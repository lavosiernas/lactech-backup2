<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solicitar Alteração de Senha - LacTech</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Solicitar alteração de senha - Sistema LacTech">
    <meta name="theme-color" content="#166534">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="LacTech">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="msapplication-TileColor" content="#166534">
    
    <!-- PWA Icons -->
    <link rel="icon" href="https://i.postimg.cc/vmrkgDcB/lactech.png" type="image/x-icon">
    <link rel="apple-touch-icon" href="https://i.postimg.cc/vmrkgDcB/lactech.png">
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- CSS Files -->
    <link href="assets/css/dark-theme-fixes.css?v=2.0" rel="stylesheet">
    <link href="assets/css/loading-screen.css" rel="stylesheet">
    
    <style>
        /* Clean white background */
        body {
            background-color: #ffffff;
            min-height: 100vh;
        }
        
        .gradient-forest {
            background: linear-gradient(135deg, #166534 0%, #15803d 50%, #16a34a 100%);
        }
        
        /* Card styles */
        .card-shadow {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05), 0 10px 15px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
        }
        
        /* Button styles */
        .btn-primary {
            background: linear-gradient(135deg, #166534 0%, #15803d 100%);
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(22, 101, 52, 0.3);
        }
        
        .btn-secondary {
            background: #6b7280;
            transition: all 0.3s ease;
        }
        
        .btn-secondary:hover {
            background: #4b5563;
            transform: translateY(-1px);
        }
        
        /* Input styles */
        .input-field {
            border: 2px solid #e5e7eb;
            transition: all 0.3s ease;
        }
        
        .input-field:focus {
            border-color: #166534;
            box-shadow: 0 0 0 3px rgba(22, 101, 52, 0.1);
            outline: none;
        }
        
        /* Password input container */
        .password-input-container {
            position: relative;
        }
        
        .password-toggle {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: #6b7280;
            transition: color 0.3s ease;
        }
        
        .password-toggle:hover {
            color: #166534;
        }
        
        /* Responsive adjustments */
        @media (max-width: 640px) {
            .container-mobile {
                padding: 1rem;
                margin: 0;
            }
        }
        
        /* Clean white theme - no dark mode */
        .form-container {
            background-color: #ffffff;
            border-radius: 12px;
        }
        
        .text-primary {
            color: #1f2937;
        }
        
        .text-secondary {
            color: #6b7280;
        }
        
        .label-text {
            color: #374151;
            font-weight: 600;
        }
        
        /* Estilo para campo preenchido automaticamente */
        .auto-filled {
            background-color: #f0fdf4 !important;
            border-color: #22c55e !important;
            transition: all 0.3s ease;
        }
        
        .auto-filled:focus {
            background-color: #ffffff !important;
            border-color: #166534 !important;
        }
    </style>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'forest': {
                            50: '#f0f9f0', 100: '#dcf2dc', 200: '#bce5bc', 300: '#8dd18d',
                            400: '#5bb85b', 500: '#369e36', 600: '#2a7f2a', 700: '#236523',
                            800: '#1f511f', 900: '#1a431a',
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-white antialiased">
    
    <!-- Header -->
    <header class="gradient-forest shadow-xl">
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center space-x-3">
                    <img src="https://i.postimg.cc/vmrkgDcB/lactech.png" alt="LacTech Logo" class="w-10 h-10 rounded-xl">
                    <div>
                        <h1 class="text-lg font-bold text-white tracking-tight">LacTech</h1>
                        <p class="text-xs text-forest-200">Solicitar Alteração de Senha</p>
                    </div>
                </div>
                <button onclick="goBack()" class="text-white hover:text-forest-200 transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                    </svg>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="form-container card-shadow p-6 sm:p-8">
            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-gradient-to-br from-yellow-500 to-yellow-600 rounded-2xl flex items-center justify-center mx-auto mb-4">
                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"></path>
                    </svg>
                </div>
                <h2 class="text-2xl font-bold text-primary mb-2">Solicitar Alteração de Senha</h2>
                <p class="text-secondary">Preencha o formulário abaixo para solicitar uma alteração ou redefinição de senha</p>
            </div>

            <!-- Formulário de Solicitação -->
            <form id="passwordRequestForm" class="space-y-6">
                <!-- Email -->
                <div>
                    <label class="block label-text mb-2">
                        Email *
                    </label>
                    <input type="email" id="userEmail" name="email" required 
                           class="w-full px-4 py-3 input-field rounded-xl bg-white" 
                           placeholder="Digite seu email">
                </div>

                <!-- Nova Senha -->
                <div>
                    <label class="block label-text mb-2">
                        Nova Senha *
                    </label>
                    <div class="password-input-container">
                        <input type="password" id="newPassword" name="newPassword" required 
                               class="w-full px-4 py-3 pr-12 input-field rounded-xl bg-white" 
                               placeholder="Digite sua nova senha"
                               oninput="validatePasswordInRealTime(this.value)">
                        <button type="button" class="password-toggle" onclick="togglePassword('newPassword')">
                            <svg id="newPassword-eye" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <!-- Indicador de força da senha -->
                    <div id="passwordStrengthIndicator" class="mt-2 hidden">
                        <div class="flex items-center space-x-2 mb-2">
                            <span class="text-sm text-gray-600">Força da senha:</span>
                            <div class="flex space-x-1">
                                <div class="w-3 h-2 bg-gray-300 rounded"></div>
                                <div class="w-3 h-2 bg-gray-300 rounded"></div>
                                <div class="w-3 h-2 bg-gray-300 rounded"></div>
                                <div class="w-3 h-2 bg-gray-300 rounded"></div>
                                <div class="w-3 h-2 bg-gray-300 rounded"></div>
                            </div>
                            <span id="passwordStrengthText" class="text-sm font-medium"></span>
                        </div>
                        
                        <!-- Requisitos da senha -->
                        <div id="passwordRequirements" class="text-xs space-y-1">
                            <div class="flex items-center space-x-2">
                                <span id="req-length" class="w-4 h-4 rounded-full border-2 border-gray-300 flex items-center justify-center">
                                    <svg class="w-3 h-3 text-white hidden" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                    </svg>
                                </span>
                                <span>Pelo menos 8 caracteres</span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <span id="req-uppercase" class="w-4 h-4 rounded-full border-2 border-gray-300 flex items-center justify-center">
                                    <svg class="w-3 h-3 text-white hidden" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                    </svg>
                                </span>
                                <span>Uma letra maiúscula</span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <span id="req-lowercase" class="w-4 h-4 rounded-full border-2 border-gray-300 flex items-center justify-center">
                                    <svg class="w-3 h-3 text-white hidden" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                    </svg>
                                </span>
                                <span>Uma letra minúscula</span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <span id="req-numbers" class="w-4 h-4 rounded-full border-2 border-gray-300 flex items-center justify-center">
                                    <svg class="w-3 h-3 text-white hidden" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                    </svg>
                                </span>
                                <span>Um número</span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <span id="req-special" class="w-4 h-4 rounded-full border-2 border-gray-300 flex items-center justify-center">
                                    <svg class="w-3 h-3 text-white hidden" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                    </svg>
                                </span>
                                <span>Um caractere especial</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Confirmar Nova Senha -->
                <div>
                    <label class="block label-text mb-2">
                        Confirmar Nova Senha *
                    </label>
                    <div class="password-input-container">
                        <input type="password" id="confirmPassword" name="confirmPassword" required 
                               class="w-full px-4 py-3 pr-12 input-field rounded-xl bg-white" 
                               placeholder="Confirme sua nova senha">
                        <button type="button" class="password-toggle" onclick="togglePassword('confirmPassword')">
                            <svg id="confirmPassword-eye" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Motivo -->
                <div>
                    <label class="block label-text mb-2">
                        Motivo da Solicitação *
                    </label>
                    <select id="requestReason" name="reason" required class="w-full px-4 py-3 input-field rounded-xl bg-white">
                        <option value="">Selecione o motivo</option>
                        <option value="forgot_password">Esqueci minha senha</option>
                        <option value="security_concern">Preocupação com segurança</option>
                        <option value="account_compromised">Conta comprometida</option>
                        <option value="new_device">Novo dispositivo</option>
                        <option value="other">Outro motivo</option>
                    </select>
                </div>

                <!-- Observações -->
                <div>
                    <label class="block label-text mb-2">
                        Observações Adicionais
                    </label>
                    <textarea id="requestNotes" name="notes" rows="4" 
                              class="w-full px-4 py-3 input-field rounded-xl bg-white" 
                              placeholder="Descreva detalhes adicionais sobre sua solicitação..."></textarea>
                </div>

                <!-- Informações Importantes -->
                <div class="bg-blue-50 border border-blue-200 rounded-xl p-4">
                    <div class="flex items-start space-x-3">
                        <svg class="w-5 h-5 text-blue-600 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <div>
                            <h4 class="font-semibold text-blue-800 mb-1">Informações Importantes</h4>
                            <ul class="text-sm text-blue-700 space-y-1">
                                <li>• Sua solicitação será analisada por um gerente</li>
                                <li>• O processo pode levar até 24 horas</li>
                                <li>• Você receberá uma notificação sobre a decisão</li>
                                <li>• Em caso de aprovação, sua senha será alterada automaticamente</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Botões -->
                <div class="flex flex-col sm:flex-row gap-3 pt-4">
                    <button type="submit" class="flex-1 px-6 py-3 btn-primary text-white rounded-xl font-semibold">
                        <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                        </svg>
                        Enviar Solicitação
                    </button>
                    <button type="button" onclick="goBack()" class="px-6 py-3 btn-secondary text-white rounded-xl font-semibold">
                        Cancelar
                    </button>
                </div>
            </form>
        </div>
    </main>

    <!-- Scripts -->
    <script src="config.js"></script>
    <script>
        let supabaseClient;

        // Inicializar Supabase
        async function initSupabase() {
            try {
                // Aguardar config.js carregar
                await new Promise(resolve => setTimeout(resolve, 500));
                
                if (typeof getSupabaseClient === 'function') {
                    supabaseClient = await getSupabaseClient();
                } else {
                    console.error('Função getSupabaseClient não encontrada');
                }
            } catch (error) {
                console.error('Erro ao inicializar Supabase:', error);
            }
        }

        // Verificar autenticação
        async function checkAuth() {
            try {
                if (!supabaseClient) {
                    await initSupabase();
                }
                
                const { data: { user }, error } = await supabaseClient.auth.getUser();
                
                if (error || !user) {
                    showNotification('Usuário não autenticado. Redirecionando para login...', 'error');
                    setTimeout(() => {
                        window.location.href = 'login.html';
                    }, 2000);
                    return;
                }
                
                console.log('Usuário autenticado:', user.email);
                
            } catch (error) {
                console.error('Erro ao verificar autenticação:', error);
                showNotification('Erro ao verificar autenticação', 'error');
            }
        }

        // Validação em tempo real da senha
        function validatePasswordInRealTime(password) {
            const indicator = document.getElementById('passwordStrengthIndicator');
            if (!indicator) return;
            
            if (password.length === 0) {
                indicator.classList.add('hidden');
                return;
            }
            
            indicator.classList.remove('hidden');
            
            const validation = validatePasswordStrength(password);
            const strengthBars = indicator.querySelectorAll('.w-3.h-2');
            const strengthText = document.getElementById('passwordStrengthText');
            
            // Atualizar barras de força
            strengthBars.forEach((bar, index) => {
                bar.className = 'w-3 h-2 rounded';
                if (index < validation.score) {
                    if (validation.score <= 2) {
                        bar.classList.add('bg-red-500');
                    } else if (validation.score <= 4) {
                        bar.classList.add('bg-yellow-500');
                    } else {
                        bar.classList.add('bg-green-500');
                    }
                } else {
                    bar.classList.add('bg-gray-300');
                }
            });
            
            // Atualizar texto de força
            const strengthLabels = ['Muito fraca', 'Fraca', 'Regular', 'Boa', 'Muito boa', 'Excelente', 'Perfeita'];
            strengthText.textContent = strengthLabels[Math.min(validation.score, 6)];
            
            // Atualizar requisitos
            const requirements = validation.requirements;
            updateRequirement('req-length', requirements.length);
            updateRequirement('req-uppercase', requirements.uppercase);
            updateRequirement('req-lowercase', requirements.lowercase);
            updateRequirement('req-numbers', requirements.numbers);
            updateRequirement('req-special', requirements.special);
        }
        
        function updateRequirement(elementId, isValid) {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            const icon = element.querySelector('svg');
            if (isValid) {
                element.classList.remove('border-gray-300');
                element.classList.add('border-green-500', 'bg-green-500');
                icon.classList.remove('hidden');
            } else {
                element.classList.remove('border-green-500', 'bg-green-500');
                element.classList.add('border-gray-300');
                icon.classList.add('hidden');
            }
        }

        // Enviar solicitação
        async function submitPasswordRequest(formData) {
            try {
                if (!supabaseClient) {
                    await initSupabase();
                }
                
                // Validar se as senhas coincidem
                const newPassword = formData.get('newPassword');
                const confirmPassword = formData.get('confirmPassword');
                
                if (newPassword !== confirmPassword) {
                    showNotification('As senhas não coincidem. Verifique e tente novamente.', 'error');
                    return;
                }
                
                // Validar força da senha
                const passwordValidation = validatePasswordStrength(newPassword);
                if (!passwordValidation.isValid) {
                    showNotification(passwordValidation.message, 'error');
                    return;
                }
                
                // Buscar usuário pelo email
                const email = formData.get('email');
                const { data: usersData, error: userError } = await supabaseClient
                    .from('users')
                    .select('id, email')
                    .eq('email', email)
                    .eq('is_active', true)
                    .single();
                
                if (userError || !usersData) {
                    showNotification('Email não encontrado no sistema.', 'error');
                    return;
                }
                
                // Verificar rate limiting
                const rateLimitCheck = checkRateLimit(usersData.id);
                if (!rateLimitCheck.allowed) {
                    showNotification(rateLimitCheck.message, 'error');
                    return;
                }
                
                // Log de auditoria
                logAuditEvent('password_request_attempt', usersData.id, {
                    email: email,
                    reason: formData.get('reason'),
                    passwordStrength: passwordValidation.score
                });
                
                // Criar solicitação na tabela com a nova senha
                // Primeiro, tentar com a coluna new_password
                let requestData = {
                    user_id: usersData.id,
                    type: 'reset', // Sempre será reset pois é para alterar senha
                    reason: formData.get('reason'),
                    notes: formData.get('notes') || null,
                    status: 'pending',
                    new_password: newPassword
                };
                
                console.log('📝 Tentando inserir solicitação:', requestData);
                
                let { data, error } = await supabaseClient
                    .from('password_requests')
                    .insert([requestData])
                    .select()
                    .single();
                
                console.log('📊 Resultado da inserção:', { data, error });
                
                // Se der erro porque a coluna new_password não existe, tentar sem ela
                if (error && error.message.includes('new_password')) {
                    console.log('⚠️ Coluna new_password não existe, usando campo notes como fallback');
                    
                    // Armazenar a nova senha no campo notes
                    const notesWithPassword = `NOVA SENHA: ${newPassword}\n\n${formData.get('notes') || 'Observações adicionais não fornecidas.'}`;
                    
                    requestData = {
                        user_id: usersData.id,
                        type: 'reset',
                        reason: formData.get('reason'),
                        notes: notesWithPassword,
                        status: 'pending'
                    };
                    
                    const result = await supabaseClient
                        .from('password_requests')
                        .insert([requestData])
                        .select()
                        .single();
                    
                    data = result.data;
                    error = result.error;
                }
                
                if (error) {
                    console.error('Erro detalhado:', error);
                    
                    // Verificar se é erro de RLS
                    if (error.message.includes('row-level security policy')) {
                        showNotification('Erro de permissão: As políticas de segurança do banco precisam ser atualizadas. Entre em contato com o administrador.', 'error');
                    } else {
                        throw error;
                    }
                    return;
                }
                
                showNotification('Solicitação enviada com sucesso! Aguarde a aprovação do gerente.', 'success');
                
                // Log de sucesso
                logAuditEvent('password_request_success', usersData.id, {
                    requestId: data.id,
                    email: email,
                    reason: formData.get('reason')
                });
                
                // Limpar formulário
                document.getElementById('passwordRequestForm').reset();
                
                // Redirecionar após 3 segundos
                setTimeout(() => {
                    goBack();
                }, 3000);
                
            } catch (error) {
                console.error('Erro ao enviar solicitação:', error);
                showNotification('Erro ao enviar solicitação: ' + error.message, 'error');
            }
        }

        // Função para alternar visibilidade da senha
        function togglePassword(fieldId) {
            const field = document.getElementById(fieldId);
            const eyeIcon = document.getElementById(fieldId + '-eye');
            
            if (field.type === 'password') {
                field.type = 'text';
                eyeIcon.innerHTML = `
                    <path stroke-linecap="round" stroke-linejoin="round" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.878 9.878L3 3m6.878 6.878L21 21"></path>
                `;
            } else {
                field.type = 'password';
                eyeIcon.innerHTML = `
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                `;
            }
        }

        // Função para voltar
        function goBack() {
            if (document.referrer && document.referrer.includes(window.location.origin)) {
                window.history.back();
            } else {
                window.location.href = 'index.html';
            }
        }

        // Sistema de notificações
        function showNotification(message, type = 'info') {
            // Criar container de notificações se não existir
            let container = document.getElementById('notificationContainer');
            if (!container) {
                container = document.createElement('div');
                container.id = 'notificationContainer';
                container.className = 'fixed top-4 right-4 z-50 space-y-2';
                document.body.appendChild(container);
            }
            
            // Criar notificação
            const notification = document.createElement('div');
            const colors = {
                success: 'bg-green-500 text-white',
                error: 'bg-red-500 text-white',
                warning: 'bg-yellow-500 text-white',
                info: 'bg-blue-500 text-white'
            };
            
            notification.className = `${colors[type]} px-6 py-3 rounded-xl shadow-lg transform translate-x-full transition-transform duration-300`;
            notification.innerHTML = `
                <div class="flex items-center space-x-2">
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-2 hover:opacity-75">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            `;
            
            container.appendChild(notification);
            
            // Animar entrada
            setTimeout(() => {
                notification.classList.remove('translate-x-full');
            }, 100);
            
            // Remover após 5 segundos
            setTimeout(() => {
                notification.classList.add('translate-x-full');
                setTimeout(() => {
                    if (container.contains(notification)) {
                        container.removeChild(notification);
                    }
                }, 300);
            }, 5000);
        }

        // Função para obter parâmetros da URL
        function getUrlParameter(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }

        // Validação robusta de senha
        function validatePasswordStrength(password) {
            const minLength = 8;
            const hasUpperCase = /[A-Z]/.test(password);
            const hasLowerCase = /[a-z]/.test(password);
            const hasNumbers = /\d/.test(password);
            const hasSpecialChar = /[!@#$%^&*(),.?":{}|<>]/.test(password);
            const hasNoSpaces = !/\s/.test(password);
            
            const errors = [];
            
            if (password.length < minLength) {
                errors.push(`pelo menos ${minLength} caracteres`);
            }
            if (!hasUpperCase) {
                errors.push('uma letra maiúscula');
            }
            if (!hasLowerCase) {
                errors.push('uma letra minúscula');
            }
            if (!hasNumbers) {
                errors.push('um número');
            }
            if (!hasSpecialChar) {
                errors.push('um caractere especial (!@#$%^&*)');
            }
            if (!hasNoSpaces) {
                errors.push('não conter espaços');
            }
            
            const isValid = errors.length === 0;
            const message = isValid ? 'Senha válida' : `A senha deve conter: ${errors.join(', ')}.`;
            
            return {
                isValid,
                message,
                score: calculatePasswordScore(password),
                requirements: {
                    length: password.length >= minLength,
                    uppercase: hasUpperCase,
                    lowercase: hasLowerCase,
                    numbers: hasNumbers,
                    special: hasSpecialChar,
                    noSpaces: hasNoSpaces
                }
            };
        }
        
        // Calcular pontuação da senha
        function calculatePasswordScore(password) {
            let score = 0;
            
            // Comprimento
            if (password.length >= 8) score += 1;
            if (password.length >= 12) score += 1;
            if (password.length >= 16) score += 1;
            
            // Caracteres
            if (/[a-z]/.test(password)) score += 1;
            if (/[A-Z]/.test(password)) score += 1;
            if (/\d/.test(password)) score += 1;
            if (/[!@#$%^&*(),.?":{}|<>]/.test(password)) score += 1;
            
            return Math.min(score, 7); // Máximo 7 pontos
        }
        
        // Rate limiting otimizado para solicitações
        const requestRateLimit = new Map();
        const MAX_REQUESTS_PER_HOUR = 3;
        const RATE_LIMIT_CLEANUP_INTERVAL = 5 * 60 * 1000; // 5 minutos
        
        // Limpeza automática do rate limiting
        setInterval(() => {
            const now = Date.now();
            const hourAgo = now - (60 * 60 * 1000);
            
            for (const [userId, requests] of requestRateLimit.entries()) {
                const recentRequests = requests.filter(time => time > hourAgo);
                if (recentRequests.length === 0) {
                    requestRateLimit.delete(userId);
                } else {
                    requestRateLimit.set(userId, recentRequests);
                }
            }
        }, RATE_LIMIT_CLEANUP_INTERVAL);
        
        function checkRateLimit(userId) {
            const now = Date.now();
            const hourAgo = now - (60 * 60 * 1000);
            
            if (!requestRateLimit.has(userId)) {
                requestRateLimit.set(userId, []);
            }
            
            const userRequests = requestRateLimit.get(userId);
            const recentRequests = userRequests.filter(time => time > hourAgo);
            
            if (recentRequests.length >= MAX_REQUESTS_PER_HOUR) {
                return {
                    allowed: false,
                    message: `Limite de ${MAX_REQUESTS_PER_HOUR} solicitações por hora atingido. Tente novamente mais tarde.`,
                    nextAllowed: new Date(recentRequests[0] + (60 * 60 * 1000))
                };
            }
            
            recentRequests.push(now);
            requestRateLimit.set(userId, recentRequests);
            
            return { allowed: true };
        }
        
        // Logs de auditoria
        function logAuditEvent(action, userId, details = {}) {
            const logEntry = {
                timestamp: new Date().toISOString(),
                action,
                userId,
                ip: details.ip || 'unknown',
                userAgent: navigator.userAgent,
                details
            };
            
            console.log(`[AUDIT] ${action} by ${userId}:`, logEntry);
            
            // Armazenar no localStorage para persistência
            const auditLogs = JSON.parse(localStorage.getItem('audit_logs') || '[]');
            auditLogs.push(logEntry);
            
            // Manter apenas os últimos 100 logs
            if (auditLogs.length > 100) {
                auditLogs.splice(0, auditLogs.length - 100);
            }
            
            localStorage.setItem('audit_logs', JSON.stringify(auditLogs));
        }

        // Função para preencher email automaticamente
        function autoFillEmail() {
            console.log('🔍 Verificando parâmetros da URL...');
            const email = getUrlParameter('email');
            console.log('📧 Email encontrado na URL:', email);
            
            if (email) {
                // Tentar encontrar o campo de email por ID primeiro
                let emailInput = document.getElementById('userEmail');
                
                // Se não encontrar por ID, tentar por name
                if (!emailInput) {
                    emailInput = document.querySelector('input[name="email"]');
                }
                
                // Se ainda não encontrar, tentar por type
                if (!emailInput) {
                    emailInput = document.querySelector('input[type="email"]');
                }
                
                console.log('🎯 Campo de email encontrado:', emailInput);
                
                if (emailInput) {
                    const decodedEmail = decodeURIComponent(email);
                    console.log('✅ Preenchendo email:', decodedEmail);
                    
                    emailInput.value = decodedEmail;
                    
                    // Adicionar uma classe para indicar que foi preenchido automaticamente
                    emailInput.classList.add('auto-filled');
                    
                    // Remover o destaque após 3 segundos
                    setTimeout(() => {
                        emailInput.classList.remove('auto-filled');
                        console.log('🎨 Destaque removido do campo de email');
                    }, 3000);
                    
                    console.log('✅ Email preenchido com sucesso!');
                } else {
                    console.error('❌ Campo de email não encontrado!');
                }
            } else {
                console.log('ℹ️ Nenhum email encontrado na URL');
            }
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Não precisa verificar autenticação pois o usuário pode não estar logado
            
            // Preencher email automaticamente se fornecido na URL
            autoFillEmail();
            
            // Fallback: tentar novamente após um pequeno delay
            setTimeout(() => {
                const email = getUrlParameter('email');
                const emailInput = document.getElementById('userEmail');
                if (email && emailInput && !emailInput.value) {
                    console.log('🔄 Executando fallback para preencher email...');
                    autoFillEmail();
                }
            }, 100);
            
            // Botão de teste temporário (remover em produção)
            if (window.location.search.includes('debug=1')) {
                const testButton = document.createElement('button');
                testButton.textContent = '🧪 Testar Email';
                testButton.className = 'fixed top-4 right-4 bg-blue-500 text-white px-3 py-1 rounded text-sm z-50';
                testButton.onclick = () => {
                    const testEmail = 'teste@exemplo.com';
                    const emailInput = document.getElementById('userEmail');
                    if (emailInput) {
                        emailInput.value = testEmail;
                        emailInput.classList.add('auto-filled');
                        setTimeout(() => emailInput.classList.remove('auto-filled'), 3000);
                        console.log('✅ Email de teste preenchido:', testEmail);
                    }
                };
                document.body.appendChild(testButton);
            }
            
            // Form submit
            document.getElementById('passwordRequestForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const formData = new FormData(this);
                
                // Validações
                if (!formData.get('email')) {
                    showNotification('Digite seu email', 'error');
                    return;
                }
                
                if (!formData.get('newPassword')) {
                    showNotification('Digite sua nova senha', 'error');
                    return;
                }
                
                if (!formData.get('confirmPassword')) {
                    showNotification('Confirme sua nova senha', 'error');
                    return;
                }
                
                if (!formData.get('reason')) {
                    showNotification('Selecione o motivo da solicitação', 'error');
                    return;
                }
                
                // Desabilitar botão
                const submitButton = this.querySelector('button[type="submit"]');
                const originalText = submitButton.innerHTML;
                submitButton.disabled = true;
                submitButton.innerHTML = `
                    <svg class="animate-spin w-5 h-5 inline mr-2" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Enviando...
                `;
                
                try {
                    await submitPasswordRequest(formData);
                } finally {
                    // Reabilitar botão
                    submitButton.disabled = false;
                    submitButton.innerHTML = originalText;
                }
            });
        });
    </script>
</body>
</html>
