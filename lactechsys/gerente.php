<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel do Gerente - Sistema Leiteiro</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Painel do Gerente - Sistema completo para gestão de produção leiteira, controle de qualidade e relatórios">
    <meta name="theme-color" content="#166534">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="LacTech Gerente">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="msapplication-TileColor" content="#166534">
    <meta name="msapplication-config" content="/browserconfig.xml">
    
    <!-- PWA Icons -->
    <link rel="icon" href="https://i.postimg.cc/vmrkgDcB/lactech.png" type="image/x-icon">
    <link rel="apple-touch-icon" href="https://i.postimg.cc/vmrkgDcB/lactech.png">
    <link rel="apple-touch-icon" sizes="72x72" href="https://i.postimg.cc/vmrkgDcB/lactech.png">
    <link rel="apple-touch-icon" sizes="96x96" href="https://i.postimg.cc/vmrkgDcB/lactech.png">
    <link rel="apple-touch-icon" sizes="128x128" href="https://i.postimg.cc/vmrkgDcB/lactech.png">
    <link rel="apple-touch-icon" sizes="144x144" href="https://i.postimg.cc/vmrkgDcB/lactech.png">
    <link rel="apple-touch-icon" sizes="152x152" href="https://i.postimg.cc/vmrkgDcB/lactech.png">
    <link rel="apple-touch-icon" sizes="192x192" href="https://i.postimg.cc/vmrkgDcB/lactech.png">
    <link rel="apple-touch-icon" sizes="384x384" href="https://i.postimg.cc/vmrkgDcB/lactech.png">
    <link rel="apple-touch-icon" sizes="512x512" href="https://i.postimg.cc/vmrkgDcB/lactech.png">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Critical CSS - inline for fastest loading -->
    <style>
        /* Critical styles inline to prevent FOUC */
        * { box-sizing: border-box; }
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        /* .loading-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; } REMOVIDO - usando apenas modal HTML */
        .main-content { opacity: 0; transition: opacity 0.5s ease-in; }
        .main-content.loaded { opacity: 1; }
    </style>
    
    <!-- Preload critical resources -->
    <link rel="preload" href="assets/css/critical.css" as="style">
    <link rel="preload" href="assets/js/performance-optimizer.js" as="script">
    <link rel="preload" href="assets/js/config_mysql.js" as="script">
    
    <!-- Load critical CSS immediately -->
    <link rel="stylesheet" href="assets/css/critical.css">
    
    <!-- Tailwind CSS CDN - optimized -->
    <script src="https://cdn.tailwindcss.com"></script>
<<<<<<< HEAD
    
    <script>
        // Configurar Tailwind ANTES de carregar outros scripts
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'forest': {
                            50: '#f0f9f0', 100: '#dcf2dc', 200: '#bce5bc', 300: '#8dd18d',
                            400: '#5bb85b', 500: '#369e36', 600: '#2a7f2a', 700: '#236523',
                            800: '#1f511f', 900: '#1a431a',
                        }
                    }
                }
            }
        }
    </script>
    
    <!-- Performance Optimizer - load first -->
    <script src="assets/js/performance-optimizer.js"></script>
    
    <!-- Critical scripts only -->
=======
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="assets/js/pdf-generator.js"></script>
>>>>>>> parent of 0eb3d2f (.)
    <script src="assets/js/config_mysql.js"></script>
    <!-- <script src="assets/js/loading-screen.js"></script> DESABILITADO - usando apenas modal de carregamento -->
    <script src="assets/js/modal-system.js"></script>
    <script src="assets/js/offline-manager.js"></script>
<<<<<<< HEAD
    <script src="assets/js/native-notifications.js"></script>
    
    <!-- Load Chart.js immediately for graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Defer other non-critical scripts -->
    <script>
        // Load non-critical scripts after page load
        window.addEventListener('load', function() {
            setTimeout(function() {
                // Load PDF generator and other scripts (avoiding duplicates)
                const scripts = [
                    'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js',
                    'assets/js/pdf-generator.js',
                    'assets/js/offline-sync.js'
                ];
                
                scripts.forEach(function(src) {
                    // Check if script already exists
                    if (!document.querySelector(`script[src="${src}"]`)) {
                        const script = document.createElement('script');
                        script.src = src;
                        script.async = true;
                        document.head.appendChild(script);
                    }
                });
            }, 500); // Increased delay to ensure Chart.js is ready
        });
    </script>
    
        // Alert shim for custom notifications - PRIORIDADE MÁXIMA
=======
    <script src="assets/js/offline-loading.js"></script>
    <script src="assets/js/native-notifications.js"></script>
    <script src="assets/js/offline-sync.js"></script>
    
    <!-- CSS Files -->
    <link href="assets/css/loading-screen.css" rel="stylesheet">
    <link href="assets/css/offline-loading.css" rel="stylesheet">
    <link href="assets/css/weather-modal.css" rel="stylesheet">
    <link href="assets/css/native-notifications.css" rel="stylesheet">
    <link href="assets/css/quality-modal.css" rel="stylesheet">
    
    <!-- Responsividade Customizada -->
    <style>
        /* Gradiente de texto estilo Xandria Store */
        .gradient-text {
            background: linear-gradient(135deg, #01875f, #10b981);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        /* Card hover effect estilo Xandria Store */
        .card-hover {
            transition: all 0.3s ease;
        }
        
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }
        
        .dark .card-hover:hover {
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.6);
        }
        
        /* Responsividade para telas muito pequenas */
        @media (max-width: 360px) {
            .text-xs { font-size: 0.65rem !important; line-height: 0.9rem !important; }
            .text-sm { font-size: 0.75rem !important; line-height: 1rem !important; }
            .text-base { font-size: 0.8rem !important; line-height: 1.1rem !important; }
            .text-lg { font-size: 0.9rem !important; line-height: 1.2rem !important; }
            .text-xl { font-size: 1rem !important; line-height: 1.3rem !important; }
            .text-2xl { font-size: 1.1rem !important; line-height: 1.4rem !important; }
            
            /* Espaçamentos reduzidos */
            .p-2 { padding: 0.3rem !important; }
            .p-3 { padding: 0.5rem !important; }
            .p-4 { padding: 0.6rem !important; }
            .p-6 { padding: 0.8rem !important; }
            .px-3 { padding-left: 0.5rem !important; padding-right: 0.5rem !important; }
            .px-4 { padding-left: 0.6rem !important; padding-right: 0.6rem !important; }
            .px-6 { padding-left: 0.8rem !important; padding-right: 0.8rem !important; }
            .py-2 { padding-top: 0.3rem !important; padding-bottom: 0.3rem !important; }
            .py-3 { padding-top: 0.5rem !important; padding-bottom: 0.5rem !important; }
            .py-4 { padding-top: 0.6rem !important; padding-bottom: 0.6rem !important; }
            
            /* Margens reduzidas */
            .m-2 { margin: 0.3rem !important; }
            .m-3 { margin: 0.5rem !important; }
            .m-4 { margin: 0.6rem !important; }
            .mb-2 { margin-bottom: 0.3rem !important; }
            .mb-3 { margin-bottom: 0.5rem !important; }
            .mb-4 { margin-bottom: 0.6rem !important; }
            .mb-6 { margin-bottom: 0.8rem !important; }
            .mt-2 { margin-top: 0.3rem !important; }
            .mt-3 { margin-top: 0.5rem !important; }
            .mt-4 { margin-top: 0.6rem !important; }
            
            /* Grid gaps reduzidos */
            .gap-2 { gap: 0.3rem !important; }
            .gap-3 { gap: 0.5rem !important; }
            .gap-4 { gap: 0.6rem !important; }
            .gap-6 { gap: 0.8rem !important; }
            
            /* Espaçamentos entre elementos */
            .space-y-2 > * + * { margin-top: 0.3rem !important; }
            .space-y-3 > * + * { margin-top: 0.5rem !important; }
            .space-y-4 > * + * { margin-top: 0.6rem !important; }
            .space-y-6 > * + * { margin-top: 0.8rem !important; }
            
            /* Botões menores */
            .btn-sm { padding: 0.3rem 0.6rem !important; font-size: 0.7rem !important; }
            .btn-md { padding: 0.5rem 0.8rem !important; font-size: 0.8rem !important; }
            
            /* Cards mais compactos */
            .card-compact { padding: 0.6rem !important; }
            .card-compact .text-lg { font-size: 0.85rem !important; }
            .card-compact .text-xl { font-size: 0.95rem !important; }
            
            /* Headers mais compactos */
            .header-compact { padding: 0.5rem 0.8rem !important; }
            .header-compact .text-xl { font-size: 0.9rem !important; }
            .header-compact .text-2xl { font-size: 1rem !important; }
        }
        
        /* Responsividade para telas pequenas */
        @media (max-width: 480px) {
            .text-xs { font-size: 0.7rem !important; line-height: 0.95rem !important; }
            .text-sm { font-size: 0.8rem !important; line-height: 1.05rem !important; }
            .text-base { font-size: 0.85rem !important; line-height: 1.15rem !important; }
            .text-lg { font-size: 0.95rem !important; line-height: 1.25rem !important; }
            .text-xl { font-size: 1.05rem !important; line-height: 1.35rem !important; }
            .text-2xl { font-size: 1.15rem !important; line-height: 1.45rem !important; }
            
            /* Espaçamentos moderados */
            .p-2 { padding: 0.4rem !important; }
            .p-3 { padding: 0.6rem !important; }
            .p-4 { padding: 0.7rem !important; }
            .p-6 { padding: 0.9rem !important; }
            .px-3 { padding-left: 0.6rem !important; padding-right: 0.6rem !important; }
            .px-4 { padding-left: 0.7rem !important; padding-right: 0.7rem !important; }
            .px-6 { padding-left: 0.9rem !important; padding-right: 0.9rem !important; }
            .py-2 { padding-top: 0.4rem !important; padding-bottom: 0.4rem !important; }
            .py-3 { padding-top: 0.6rem !important; padding-bottom: 0.6rem !important; }
            .py-4 { padding-top: 0.7rem !important; padding-bottom: 0.7rem !important; }
            
            /* Margens moderadas */
            .m-2 { margin: 0.4rem !important; }
            .m-3 { margin: 0.6rem !important; }
            .m-4 { margin: 0.7rem !important; }
            .mb-2 { margin-bottom: 0.4rem !important; }
            .mb-3 { margin-bottom: 0.6rem !important; }
            .mb-4 { margin-bottom: 0.7rem !important; }
            .mb-6 { margin-bottom: 0.9rem !important; }
            .mt-2 { margin-top: 0.4rem !important; }
            .mt-3 { margin-top: 0.6rem !important; }
            .mt-4 { margin-top: 0.7rem !important; }
            
            /* Grid gaps moderados */
            .gap-2 { gap: 0.4rem !important; }
            .gap-3 { gap: 0.6rem !important; }
            .gap-4 { gap: 0.7rem !important; }
            .gap-6 { gap: 0.9rem !important; }
            
            /* Espaçamentos entre elementos */
            .space-y-2 > * + * { margin-top: 0.4rem !important; }
            .space-y-3 > * + * { margin-top: 0.6rem !important; }
            .space-y-4 > * + * { margin-top: 0.7rem !important; }
            .space-y-6 > * + * { margin-top: 0.9rem !important; }
        }
        
        /* Prevenir quebra de linha em textos importantes */
        .no-wrap { white-space: nowrap !important; }
        .text-ellipsis { overflow: hidden !important; text-overflow: ellipsis !important; white-space: nowrap !important; }
        
        /* Ajustes específicos para elementos que quebram */
        .metric-value { font-size: clamp(0.8rem, 2.5vw, 1.25rem) !important; }
        .metric-label { font-size: clamp(0.6rem, 2vw, 0.875rem) !important; }
        .card-title { font-size: clamp(0.75rem, 2.2vw, 1.125rem) !important; }
        .button-text { font-size: clamp(0.7rem, 2vw, 0.875rem) !important; }
        
        /* Melhorar espaçamento em grids */
        .grid-compact { gap: 0.5rem !important; }
        .grid-compact > * { padding: 0.5rem !important; }
        
        /* Ajustes para modais em telas pequenas */
        @media (max-width: 480px) {
            .modal-content { padding: 0.8rem !important; }
            .modal-title { font-size: 1rem !important; }
            .modal-body { font-size: 0.85rem !important; }
            .modal-button { padding: 0.5rem 0.8rem !important; font-size: 0.8rem !important; }
        }
        
        @media (max-width: 360px) {
            .modal-content { padding: 0.6rem !important; }
            .modal-title { font-size: 0.9rem !important; }
            .modal-body { font-size: 0.75rem !important; }
            .modal-button { padding: 0.4rem 0.6rem !important; font-size: 0.7rem !important; }
        }
        
        /* Ajustes específicos para cards de dados */
        @media (max-width: 480px) {
            .data-card { padding: 0.8rem !important; }
            .data-card h3 { font-size: 0.9rem !important; margin-bottom: 0.6rem !important; }
            .data-card .text-lg { font-size: 0.85rem !important; }
            .data-card .text-xl { font-size: 0.95rem !important; }
            .data-card .text-2xl { font-size: 1.05rem !important; }
        }
        
        @media (max-width: 360px) {
            .data-card { padding: 0.6rem !important; }
            .data-card h3 { font-size: 0.8rem !important; margin-bottom: 0.5rem !important; }
            .data-card .text-lg { font-size: 0.75rem !important; }
            .data-card .text-xl { font-size: 0.85rem !important; }
            .data-card .text-2xl { font-size: 0.95rem !important; }
        }
        
        /* Ajustes para botões em telas pequenas */
        @media (max-width: 480px) {
            .btn-primary, .btn-secondary, .btn-success, .btn-danger { 
                padding: 0.4rem 0.8rem !important; 
                font-size: 0.8rem !important; 
            }
            .btn-sm { 
                padding: 0.3rem 0.6rem !important; 
                font-size: 0.7rem !important; 
            }
        }
        
        @media (max-width: 360px) {
            .btn-primary, .btn-secondary, .btn-success, .btn-danger { 
                padding: 0.3rem 0.6rem !important; 
                font-size: 0.7rem !important; 
            }
            .btn-sm { 
                padding: 0.25rem 0.5rem !important; 
                font-size: 0.65rem !important; 
            }
        }
        
        /* Ajustes para tabelas em telas pequenas */
        @media (max-width: 480px) {
            .table-responsive { font-size: 0.75rem !important; }
            .table-responsive th, .table-responsive td { 
                padding: 0.4rem 0.3rem !important; 
            }
        }
        
        @media (max-width: 360px) {
            .table-responsive { font-size: 0.7rem !important; }
            .table-responsive th, .table-responsive td { 
                padding: 0.3rem 0.2rem !important; 
            }
        }
        
        /* Ajustes para inputs e formulários */
        @media (max-width: 480px) {
            input, select, textarea { 
                font-size: 0.85rem !important; 
                padding: 0.4rem 0.6rem !important; 
            }
            label { font-size: 0.8rem !important; }
        }
        
        @media (max-width: 360px) {
            input, select, textarea { 
                font-size: 0.8rem !important; 
                padding: 0.3rem 0.5rem !important; 
            }
            label { font-size: 0.75rem !important; }
        }
        
        /* Ajustes específicos para modal de logout */
        @media (max-width: 480px) {
            #logoutConfirmationModal .bg-white,
            #logoutConfirmationModal .bg-white {
                margin: 1rem !important;
                padding: 1.5rem !important;
            }
            
            #logoutConfirmationModal h3 {
                font-size: 1.1rem !important;
            }
            
            #logoutConfirmationModal p {
                font-size: 0.9rem !important;
            }
            
            #logoutConfirmationModal .w-16 {
                width: 3rem !important;
                height: 3rem !important;
            }
            
            #logoutConfirmationModal .w-8 {
                width: 1.5rem !important;
                height: 1.5rem !important;
            }
        }
        
        /* Garantir que os botões de edição sejam ocultados corretamente */
        #profileEditButtons.hidden {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
            pointer-events: none !important;
        }
        
        /* Forçar ocultação dos botões quando não há mudanças */
        #profileEditButtons[style*="display: none"] {
            visibility: hidden !important;
            opacity: 0 !important;
            pointer-events: none !important;
        }
        
        /* Garantir que as telas de processamento sejam ocultadas */
        #photoProcessingScreen.hidden,
        #managerPhotoProcessingScreen.hidden {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
            pointer-events: none !important;
        }
        
        /* Forçar ocultação das telas de processamento */
        #photoProcessingScreen[style*="display: none"],
        #managerPhotoProcessingScreen[style*="display: none"] {
            visibility: hidden !important;
            opacity: 0 !important;
            pointer-events: none !important;
        }
        
        /* Garantir que o modal de foto do gerente seja exibido corretamente */
        #managerPhotoChoiceModal[style*="display: flex"] {
            visibility: visible !important;
            opacity: 1 !important;
            pointer-events: auto !important;
        }
        
        #managerPhotoChoiceModal.flex {
            display: flex !important;
            visibility: visible !important;
            opacity: 1 !important;
            pointer-events: auto !important;
        }
        
        /* Garantir que o modal MAIS seja exibido corretamente */
        #moreModal[style*="display: block"] {
            visibility: visible !important;
            opacity: 1 !important;
            pointer-events: auto !important;
        }
        
        #moreModal:not(.hidden) {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            pointer-events: auto !important;
        }
        
        
        /* Melhorar aparência dos apps no modal estilo mobile */
        #moreModal .app-item {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
            padding: 8px;
            border-radius: 12px;
        }
        
        #moreModal .app-item:hover {
            background-color: rgba(0, 0, 0, 0.05) !important;
            transform: translateY(-2px) !important;
        }
        
        
        #moreModal .app-item:active {
            transform: scale(0.95) !important;
        }
        
        
        /* Garantir que o ícone de perfil seja ocultado quando há foto */
        #headerProfileIcon.hidden,
        #modalProfileIcon.hidden,
        #managerProfilePlaceholder.hidden {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
            pointer-events: none !important;
        }
        
        /* Garantir que a foto de perfil seja exibida */
        #headerProfilePhoto:not(.hidden),
        #modalProfilePhoto:not(.hidden),
        #managerProfilePreview:not(.hidden) {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            pointer-events: auto !important;
        }
        
        /* Forçar fechamento do modal de foto do gerente */
        #managerPhotoChoiceModal.hidden {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
            pointer-events: none !important;
            position: fixed !important;
            z-index: -1 !important;
        }
        
        #managerPhotoChoiceModal[style*="display: none"] {
            visibility: hidden !important;
            opacity: 0 !important;
            pointer-events: none !important;
            position: fixed !important;
            z-index: -1 !important;
        }
        
        /* Garantir que o modal de foto do gerente seja exibido corretamente */
        #managerPhotoChoiceModal.flex {
            display: flex !important;
            visibility: visible !important;
            opacity: 1 !important;
            pointer-events: auto !important;
            position: fixed !important;
            z-index: 999999 !important;
        }
        
        #managerPhotoChoiceModal[style*="display: flex"] {
            visibility: visible !important;
            opacity: 1 !important;
            pointer-events: auto !important;
            position: fixed !important;
            z-index: 999999 !important;
        }
        
        /* Corrigir overflow nas contas secundárias */
        #secondaryAccountsList {
            overflow-x: hidden;
            overflow-y: auto;
            width: 100%;
        }
        
        #secondaryAccountsList > div {
            max-width: 100%;
            overflow: hidden;
            width: 100%;
        }
        
        /* Corrigir centralização no desktop */
        @media (min-width: 640px) {
            #secondaryAccountsList {
                display: flex;
                flex-direction: column;
                align-items: stretch;
                width: 100%;
            }
            
            #secondaryAccountsList > div {
                width: 100%;
                max-width: none;
                flex: 1;
            }
        }
        
        /* Garantir que o container das contas secundárias ocupe toda a largura */
        .bg-white.rounded-2xl.p-4.sm\\:p-8.border.border-gray-200.mx-0.sm\\:mx-4.mb-8 {
            width: 100%;
        }
        
        /* ==================== ANIMAÇÃO DE CONEXÃO COM SERVIDOR ==================== */
        /* From Uiverse.io by Juanes200122 */ 
        #svg_svg {
            zoom: 0.3;
        }
        .estrobo_animation {
            animation:
                floatAndBounce 4s infinite ease-in-out,
                strobe 0.8s infinite;
        }

        .estrobo_animationV2 {
            animation:
                floatAndBounce 4s infinite ease-in-out,
                strobev2 0.8s infinite;
        }

        #float_server {
            animation: floatAndBounce 4s infinite ease-in-out;
        }

        @keyframes floatAndBounce {
            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-20px);
            }
        }

        @keyframes strobe {
            0%,
            50%,
            100% {
                fill: #17e300;
            }

            25%,
            75% {
                fill: #17e300b4;
            }
        }

        @keyframes strobev2 {
            0%,
            50%,
            100% {
                fill: rgb(255, 95, 74);
            }

            25%,
            75% {
                fill: rgb(16, 53, 115);
            }
        }

        /* Animación de los colores del gradiente */
        @keyframes animateGradient {
            0% {
                stop-color: #313f8773;
            }

            50% {
                stop-color: #040d3a;
            }

            100% {
                stop-color: #313f8773;
            }
        }

        /* Animación aplicada a los puntos del gradiente */
        #paint13_linear_163_1030 stop {
            animation: animateGradient 4s infinite alternate;
        }
        
        /* Garantir que os textos longos sejam truncados */
        .truncate {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        /* Animações do header dinâmico - Global */
        #profileModalHeader {
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out !important;
        }
        
        /* Responsividade para telas pequenas */
        @media (max-width: 640px) {
            #secondaryAccountsList > div {
                padding: 0.75rem;
            }
            
            #secondaryAccountsList .flex-col {
                gap: 0.5rem;
            }
            
            /* Modal de perfil ocupar toda a tela no mobile */
            #profileModal {
                width: 100vw;
                height: 100vh;
                max-width: none;
                max-height: none;
                border-radius: 0;
                margin: 0;
            }
            
            #profileModal .modal-content {
                width: 100%;
                height: 100%;
                border-radius: 0;
                margin: 0;
            }
            
            /* Header do modal de perfil */
            #profileModalHeader {
                border-radius: 0;
                margin: 0;
                width: 100vw;
                margin-left: -1rem;
                margin-right: -1rem;
            }
            
            @media (min-width: 640px) {
                #profileModalHeader {
                    width: 100%;
                    margin-left: 0;
                    margin-right: 0;
                }
            }
            
            /* Conteúdo do modal responsivo - padding removido para evitar conflito com sticky header */
            
            /* Animações do header dinâmico */
            #profileModalHeader {
                transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out !important;
            }
        }
        
        @media (max-width: 360px) {
            #logoutConfirmationModal .bg-white,
            #logoutConfirmationModal .bg-white {
                margin: 0.5rem !important;
                padding: 1rem !important;
            }
            
            #logoutConfirmationModal h3 {
                font-size: 1rem !important;
            }
            
            #logoutConfirmationModal p {
                font-size: 0.85rem !important;
            }
            
            #logoutConfirmationModal .w-16 {
                width: 2.5rem !important;
                height: 2.5rem !important;
            }
            
            #logoutConfirmationModal .w-8 {
                width: 1.25rem !important;
                height: 1.25rem !important;
            }
        }
        
        /* Animação dos três pontinhos para indicador de digitando */
        .typing-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background-color: #9CA3AF;
            animation: typing 1.4s infinite ease-in-out;
        }
        
        .typing-dot:nth-child(1) {
            animation-delay: -0.32s;
        }
        
        .typing-dot:nth-child(2) {
            animation-delay: -0.16s;
        }
        
        @keyframes typing {
            0%, 80%, 100% {
                transform: scale(0.8);
                opacity: 0.5;
            }
            40% {
                transform: scale(1);
                opacity: 1;
            }
        }
    </style>
    
    <script>
    </script>
    
    <!-- Estilos personalizados para animações premium da seção de relatórios -->
    <style>
        /* Animações customizadas */
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-6px); }
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        .animate-float {
            animation: float 4s ease-in-out infinite;
        }
        
        /* Efeito shimmer nos botões */
        .btn-shimmer {
            position: relative;
            overflow: hidden;
        }
        
        .btn-shimmer::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                90deg,
                transparent,
                rgba(255, 255, 255, 0.4),
                transparent
            );
            transition: left 0.6s ease-in-out;
        }
        
        .btn-shimmer:hover::before {
            left: 100%;
        }
        
        /* Efeito de vidro melhorado */
        .glass-effect {
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }
        
        /* Sombras coloridas personalizadas */
        .shadow-red-glow {
            box-shadow: 0 10px 40px rgba(239, 68, 68, 0.3);
        }
        
        .shadow-green-glow {
            box-shadow: 0 10px 40px rgba(34, 197, 94, 0.3);
        }
        
        .shadow-purple-glow {
            box-shadow: 0 10px 40px rgba(147, 51, 234, 0.3);
        }
        
        /* Efeito de partículas flutuantes */
        .floating-particles::before,
        .floating-particles::after {
            content: '';
            position: absolute;
            width: 4px;
            height: 4px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            animation: float 3s ease-in-out infinite;
        }
        
        .floating-particles::before {
            top: 20%;
            right: 15%;
            animation-delay: -1s;
        }
        
        .floating-particles::after {
            bottom: 25%;
            left: 10%;
            animation-delay: -2s;
        }
    </style>

        
    <script>
        // Non-blocking alert shim routed to showNotification when available
>>>>>>> parent of 0eb3d2f (.)
        (function(){
            var originalAlert = window.alert;
            window.alert = function(message){
                try {
                    var msg = String(message);
                    console.log('🚨 Alert interceptado:', msg);
                    
                    // Tentar usar showNotification se disponível
                    if (typeof showNotification === 'function') {
                        showNotification(msg, 'warning');
                        return;
                    }
                    
                    // Fallback: usar modal system se disponível
                    if (typeof window.modalSystem !== 'undefined' && window.modalSystem.showAlert) {
                        window.modalSystem.showAlert(msg);
                        return;
                    }
                    
                    // Último recurso: console.warn
                    console.warn('Alert (fallback):', msg);
                } catch(e){
                    console.error('Erro no alert shim:', e);
                }
            };
            
            // Garantir que nossa função não seja sobrescrita
            Object.defineProperty(window, 'alert', {
                value: window.alert,
                writable: false,
                configurable: false
            });
        })();
        
        // Confirm shim for custom modals
        (function(){
            var originalConfirm = window.confirm;
            window.confirm = function(message){
                try {
                    var msg = String(message);
                    console.log('🚨 Confirm interceptado:', msg);
                    
                    // Usar modal system se disponível
                    if (typeof window.modalSystem !== 'undefined' && window.modalSystem.showConfirm) {
                        return window.modalSystem.showConfirm(msg);
                    }
                    
                    // Fallback: usar alert nativo (temporário)
                    console.warn('Confirm (fallback para alert nativo):', msg);
                    return originalConfirm(msg);
                } catch(e){
                    console.error('Erro no confirm shim:', e);
                    return originalConfirm(message);
                }
            };
            
            // Garantir que nossa função não seja sobrescrita
            Object.defineProperty(window, 'confirm', {
                value: window.confirm,
                writable: false,
                configurable: false
            });
        })();
    </script>
    <!-- Script fix_data_sync_complete.js removido para evitar conflitos -->

    <link rel="icon" href="https://i.postimg.cc/vmrkgDcB/lactech.png" type="image/x-icon">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="assets/css/style.css">
    <style>

        

        
        /* Efeito de foco nos botões */ 
        button:focus { 
            outline: none; 
        } 
        
        /* Classes Tailwind para focus-visible */ 
        .focus-visible:focus { 
            --tw-ring-offset-shadow: var(--tw-ring-inset) 0 0 0 var(--tw-ring-offset-width) var(--tw-ring-offset-color); 
            --tw-ring-shadow: var(--tw-ring-inset) 0 0 0 calc(2px + var(--tw-ring-offset-width)) var(--tw-ring-color); 
            box-shadow: var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow, 0 0 #0000); 
            --tw-ring-color: rgba(134, 209, 134, 0.5); 
            --tw-ring-offset-width: 2px; 
        } 
        
        /* Classe para background do ícone */ 
        .bg-forest-100 { 
            background-color: #f0f9f0; 
        } 
        
        /* Definição de cores personalizadas para o ring */
        :root {
            --forest-300: #86d186;
        }
        
        /* Animações da Câmera */
        @keyframes focusPulse {
            0%, 100% { transform: scale(1); opacity: 0.4; }
            50% { transform: scale(1.05); opacity: 0.8; }
        }
        
        @keyframes focusSuccess {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
<<<<<<< HEAD
        /* Sistema de loading REMOVIDO - sem tela de carregamento */
=======
        .focus-pulse {
            animation: focusPulse 2s ease-in-out infinite;
        }
        
        .focus-success {
            animation: focusSuccess 0.5s ease-in-out;
        }
>>>>>>> parent of 0eb3d2f (.)
        
        /* Estilos da câmera */
        .camera-overlay {
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        
        .camera-button {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .camera-button:hover {
            transform: scale(1.05);
        }
        
        /* Modal de Foto */
        #photoModal.show #photoModalContent {
            transform: scale(1);
            opacity: 1;
        }
        

    </style>
    <script>
        
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'forest': {
                            50: '#f0f9f0', 100: '#dcf2dc', 200: '#bce5bc', 300: '#8dd18d',
                            400: '#5bb85b', 500: '#369e36', 600: '#2a7f2a', 700: '#236523',
                            800: '#1f511f', 900: '#1a431a',
                        }
                    }
                }
            }
        }
    </script>
    

</head>
<<<<<<< HEAD
<!-- Tela de Carregamento - REMOVIDA - sem tela de loading -->
=======
<!-- Tela de Carregamento -->
<div id="loadingScreen" class="fixed inset-0 bg-black bg-opacity-75 backdrop-blur-sm flex items-center justify-center z-50">
    <div class="bg-white rounded-3xl p-8 max-w-md w-full mx-4 shadow-2xl text-center">
        <!-- Logo -->
        <div class="mb-6">
            <img src="assets/img/lactech-logo.png" alt="LacTech" class="w-20 h-20 mx-auto mb-4">
            <h2 class="text-2xl font-bold text-gray-800">LacTech</h2>
            <p class="text-gray-600" id="farmNameLoading">Carregando sistema...</p>
        </div>
        
        <!-- Mensagem de Status -->
        <div class="mb-6">
            <div id="loadingMessage" class="text-lg font-medium text-gray-700 mb-2">Inicializando sistema...</div>
            <div id="loadingSubMessage" class="text-sm text-gray-500">Preparando ambiente...</div>
        </div>
        
        <!-- Barra de Progresso -->
        <div class="mb-6">
            <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden">
                <div id="loadingProgress" class="bg-gradient-to-r from-forest-500 to-forest-600 h-3 rounded-full transition-all duration-500 ease-out" style="width: 0%"></div>
            </div>
            <div class="mt-2 text-sm text-gray-600">
                <span id="loadingPercentage">0%</span> concluído
            </div>
        </div>
        
        <!-- Indicador de Carregamento -->
        <div class="flex justify-center">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-forest-600"></div>
        </div>
    </div>
</div>
>>>>>>> parent of 0eb3d2f (.)

<body class="gradient-mesh antialiased transition-colors duration-300 main-content" id="mainBody" data-non-critical>

    <!-- Header -->
    <header class="gradient-forest shadow-xl sticky top-0 z-40 border-b border-forest-800 header-compact">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-14 sm:h-16">
                <div class="flex items-center space-x-3">
                    <div class="header-logo-container">
                        <img src="assets/img/lactech-logo.png" alt="LacTech Logo" class="header-logo">
                    </div>
                    <div>
                        <h1 class="text-lg font-bold text-white tracking-tight">PAINEL DO GERENTE</h1>
                        <p class="text-xs text-forest-200" id="farmNameHeader">Carregando...</p>
                    </div>
                </div>

                <!-- Desktop Navigation -->
                <nav class="hidden md:flex space-x-1">
                    <button class="nav-item active relative px-3 py-2 text-sm font-semibold text-white hover:text-forest-200 transition-all rounded-lg" data-tab="dashboard">
                        Dashboard
                    </button>
                    <button class="nav-item relative px-3 py-2 text-sm font-semibold text-white hover:text-forest-200 transition-all rounded-lg" data-tab="volume">
                        Volume
                    </button>
                    <button class="nav-item relative px-3 py-2 text-sm font-semibold text-white hover:text-forest-200 transition-all rounded-lg" data-tab="quality">
                        Qualidade
                    </button>
                    <button class="nav-item relative px-3 py-2 text-sm font-semibold text-white hover:text-forest-200 transition-all rounded-lg" data-tab="payments">
                        Financeiro
                    </button>
                    <button class="nav-item relative px-3 py-2 text-sm font-semibold text-white hover:text-forest-200 transition-all rounded-lg" data-tab="users">
                        Usuários
                    </button>
                    <button onclick="openMoreModal()" class="relative px-3 py-2 text-sm font-semibold text-white hover:text-forest-200 transition-all rounded-lg">
                        MAIS
                    </button>
                </nav>

                <div class="flex items-center space-x-4">
                    <!-- Botão de Notificações -->
                    <button onclick="openNotificationsModal()" class="relative p-2 text-white hover:text-forest-200 transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 17h5l-5 5v-5zM9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <span id="notificationCounter" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center hidden">0</span>
                        <!-- Indicador de tempo real -->
                        <div id="realTimeIndicator" class="absolute -bottom-1 -right-1 w-3 h-3 bg-green-500 rounded-full animate-pulse hidden" title="Sistema de atualização automática ativo"></div>
                    </button>
                    
                    
                    
                    <button onclick="openProfileModal()" class="flex items-center space-x-3 text-white hover:text-forest-200 p-2 rounded-lg transition-all">
                        <div class="relative w-8 h-8">
                            <!-- Foto do usuário -->
                            <img id="headerProfilePhoto" src="" alt="Foto de Perfil" class="w-8 h-8 object-cover rounded-full hidden">
                            <!-- Ícone padrão -->
                            <div id="headerProfileIcon" class="w-8 h-8 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                </svg>
                            </div>
                        </div>
                        <div class="text-left hidden sm:block">
                            <div class="text-sm font-semibold" id="managerName">Carregando...</div>
                            <div class="text-xs text-forest-200">Gerente</div>
                        </div>
                    </button>
                </div>
            </div>
        </div>
    </header>
    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-2 sm:px-4 lg:px-6 xl:px-8 py-4 sm:py-6 lg:py-8 pb-16 sm:pb-20 md:pb-4">
        
        <!-- Dashboard Tab -->
        <div id="dashboard-tab" class="tab-content">
            <!-- Welcome Section -->
            <div class="gradient-forest rounded-2xl p-4 sm:p-6 mb-4 sm:mb-6 text-white shadow-xl relative overflow-hidden">
                <div class="relative z-10">
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="text-xl sm:text-2xl font-bold mb-1 sm:mb-2">Bem-vindo, <span id="managerWelcome">Carregando...</span>!</h2>
                            <p class="text-forest-200 text-sm sm:text-base font-medium mb-2 sm:mb-3">Painel de controle gerencial</p>
                            <div class="flex items-center space-x-2 sm:space-x-4">
                                <div class="text-xs font-medium">Última atualização: <span id="lastUpdate">Agora</span></div>
                            </div>
                        </div>
                        <div class="hidden sm:block">
                            <div class="w-12 h-12 sm:w-16 sm:h-16 bg-white bg-opacity-20 rounded-2xl flex items-center justify-center backdrop-blur-sm">
                                <svg class="w-6 h-6 sm:w-8 sm:h-8" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
                                </svg>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Key Metrics -->
            <div class="grid grid-cols-2 gap-3 sm:gap-4 mb-4 sm:mb-6 grid-compact">
                <div class="metric-card rounded-2xl p-3 sm:p-4 text-center card-compact">
                    <div class="w-10 h-10 sm:w-12 sm:h-12 bg-blue-500 rounded-xl flex items-center justify-center mx-auto mb-2 sm:mb-3 shadow-lg">
                        <svg class="w-5 h-5 sm:w-6 sm:h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path>
                        </svg>
                    </div>
                    <div class="metric-value font-bold text-slate-900 mb-1" id="todayVolume">-- L</div>
                    <div class="metric-label text-slate-500 font-medium">Volume Hoje</div>
                    <div class="metric-label text-slate-600 font-semibold mt-1">Litros</div>
                </div>
                
                <div class="metric-card rounded-2xl p-3 sm:p-4 text-center card-compact">
                    <div class="w-10 h-10 sm:w-12 sm:h-12 bg-green-500 rounded-xl flex items-center justify-center mx-auto mb-2 sm:mb-3 shadow-lg">
                        <svg class="w-5 h-5 sm:w-6 sm:h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <div class="metric-value font-bold text-slate-900 mb-1" id="qualityAverage">--%</div>
                    <div class="metric-label text-slate-500 font-medium">Qualidade Média</div>
                    <div class="metric-label text-slate-600 font-semibold mt-1">Hoje</div>
                </div>
                
                <div class="metric-card rounded-2xl p-3 sm:p-4 text-center card-compact">
                    <div class="w-10 h-10 sm:w-12 sm:h-12 bg-purple-500 rounded-xl flex items-center justify-center mx-auto mb-2 sm:mb-3 shadow-lg">
                        <svg class="w-5 h-5 sm:w-6 sm:h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                        </svg>
                    </div>
                    <div class="metric-value font-bold text-slate-900 mb-1" id="pendingPayments">R$ --</div>
                    <div class="metric-label text-slate-500 font-medium">Pagamentos Pendentes</div>
                    <div class="metric-label text-slate-600 font-semibold mt-1">Este Mês</div>
                </div>
                
                <div class="metric-card rounded-2xl p-3 sm:p-4 text-center card-compact">
                    <div class="w-10 h-10 sm:w-12 sm:h-12 bg-orange-500 rounded-xl flex items-center justify-center mx-auto mb-2 sm:mb-3 shadow-lg">
                        <svg class="w-5 h-5 sm:w-6 sm:h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                        </svg>
                    </div>
                    <div class="metric-value font-bold text-slate-900 mb-1" id="activeUsers">--</div>
                    <div class="metric-label text-slate-500 font-medium">Usuários Ativos</div>
                    <div class="metric-label text-slate-600 font-semibold mt-1">Sistema</div>
                </div>
            </div>

            <!-- Charts Section -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-6 mb-4 sm:mb-6">
                <!-- Volume Chart -->
                <div class="data-card rounded-2xl p-4 sm:p-6 card-compact">
                    <h3 class="card-title font-bold text-slate-900 mb-3 sm:mb-4">Volume Semanal</h3>
                    <div class="chart-container">
                        <canvas id="volumeChart"></canvas>
                    </div>
                </div>

                <!-- Weekly Production Chart -->
                <div class="data-card rounded-2xl p-6">
                    <h3 class="text-lg font-bold text-slate-900 mb-4">Produção dos Últimos 7 Dias</h3>
                    <div class="chart-container">
                        <canvas id="dashboardWeeklyChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Temperature Chart Section -->
            <div class="grid grid-cols-1 gap-6 mb-6">
                <div class="data-card rounded-2xl p-6">
                    <h3 class="text-lg font-bold text-slate-900 mb-4">Controle de Temperatura</h3>
                    <div class="chart-container">
                        <canvas id="temperatureChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Monthly Production Chart -->
            <div class="data-card rounded-2xl p-6 mb-6">
                <h3 class="text-lg font-bold text-slate-900 mb-4">Volume de Produção do Mês</h3>
                <div class="h-64 relative">
                    <canvas id="monthlyProductionChart" width="800" height="256"></canvas>
                </div>
            </div>

            <!-- Recent Activities -->
            <div class="data-card rounded-2xl p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-bold text-slate-900">Atividades Recentes</h3>
                    <button onclick="showTab('volume')" class="text-forest-600 hover:text-forest-700 font-semibold text-sm">Ver Tudo</button>
                </div>
                <div class="space-y-3" id="recentActivities">
                    <div class="text-center py-8">
                        <div class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <p class="text-gray-500 text-sm">Nenhuma atividade recente</p>
                        <p class="text-gray-400 text-xs">Registros aparecerão aqui</p>
                    </div>
                </div>
            </div>

        </div>

        <!-- Volume Tab -->
        <div id="volume-tab" class="tab-content hidden">
            <div class="space-y-6">
                <!-- Volume Header -->
                <div class="data-card rounded-2xl p-6">
                    <div class="flex flex-col sm:flex-row sm:items-center justify-between mb-6 gap-4">
                        <div>
                            <h2 class="text-xl md:text-2xl font-bold text-slate-900 mb-1">Controle de Volume</h2>
            <p class="text-slate-600 text-sm">Monitore a produção de leite em tempo real</p>
                        </div>
                        <div class="flex flex-col sm:flex-row gap-3 w-full sm:w-auto">
                            <select id="volumePeriod" class="px-4 py-2 border border-slate-200 rounded-lg text-sm focus:border-forest-500 focus:outline-none bg-white">
                                <option value="today">Hoje</option>
                                <option value="week">Esta Semana</option>
                                <option value="month">Este Mês</option>
                            </select>
                            <button onclick="openIndividualVolumeModal()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:shadow-lg transition-all font-semibold text-sm">
                                <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M19 14l-7 7m0 0l-7-7m7 7V3"></path>
                                </svg>
                                Por Vaca
                            </button>
                            <button onclick="exportVolumeReport()" class="px-4 py-2 bg-forest-600 text-white rounded-lg hover:shadow-lg transition-all font-semibold text-sm">
                                <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 10v6m0 0l-4-4m4 4l4-4m3 8H5a2 2 0 01-2-2V7a2 2 0 012-2h4l2 2h4a2 2 0 012 2v1"></path>
                                </svg>
                                Exportar
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Volume Metrics -->
                <div class="grid grid-cols-2 gap-4">
                    <div class="metric-card rounded-2xl p-4 text-center">
                        <div class="w-12 h-12 bg-blue-500 rounded-xl flex items-center justify-center mx-auto mb-3 shadow-lg">
                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path>
                            </svg>
                        </div>
                        <div class="text-xl font-bold text-slate-900 mb-1" id="volumeToday">-- L</div>
                    <div class="text-xs text-slate-500 font-medium">Hoje</div>
                    <div class="text-xs text-slate-600 font-semibold mt-1">Total</div>
                    </div>
                    
                    <div class="metric-card rounded-2xl p-4 text-center">
                        <div class="w-12 h-12 bg-green-500 rounded-xl flex items-center justify-center mx-auto mb-3 shadow-lg">
                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                            </svg>
                        </div>
                        <div class="text-xl font-bold text-slate-900 mb-1" id="volumeWeekAvg">-- L</div>
                    <div class="text-xs text-slate-500 font-medium">Média Semanal</div>
                    <div class="text-xs text-slate-600 font-semibold mt-1">Por Dia</div>
                    </div>
                    
                    <div class="metric-card rounded-2xl p-4 text-center">
                        <div class="w-12 h-12 bg-purple-500 rounded-xl flex items-center justify-center mx-auto mb-3 shadow-lg">
                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                            </svg>
                        </div>
                        <div class="text-xl font-bold text-slate-900 mb-1" id="volumeGrowth">+0%</div>
                    <div class="text-xs text-slate-500 font-medium">Crescimento</div>
                    <div class="text-xs text-slate-600 font-semibold mt-1">vs. Semana Anterior</div>
                    </div>
                    
                    <div class="metric-card rounded-2xl p-4 text-center">
                        <div class="w-12 h-12 bg-orange-500 rounded-xl flex items-center justify-center mx-auto mb-3 shadow-lg">
                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <div class="text-lg font-bold text-slate-900 mb-1" id="lastCollection">--/--/---- - --:--</div>
                    <div class="text-xs text-slate-500 font-medium">Última Coleta</div>
                    <div class="text-xs text-slate-600 font-semibold mt-1">Data e Hora</div>
                    </div>
                </div>

                <!-- Volume Charts -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Daily Production Chart -->
                    <div class="data-card rounded-2xl p-6">
                        <h3 class="text-lg font-bold text-slate-900 mb-4">Produção Diária</h3>
                        <div class="chart-container">
                            <canvas id="dailyVolumeChart"></canvas>
                        </div>
                    </div>

                    <!-- Weekly Production Chart -->
                    <div class="data-card rounded-2xl p-6">
                        <h3 class="text-lg font-bold text-slate-900 mb-4">Produção Semanal</h3>
                        <div class="chart-container">
                            <canvas id="weeklyVolumeChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Weekly Summary Chart (only visible on Sundays) -->
                <div id="weeklySummaryChartContainer" class="data-card rounded-2xl p-6" style="display: none;">
                    <h3 class="text-lg font-bold text-slate-900 mb-4">Resumo Semanal</h3>
                    <div class="chart-container">
                        <canvas id="weeklySummaryChart"></canvas>
                    </div>
                </div>

                <!-- Monthly Volume Chart (only visible on last day of month) -->
                <div id="monthlyVolumeChartContainer" class="data-card rounded-2xl p-6" style="display: none;">
                    <h3 class="text-lg font-bold text-slate-900 mb-4">Produção Mensal</h3>
                    <div class="chart-container">
                        <canvas id="monthlyVolumeChart"></canvas>
                    </div>
                </div>

                <!-- Volume Records -->
                <div class="data-card rounded-2xl p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-bold text-slate-900">Registros de Volume</h3>
                        <button onclick="addVolumeRecord()" class="px-4 py-2 bg-forest-600 text-white rounded-lg hover:shadow-lg transition-all font-semibold text-sm">
                            <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                            </svg>
                            Novo Registro
                        </button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="border-b border-gray-200">
                                    <th class="text-left py-3 px-4 font-semibold text-slate-900">Data/Hora</th>
                                    <th class="text-left py-3 px-4 font-semibold text-slate-900">Volume (L)</th>
                                    <th class="text-left py-3 px-4 font-semibold text-slate-900">Funcionário</th>
                                    <th class="text-left py-3 px-4 font-semibold text-slate-900">Observações</th>
                                    <th class="text-left py-3 px-4 font-semibold text-slate-900">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="volumeRecords">
                                <tr>
                                    <td colspan="5" class="text-center py-8 text-gray-500">
                                        Nenhum registro encontrado
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quality Tab -->
        <div id="quality-tab" class="tab-content hidden">
            <div class="space-y-6">
                <!-- Quality Header -->
                <div class="data-card rounded-2xl p-6">
                    <div class="flex flex-col sm:flex-row sm:items-center justify-between mb-6 gap-4">
                        <div>
                            <h2 class="text-xl md:text-2xl font-bold text-slate-900 mb-1">Controle de Qualidade</h2>
            <p class="text-slate-600 text-sm">Monitore os parâmetros de qualidade do leite</p>
                        </div>
                        <div class="flex flex-col sm:flex-row gap-3 w-full sm:w-auto">
                            <select id="qualityPeriod" class="px-4 py-2 border border-slate-200 rounded-lg text-sm focus:border-forest-500 focus:outline-none bg-white">
                                <option value="today">Hoje</option>
                                <option value="week">Esta Semana</option>
                                <option value="month">Este Mês</option>
                            </select>
                            <button onclick="exportQualityReport()" class="px-4 py-2 bg-forest-600 text-white rounded-lg hover:shadow-lg transition-all font-semibold text-sm">
                                <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                Relatório
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Quality Indicators -->
                <div class="grid grid-cols-2 gap-4">
                    <div class="data-card rounded-2xl p-4">
                        <div class="flex items-center justify-between mb-3">
                            <h4 class="font-semibold text-slate-900">Gordura</h4>
                            <span class="text-lg font-bold text-slate-900" id="fatContent">-</span>
                        </div>
                        <div class="quality-indicator">
                            <div class="quality-bar" id="fatQualityBar" style="width: 0%"></div>
                        </div>
                        <p class="text-xs text-slate-500 mt-2" id="fatQualityText">-</p>
                    </div>

                    <div class="data-card rounded-2xl p-4">
                        <div class="flex items-center justify-between mb-3">
                            <h4 class="font-semibold text-slate-900">Proteína</h4>
                            <span class="text-lg font-bold text-slate-900" id="proteinContent">-</span>
                        </div>
                        <div class="quality-indicator">
                            <div class="quality-bar" id="proteinQualityBar" style="width: 0%"></div>
                        </div>
                        <p class="text-xs text-slate-500 mt-2" id="proteinQualityText">-</p>
                    </div>

                    <div class="data-card rounded-2xl p-4">
                        <div class="flex items-center justify-between mb-3">
                            <h4 class="font-semibold text-slate-900">CCS</h4>
                            <span class="text-lg font-bold text-slate-900" id="sccCount">-</span>
                        </div>
                        <div class="quality-indicator">
                            <div class="quality-bar" id="sccQualityBar" style="width: 0%"></div>
                        </div>
                        <p class="text-xs text-slate-500 mt-2" id="sccQualityText">-</p>
                    </div>

                    <div class="data-card rounded-2xl p-4">
                        <div class="flex items-center justify-between mb-3">
                            <h4 class="font-semibold text-slate-900">CBT</h4>
                            <span class="text-lg font-bold text-slate-900" id="tbc">-</span>
                        </div>
                        <div class="quality-indicator">
                            <div class="quality-bar" id="tbcQualityBar" style="width: 0%"></div>
                        </div>
                        <p class="text-xs text-slate-500 mt-2" id="tbcQualityText">-</p>
                    </div>
                </div>
                <!-- Quality Trends -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="data-card rounded-2xl p-6">
                        <h3 class="text-lg font-bold text-slate-900 mb-4">Tendência de Qualidade</h3>
                        <div class="chart-container">
                            <canvas id="qualityTrendChart"></canvas>
                        </div>
                    </div>

                    <div class="data-card rounded-2xl p-6">
                        <h3 class="text-lg font-bold text-slate-900 mb-4">Distribuição de Qualidade</h3>
                        <div class="chart-container">
                            <canvas id="qualityDistributionChart"></canvas>
                        </div>
                    </div>

                    <div class="data-card rounded-2xl p-6">
                        <h3 class="text-lg font-bold text-slate-900 mb-4">Qualidade Semanal</h3>
                        <div class="chart-container">
                            <canvas id="qualityChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Quality Tests -->
                <div class="data-card rounded-2xl p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-bold text-slate-900">Testes de Qualidade</h3>
                        <button onclick="addQualityTest()" class="px-4 py-2 bg-forest-600 text-white rounded-lg hover:shadow-lg transition-all font-semibold text-sm">
                            <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                            </svg>
                            Novo Teste
                        </button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="border-b border-gray-200">
                                    <th class="text-left py-3 px-4 font-semibold text-slate-900">Data</th>
                                    <th class="text-left py-3 px-4 font-semibold text-slate-900">Gordura</th>
                                    <th class="text-left py-3 px-4 font-semibold text-slate-900">Proteína</th>
                                    <th class="text-left py-3 px-4 font-semibold text-slate-900">CCS</th>
                                    <th class="text-left py-3 px-4 font-semibold text-slate-900">CBT</th>
                                    <th class="text-left py-3 px-4 font-semibold text-slate-900">Laboratório</th>
                                    <th class="text-left py-3 px-4 font-semibold text-slate-900">Observações</th>
                                    <th class="text-left py-3 px-4 font-semibold text-slate-900">Status</th>
                                    <th class="text-left py-3 px-4 font-semibold text-slate-900">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="qualityTests">
                                <tr>
                                    <td colspan="9" class="text-center py-8 text-gray-500">
                                        Nenhum teste encontrado
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Financial Records Tab -->
        <div id="payments-tab" class="tab-content hidden">
            <div class="space-y-6">
                <!-- Financial Records Header -->
                <div class="data-card rounded-2xl p-6">
                    <div class="flex flex-col sm:flex-row sm:items-center justify-between mb-6 gap-4">
                        <div>
                            <h2 class="text-xl md:text-2xl font-bold text-slate-900 mb-1">Controle de Vendas</h2>
                <p class="text-slate-600 text-sm">Gerencie vendas de leite e recebimentos</p>
                        </div>
                        <div class="flex flex-col sm:flex-row gap-3 w-full sm:w-auto">
                            <select id="paymentPeriod" class="px-4 py-2 border border-slate-200 rounded-lg text-sm focus:border-forest-500 focus:outline-none bg-white">
                                <option value="month">Este Mês</option>
                                <option value="quarter">Trimestre</option>
                                <option value="year">Ano</option>
                            </select>
                            <button onclick="generatePaymentsReport()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:shadow-lg transition-all font-semibold text-sm">
                                <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                Relatório
                            </button>
                            <button onclick="addPayment()" class="px-4 py-2 bg-forest-600 text-white rounded-lg hover:shadow-lg transition-all font-semibold text-sm">
                        <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                        </svg>
                        Nova Venda
                    </button>
                        </div>
                    </div>
                </div>

                <!-- Payment Summary -->
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="data-card rounded-2xl p-6 text-center">
                        <div class="w-16 h-16 bg-green-100 rounded-2xl flex items-center justify-center mx-auto mb-4">
                            <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <div class="text-2xl font-bold text-slate-900 mb-2" id="paidAmount">-</div>
                        <div class="text-sm text-slate-600 font-medium">Vendas Realizadas</div>
                        <div class="text-xs text-green-600 font-semibold mt-2">Este Mês</div>
                    </div>

                    <div class="data-card rounded-2xl p-6 text-center">
                        <div class="w-16 h-16 bg-yellow-100 rounded-2xl flex items-center justify-center mx-auto mb-4">
                            <svg class="w-8 h-8 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <div class="text-2xl font-bold text-slate-900 mb-2" id="pendingAmount">-</div>
                        <div class="text-sm text-slate-600 font-medium">Vendas Pendentes</div>
                        <div class="text-xs text-yellow-600 font-semibold mt-2">A Vencer</div>
                    </div>

                    <div class="data-card rounded-2xl p-6 text-center">
                        <div class="w-16 h-16 bg-red-100 rounded-2xl flex items-center justify-center mx-auto mb-4">
                            <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                            </svg>
                        </div>
                        <div class="text-2xl font-bold text-slate-900 mb-2" id="overdueAmount">-</div>
                        <div class="text-sm text-slate-600 font-medium">Vendas Atrasadas</div>
                        <div class="text-xs text-red-600 font-semibold mt-2">Vencidos</div>
                    </div>
                </div>

                <!-- Payment Chart -->
                <div class="data-card rounded-2xl p-6">
                    <h3 class="text-lg font-bold text-slate-900 mb-4">Fluxo de Vendas</h3>
                    <div class="chart-container">
                        <canvas id="paymentsChart"></canvas>
                    </div>
                </div>
                <!-- Payments List -->
                <div class="data-card rounded-2xl p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-bold text-slate-900">Lista de Vendas</h3>
                        <div class="flex gap-2">
                            <select id="paymentFilter" class="px-3 py-2 border border-slate-200 rounded-lg text-sm focus:border-forest-500 focus:outline-none bg-white">
                                <option value="all">Todos</option>
                                <option value="paid">Pagos</option>
                                <option value="pending">Pendentes</option>
                                <option value="overdue">Atrasados</option>
                            </select>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="border-b border-gray-200">
                                    <th class="text-left py-3 px-4 font-semibold text-slate-900">Beneficiário</th>
                                    <th class="text-left py-3 px-4 font-semibold text-slate-900">Tipo</th>
                                    <th class="text-left py-3 px-4 font-semibold text-slate-900">Valor</th>
                                    <th class="text-left py-3 px-4 font-semibold text-slate-900">Vencimento</th>
                                    <th class="text-left py-3 px-4 font-semibold text-slate-900">Status</th>
                                    <th class="text-left py-3 px-4 font-semibold text-slate-900">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="paymentsList">
                                <tr>
                                    <td colspan="6" class="text-center py-8 text-gray-500">
                                        Nenhuma venda encontrada
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Users Tab -->
        <div id="users-tab" class="tab-content hidden users-section">
            <div class="space-y-6 sm:space-y-8">
                <!-- Users Header -->
                <div class="data-card rounded-2xl p-4 sm:p-6">
                    <div class="flex flex-col sm:flex-row sm:items-center justify-between mb-4 sm:mb-6 gap-3 sm:gap-4">
                        <div>
                            <h2 class="text-lg sm:text-xl md:text-2xl font-bold text-slate-900 mb-1">Gestão de Usuários</h2>
                            <p class="text-slate-600 text-xs sm:text-sm">Gerencie funcionários e suas permissões</p>
                        </div>
                        <div class="flex flex-col sm:flex-row gap-2 sm:gap-3 w-full sm:w-auto">
                            <select id="userFilter" class="px-3 sm:px-4 py-2 border border-slate-200 rounded-lg text-sm focus:border-forest-500 focus:outline-none bg-white">
                                <option value="all">Todos os usuários</option>
                                <option value="funcionario">Funcionários</option>
                                <option value="veterinario">Veterinários</option>
                                <option value="proprietario">Proprietários</option>
                            </select>
                            <button onclick="addUser()" class="px-3 sm:px-4 py-2 bg-forest-600 text-white rounded-lg hover:shadow-lg transition-all font-semibold text-sm">
                                <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                </svg>
                                Adicionar Usuário
                            </button>
                        </div>
                    </div>
                </div>

                <!-- User Stats -->
                <div class="grid grid-cols-2 gap-4 sm:gap-6">
                    <div class="data-card rounded-2xl p-4 sm:p-6 text-center metric-card-responsive">
                        <div class="w-10 h-10 sm:w-12 sm:h-12 bg-blue-500 rounded-xl flex items-center justify-center mx-auto mb-2 sm:mb-3 shadow-lg">
                            <svg class="w-5 h-5 sm:w-6 sm:h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                            </svg>
                        </div>
                        <div class="text-lg sm:text-xl font-bold text-slate-900 mb-1" id="totalUsers">--</div>
                        <div class="text-xs text-slate-500 font-medium">Total</div>
                        <div class="text-xs text-slate-600 font-semibold mt-1">Usuários</div>
                    </div>
                    
                    <div class="data-card rounded-2xl p-4 sm:p-6 text-center metric-card-responsive">
                        <div class="w-10 h-10 sm:w-12 sm:h-12 bg-green-500 rounded-xl flex items-center justify-center mx-auto mb-2 sm:mb-3 shadow-lg">
                            <svg class="w-5 h-5 sm:w-6 sm:h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                            </svg>
                        </div>
                        <div class="text-lg sm:text-xl font-bold text-slate-900 mb-1" id="employeesCount">--</div>
                        <div class="text-xs text-slate-500 font-medium">Funcionários</div>
                        <div class="text-xs text-slate-600 font-semibold mt-1">Ativos</div>
                    </div>
                    
                    <div class="data-card rounded-2xl p-4 sm:p-6 text-center metric-card-responsive">
                        <div class="w-10 h-10 sm:w-12 sm:h-12 bg-purple-500 rounded-xl flex items-center justify-center mx-auto mb-2 sm:mb-3 shadow-lg">
                            <svg class="w-5 h-5 sm:w-6 sm:h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                            </svg>
                        </div>
                        <div class="text-lg sm:text-xl font-bold text-slate-900 mb-1" id="veterinariansCount">--</div>
                        <div class="text-xs text-slate-500 font-medium">Veterinários</div>
                        <div class="text-xs text-slate-600 font-semibold mt-1">Ativos</div>
                    </div>
                    
                    <div class="data-card rounded-2xl p-4 sm:p-6 text-center metric-card-responsive">
                        <div class="w-10 h-10 sm:w-12 sm:h-12 bg-orange-500 rounded-xl flex items-center justify-center mx-auto mb-2 sm:mb-3 shadow-lg">
                            <svg class="w-5 h-5 sm:w-6 sm:h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                            </svg>
                        </div>
                        <div class="text-lg sm:text-xl font-bold text-slate-900 mb-1" id="managersCount">--</div>
                        <div class="text-xs text-slate-500 font-medium">Gerentes</div>
                        <div class="text-xs text-slate-600 font-semibold mt-1">Ativos</div>
                    </div>
                </div>

                <!-- Users List -->
                <div class="data-card rounded-2xl p-4 sm:p-6">
                    <h3 class="text-base sm:text-lg font-bold text-slate-900 mb-4 sm:mb-6">Lista de Usuários</h3>
                    <div class="space-y-4 sm:space-y-6" id="usersList">
                        <div class="text-center py-8 sm:py-12">
                            <div class="w-16 h-16 sm:w-20 sm:h-20 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4 sm:mb-6">
                                <svg class="w-8 h-8 sm:w-10 sm:h-10 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                </svg>
                            </div>
                            <h3 class="text-base sm:text-lg font-semibold text-gray-900 mb-2">Nenhum Usuário Cadastrado</h3>
                            <p class="text-gray-600 mb-3 sm:mb-4 text-sm">Adicione usuários para gerenciar sua equipe</p>
                            <button onclick="addUser()" class="px-4 sm:px-6 py-2 sm:py-3 gradient-forest text-white font-semibold rounded-xl hover:shadow-lg transition-all text-sm">
                                <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                </svg>
                                Adicionar Primeiro Usuário
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Enhanced Mobile Navigation -->
    <nav class="fixed bottom-0 left-0 right-0 md:hidden mobile-nav-enhanced shadow-2xl z-40">
        <div class="grid grid-cols-6 gap-1 p-2">
            <button class="mobile-nav-item active flex flex-col items-center py-2 px-1 transition-all" data-tab="dashboard">
                <svg class="w-4 h-4 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2H5a2 2 0 00-2-2z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" d="M8 7V5a2 2 0 012-2h4a2 2 0 012 2v2"></path>
                </svg>
                <span class="text-xs font-semibold">Dashboard</span>
            </button>
            <button class="mobile-nav-item flex flex-col items-center py-2 px-1 transition-all" data-tab="volume">
                <svg class="w-4 h-4 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path>
                            </svg>
                <span class="text-xs font-semibold">Volume</span>
            </button>
            <button class="mobile-nav-item flex flex-col items-center py-2 px-1 transition-all" data-tab="quality">
                <svg class="w-4 h-4 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <span class="text-xs font-semibold">Qualidade</span>
            </button>
            <button class="mobile-nav-item flex flex-col items-center py-2 px-1 transition-all" data-tab="payments">
                <svg class="w-4 h-4 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                </svg>
                <span class="text-xs font-semibold">Financeiro</span>
            </button>
            <button class="mobile-nav-item flex flex-col items-center py-2 px-1 transition-all" data-tab="users">
                <svg class="w-4 h-4 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 19.128a9.38 9.38 0 002.625.372 9.337 9.337 0 004.121-.952 4.125 4.125 0 00-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 018.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0111.964-3.07M12 6.375a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zm8.25 2.25a2.625 2.625 0 11-5.25 0 2.625 2.625 0 015.25 0z"></path>
                </svg>
                <span class="text-xs font-semibold">Usuários</span>
            </button>
            <button class="mobile-nav-item flex flex-col items-center py-2 px-1 transition-all" data-tab="animals">
                <svg class="w-4 h-4 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M19 14l-7 7m0 0l-7-7m7 7V3"></path>
                </svg>
                <span class="text-xs font-semibold">Animais</span>
            </button>
            <button class="mobile-nav-item flex flex-col items-center py-2 px-1 transition-all" onclick="openMoreModal()">
                <svg class="w-4 h-4 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"></path>
                            </svg>
                <span class="text-xs font-semibold">Mais</span>
            </button>
        </div>
    </nav>
    
    <!-- Animals Management Tab -->
    <div id="animals-tab" class="tab-content hidden animals-section">
        <div class="space-y-6 sm:space-y-8">
            <!-- Animals Header -->
            <div class="data-card rounded-2xl p-4 sm:p-6">
                <div class="flex flex-col sm:flex-row sm:items-center justify-between mb-4 sm:mb-6 gap-3 sm:gap-4">
                    <div>
                        <h2 class="text-lg sm:text-xl md:text-2xl font-bold text-slate-900 mb-1">Gestão de Animais</h2>
                        <p class="text-slate-600 text-xs sm:text-sm">Gerencie o rebanho da Lagoa do Mato</p>
                    </div>
                    <div class="flex flex-col sm:flex-row gap-2 sm:gap-3 w-full sm:w-auto">
                        <button onclick="openAddAnimalModal()" class="px-3 sm:px-4 py-2 bg-forest-600 text-white rounded-lg hover:shadow-lg transition-all font-semibold text-sm">
                            <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                            </svg>
                            Adicionar Animal
                        </button>
                    </div>
                </div>
            </div>

            <!-- Animal Stats -->
            <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 sm:gap-6">
                <div class="data-card rounded-2xl p-4 sm:p-6 text-center metric-card-responsive">
                    <div class="w-10 h-10 sm:w-12 sm:h-12 bg-green-500 rounded-xl flex items-center justify-center mx-auto mb-2 sm:mb-3 shadow-lg">
                        <svg class="w-5 h-5 sm:w-6 sm:h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19 14l-7 7m0 0l-7-7m7 7V3"></path>
                        </svg>
                    </div>
                    <div class="text-lg sm:text-xl font-bold text-slate-900 mb-1" id="totalAnimals">--</div>
                    <div class="text-xs text-slate-500 font-medium">Total</div>
                    <div class="text-xs text-slate-600 font-semibold mt-1">Animais</div>
                </div>
                
                <div class="data-card rounded-2xl p-4 sm:p-6 text-center metric-card-responsive">
                    <div class="w-10 h-10 sm:w-12 sm:h-12 bg-blue-500 rounded-xl flex items-center justify-center mx-auto mb-2 sm:mb-3 shadow-lg">
                        <svg class="w-5 h-5 sm:w-6 sm:h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <div class="text-lg sm:text-xl font-bold text-slate-900 mb-1" id="healthyAnimals">--</div>
                    <div class="text-xs text-slate-500 font-medium">Saudáveis</div>
                    <div class="text-xs text-slate-600 font-semibold mt-1">Animais</div>
                </div>
                
                <div class="data-card rounded-2xl p-4 sm:p-6 text-center metric-card-responsive">
                    <div class="w-10 h-10 sm:w-12 sm:h-12 bg-yellow-500 rounded-xl flex items-center justify-center mx-auto mb-2 sm:mb-3 shadow-lg">
                        <svg class="w-5 h-5 sm:w-6 sm:h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                        </svg>
                    </div>
                    <div class="text-lg sm:text-xl font-bold text-slate-900 mb-1" id="warningAnimals">--</div>
                    <div class="text-xs text-slate-500 font-medium">Em Tratamento</div>
                    <div class="text-xs text-slate-600 font-semibold mt-1">Animais</div>
                </div>
                
                <div class="data-card rounded-2xl p-4 sm:p-6 text-center metric-card-responsive">
                    <div class="w-10 h-10 sm:w-12 sm:h-12 bg-red-500 rounded-xl flex items-center justify-center mx-auto mb-2 sm:mb-3 shadow-lg">
                        <svg class="w-5 h-5 sm:w-6 sm:h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <div class="text-lg sm:text-xl font-bold text-slate-900 mb-1" id="criticalAnimals">--</div>
                    <div class="text-xs text-slate-500 font-medium">Doentes</div>
                    <div class="text-xs text-slate-600 font-semibold mt-1">Animais</div>
                </div>
            </div>

            <!-- Animals List -->
            <div class="data-card rounded-2xl p-4 sm:p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-slate-900">Lista de Animais</h3>
                    <div class="flex gap-2">
                        <button onclick="openAddTreatmentModal()" class="px-3 py-1.5 bg-blue-600 text-white rounded-lg text-sm hover:bg-blue-700 transition-all">
                            <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                            </svg>
                            Tratamento
                        </button>
                        <button onclick="openAddInseminationModal()" class="px-3 py-1.5 bg-purple-600 text-white rounded-lg text-sm hover:bg-purple-700 transition-all">
                            <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                            </svg>
                            Inseminação
                        </button>
                    </div>
                </div>
                <div id="animalsList" class="space-y-3">
                    <div class="text-center py-8 text-gray-500">
                        <svg class="w-12 h-12 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19 14l-7 7m0 0l-7-7m7 7V3"></path>
                        </svg>
                        <p>Carregando animais...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Reports Tab -->
    <div id="reports-tab" class="tab-content hidden">
        <div class="px-4 sm:px-6 lg:px-8 py-6">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <!-- Configurações de Relatórios -->
            <div class="bg-gradient-to-br from-white to-slate-50 rounded-2xl p-8 border border-slate-200 shadow-lg">
                <!-- Header da Seção -->
                <div class="flex items-center mb-6">
                    <div class="p-3 bg-gradient-to-br from-green-500 to-green-600 rounded-xl mr-4">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>
                        </div>
                    <div>
                        <h3 class="text-xl font-bold text-slate-900">Configurações de Relatórios</h3>
                        <p class="text-sm text-slate-600">Personalize a aparência dos seus relatórios</p>
                    </div>
                    </div>
                    
                <div class="space-y-6">
                    <!-- Nome da Fazenda -->
                    <div class="space-y-2">
                        <label class="block text-sm font-semibold text-slate-700 flex items-center">
                            <svg class="w-4 h-4 mr-2 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2H5a2 2 0 00-2-2z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V5a2 2 0 012-2h4a2 2 0 012 2v2"></path>
                            </svg>
                            Nome da Fazenda
                        </label>
                        <input type="text" id="reportFarmNameTab" class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:border-green-500 focus:ring-2 focus:ring-green-100 focus:outline-none bg-white shadow-sm transition-all" placeholder="Digite o nome da fazenda">
                </div>

                    <!-- Upload da Logo da Fazenda -->
                    <div class="space-y-3">
                        <label class="block text-sm font-semibold text-slate-700 flex items-center">
                            <svg class="w-4 h-4 mr-2 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                            </svg>
                            Logo da Fazenda
                        </label>
                        
                        <div class="bg-white rounded-xl p-4 border border-slate-200 shadow-sm">
                            <div class="flex items-center space-x-4">
                                <div class="relative">
                                    <!-- Preview da logo -->
                                    <div id="farmLogoPreviewTab" class="w-20 h-20 border-2 border-dashed border-green-300 rounded-xl flex items-center justify-center bg-green-50 hidden">
                                        <img id="farmLogoImageTab" src="" alt="Logo da Fazenda" class="w-full h-full object-cover rounded-xl">
                        </div>
                                    <!-- Placeholder quando não há logo -->
                                    <div id="farmLogoPlaceholderTab" class="w-20 h-20 border-2 border-dashed border-slate-300 rounded-xl flex items-center justify-center bg-slate-50">
                                        <svg class="w-8 h-8 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                        </svg>
                    </div>
                </div>
                                <div class="flex-1 space-y-2">
                                    <div class="flex flex-wrap gap-2">
                                        <button onclick="document.getElementById('farmLogoUploadTab').click()" class="flex items-center px-4 py-2 bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-medium rounded-lg transition-all text-sm shadow-md hover:shadow-lg">
                                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                                <path stroke-linecap="round" stroke-linejoin="round" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                            </svg>
                                            Escolher Logo
                                        </button>
                                        <button id="removeFarmLogoTab" onclick="removeFarmLogoTab()" class="flex items-center px-4 py-2 bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white font-medium rounded-lg transition-all text-sm shadow-md hover:shadow-lg hidden">
                                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                                <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                            </svg>
                                            Remover
                                        </button>
                    </div>
                                    <input type="file" id="farmLogoUploadTab" accept="image/*" class="hidden" onchange="handleFarmLogoUploadTab(event)">
                                    <p class="text-xs text-slate-500 flex items-center">
                                        <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                        PNG, JPG, JPEG (máx. 2MB) - Preferência: formato quadrado
                                    </p>
                </div>
                            </div>
                    </div>
                </div>

                    <!-- Botão Salvar -->
                    <div class="pt-4 border-t border-slate-200">
                        <button onclick="saveReportSettingsTab()" class="w-full sm:w-auto flex items-center justify-center px-8 py-3 bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white font-semibold rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 transform hover:-translate-y-0.5">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"></path>
                            </svg>
                            Salvar Configurações
                        </button>
                </div>
            </div>
        </div>

            <!-- Estatísticas Rápidas -->
            <div class="bg-gradient-to-br from-green-50 to-emerald-50 rounded-2xl p-4 sm:p-6 lg:p-8 border border-green-200 shadow-lg relative overflow-hidden">
                <!-- Background Pattern -->
                <div class="absolute inset-0 opacity-5">
                    <div class="absolute inset-0 bg-gradient-to-br from-green-500 to-emerald-600"></div>
                    <svg class="absolute top-0 right-0 w-20 sm:w-24 lg:w-32 h-20 sm:h-24 lg:h-32 transform translate-x-4 sm:translate-x-6 lg:translate-x-8 -translate-y-4 sm:-translate-y-6 lg:-translate-y-8" fill="currentColor" viewBox="0 0 100 100">
                        <circle cx="50" cy="50" r="35"/>
                    </svg>
                    <svg class="absolute bottom-0 left-0 w-16 sm:w-20 lg:w-24 h-16 sm:h-20 lg:h-24 transform -translate-x-2 sm:-translate-x-3 lg:-translate-x-4 translate-y-2 sm:translate-y-3 lg:translate-y-4" fill="currentColor" viewBox="0 0 100 100">
                        <rect x="30" y="30" width="40" height="40" rx="8"/>
                    </svg>
                        </div>
                
                <!-- Header da Seção -->
                <div class="relative flex flex-col sm:flex-row items-start sm:items-center mb-4 sm:mb-6">
                    <div class="p-2 sm:p-3 bg-gradient-to-br from-green-500 to-emerald-600 rounded-lg sm:rounded-xl mr-0 sm:mr-4 mb-3 sm:mb-0">
                        <svg class="w-5 h-5 sm:w-6 sm:h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                </svg>
                        </div>
                    <div>
                        <h3 class="text-lg sm:text-xl font-bold text-slate-900">Resumo de Produção</h3>
                        <p class="text-xs sm:text-sm text-slate-600">Indicadores em tempo real</p>
                    </div>
                </div>

                <div class="relative space-y-3 sm:space-y-4">
                    <!-- Produção de Hoje - Destaque -->
                    <div class="bg-white/80 backdrop-blur-sm rounded-xl p-3 sm:p-4 border border-white/50 shadow-sm hover:shadow-md transition-all duration-300">
                        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between space-y-3 sm:space-y-0">
                            <div class="flex items-center space-x-2 sm:space-x-3">
                                <div class="p-1.5 sm:p-2 bg-gradient-to-br from-green-400 to-green-500 rounded-lg flex-shrink-0">
                                    <svg class="w-4 h-4 sm:w-5 sm:h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                        </div>
                                <div>
                                    <p class="text-sm sm:text-base font-medium text-slate-600">Produção de Hoje</p>
                                    <p class="text-xs text-slate-500">Volume registrado</p>
                        </div>
                    </div>
                            <div class="text-left sm:text-right">
                                <p class="text-xl sm:text-2xl font-bold text-green-600" id="reportTodayVolume">0.0 L</p>
                                <p class="text-xs text-slate-500">litros</p>
                        </div>
                        </div>
                    </div>

                    <!-- Outras Métricas -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 sm:gap-3">
                        <div class="bg-white/60 backdrop-blur-sm rounded-lg p-2 sm:p-3 border border-white/30 hover:bg-white/80 transition-all duration-300">
                            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between space-y-2 sm:space-y-0">
                                <div class="flex items-center space-x-2">
                                    <div class="p-1 sm:p-1.5 bg-blue-100 rounded-md flex-shrink-0">
                                        <svg class="w-3 h-3 sm:w-4 sm:h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"></path>
                                        </svg>
                        </div>
                                    <span class="text-xs sm:text-sm font-medium text-slate-700">Média Semanal</span>
                        </div>
                                <span class="text-sm sm:text-base font-bold text-blue-600" id="reportWeekAverage">0.0 L</span>
                            </div>
                    </div>

                        <div class="bg-white/60 backdrop-blur-sm rounded-lg p-2 sm:p-3 border border-white/30 hover:bg-white/80 transition-all duration-300">
                            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between space-y-2 sm:space-y-0">
                                <div class="flex items-center space-x-2">
                                    <div class="p-1 sm:p-1.5 bg-emerald-100 rounded-md flex-shrink-0">
                                        <svg class="w-3 h-3 sm:w-4 sm:h-4 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                        </svg>
                        </div>
                                    <span class="text-xs sm:text-sm font-medium text-slate-700">Total do Mês</span>
                        </div>
                                <span class="text-sm sm:text-base font-bold text-emerald-600" id="reportMonthTotal">0.0 L</span>
                            </div>
                    </div>

                        <div class="bg-white/60 backdrop-blur-sm rounded-lg p-2 sm:p-3 border border-white/30 hover:bg-white/80 transition-all duration-300">
                            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between space-y-2 sm:space-y-0">
                                <div class="flex items-center space-x-2">
                                    <div class="p-1 sm:p-1.5 bg-orange-100 rounded-md flex-shrink-0">
                                        <svg class="w-3 h-3 sm:w-4 sm:h-4 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                        </svg>
                        </div>
                                    <span class="text-xs sm:text-sm font-medium text-slate-700">Registros</span>
                    </div>
                                <span class="text-sm sm:text-base font-bold text-orange-600" id="reportMonthRecords">0</span>
                        </div>
                    </div>

                        <div class="bg-white/60 backdrop-blur-sm rounded-lg p-2 sm:p-3 border border-white/30 hover:bg-white/80 transition-all duration-300">
                            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between space-y-2 sm:space-y-0">
                                <div class="flex items-center space-x-2">
                                    <div class="p-1 sm:p-1.5 bg-teal-100 rounded-md flex-shrink-0">
                                        <svg class="w-3 h-3 sm:w-4 sm:h-4 text-teal-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"></path>
                                        </svg>
                        </div>
                                    <span class="text-xs sm:text-sm font-medium text-slate-700">Funcionários</span>
                    </div>
                                <span class="text-sm sm:text-base font-bold text-teal-600" id="reportActiveEmployees">0</span>
                </div>
                    </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Exportar Relatórios -->
        <div class="bg-gradient-to-br from-white to-slate-50 rounded-2xl p-8 border border-slate-200 shadow-lg">
            <!-- Header da Seção -->
            <div class="flex items-center mb-8">
                <div class="p-3 bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl mr-4">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.207A1 1 0 013 6.5V4z"></path>
                                </svg>
                        </div>
                <div>
                    <h3 class="text-xl font-bold text-slate-900">Exportar Relatórios</h3>
                    <p class="text-sm text-slate-600">Gere relatórios personalizados da produção</p>
                    </div>
                </div>

            <!-- Filtros de Data - Design Melhorado -->
            <div class="bg-white rounded-xl p-6 border border-slate-200 shadow-sm mb-8">
                <h4 class="text-lg font-semibold text-slate-800 mb-4 flex items-center">
                    <svg class="w-5 h-5 mr-2 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.207A1 1 0 013 6.5V4z"></path>
                    </svg>
                    Filtros de Relatório
                </h4>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="space-y-2">
                        <label class="block text-sm font-semibold text-slate-700">Data Inicial</label>
                        <div class="relative">
                            <input type="date" id="reportStartDate" class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all bg-white shadow-sm">
                            <svg class="absolute right-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-slate-400 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                            </svg>
                        </div>
                    </div>
                    <div class="space-y-2">
                        <label class="block text-sm font-semibold text-slate-700">Data Final</label>
                        <div class="relative">
                            <input type="date" id="reportEndDate" class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all bg-white shadow-sm">
                            <svg class="absolute right-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-slate-400 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                            </svg>
                        </div>
                    </div>
                    <div class="space-y-2">
                        <label class="block text-sm font-semibold text-slate-700">Funcionário</label>
                        <div class="relative">
                            <select id="reportEmployee" class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all bg-white shadow-sm appearance-none">
                                <option value="">Todos os funcionários</option>
                            </select>
                            <svg class="absolute right-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-slate-400 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </div>
                    </div>
                    </div>
                </div>

            <!-- Botões de Exportação - Design Responsivo -->
            <!-- Botões de Exportação - Design Simples -->
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-8">
                <!-- PDF -->
                <button onclick="exportPDFReport()" class="bg-red-600 hover:bg-red-700 text-white rounded-lg p-4 transition-colors duration-200 shadow-md">
                    <div class="flex flex-col items-center space-y-2">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        <div class="text-center">
                            <h4 class="font-bold">Exportar PDF</h4>
                            <p class="text-sm opacity-90">Relatório completo formatado</p>
                        </div>
                    </div>
                </button>
                
                <!-- Excel -->
                <button onclick="exportExcelReport()" class="bg-green-600 hover:bg-green-700 text-white rounded-lg p-4 transition-colors duration-200 shadow-md">
                    <div class="flex flex-col items-center space-y-2">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        <div class="text-center">
                            <h4 class="font-bold">Exportar Excel</h4>
                            <p class="text-sm opacity-90">Planilha para análise</p>
                        </div>
                    </div>
                </button>
                
                <!-- Prévia -->
                <button onclick="previewReportTab()" class="bg-purple-600 hover:bg-purple-700 text-white rounded-lg p-4 transition-colors duration-200 shadow-md">
                    <div class="flex flex-col items-center space-y-2">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                        </svg>
                        <div class="text-center">
                            <h4 class="font-bold">Visualizar Prévia</h4>
                            <p class="text-sm opacity-90">Amostra do relatório</p>
                        </div>
                    </div>
                </button>
                        </div>
                    </div>
                </div>
                
                <!-- Espaço adicional para rolagem -->
                <div class="h-32"></div>
            </div>
        </div>
    <!-- Modal de Adicionar Usuário -->
    <div id="addUserModal" class="fullscreen-modal">
        <div class="modal-content">
            <!-- Header do Modal -->
            <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 z-10">
                <div class="flex items-center justify-between">
                    <h2 class="text-xl font-bold text-gray-900">Adicionar Novo Usuário</h2>
                    <button onclick="closeAddUserModal()" class="p-2 hover:bg-gray-100 rounded-lg transition-all">
                        <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>
            
            <!-- Conteúdo do Modal -->
            <div class="p-6 space-y-6">
                <!-- Formulário de Adicionar Usuário -->
                <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-200">
                    <h4 class="text-lg font-semibold text-gray-900 mb-4">Informações do Usuário</h4>
                    <form id="addUserFormModal" class="space-y-4">
                        <div class="form-floating">
                            <input type="text" id="userName" name="name" class="w-full px-3 py-4 border border-slate-200 rounded-xl focus:border-forest-500 focus:ring-2 focus:ring-forest-100 focus:outline-none" placeholder=" " required>
                            <label for="userName" class="text-slate-600">Nome Completo *</label>
                        </div>
                                                
                        <!-- Email Preview -->
                        <div class="bg-gray-50 border border-gray-200 rounded-xl p-4">
                            <div class="flex items-center">
                                <svg class="w-5 h-5 text-gray-500 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V5a2 2 0 00-2-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                <div>
                                    <h5 class="text-sm font-semibold text-gray-900 mb-1">Email será gerado automaticamente:</h5>
                                    <p class="text-sm text-gray-600" id="emailPreview">Digite o nome para ver o email</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="form-floating">
                                <input type="tel" id="userWhatsapp" name="whatsapp" class="w-full px-3 py-4 border border-slate-200 rounded-xl focus:border-forest-500 focus:ring-2 focus:ring-forest-100 focus:outline-none" placeholder=" " required>
                                <label for="userWhatsapp" class="text-slate-600">WhatsApp *</label>
                            </div>
                            <div class="form-floating">
                                <select id="userRole" name="role" class="w-full px-3 py-4 border border-slate-200 rounded-xl focus:border-forest-500 focus:ring-2 focus:ring-forest-100 focus:outline-none" required onchange="togglePhotoSection();">
                                    <option value="">Selecione o cargo</option>
                                    <option value="funcionario">Funcionário</option>
                                    <option value="veterinario">Veterinário</option>
                                </select>
                                <label for="userRole" class="text-slate-600">Cargo *</label>
                            </div>
                        </div>
                        
                        <!-- Seção de Foto de Perfil para Add User (funcionários e veterinários) -->
                        <div id="addPhotoSection" class="hidden" style="display: none !important;">
                            <label class="block text-sm font-semibold text-gray-800 mb-2">Foto de Perfil (Opcional)</label>
                            <div class="flex items-center space-x-4">
                                <div class="relative">
                                    <img id="profilePreview" src="" alt="Preview da foto" class="w-16 h-16 rounded-xl object-cover hidden" style="display: none;">
                                    <div id="profilePlaceholder" class="w-16 h-16 bg-gray-100 rounded-xl flex items-center justify-center">
                                        <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                        </svg>
                                    </div>
                                </div>
                                <div>
                                    <button type="button" onclick="addPhotoToNewUser()" class="px-4 py-2 bg-forest-600 hover:bg-forest-700 text-white font-medium rounded-lg transition-all text-sm">
                                        Escolher Foto
                                    </button>
                                    <input type="file" id="profilePhotoInput" name="profilePhoto" accept="image/*" class="hidden" onchange="previewProfilePhoto(this)">
                                    <p class="text-xs text-gray-500 mt-1">Formatos: JPG, PNG (máx. 2MB) - Opcional</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-floating relative">
                            <input type="password" id="userPassword" name="password" class="w-full px-3 py-4 pr-12 border border-slate-200 rounded-xl focus:border-forest-500 focus:ring-2 focus:ring-forest-100 focus:outline-none" placeholder=" " required>
                            <label for="userPassword" class="text-slate-600">Senha *</label>
                            <button type="button" onclick="toggleUserPasswordVisibility('userPassword', 'userPasswordToggle')" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700 focus:outline-none" id="userPasswordToggle">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                </svg>
                            </button>
                        </div>
                        
                        <div class="bg-blue-50 border border-blue-200 rounded-xl p-4">
                            <div class="flex items-start">
                                <svg class="w-5 h-5 text-blue-500 mt-0.5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                <div>
                                    <h5 class="text-sm font-semibold text-blue-900 mb-1">Informações Importantes</h5>
                                    <p class="text-sm text-blue-700">• Como gerente, você pode criar perfis de funcionários e veterinários</p>
                                    <p class="text-sm text-blue-700">• O usuário receberá as credenciais por WhatsApp</p>
                                    <p class="text-sm text-blue-700">• O email será gerado automaticamente baseado no nome da fazenda</p>
                                    <p class="text-sm text-blue-700">• Recomenda-se que o usuário altere a senha no primeiro acesso</p>
                                    <p class="text-sm text-blue-700">• O acesso será ativado imediatamente após a criação</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex justify-end space-x-3 pt-4">
                            <button type="button" onclick="closeAddUserModal()" class="px-6 py-3 border border-gray-300 text-gray-700 font-semibold rounded-xl hover:bg-gray-50 transition-all">
                                Cancelar
                            </button>
                            <button type="submit" id="createUserBtn" class="px-6 py-3 gradient-forest text-white font-semibold rounded-xl hover:shadow-lg transition-all">
                                <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                </svg>
                                Criar Usuário
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Editar Usuário -->
    <div id="editUserModal" class="fullscreen-modal">
        <div class="modal-content">
            <!-- Header do Modal -->
            <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 z-10">
                <div class="flex items-center justify-between">
                    <h2 class="text-xl font-bold text-gray-900">Editar Usuário</h2>
                    <button onclick="closeEditUserModal()" class="p-2 hover:bg-gray-100 rounded-lg transition-all">
                        <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>
            
            <!-- Conteúdo do Modal -->
            <div class="p-6 space-y-6">
                <!-- Formulário de Editar Usuário -->
                <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-200">
                    <h4 class="text-lg font-semibold text-gray-900 mb-4">Informações do Usuário</h4>
                    <form id="editUserFormModal" class="space-y-4">
                        <input type="hidden" id="editUserId" name="id">
                        
                        <div class="form-floating">
                            <input type="text" id="editUserName" name="name" class="w-full px-3 py-4 border border-slate-200 rounded-xl focus:border-forest-500 focus:ring-2 focus:ring-forest-100 focus:outline-none" placeholder=" " required>
                            <label for="editUserName" class="text-slate-600">Nome Completo *</label>
                        </div>
                                                
                        <div class="form-floating">
                            <input type="email" id="editUserEmail" name="email" class="w-full px-3 py-4 border border-slate-200 rounded-xl bg-gray-100 text-gray-500" placeholder=" " readonly>
                            <label for="editUserEmail" class="text-slate-600">Email (não pode ser alterado)</label>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="form-floating">
                                <input type="tel" id="editUserWhatsapp" name="whatsapp" class="w-full px-3 py-4 border border-slate-200 rounded-xl focus:border-forest-500 focus:ring-2 focus:ring-forest-100 focus:outline-none" placeholder=" " required>
                                <label for="editUserWhatsapp" class="text-slate-600">WhatsApp *</label>
                            </div>
                            <div class="form-floating">
                                <select id="editUserRole" name="role" class="w-full px-3 py-4 border border-slate-200 rounded-xl focus:border-forest-500 focus:ring-2 focus:ring-forest-100 focus:outline-none" required>
                                    <option value="">Selecione o cargo</option>
                                    <option value="funcionario">Funcionário</option>
                                    <option value="veterinario">Veterinário</option>
                                </select>
                                <label for="editUserRole" class="text-slate-600">Cargo *</label>
                            </div>
                        </div>
                        
                        <!-- Seção de Foto de Perfil para Edit User -->
                        <div id="editPhotoSection" class="hidden">
                            <label class="block text-sm font-semibold text-gray-800 mb-2">Foto de Perfil</label>
                            <div class="flex items-center space-x-4">
                                <div class="relative">
                                    <img id="editProfilePreview" src="" alt="Preview da foto" class="w-16 h-16 rounded-xl object-cover hidden">
                                    <div id="editProfilePlaceholder" class="w-16 h-16 bg-gray-100 rounded-xl flex items-center justify-center">
                                        <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                        </svg>
                                    </div>
                                </div>
                                <div>
                                    <button type="button" onclick="addPhotoToEditUser()" class="px-4 py-2 bg-forest-600 hover:bg-forest-700 text-white font-medium rounded-lg transition-all text-sm">
                                        Alterar Foto
                                    </button>
                                    <input type="file" id="editProfilePhoto" name="profilePhoto" accept="image/*" class="hidden" onchange="previewEditProfilePhoto(this)">
                                    <p class="text-xs text-gray-500 mt-1">Formatos: JPG, PNG (máx. 2MB)</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-floating relative">
                            <input type="password" id="editUserPassword" name="password" class="w-full px-3 py-4 pr-12 border border-slate-200 rounded-xl focus:border-forest-500 focus:ring-2 focus:ring-forest-100 focus:outline-none" placeholder=" ">
                            <label for="editUserPassword" class="text-slate-600">Nova Senha (deixe em branco para manter a atual)</label>
                            <button type="button" onclick="toggleUserPasswordVisibility('editUserPassword', 'editUserPasswordToggle')" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700 focus:outline-none" id="editUserPasswordToggle">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                </svg>
                            </button>
                        </div>
                        
                        <div class="bg-blue-50 border border-blue-200 rounded-xl p-4">
                            <div class="flex items-start">
                                <svg class="w-5 h-5 text-blue-500 mt-0.5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                <div>
                                    <h5 class="text-sm font-semibold text-blue-900 mb-1">Informações sobre Edição</h5>
                                    <p class="text-sm text-blue-700">• O email não pode ser alterado após a criação</p>
                                    <p class="text-sm text-blue-700">• Deixe o campo senha em branco para manter a senha atual</p>
                                    <p class="text-sm text-blue-700">• As alterações serão aplicadas imediatamente</p>
                                    <p class="text-sm text-blue-700">• O usuário será notificado sobre as mudanças por WhatsApp</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex justify-end space-x-3 pt-4">
                            <button type="button" onclick="closeEditUserModal()" class="px-6 py-3 border border-gray-300 text-gray-700 font-semibold rounded-xl hover:bg-gray-50 transition-all">
                                Cancelar
                            </button>
                            <button type="submit" class="px-6 py-3 gradient-forest text-white font-semibold rounded-xl hover:shadow-lg transition-all">
                                <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"></path>
                                </svg>
                                Salvar Alterações
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>



    <!-- Modal de Escolha de Foto Novo -->
    <div id="photoChoiceModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-[99999]" style="display: none;">
        <div class="bg-white rounded-2xl p-6 max-w-sm w-full mx-4 shadow-xl">
            <div class="text-center mb-6">
                <h3 class="text-xl font-bold text-gray-800 mb-2">Adicionar Foto</h3>
                <p class="text-gray-600 text-sm">Escolha como adicionar a foto do funcionário</p>
            </div> 
    
            <div class="space-y-3">
                <button onclick="selectFromGallery()" class="w-full p-4 bg-blue-500 hover:bg-blue-600 text-white rounded-xl transition-colors flex items-center justify-center space-x-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"> 
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                    </svg> 
                    <span>Galeria</span>
                </button> 
                
                <button onclick="takePhoto()" class="w-full p-4 bg-green-500 hover:bg-green-600 text-white rounded-xl transition-colors flex items-center justify-center space-x-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"> 
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0118.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg> 
                    <span>Câmera</span>
                </button> 
            </div> 
    
            <button onclick="closePhotoChoiceModal()" class="w-full mt-4 p-3 border border-gray-300 text-gray-700 rounded-xl hover:bg-gray-50 transition-colors">
                Cancelar 
            </button> 
        </div> 
    </div>

    <!-- Modal da Câmera -->
    <div id="cameraModal" class="fixed inset-0 bg-black z-[10001] hidden">
        <div class="relative w-full h-full bg-black overflow-hidden">
            <!-- Header Minimalista -->
            <div class="absolute top-0 left-0 right-0 z-20 p-6">
                <div class="flex items-center justify-between">
                    <!-- Logo LacTech -->
                    <div class="flex items-center space-x-3">
                        <img src="assets/img/lactech-logo.png" alt="LacTech" class="w-8 h-8 rounded-lg">
                        <div class="text-white">
                            <div class="text-sm font-semibold">LacTech</div>
                            <div class="text-xs opacity-70">Verificação Facial</div>
                        </div>
                    </div>
                    
                    <!-- Botão Fechar -->
                    <button onclick="closeCamera()" class="p-2 bg-black/30 backdrop-blur-md rounded-full hover:bg-black/50 transition-all">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Video da Câmera -->
            <video id="cameraVideo" class="w-full h-full object-cover" autoplay playsinline></video>
            
            <!-- Overlay de Verificação Facial -->
            <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                <!-- Círculo de Foco Principal -->
                <div id="focusCircle" class="relative">
                    <!-- Círculo Externo Animado -->
                    <div class="w-80 h-80 border-2 border-white/40 rounded-full flex items-center justify-center animate-pulse">
                        <!-- Círculo Interno -->
                        <div class="w-72 h-72 border-2 border-white/60 rounded-full flex items-center justify-center">
                            <!-- Círculo de Foco -->
                            <div class="w-64 h-64 border-3 border-white/80 rounded-full flex items-center justify-center">
                                <!-- Indicador de Foco -->
                                <div id="focusIndicator" class="w-56 h-56 border-2 border-green-400 rounded-full flex items-center justify-center opacity-0 transition-opacity duration-500">
                                    <div class="w-48 h-48 border border-green-300 rounded-full"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Instruções -->
                    <div class="absolute -bottom-16 left-1/2 transform -translate-x-1/2 text-center">
                        <div id="focusText" class="text-white text-lg font-medium mb-2">Posicione o rosto no centro</div>
                        <div id="focusTimer" class="text-white/70 text-sm hidden">Focando em <span id="timerCount">3</span>s...</div>
                    </div>
                </div>
            </div>

            <!-- Controles Minimalistas -->
            <div class="absolute bottom-0 left-0 right-0 z-20 p-8">
                <div class="flex items-center justify-center space-x-12">
                    <!-- Botão Trocar Câmera -->
                    <button onclick="switchCamera()" class="p-4 bg-black/30 backdrop-blur-md rounded-full hover:bg-black/50 transition-all">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                    </button>
                    
                    <!-- Botão de Captura -->
                    <button id="captureBtn" onclick="startFaceVerification()" class="p-6 bg-white rounded-full hover:bg-gray-100 transition-all shadow-2xl transform hover:scale-105">
                        <div class="w-20 h-20 border-4 border-gray-200 rounded-full flex items-center justify-center">
                            <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center">
                                <svg class="w-8 h-8 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                </svg>
                            </div>
                        </div>
                    </button>
                    
                    <!-- Botão Cancelar -->
                    <button onclick="closeCamera()" class="p-4 bg-black/30 backdrop-blur-md rounded-full hover:bg-black/50 transition-all">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Canvas para Captura -->
            <canvas id="cameraCanvas" class="hidden"></canvas>
            
            <!-- Tela de Carregamento da Foto -->
            <div id="photoProcessingScreen" class="absolute inset-0 bg-black bg-opacity-90 flex items-center justify-center z-30 hidden">
                <div class="text-center text-white">
                    <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-white mx-auto mb-4"></div>
                    <h3 class="text-xl font-semibold mb-2">Processando foto...</h3>
                    <p class="text-white/70">Aguarde enquanto processamos sua imagem</p>
                </div>
            </div>
        </div>
    </div>

<!-- Modal de Perfil do Gerente -->
    <div id="profileModal" class="fullscreen-modal">
        <div class="modal-content overflow-y-auto">
            <!-- Header do Modal -->
            <div id="profileModalHeader" class="sticky top-0 left-0 right-0 bg-white border-b border-gray-200 px-4 sm:px-6 py-4 z-20 transition-transform duration-300 ease-in-out -mx-4 sm:mx-0">
                <div class="flex items-center justify-between">
                    <h2 class="text-xl font-bold text-gray-900">Perfil do Gerente</h2>
                    <button onclick="closeProfileModal()" class="p-2 hover:bg-gray-100 rounded-lg transition-all">
                        <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>
            
            <!-- Conteúdo do Perfil -->
            <div class="p-4 sm:p-6 pb-8">
                <div class="flex items-center justify-between mb-6">
                                            <div class="flex items-center space-x-4">
                            <div class="relative">
                                <!-- Foto do usuário -->
                                <img id="modalProfilePhoto" src="" alt="Foto de Perfil" class="w-16 h-16 object-cover rounded-2xl shadow-lg hidden">
                                <!-- Ícone padrão -->
                                <div id="modalProfileIcon" class="w-16 h-16 gradient-forest rounded-2xl flex items-center justify-center shadow-lg">
                                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                    </svg>
                                </div>
                            </div>
                        <div>
                            <h2 class="text-2xl font-bold text-slate-900" id="profileName">Carregando...</h2>
                            <p class="text-slate-600 text-base">Gerente</p>
                            <p class="text-sm text-slate-500" id="profileFarmName">Carregando...</p>
                        </div>
                    </div>
                </div>
                
                <!-- Informações Pessoais -->
                <div class="bg-white rounded-2xl p-4 sm:p-6 border border-gray-200 mt-4">
                    <div class="flex items-center justify-between mb-4">
                        <h4 class="text-lg font-semibold text-gray-900">Informações Pessoais</h4>
                        <button id="editProfileBtn" onclick="toggleProfileEdit()" class="px-4 py-2 text-sm bg-forest-600 hover:bg-forest-700 text-white font-medium rounded-lg transition-all">
                            <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                            </svg>
                            Editar
                        </button>
                    </div>
                    
                    <!-- Modo Visualização -->
                    <div id="profileViewMode" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-800 mb-1">Nome Completo</label>
                            <p class="text-gray-900 font-semibold text-base" id="profileFullName">Carregando...</p>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-800 mb-1">Email</label>
                            <p class="text-gray-900 font-semibold text-base" id="profileEmail2">Carregando...</p>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-800 mb-1">WhatsApp</label>
                            <p class="text-gray-900 font-semibold text-base" id="profileWhatsApp">Carregando...</p>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-800 mb-1">Cargo</label>
                            <p class="text-gray-900 font-semibold text-base">Gerente</p>
                        </div>
                    </div>
                    
                    <!-- Modo Edição -->
                    <div id="profileEditMode" class="hidden">
                        <form id="updateProfileForm" class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-800 mb-2">Nome Completo</label>
                                    <input type="text" id="editProfileName" name="name" class="w-full px-4 py-3 border border-slate-200 rounded-xl focus:border-forest-500 focus:ring-2 focus:ring-forest-100 focus:outline-none bg-white" placeholder="Digite seu nome completo">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-800 mb-2">Email</label>
                                    <input type="email" id="editProfileEmail" name="email" class="w-full px-4 py-3 border border-slate-200 rounded-xl bg-gray-100 text-gray-500" readonly placeholder="Email não pode ser alterado">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-800 mb-2">WhatsApp</label>
                                    <input type="tel" id="editProfileWhatsApp" name="whatsapp" class="w-full px-4 py-3 border border-slate-200 rounded-xl focus:border-forest-500 focus:ring-2 focus:ring-forest-100 focus:outline-none bg-white" placeholder="(00) 00000-0000">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-800 mb-2">Cargo</label>
                                    <input type="text" value="Gerente" class="w-full px-4 py-3 border border-slate-200 rounded-xl bg-gray-100 text-gray-500" readonly>
                                </div>
                            </div>
                            
                            </div>
                            
                            <!-- Seção de Foto de Perfil do Gerente -->
                            <div class="border-t border-gray-200 pt-6 mt-6">
                                <h5 class="text-lg font-semibold text-gray-900 mb-4">Foto de Perfil</h5>
                                <div class="flex flex-col space-y-3">
                                    <div class="flex items-center space-x-3">
                                        <button type="button" onclick="openManagerPhotoModal()" class="px-4 py-2 bg-forest-600 hover:bg-forest-700 text-white font-medium rounded-lg transition-all text-sm">
                                            Mudar Foto
                                        </button>
                                        <button type="button" onclick="removeManagerPhoto()" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white font-medium rounded-lg transition-all text-sm">
                                            Remover Foto
                                        </button>
                                    </div>
                                    <input type="file" id="managerProfilePhotoInput" name="managerProfilePhoto" accept="image/*" class="hidden" onchange="handleManagerGallerySelection(this)">
                                    <p class="text-xs text-gray-500">Formatos: JPG, PNG (máx. 2MB)</p>
                                </div>
                            </div>
                            
                            <div id="profileEditButtons" class="flex justify-end space-x-3 pt-4 hidden">
                                <button type="button" onclick="cancelProfileEdit()" class="px-6 py-3 border border-gray-300 text-gray-700 font-semibold rounded-xl hover:bg-gray-50 transition-all">
                                    Cancelar
                                </button>
                                <button type="submit" class="px-6 py-3 gradient-forest text-white font-semibold rounded-xl hover:shadow-lg transition-all">
                                    <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"></path>
                                    </svg>
                                    Salvar Alterações
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                
                
                <!-- Alterar Senha -->
                <div class="bg-white rounded-2xl p-6 border border-gray-200 mx-4 mb-8">
                    <div class="flex items-center justify-between">
                        <div>
                            <h4 class="text-lg font-semibold text-gray-900 mb-2">Segurança da Conta</h4>
                            <p class="text-sm text-gray-600">Altere sua senha para manter sua conta segura</p>
                        </div>
                        <button onclick="window.location.href='alterar-senha.php'" class="px-6 py-3 gradient-forest text-white font-semibold rounded-xl hover:shadow-lg transition-all">
                            <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"></path>
                            </svg>
                            Alterar Senha
                        </button>
                    </div>
                </div>
                
                <!-- Criação de Contas Secundárias -->
                <div class="bg-white rounded-2xl p-4 sm:p-8 border border-gray-200 mx-0 sm:mx-4 mb-8">
                    <div class="flex items-center justify-between mb-4">
                        <h4 class="text-lg font-semibold text-gray-900">Contas Secundárias</h4>
                        <button onclick="toggleSecondaryAccountForm()" class="px-4 py-2 text-sm bg-forest-600 hover:bg-forest-700 text-white font-medium rounded-lg transition-all">
                            <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                            </svg>
                            Nova Conta
                        </button>
                    </div>
                    
                    <p class="text-sm text-gray-600 mb-4">Crie contas de funcionário ou veterinário usando seus dados como base</p>
                    
                    <!-- Lista de Contas Secundárias -->
                    <div id="secondaryAccountsList" class="space-y-3 mb-4 overflow-hidden">
                        <!-- Contas serão carregadas aqui -->
                    </div>
                    
                    <!-- Formulário de Nova Conta -->
                    <div id="secondaryAccountForm" class="hidden border-t border-gray-200 pt-4">
                        <form id="createSecondaryAccountForm" class="space-y-4">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-800 mb-2">Tipo de Conta</label>
                                    <select name="account_type" required class="w-full px-4 py-3 border border-slate-200 rounded-xl focus:border-forest-500 focus:ring-2 focus:ring-forest-100 focus:outline-none bg-white" onchange="checkExistingSecondaryAccount(this.value)">
                                        <option value="">Selecione o tipo</option>
                                        <option value="funcionario">Funcionário</option>
                                        <option value="veterinario">Veterinário</option>
                                    </select>
                                    <div id="existingAccountMessage" class="mt-2 text-sm hidden"></div>
                                </div>
                                
                                <!-- Campos ocultos com dados da conta primária -->
                                <input type="hidden" name="email" id="secondaryAccountEmail">
                                <input type="hidden" name="name" id="secondaryAccountName">
                                <input type="hidden" name="whatsapp" id="secondaryAccountWhatsApp">
                                
                                <div class="bg-green-50 border border-green-200 rounded-xl p-4">
                                    <div class="flex items-start">
                                        <svg class="w-5 h-5 text-green-600 mt-0.5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                <div>
                                            <h5 class="text-sm font-semibold text-green-800 mb-1">Dados Automáticos</h5>
                                            <p class="text-sm text-green-700">A nova conta usará automaticamente seus dados da conta principal:</p>
                                            <ul class="text-sm text-green-700 mt-2 space-y-1">
                                                <li>• <strong>Email:</strong> <span id="displayEmail">-</span></li>
                                                <li>• <strong>Nome:</strong> <span id="displayName">-</span></li>
                                                <li>• <strong>WhatsApp:</strong> <span id="displayWhatsApp">-</span></li>
                                            </ul>
                                </div>
                                </div>
                                </div>
                            </div>
                            
                            <div class="bg-blue-50 border border-blue-200 rounded-xl p-4">
                                <div class="flex items-start">
                                    <svg class="w-5 h-5 text-blue-600 mt-0.5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    <div>
                                        <h5 class="text-sm font-semibold text-blue-800 mb-1">Contas Secundárias - Para Você Mesmo</h5>
                                        <ul class="text-sm text-blue-700 space-y-1">
                                            <li>• Crie contas para você mesmo (ex: veterinário, funcionário)</li>
                                            <li>• Use o mesmo email da sua conta principal</li>
                                            <li>• Útil para fazendas menores onde você faz múltiplas funções</li>
                                            <li>• Acesso rápido entre diferentes perfis</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="flex justify-end space-x-3">
                                <button type="button" onclick="cancelSecondaryAccountForm()" class="px-6 py-3 border border-gray-300 text-gray-700 font-semibold rounded-xl hover:bg-gray-50 transition-all">
                                    Cancelar
                                </button>
                                <button type="submit" class="px-6 py-3 gradient-forest text-white font-semibold rounded-xl hover:shadow-lg transition-all">
                                    <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                    </svg>
                                    Criar Conta
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <!-- Sair do Sistema -->
                <div class="bg-white rounded-2xl p-4 sm:p-8 border border-red-200 mx-0 sm:mx-4 mb-8">
                    <h4 class="text-lg font-semibold text-red-900 mb-4">Zona de Perigo</h4>
                    <div class="flex items-center justify-between">
                        <div>
                            <h5 class="font-medium text-red-900">Sair do Sistema</h5>
                            <p class="text-sm text-red-600">Encerrar sua sessão atual</p>
                        </div>
                        <button onclick="signOut()" class="px-6 py-3 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-xl transition-all">
                            <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                            </svg>
                            Sair
                        </button>
                    </div>
                </div>
                
                <!-- Modal de Escolha de Foto do Gerente (dentro do modal de perfil) -->
                <div id="managerPhotoChoiceModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[-999999]" style="display: none !important; visibility: hidden !important;">
                    <div class="bg-white rounded-2xl p-6 w-full max-w-md mx-4">
                        <div class="flex items-center justify-between mb-6">
                            <h2 class="text-xl font-bold text-gray-900">Mudar Foto de Perfil</h2>
                            <button onclick="closeManagerPhotoModal()" class="p-2 hover:bg-gray-100 rounded-lg transition-all">
                                <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
            </div>
                        
                        <div>
                            <div class="text-center space-y-6">
                                <div class="w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mx-auto">
                                    <svg class="w-12 h-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                    </svg>
                                </div>
                                
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-900 mb-2">Como você quer adicionar sua foto?</h3>
                                    <p class="text-gray-600">Escolha entre tirar uma foto ou selecionar da galeria</p>
                                </div>
                                
                                <div class="flex flex-col sm:flex-row gap-4 justify-center">
                                    <button onclick="openManagerCamera()" class="flex items-center justify-center space-x-3 px-6 py-4 bg-forest-600 hover:bg-forest-700 text-white font-medium rounded-xl transition-all">
                                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                        </svg>
                                        <span>Tirar Foto</span>
                                    </button>
                                    
                                    <button onclick="selectManagerFromGallery()" class="flex items-center justify-center space-x-3 px-6 py-4 bg-gray-600 hover:bg-gray-700 text-white font-medium rounded-xl transition-all">
                                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                        </svg>
                                        <span>Galeria</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Câmera do Gerente -->
    <div id="managerCameraModal" class="fullscreen-modal" style="display: none;">
        <div class="modal-content bg-black">
            <!-- Header com Logo -->
            <div class="absolute top-0 left-0 right-0 z-30 p-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <img src="https://i.postimg.cc/vmrkgDcB/lactech.png" alt="LacTech" class="w-8 h-8">
                        <span class="text-white font-semibold">LacTech</span>
                    </div>
                    <button onclick="closeManagerCamera()" class="p-2 bg-black/30 backdrop-blur-md rounded-full hover:bg-black/50 transition-all">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Video da Câmera -->
            <video id="managerCameraVideo" class="w-full h-full object-cover" autoplay playsinline></video>
            
            <!-- Overlay de Verificação Facial -->
            <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                <div id="managerFocusCircle" class="relative">
                    <div id="managerFaceCircle" class="w-80 h-80 border-4 border-red-500 rounded-full flex items-center justify-center animate-pulse transition-colors duration-300">
                        <div class="w-72 h-72 border-2 border-white/60 rounded-full flex items-center justify-center">
                            <div class="w-64 h-64 border-3 border-white/80 rounded-full flex items-center justify-center">
                                <div id="managerFocusIndicator" class="w-56 h-56 border-2 border-green-400 rounded-full flex items-center justify-center opacity-0 transition-opacity duration-500">
                                    <div class="w-48 h-48 border border-green-300 rounded-full"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="absolute -bottom-16 left-1/2 transform -translate-x-1/2 text-center">
                        <div id="managerFocusText" class="text-white text-lg font-medium mb-2">Posicione o rosto no centro</div>
                        <div id="managerFaceStatus" class="text-white/70 text-sm mb-2">Centralizando rosto...</div>
                        <div id="managerFocusTimer" class="text-white/70 text-sm hidden">Focando em <span id="managerTimerCount">3</span>s...</div>
                    </div>
                </div>
            </div>
            
            <!-- Aviso de Centralização -->
            <div id="managerFaceWarning" class="absolute top-20 left-1/2 transform -translate-x-1/2 bg-red-500 text-white px-4 py-2 rounded-lg text-sm font-medium opacity-0 transition-opacity duration-300 pointer-events-none">
                Centralize o rosto no círculo para tirar a foto
            </div>

            <!-- Controles -->
            <div class="absolute bottom-0 left-0 right-0 z-20 p-8">
                <div class="flex items-center justify-center space-x-12">
                    <button onclick="switchManagerCamera()" class="p-4 bg-black/30 backdrop-blur-md rounded-full hover:bg-black/50 transition-all">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                    </button>
                    
                    <button id="managerCaptureBtn" onclick="captureManagerPhoto()" class="p-6 bg-white/50 rounded-full transition-all shadow-2xl cursor-not-allowed opacity-50" disabled>
                        <div class="w-20 h-20 border-4 border-gray-200 rounded-full flex items-center justify-center">
                            <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center">
                                <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                </svg>
                            </div>
                        </div>
                    </button>
                    
                    <button onclick="closeManagerCamera()" class="p-4 bg-black/30 backdrop-blur-md rounded-full hover:bg-black/50 transition-all">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Canvas para Captura -->
            <canvas id="managerCameraCanvas" class="hidden"></canvas>
            
            <!-- Tela de Carregamento -->
            <div id="managerPhotoProcessingScreen" class="absolute inset-0 bg-black bg-opacity-90 flex items-center justify-center z-30 hidden">
                <div class="text-center text-white">
                    <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-white mx-auto mb-4"></div>
                    <h3 class="text-xl font-semibold mb-2">Processando foto...</h3>
                    <p class="text-white/70">Aguarde enquanto processamos sua imagem</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Tela de Carregamento de Conexão com Servidor -->
    <div id="serverConnectionLoading" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-2xl p-8 max-w-md mx-4 text-center">
            <div class="mb-6">
                <h3 class="text-xl font-bold text-slate-900 mb-2">Conectando com o Servidor</h3>
                <p class="text-gray-600">Sincronizando dados...</p>
            </div>
            
            <!-- Espaço para o SVG - COLOQUE SEU SVG AQUI -->
            <div class="flex justify-center mb-6">
              <!-- From Uiverse.io by Juanes200122 --> 
<svg
  id="svg_svg"
  xmlns="http://www.w3.org/2000/svg"
  fill="none"
  viewBox="0 0 477 578"
  height="578"
  width="477"
>
  <g filter="url(#filter0_i_163_1030)">
    <path
      fill="#E9E9E9"
      d="M235.036 304.223C236.949 303.118 240.051 303.118 241.964 304.223L470.072 435.921C473.898 438.13 473.898 441.712 470.072 443.921L247.16 572.619C242.377 575.38 234.623 575.38 229.84 572.619L6.92817 443.921C3.10183 441.712 3.10184 438.13 6.92817 435.921L235.036 304.223Z"
    ></path>
  </g>
  <path
    stroke="white"
    d="M235.469 304.473C237.143 303.506 239.857 303.506 241.531 304.473L469.639 436.171C473.226 438.242 473.226 441.6 469.639 443.671L246.727 572.369C242.183 574.992 234.817 574.992 230.273 572.369L7.36118 443.671C3.77399 441.6 3.774 438.242 7.36119 436.171L235.469 304.473Z"
  ></path>
  <path
    stroke="white"
    fill="#C3CADC"
    d="M234.722 321.071C236.396 320.105 239.111 320.105 240.785 321.071L439.477 435.786C443.064 437.857 443.064 441.215 439.477 443.286L240.785 558.001C239.111 558.967 236.396 558.967 234.722 558.001L36.0304 443.286C32.4432 441.215 32.4432 437.857 36.0304 435.786L234.722 321.071Z"
  ></path>
  <path
    fill="#4054B2"
    d="M234.521 366.089C236.434 364.985 239.536 364.985 241.449 366.089L406.439 461.346L241.247 556.72C239.333 557.825 236.231 557.825 234.318 556.72L69.3281 461.463L234.521 366.089Z"
  ></path>
  <path
    fill="#30439B"
    d="M237.985 364.089L237.984 556.972C236.144 556.941 235.082 556.717 233.13 556.043L69.3283 461.463L237.985 364.089Z"
  ></path>
  <path
    fill="url(#paint0_linear_163_1030)"
    d="M36.2146 117.174L237.658 0.435217V368.615C236.541 368.598 235.686 368.977 233.885 370.124L73.1836 463.678L39.2096 444.075C37.0838 442.229 36.285 440.981 36.2146 438.027V117.174Z"
    id="layer_pared"
  ></path>
  <path
    fill="url(#paint1_linear_163_1030)"
    d="M439.1 116.303L237.657 0.435568V368.616C238.971 368.585 239.822 369.013 241.43 370.135L403.64 462.925L436.128 444.089C437.832 442.715 438.975 441.147 439.1 439.536V116.303Z"
    id="layer_pared"
  ></path>
  <path
    fill="#27C6FD"
    d="M64.5447 181.554H67.5626V186.835L64.5447 188.344V181.554Z"
    id="float_server"
  ></path>
  <path
    fill="#138EB9"
    d="M88.3522 374.347L232.415 457.522C234.202 458.405 234.866 458.629 236.335 458.71V468.291C235.356 468.291 234.086 468.212 232.415 467.275L88.3522 384.1C86.3339 382.882 85.496 382.098 85.4707 380.198V370.428L88.3522 374.347Z"
    id="float_server"
  ></path>
  <path
    fill="#138EB9"
    d="M384.318 374.445L240.254 457.62C238.914 458.385 238.295 458.629 236.335 458.71V468.291C237.315 468.291 238.704 468.211 240.236 467.274L384.318 384.198C386.457 383.091 387.151 382.244 387.258 380.228V370.917C386.768 372.387 386.21 373.295 384.318 374.445Z"
    id="float_server"
  ></path>
  <path
    stroke="url(#paint3_linear_163_1030)"
    fill="url(#paint2_linear_163_1030)"
    d="M240.452 226.082L408.617 323.172C412.703 325.531 412.703 329.355 408.617 331.713L240.452 428.803C238.545 429.904 235.455 429.904 233.548 428.803L65.3832 331.713C61.298 329.355 61.298 325.531 65.3832 323.172L233.548 226.082C235.455 224.982 238.545 224.982 240.452 226.082Z"
    id="float_server"
  ></path>
  <path
    fill="#5B6CA2"
    d="M408.896 332.123L241.489 428.775C240.013 429.68 238.557 430.033 236.934 430.033V464.518C238.904 464.518 239.366 464.169 241.489 463.233L408.896 366.58C411.372 365.292 412.125 363.262 412.312 361.317C412.312 361.317 412.312 326.583 412.312 327.722C412.312 328.86 411.42 330.514 408.896 332.123Z"
    id="float_server"
  ></path>
  <path
    fill="#6879AF"
    d="M240.92 429.077L255.155 420.857V432.434L251.511 439.064V457.432L241.489 463.242C240.116 463.858 239.141 464.518 236.934 464.518V430.024C238.695 430.024 239.862 429.701 240.92 429.077Z"
    id="float_server"
  ></path>
  <path
    fill="url(#paint4_linear_163_1030)"
    d="M65.084 331.984L232.379 428.571C233.882 429.619 235.101 430.005 236.934 430.005V464.523C234.656 464.523 234.285 464.215 232.379 463.214L65.084 366.442C62.4898 365 61.6417 362.992 61.6699 361.29V327.125C61.6899 329.24 62.4474 330.307 65.084 331.984Z"
    id="float_server"
  ></path>
  <path
    fill="#20273A"
    d="M400.199 361.032C403.195 359.302 405.623 355.096 405.623 351.637C405.623 348.177 403.195 346.775 400.199 348.505C397.203 350.235 394.775 354.441 394.775 357.9C394.775 361.359 397.203 362.762 400.199 361.032Z"
    id="float_server"
  ></path>
  <path
    fill="#20273A"
    d="M221.404 446.444C224.4 448.174 226.828 446.771 226.828 443.312C226.828 439.853 224.4 435.646 221.404 433.917C218.408 432.187 215.979 433.589 215.979 437.049C215.979 440.508 218.408 444.714 221.404 446.444Z"
    id="float_server"
  ></path>
  <path
    fill="#494F76"
    d="M102.895 359.589L97.9976 356.762V380.07L102.895 382.897V359.589Z"
    id="float_server"
  ></path>
  <path
    fill="#313654"
    d="M102.895 359.619L98.3394 356.989V379.854L102.895 382.484V359.619Z"
    id="float_server"
  ></path>
  <path
    fill="#494F76"
    d="M78.9793 345.923L74.0823 343.096V366.37L78.9793 369.198V345.923Z"
    id="float_server"
  ></path>
  <path
    fill="#494F76"
    d="M86.9512 350.478L82.0542 347.651V370.959L86.9512 373.787V350.478Z"
    id="float_server"
  ></path>
  <path
    fill="#494F76"
    d="M94.9229 355.034L90.0259 352.206V375.515L94.9229 378.342V355.034Z"
    id="float_server"
  ></path>
  <path
    fill="#313654"
    d="M86.951 350.509L82.3958 347.879V370.743L86.951 373.373V350.509Z"
    id="float_server"
  ></path>
  <path
    fill="#313654"
    d="M94.9227 355.064L90.3674 352.434V375.299L94.9227 377.929V355.064Z"
    class="estrobo_animation"
  ></path>
  <path
    fill="#313654"
    d="M78.9794 345.954L74.4241 343.324V366.188L78.9794 368.818V345.954Z"
    class="estrobo_animation"
  ></path>
  <path
    fill="#333B5F"
    d="M221.859 446.444C224.855 448.174 227.284 446.771 227.284 443.312C227.284 439.853 224.855 435.646 221.859 433.917C218.863 432.187 216.435 433.589 216.435 437.049C216.435 440.508 218.863 444.714 221.859 446.444Z"
    id="float_server"
  ></path>
  <path
    fill="#333B5F"
    d="M399.516 361.032C402.511 359.302 404.94 355.096 404.94 351.637C404.94 348.177 402.511 346.775 399.516 348.505C396.52 350.235 394.091 354.441 394.091 357.9C394.091 361.359 396.52 362.762 399.516 361.032Z"
    id="float_server"
  ></path>
  <path
    fill="#27C6FD"
    d="M88.3522 317.406L232.415 400.581C234.202 401.464 234.866 401.688 236.335 401.769V411.35C235.356 411.35 234.086 411.271 232.415 410.334L88.3522 327.159C86.3339 325.941 85.496 325.157 85.4707 323.256V313.486L88.3522 317.406Z"
    id="float_server"
  ></path>
  <path
    fill="#27C6FD"
    d="M384.318 317.504L240.254 400.679C238.914 401.444 238.295 401.688 236.335 401.769V411.35C237.315 411.35 238.704 411.27 240.236 410.333L384.318 327.257C386.457 326.15 387.151 325.303 387.258 323.287V313.976C386.768 315.446 386.21 316.354 384.318 317.504Z"
    id="float_server"
  ></path>
  <path
    stroke="url(#paint6_linear_163_1030)"
    fill="url(#paint5_linear_163_1030)"
    d="M240.452 169.141L408.617 266.231C412.703 268.59 412.703 272.414 408.617 274.772L240.452 371.862C238.545 372.962 235.455 372.962 233.548 371.862L65.3832 274.772C61.298 272.414 61.298 268.59 65.3832 266.231L233.548 169.141C235.455 168.04 238.545 168.04 240.452 169.141Z"
    id="float_server"
  ></path>
  <path
    fill="#5B6CA2"
    d="M408.896 275.182L241.489 371.834C240.013 372.739 238.557 373.092 236.934 373.092V407.577C238.904 407.577 239.366 407.229 241.489 406.292L408.896 309.64C411.372 308.352 412.125 306.321 412.312 304.376C412.312 304.376 412.312 269.642 412.312 270.781C412.312 271.92 411.42 273.573 408.896 275.182Z"
    id="float_server"
  ></path>
  <path
    fill="#6879AF"
    d="M240.92 372.135L255.155 363.915V375.493L251.511 382.123V400.491L241.489 406.3C240.116 406.916 239.141 407.577 236.934 407.577V373.083C238.695 373.083 239.862 372.759 240.92 372.135Z"
    id="float_server"
  ></path>
  <path
    fill="url(#paint7_linear_163_1030)"
    d="M65.084 275.043L232.379 371.63C233.882 372.678 235.101 373.064 236.934 373.064V407.582C234.656 407.582 234.285 407.274 232.379 406.273L65.084 309.501C62.4898 308.059 61.6417 306.051 61.6699 304.349V270.184C61.6899 272.299 62.4474 273.366 65.084 275.043Z"
    id="float_server"
  ></path>
  <path
    fill="#20273A"
    d="M400.199 304.091C403.195 302.362 405.623 298.155 405.623 294.696C405.623 291.237 403.195 289.835 400.199 291.564C397.203 293.294 394.775 297.5 394.775 300.959C394.775 304.419 397.203 305.821 400.199 304.091Z"
    id="float_server"
  ></path>
  <path
    fill="#20273A"
    d="M221.404 389.503C224.4 391.232 226.828 389.83 226.828 386.371C226.828 382.912 224.4 378.705 221.404 376.976C218.408 375.246 215.979 376.648 215.979 380.107C215.979 383.567 218.408 387.773 221.404 389.503Z"
    id="float_server"
  ></path>
  <path
    fill="#494F76"
    d="M102.553 301.281L97.656 298.454V321.762L102.553 324.59V301.281Z"
    id="float_server"
  ></path>
  <path
    fill="#313654"
    d="M102.553 301.312L97.9976 298.682V321.546L102.553 324.176V301.312Z"
    class="estrobo_animation"
  ></path>
  <path
    fill="#494F76"
    d="M78.6377 287.615L73.7407 284.788V308.063L78.6377 310.89V287.615Z"
    id="float_server"
  ></path>
  <path
    fill="#494F76"
    d="M86.6094 292.171L81.7124 289.343V312.652L86.6094 315.479V292.171Z"
    id="float_server"
  ></path>
  <path
    fill="#494F76"
    d="M94.5811 296.726L89.6841 293.899V317.207L94.5811 320.034V296.726Z"
    id="float_server"
  ></path>
  <path
    fill="#313654"
    d="M86.6095 292.201L82.0542 289.571V312.436L86.6095 315.066V292.201Z"
    id="float_server"
  ></path>
  <path
    fill="#313654"
    d="M94.5812 296.756L90.0259 294.126V316.991L94.5812 319.621V296.756Z"
    class="estrobo_animationV2"
  ></path>
  <path
    fill="#313654"
    d="M78.6376 287.646L74.0823 285.016V307.88L78.6376 310.51V287.646Z"
    id="float_server"
  ></path>
  <path
    fill="#333B5F"
    d="M221.859 389.503C224.855 391.232 227.284 389.83 227.284 386.371C227.284 382.912 224.855 378.705 221.859 376.976C218.863 375.246 216.435 376.648 216.435 380.107C216.435 383.567 218.863 387.773 221.859 389.503Z"
    id="float_server"
  ></path>
  <path
    fill="#333B5F"
    d="M399.516 304.091C402.511 302.362 404.94 298.155 404.94 294.696C404.94 291.237 402.511 289.835 399.516 291.564C396.52 293.294 394.091 297.5 394.091 300.959C394.091 304.419 396.52 305.821 399.516 304.091Z"
    id="float_server"
  ></path>
  <path
    fill="#27C6FD"
    d="M89.4907 214.912L233.554 298.087C235.341 298.97 236.003 299.194 237.474 299.275V308.856C236.494 308.856 235.223 308.777 233.554 307.84L89.4907 224.665C87.4726 223.447 86.6347 222.663 86.6094 220.762V210.993L89.4907 214.912Z"
    id="float_server"
  ></path>
  <path
    fill="#27C6FD"
    d="M385.457 215.01L241.393 298.185C240.053 298.951 239.434 299.194 237.474 299.275V308.856C238.454 308.856 239.844 308.776 241.375 307.839L385.457 224.763C387.597 223.656 388.29 222.809 388.397 220.793V211.482C387.907 212.953 387.349 213.86 385.457 215.01Z"
    id="float_server"
  ></path>
  <path
    fill="url(#paint8_linear_163_1030)"
    d="M66.1102 196.477L233.517 293.129C235.593 294.154 236.364 294.416 238.073 294.509V305.642C236.934 305.642 235.458 305.551 233.517 304.463L66.1102 207.81C63.7651 206.394 62.7914 205.483 62.762 203.275V191.922L66.1102 196.477Z"
    id="float_server"
  ></path>
  <path
    fill="#5B6CA2"
    d="M410.101 196.591L242.694 293.243C241.135 294.132 240.35 294.375 238.073 294.468V305.643C239.211 305.643 240.892 305.55 242.671 304.46L410.101 207.923C412.587 206.638 413.392 205.653 413.517 203.31V192.491C412.948 194.199 412.3 195.254 410.101 196.591Z"
    id="float_server"
  ></path>
  <path
    stroke="url(#paint10_linear_163_1030)"
    fill="url(#paint9_linear_163_1030)"
    d="M241.59 90.5623L409.756 187.652C413.842 190.011 413.842 193.835 409.756 196.194L241.59 293.284C239.684 294.384 236.593 294.384 234.687 293.284L66.5219 196.194C62.4367 193.835 62.4367 190.011 66.5219 187.652L234.687 90.5623C236.593 89.4616 239.684 89.4616 241.59 90.5623Z"
    id="float_server"
  ></path>
  <path
    fill="#20273A"
    d="M89.0427 195.334C92.0385 197.063 96.8956 197.063 99.8914 195.334C102.887 193.604 102.887 190.8 99.8914 189.07C96.8956 187.341 92.0385 187.341 89.0427 189.07C86.0469 190.8 86.0469 193.604 89.0427 195.334Z"
    id="float_server"
  ></path>
  <path
    fill="#20273A"
    d="M231.396 111.061C234.391 112.791 239.249 112.791 242.244 111.061C245.24 109.331 245.24 106.527 242.244 104.798C239.249 103.068 234.391 103.068 231.396 104.798C228.4 106.527 228.4 109.331 231.396 111.061Z"
    id="float_server"
  ></path>
  <path
    fill="#20273A"
    d="M374.887 194.195C377.883 195.925 382.74 195.925 385.736 194.195C388.732 192.465 388.732 189.661 385.736 187.932C382.74 186.202 377.883 186.202 374.887 187.932C371.891 189.661 371.891 192.465 374.887 194.195Z"
    id="float_server"
  ></path>
  <path
    fill="#20273A"
    d="M231.396 279.607C234.391 281.336 239.249 281.336 242.244 279.607C245.24 277.877 245.24 275.073 242.244 273.343C239.249 271.613 234.391 271.613 231.396 273.343C228.4 275.073 228.4 277.877 231.396 279.607Z"
    id="float_server"
  ></path>
  <path
    fill="#333B5F"
    d="M232.109 279.607C235.104 281.336 239.962 281.336 242.957 279.607C245.953 277.877 245.953 275.073 242.957 273.343C239.962 271.613 235.104 271.613 232.109 273.343C229.113 275.073 229.113 277.877 232.109 279.607Z"
    id="float_server"
  ></path>
  <path
    fill="#333B5F"
    d="M89.7563 195.334C92.7521 197.063 97.6092 197.063 100.605 195.334C103.601 193.604 103.601 190.8 100.605 189.07C97.6092 187.341 92.7521 187.341 89.7563 189.07C86.7605 190.8 86.7605 193.604 89.7563 195.334Z"
    id="float_server"
  ></path>
  <path
    fill="#333B5F"
    d="M232.109 111.061C235.104 112.791 239.962 112.791 242.957 111.061C245.953 109.331 245.953 106.527 242.957 104.798C239.962 103.068 235.104 103.068 232.109 104.798C229.113 106.527 229.113 109.331 232.109 111.061Z"
    id="float_server"
  ></path>
  <path
    fill="#333B5F"
    d="M375.6 194.195C378.595 195.925 383.453 195.925 386.448 194.195C389.444 192.465 389.444 189.661 386.448 187.932C383.453 186.202 378.595 186.202 375.6 187.932C372.604 189.661 372.604 192.465 375.6 194.195Z"
    id="float_server"
  ></path>
  <path
    stroke="#313654"
    d="M371.315 166.009L354.094 176.748C351.92 178.337 350.677 179.595 350.677 181.872L351.247 196.108C351.412 198.824 350.734 200.095 347.83 201.802L251.03 257.603C248.955 258.968 247.598 259.356 244.767 259.312L215.727 258.743C212.711 258.605 211.233 259.005 208.894 260.45L193.659 269.072"
    id="float_server"
  ></path>
  <path
    stroke="#313654"
    d="M345.691 151.204L328.328 161.374C326.154 162.963 324.911 164.221 324.911 166.498L325.481 180.734C325.646 183.45 324.968 184.721 322.064 186.428L225.264 242.229C223.19 243.594 221.832 243.982 219.001 243.938L189.961 243.369C186.946 243.231 185.468 243.631 183.128 245.076L167.124 253.698"
    id="float_server"
  ></path>
  <path
    stroke="#313654"
    d="M105.482 218.098L122.697 207.363C124.87 205.773 126.111 204.516 126.111 202.24L125.537 188.007C125.371 185.291 126.048 184.02 128.951 182.314L225.715 126.533C227.788 125.17 229.146 124.782 231.976 124.825L261.012 125.398C264.026 125.535 265.503 125.136 267.842 123.691L283.072 115.072"
    id="float_server"
  ></path>
  <path
    stroke="#313654"
    d="M131.121 232.893L148.482 222.725C150.656 221.136 151.898 219.879 151.898 217.601L151.327 203.367C151.162 200.65 151.839 199.379 154.743 197.673L251.531 141.878C253.605 140.514 254.962 140.126 257.794 140.17L286.832 140.74C289.847 140.878 291.325 140.478 293.664 139.032L309.667 130.412"
    id="float_server"
  ></path>
  <path
    fill="#313654"
    d="M327.961 242.79L301.907 227.748L300.673 228.46L326.727 243.503L327.961 242.79Z"
    id="float_server"
  ></path>
  <path
    fill="#313654"
    d="M354.625 227.426L328.56 212.377L327.326 213.09L353.392 228.139L354.625 227.426Z"
    id="float_server"
  ></path>
  <path
    fill="#313654"
    d="M300.864 258.519L274.707 243.417L273.474 244.129L299.631 259.231L300.864 258.519Z"
    id="float_server"
  ></path>
  <path
    fill="#313654"
    d="M176.498 155.101L150.21 139.924L148.977 140.636L175.264 155.813L176.498 155.101Z"
    id="float_server"
  ></path>
  <path
    fill="#313654"
    d="M193.703 145.191L167.388 129.998L166.154 130.711L192.469 145.903L193.703 145.191Z"
    id="float_server"
  ></path>
  <path
    fill="#313654"
    d="M158.333 165.69L131.974 150.472L130.74 151.184L157.099 166.402L158.333 165.69Z"
    id="float_server"
  ></path>
  <path
    fill="#20273A"
    d="M232.079 135.83C234.258 134.573 237.79 134.573 239.969 135.83L329.717 187.647C334.074 190.163 334.074 194.242 329.717 196.757L239.969 248.574C237.79 249.832 234.258 249.832 232.079 248.574L142.33 196.757C137.972 194.242 137.972 190.163 142.33 187.647L232.079 135.83Z"
    id="float_server"
  ></path>
  <path
    fill="url(#paint11_linear_163_1030)"
    d="M234.357 135.83C236.535 134.573 240.068 134.573 242.246 135.83L331.995 187.647C336.352 190.163 336.352 194.242 331.995 196.757L242.246 248.574C240.068 249.832 236.535 249.832 234.357 248.574L144.608 196.757C140.25 194.242 140.25 190.163 144.608 187.647L234.357 135.83Z"
    id="float_server"
  ></path>
  <path
    stroke-width="3"
    stroke="#27C6FD"
    d="M380.667 192.117V181.97C380.667 179.719 383.055 178.27 385.052 179.309L409.985 192.282C410.978 192.799 411.601 193.825 411.601 194.943V301.113C411.601 302.642 409.953 303.606 408.62 302.856L399.529 297.742"
    class="after_animation"
    id="float_server"
  ></path>
  <path
    stroke-width="3"
    stroke="#27C6FD"
    d="M94.7234 192.117V180.306C94.7234 179.214 94.1301 178.208 93.1744 177.68L70.5046 165.152C68.5052 164.047 66.0536 165.493 66.0536 167.778V185.326"
    id="float_server"
  ></path>
  <ellipse
    fill="#27C6FD"
    ry="1.50894"
    rx="1.50894"
    cy="192.117"
    cx="380.667"
    id="float_server"
  ></ellipse>
  <ellipse
    fill="#27C6FD"
    ry="1.50894"
    rx="1.50894"
    cy="192.117"
    cx="94.7235"
    id="float_server"
  ></ellipse>
  <ellipse
    fill="#27C6FD"
    ry="1.50894"
    rx="1.50894"
    cy="297.742"
    cx="399.529"
    id="float_server"
  ></ellipse>
  <ellipse
    fill="#27C6FD"
    ry="1.50894"
    rx="1.50894"
    cy="383.751"
    cx="221.474"
    id="float_server"
  ></ellipse>
  <ellipse
    fill="#27C6FD"
    ry="1.50894"
    rx="1.50894"
    cy="439.583"
    cx="221.474"
    id="float_server"
  ></ellipse>
  <path
    stroke-width="3"
    stroke="#27C6FD"
    d="M221.474 383.752L211.746 388.941C210.768 389.462 210.157 390.48 210.157 391.588V444.34C210.157 445.108 210.988 445.589 211.654 445.208L221.474 439.583"
    id="float_server"
  ></path>
  <path
    fill="url(#paint13_linear_163_1030)"
    d="M237.376 236.074L36 119.684V439.512C36.0957 441.966 36.7214 443.179 39.0056 445.021L200.082 538.547L231.362 556.441C233.801 557.806 235.868 558.222 237.376 558.328V236.074Z"
    id="layer_pared"
  ></path>
  <defs>
    <linearGradient
      gradientUnits="userSpaceOnUse"
      y2="556.454"
      x2="438.984"
      y1="235.918"
      x1="237.376"
      id="paint13_linear_163_1030"
    >
      <stop style="stop-color:#4457b3; stop-opacity:0" offset="10%"></stop>
      <stop style="stop-color:#4457b3; stop-opacity:1" offset="100%"></stop>
    </linearGradient>
  </defs>
  <path
    fill="url(#paint13_linear_163_1030)"
    d="M237.376 235.918L438.984 119.576V439.398C439.118 441.699 438.452 442.938 435.975 444.906L274.712 538.539L243.397 556.454C240.955 557.821 238.886 558.23 237.376 558.336V235.918Z"
    class="animatedStop"
    id="layer_pared"
  ></path>
  <defs>
    <filter
      color-interpolation-filters="sRGB"
      filterUnits="userSpaceOnUse"
      height="275.295"
      width="468.883"
      y="303.394"
      x="4.05835"
      id="filter0_i_163_1030"
    >
      <feFlood result="BackgroundImageFix" flood-opacity="0"></feFlood>
      <feBlend
        result="shape"
        in2="BackgroundImageFix"
        in="SourceGraphic"
        mode="normal"
      ></feBlend>
      <feColorMatrix
        result="hardAlpha"
        values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0"
        type="matrix"
        in="SourceAlpha"
      ></feColorMatrix>
      <feOffset dy="4"></feOffset>
      <feGaussianBlur stdDeviation="2"></feGaussianBlur>
      <feComposite
        k3="1"
        k2="-1"
        operator="arithmetic"
        in2="hardAlpha"
      ></feComposite>
      <feColorMatrix
        values="0 0 0 0 0.220833 0 0 0 0 0.220833 0 0 0 0 0.220833 0 0 0 1 0"
        type="matrix"
      ></feColorMatrix>
      <feBlend
        result="effect1_innerShadow_163_1030"
        in2="shape"
        mode="normal"
      ></feBlend>
    </filter>
    <linearGradient
      gradientUnits="userSpaceOnUse"
      y2="336.055"
      x2="294.366"
      y1="60.1113"
      x1="135.05"
      id="paint0_linear_163_1030"
    >
      <stop stop-opacity="0.01" stop-color="white" offset="0.305"></stop>
      <stop stop-color="#4054B2" offset="1"></stop>
    </linearGradient>
    <linearGradient
      gradientUnits="userSpaceOnUse"
      y2="335.208"
      x2="180.935"
      y1="59.2405"
      x1="340.265"
      id="paint1_linear_163_1030"
    >
      <stop stop-opacity="0.01" stop-color="white" offset="0.305"></stop>
      <stop stop-color="#4054B2" offset="1"></stop>
    </linearGradient>
    <linearGradient
      gradientUnits="userSpaceOnUse"
      y2="420.619"
      x2="88.5367"
      y1="327.152"
      x1="412.313"
      id="paint2_linear_163_1030"
    >
      <stop stop-color="#313654"></stop>
      <stop stop-color="#313654" offset="1"></stop>
    </linearGradient>
    <linearGradient
      gradientUnits="userSpaceOnUse"
      y2="211.092"
      x2="168.239"
      y1="426.799"
      x1="236.934"
      id="paint3_linear_163_1030"
    >
      <stop stop-color="#7281B8"></stop>
      <stop stop-color="#333952" offset="1"></stop>
    </linearGradient>
    <linearGradient
      gradientUnits="userSpaceOnUse"
      y2="349.241"
      x2="232.379"
      y1="349.241"
      x1="65.0839"
      id="paint4_linear_163_1030"
    >
      <stop stop-color="#7281B8"></stop>
      <stop stop-color="#5D6EA4" offset="1"></stop>
    </linearGradient>
    <linearGradient
      gradientUnits="userSpaceOnUse"
      y2="363.678"
      x2="88.5367"
      y1="270.211"
      x1="412.313"
      id="paint5_linear_163_1030"
    >
      <stop stop-color="#313654"></stop>
      <stop stop-color="#313654" offset="1"></stop>
    </linearGradient>
    <linearGradient
      gradientUnits="userSpaceOnUse"
      y2="154.15"
      x2="168.239"
      y1="369.858"
      x1="236.934"
      id="paint6_linear_163_1030"
    >
      <stop stop-color="#7281B8"></stop>
      <stop stop-color="#333952" offset="1"></stop>
    </linearGradient>
    <linearGradient
      gradientUnits="userSpaceOnUse"
      y2="292.3"
      x2="232.379"
      y1="292.3"
      x1="65.0839"
      id="paint7_linear_163_1030"
    >
      <stop stop-color="#7281B8"></stop>
      <stop stop-color="#5D6EA4" offset="1"></stop>
    </linearGradient>
    <linearGradient
      gradientUnits="userSpaceOnUse"
      y2="198.899"
      x2="238.073"
      y1="198.899"
      x1="62.762"
      id="paint8_linear_163_1030"
    >
      <stop stop-color="#7382B9"></stop>
      <stop stop-color="#5D6EA4" offset="1"></stop>
    </linearGradient>
    <linearGradient
      gradientUnits="userSpaceOnUse"
      y2="191.599"
      x2="67.1602"
      y1="191.633"
      x1="413.451"
      id="paint9_linear_163_1030"
    >
      <stop stop-color="#5F6E99"></stop>
      <stop stop-color="#465282" offset="1"></stop>
    </linearGradient>
    <linearGradient
      gradientUnits="userSpaceOnUse"
      y2="191.599"
      x2="63.6601"
      y1="191.599"
      x1="417.16"
      id="paint10_linear_163_1030"
    >
      <stop stop-color="#7281B8"></stop>
      <stop stop-color="#333952" offset="1"></stop>
    </linearGradient>
    <linearGradient
      gradientUnits="userSpaceOnUse"
      y2="243.221"
      x2="156.734"
      y1="191.633"
      x1="335.442"
      id="paint11_linear_163_1030"
    >
      <stop stop-color="#313654"></stop>
      <stop stop-color="#313654" offset="1"></stop>
    </linearGradient>
    <linearGradient
      gradientUnits="userSpaceOnUse"
      y2="421.983"
      x2="-1.9283"
      y1="179.292"
      x1="138.189"
      id="paint12_linear_163_1030"
    >
      <stop stop-opacity="0.01" stop-color="white" offset="0.305"></stop>
      <stop stop-color="#4054B2" offset="1"></stop>
    </linearGradient>
  </defs>
</svg>

            </div>
            
            <div class="text-sm text-gray-500">
                Aguarde enquanto sincronizamos seus dados...
            </div>
        </div>
    </div>

    <!-- Notification Toast -->
    <div id="notificationToast" class="notification-toast">
        <div class="bg-white    rounded-lg shadow-lg border border-gray-200    p-4 max-w-sm">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <svg class="w-5 h-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </div>
                <div class="ml-3">
                    <p class="text-sm font-medium text-gray-900   " id="toastMessage">Sucesso!</p>
                </div>
                <div class="ml-auto pl-3">
                    <button onclick="hideNotification()" class="text-gray-400 hover:text-gray-600   :text-gray-300">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>


    <script>
        const supabaseMock = {
            auth: {
                getUser: async () => {
                    const userData = localStorage.getItem('user_data');
                    if (userData) {
                        const user = JSON.parse(userData);
                        return { data: { user: user }, error: null };
                    }
                    return { data: { user: null }, error: null };
                },
                signOut: async () => {
                    localStorage.clear();
                    return { error: null };
                },
                getSession: async () => {
                    const userData = localStorage.getItem('user_data');
                    return { data: { session: userData ? { user: JSON.parse(userData) } : null }, error: null };
                }
            },
            from: (table) => ({
                select: (cols) => {
                    const query = {
                        eq: (col, val) => query,
                        gte: (col, val) => query,
                        lte: (col, val) => query,
                        gt: (col, val) => query,
                        lt: (col, val) => query,
                        not: (col, op, val) => query,
                        order: (col, opts) => query,
                        limit: (n) => query,
                        single: async () => ({ data: null, error: null }),
                        maybeSingle: async () => ({ data: null, error: null }),
                        then: async (callback) => {
                            if (callback) callback({ data: [], error: null });
                            return { data: [], error: null };
                        }
                    };
                    return query;
                },
                insert: async (data) => ({ data: null, error: null }),
                update: (data) => ({
                    eq: async (col, val) => ({ data: null, error: null })
                }),
                delete: () => ({
                    eq: async (col, val) => ({ data: null, error: null })
                }),
                upsert: async (data) => ({ data: null, error: null })
            }),
            rpc: async (funcName, params) => ({ data: null, error: null }),
            storage: {
                from: (bucket) => ({
                    upload: async (path, file) => ({ data: null, error: null }),
                    download: async (path) => ({ data: null, error: null }),
                    remove: async (paths) => ({ data: null, error: null }),
                    getPublicUrl: (path) => ({ data: { publicUrl: '' } })
                })
            },
            channel: (name) => ({
                on: (event, opts, callback) => ({
                    subscribe: (callback) => ({ unsubscribe: () => {} })
                }),
                subscribe: (callback) => ({ unsubscribe: () => {} }),
                unsubscribe: () => {}
            })
        };
        
        // Função que retorna o mock ao invés do Supabase real
        async function getSupabaseClient() {
            return supabaseMock;
        }
        
        // Tornar disponível globalmente
        window.supabase = supabaseMock;
        
        // ==================== CONTROLE DE TELA DE CARREGAMENTO DE CONEXÃO ====================
        function showServerConnectionLoading() {
            const loadingModal = document.getElementById('serverConnectionLoading');
            if (loadingModal) {
                loadingModal.classList.remove('hidden');
                console.log('🔄 Mostrando tela de carregamento de conexão com servidor');
            }
        }

        function hideServerConnectionLoading() {
            const loadingModal = document.getElementById('serverConnectionLoading');
            if (loadingModal) {
                loadingModal.classList.add('hidden');
                console.log('✅ Escondendo tela de carregamento de conexão com servidor');
            }
        }

        // ==================== CACHE SYSTEM ====================
        const CacheManager = {
            cache: new Map(),
            userData: null,
            farmData: null,
            lastUserFetch: 0,
            lastFarmFetch: 0,
            forceRefresh: false, // Flag para forçar atualização
            CACHE_DURATION: 5 * 60 * 1000, // 5 minutos
            
            // Limpar cache após registros
            clearCache() {
                console.log('🗑️ Limpando cache...');
                this.cache.clear();
                this.userData = null;
                this.farmData = null;
                this.lastUserFetch = 0;
                this.lastFarmFetch = 0;
                this.forceRefresh = true;
                console.log('✅ Cache limpo');
            },

            // Forçar atualização do cache
            forceCacheRefresh() {
                console.log('🔄 Forçando atualização do cache...');
                this.forceRefresh = true;
                this.cache.clear();
            },
            
            // Cache de dados do usuário
            async getUserData(forceRefresh = false) {
                const now = Date.now();
                if (!forceRefresh && this.userData && (now - this.lastUserFetch) < this.CACHE_DURATION) {
                    return this.userData;
                }
                
                const userDataLS = localStorage.getItem('user_data');
                if (userDataLS) {
                    this.userData = JSON.parse(userDataLS);
                    this.lastUserFetch = now;
                }
                
                return this.userData;
            },
            
            // Cache de dados da fazenda
            async getFarmData(forceRefresh = false) {
                const now = Date.now();
                if (!forceRefresh && this.farmData && (now - this.lastFarmFetch) < this.CACHE_DURATION) {
                    return this.farmData;
                }
                
                this.farmData = {
                    id: 1,
                    name: 'Lagoa do Mato',
                    location: 'Lagoa do Mato'
                };
                this.lastFarmFetch = now;
                
                return this.farmData;
            },
            
            // Cache genérico
            set(key, data, ttl = this.CACHE_DURATION) {
                this.cache.set(key, {
                    data,
                    timestamp: Date.now(),
                    ttl
                });
            },
            
            get(key) {
                const item = this.cache.get(key);
                if (!item) return null;
                
                const now = Date.now();
                if (now - item.timestamp > item.ttl) {
                    this.cache.delete(key);
                    return null;
                }
                
                return item.data;
            },
            
            // Limpar cache específico
            clear(key) {
                if (key) {
                    this.cache.delete(key);
                } else {
                    this.cache.clear();
                    this.userData = null;
                    this.farmData = null;
                }
            },
            
            // Invalidar cache de dados críticos
            invalidateUserData() {
                this.userData = null;
                this.farmData = null;
                this.lastUserFetch = 0;
                this.lastFarmFetch = 0;
            },
            
            // Cache para dados de volume (MySQL - stub)
            async getVolumeData(farmId, dateRange, forceRefresh = false) {
                return null; // MySQL: implementar API se necessário
            }
        };
        
    // Função para verificar autenticação MySQL
    async function checkAuthentication() {
        try {
            const userData = localStorage.getItem('user_data');
            
            if (!userData) {
                clearUserSession();
                showNotification('Sessão expirada. Redirecionando para login...', 'error');
                setTimeout(() => {
                    safeRedirect('login.php');
                }, 2000);
                return false;
            }
            
            let user;
            try {
                user = JSON.parse(userData);
            } catch (e) {
                clearUserSession();
                safeRedirect('login.php');
                return false;
            }
            
            if (!user.id || !user.email || !user.role) {
                clearUserSession();
                safeRedirect('login.php');
                return false;
            }
            
            window.currentUser = user;
            return true;
            
        } catch (error) {
            clearUserSession();
            setTimeout(() => {
                safeRedirect('login.php');
            }, 2000);
            return false;
        }
    }
    
    // Função para limpar completamente a sessão MySQL
function clearUserSession() {
    localStorage.removeItem('user_data');
    localStorage.removeItem('user_token');
    localStorage.removeItem('userData');
    localStorage.removeItem('userSession');
    localStorage.removeItem('farmData');
    localStorage.removeItem('setupCompleted');
    
    sessionStorage.removeItem('user_data');
    sessionStorage.removeItem('user_token');
    sessionStorage.removeItem('userData');
    sessionStorage.removeItem('userSession');
    sessionStorage.removeItem('farmData');
    sessionStorage.removeItem('setupCompleted');
    sessionStorage.removeItem('redirectCount');
    
    if (window.currentUser) {
        delete window.currentUser;
    }
}

// Função para gerenciar redirecionamentos
function safeRedirect(url) {
    const currentCount = parseInt(sessionStorage.getItem('redirectCount') || '0');
    sessionStorage.setItem('redirectCount', (currentCount + 1).toString());
    
    window.location.replace(url);
    }
    
    // Função para monitorar bloqueio de usuário (otimizada)
    let blockWatcherInterval = null;
    let lastBlockCheck = 0;
    const BLOCK_CHECK_INTERVAL = 60000; // 1 minuto em vez de 15 segundos
    
    function startBlockWatcher() {
        // Evitar múltiplos intervalos
        if (blockWatcherInterval) {
            clearInterval(blockWatcherInterval);
        }
        
        blockWatcherInterval = setInterval(async () => {
            try {
                const now = Date.now();
                // Evitar verificações muito frequentes
                if (now - lastBlockCheck < BLOCK_CHECK_INTERVAL) {
                    return;
                }
                lastBlockCheck = now;
                
                // Verificação MySQL removida - não precisa
            } catch (error) {
                // Em caso de erro persistente, limpar sessão
                clearUserSession();
                clearInterval(blockWatcherInterval);
                safeRedirect('login.php');
            }
        }, BLOCK_CHECK_INTERVAL);
    }
    
    function stopBlockWatcher() {
        if (blockWatcherInterval) {
            clearInterval(blockWatcherInterval);
            blockWatcherInterval = null;
        }
    }
    
    document.addEventListener('DOMContentLoaded', async function() {
        // Flag para evitar múltiplas inicializações
        if (window.pageInitialized) {
            return;
        }
        
        window.pageInitialized = true;
        
<<<<<<< HEAD
        // FAILSAFE REMOVIDO - sem tela de loading
        
=======
>>>>>>> parent of 0eb3d2f (.)
        // Verificar se há dados de sessão válidos (MySQL)
        const userData = localStorage.getItem('user_data') || sessionStorage.getItem('user_data');
        if (!userData) {
            safeRedirect('login.php');
            return;
        }
        
        // Verificar se não estamos em um loop de redirecionamento
        const redirectCount = sessionStorage.getItem('redirectCount') || 0;
        if (redirectCount > 3) {
            clearUserSession();
            sessionStorage.removeItem('redirectCount');
            safeRedirect('login.php');
            return;
        }
        
        try {
            const parsedUserData = JSON.parse(userData);
            if (!parsedUserData || !parsedUserData.id) {
                clearUserSession();
                safeRedirect('login.php');
                return;
            }
        } catch (error) {
            clearUserSession();
            safeRedirect('login.php');
            return;
        }
        
        // Check authentication first
        const isAuthenticated = await checkAuthentication();
        if (!isAuthenticated) {
            return; // Stop execution if not authenticated
        }
        
        
        initializeCharts(); // Initialize charts before loading data
        await initializePage();
        setupEventListeners();
        
        // Carregar foto do header
        await loadHeaderPhoto();
        
        // Garantir que o modal de foto esteja fechado na inicialização
        const photoModal = document.getElementById('photoChoiceModal');
        if (photoModal) {
            photoModal.classList.remove('show');
            photoModal.classList.add('hidden');
            photoModal.classList.remove('flex');
            photoModal.style.display = 'none';
            photoModal.style.visibility = 'hidden';
            photoModal.style.opacity = '0';
            photoModal.style.pointerEvents = 'none';
        }
        
        // Garantir que as telas de processamento estejam ocultas
        const photoProcessingScreen = document.getElementById('photoProcessingScreen');
        if (photoProcessingScreen) {
            photoProcessingScreen.classList.add('hidden');
            photoProcessingScreen.style.display = 'none';
            photoProcessingScreen.style.visibility = 'hidden';
            photoProcessingScreen.style.opacity = '0';
            photoProcessingScreen.style.pointerEvents = 'none';
        }
        
        const managerPhotoProcessingScreen = document.getElementById('managerPhotoProcessingScreen');
        if (managerPhotoProcessingScreen) {
            managerPhotoProcessingScreen.classList.add('hidden');
            managerPhotoProcessingScreen.style.display = 'none';
            managerPhotoProcessingScreen.style.visibility = 'hidden';
            managerPhotoProcessingScreen.style.opacity = '0';
            managerPhotoProcessingScreen.style.pointerEvents = 'none';
        }
        
        updateDateTime();
        setInterval(updateDateTime, 60000); // Update every minute
        // Iniciar verificação de bloqueio durante a sessão (otimizada)
        startBlockWatcher();
        
    });
    
    // Função para limpar todos os event listeners (útil para debugging)
    window.clearAllEventListeners = function() {
        
        // Limpar listeners de formulários
        const forms = [
            'addUserFormModal', 
            'updateProfileForm',
            'editUserForm',
            'createSecondaryAccountForm'
        ];
        
        forms.forEach(formId => {
            const form = document.getElementById(formId);
            if (form) {
                const newForm = form.cloneNode(true);
                form.parentNode.replaceChild(newForm, form);
            }
        });
        
    };

/**
 * Inicializa a página do gerente
 * Carrega dados do dashboard, volume, qualidade, pagamentos e usuários
 * Configura autenticação e verifica status do usuário
 */
// =====================================================
// MOCK DO SUPABASE PARA COMPATIBILIDADE
// =====================================================
// Este mock faz TODAS as funções Supabase funcionarem sem erros
// Retornam dados vazios, permitindo que o código execute normalmente

const supabaseMock = {
    auth: {
        getUser: async () => {
            const userData = localStorage.getItem('user_data');
            if (userData) {
                const user = JSON.parse(userData);
                return { data: { user: user }, error: null };
            }
            return { data: { user: null }, error: null };
        },
        signOut: async () => {
            localStorage.clear();
            return { error: null };
        }
    },
    from: (table) => ({
        select: (cols) => {
            const query = {
                eq: (col, val) => query,
                gte: (col, val) => query,
                lte: (col, val) => query,
                gt: (col, val) => query,
                lt: (col, val) => query,
                not: (col, op, val) => query,
                order: (col, opts) => query,
                limit: (n) => query,
                single: async () => ({ data: null, error: null }),
                maybeSingle: async () => ({ data: null, error: null }),
                then: async (callback) => callback({ data: [], error: null })
            };
            return query;
        },
        insert: async (data) => ({ data: null, error: null }),
        update: async (data) => ({ data: null, error: null }),
        delete: async () => ({ data: null, error: null }),
        upsert: async (data) => ({ data: null, error: null })
    }),
    rpc: async (funcName, params) => ({ data: null, error: null }),
    storage: {
        from: (bucket) => ({
            upload: async (path, file) => ({ data: null, error: null }),
            download: async (path) => ({ data: null, error: null }),
            remove: async (paths) => ({ data: null, error: null })
        })
    },
    channel: (name) => ({
        on: (event, opts, callback) => ({
            subscribe: (callback) => {}
        }),
        subscribe: (callback) => {},
        unsubscribe: () => {}
    })
};

// Função que retorna o mock
async function getSupabaseClient() {
    return supabaseMock;
}

// =====================================================
// FUNÇÕES MYSQL
// =====================================================

async function getCurrentUser() {
    const userData = localStorage.getItem('user_data');
    if (!userData) {
        throw new Error('Usuário não autenticado');
    }
    return JSON.parse(userData);
}

async function mysqlRequest(endpoint, data = null) {
    const options = {
        method: data ? 'POST' : 'GET',
        headers: {
            'Content-Type': 'application/json',
        }
    };
    
    if (data) {
        options.body = JSON.stringify(data);
    }
    
    const response = await fetch(`api/${endpoint}`, options);
    const result = await response.json();
    
    if (!result.success) {
        throw new Error(result.message || 'Erro na requisição');
    }
    
    return result;
}

async function initializePage() {
    try {
        const user = await getCurrentUser();
        
        window.currentUser = {
            id: user.id,
            email: user.email,
            name: user.name,
            role: user.role,
            farm_id: user.farm_id
        };
        

        
        // Execute each function independently to avoid blocking
        try {
            await setFarmName();
        } catch (error) {
        }
        
        try {
            await setManagerName();
        } catch (error) {
        }
        

        
        try {
            await loadUserProfile();
        } catch (error) {
        }
        
        try {
            if (typeof loadHeaderProfilePhoto === 'function') {
                await loadHeaderProfilePhoto();
            }
        } catch (error) {
        }
        
        try {
    
            await loadDashboardData();
        } catch (error) {
        }
        
        try {
            await loadVolumeData();
            await loadVolumeRecords();
            // Forçar atualização da lista de registros para garantir dados corretos
            setTimeout(async () => {
                await updateVolumeRecordsList();
                // Corrigir registros existentes sem nome do funcionário
                await fixVolumeRecordsEmployeeNames();
            }, 1000);
        } catch (error) {
            console.error('Error loading volume data:', error);
        }
        
        try {
            await loadQualityData();
            await loadQualityTests();
        } catch (error) {
        }
        
        try {
            await loadTemperatureChart();
        } catch (error) {
        }
        
        try {
            await loadPaymentsData();
        } catch (error) {
        }
        
        // Carregar gráficos em paralelo para otimizar performance
        try {
            const chartPromises = [
                loadDashboardVolumeChart(),
                loadWeeklyVolumeChart(),
                loadDailyVolumeChart(),
                loadDashboardWeeklyChart(),
                loadMonthlyProductionChart()
            ];
            
            // Executar todos os gráficos em paralelo
            await Promise.allSettled(chartPromises);
            console.log('✅ Todos os gráficos carregados');
        } catch (error) {
            console.error('Erro ao carregar gráficos:', error);
        }
        
        try {
            // Carregar atividades recentes (MySQL)
            if (window.currentUser?.farm_id) {
                await loadRecentActivities(window.currentUser.farm_id);
            }
        } catch (error) {
            console.log('⚠️ Erro ao carregar atividades recentes:', error);
        }
        
        try {
            await loadUsersData();
        } catch (error) {
        }
        
        // Configurar atualizações em tempo real
        try {
            await setupRealtimeUpdates();
        } catch (error) {
        }
    } catch (error) {
        // Show user-friendly message
        showNotification('Algumas informações não puderam ser carregadas. Verifique sua conexão.', 'warning');
    }
}
// Function to create user if not exists - MySQL stub
async function createUserIfNotExists(authUser) {
    // MySQL: não precisa criar usuário automaticamente
    return;
        
        if (userCheckError) {
            throw userCheckError;
        }
        
        if (existingUser) {
    
            return;
        }
        
        // Check if farm already exists with the same name
        const farmName = authUser.user_metadata?.farm_name || 'fazenda nascimento';

        
        const { data: existingFarm, error: farmCheckError } = await supabase
            .from('farms')
            .select('id')
            .eq('name', farmName)
            .maybeSingle();
        
        if (farmCheckError) {
            throw farmCheckError;
        }
        
        let farmId;
        
        if (existingFarm) {
    
            farmId = existingFarm.id;
        } else {
            // Try to create new farm, but handle duplicate name error
    
            const { data: newFarmId, error: farmError } = await supabase
                .rpc('create_initial_farm', {
                    p_name: farmName,
                    p_owner_name: authUser.user_metadata?.name || authUser.email?.split('@')[0] || 'Proprietário',
                    p_city: authUser.user_metadata?.city || 'Cidade',
                    p_state: authUser.user_metadata?.state || 'MG'
                });
            
            if (farmError) {
                // If it's a duplicate name error, try to find the existing farm
                if (farmError.code === '23505' || farmError.message?.includes('duplicate') || farmError.message?.includes('already exists')) {
            
                    
                    // Wait a bit and try again
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                    const { data: retryFarm, error: retryError } = await supabase
                        .from('farms')
                        .select('id')
                        .eq('name', farmName)
                        .maybeSingle();
                    
                    if (retryError) {
                        throw retryError;
                    }
                    
                    if (retryFarm) {
                        farmId = retryFarm.id;
                
                    } else {
                        throw new Error('Failed to create or find farm');
                    }
                } else {
                    throw farmError;
                }
            } else {
                farmId = newFarmId;
        
            }
        }
        
        if (!farmId) {
            throw new Error('No farm ID available for user creation');
        }
        
        // Create user with the farm_id

        const { data: userResult, error: userError } = await supabase
            .rpc('create_initial_user', {
                p_user_id: authUser.id,
                p_farm_id: farmId,
                p_name: authUser.user_metadata?.name || authUser.email?.split('@')[0] || 'Usuário',
                p_email: authUser.email,
                p_role: authUser.user_metadata?.role || 'funcionario',
                p_whatsapp: authUser.user_metadata?.whatsapp || authUser.user_metadata?.phone || ''
            });
        
        if (userError) {
            throw userError;
        } else {
    
        }
    } catch (error) {
        throw error; // Re-throw the error so it can be handled by the caller
    }
}

// Function to get farm name from session or Supabase
async function getFarmName() {
    try {

        
        // First try to get from local session
        const userData = localStorage.getItem('userData') || sessionStorage.getItem('userData');
        if (userData) {
            try {
                const user = JSON.parse(userData);
                if (user.farm_name) {
            
                    return user.farm_name;
                }
            } catch (error) {
            }
        }
        
        // Get current user and their farm
        // // const supabase = await getSupabaseClient(); // REMOVIDO // REMOVIDO - usando MySQL
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) {
            return 'Minha Fazenda';
        }

        // Get user's farm_id from users table - SEMPRE USAR CONTA PRIMÁRIA
        const { data: userDbData, error: userError } = await supabase
            .from('users')
            .select('farm_id')
            .eq('id', user.id)
            .single();
            
        if (userError) {
            throw userError;
        }
        
        if (!userDbData?.farm_id) {
            // Fallback to auth metadata
            if (user.user_metadata?.farm_name) {
                return user.user_metadata.farm_name;
            }
            return 'Minha Fazenda';
        }

        // Get farm name from farms table
        const { data: farmData, error: farmError } = await supabase
            .from('farms')
            .select('name')
            .eq('id', userDbData.farm_id)
            .single();
        
        if (farmError || !farmData?.name) {
            return 'Minha Fazenda';
        }
        
        return farmData.name;
        
    } catch (error) {
        return 'Minha Fazenda';
    }
}


// Função utilitária para sempre buscar a conta primária
async function getPrimaryUserAccount(email) {
    try {
        // // const supabase = await getSupabaseClient(); // REMOVIDO // REMOVIDO - usando MySQL
        const { data: usersData, error } = await supabase
            .from('users')
            .select('*')
            .eq('email', email)
            .eq('is_active', true)
            .order('created_at', { ascending: true }); // Primeira conta = primária
        
        if (error) {
            console.error('Erro ao buscar conta primária:', error);
            return null;
        }
        
        return usersData?.[0] || null; // Sempre retorna a primeira conta
    } catch (error) {
        console.error('Erro na função getPrimaryUserAccount:', error);
        return null;
    }
}


// Chamar a inicialização quando a página carregar
document.addEventListener('DOMContentLoaded', function() {
    // Inicializar logo da Xandria Store
    setTimeout(updateXandriaStoreIcon, 200);
});

// Show notification function melhorada
function showNotification(message, type = 'info') {
    // Verificar se é uma mensagem especial que merece modal
    if (message.includes('Logo carregada') || message.includes('Configurações salvas com sucesso')) {
        showSuccessModal(message, type);
        return;
    }
    
    // Create notification element com design melhorado
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 p-4 rounded-xl shadow-2xl z-50 max-w-sm transform transition-all duration-300 border-l-4`;
    
    // Definir cores e ícones baseados no tipo
    let bgColor, textColor, borderColor, icon;
    switch(type) {
        case 'error':
            bgColor = 'bg-red-50';
            textColor = 'text-red-800';
            borderColor = 'border-red-500';
            icon = '🚨';
            break;
        case 'warning':
            bgColor = 'bg-yellow-50';
            textColor = 'text-yellow-800';
            borderColor = 'border-yellow-500';
            icon = '⚠️';
            break;
        case 'success':
            bgColor = 'bg-green-50';
            textColor = 'text-green-800';
            borderColor = 'border-green-500';
            icon = '✅';
            break;
        default:
            bgColor = 'bg-blue-50';
            textColor = 'text-blue-800';
            borderColor = 'border-blue-500';
            icon = 'ℹ️';
    }
    
    notification.className += ` ${bgColor} ${textColor} ${borderColor}`;
    
    // Criar conteúdo com ícone
    notification.innerHTML = `
        <div class="flex items-start space-x-3">
            <span class="text-lg flex-shrink-0">${icon}</span>
            <div class="flex-1">
                <p class="font-medium text-sm">${message}</p>
            </div>
            <button onclick="this.parentElement.parentElement.remove()" class="text-gray-400 hover:text-gray-600 transition-colors">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
    `;
    
    // Adicionar animação de entrada
    notification.style.transform = 'translateX(100%)';
    notification.style.opacity = '0';
    
    // Add to page
    document.body.appendChild(notification);
    
    // Animar entrada
    requestAnimationFrame(() => {
        notification.style.transform = 'translateX(0)';
        notification.style.opacity = '1';
    });
    
    // Remove after 5 seconds with animation
    setTimeout(() => {
        if (notification.parentNode) {
            notification.style.transform = 'translateX(100%)';
            notification.style.opacity = '0';
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
                }
            }, 300);
        }
    }, 5000);
}
// Modal de sucesso especial para mensagens importantes
function showSuccessModal(message, type = 'success') {
    // Verificar se já existe um modal
    const existingModal = document.getElementById('successModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Criar modal
    const modal = document.createElement('div');
    modal.id = 'successModal';
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
    
    // Determinar ícone e cores baseado na mensagem
    let icon, title, bgColor;
    if (message.includes('Logo carregada')) {
        icon = '🖼️';
        title = 'Logo Carregada!';
        bgColor = 'from-blue-500 to-blue-600';
    } else if (message.includes('Configurações salvas')) {
        icon = '⚙️';
        title = 'Configurações Salvas!';
        bgColor = 'from-green-500 to-green-600';
    } else {
        icon = '✅';
        title = 'Sucesso!';
        bgColor = 'from-green-500 to-green-600';
    }
    
    modal.innerHTML = `
        <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4 transform transition-all duration-300 scale-95 opacity-0" id="modalContent">
            <!-- Header com gradiente -->
            <div class="text-center mb-6">
                <div class="w-20 h-20 bg-gradient-to-br ${bgColor} rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg">
                    <span class="text-3xl">${icon}</span>
                </div>
                <h3 class="text-2xl font-bold text-gray-900 mb-2">${title}</h3>
                <div class="w-16 h-1 bg-gradient-to-r ${bgColor} rounded-full mx-auto"></div>
            </div>
            
            <!-- Mensagem -->
            <div class="text-center mb-8">
                <p class="text-gray-600 leading-relaxed">${message}</p>
            </div>
            
            <!-- Botão -->
            <div class="text-center">
                <button onclick="closeSuccessModal()" class="bg-gradient-to-r ${bgColor} text-white px-8 py-3 rounded-xl font-semibold shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 transition-all duration-200">
                    Entendi
                </button>
            </div>
        </div>
    `;
    
    // Adicionar evento de clique no fundo para fechar
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            closeSuccessModal();
        }
    });
    
    document.body.appendChild(modal);
    
    // Animar entrada
    requestAnimationFrame(() => {
        const content = document.getElementById('modalContent');
        if (content) {
            content.style.transform = 'scale(1)';
            content.style.opacity = '1';
        }
    });
    
    // Auto-fechar após 4 segundos
    setTimeout(() => {
        closeSuccessModal();
    }, 4000);
}

// Função para fechar modal de sucesso
function closeSuccessModal() {
    const modal = document.getElementById('successModal');
    if (modal) {
        const content = document.getElementById('modalContent');
        if (content) {
            content.style.transform = 'scale(0.95)';
            content.style.opacity = '0';
        }
        setTimeout(() => {
            modal.remove();
        }, 300);
    }
}

// Function to get manager name from session or Supabase
async function getManagerName() {
    try {

        
        // First try to get from local session
        const userData = localStorage.getItem('userData') || sessionStorage.getItem('userData');
        if (userData) {
            try {
                const user = JSON.parse(userData);
                if (user.name) {
            
                    return user.name;
                }
            } catch (error) {
            }
        }
        
        // Fallback to Supabase Auth
        const { data: { user } } = await supabase.auth.getUser();

        if (!user) {
    
            return authUser.user_metadata?.name || authUser.email?.split('@')[0] || 'Gerente';
        }

        // First try to get user from database
        const { data, error } = await supabase
            .from('users')
            .select('name')
            .eq('id', user.id)
            .single();
        

        
        // If user not found in database, return fallback
        if (error && error.code === 'PGRST116') {
            return user.user_metadata?.name || user.email?.split('@')[0] || 'Gerente';
        }
        
        if (error) {
            console.error('Error in getManagerName:', error);
            return 'Gerente';
        }
        return data?.name || 'Gerente';
    } catch (error) {
        console.error('Error fetching manager name:', error);
        return 'Gerente';
    }
}

// Function to set farm name in header
async function setFarmName() {
    const farmName = await getFarmName();
    document.getElementById('farmNameHeader').textContent = farmName;
}

// Function to extract formal name (second name)
function extractFormalName(fullName) {
    if (!fullName || typeof fullName !== 'string') {
        return 'Gerente';
    }
    
    // Remove extra spaces and split
    const names = fullName.trim().split(/\s+/);
    
    // If only one name, return it
    if (names.length === 1) {
        return names[0];
    }
    
    // If two names, return the first
    if (names.length === 2) {
        return names[0];
    }
    
    // For 3 or more names, try to find the most formal name
    // Skip common prefixes and find the second meaningful name
    const skipWords = ['da', 'de', 'do', 'das', 'dos', 'di', 'del', 'della', 'delle', 'delli'];
    
    let formalName = '';
    let nameCount = 0;
    
    for (let i = 0; i < names.length; i++) {
        const name = names[i].toLowerCase();
        
        // Skip common prefixes
        if (skipWords.includes(name)) {
            continue;
        }
        
        // Count meaningful names
        nameCount++;
        
        // Get the first meaningful name
        if (nameCount === 1) {
            formalName = names[i];
            break;
        }
    }
    
    // If we didn't find a first meaningful name, use the first name overall
    if (!formalName && names.length >= 1) {
        formalName = names[0];
    }
    
    // If still no formal name, use the first name
    if (!formalName) {
        formalName = names[0];
    }
    
    // Capitalize first letter
    return formalName.charAt(0).toUpperCase() + formalName.slice(1).toLowerCase();
}

// Function to set manager name in profile
async function setManagerName() {
    const managerName = await getManagerName();
    const farmName = await getFarmName();
    
    // Set with fallback values if empty
    const finalManagerName = managerName || 'Gerente';
    const finalFarmName = farmName || 'Minha Fazenda';
    
    // Extract formal name for welcome message
    const formalName = extractFormalName(finalManagerName);
    
    const elements = [
        'profileName',
        'profileFullName'
    ];
    
    elements.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.textContent = finalManagerName;
        }
    });
    
    // Set header and welcome message with formal name
    const headerElement = document.getElementById('managerName');
    const welcomeElement = document.getElementById('managerWelcome');
    if (headerElement) {
        headerElement.textContent = formalName;
    }
    if (welcomeElement) {
        welcomeElement.textContent = formalName;
    }
    
    document.getElementById('profileFarmName').textContent = finalFarmName;
}

// Function to load user profile data
async function loadUserProfile() {
    try {
        const whatsappElement = document.getElementById('profileWhatsApp');
        
        if (!whatsappElement) {
            return;
        }
        
        // First try to get from local session
        const sessionData = localStorage.getItem('userData') || sessionStorage.getItem('userData');
        
        if (sessionData) {
            try {
                const user = JSON.parse(sessionData);
                
                // Set profile data from session
                document.getElementById('profileEmail2').textContent = user.email || '';
                const whatsappValue = user.whatsapp || user.phone || 'Não informado';
                document.getElementById('profileWhatsApp').textContent = whatsappValue;
                return;
            } catch (error) {
                // Continue to fallback
            }
        }
        
        // Fallback to Supabase Auth
        const { data: { user } } = await supabase.auth.getUser();
        
        if (!user) {
            document.getElementById('profileEmail2').textContent = 'Não logado';
            document.getElementById('profileWhatsApp').textContent = 'Não informado';
            return;
        }

        const { data: userData, error } = await supabase
            .from('users')
            .select('name, email, whatsapp')
            .eq('id', user.id)
            .single();
        
        // If user not found, just show error - don't create automatically
        if (error && error.code === 'PGRST116') {
            document.getElementById('profileEmail2').textContent = user.email || '';
            document.getElementById('profileWhatsApp').textContent = 'Usuário não encontrado';
            return;
        }
        
        if (error) {
            document.getElementById('profileEmail2').textContent = user.email || '';
            document.getElementById('profileWhatsApp').textContent = 'Erro ao carregar';
            return;
        }

        // Update profile elements
        if (userData) {
            const email = userData.email || user.email || '';
            const whatsapp = userData.whatsapp || 'Não informado';
            
            document.getElementById('profileEmail2').textContent = email;
            document.getElementById('profileWhatsApp').textContent = whatsapp;
            
            // Armazenar email no sessionStorage para identificação de contas secundárias
            sessionStorage.setItem('userEmail', email);
        } else {
            const email = user.email || '';
            document.getElementById('profileEmail2').textContent = email;
            document.getElementById('profileWhatsApp').textContent = 'Não informado';
            
            // Armazenar email no sessionStorage mesmo se não encontrar dados completos
            sessionStorage.setItem('userEmail', email);
        }
    } catch (error) {
        document.getElementById('profileEmail2').textContent = 'Erro';
        document.getElementById('profileWhatsApp').textContent = 'Erro';
    }
}


// Update date and time
function updateDateTime() {
    const now = new Date();
    const timeString = now.toLocaleTimeString('pt-BR', { 
        hour: '2-digit', 
        minute: '2-digit' 
    });
    document.getElementById('lastUpdate').textContent = timeString;
}
// Load dashboard data from Supabase
/**
 * Carrega dados do dashboard principal
 * Inclui métricas de volume, qualidade, pagamentos e atividades recentes
 */
async function loadDashboardData() {
    // Aguardar LacTech estar disponível
    if (!window.LacTech || !window.LacTech.supabase) {

        await new Promise(resolve => setTimeout(resolve, 1000));
        if (!window.supabase) {
            console.error('❌ Supabase não disponível');
            return;
        }
    }
    
    // // const supabase = await getSupabaseClient(); // REMOVIDO // REMOVIDO - usando MySQL
    
    try {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) {
            return;
        }

        // Get user's farm_id first
        const { data: userData, error: userError } = await supabase
            .from('users')
            .select('farm_id')
            .eq('id', user.id)
            .maybeSingle();
        
        if (userError || !userData) {
            return;
        }

        // Load volume data - handle if table doesn't exist
        try {
            const { data: volumeData, error: volumeError } = await supabase
                .from('volume_records')
                .select('volume_liters')
                .eq('farm_id', userData.farm_id)
                .gte('production_date', new Date().toISOString().split('T')[0]);

            let todayVolume = 0;
            if (!volumeError && volumeData && volumeData.length > 0) {
                todayVolume = volumeData.reduce((sum, record) => sum + (record.volume_liters || 0), 0);
            }

            // Adicionar dados locais de hoje
            if (window.offlineSyncManager) {
                const localVolumeData = window.offlineSyncManager.getLocalData('volume');
                const today = new Date().toISOString().split('T')[0];
                const todayLocalData = localVolumeData.filter(record => 
                    record.production_date === today && record.farm_id === userData.farm_id
                );
                const todayLocalVolume = todayLocalData.reduce((sum, record) => sum + (record.volume_liters || 0), 0);
                todayVolume += todayLocalVolume;
                console.log(`📊 Volume hoje (online + offline): ${todayVolume}L`);
            }

                document.getElementById('todayVolume').textContent = `${todayVolume} L`;
                
                // Salvar no localStorage para persistir entre sessões
                localStorage.setItem('todayVolume', todayVolume.toString());
                localStorage.setItem('todayVolumeDate', new Date().toISOString().split('T')[0]);
        } catch (error) {
            console.error('❌ Erro ao carregar volume de hoje:', error);
            document.getElementById('todayVolume').textContent = '0 L';
            localStorage.setItem('todayVolume', '0');
            localStorage.setItem('todayVolumeDate', new Date().toISOString().split('T')[0]);
        }

        // Load quality data - handle if table doesn't exist
        try {
            // Buscar dados dos últimos 30 dias ao invés de apenas hoje
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            
            
            
            const { data: qualityData, error: qualityError } = await supabase
                .from('quality_tests')
                .select('fat_percentage, protein_percentage')
                .eq('farm_id', userData.farm_id)
                .gte('test_date', thirtyDaysAgo.toISOString().split('T')[0]);
                
            

            if (!qualityError && qualityData && qualityData.length > 0) {
                // Calculate quality score based on fat and protein percentages
                let totalScore = 0;
                let validTests = 0;
                
                qualityData.forEach(record => {
                    if (record.fat_percentage && record.protein_percentage) {
                        // Quality score: fat (3.0-4.5% ideal) + protein (3.0-3.8% ideal)
                        const fatScore = Math.min(100, Math.max(0, (record.fat_percentage / 4.0) * 100));
                        const proteinScore = Math.min(100, Math.max(0, (record.protein_percentage / 3.5) * 100));
                        const testScore = (fatScore + proteinScore) / 2;
                        totalScore += testScore;
                        validTests++;
                    }
                });
                
                if (validTests > 0) {
                    const avgQuality = totalScore / validTests;
                    document.getElementById('qualityAverage').textContent = `${Math.round(avgQuality)}%`;
                } else {
                    document.getElementById('qualityAverage').textContent = '--%';
                }
            } else {
                document.getElementById('qualityAverage').textContent = '--%';
            }
        } catch (error) {
    
            document.getElementById('qualityAverage').textContent = '--%';
        }

        // Load financial data - handle if table doesn't exist
        try {
            const { data: financialData, error: financialError } = await supabase
                .from('financial_records')
                .select('amount, type')
                .eq('farm_id', userData.farm_id)
                .eq('type', 'expense')
                .gte('created_at', new Date(new Date().getFullYear(), new Date().getMonth(), 1).toISOString());

            if (!financialError && financialData && financialData.length > 0) {
                const pendingAmount = financialData.reduce((sum, record) => sum + (record.amount || 0), 0);
                document.getElementById('pendingPayments').textContent = `R$ ${pendingAmount.toLocaleString('pt-BR')}`;
            } else {
                document.getElementById('pendingPayments').textContent = 'R$ 0';
            }
        } catch (error) {

            document.getElementById('pendingPayments').textContent = 'R$ 0';
        }

        // Load users data
        try {
            const { data: usersData, error: usersError } = await supabase
                .from('users')
                .select('id')
                .eq('farm_id', userData.farm_id)
                .eq('is_active', true);

            if (!usersError && usersData) {
                document.getElementById('activeUsers').textContent = usersData.length;
            } else {
                document.getElementById('activeUsers').textContent = '0';
            }
        } catch (error) {

            document.getElementById('activeUsers').textContent = '0';
        }

        // Load recent activities
        await loadRecentActivities(userData.farm_id);
        
        // Restaurar volume salvo se for do mesmo dia
        restoreSavedVolume();
        


    } catch (error) {
        console.error('❌ ERRO GERAL em loadDashboardData:', error);
        console.error('Stack trace:', error.stack);
    }
}

// Função para restaurar volume salvo do localStorage
function restoreSavedVolume() {
    try {
        const savedVolume = localStorage.getItem('todayVolume');
        const savedDate = localStorage.getItem('todayVolumeDate');
        const today = new Date().toISOString().split('T')[0];
        
        if (savedVolume && savedDate === today) {
            const volumeElement = document.getElementById('todayVolume');
            if (volumeElement) {
                volumeElement.textContent = `${savedVolume} L`;
            }
        } else if (savedDate !== today) {
            // Se a data mudou, limpar dados antigos
            localStorage.removeItem('todayVolume');
            localStorage.removeItem('todayVolumeDate');
        }
    } catch (error) {
        console.error('❌ Erro ao restaurar volume salvo:', error);
    }
}

// Load volume data from database and local storage
async function loadVolumeData() {
    // Aguardar Supabase estar disponível
    if (!window.supabase) {
        await new Promise(resolve => setTimeout(resolve, 1000));
        if (!window.supabase) {
            console.error('❌ Supabase não disponível para volume');
            return;
        }
    }
    
    // // const supabase = await getSupabaseClient(); // REMOVIDO // REMOVIDO - usando MySQL
    
    try {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) throw new Error('User not authenticated');

        const { data: volumeUserData, error: userError } = await supabase
            .from('users')
            .select('farm_id')
            .eq('id', user.id)
            .single();
        
        if (userError) {
            throw userError;
        }

        // Carregar dados locais se disponível
        let localVolumeData = [];
        if (window.offlineSyncManager) {
            localVolumeData = window.offlineSyncManager.getLocalData('volume');
            console.log(`📊 ${localVolumeData.length} registros locais de volume carregados`);
        }

        // Forçar atualização se cache foi limpo
        if (CacheManager.forceRefresh) {
            console.log('🔄 Cache foi limpo, forçando atualização...');
            CacheManager.forceRefresh = false;
        }

        // Get today's production data
        const today = new Date().toISOString().split('T')[0];
        const { data: todayData, error: todayError } = await supabase
            .from('volume_records')
            .select('volume_liters')
            .eq('farm_id', volumeUserData.farm_id)
            .gte('production_date', today)
            .lte('production_date', today);

        if (todayError) {
        }

        // Get week average
        const weekAgo = new Date();
        weekAgo.setDate(weekAgo.getDate() - 7);
        const { data: weekData, error: weekError } = await supabase
            .from('volume_records')
            .select('volume_liters')
            .eq('farm_id', volumeUserData.farm_id)
            .gte('production_date', weekAgo.toISOString().split('T')[0]);

        if (weekError) {
        }

        // Calcular volume de hoje incluindo dados locais
        let todayVolume = todayData?.reduce((sum, record) => sum + (record.volume_liters || 0), 0) || 0;
        
        // Adicionar dados locais de hoje
        const todayLocalData = localVolumeData.filter(record => 
            record.production_date === today && record.farm_id === volumeUserData.farm_id
        );
        const todayLocalVolume = todayLocalData.reduce((sum, record) => sum + (record.volume_liters || 0), 0);
        todayVolume += todayLocalVolume;

        // Calcular média semanal incluindo dados locais
        let weekAvg = weekData?.length > 0 ? 
            weekData.reduce((sum, record) => sum + (record.volume_liters || 0), 0) / weekData.length : 0;
        
        // Adicionar dados locais da semana
        const weekLocalData = localVolumeData.filter(record => {
            const recordDate = new Date(record.production_date);
            return recordDate >= weekAgo && record.farm_id === volumeUserData.farm_id;
        });
        const weekLocalVolume = weekLocalData.reduce((sum, record) => sum + (record.volume_liters || 0), 0);
        const totalWeekData = (weekData?.length || 0) + weekLocalData.length;
        if (totalWeekData > 0) {
            const totalWeekVolume = (weekData?.reduce((sum, record) => sum + (record.volume_liters || 0), 0) || 0) + weekLocalVolume;
            weekAvg = totalWeekVolume / totalWeekData;
        }

        const growth = weekAvg > 0 ? ((todayVolume - weekAvg) / weekAvg * 100) : 0;
        
        // Atualizar elementos da interface
        const volumeTodayElement = document.getElementById('volumeToday');
        const volumeWeekAvgElement = document.getElementById('volumeWeekAvg');
        const volumeGrowthElement = document.getElementById('volumeGrowth');
        
        if (volumeTodayElement) {
            volumeTodayElement.textContent = `${todayVolume.toFixed(0)} L`;
            console.log(`📊 Volume hoje atualizado: ${todayVolume.toFixed(0)} L`);
        } else {
            console.error('❌ Elemento volumeToday não encontrado');
        }
        
        if (volumeWeekAvgElement) {
            volumeWeekAvgElement.textContent = `${weekAvg.toFixed(0)} L`;
            console.log(`📊 Média semanal atualizada: ${weekAvg.toFixed(0)} L`);
        } else {
            console.error('❌ Elemento volumeWeekAvg não encontrado');
        }
        
        if (volumeGrowthElement) {
            volumeGrowthElement.textContent = `${growth > 0 ? '+' : ''}${growth.toFixed(1)}%`;
            console.log(`📊 Crescimento atualizado: ${growth > 0 ? '+' : ''}${growth.toFixed(1)}%`);
        } else {
            console.error('❌ Elemento volumeGrowth não encontrado');
        }
        
        // Buscar a última coleta real do banco de dados
        const { data: lastCollectionData, error: lastCollectionError } = await supabase
            .from('volume_records')
            .select('created_at')
            .eq('farm_id', volumeUserData.farm_id)
            .order('created_at', { ascending: false })
            .limit(1);

        if (!lastCollectionError && lastCollectionData && lastCollectionData.length > 0) {
            const lastCollectionTime = new Date(lastCollectionData[0].created_at);
            const dateStr = lastCollectionTime.toLocaleDateString('pt-BR', { 
                day: '2-digit', 
                month: '2-digit', 
                year: 'numeric' 
            });
            const timeStr = lastCollectionTime.toLocaleTimeString('pt-BR', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            document.getElementById('lastCollection').textContent = `${dateStr} - ${timeStr}`;
        } else {
            document.getElementById('lastCollection').textContent = '--/--/---- - --:--';
        }
        
    } catch (error) {
        console.error('Error loading volume data:', error);
        // Set default values on error
        document.getElementById('volumeToday').textContent = '0 L';
        document.getElementById('volumeWeekAvg').textContent = '0 L';
        document.getElementById('volumeGrowth').textContent = '0%';
        document.getElementById('lastCollection').textContent = '--:--';
    }
}

// Load quality data from database
async function loadQualityData() {
    try {
        // Aguardar Supabase estar disponível
        if (!window.supabase) {
            await new Promise(resolve => setTimeout(resolve, 1000));
            if (!window.supabase) {
                console.error('❌ Supabase não disponível para qualidade');
                throw new Error('Supabase not available');
            }
        }
        
        // // const supabase = await getSupabaseClient(); // REMOVIDO // REMOVIDO - usando MySQL
        
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) {
            throw new Error('User not authenticated');
        }



        const { data: qualityUserData, error: userError } = await supabase
            .from('users')
            .select('farm_id')
            .eq('id', user.id)
            .single();
        
        if (userError) {
            console.error('❌ Erro ao buscar dados do usuário:', userError);
            throw userError;
        }

        if (!qualityUserData || !qualityUserData.farm_id) {
            console.error('❌ Farm ID não encontrado para o usuário');
            throw new Error('Farm ID not found');
        }



        // Get latest quality data

        
        const { data: qualityData, error } = await supabase
            .from('quality_tests')
            .select('fat_percentage, protein_percentage, scc, cbt, test_date')
            .eq('farm_id', qualityUserData.farm_id)
            .not('fat_percentage', 'is', null)
            .not('protein_percentage', 'is', null)
            .order('test_date', { ascending: false })
            .limit(30);

        if (error) {
            console.error('❌ Erro ao buscar dados de qualidade:', error);
            throw error;
        }


        if (qualityData && qualityData.length > 0) {

        }

        if (qualityData && qualityData.length > 0) {
            // Filter out records with invalid data
            const validQualityData = qualityData.filter(record => 
                record.fat_percentage && 
                record.protein_percentage && 
                !isNaN(record.fat_percentage) && 
                !isNaN(record.protein_percentage)
            );
            

            
            if (validQualityData.length === 0) {

                updateQualityDisplay('--', '--', '--', '--', '--%');
                updateQualityCharts([]);
                return;
            }
            
            const avgFat = validQualityData.reduce((sum, record) => sum + (record.fat_percentage || 0), 0) / validQualityData.length;
            const avgProtein = validQualityData.reduce((sum, record) => sum + (record.protein_percentage || 0), 0) / validQualityData.length;
                            const avgSCC = validQualityData.reduce((sum, record) => sum + (record.scc || 0), 0) / validQualityData.length;
                            const avgTBC = validQualityData.reduce((sum, record) => sum + (record.cbt || 0), 0) / validQualityData.length;
            

            
            // Calculate quality score based on industry standards
            let totalScore = 0;
            let validTests = 0;
            
            validQualityData.forEach(record => {
                if (record.fat_percentage && record.protein_percentage) {
                    // Quality scoring based on industry standards
                    // Fat: 3.0-4.5% is excellent, 2.5-3.0% is good, <2.5% is poor
                    // Protein: 3.0-3.8% is excellent, 2.7-3.0% is good, <2.7% is poor
                    
                    let fatScore = 0;
                    if (record.fat_percentage >= 3.0 && record.fat_percentage <= 4.5) {
                        fatScore = 100; // Excellent range
                    } else if (record.fat_percentage >= 2.5 && record.fat_percentage < 3.0) {
                        fatScore = 70; // Good range
                    } else if (record.fat_percentage > 4.5) {
                        fatScore = 80; // Above excellent, still good
                    } else {
                        fatScore = Math.max(0, (record.fat_percentage / 2.5) * 70); // Poor range
                    }
                    
                    let proteinScore = 0;
                    if (record.protein_percentage >= 3.0 && record.protein_percentage <= 3.8) {
                        proteinScore = 100; // Excellent range
                    } else if (record.protein_percentage >= 2.7 && record.protein_percentage < 3.0) {
                        proteinScore = 70; // Good range
                    } else if (record.protein_percentage > 3.8) {
                        proteinScore = 80; // Above excellent, still good
                    } else {
                        proteinScore = Math.max(0, (record.protein_percentage / 2.7) * 70); // Poor range
                    }
                    
                    const testScore = (fatScore + proteinScore) / 2;
                    totalScore += testScore;
                    validTests++;
                    

                }
            });
            
            const avgQuality = validTests > 0 ? totalScore / validTests : 0;

            
            // Atualizar elementos do DOM com verificação de existência
            const fatContent = `${avgFat.toFixed(1)}%`;
            const proteinContent = `${avgProtein.toFixed(1)}%`;
            const sccContent = avgSCC > 0 ? `${Math.round(avgSCC / 1000)}k` : '--';
            const tbcContent = avgTBC > 0 ? `${Math.round(avgTBC / 1000)}k` : '--';
            const qualityContent = `${Math.round(avgQuality)}%`;
            
            updateQualityDisplay(fatContent, proteinContent, sccContent, tbcContent, qualityContent);
            

            
            // Update quality charts
            updateQualityCharts(validQualityData);
        } else {
    
            updateQualityDisplay('--', '--', '--', '--', '--%');
            updateQualityCharts([]);
        }
        
    } catch (error) {
        console.error('❌ Erro ao carregar dados de qualidade:', error);
        updateQualityDisplay('--', '--', '--', '--', '--%');
        updateQualityCharts([]);
    }
}

// Função auxiliar para atualizar elementos de qualidade com verificação de existência
function updateQualityDisplay(fat, protein, scc, tbc, quality) {
    const elements = {
        'fatContent': fat,
        'proteinContent': protein,
        'sccCount': scc,
        'tbc': tbc,
        'qualityAverage': quality
    };
    
    Object.entries(elements).forEach(([id, value]) => {
        const element = document.getElementById(id);
        if (element) {
            element.textContent = value;

        } else {
        }
    });
}
// Load sales data from database
async function loadPaymentsData() {
    // Aguardar Supabase estar disponível
    if (!window.supabase) {
        await new Promise(resolve => setTimeout(resolve, 1000));
        if (!window.supabase) {
            console.error('❌ Supabase não disponível para pagamentos');
            return;
        }
    }
    
    // // const supabase = await getSupabaseClient(); // REMOVIDO // REMOVIDO - usando MySQL
    
    try {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) throw new Error('User not authenticated');

        const { data: userData, error: userError } = await supabase
            .from('users')
            .select('farm_id')
            .eq('id', user.id)
            .maybeSingle();
        
        if (userError) {
            throw userError;
        }

        // Get sales data from financial records table
        const { data: salesData, error: salesError } = await supabase
            .from('financial_records')
            .select('amount, type, record_date, created_at, description')
            .eq('farm_id', userData.farm_id)
            .eq('type', 'income')
            .order('created_at', { ascending: false });

        if (salesError) {
            throw salesError;
        }

        let completedAmount = 0;
        let pendingAmount = 0;
        let overdueAmount = 0;

        if (salesData && salesData.length > 0) {
            // Para financial_records, consideramos todas as receitas como "pagas"
            // pois são registros de transações já realizadas
            salesData.forEach(sale => {
                const amount = parseFloat(sale.amount) || 0;
                completedAmount += amount;
            });
        }

        // Update UI elements
        document.getElementById('paidAmount').textContent = `R$ ${completedAmount.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;
        document.getElementById('pendingAmount').textContent = `R$ ${pendingAmount.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;
        document.getElementById('overdueAmount').textContent = `R$ ${overdueAmount.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;
        
        // Update sales chart if it exists
        if (window.paymentsChart && window.paymentsChart.data && window.paymentsChart.data.datasets) {
            window.paymentsChart.data.labels = ['Pagos', 'Pendentes', 'Atrasados'];
            window.paymentsChart.data.datasets[0].data = [completedAmount, pendingAmount, overdueAmount];
            window.paymentsChart.update();
        }
        
    } catch (error) {
        console.error('Error loading sales data:', error);
        // Set default values on error
        document.getElementById('paidAmount').textContent = 'R$ 0,00';
        document.getElementById('pendingAmount').textContent = 'R$ 0,00';
        document.getElementById('overdueAmount').textContent = 'R$ 0,00';
    }
}

// Load users data from database
async function loadUsersData() {
    try {
        // Aguardar Supabase estar disponível
        if (!window.supabase) {
            await new Promise(resolve => setTimeout(resolve, 1000));
            if (!window.supabase) {
                console.error('❌ Supabase não disponível para usuários');
                throw new Error('Supabase not available');
            }
        }
        
        // // const supabase = await getSupabaseClient(); // REMOVIDO // REMOVIDO - usando MySQL
        
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) throw new Error('User not authenticated');

        let { data: usersUserData, error: userError } = await supabase
            .from('users')
            .select('farm_id')
            .eq('id', user.id)
            .maybeSingle();
        
        if (userError) {
            console.error('❌ Erro ao buscar dados do usuário:', userError);
            throw userError;
        }
        if (!usersUserData) {
            console.error('❌ Dados do usuário não encontrados para ID:', user.id);
            throw new Error('User data not found');
        }

        const { data: usersData, error } = await supabase
            .from('users')
            .select('id, name, email, role, whatsapp, is_active, created_at, profile_photo_url')
            .eq('farm_id', usersUserData.farm_id)
            .order('created_at', { ascending: false });

        if (usersData) {
            const employeesCount = usersData.filter(u => u.role === 'funcionario').length;
            const veterinariansCount = usersData.filter(u => u.role === 'veterinario').length;
            const managersCount = usersData.filter(u => u.role === 'gerente').length;
            const totalUsers = usersData.length;
            
            document.getElementById('totalUsers').textContent = totalUsers;
            document.getElementById('employeesCount').textContent = employeesCount;
            document.getElementById('veterinariansCount').textContent = veterinariansCount;
            document.getElementById('managersCount').textContent = managersCount;
            
        setTimeout(() => {
            displayUsersList(usersData);
            
            document.querySelectorAll('.action-button.permissions').forEach(button => {
                button.addEventListener('click', function(e) {
                    e.preventDefault();
                    const userId = this.getAttribute('data-user-id');
                    const currentStatus = this.getAttribute('data-current-status') === 'true';
                    toggleUserAccess(userId, currentStatus);
                });
            });
        }, 100);
        } else {
            document.getElementById('totalUsers').textContent = '1';
            document.getElementById('employeesCount').textContent = '0';
            document.getElementById('veterinariansCount').textContent = '0';
            document.getElementById('managersCount').textContent = '1';
            displayUsersList([]);
        }
        
    } catch (error) {
        console.error('Error loading users data:', error);
        // Set default values on error
        document.getElementById('totalUsers').textContent = '1';
        document.getElementById('employeesCount').textContent = '0';
        document.getElementById('veterinariansCount').textContent = '0';
        document.getElementById('managersCount').textContent = '1';
        displayUsersList([]);
    }
}

// Load weekly volume chart data
async function loadWeeklyVolumeChart() {
    try {
        // Aguardar Supabase estar disponível
        if (!window.supabase) {
            await new Promise(resolve => setTimeout(resolve, 1000));
            if (!window.supabase) {
                console.error('❌ Supabase não disponível para gráfico semanal');
                return;
            }
        }
        
        // // const supabase = await getSupabaseClient(); // REMOVIDO // REMOVIDO - usando MySQL
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) return;

        const { data: userData, error: userError } = await supabase
            .from('users')
            .select('farm_id')
            .eq('id', user.id)
            .maybeSingle();
        
        if (userError) {
            return;
        }

        // Get last 7 days of data
        const endDate = new Date();
        const startDate = new Date();
        startDate.setDate(startDate.getDate() - 6);

        const { data: volumeData, error } = await supabase
            .from('volume_records')
            .select('production_date, volume_liters')
            .eq('farm_id', userData.farm_id)
            .gte('production_date', startDate.toISOString().split('T')[0])
            .lte('production_date', endDate.toISOString().split('T')[0])
            .order('production_date', { ascending: true });

        if (error) {
            return;
        }

        // Group by date and sum volumes
        const dailyVolumes = {};
        const labels = [];
        
        // Initialize all days with 0
        for (let i = 0; i < 7; i++) {
            const date = new Date(startDate);
            date.setDate(date.getDate() + i);
            const dateStr = date.toISOString().split('T')[0];
            const dayName = date.toLocaleDateString('pt-BR', { weekday: 'short' });
            labels.push(dayName);
            dailyVolumes[dateStr] = 0;
        }

        // Sum volumes by date
        if (volumeData) {
            volumeData.forEach(record => {
                if (dailyVolumes.hasOwnProperty(record.production_date)) {
                    dailyVolumes[record.production_date] += record.volume_liters || 0;
                }
            });
        }

        const data = Object.values(dailyVolumes);
        const hasRealData = data.some(value => value > 0);

        // Update chart
        if (window.weeklyVolumeChart && hasRealData) {
            window.weeklyVolumeChart.data.labels = labels;
            window.weeklyVolumeChart.data.datasets[0].data = data;
            window.weeklyVolumeChart.update();
        }

    } catch (error) {
        console.error('Error loading weekly volume chart:', error);
    }
}

// Load daily volume chart data
async function loadDailyVolumeChart() {
    try {
        // // const supabase = await getSupabaseClient(); // REMOVIDO // REMOVIDO - usando MySQL
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) return;

        const { data: userData, error: userError } = await supabase
            .from('users')
            .select('farm_id')
            .eq('id', user.id)
            .single();
        
        if (userError) {
            return;
        }

        // Get today's data by shift
        const today = new Date().toISOString().split('T')[0];
        const { data: volumeData, error } = await supabase
            .from('volume_records')
            .select('milking_type, volume_liters')
            .eq('farm_id', userData.farm_id)
            .eq('production_date', today)
            .order('milking_type', { ascending: true });

        if (error) {
            return;
        }

        // Group by shift
        const shiftVolumes = {
            'morning': 0,
            'afternoon': 0,
            'evening': 0,
            'night': 0
        };

        if (volumeData) {
            volumeData.forEach(record => {
                if (shiftVolumes.hasOwnProperty(record.milking_type)) {
                    shiftVolumes[record.milking_type] += record.volume_liters || 0;
                }
            });
        }

        const labels = ['Manhã', 'Tarde', 'Noite', 'Madrugada'];
        const data = [shiftVolumes.morning, shiftVolumes.afternoon, shiftVolumes.evening, shiftVolumes.night];

        // Update chart
        if (window.dailyVolumeChart) {
            window.dailyVolumeChart.data.labels = labels;
            window.dailyVolumeChart.data.datasets[0].data = data;
            window.dailyVolumeChart.update();
        }

    } catch (error) {
        console.error('Error loading daily volume chart:', error);
    }
}

// Load monthly volume chart data (only shows on last day of month)
async function loadMonthlyVolumeChart() {
    try {
        const now = new Date();
        const lastDayOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);
        
        // Only show monthly chart on the last day of the month
        if (now.getDate() !== lastDayOfMonth.getDate()) {
            return;
        }
        
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) return;

        const { data: userData, error: userError } = await supabase
            .from('users')
            .select('farm_id')
            .eq('id', user.id)
            .single();
        
        if (userError) {
            return;
        }

        // Get last 12 months of data
        const endDate = new Date();
        const startDate = new Date();
        startDate.setMonth(startDate.getMonth() - 11);
        startDate.setDate(1);

        const { data: volumeData, error } = await supabase
            .from('volume_records')
            .select('production_date, volume_liters')
            .eq('farm_id', userData.farm_id)
            .gte('production_date', startDate.toISOString().split('T')[0])
            .lte('production_date', endDate.toISOString().split('T')[0])
            .order('production_date', { ascending: true });

        if (error) {
            return;
        }

        // Group by month and sum volumes
        const monthlyVolumes = {};
        const labels = [];
        
        // Initialize all months with 0
        for (let i = 0; i < 12; i++) {
            const date = new Date(startDate);
            date.setMonth(date.getMonth() + i);
            const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
            const monthName = date.toLocaleDateString('pt-BR', { month: 'short', year: '2-digit' });
            labels.push(monthName);
            monthlyVolumes[monthKey] = 0;
        }

        // Sum volumes by month
        if (volumeData) {
            volumeData.forEach(record => {
                const date = new Date(record.production_date);
                const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                if (monthlyVolumes.hasOwnProperty(monthKey)) {
                    monthlyVolumes[monthKey] += record.volume_liters || 0;
                }
            });
        }
        const data = Object.values(monthlyVolumes);

        // Show monthly chart container and update chart
        const monthlyChartContainer = document.getElementById('monthlyVolumeChartContainer');
        if (monthlyChartContainer) {
            monthlyChartContainer.style.display = 'block';
            
            if (window.monthlyVolumeChart) {
                window.monthlyVolumeChart.data.labels = labels;
                window.monthlyVolumeChart.data.datasets[0].data = data;
                window.monthlyVolumeChart.update();
            }
        }

    } catch (error) {
        console.error('Error loading monthly volume chart:', error);
    }
}

// Load weekly summary chart (only shows on Sundays)
async function loadWeeklySummaryChart() {
    try {
        const now = new Date();
        
        // Only show weekly summary on Sundays (0 = Sunday)
        if (now.getDay() !== 0) {
            return;
        }
        
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) return;

        const { data: userData, error: userError } = await supabase
            .from('users')
            .select('farm_id')
            .eq('id', user.id)
            .single();
        
        if (userError) {
            return;
        }

        // Get last 8 weeks of data
        const endDate = new Date();
        const startDate = new Date();
        startDate.setDate(startDate.getDate() - 56); // 8 weeks

        const { data: volumeData, error } = await supabase
            .from('volume_records')
            .select('production_date, volume_liters')
            .eq('farm_id', userData.farm_id)
            .gte('production_date', startDate.toISOString().split('T')[0])
            .lte('production_date', endDate.toISOString().split('T')[0])
            .order('production_date', { ascending: true });

        if (error) {
            return;
        }

        // Group by week and sum volumes
        const weeklyVolumes = {};
        const labels = [];
        
        // Initialize all weeks with 0
        for (let i = 0; i < 8; i++) {
            const weekStart = new Date(startDate);
            weekStart.setDate(weekStart.getDate() + (i * 7));
            const weekKey = getWeekKey(weekStart);
            const weekLabel = `Sem ${i + 1}`;
            labels.push(weekLabel);
            weeklyVolumes[weekKey] = 0;
        }

        // Sum volumes by week
        if (volumeData) {
            volumeData.forEach(record => {
                const date = new Date(record.production_date);
                const weekKey = getWeekKey(date);
                if (weeklyVolumes.hasOwnProperty(weekKey)) {
                    weeklyVolumes[weekKey] += record.volume_liters || 0;
                }
            });
        }

        const data = Object.values(weeklyVolumes);

        // Show weekly summary chart container and update chart
        const weeklySummaryContainer = document.getElementById('weeklySummaryChartContainer');
        if (weeklySummaryContainer) {
            weeklySummaryContainer.style.display = 'block';
            
            if (window.weeklySummaryChart) {
                window.weeklySummaryChart.data.labels = labels;
                window.weeklySummaryChart.data.datasets[0].data = data;
                window.weeklySummaryChart.update();
            }
        }

    } catch (error) {
        console.error('Error loading weekly summary chart:', error);
    }
}

// Helper function to get week key
function getWeekKey(date) {
    const startOfWeek = new Date(date);
    startOfWeek.setDate(date.getDate() - date.getDay());
    return startOfWeek.toISOString().split('T')[0];
}

// Load dashboard volume chart (last 7 days)
async function loadDashboardVolumeChart() {
    try {
        console.log('🔄 Carregando gráfico Volume Semanal...');
        
<<<<<<< HEAD
        // Wait for Chart.js to be available
        if (typeof Chart === 'undefined') {
            console.log('⏳ Aguardando Chart.js...');
            await new Promise(resolve => {
                const checkChart = () => {
                    if (typeof Chart !== 'undefined') {
                        resolve();
                    } else {
                        setTimeout(checkChart, 100);
                    }
                };
                checkChart();
            });
        }
        
        // Usando MySQL direto através do objeto 'db'
        if (!db) {
            console.error('❌ Database não disponível para Volume Semanal');
=======
        // // const supabase = await getSupabaseClient(); // REMOVIDO // REMOVIDO - usando MySQL
        if (!supabase) {
            console.error('❌ Supabase não disponível para Volume Semanal');
>>>>>>> parent of 0eb3d2f (.)
            return;
        }

        // Usar cache para dados do usuário
        const userData = await CacheManager.getUserData();
        
        if (!userData?.farm_id) {
            console.error('❌ Farm ID não encontrado para Volume Semanal');
            return;
        }

        console.log('🏡 Farm ID para Volume Semanal:', userData.farm_id);

        // Get last 7 days of data
        const endDate = new Date();
        const startDate = new Date();
        startDate.setDate(startDate.getDate() - 6);

        console.log('📅 Período Volume Semanal:', startDate.toISOString().split('T')[0], 'até', endDate.toISOString().split('T')[0]);

        const { data: volumeData, error } = await supabase
            .from('volume_records')
            .select('production_date, volume_liters')
            .eq('farm_id', userData.farm_id)
            .gte('production_date', startDate.toISOString().split('T')[0])
            .lte('production_date', endDate.toISOString().split('T')[0])
            .order('production_date', { ascending: true });

        if (error) {
            console.error('❌ Erro ao buscar dados de volume:', error);
            return;
        }

        console.log('📊 Dados de volume encontrados:', volumeData?.length || 0, 'registros');

        // Group by date and sum volumes
        const dailyVolumes = {};
        const labels = [];
        
        // Initialize all days with 0
        for (let i = 0; i < 7; i++) {
            const date = new Date(startDate);
            date.setDate(date.getDate() + i);
            const dateStr = date.toISOString().split('T')[0];
            const dayName = date.toLocaleDateString('pt-BR', { weekday: 'short' });
            labels.push(dayName);
            dailyVolumes[dateStr] = 0;
        }

        // Sum volumes by date
        if (volumeData && volumeData.length > 0) {
            volumeData.forEach(record => {
                if (dailyVolumes.hasOwnProperty(record.production_date)) {
                    dailyVolumes[record.production_date] += record.volume_liters || 0;
                }
            });
        }

        const data = Object.values(dailyVolumes);
        const hasRealData = data.some(value => value > 0);

        console.log('📈 Dados processados Volume Semanal:', { labels, data, hasRealData });

        // Update chart - sempre mostrar o gráfico, mesmo sem dados
        if (window.volumeChart) {
            console.log('✅ Atualizando gráfico Volume Semanal...');
            window.volumeChart.data.labels = labels;
            window.volumeChart.data.datasets[0].data = data;
            window.volumeChart.update();
            console.log('✅ Gráfico Volume Semanal atualizado com sucesso');
        } else {
            console.error('❌ Gráfico volumeChart não encontrado, tentando reinicializar...');
            // Tentar reinicializar o gráfico
                const volumeCtx = document.getElementById('volumeChart');
                if (volumeCtx) {
                    window.volumeChart = new Chart(volumeCtx, {
                        type: 'line',
                        data: {
                        labels: labels,
                            datasets: [{
                                label: 'Volume (L)',
                            data: data,
                                borderColor: '#369e36',
                                backgroundColor: 'rgba(54, 158, 54, 0.1)',
                                tension: 0.4,
                                fill: true
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: false
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            }
                        }
                    });
                console.log('✅ Gráfico Volume Semanal reinicializado com sucesso');
            } else {
                console.error('❌ Elemento volumeChart não encontrado no DOM');
            }
        }

    } catch (error) {
        console.error('❌ Erro ao carregar gráfico Volume Semanal:', error);
    }
}

// Load dashboard weekly production chart (last 7 days)
async function loadDashboardWeeklyChart() {
    try {
        console.log('🔄 Carregando gráfico de produção semanal...');
        
<<<<<<< HEAD
        // Wait for Chart.js to be available
        if (typeof Chart === 'undefined') {
            console.log('⏳ Aguardando Chart.js...');
            await new Promise(resolve => {
                const checkChart = () => {
                    if (typeof Chart !== 'undefined') {
                        resolve();
                    } else {
                        setTimeout(checkChart, 100);
                    }
                };
                checkChart();
            });
        }
        
        // Usando MySQL direto através do objeto 'db'
        if (!db) {
            console.error('❌ Database não disponível');
=======
        // // const supabase = await getSupabaseClient(); // REMOVIDO // REMOVIDO - usando MySQL
        if (!supabase) {
            console.error('❌ Supabase não disponível');
>>>>>>> parent of 0eb3d2f (.)
            return;
        }

        // Usar cache para dados do usuário
        const userData = await CacheManager.getUserData();
        
        if (!userData?.farm_id) {
            console.error('❌ Farm ID não encontrado');
            return;
        }

        console.log('🏡 Farm ID:', userData.farm_id);

        // Get last 7 days of data
        const endDate = new Date();
        const startDate = new Date();
        startDate.setDate(startDate.getDate() - 6);

        console.log('📅 Período:', startDate.toISOString().split('T')[0], 'até', endDate.toISOString().split('T')[0]);

        // Usar cache para dados de volume semanal (forçar atualização se necessário)
        const productionData = await CacheManager.getVolumeData(userData.farm_id, 'week', CacheManager.forceRefresh);

        if (!productionData) {
            console.error('❌ Erro ao buscar dados de produção');
            return;
        }

        console.log('📊 Dados de produção encontrados:', productionData?.length || 0, 'registros');

        // Carregar dados locais se disponível
        let localVolumeData = [];
        if (window.offlineSyncManager) {
            localVolumeData = window.offlineSyncManager.getLocalData('volume');
            console.log(`📊 ${localVolumeData.length} registros locais de volume carregados`);
        }

        // Group by date and sum volumes
        const dailyProduction = {};
        const labels = [];
        
        // Initialize all days with 0
        for (let i = 0; i < 7; i++) {
            const date = new Date(startDate);
            date.setDate(date.getDate() + i);
            const dateStr = date.toISOString().split('T')[0];
            const dayName = date.toLocaleDateString('pt-BR', { weekday: 'short' });
            labels.push(dayName);
            dailyProduction[dateStr] = 0;
        }

        // Sum production by date (dados online)
        if (productionData && productionData.length > 0) {
            productionData.forEach(record => {
                if (dailyProduction.hasOwnProperty(record.production_date)) {
                    dailyProduction[record.production_date] += record.volume_liters || 0;
                }
            });
        }

        // Adicionar dados locais (offline)
        if (localVolumeData && localVolumeData.length > 0) {
            localVolumeData.forEach(record => {
                if (dailyProduction.hasOwnProperty(record.production_date) && record.farm_id === userData.farm_id) {
                    dailyProduction[record.production_date] += record.volume_liters || 0;
                    console.log(`📊 Adicionando volume local: ${record.volume_liters}L para ${record.production_date}`);
                }
            });
        }

        const data = Object.values(dailyProduction);
        console.log('📈 Dados processados (online + offline):', { labels, data });
        console.log('📈 Produção diária:', dailyProduction);

        // Update chart
        if (window.dashboardWeeklyChart) {
            console.log('✅ Atualizando gráfico...');
            window.dashboardWeeklyChart.data.labels = labels;
            window.dashboardWeeklyChart.data.datasets[0].data = data;
            window.dashboardWeeklyChart.update();
            console.log('✅ Gráfico atualizado com sucesso');
        } else {
            console.error('❌ Gráfico dashboardWeeklyChart não encontrado, tentando reinicializar...');
            // Tentar reinicializar o gráfico
            const dashboardWeeklyCtx = document.getElementById('dashboardWeeklyChart');
            if (dashboardWeeklyCtx) {
                window.dashboardWeeklyChart = new Chart(dashboardWeeklyCtx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Produção (L)',
                            data: data,
                            backgroundColor: '#5bb85b',
                            borderRadius: 8
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                // Escala dinâmica - sem limite máximo
                                ticks: {
                                    callback: function(value) {
                                        return value + 'L';
                                    }
                                }
                            }
                        }
                    }
                });
                console.log('✅ Gráfico reinicializado com sucesso');
            } else {
                console.error('❌ Elemento dashboardWeeklyChart não encontrado no DOM');
            }
        }

    } catch (error) {
        console.error('❌ Erro ao carregar gráfico de produção semanal:', error);
    }
}

// Load monthly production chart
async function loadMonthlyProductionChart() {
    try {
        console.log('🔄 Carregando gráfico de produção mensal...');
        
<<<<<<< HEAD
        // Wait for Chart.js to be available
        if (typeof Chart === 'undefined') {
            console.log('⏳ Aguardando Chart.js...');
            await new Promise(resolve => {
                const checkChart = () => {
                    if (typeof Chart !== 'undefined') {
                        resolve();
                    } else {
                        setTimeout(checkChart, 100);
                    }
                };
                checkChart();
            });
        }
        
        // Usando MySQL direto através do objeto 'db'
        if (!db) {
            console.error('❌ Cliente Database não disponível');
=======
        // // const supabase = await getSupabaseClient(); // REMOVIDO // REMOVIDO - usando MySQL
        if (!supabase) {
            console.error('❌ Cliente Supabase não disponível');
>>>>>>> parent of 0eb3d2f (.)
            return;
        }

        // Usar cache para dados do usuário
        const userData = await CacheManager.getUserData();

        if (!userData?.farm_id) {
            console.error('❌ Farm ID não encontrado');
            return;
        }

        console.log('✅ Usuário autenticado, farm_id:', userData.farm_id);

        // Get first day of current month
        const hoje = new Date();
        const primeiroDiaMes = new Date(hoje.getFullYear(), hoje.getMonth(), 1);

        console.log('📅 Buscando dados de:', primeiroDiaMes.toISOString().split('T')[0], 'até hoje');

        // Usar cache para dados de volume mensal
        const dadosGrafico = await CacheManager.getVolumeData(userData.farm_id, 'month');

        if (!dadosGrafico) {
            console.error('❌ Erro ao buscar dados do gráfico mensal');
            return;
        }

        console.log('📊 Dados mensais encontrados:', dadosGrafico?.length || 0, 'registros');

        // Process monthly data
        const dadosPorDia = {};

        if (dadosGrafico && dadosGrafico.length > 0) {
            dadosGrafico.forEach(registro => {
                const data = registro.production_date;
                if (!dadosPorDia[data]) {
                    dadosPorDia[data] = 0;
                }
                dadosPorDia[data] += parseFloat(registro.volume_liters || 0);
            });
        }

        // Create array with all days of the month
        const diasDoMes = [];
        const volumesDoMes = [];

        for (let dia = 1; dia <= hoje.getDate(); dia++) {
            const data = new Date(hoje.getFullYear(), hoje.getMonth(), dia);
            const dataStr = data.toISOString().split('T')[0];

            diasDoMes.push(dia.toString());
            volumesDoMes.push(dadosPorDia[dataStr] || 0);
        }

        console.log('📊 Dados processados:', { dias: diasDoMes.length, volumes: volumesDoMes });

        // Destroy previous chart if exists
        if (window.monthlyProductionChartInstance) {
            window.monthlyProductionChartInstance.destroy();
        }

        const ctx = document.getElementById('monthlyProductionChart');
        if (ctx) {
            window.monthlyProductionChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: diasDoMes,
                    datasets: [{
                        label: 'Volume (L)',
                        data: volumesDoMes,
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 4,
                        pointHoverRadius: 6,
                        pointBackgroundColor: '#10b981',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#ffffff',
                            bodyColor: '#ffffff',
                            borderColor: '#10b981',
                            borderWidth: 1,
                            callbacks: {
                                label: function(context) {
                                    return `Volume: ${context.parsed.y.toFixed(1)}L`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                color: '#6b7280',
                                font: {
                                    size: 12
                                }
                            }
                        },
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(107, 114, 128, 0.1)'
                            },
                            ticks: {
                                color: '#6b7280',
                                font: {
                                    size: 12
                                },
                                callback: function(value) {
                                    return value.toFixed(0) + 'L';
                                }
                            }
                        }
                    },
                    animation: {
                        duration: 1000,
                        easing: 'easeInOutQuart'
                    }
                }
            });

            console.log('✅ Gráfico mensal criado com sucesso!');
        } else {
            console.error('❌ Elemento monthlyProductionChart não encontrado');
        }

    } catch (error) {
        console.error('❌ Erro ao carregar gráfico mensal:', error);
    }
}

// Helper function to get time ago text
function getTimeAgo(minutesAgo) {
    if (minutesAgo < 60) {
        return `${minutesAgo}min atrás`;
    } else if (minutesAgo < 1440) {
        const hours = Math.floor(minutesAgo / 60);
        return `${hours}h atrás`;
    } else {
        const days = Math.floor(minutesAgo / 1440);
        return `${days}d atrás`;
    }
}

// Helper function to get time ago from date
function getTimeAgoFromDate(date) {
    const now = new Date();
    const diffMs = now - date;
    const diffMinutes = Math.floor(diffMs / (1000 * 60));
    
    if (diffMinutes < 60) {
        return `${diffMinutes}min atrás`;
    } else if (diffMinutes < 1440) {
        const hours = Math.floor(diffMinutes / 60);
        return `${hours}h atrás`;
    } else {
        const days = Math.floor(diffMinutes / 1440);
        return `${days}d atrás`;
    }
}

// Function to display users list
/**
 * Exibe a lista de usuários na interface
 * Renderiza cards com informações e ações para cada usuário
 */
function displayUsersList(users) {
    const usersList = document.getElementById('usersList');
    
    if (!users || users.length === 0) {
        usersList.innerHTML = `
            <div class="text-center py-12">
                <div class="w-20 h-20 bg-gray-100    rounded-full flex items-center justify-center mx-auto mb-6">
                    <svg class="w-10 h-10 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                    </svg>
                </div>
                <h3 class="text-lg font-semibold text-gray-900    mb-2">Nenhum Usuário Cadastrado</h3>
                <p class="text-gray-600    mb-4">Adicione usuários para gerenciar sua equipe</p>
                <button onclick="addUser()" class="px-6 py-3 gradient-forest text-white font-semibold rounded-xl hover:shadow-lg transition-all">
                    <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                    </svg>
                    Adicionar Primeiro Usuário
                </button>
            </div>
        `;
        return;
    }
    
    const usersHtml = users.map(user => {
        
        // Verificar se é conta secundária (mesmo email do gerente atual, mas role diferente)
        // Obter email do usuário atual do Supabase se não estiver no sessionStorage
        let currentUserEmail = sessionStorage.getItem('userEmail');
        if (!currentUserEmail) {
            // Tentar obter do localStorage ou sessionStorage como userData
            const userData = localStorage.getItem('userData') || sessionStorage.getItem('userData');
            if (userData) {
                try {
                    const parsedUserData = JSON.parse(userData);
                    currentUserEmail = parsedUserData.email;
                    // Armazenar no sessionStorage para uso futuro
                    sessionStorage.setItem('userEmail', currentUserEmail);
                } catch (e) {
                }
            }
        }
        
        const isSecondaryAccount = user.email === currentUserEmail && user.role !== 'gerente';
        
        const roleText = {
            'gerente': 'Gerente',
            'funcionario': 'Funcionário',
            'veterinario': 'Veterinário',
            'proprietario': 'Proprietário'
        }[user.role] || user.role;
        
        const roleColor = {
            'gerente': 'bg-blue-100 text-blue-800',
            'funcionario': 'bg-green-100 text-green-800',
            'veterinario': 'bg-purple-100 text-purple-800',
            'proprietario': 'bg-yellow-100 text-yellow-800'
        }[user.role] || 'bg-gray-100 text-gray-800';
        
        // Definir cores inline para garantir que sejam aplicadas
        const roleColorInline = {
            'gerente': 'background-color: #dbeafe !important; color: #1e40af !important;',
            'funcionario': 'background-color: #dcfce7 !important; color: #166534 !important;',
            'veterinario': 'background-color: #f3e8ff !important; color: #7c3aed !important;',
            'proprietario': 'background-color: #fef3c7 !important; color: #d97706 !important;'
        }[user.role] || 'background-color: #f1f5f9 !important; color: #64748b !important;';
        
        const statusColor = user.is_active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
        const statusText = user.is_active ? 'Ativo' : 'Inativo';
        
        const showPhoto = user.profile_photo_url && user.profile_photo_url.trim() !== '';
        
        return `
            <div class="user-card">
                <div class="user-card-header">
                    <div class="user-info">
                        <div class="user-avatar relative">
                            ${showPhoto ? 
                                `<img id="user-photo-${user.id}" src="${user.profile_photo_url}?t=${Date.now()}" alt="Foto de ${user.name}" class="w-full h-full object-cover rounded-full" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" onload="this.nextElementSibling.style.display='none';">
                                <div id="user-icon-${user.id}" class="w-full h-full bg-gradient-to-br from-forest-500 to-forest-600 flex items-center justify-center absolute inset-0 rounded-full" style="display: flex;">
                                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                    </svg>
                                </div>` :
                                `<div id="user-icon-${user.id}" class="w-full h-full bg-gradient-to-br from-forest-500 to-forest-600 flex items-center justify-center rounded-full">
                                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                    </svg>
                                </div>`
                            }
                        </div>
                        <div class="user-details">
                            <div class="user-name">
                                ${user.name}
                                ${isSecondaryAccount ? '<span class="ml-2 text-orange-600"><svg class="w-4 h-4 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg></span>' : ''}
                            </div>
                            <div class="user-email">${user.email}</div>
                            <div class="user-phone">${user.whatsapp || 'WhatsApp não informado'}</div>
                        </div>
                    </div>
                    <div class="user-status">
                        <span class="status-badge role" style="${roleColorInline}">${roleText}</span>
                        <span class="status-badge active ${statusColor}">${statusText}</span>
                        ${isSecondaryAccount ? '<span class="status-badge secondary" style="background-color: #fed7aa !important; color: #ea580c !important;"><svg class="w-3 h-3 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>Conta Secundária</span>' : ''}
                    </div>
                </div>
                <div class="user-card-footer">
                    <div class="user-created">Criado em: ${new Date(user.created_at).toLocaleDateString('pt-BR')}</div>
                    <div class="user-actions">
                        <button onclick="editUser('${user.id}');" class="action-button edit" title="Editar usuário">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                            </svg>
                        </button>
                        ${user.role !== 'gerente' ? `
                        <button onclick="toggleUserAccess('${user.id}', '${user.is_active}');" class="action-button permissions ${!user.is_active ? 'blocked' : ''}" title="${user.is_active ? 'Bloquear acesso' : 'Desbloquear acesso'}" data-user-id="${user.id}" data-current-status="${user.is_active}">
                            ${user.is_active ? 
                                '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2z"></path></svg>' :
                                '<svg class="w-4 h-4 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 11V7a4 4 0 018 0m-4 8v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2z"></path></svg>'
                            }
                        </button>
                        ` : ''}
                        ${user.role !== 'gerente' ? `
                        <button onclick="deleteUser('${user.id}', '${user.name}');" class="action-button delete" title="Excluir usuário">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                        </button>
                        ` : ''}
                    </div>
                </div>
            </div>
        `;
    }).join('');
    
    usersList.innerHTML = usersHtml;
}

// Function to edit user
async function editUser(userId) {
    try {
        // // const supabase = await getSupabaseClient(); // REMOVIDO // REMOVIDO - usando MySQL
        // Buscar dados do funcionário pelo ID selecionado
        const { data: user, error } = await supabase
            .from('users')
            .select('*')
            .eq('id', userId)
            .single();
        if (error) throw error;
        // Sempre criar uma cópia do objeto
        const funcionario = { ...user };
        // Preencher campos do modal de edição
        document.getElementById('editUserId').value = funcionario.id;
        document.getElementById('editUserName').value = funcionario.name;
        document.getElementById('editUserEmail').value = funcionario.email;
        document.getElementById('editUserWhatsapp').value = funcionario.whatsapp || '';
        document.getElementById('editUserRole').value = funcionario.role;
        // Atualizar preview da foto baseado no role
        const editPreview = document.getElementById('editProfilePreview');
        const editPlaceholder = document.getElementById('editProfilePlaceholder');
        const photoSection = document.getElementById('editPhotoSection');
        
        if (photoSection) {
            if (funcionario.role === 'funcionario') {
                photoSection.classList.remove('hidden');
                
                if (funcionario.profile_photo_url && editPreview && editPlaceholder) {
                    const uniqueTimestamp = Date.now() + '_' + funcionario.id + '_' + Math.random().toString(36).substr(2, 9);
                    editPreview.src = funcionario.profile_photo_url + '?t=' + uniqueTimestamp;
                    editPreview.classList.remove('hidden');
                    editPlaceholder.classList.add('hidden');
                } else if (editPreview && editPlaceholder) {
                    editPreview.classList.add('hidden');
                    editPlaceholder.classList.remove('hidden');
                    editPreview.src = '';
                }
            } else {
                photoSection.classList.add('hidden');
            }
        }
        openEditUserModal();
    } catch (error) {
        console.error('Error loading user data:', error);
        showNotification('Erro ao carregar dados do usuário', 'error');
    }
}

// Function to toggle user access
async function toggleUserAccess(userId, currentStatus) {
    try {
        // // const supabase = await getSupabaseClient(); // REMOVIDO // REMOVIDO - usando MySQL
        
        // Validate inputs
        if (!userId) {
            throw new Error('User ID is required');
        }
        
        const newStatus = !currentStatus;
        const action = newStatus ? 'desbloqueado' : 'bloqueado';
        
        // First, let's check if the user exists and get current data
        const { data: currentUser, error: fetchError } = await supabase
            .from('users')
            .select('*')
            .eq('id', userId)
            .single();
            
        if (fetchError) {
            throw new Error('Usuário não encontrado');
        }
        
        // Now update the user status
        const { data, error } = await supabase
            .from('users')
            .update({ is_active: newStatus })
            .eq('id', userId)
            .select();
            
        if (error) {
            throw error;
        }
        
        showNotification(`Acesso do usuário ${action} com sucesso!`, 'success');
        
        // Reload users list with a small delay to ensure the update is processed
        setTimeout(async () => {
            await loadUsersData();
        }, 500);
        
    } catch (error) {
        showNotification('Erro ao alterar acesso do usuário: ' + (error.message || error), 'error');
    }
}

// Test function for debugging user blocking
async function testUserBlocking() {
    try {

        
        // // const supabase = await getSupabaseClient(); // REMOVIDO // REMOVIDO - usando MySQL
        // Get current user data
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) {
            console.error('No authenticated user');
            return;
        }

        

        // Get farm users
        const { data: usersData, error } = await supabase
            .from('users')
            .select('*')
            .eq('id', user.id)
            .single();
            
        if (error) {
            console.error('Error fetching current user data:', error);
            return;
        }
        

        
        // Get all users from the same farm
        const { data: farmUsers, error: farmUsersError } = await supabase
            .from('users')
            .select('*')
            .eq('farm_id', usersData.farm_id);
            
        if (farmUsersError) {
            console.error('Error fetching farm users:', farmUsersError);
            return;
        }
        

        
        // Test blocking the first non-manager user
        const testUser = farmUsers.find(u => u.role !== 'gerente' && u.id !== usersData.id);
        
        if (testUser) {

            await toggleUserAccess(testUser.id, testUser.is_active);
        } else {
    
        }
        
    } catch (error) {
        console.error('Test error:', error);
    }
}

// Make test function available globally
window.testUserBlocking = testUserBlocking;

// Variável para armazenar dados do usuário a ser excluído
let userToDelete = null;

// Function to delete user com modal estilizado
function deleteUser(userId, userName) {
    // Verificar se os parâmetros são válidos
    if (!userId || !userName) {
        console.error('deleteUser: Parâmetros inválidos', { userId, userName });
        return;
    }
    
    // Armazenar dados do usuário para exclusão
    userToDelete = { id: userId, name: userName };
    
    // Mostrar modal de confirmação
    showDeleteConfirmationModal(userName);
}

// Função para executar a exclusão
async function executeDeleteUser(userId, userName) {
    try {
        // // const supabase = await getSupabaseClient(); // REMOVIDO // REMOVIDO - usando MySQL
        
        // Primeiro, buscar dados completos do usuário antes de excluir
        const { data: userData, error: fetchError } = await supabase
            .from('users')
            .select('*')
            .eq('id', userId)
            .single();
            
        if (fetchError) {
            showNotification('Erro ao buscar dados do usuário: ' + fetchError.message, 'error');
            return;
        }
        
        // Armazenar dados completos para possível restauração
        userToDelete = {
            id: userData.id,
            name: userData.name,
            email: userData.email,
            whatsapp: userData.whatsapp,
            role: userData.role,
            farm_id: userData.farm_id,
            profile_photo_url: userData.profile_photo_url,
            is_active: userData.is_active,
            created_at: userData.created_at
        };
        
        // Agora excluir o usuário
        const { data, error } = await supabase
            .from('users')
            .delete()
            .eq('id', userId);
            
        if (error) {
            showNotification('Erro ao excluir usuário: ' + error.message, 'error');
            return;
        }
        
        showNotification(`Usuário "${userName}" excluído com sucesso!`, 'success');
        await loadUsersData(); // Reload users list
        
    } catch (error) {
        showNotification('Erro ao excluir usuário: ' + error.message, 'error');
    }
}

// Modal de confirmação de exclusão
function showDeleteConfirmationModal(userName) {
    // Criar modal dinamicamente
    const modalHTML = `
        <div id="deleteConfirmationModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4 transform transition-all duration-300 scale-95 opacity-0" id="deleteModalContent">
                <div class="text-center">
                    <!-- Ícone de aviso -->
                    <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-6">
                        <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                        </svg>
                    </div>
                    
                    <!-- Título -->
                    <h3 class="text-xl font-bold text-gray-900 mb-4">Confirmar Exclusão</h3>
                    
                    <!-- Mensagem -->
                    <p class="text-gray-600 mb-6">
                        Tem certeza que deseja excluir o usuário <strong>"${userName}"</strong>?
                    </p>
                    
                    <!-- Botões -->
                    <div class="flex space-x-3">
                        <button onclick="cancelDelete()" class="flex-1 px-4 py-3 border border-gray-300 text-gray-700 font-semibold rounded-xl hover:bg-gray-50 transition-all">
                            Cancelar
                        </button>
                        <button onclick="confirmDelete()" class="flex-1 px-4 py-3 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-xl transition-all">
                            Excluir
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Adicionar modal ao DOM
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    // Animar entrada do modal
    setTimeout(() => {
        const modalContent = document.getElementById('deleteModalContent');
        modalContent.classList.remove('scale-95', 'opacity-0');
        modalContent.classList.add('scale-100', 'opacity-100');
    }, 10);
}

// Função para iniciar timer de desfazer
function startUndoTimer() {
    let timeLeft = 3;
    const timerElement = document.getElementById('undoTimer');
    
    const timer = setInterval(() => {
        timeLeft--;
        if (timerElement) {
            timerElement.textContent = timeLeft;
        }
        
        if (timeLeft <= 0) {
            clearInterval(timer);
            closeUndoModal();
        }
    }, 1000);
    
    // Armazenar timer para poder cancelar
    window.undoTimer = timer;
}

// Função para desfazer exclusão
async function undoDelete() {
    // Limpar timer
    if (window.undoTimer) {
        clearInterval(window.undoTimer);
        window.undoTimer = null;
    }
    
    if (userToDelete) {
        try {
            // // const supabase = await getSupabaseClient(); // REMOVIDO // REMOVIDO - usando MySQL
            
            // Restaurar usuário usando RPC
            const { data: result, error } = await supabase.rpc('restore_deleted_user', {
                p_user_id: userToDelete.id,
                p_name: userToDelete.name,
                p_email: userToDelete.email,
                p_whatsapp: userToDelete.whatsapp,
                p_role: userToDelete.role,
                p_farm_id: userToDelete.farm_id,
                p_profile_photo_url: userToDelete.profile_photo_url
            });
            
            if (error) {
                throw error;
            }
            
            if (result.success) {
                showNotification(`Usuário "${userToDelete.name}" restaurado com sucesso!`, 'success');
                
                // Recarregar lista de usuários
                setTimeout(() => {
                    loadUsersData();
                }, 500);
            } else {
                throw new Error(result.error || 'Falha ao restaurar usuário');
            }
            
        } catch (error) {
            console.error('Erro ao desfazer exclusão:', error);
            showNotification('Erro ao desfazer exclusão: ' + error.message, 'error');
        }
    }
    
    // Fechar modal
    closeUndoModal();
    
    // Limpar dados do usuário
    userToDelete = null;
}

// Função para fechar modal de desfazer
function closeUndoModal() {
    const modal = document.getElementById('undoModal');
    if (modal) {
        const modalContent = document.getElementById('undoModalContent');
        modalContent.classList.add('scale-95', 'opacity-0');
        
        setTimeout(() => {
            modal.remove();
        }, 300);
    }
    
    // Limpar dados do usuário
    userToDelete = null;
}

// Função para cancelar exclusão
function cancelDelete() {
    // Fechar modal
    closeDeleteConfirmationModal();
    
    // Limpar dados do usuário
    userToDelete = null;
}

// Função para confirmar exclusão
function confirmDelete() {
    // Executar exclusão imediatamente
    if (userToDelete) {
        executeDeleteUser(userToDelete.id, userToDelete.name);
    }
    
    // Fechar modal de confirmação
    closeDeleteConfirmationModal();
    
    // Mostrar modal de desfazer com timer
    showUndoModal();
}

// Modal para desfazer exclusão
function showUndoModal() {
    const modalHTML = `
        <div id="undoModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4 transform transition-all duration-300 scale-95 opacity-0" id="undoModalContent">
                <div class="text-center">
                    <!-- Ícone de sucesso -->
                    <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6">
                        <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"></path>
                        </svg>
                    </div>
                    
                    <!-- Título -->
                    <h3 class="text-xl font-bold text-gray-900 mb-4">Usuário Excluído</h3>
                    
                    <!-- Mensagem -->
                    <p class="text-gray-600 mb-6">
                        O usuário <strong>"${userToDelete?.name}"</strong> foi excluído com sucesso!
                    </p>
                    
                    <!-- Timer para desfazer -->
                    <div class="mb-6">
                        <div class="text-sm text-gray-500 mb-2">Tempo para desfazer:</div>
                        <div class="flex items-center justify-center space-x-2">
                            <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                                <span id="undoTimer" class="text-blue-600 font-bold text-lg">3</span>
                            </div>
                            <span class="text-gray-500">segundos</span>
                        </div>
                    </div>
                    
                    <!-- Botão para desfazer -->
                    <button onclick="undoDelete()" class="w-full px-4 py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-xl transition-all">
                        Desfazer Exclusão
                    </button>
                </div>
            </div>
        </div>
    `;
    
    // Adicionar modal ao DOM
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    // Animar entrada do modal
    setTimeout(() => {
        const modalContent = document.getElementById('undoModalContent');
        modalContent.classList.remove('scale-95', 'opacity-0');
        modalContent.classList.add('scale-100', 'opacity-100');
    }, 10);
    
    // Iniciar timer de 3 segundos para desfazer
    startUndoTimer();
}

// Função para fechar modal de confirmação
function closeDeleteConfirmationModal() {
    const modal = document.getElementById('deleteConfirmationModal');
    if (modal) {
        const modalContent = document.getElementById('deleteModalContent');
        modalContent.classList.add('scale-95', 'opacity-0');
        
        setTimeout(() => {
            modal.remove();
        }, 300);
    }
}

// Adicionar listener para fechar modal com ESC
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        cancelDelete();
    }
});
// Function to handle edit user form submission
async function handleEditUser(e) {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const userId = formData.get('id'); // Corrigido para 'id' conforme o input hidden
    const name = formData.get('name');
    const whatsapp = formData.get('whatsapp');
    const role = formData.get('role');
    const password = formData.get('password');
    
    try {
        // Preparar dados para atualização
        const updateData = {
            name: name,
            whatsapp: whatsapp || null,
            role: role
        };
        
        // Nota: Senhas são gerenciadas pelo Supabase Auth, não pela tabela users
        // Se uma nova senha foi fornecida, ela deve ser atualizada via supabase.auth.updateUser
        if (password && password.trim() !== '') {
            // TODO: Implementar atualização de senha via Supabase Auth se necessário

        }
        
        // Handle profile photo upload if provided and role is funcionario
        if (role === 'funcionario') {
            const profilePhotoFile = formData.get('profilePhoto');
            if (profilePhotoFile && profilePhotoFile.size > 0) {
                try {
                    const profilePhotoUrl = await uploadProfilePhoto(profilePhotoFile, userId);
                    updateData.profile_photo_url = profilePhotoUrl;
                } catch (photoError) {
                    console.error('Error uploading profile photo:', photoError);
                    // Don't show error notification for photo upload - user update is more important
                    // showNotification('Erro ao fazer upload da foto de perfil, mas outros dados serão atualizados', 'warning');
                }
            }
        } else {
            updateData.profile_photo_url = null;
        }
        
        // // const supabase = await getSupabaseClient(); // REMOVIDO // REMOVIDO - usando MySQL
        const { error } = await supabase
            .from('users')
            .update(updateData)
            .eq('id', userId);
            
        if (error) throw error;
        
        showNotification('Usuário atualizado com sucesso!', 'success');
        closeEditUserModal();
        
        // Update users list without reloading photos to prevent conflicts
        setTimeout(async () => {
            await refreshUsersListOnly();
        }, 500);
        
        // Atualizar foto na lista se foi alterada
        if (updateData.profile_photo_url) {
            setTimeout(async () => {
                await updateUserPhotoInList(userId, updateData.profile_photo_url);
            }, 600);
        }
        
    } catch (error) {
        console.error('Error updating user:', error);
        showNotification('Erro ao atualizar usuário', 'error');
    }
}

// Function to open edit user modal
function openEditUserModal() {
    document.getElementById('editUserModal').classList.add('show');
}

// Function to close edit user modal
function closeEditUserModal() {
    document.getElementById('editUserModal').classList.remove('show');
    document.getElementById('editUserForm').reset();
}

// Função para preview de foto no add user
function previewProfilePhoto(input) {
    
    let file = null;
    
    // Verificar se é um input com files ou um arquivo direto
    if (input.files && input.files[0]) {
        file = input.files[0];
    } else if (input instanceof File) {
        file = input;
    } else {
        return;
    }
    
    // Validar tamanho do arquivo (5MB máximo)
    if (file.size > 5 * 1024 * 1024) {
        showNotification('A foto deve ter no máximo 5MB', 'error');
        if (input.files) input.value = '';
        return;
    }
    
    // Validar tipo do arquivo
    if (!file.type.startsWith('image/')) {
        showNotification('Por favor, selecione apenas arquivos de imagem', 'error');
        if (input.files) input.value = '';
        return;
    }
    
        const reader = new FileReader();
        reader.onload = function(e) {
        const preview = document.getElementById('profilePreview');
        const placeholder = document.getElementById('profilePlaceholder');
        
        
        if (preview && placeholder) {
            preview.src = e.target.result;
            preview.style.display = 'block';
            preview.classList.remove('hidden');
            placeholder.style.display = 'none';
            placeholder.classList.add('hidden');
        } else {
            console.error('❌ Elementos de preview não encontrados');
        }
    };
    reader.readAsDataURL(file);
}

// Função para preview de foto no edit user
function previewEditProfilePhoto(input) {
    let file = null;
    
    // Verificar se é um input com files ou um arquivo direto
    if (input.files && input.files[0]) {
        file = input.files[0];
    } else if (input instanceof File) {
        file = input;
    } else {
        return;
    }
    
    // Validar tamanho do arquivo (5MB máximo)
    if (file.size > 5 * 1024 * 1024) {
        showNotification('A foto deve ter no máximo 5MB', 'error');
        if (input.files) input.value = '';
        return;
    }
    
    // Validar tipo do arquivo
    if (!file.type.startsWith('image/')) {
        showNotification('Por favor, selecione apenas arquivos de imagem', 'error');
        if (input.files) input.value = '';
        return;
    }
    
        const reader = new FileReader();
        reader.onload = function(e) {
        const preview = document.getElementById('editProfilePreview');
        const placeholder = document.getElementById('editProfilePlaceholder');
        
        if (preview && placeholder) {
            preview.src = e.target.result;
            preview.style.display = 'block';
            preview.classList.remove('hidden');
            placeholder.style.display = 'none';
            placeholder.classList.add('hidden');
        }
    };
    reader.readAsDataURL(file);
}



// Variáveis globais para câmera
let currentPhotoMode = '';





// Funções da Câmera - REFORMULADAS
let cameraStream = null;
let isCameraOpen = false;

async function openCamera() {
    
    // Verificar se já está aberta
    if (isCameraOpen) {
        return;
    }
    
    try {
        const modal = document.getElementById('cameraModal');
        const video = document.getElementById('cameraVideo');
        const processingScreen = document.getElementById('photoProcessingScreen');
        
        if (!modal || !video) {
            console.error('❌ Modal ou vídeo não encontrado');
            return;
        }
        
        
        // Fechar modal de escolha de foto
        closePhotoChoiceModal();
        
        // Garantir que a tela de processamento esteja oculta
        if (processingScreen) {
            processingScreen.classList.add('hidden');
            processingScreen.style.display = 'none';
            processingScreen.style.visibility = 'hidden';
            processingScreen.style.opacity = '0';
            processingScreen.style.pointerEvents = 'none';
        }
        
        // Abrir modal da câmera
    modal.classList.remove('hidden');
        modal.style.display = 'flex';
        isCameraOpen = true;
        
        
        // Resetar estado da verificação facial
        resetFaceVerification();
        
        // Iniciar câmera (funciona no desktop também)
        const stream = await navigator.mediaDevices.getUserMedia({ 
            video: { 
                facingMode: 'user',
                width: { ideal: 1280 },
                height: { ideal: 720 }
            } 
        });
        
        
        cameraStream = stream;
        video.srcObject = stream;
        
        
    } catch (error) {
        console.error('❌ Erro ao acessar câmera:', error);
        showNotification('Não foi possível acessar a câmera. Verifique as permissões.', 'error');
        closeCamera();
    }
}

function closeCamera() {
    
    const modal = document.getElementById('cameraModal');
    
    if (!modal) {
        console.error('❌ Modal não encontrado');
        return;
    }
    
    // Parar stream da câmera
    if (cameraStream) {
        cameraStream.getTracks().forEach(track => track.stop());
        cameraStream = null;
    }
    
    // Fechar modal
        modal.classList.add('hidden');
    modal.style.display = 'none';
    isCameraOpen = false;
    
    // Limpar currentPhotoMode apenas agora
    currentPhotoMode = '';
    
}

async function switchCamera() {
    
    if (!cameraStream) {
        console.error('❌ Nenhum stream ativo');
        return;
    }
    
    try {
        const video = document.getElementById('cameraVideo');
        const currentFacingMode = cameraStream.getVideoTracks()[0]?.getSettings().facingMode;
        const newFacingMode = currentFacingMode === 'user' ? 'environment' : 'user';
        
        
        // Parar stream atual
        cameraStream.getTracks().forEach(track => track.stop());
        
        // Iniciar nova câmera
        const newStream = await navigator.mediaDevices.getUserMedia({ 
            video: { 
                facingMode: newFacingMode,
                width: { ideal: 1280 },
                height: { ideal: 720 }
            } 
        });
        
        cameraStream = newStream;
        video.srcObject = newStream;
        
        
    } catch (error) {
        console.error('❌ Erro ao trocar câmera:', error);
    }
}

// Função para resetar verificação facial
function resetFaceVerification() {
    const focusText = document.getElementById('focusText');
    const focusTimer = document.getElementById('focusTimer');
    const focusIndicator = document.getElementById('focusIndicator');
    const captureBtn = document.getElementById('captureBtn');
    
    if (focusText) focusText.textContent = 'Posicione o rosto no centro';
    if (focusTimer) focusTimer.classList.add('hidden');
    if (focusIndicator) {
        focusIndicator.classList.add('opacity-0');
        focusIndicator.classList.remove('focus-success');
    }
    if (captureBtn) {
        captureBtn.disabled = false;
        captureBtn.style.opacity = '1';
    }
}

// Função para iniciar verificação facial
function startFaceVerification() {
    
    const focusText = document.getElementById('focusText');
    const focusTimer = document.getElementById('focusTimer');
    const timerCount = document.getElementById('timerCount');
    const focusIndicator = document.getElementById('focusIndicator');
    const captureBtn = document.getElementById('captureBtn');
    
    if (!focusText || !focusTimer || !timerCount || !focusIndicator || !captureBtn) {
        console.error('❌ Elementos de foco não encontrados');
        return;
    }
    
    // Desabilitar botão durante verificação
    captureBtn.disabled = true;
    captureBtn.style.opacity = '0.5';
    
    // Mostrar timer
    focusText.textContent = 'Mantenha o rosto no centro';
    focusTimer.classList.remove('hidden');
    
    // Timer de 3 segundos
    let countdown = 3;
    timerCount.textContent = countdown;
    
    const timer = setInterval(() => {
        countdown--;
        timerCount.textContent = countdown;
        
        if (countdown <= 0) {
            clearInterval(timer);
            
            // Mostrar indicador de foco
            focusIndicator.classList.remove('opacity-0');
            focusIndicator.classList.add('focus-success');
            
            // Capturar foto após 0.5s
            setTimeout(() => {
                capturePhoto();
            }, 500);
        }
    }, 1000);
}

function capturePhoto() {
    
    const video = document.getElementById('cameraVideo');
    const canvas = document.getElementById('cameraCanvas');
    
    if (!video || !canvas) {
        console.error('❌ Vídeo ou canvas não encontrado');
        return;
    }
    
    const context = canvas.getContext('2d');
    canvas.width = video.videoWidth || 640;
    canvas.height = video.videoHeight || 480;
    
    try {
        // Desenhar frame do vídeo no canvas
        context.drawImage(video, 0, 0, canvas.width, canvas.height);
        
        // Converter para blob e processar
        canvas.toBlob((blob) => {
            if (!blob) {
                console.error('❌ Erro ao criar blob');
                return;
            }
            
            
            // Criar URL da imagem
            const imageUrl = URL.createObjectURL(blob);
            
            // Mostrar preview diretamente
            if (currentPhotoMode === 'add') {
                const preview = document.getElementById('profilePreview');
                const placeholder = document.getElementById('profilePlaceholder');
                
                
                if (preview && placeholder) {
                    preview.src = imageUrl;
                    preview.style.display = 'block';
                    preview.classList.remove('hidden');
                    placeholder.style.display = 'none';
                    placeholder.classList.add('hidden');
    } else {
                    console.error('❌ Elementos de preview não encontrados para novo usuário');
                }
            } else if (currentPhotoMode === 'edit') {
                const preview = document.getElementById('editProfilePreview');
                const placeholder = document.getElementById('editProfilePlaceholder');
                
                
                if (preview && placeholder) {
                    preview.src = imageUrl;
                    preview.style.display = 'block';
                    preview.classList.remove('hidden');
                    placeholder.style.display = 'none';
                    placeholder.classList.add('hidden');
                } else {
                    console.error('❌ Elementos de preview não encontrados para edição');
                }
            } else {
                console.error('❌ currentPhotoMode inválido:', currentPhotoMode);
            }
            
            // Fechar câmera
            closeCamera();
            
        }, 'image/jpeg', 0.8);
        
    } catch (error) {
        console.error('❌ Erro ao capturar foto:', error);
        closeCamera();
    }
}

// Função para abrir galeria
function openGallery() {
    const inputId = currentPhotoMode === 'add' ? 'profilePhotoInput' : 'editProfilePhoto';
    const input = document.getElementById(inputId);
    
    if (input) {
        input.removeAttribute('capture');
    input.click();
    }
    
    closePhotoChoiceModal();
}

// Funções para adicionar foto
function addPhotoToNewUser() {
    openPhotoChoiceModal('add');
}

function addPhotoToEditUser() {
    openPhotoChoiceModal('edit');
}

// Funções do novo modal de foto
function openPhotoChoiceModal(mode) {
    currentPhotoMode = mode;
    
    const modal = document.getElementById('photoChoiceModal');
    
    if (modal) {
        
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        modal.style.display = 'flex';
        modal.style.visibility = 'visible';
        modal.style.opacity = '1';
        modal.style.pointerEvents = 'auto';
        
        // Verificar se realmente está visível
        setTimeout(() => {
            const rect = modal.getBoundingClientRect();
        }, 100);
    } else {
        console.error('❌ Modal não encontrado');
    }
}

function closePhotoChoiceModal() {
    const modal = document.getElementById('photoChoiceModal');
    if (modal) {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
        modal.style.display = 'none';
        modal.style.visibility = 'hidden';
        modal.style.opacity = '0';
        modal.style.pointerEvents = 'none';
        // NÃO limpar currentPhotoMode aqui, pois precisamos dele na câmera
        console.log('✅ Modal fechado, currentPhotoMode mantido:', currentPhotoMode);
    }
}

function selectFromGallery() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*';
    input.onchange = function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                if (currentPhotoMode === 'add') {
                    processPhotoForNewUser(e.target.result);
                } else if (currentPhotoMode === 'edit') {
                    processPhotoForEditUser(e.target.result);
                }
                closePhotoChoiceModal();
            };
            reader.readAsDataURL(file);
        }
    };
    input.click();
}

function processPhotoForNewUser(photoData) {
    // Simular o input file para o novo usuário
    const input = document.getElementById('profilePhotoInput');
    if (input) {
        // Criar um arquivo a partir da foto
        fetch(photoData)
            .then(res => res.blob())
            .then(blob => {
                const file = new File([blob], 'photo.jpg', { type: 'image/jpeg' });
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(file);
                input.files = dataTransfer.files;
                
                // Disparar evento change
                const event = new Event('change', { bubbles: true });
                input.dispatchEvent(event);
            });
    }
}

function processPhotoForEditUser(photoData) {
    // Simular o input file para edição de usuário
    const input = document.getElementById('editProfilePhoto');
    if (input) {
        // Criar um arquivo a partir da foto
        fetch(photoData)
            .then(res => res.blob())
            .then(blob => {
                const file = new File([blob], 'photo.jpg', { type: 'image/jpeg' });
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(file);
                input.files = dataTransfer.files;
                
                // Disparar evento change
                const event = new Event('change', { bubbles: true });
                input.dispatchEvent(event);
            });
    }
}

function takePhoto() {
    console.log('📸 takePhoto chamado, currentPhotoMode:', currentPhotoMode);
    closePhotoChoiceModal();
    openCamera();
}

// Setup event listeners
function setupEventListeners() {
    console.log('🔧 Configurando event listeners...');
    
    // Função para limpar listeners existentes
    function clearExistingListeners(element, eventType, handler) {
        if (element) {
            element.removeEventListener(eventType, handler);
        }
    }
    // Listener para role no add user
    const userRoleSelect = document.getElementById('userRole');
    if (userRoleSelect) {
        userRoleSelect.addEventListener('change', function() {
            const addPhotoSection = document.getElementById('addPhotoSection');
            console.log('🔍 Role selecionado:', this.value);
            console.log('🔍 Seção de foto:', addPhotoSection ? 'encontrada' : 'não encontrada');
            
            if (this.value === 'funcionario') {
                addPhotoSection.classList.remove('hidden');
                console.log('✅ Seção de foto mostrada');
            } else {
                addPhotoSection.classList.add('hidden');
                console.log('✅ Seção de foto ocultada');
            }
        });
    }
    
    // Listener para role no edit user
    const editUserRoleSelect = document.getElementById('editUserRole');
    if (editUserRoleSelect) {
        editUserRoleSelect.addEventListener('change', function() {
            const editPhotoSection = document.getElementById('editPhotoSection');
            if (this.value === 'funcionario') {
                editPhotoSection.classList.remove('hidden');
            } else {
                editPhotoSection.classList.add('hidden');
            }
        });
    }
    
    // Tab switching for both desktop and mobile
    const navItems = document.querySelectorAll('.nav-item, .mobile-nav-item');
    
    navItems.forEach(item => {
        item.addEventListener('click', function(e) {
            e.preventDefault();
            const targetTab = this.getAttribute('data-tab');
            
            if (targetTab) {
                // Remove active class from all nav items
                navItems.forEach(nav => nav.classList.remove('active'));
                
                // Add active class to clicked item
                this.classList.add('active');
                
                // Hide all tab contents
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.add('hidden');
                });
                
                // Show target tab content
                const targetContent = document.getElementById(targetTab + '-tab');
                if (targetContent) {
                    targetContent.classList.remove('hidden');
                }
            }
        });
    });

    // Form submissions (password form removed - now uses separate page)

    // Add user form submission
    const addUserForm = document.getElementById('addUserFormModal');
    if (addUserForm) {
        console.log('🔍 Formulário encontrado, adicionando listener');
        clearExistingListeners(addUserForm, 'submit', handleAddUser);
        addUserForm.addEventListener('submit', handleAddUser);
    } else {
        console.error('❌ Formulário addUserFormModal não encontrado!');
    }
        


    // Update profile form submission
    const updateProfileForm = document.getElementById('updateProfileForm');
    if (updateProfileForm) {
        clearExistingListeners(updateProfileForm, 'submit', handleUpdateProfile);
        updateProfileForm.addEventListener('submit', handleUpdateProfile);
    }

    // Edit user form submission
    const editUserForm = document.getElementById('editUserForm');
    if (editUserForm) {
        clearExistingListeners(editUserForm, 'submit', handleEditUser);
        editUserForm.addEventListener('submit', handleEditUser);
    }

    // Email preview update
    const userNameInput = document.getElementById('userName');
    if (userNameInput) {
        userNameInput.addEventListener('input', function() {
            updateEmailPreview(this.value);
        });
    }
}

// Password change now handled in separate page (alterar-senha.html)

// Global chart instances
let qualityTrendChart = null;
let qualityDistributionChart = null;

// Load volume records table
async function loadVolumeRecords() {
    try {
        // // const supabase = await getSupabaseClient(); // REMOVIDO // REMOVIDO - usando MySQL
        
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) throw new Error('User not authenticated');

        const { data: userData, error: userError } = await supabase
            .from('users')
            .select('farm_id')
            .eq('id', user.id)
            .single();
        
        if (userError) {
            throw userError;
        }

        // Get volume records data - buscar dados mais recentes primeiro
        const { data: volumeRecords, error } = await supabase
            .from('volume_records')
            .select(`
                *,
                users(name)
            `)
            .eq('farm_id', userData.farm_id)
            .order('created_at', { ascending: false })
            .limit(20);

        if (error) {
        }

        displayVolumeRecords(volumeRecords || []);
        
    } catch (error) {
        console.error('Error loading volume records:', error);
        displayVolumeRecords([]);
    }
}
// Display volume records in table
function displayVolumeRecords(records) {
    const tbody = document.getElementById('volumeRecords');
    
    if (!records || records.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="5" class="px-6 py-12 text-center text-gray-500">
                    <div class="flex flex-col items-center">
                        <svg class="w-12 h-12 text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        <p class="text-lg font-medium mb-2">Nenhum registro de volume encontrado</p>
                        <p class="text-sm">Adicione registros de produção para monitorar o volume</p>
                    </div>
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = records.map(record => {
        // Corrigir data - adicionar timezone para evitar problema de 1 dia
        const recordDate = new Date(record.production_date + 'T00:00:00').toLocaleDateString('pt-BR');
        const recordTime = new Date(record.created_at).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
        const volume = record.volume_liters ? `${record.volume_liters.toFixed(1)}L` : '--';
        // Obter nome do funcionário via relacionamento
        const userName = record.users?.name || record.user_name || 'N/A';
        const notes = record.notes || '-';
        
        return `
            <tr class="hover:bg-gray-50">
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${recordDate} ${recordTime}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${volume}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${userName}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${notes}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm">
                    <button onclick="deleteVolumeRecord('${record.id}');" class="text-red-600 hover:text-red-800 font-medium">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                    </button>
                </td>
            </tr>
        `;
    }).join('');
}

// Load quality tests table
async function loadQualityTests() {
    try {
        // // const supabase = await getSupabaseClient(); // REMOVIDO // REMOVIDO - usando MySQL
        
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) throw new Error('User not authenticated');

        const { data: qualityUserData, error: userError } = await supabase
            .from('users')
            .select('farm_id')
            .eq('id', user.id)
            .single();
        
        if (userError) {
            throw userError;
        }

        // Get quality tests data
        const { data: qualityTests, error } = await supabase
            .from('quality_tests')
            .select('*')
            .eq('farm_id', qualityUserData.farm_id)
            .order('test_date', { ascending: false })
            .limit(20);

        if (error) {
        }

        displayQualityTests(qualityTests || []);
        
    } catch (error) {
        console.error('Error loading quality tests:', error);
        displayQualityTests([]);
    }
}

// Display quality tests in table
function displayQualityTests(tests) {
    const tbody = document.getElementById('qualityTests');
    
    if (!tests || tests.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="9" class="px-6 py-12 text-center text-gray-500">
                    <div class="flex flex-col items-center">
                        <svg class="w-12 h-12 text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        <p class="text-lg font-medium mb-2">Nenhum teste de qualidade encontrado</p>
                        <p class="text-sm">Adicione testes de qualidade para monitorar a qualidade do leite</p>
                    </div>
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = tests.map(test => {
        const testDate = new Date(test.test_date).toLocaleDateString('pt-BR');
        const fatPercentage = test.fat_percentage ? `${test.fat_percentage.toFixed(1)}%` : '--';
        const proteinPercentage = test.protein_percentage ? `${test.protein_percentage.toFixed(1)}%` : '--';
                        const sccCount = test.scc ? `${Math.round(test.scc / 1000)}k` : '--';
                        const tbcCount = test.cbt ? `${Math.round(test.cbt / 1000)}k` : '--';
        const laboratory = test.laboratory || '--';
        
        // Determine quality grade based on values
        let qualityGrade = 'A';
        let gradeColor = 'bg-green-100 text-green-800';
        
        if (test.fat_percentage < 3.0 || test.protein_percentage < 2.9 || 
                            (test.scc && test.scc > 400000) ||
                            (test.cbt && test.cbt > 100000)) {
            qualityGrade = 'C';
            gradeColor = 'bg-red-100 text-red-800';
        } else if (test.fat_percentage < 3.5 || test.protein_percentage < 3.2 ||
                   (test.scc && test.scc > 200000) ||
                   (test.cbt && test.cbt > 50000)) {
            qualityGrade = 'B';
            gradeColor = 'bg-yellow-100 text-yellow-800';
        }
        
        return `
            <tr class="hover:bg-gray-50">
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${testDate}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${fatPercentage}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${proteinPercentage}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${sccCount}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${tbcCount}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${laboratory}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 max-w-xs truncate" title="${test.observations || '--'}">${test.observations || '--'}</td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${gradeColor}">
                        Nota ${qualityGrade}
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm">
                    <button onclick="deleteQualityTest('${test.id}');" class="text-red-600 hover:text-red-800 font-medium">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                    </button>
                </td>
            </tr>
        `;
    }).join('');
}

// Delete volume record function
async function deleteVolumeRecord(recordId) {
    if (!confirm('Tem certeza que deseja excluir este registro de volume?')) {
        return;
    }
    
    try {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) {
            showNotification('Usuário não autenticado', 'error');
            return;
        }
        
        // Delete the record
        const { error } = await supabase
            .from('volume_records')
            .delete()
            .eq('id', recordId);
        
        if (error) {
            console.error('Error deleting volume record:', error);
            showNotification('Erro ao excluir registro: ' + error.message, 'error');
            return;
        }
        
        showNotification('Registro de volume excluído com sucesso!', 'success');
        
        // Reload data
        await loadVolumeData();
        await loadVolumeRecords();
        await loadWeeklyVolumeChart();
        await loadDailyVolumeChart();
        await loadDashboardWeeklyChart();
        await loadWeeklySummaryChart();
        await loadMonthlyVolumeChart();
        await loadQualityChart();
        await loadTemperatureChart();
        // Get user's farm_id for recent activities
        if (user) {
            const { data: userData } = await supabase
                .from('users')
                .select('farm_id')
                .eq('id', user.id)
                .single();
            
            if (userData?.farm_id) {
                await loadRecentActivities(userData.farm_id);
            }
        }
        
    } catch (error) {
        console.error('Error deleting volume record:', error);
        showNotification('Erro ao excluir registro: ' + error.message, 'error');
    }
}

// Delete quality test function
async function deleteQualityTest(testId) {
    if (!confirm('Tem certeza que deseja excluir este teste de qualidade?')) {
        return;
    }
    
    try {
        // // const supabase = await getSupabaseClient(); // REMOVIDO // REMOVIDO - usando MySQL
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) {
            showNotification('Usuário não autenticado', 'error');
            return;
        }
        
        // Delete the test
        const { error } = await supabase
            .from('quality_tests')
            .delete()
            .eq('id', testId);
        
        if (error) {
            console.error('Error deleting quality test:', error);
            showNotification('Erro ao excluir teste: ' + error.message, 'error');
            return;
        }
        
        showNotification('Teste de qualidade excluído com sucesso!', 'success');
        
        // Reload data
        await loadQualityData();
        await loadQualityTests();
        
    } catch (error) {
        console.error('Error deleting quality test:', error);
        showNotification('Erro ao excluir teste: ' + error.message, 'error');
    }
}

// Load quality chart data
async function loadQualityChart() {
    try {
        // // const supabase = await getSupabaseClient(); // REMOVIDO // REMOVIDO - usando MySQL
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) return;

        const { data: userProfile } = await supabase
            .from('users')
            .select('farm_id')
            .eq('id', user.id)
            .single();

        if (!userProfile?.farm_id) return;

        const { data: qualityData, error } = await supabase
            .from('quality_tests')
            .select('*')
            .eq('farm_id', userProfile.farm_id)
            .order('test_date', { ascending: false })
            .limit(7);

        if (error) {
            return;
        }

        if (window.qualityChart && qualityData && qualityData.length > 0) {
            const labels = qualityData.reverse().map(record => 
                new Date(record.test_date).toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' })
            );
            const qualityScores = qualityData.map(record => {
                // Calculate quality score based on fat and protein percentages
                const fatScore = Math.min((record.fat_percentage || 0) / 4 * 100, 100);
                const proteinScore = Math.min((record.protein_percentage || 0) / 3.5 * 100, 100);
                return Math.round((fatScore + proteinScore) / 2);
            });

            window.qualityChart.data.labels = labels;
            window.qualityChart.data.datasets[0].data = qualityScores;
            window.qualityChart.update();
        }
    } catch (error) {
        console.error('Error loading quality chart:', error);
    }
}

// Load temperature chart data
async function loadTemperatureChart() {
    try {
        console.log('🌡️ Iniciando carregamento do gráfico de temperatura...');
<<<<<<< HEAD
        
        // Wait for Chart.js to be available
        if (typeof Chart === 'undefined') {
            console.log('⏳ Aguardando Chart.js...');
            await new Promise(resolve => {
                const checkChart = () => {
                    if (typeof Chart !== 'undefined') {
                        resolve();
                    } else {
                        setTimeout(checkChart, 100);
                    }
                };
                checkChart();
            });
        }
        
        // Usar API de volume para dados de temperatura
        const response = await fetch('api/volume.php?action=select');
        const result = await response.json();
=======
        // // const supabase = await getSupabaseClient(); // REMOVIDO // REMOVIDO - usando MySQL
>>>>>>> parent of 0eb3d2f (.)
        
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) {
            console.log('❌ Usuário não autenticado');
            return;
        }

        const { data: userData } = await supabase
            .from('users')
            .select('farm_id')
            .eq('id', user.id)
            .single();

        if (!userData?.farm_id) {
            console.log('❌ Farm ID não encontrado');
            return;
        }
        
        console.log('✅ Usuário autenticado, farm_id:', userData.farm_id);


        
        // First, let's check if there are any records with temperature
        const { data: allRecords, error: checkError } = await supabase
            .from('volume_records')
            .select('production_date, temperature')
            .eq('farm_id', userData.farm_id);
            


        const { data: temperatureData, error } = await supabase
            .from('volume_records')
            .select('production_date, temperature')
            .eq('farm_id', userData.farm_id)
            .not('temperature', 'is', null)
            .order('production_date', { ascending: false })
            .limit(7);

        if (error) {
            console.error('❌ Erro ao carregar dados de temperatura:', error);
            return;
        }
        
        console.log('📊 Dados de temperatura encontrados:', temperatureData?.length || 0, 'registros');
        console.log('📊 Dados brutos:', temperatureData);

        
        if (window.temperatureChart) {
            if (temperatureData && temperatureData.length > 0) {
                // Restore canvas if it was replaced by message
                const chartContainer = document.querySelector('#temperatureChart').parentElement;
                if (chartContainer && !chartContainer.querySelector('canvas')) {
                    chartContainer.innerHTML = '<canvas id="temperatureChart"></canvas>';
                    // Reinitialize chart
                    const temperatureCtx = document.getElementById('temperatureChart');
                    if (temperatureCtx) {
                        window.temperatureChart = new Chart(temperatureCtx, {
                            type: 'line',
                            data: {
                                labels: [],
                                datasets: [{
                                    label: 'Temperatura (°C)',
                                    data: [],
                                    borderColor: '#f59e0b',
                                    backgroundColor: 'rgba(245, 158, 11, 0.1)',
                                    borderWidth: 3,
                                    pointRadius: 6,
                                    pointHoverRadius: 8,
                                    pointBackgroundColor: '#f59e0b',
                                    pointBorderColor: '#ffffff',
                                    pointBorderWidth: 2,
                                    tension: 0.4,
                                    fill: true,
                                    showLine: true
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                interaction: {
                                    intersect: false,
                                    mode: 'index'
                                },
                                plugins: {
                                    legend: {
                                        display: false
                                    },
                                    tooltip: {
                                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                        titleColor: 'white',
                                        bodyColor: 'white',
                                        borderColor: 'rgba(255, 255, 255, 0.1)',
                                        borderWidth: 1,
                                        callbacks: {
                                            label: function(context) {
                                                return 'Temperatura: ' + context.parsed.y + '°C';
                                            }
                                        }
                                    }
                                },
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        max: 10,
                                        grid: {
                                            color: 'rgba(0, 0, 0, 0.1)'
                                        },
                                        ticks: {
                                            callback: function(value) {
                                                return value + '°C';
                                            }
                                        }
                                    },
                                    x: {
                                        grid: {
                                            color: 'rgba(0, 0, 0, 0.1)'
                                        },
                                        ticks: {
                                            maxTicksLimit: 7, // Limitar número de ticks no eixo X
                                            callback: function(value, index, ticks) {
                                                // Garantir que não haja labels duplicados
                                                const label = this.getLabelForValue(value);
                                                return label;
                                            }
                                        }
                                    }
                                },
                                elements: {
                                    line: {
                                        tension: 0.4
                                    },
                                    point: {
                                        radius: 6,
                                        hoverRadius: 8
                                    }
                                },
                                animation: {
                                    duration: 1000,
                                    easing: 'easeInOutQuart'
                                }
                            }
                        });
                    }
                }
                
                // Processar dados de temperatura corretamente
                const labels = [];
                const temperatures = [];
                const processedDates = new Set(); // Para evitar datas duplicadas
                
                // Ordenar dados por data (mais antigo primeiro)
                const sortedData = temperatureData.sort((a, b) => 
                    new Date(a.production_date) - new Date(b.production_date)
                );
                
                sortedData.forEach(record => {
                    const dateStr = new Date(record.production_date).toLocaleDateString('pt-BR', { 
                        day: '2-digit', 
                        month: '2-digit' 
                    });
                    
                    // Evitar duplicatas
                    if (!processedDates.has(dateStr)) {
                        labels.push(dateStr);
                        temperatures.push(record.temperature || 0);
                        processedDates.add(dateStr);
                    }
                });
                
                console.log('📊 Dados de temperatura processados:', { labels, temperatures });

                window.temperatureChart.data.labels = labels;
                window.temperatureChart.data.datasets[0].data = temperatures;
                
                // Show success message

            } else {
    
                // Show message in chart area
                const chartContainer = document.querySelector('#temperatureChart').parentElement;

                if (chartContainer) {
                    const totalRecords = allRecords?.length || 0;
                    const recordsWithTemp = allRecords?.filter(r => r.temperature !== null).length || 0;
                    
                    chartContainer.innerHTML = `
                        <div class="flex flex-col items-center justify-center h-64 text-center">
                            <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mb-4">
                                <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                                </svg>
                            </div>
                            <h3 class="text-lg font-semibold text-gray-900 mb-2">Sem Dados de Temperatura</h3>
                            <p class="text-gray-500 text-sm">Nenhum registro com temperatura foi encontrado nos últimos 7 dias.</p>
                            <p class="text-gray-400 text-xs mt-1">
                                Total de registros: ${totalRecords} | Com temperatura: ${recordsWithTemp}
                            </p>
                            <p class="text-gray-400 text-xs mt-1">Os dados aparecerão aqui quando houver registros com temperatura.</p>
                        </div>
                    `;
                }
                
                // Clear chart when no data
                window.temperatureChart.data.labels = [];
                window.temperatureChart.data.datasets[0].data = [];
            }
            window.temperatureChart.update();
        } else {
            console.error('Temperature chart not initialized');
        }
    } catch (error) {
        console.error('Error loading temperature chart:', error);
    }
}

// Update quality charts with data
function updateQualityCharts(qualityData) {
    
    
    // Update trend chart
    if (qualityTrendChart) {
        try {
            const labels = qualityData.slice(0, 10).reverse().map(record => 
                new Date(record.test_date).toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' })
            );
            const fatData = qualityData.slice(0, 10).reverse().map(record => record.fat_percentage || 0);
            const proteinData = qualityData.slice(0, 10).reverse().map(record => record.protein_percentage || 0);
            
    
            
            qualityTrendChart.data.labels = labels;
            qualityTrendChart.data.datasets[0].data = fatData;
            qualityTrendChart.data.datasets[1].data = proteinData;
            qualityTrendChart.update();
            
    
        } catch (error) {
            console.error('Error updating trend chart:', error);
        }
    } else {
    }
    
    // Update distribution chart
    if (qualityDistributionChart && qualityData.length > 0) {
        const avgFat = qualityData.reduce((sum, record) => sum + (record.fat_percentage || 0), 0) / qualityData.length;
        const avgProtein = qualityData.reduce((sum, record) => sum + (record.protein_percentage || 0), 0) / qualityData.length;
                        const avgSCC = qualityData.reduce((sum, record) => sum + (record.scc || 0), 0) / qualityData.length;
        
        // Classify quality based on standards
        const fatQuality = avgFat >= 3.5 ? 'Excelente' : avgFat >= 3.0 ? 'Bom' : 'Regular';
        const proteinQuality = avgProtein >= 3.2 ? 'Excelente' : avgProtein >= 2.9 ? 'Bom' : 'Regular';
        const sccQuality = avgSCC <= 200000 ? 'Excelente' : avgSCC <= 400000 ? 'Bom' : 'Regular';
        
        const excellent = [fatQuality, proteinQuality, sccQuality].filter(q => q === 'Excelente').length;
        const good = [fatQuality, proteinQuality, sccQuality].filter(q => q === 'Bom').length;
        const regular = [fatQuality, proteinQuality, sccQuality].filter(q => q === 'Regular').length;
        
        qualityDistributionChart.data.labels = ['Excelente', 'Bom', 'Regular'];
        qualityDistributionChart.data.datasets[0].data = [excellent, good, regular];
        qualityDistributionChart.update();
    }
}

// Load recent activities
async function loadRecentActivities(farmId) {
    try {
        console.log('🔄 Carregando atividades recentes para fazenda:', farmId);
        
        // Aguardar Supabase estar disponível
        if (!window.supabase) {
            await new Promise(resolve => setTimeout(resolve, 1000));
            if (!window.supabase) {
                console.error('❌ Supabase não disponível para atividades recentes');
                return;
            }
        }
        
        // // const supabase = await getSupabaseClient(); // REMOVIDO // REMOVIDO - usando MySQL
        
        const { data: activities, error } = await supabase
            .from('volume_records')
            .select(`
                id,
                volume_liters,
                production_date,
                milking_type,
                created_at,
                users!inner(name)
            `)
            .eq('farm_id', farmId)
            .order('created_at', { ascending: false })
            .limit(5);

        if (error) {
            console.error('❌ Erro ao carregar atividades recentes:', error);
            return;
        }
        
        console.log('📊 Atividades encontradas:', activities?.length || 0);

        const activitiesContainer = document.getElementById('recentActivities');
        
        if (!activities || activities.length === 0) {
            console.log('ℹ️ Nenhuma atividade encontrada, mostrando mensagem padrão');
            activitiesContainer.innerHTML = `
                <div class="text-center py-8">
                    <div class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <p class="text-gray-500 text-sm">Nenhuma atividade recente</p>
                    <p class="text-gray-400 text-xs">Registros aparecerão aqui</p>
                </div>
            `;
            return;
        }
        
        console.log('✅ Renderizando atividades recentes...');

        activitiesContainer.innerHTML = activities.map(activity => {
            const timeAgo = getTimeAgoFromDate(new Date(activity.created_at));
            const userName = activity.users?.name || 'Usuário';
            
            return `
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                    <div class="flex items-center space-x-3">
                        <div class="w-8 h-8 bg-forest-500 rounded-full flex items-center justify-center">
                            <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path>
                            </svg>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-gray-900">${activity.volume_liters}L - ${getMilkingTypeInPortuguese(activity.milking_type)}</p>
                            <p class="text-xs text-gray-500">${timeAgo} • por ${userName}</p>
                        </div>
                    </div>
                    <div class="text-xs text-gray-400">
                        ${timeAgo}
                    </div>
                </div>
            `;
        }).join('');

    } catch (error) {
        console.error('❌ Erro ao carregar atividades recentes:', error);
    }
    
            console.log('✅ Função loadRecentActivities concluída');
}

// ==================== REAL-TIME UPDATES ====================
let realtimeSubscriptions = [];

// Função para configurar atualizações em tempo real
async function setupRealtimeUpdates() {
    try {
        console.log('🔌 Configurando atualizações em tempo real...');
        
        // Obter farm_id do usuário atual
        const userData = localStorage.getItem('userData') || sessionStorage.getItem('userData');
        if (!userData) {
            console.log('❌ Dados de usuário não encontrados para tempo real');
            return;
        }
        
        const parsedUserData = JSON.parse(userData);
        const farmId = parsedUserData.farm_id;
        
        // Obter cliente Supabase
        // // const supabase = await getSupabaseClient(); // REMOVIDO // REMOVIDO - usando MySQL
        if (!supabase) {
            console.log('❌ Supabase não disponível para tempo real');
            return;
        }
        
        // 1. Escutar mudanças na tabela volume_records (produção)
        const volumeSubscription = supabase
            .channel('volume_records_changes')
            .on(
                'postgres_changes',
                {
                    event: '*', // INSERT, UPDATE, DELETE
                    schema: 'public',
                    table: 'volume_records',
                    filter: `farm_id=eq.${farmId}`
                },
                async (payload) => {
                    console.log('📊 Mudança detectada em volume_records:', payload.eventType);
                    
                    // Atualizar apenas os componentes necessários
                    switch (payload.eventType) {
                        case 'INSERT':
                            await handleNewProduction(payload.new);
                            break;
                        case 'UPDATE':
                            await handleProductionUpdate(payload.new, payload.old);
                            break;
                        case 'DELETE':
                            await handleProductionDelete(payload.old);
                            break;
                    }
                }
            )
            .subscribe();

        // Armazenar referência da subscription
        realtimeSubscriptions = [volumeSubscription];

        console.log('✅ Atualizações em tempo real configuradas com sucesso!');
        
        // Mostrar indicador visual
        const indicator = document.getElementById('realtimeIndicator');
        if (indicator) {
            indicator.classList.remove('hidden');
        }
        
    } catch (error) {
        console.error('❌ Erro ao configurar atualizações em tempo real:', error.message);
    }
}

// Função para limpar todas as subscriptions
function cleanupRealtimeUpdates() {
    try {
        console.log('🧹 Limpando atualizações em tempo real...');
        
        realtimeSubscriptions.forEach(subscription => {
            if (subscription && subscription.unsubscribe) {
                subscription.unsubscribe();
            }
        });
        
        realtimeSubscriptions = [];
        
        // Esconder indicador visual
        const indicator = document.getElementById('realtimeIndicator');
        if (indicator) {
            indicator.classList.add('hidden');
        }
        
        console.log('✅ Atualizações em tempo real limpas');
        
    } catch (error) {
        console.error('❌ Erro ao limpar atualizações em tempo real:', error.message);
    }
}

// Handlers para mudanças em tempo real
async function handleNewProduction(newProduction) {
    try {
        console.log('🆕 Nova produção detectada:', newProduction);
        
        // Atualizar volume de hoje
        await updateTodayVolume();
        
        // Atualizar atividades recentes
        const userData = localStorage.getItem('userData') || sessionStorage.getItem('userData');
        if (userData) {
            const parsedUserData = JSON.parse(userData);
            await loadRecentActivities(parsedUserData.farm_id);
        }
        
        // Mostrar notificação
        showNotification(`Nova produção registrada: ${newProduction.volume_liters}L`, 'success');
        
        // Notificação REAL do dispositivo para registro de produção
        if (window.nativeNotifications) {
            window.nativeNotifications.showRealDeviceNotification(
                'Nova Produção Registrada',
                `Volume: ${newProduction.volume_liters}L registrado com sucesso!`,
                'production'
            );
        }
        
    } catch (error) {
        console.error('❌ Erro ao processar nova produção:', error.message);
    }
}

async function handleProductionUpdate(newProduction, oldProduction) {
    try {
        console.log('🔄 Produção atualizada:', { old: oldProduction, new: newProduction });
        
        // Atualizar volume de hoje
        await updateTodayVolume();
        
        // Atualizar atividades recentes
        const userData = localStorage.getItem('userData') || sessionStorage.getItem('userData');
        if (userData) {
            const parsedUserData = JSON.parse(userData);
            await loadRecentActivities(parsedUserData.farm_id);
        }
        
        // Mostrar notificação
        showNotification('Produção atualizada com sucesso!', 'info');
        
    } catch (error) {
        console.error('❌ Erro ao processar atualização de produção:', error.message);
    }
}

async function handleProductionDelete(deletedProduction) {
    try {
        console.log('🗑️ Produção deletada:', deletedProduction);
        
        // Atualizar volume de hoje
        await updateTodayVolume();
        
        // Atualizar atividades recentes
        const userData = localStorage.getItem('userData') || sessionStorage.getItem('userData');
        if (userData) {
            const parsedUserData = JSON.parse(userData);
            await loadRecentActivities(parsedUserData.farm_id);
        }
        
        // Mostrar notificação
        showNotification('Produção removida com sucesso!', 'info');
        
    } catch (error) {
        console.error('❌ Erro ao processar remoção de produção:', error.message);
    }
}

// Função para atualizar volume de hoje
async function updateTodayVolume() {
    try {
        const userData = localStorage.getItem('userData') || sessionStorage.getItem('userData');
        if (!userData) return;
        
        const parsedUserData = JSON.parse(userData);
        // // const supabase = await getSupabaseClient(); // REMOVIDO // REMOVIDO - usando MySQL
        
        const { data: volumeData, error: volumeError } = await supabase
            .from('volume_records')
            .select('volume_liters')
            .eq('farm_id', parsedUserData.farm_id)
            .gte('production_date', new Date().toISOString().split('T')[0]);

        if (!volumeError && volumeData && volumeData.length > 0) {
            const todayVolume = volumeData.reduce((sum, record) => sum + (record.volume_liters || 0), 0);
            const volumeElement = document.getElementById('todayVolume');
            if (volumeElement) {
                volumeElement.textContent = `${todayVolume} L`;
                
                // Salvar no localStorage
                localStorage.setItem('todayVolume', todayVolume.toString());
                localStorage.setItem('todayVolumeDate', new Date().toISOString().split('T')[0]);
                
                console.log('✅ Volume de hoje atualizado em tempo real:', todayVolume, 'L');
            }
        }
    } catch (error) {
        console.error('❌ Erro ao atualizar volume em tempo real:', error.message);
    }
}



// Initialize charts
function initializeCharts() {
    // Volume Chart
    const volumeCtx = document.getElementById('volumeChart');
    if (volumeCtx) {
        console.log('✅ Inicializando gráfico volumeChart (Volume Semanal)...');
        window.volumeChart = new Chart(volumeCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Volume (L)',
                    data: [],
                    borderColor: '#369e36',
                    backgroundColor: 'rgba(54, 158, 54, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
        console.log('✅ Gráfico volumeChart (Volume Semanal) inicializado com sucesso');
    } else {
        console.error('❌ Elemento volumeChart não encontrado no DOM');
    }

    // Quality Chart
    const qualityCtx = document.getElementById('qualityChart');
    if (qualityCtx) {
        window.qualityChart = new Chart(qualityCtx, {
            type: 'bar',
            data: {
                labels: [],
                datasets: [{
                    label: 'Qualidade (%)',
                    data: [],
                    backgroundColor: '#5bb85b',
                    borderRadius: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100
                    }
                }
            }
        });
    }
    // Temperature Chart
    const temperatureCtx = document.getElementById('temperatureChart');
    
    if (temperatureCtx) {
        window.temperatureChart = new Chart(temperatureCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Temperatura (°C)',
                    data: [],
                    borderColor: '#f59e0b',
                    backgroundColor: 'rgba(245, 158, 11, 0.1)',
                    borderWidth: 3,
                    pointRadius: 6,
                    pointHoverRadius: 8,
                    pointBackgroundColor: '#f59e0b',
                    pointBorderColor: '#ffffff',
                    pointBorderWidth: 2,
                    tension: 0.4,
                    fill: true,
                    showLine: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    intersect: false,
                    mode: 'index'
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleColor: 'white',
                        bodyColor: 'white',
                        borderColor: 'rgba(255, 255, 255, 0.1)',
                        borderWidth: 1,
                        callbacks: {
                            label: function(context) {
                                return 'Temperatura: ' + context.parsed.y + '°C';
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 10,
                        grid: {
                            color: 'rgba(0, 0, 0, 0.1)'
                        },
                        ticks: {
                            callback: function(value) {
                                return value + '°C';
                            }
                        }
                    },
                    x: {
                        grid: {
                            color: 'rgba(0, 0, 0, 0.1)'
                        }
                    }
                },
                elements: {
                    line: {
                        tension: 0.4
                    },
                    point: {
                        radius: 6,
                        hoverRadius: 8
                    }
                }
            }
        });
    }

    // Dashboard Weekly Production Chart
    const dashboardWeeklyCtx = document.getElementById('dashboardWeeklyChart');
    if (dashboardWeeklyCtx) {
        console.log('✅ Inicializando gráfico dashboardWeeklyChart...');
        window.dashboardWeeklyChart = new Chart(dashboardWeeklyCtx, {
            type: 'bar',
            data: {
                labels: [],
                datasets: [{
                    label: 'Produção (L)',
                    data: [],
                    backgroundColor: '#5bb85b',
                    borderRadius: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        // Escala dinâmica - sem limite máximo
                        ticks: {
                            callback: function(value) {
                                return value + 'L';
                            }
                        }
                    }
                }
            }
        });
        console.log('✅ Gráfico dashboardWeeklyChart inicializado com sucesso');
    } else {
        console.error('❌ Elemento dashboardWeeklyChart não encontrado no DOM');
    }

    // Weekly Volume Chart
    const weeklyVolumeCtx = document.getElementById('weeklyVolumeChart');
    if (weeklyVolumeCtx) {
        window.weeklyVolumeChart = new Chart(weeklyVolumeCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Volume Semanal (L)',
                    data: [],
                    borderColor: '#3b82f6',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    borderWidth: 3,
                    pointRadius: 6,
                    pointHoverRadius: 8,
                    pointBackgroundColor: '#3b82f6',
                    pointBorderColor: '#ffffff',
                    pointBorderWidth: 2,
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    intersect: false,
                    mode: 'index'
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleColor: 'white',
                        bodyColor: 'white',
                        borderColor: 'rgba(255, 255, 255, 0.1)',
                        borderWidth: 1,
                        callbacks: {
                            label: function(context) {
                                return 'Volume: ' + context.parsed.y + 'L';
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(0, 0, 0, 0.1)'
                        },
                        ticks: {
                            callback: function(value) {
                                return value + 'L';
                            }
                        }
                    },
                    x: {
                        grid: {
                            color: 'rgba(0, 0, 0, 0.1)'
                        }
                    }
                }
            }
        });
    }

    // Daily Volume Chart
    const dailyVolumeCtx = document.getElementById('dailyVolumeChart');
    if (dailyVolumeCtx) {
        window.dailyVolumeChart = new Chart(dailyVolumeCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Volume por Horário (L)',
                    data: [],
                    borderColor: '#3b82f6',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        // Escala dinâmica - sem limite máximo
                        ticks: {
                            callback: function(value) {
                                return value + 'L';
                            }
                        }
                    }
                }
            }
        });
    }

    // Quality Trend Chart
    const qualityTrendCtx = document.getElementById('qualityTrendChart');
    if (qualityTrendCtx) {
        qualityTrendChart = new Chart(qualityTrendCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    {
                        label: 'Gordura (%)',
                        data: [],
                        borderColor: '#f59e0b',
                        backgroundColor: 'rgba(245, 158, 11, 0.1)',
                        borderWidth: 3,
                        pointRadius: 5,
                        pointHoverRadius: 7,
                        pointBackgroundColor: '#f59e0b',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2,
                        tension: 0.4,
                        fill: false
                    },
                    {
                        label: 'Proteína (%)',
                        data: [],
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        borderWidth: 3,
                        pointRadius: 5,
                        pointHoverRadius: 7,
                        pointBackgroundColor: '#10b981',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2,
                        tension: 0.4,
                        fill: false
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    intersect: false,
                    mode: 'index'
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 6,
                        grid: {
                            color: 'rgba(0, 0, 0, 0.1)'
                        },
                        ticks: {
                            callback: function(value) {
                                return value + '%';
                            }
                        }
                    },
                    x: {
                        grid: {
                            color: 'rgba(0, 0, 0, 0.1)'
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                        labels: {
                            usePointStyle: true,
                            padding: 20
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleColor: 'white',
                        bodyColor: 'white',
                        borderColor: 'rgba(255, 255, 255, 0.1)',
                        borderWidth: 1
                    }
                }
            }
        });
    }

    // Quality Distribution Chart
    const qualityDistCtx = document.getElementById('qualityDistributionChart');
    if (qualityDistCtx) {
        qualityDistributionChart = new Chart(qualityDistCtx, {
            type: 'doughnut',
            data: {
                labels: ['Excelente', 'Bom', 'Regular'],
                datasets: [{
                    data: [0, 0, 0],
                    backgroundColor: ['#10b981', '#f59e0b', '#ef4444'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    }

    // Payments Chart
    const paymentsCtx = document.getElementById('paymentsChart');
    if (paymentsCtx) {
        window.paymentsChart = new Chart(paymentsCtx, {
            type: 'bar',
            data: {
                labels: ['Pagos', 'Pendentes', 'Atrasados'],
                datasets: [{
                    label: 'Vendas (R$)',
                    data: [0, 0, 0],
                    backgroundColor: ['#10b981', '#f59e0b', '#ef4444']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }
    // Weekly Summary Chart
    const weeklySummaryCtx = document.getElementById('weeklySummaryChart');
    if (weeklySummaryCtx) {
        window.weeklySummaryChart = new Chart(weeklySummaryCtx, {
            type: 'bar',
            data: {
                labels: [],
                datasets: [{
                    label: 'Volume Semanal (L)',
                    data: [],
                    backgroundColor: '#3b82f6',
                    borderColor: '#1d4ed8',
                    borderWidth: 1,
                    borderRadius: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return value + 'L';
                            }
                        }
                    }
                }
            }
        });
    }

    // Monthly Volume Chart
    const monthlyVolumeCtx = document.getElementById('monthlyVolumeChart');
    if (monthlyVolumeCtx) {
        window.monthlyVolumeChart = new Chart(monthlyVolumeCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Volume Mensal (L)',
                    data: [],
                    borderColor: '#10b981',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    borderWidth: 3,
                    pointRadius: 6,
                    pointHoverRadius: 8,
                    pointBackgroundColor: '#10b981',
                    pointBorderColor: '#ffffff',
                    pointBorderWidth: 2,
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return value + 'L';
                            }
                        }
                    }
                }
            }
        });
    }
}



// Hide notification
function hideNotification() {
    document.getElementById('notificationToast').classList.remove('show');
}

// Profile modal functions
function openProfileModal() {
    document.getElementById('profileModal').classList.add('show');
    // Configurar header dinâmico quando o modal for aberto
    setTimeout(() => {
        setupProfileModalHeader();
    }, 100);
}

function closeProfileModal() {
    document.getElementById('profileModal').classList.remove('show');
}

// Profile edit functions
function toggleProfileEdit() {
    const viewMode = document.getElementById('profileViewMode');
    const editMode = document.getElementById('profileEditMode');
    const editBtn = document.getElementById('editProfileBtn');
    const editButtons = document.getElementById('profileEditButtons');
    
    if (editMode.classList.contains('hidden')) {
        // Switch to edit mode
        viewMode.classList.add('hidden');
        editMode.classList.remove('hidden');
        // NÃO mostrar botões automaticamente - só quando há mudanças
        editButtons.classList.add('hidden');
        editBtn.innerHTML = `
            <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
            Cancelar
        `;
        editBtn.onclick = cancelProfileEdit;
        
        // Populate edit form with current values
        populateEditForm();
    } else {
        // Switch back to view mode
        cancelProfileEdit();
    }
}

function cancelProfileEdit() {
    console.log('❌ Cancelando edição do perfil...');
    
    const viewMode = document.getElementById('profileViewMode');
    const editMode = document.getElementById('profileEditMode');
    const editBtn = document.getElementById('editProfileBtn');
    const editButtons = document.getElementById('profileEditButtons');
    
    viewMode.classList.remove('hidden');
    editMode.classList.add('hidden');
    
    // Garantir que os botões sejam ocultados completamente
    editButtons.classList.add('hidden');
    editButtons.style.display = 'none';
    editButtons.style.visibility = 'hidden';
    editButtons.style.opacity = '0';
    editButtons.style.pointerEvents = 'none';
    
    editBtn.innerHTML = `
        <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
        </svg>
        Editar
    `;
    editBtn.onclick = toggleProfileEdit;
    
    console.log('✅ Edição cancelada, botões ocultados');
}

function populateEditForm() {
    console.log('📝 Preenchendo formulário de edição...');
    
    // Get current values from view mode
    const currentName = document.getElementById('profileFullName').textContent;
    const currentEmail = document.getElementById('profileEmail2').textContent;
    const currentWhatsApp = document.getElementById('profileWhatsApp').textContent;
    
    // Populate edit form
    document.getElementById('editProfileName').value = currentName === 'Carregando...' ? '' : currentName;
    document.getElementById('editProfileEmail').value = currentEmail === 'Carregando...' ? '' : currentEmail;
    document.getElementById('editProfileWhatsApp').value = currentWhatsApp === 'Carregando...' || currentWhatsApp === 'Não informado' ? '' : currentWhatsApp;
    
    // Store original values for comparison
    window.originalProfileValues = {
        name: currentName === 'Carregando...' ? '' : currentName,
        email: currentEmail === 'Carregando...' ? '' : currentEmail,
        whatsapp: currentWhatsApp === 'Carregando...' || currentWhatsApp === 'Não informado' ? '' : currentWhatsApp
    };
    
    console.log('📋 Valores originais armazenados:', window.originalProfileValues);
    
    // Add change listeners to show/hide edit buttons
    const editFields = ['editProfileName', 'editProfileEmail', 'editProfileWhatsApp'];
    editFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
            // Remover listener anterior se existir
            field.removeEventListener('input', checkForChanges);
            field.addEventListener('input', checkForChanges);
            console.log(`✅ Listener adicionado ao campo: ${fieldId}`);
        }
    });
    
            // Verificar mudanças iniciais
        setTimeout(() => {
            checkForChanges();
        }, 100);
        
        // Garantir que os botões estejam ocultos inicialmente
        const editButtons = document.getElementById('profileEditButtons');
        if (editButtons) {
            editButtons.classList.add('hidden');
            editButtons.style.display = 'none';
            editButtons.style.visibility = 'hidden';
            editButtons.style.opacity = '0';
            editButtons.style.pointerEvents = 'none';
            console.log('✅ Botões de edição ocultados inicialmente');
        }
}

function checkForChanges() {
    const editButtons = document.getElementById('profileEditButtons');
    const currentName = document.getElementById('editProfileName').value;
    const currentEmail = document.getElementById('editProfileEmail').value;
    const currentWhatsApp = document.getElementById('editProfileWhatsApp').value;
    
    // Verificar se os valores originais existem
    if (!window.originalProfileValues) {
        console.log('⚠️ Valores originais não encontrados, ocultando botões');
        editButtons.classList.add('hidden');
        editButtons.style.display = 'none';
        editButtons.style.visibility = 'hidden';
        editButtons.style.opacity = '0';
        editButtons.style.pointerEvents = 'none';
        return;
    }
    
    const hasChanges = 
        currentName !== window.originalProfileValues.name ||
        currentEmail !== window.originalProfileValues.email ||
        currentWhatsApp !== window.originalProfileValues.whatsapp;
    
    console.log('🔍 Verificando mudanças:', {
        current: { name: currentName, email: currentEmail, whatsapp: currentWhatsApp },
        original: window.originalProfileValues,
        hasChanges: hasChanges
    });
    
    if (hasChanges) {
        editButtons.classList.remove('hidden');
        editButtons.style.display = 'flex';
        editButtons.style.visibility = 'visible';
        editButtons.style.opacity = '1';
        editButtons.style.pointerEvents = 'auto';
        console.log('✅ Mudanças detectadas, mostrando botões');
    } else {
        editButtons.classList.add('hidden');
        editButtons.style.display = 'none';
        editButtons.style.visibility = 'hidden';
        editButtons.style.opacity = '0';
        editButtons.style.pointerEvents = 'none';
        console.log('✅ Sem mudanças, ocultando botões');
    }
}

// Handle profile update form submission
async function handleUpdateProfile(event) {
    event.preventDefault();
    
    try {
        const formData = new FormData(event.target);
        const { data: { user } } = await supabase.auth.getUser();
        
        if (!user) {
            throw new Error('Usuário não autenticado');
        }
        
        const updateData = {
            name: formData.get('name'),
            whatsapp: formData.get('whatsapp') || null,
            // Campos de relatório adicionados
            report_farm_name: formData.get('report_farm_name') || null,
            report_farm_logo_base64: formData.get('report_farm_logo_base64') || null,
            report_footer_text: formData.get('report_footer_text') || null,
            report_system_logo_base64: formData.get('report_system_logo_base64') || null
        };
        
        // Handle profile photo upload if provided
        const profilePhotoFile = formData.get('profilePhoto');
        if (profilePhotoFile && profilePhotoFile.size > 0) {
            try {
                const profilePhotoUrl = await uploadProfilePhoto(profilePhotoFile, user.id);
                updateData.profile_photo_url = profilePhotoUrl;
            } catch (photoError) {
                console.error('Erro ao fazer upload da foto de perfil:', photoError);
                // Don't show error notification for photo upload - profile update is more important
                // showNotification('Erro ao fazer upload da foto de perfil, mas outros dados foram atualizados', 'warning');
            }
        }
        
        // First, check if user exists in users table
        const { data: existingUser, error: checkError } = await supabase
            .from('users')
            .select('*')
            .eq('id', user.id)
            .single();
        
        // Update user table in database
        const { data, error } = await supabase
            .from('users')
            .update(updateData)
            .eq('id', user.id)
            .select();
        
        if (error) {
            throw error;
        }
        
        // Also update user metadata in Supabase Auth
        const { error: authError } = await supabase.auth.updateUser({
            data: {
                name: updateData.name,
                whatsapp: updateData.whatsapp
            }
        });
        
        if (authError) {
        }
        
        // Update the view mode with new values
        document.getElementById('profileFullName').textContent = updateData.name || 'Não informado';
        document.getElementById('profileName').textContent = updateData.name || 'Não informado';
        
        // Extract formal name for header and welcome message
        const formalName = extractFormalName(updateData.name);
        document.getElementById('managerName').textContent = formalName || 'Gerente';
        document.getElementById('managerWelcome').textContent = formalName || 'Gerente';
        
        document.getElementById('profileWhatsApp').textContent = updateData.whatsapp || 'Não informado';
        
        // Update localStorage/sessionStorage if exists (excluding profile_photo_url to prevent cross-page sharing)
        const sessionData = localStorage.getItem('userData') || sessionStorage.getItem('userData');
        if (sessionData) {
            try {
                const userData = JSON.parse(sessionData);
                userData.name = updateData.name;
                userData.whatsapp = updateData.whatsapp;
                // DO NOT update profile_photo_url in localStorage to prevent sharing between pages
                // Each page should load profile photo directly from database
                
                if (localStorage.getItem('userData')) {
                    localStorage.setItem('userData', JSON.stringify(userData));
                }
                if (sessionStorage.getItem('userData')) {
                    sessionStorage.setItem('userData', JSON.stringify(userData));
                }
            } catch (e) {
            }
        }
        
        // Switch back to view mode
        cancelProfileEdit();
        
        showNotification('Perfil atualizado com sucesso!', 'success');
        
    } catch (error) {
        console.error('Erro ao atualizar perfil:', error);
        showNotification('Erro ao atualizar perfil: ' + error.message, 'error');
    }
}

// Action functions
function addVolumeRecord() {
    // Criar modal para adicionar novo registro de volume
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    modal.innerHTML = `
        <div class="bg-white    rounded-2xl p-6 w-full max-w-md mx-4">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-bold text-slate-900   ">Novo Registro de Volume</h3>
                <button onclick="closeVolumeModal()" class="text-gray-400 hover:text-gray-600   :text-gray-300">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <form id="volumeForm" onsubmit="handleAddVolume(event)">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700    mb-2">Data</label>
                        <input type="date" name="production_date" id="volumeDateInput" required class="w-full px-3 py-2 border border-gray-300    rounded-lg focus:ring-2 focus:ring-forest-500 focus:border-transparent      ">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700    mb-2">Turno</label>
                        <select name="shift" required class="w-full px-3 py-2 border border-gray-300    rounded-lg focus:ring-2 focus:ring-forest-500 focus:border-transparent      ">
                            <option value="">Selecione o turno</option>
                            <option value="manha">Manhã</option>
                            <option value="tarde">Tarde</option>
                            <option value="noite">Noite</option>
                            <option value="madrugada">Madrugada</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700    mb-2">Volume (Litros)</label>
                        <input type="number" name="volume" step="0.1" min="0" required class="w-full px-3 py-2 border border-gray-300    rounded-lg focus:ring-2 focus:ring-forest-500 focus:border-transparent      " placeholder="0.0">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700    mb-2">Temperatura (°C)</label>
                        <input type="number" name="temperature" step="0.1" class="w-full px-3 py-2 border border-gray-300    rounded-lg focus:ring-2 focus:ring-forest-500 focus:border-transparent      " placeholder="4.0">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700    mb-2">Observações</label>
                        <textarea name="observations" rows="3" class="w-full px-3 py-2 border border-gray-300    rounded-lg focus:ring-2 focus:ring-forest-500 focus:border-transparent      " placeholder="Observações adicionais (opcional)"></textarea>
                    </div>
                </div>
                <div class="flex gap-3 mt-6">
                    <button type="button" onclick="closeVolumeModal()" class="flex-1 px-4 py-2 border border-gray-300    text-gray-700    rounded-lg hover:bg-gray-50   :bg-slate-700 transition-colors">
                        Cancelar
                    </button>
                    <button type="submit" class="flex-1 px-4 py-2 bg-forest-600 text-white rounded-lg hover:bg-forest-700 transition-colors">
                        Registrar
                    </button>
                </div>
            </form>
        </div>
    `;
    
    modal.id = 'volumeModal';
    document.body.appendChild(modal);
    
    // Set default date to today
    const today = new Date().toISOString().split('T')[0];
    modal.querySelector('input[name="production_date"]').value = today;
}
function addQualityTest() {
    // Criar modal para adicionar novo teste de qualidade
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 quality-modal-backdrop py-8 px-4';
    modal.innerHTML = `
        <div class="bg-white rounded-3xl p-8 w-full max-w-lg mx-4 shadow-2xl transform transition-all duration-300 scale-100">
            <!-- Header com ícone -->
            <div class="flex items-center justify-between mb-8 quality-modal-header p-6 -m-8 mb-8 rounded-t-3xl">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-green-100 rounded-xl flex items-center justify-center">
                        <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold text-gray-900">Novo Teste de Qualidade</h3>
                        <p class="text-sm text-gray-500">Registre os parâmetros de qualidade do leite</p>
                    </div>
                </div>
                <button onclick="closeQualityModal()" class="quality-close-btn text-gray-400 hover:text-gray-600 transition-colors p-2 hover:bg-gray-100 rounded-lg">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <form id="qualityForm" onsubmit="handleAddQuality(event)" class="quality-form space-y-6">
                <!-- Data do Teste -->
                <div class="relative">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                        Data do Teste
                    </label>
                    <input type="date" name="test_date" required 
                           class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all duration-200 bg-gray-50 focus:bg-white">
                </div>

                <!-- Parâmetros de Qualidade em Grid -->
                <div class="quality-modal-grid grid grid-cols-2 gap-4">
                    <!-- Gordura -->
                    <div class="relative">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            <div class="w-3 h-3 bg-orange-400 rounded-full inline-block mr-2"></div>
                            Gordura (%)
                        </label>
                        <div class="relative">
                            <input type="number" name="fat_percentage" step="0.01" min="0" max="100" required 
                                   class="w-full px-4 py-3 pr-16 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition-all duration-200 bg-gray-50 focus:bg-white" 
                                   placeholder="3.50">
                            <div class="absolute inset-y-0 right-0 flex flex-col items-center pr-3">
                                <button type="button" onclick="adjustValue('fat_percentage', 0.1)" class="text-gray-400 hover:text-orange-600 p-1">
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path>
                                    </svg>
                                </button>
                                <button type="button" onclick="adjustValue('fat_percentage', -0.1)" class="text-gray-400 hover:text-orange-600 p-1">
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <div class="quality-standards">Padrão: 3.0 - 6.0%</div>
                    </div>

                    <!-- Proteína -->
                    <div class="relative">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            <div class="w-3 h-3 bg-blue-400 rounded-full inline-block mr-2"></div>
                            Proteína (%)
                        </label>
                        <div class="relative">
                            <input type="number" name="protein_percentage" step="0.01" min="0" max="100" required 
                                   class="w-full px-4 py-3 pr-16 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 bg-gray-50 focus:bg-white" 
                                   placeholder="3.20">
                            <div class="absolute inset-y-0 right-0 flex flex-col items-center pr-3">
                                <button type="button" onclick="adjustValue('protein_percentage', 0.1)" class="text-gray-400 hover:text-blue-600 p-1">
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path>
                                    </svg>
                                </button>
                                <button type="button" onclick="adjustValue('protein_percentage', -0.1)" class="text-gray-400 hover:text-blue-600 p-1">
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <div class="quality-standards">Padrão: 2.8 - 4.0%</div>
                    </div>

                    <!-- CCS -->
                    <div class="relative">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            <div class="w-3 h-3 bg-red-400 rounded-full inline-block mr-2"></div>
                            CCS (mil/mL)
                        </label>
                        <div class="relative">
                            <input type="number" name="scc" min="0" max="1000" required 
                                   class="w-full px-4 py-3 pr-16 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-red-500 focus:border-red-500 transition-all duration-200 bg-gray-50 focus:bg-white" 
                                   placeholder="200">
                            <div class="absolute inset-y-0 right-0 flex flex-col items-center pr-3">
                                <button type="button" onclick="adjustValue('scc', 10)" class="text-gray-400 hover:text-red-600 p-1">
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path>
                                    </svg>
                                </button>
                                <button type="button" onclick="adjustValue('scc', -10)" class="text-gray-400 hover:text-red-600 p-1">
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <div class="quality-standards">Máximo: 400 mil/mL</div>
                    </div>

                    <!-- CBT -->
                    <div class="relative">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            <div class="w-3 h-3 bg-purple-400 rounded-full inline-block mr-2"></div>
                            CBT (mil/mL)
                        </label>
                        <div class="relative">
                            <input type="number" name="total_bacterial_count" min="0" max="1000" required 
                                   class="w-full px-4 py-3 pr-16 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-all duration-200 bg-gray-50 focus:bg-white" 
                                   placeholder="50">
                            <div class="absolute inset-y-0 right-0 flex flex-col items-center pr-3">
                                <button type="button" onclick="adjustValue('total_bacterial_count', 5)" class="text-gray-400 hover:text-purple-600 p-1">
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path>
                                    </svg>
                                </button>
                                <button type="button" onclick="adjustValue('total_bacterial_count', -5)" class="text-gray-400 hover:text-purple-600 p-1">
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <div class="quality-standards">Máximo: 100 mil/mL</div>
                    </div>
                </div>

                <!-- Laboratório -->
                <div class="relative">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path>
                        </svg>
                        Laboratório
                    </label>
                    <input type="text" name="laboratory" 
                           class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all duration-200 bg-gray-50 focus:bg-white" 
                           placeholder="Nome do laboratório">
                </div>

                <!-- Observações -->
                <div class="relative">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                        </svg>
                        Observações
                    </label>
                    <textarea name="notes" rows="3" 
                              class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all duration-200 bg-gray-50 focus:bg-white resize-none" 
                              placeholder="Observações adicionais (opcional)"></textarea>
                </div>

                <!-- Botões -->
                <div class="flex gap-4 pt-4">
                    <button type="button" onclick="closeQualityModal()" 
                            class="flex-1 px-6 py-3 border-2 border-gray-300 text-gray-700 font-semibold rounded-xl hover:bg-gray-50 hover:border-gray-400 transition-all duration-200">
                        Cancelar
                    </button>
                    <button type="submit" 
                            class="quality-btn-primary flex-1 px-6 py-3 bg-gradient-to-r from-green-600 to-green-700 text-white font-semibold rounded-xl hover:from-green-700 hover:to-green-800 transition-all duration-200 shadow-lg hover:shadow-xl">
                        <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                        Registrar Teste
                    </button>
                </div>
            </form>
        </div>
    `;
    
    modal.id = 'qualityModal';
    document.body.appendChild(modal);
    
    // Set default date to today
    const today = new Date().toISOString().split('T')[0];
    modal.querySelector('input[name="test_date"]').value = today;
    
    // Garantir posicionamento correto
    modal.style.position = 'fixed';
    modal.style.top = '0';
    modal.style.left = '0';
    modal.style.width = '100%';
    modal.style.height = '100%';
    modal.style.display = 'flex';
    modal.style.alignItems = 'center';
    modal.style.justifyContent = 'center';
    modal.style.zIndex = '9999';
    
    // Adicionar animação de entrada
    setTimeout(() => {
        modal.querySelector('.bg-white').classList.add('scale-100');
    }, 10);
    
    // Ativar validação em tempo real
    setTimeout(() => {
        validateQualityInputs();
        addQualitySummary();
    }, 100);
}

function addPayment() {
    // Criar modal para adicionar novo pagamento
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    modal.innerHTML = `
        <div class="bg-white    rounded-2xl p-6 w-full max-w-md mx-4">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-bold text-slate-900   ">Nova Venda de Leite</h3>
                <button onclick="closePaymentModal()" class="text-gray-400 hover:text-gray-600   :text-gray-300">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <form id="paymentForm" onsubmit="handleAddPayment(event)">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700    mb-2">Descrição</label>
                        <input type="text" name="description" required class="w-full px-3 py-2 border border-gray-300    rounded-lg focus:ring-2 focus:ring-forest-500 focus:border-transparent      " placeholder="Ex: Venda para Laticínio ABC">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700    mb-2">Valor (R$)</label>
                        <input type="number" name="amount" step="0.01" required class="w-full px-3 py-2 border border-gray-300    rounded-lg focus:ring-2 focus:ring-forest-500 focus:border-transparent      " placeholder="0,00">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700    mb-2">Tipo</label>
                        <select name="payment_type" required class="w-full px-3 py-2 border border-gray-300    rounded-lg focus:ring-2 focus:ring-forest-500 focus:border-transparent      ">
                            <option value="">Selecione o tipo</option>
                            <option value="laticinio">Laticínio</option>
                            <option value="cooperativa">Cooperativa</option>
                            <option value="distribuidor">Distribuidor</option>
                            <option value="consumidor_final">Consumidor Final</option>
                            <option value="exportacao">Exportação</option>
                            <option value="outros">Outros</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700    mb-2">Data da Venda</label>
                        <input type="date" name="due_date" required class="w-full px-3 py-2 border border-gray-300    rounded-lg focus:ring-2 focus:ring-forest-500 focus:border-transparent      ">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700    mb-2">Status</label>
                        <select name="status" required class="w-full px-3 py-2 border border-gray-300    rounded-lg focus:ring-2 focus:ring-forest-500 focus:border-transparent      ">
                            <option value="pending">Pendente</option>
                            <option value="completed">Concluída</option>
                            <option value="overdue">Atrasada</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700    mb-2">Observações</label>
                        <textarea name="notes" rows="3" class="w-full px-3 py-2 border border-gray-300    rounded-lg focus:ring-2 focus:ring-forest-500 focus:border-transparent      " placeholder="Observações adicionais (opcional)"></textarea>
                    </div>
                </div>
                <div class="flex gap-3 mt-6">
                    <button type="button" onclick="closePaymentModal()" class="flex-1 px-4 py-2 border border-gray-300    text-gray-700    rounded-lg hover:bg-gray-50   :bg-slate-700 transition-colors">
                        Cancelar
                    </button>
                    <button type="submit" class="flex-1 px-4 py-2 bg-forest-600 text-white rounded-lg hover:bg-forest-700 transition-colors">
                        Adicionar
                    </button>
                </div>
            </form>
        </div>
    `;
    
    modal.id = 'paymentModal';
    document.body.appendChild(modal);
    
    // Set default due date to today
    const today = new Date().toISOString().split('T')[0];
    modal.querySelector('input[name="due_date"]').value = today;
}

function closePaymentModal() {
    const modal = document.getElementById('paymentModal');
    if (modal) {
        modal.remove();
    }
}

function closeVolumeModal() {
    const modal = document.getElementById('volumeModal');
    if (modal) {
        modal.remove();
    }
}

function closeQualityModal() {
    const modal = document.getElementById('qualityModal');
    if (modal) {
        // Adicionar animação de saída
        modal.querySelector('.bg-white').classList.add('scale-95', 'opacity-0');
        setTimeout(() => {
            modal.remove();
        }, 200);
    }
}

// Função para ajustar valores dos campos numéricos
function adjustValue(fieldName, increment) {
    const field = document.querySelector(`input[name="${fieldName}"]`);
    if (field) {
        const currentValue = parseFloat(field.value) || 0;
        const newValue = Math.max(0, currentValue + increment);
        
        // Determinar número de casas decimais baseado no campo
        let decimalPlaces = 0;
        if (fieldName === 'fat_percentage' || fieldName === 'protein_percentage') {
            decimalPlaces = 2;
        }
        
        field.value = newValue.toFixed(decimalPlaces);
        
        // Adicionar feedback visual
        const color = increment > 0 ? '#fef3c7' : '#fef2f2';
        field.style.backgroundColor = color;
        setTimeout(() => {
            field.style.backgroundColor = '';
        }, 300);
        
        // Disparar evento de input para validação
        field.dispatchEvent(new Event('input'));
    }
}

// Função para validar valores em tempo real
function validateQualityInputs() {
    const inputs = document.querySelectorAll('#qualityForm input[type="number"]');
    inputs.forEach(input => {
        input.addEventListener('input', function() {
            const value = parseFloat(this.value);
            const fieldName = this.name;
            
            // Validações específicas por campo
            switch(fieldName) {
                case 'fat_percentage':
                    if (value < 0 || value > 100) {
                        this.style.borderColor = '#ef4444';
                        this.style.backgroundColor = '#fef2f2';
                    } else if (value < 3.0 || value > 6.0) {
                        this.style.borderColor = '#f59e0b';
                        this.style.backgroundColor = '#fffbeb';
                    } else {
                        this.style.borderColor = '#10b981';
                        this.style.backgroundColor = '#f0fdf4';
                    }
                    break;
                    
                case 'protein_percentage':
                    if (value < 0 || value > 100) {
                        this.style.borderColor = '#ef4444';
                        this.style.backgroundColor = '#fef2f2';
                    } else if (value < 2.8 || value > 4.0) {
                        this.style.borderColor = '#f59e0b';
                        this.style.backgroundColor = '#fffbeb';
                    } else {
                        this.style.borderColor = '#10b981';
                        this.style.backgroundColor = '#f0fdf4';
                    }
                    break;
                    
                case 'scc':
                    if (value < 0) {
                        this.style.borderColor = '#ef4444';
                        this.style.backgroundColor = '#fef2f2';
                    } else if (value > 400) {
                        this.style.borderColor = '#ef4444';
                        this.style.backgroundColor = '#fef2f2';
                    } else if (value > 300) {
                        this.style.borderColor = '#f59e0b';
                        this.style.backgroundColor = '#fffbeb';
                    } else {
                        this.style.borderColor = '#10b981';
                        this.style.backgroundColor = '#f0fdf4';
                    }
                    break;
                    
                case 'total_bacterial_count':
                    if (value < 0) {
                        this.style.borderColor = '#ef4444';
                        this.style.backgroundColor = '#fef2f2';
                    } else if (value > 100) {
                        this.style.borderColor = '#ef4444';
                        this.style.backgroundColor = '#fef2f2';
                    } else if (value > 50) {
                        this.style.borderColor = '#f59e0b';
                        this.style.backgroundColor = '#fffbeb';
                    } else {
                        this.style.borderColor = '#10b981';
                        this.style.backgroundColor = '#f0fdf4';
                    }
                    break;
            }
            
            // Reset após 2 segundos
            setTimeout(() => {
                this.style.borderColor = '';
                this.style.backgroundColor = '';
            }, 2000);
        });
    });
}

// Função para adicionar resumo visual dos valores
function addQualitySummary() {
    const inputs = document.querySelectorAll('#qualityForm input[type="number"]');
    const summaryContainer = document.createElement('div');
    summaryContainer.className = 'quality-summary mt-4 p-4 bg-gradient-to-r from-blue-50 to-green-50 rounded-xl border border-blue-200';
    summaryContainer.innerHTML = `
        <div class="flex items-center justify-between mb-2">
            <h4 class="text-sm font-semibold text-gray-700">Resumo da Qualidade</h4>
            <div class="quality-overall-status w-3 h-3 rounded-full bg-gray-300"></div>
        </div>
        <div class="grid grid-cols-2 gap-2 text-xs">
            <div class="quality-summary-item">
                <span class="text-gray-600">Gordura:</span>
                <span class="quality-fat-status font-semibold">--%</span>
            </div>
            <div class="quality-summary-item">
                <span class="text-gray-600">Proteína:</span>
                <span class="quality-protein-status font-semibold">--%</span>
            </div>
            <div class="quality-summary-item">
                <span class="text-gray-600">CCS:</span>
                <span class="quality-scc-status font-semibold">--</span>
            </div>
            <div class="quality-summary-item">
                <span class="text-gray-600">CBT:</span>
                <span class="quality-cbt-status font-semibold">--</span>
            </div>
        </div>
    `;
    
    // Inserir o resumo após o grid de parâmetros
    const gridContainer = document.querySelector('.quality-modal-grid').parentElement;
    gridContainer.insertBefore(summaryContainer, gridContainer.querySelector('div:last-child'));
    
    // Atualizar resumo quando valores mudarem
    inputs.forEach(input => {
        input.addEventListener('input', updateQualitySummary);
    });
}

// Função para atualizar o resumo
function updateQualitySummary() {
    const fatValue = parseFloat(document.querySelector('input[name="fat_percentage"]')?.value || 0);
    const proteinValue = parseFloat(document.querySelector('input[name="protein_percentage"]')?.value || 0);
    const sccValue = parseFloat(document.querySelector('input[name="scc"]')?.value || 0);
    const cbtValue = parseFloat(document.querySelector('input[name="total_bacterial_count"]')?.value || 0);
    
    // Atualizar valores
    const fatStatus = document.querySelector('.quality-fat-status');
    const proteinStatus = document.querySelector('.quality-protein-status');
    const sccStatus = document.querySelector('.quality-scc-status');
    const cbtStatus = document.querySelector('.quality-cbt-status');
    const overallStatus = document.querySelector('.quality-overall-status');
    
    if (fatStatus) {
        fatStatus.textContent = fatValue > 0 ? fatValue.toFixed(2) + '%' : '--%';
        fatStatus.className = getQualityStatusClass('fat', fatValue);
    }
    
    if (proteinStatus) {
        proteinStatus.textContent = proteinValue > 0 ? proteinValue.toFixed(2) + '%' : '--%';
        proteinStatus.className = getQualityStatusClass('protein', proteinValue);
    }
    
    if (sccStatus) {
        sccStatus.textContent = sccValue > 0 ? sccValue.toFixed(0) : '--';
        sccStatus.className = getQualityStatusClass('scc', sccValue);
    }
    
    if (cbtStatus) {
        cbtStatus.textContent = cbtValue > 0 ? cbtValue.toFixed(0) : '--';
        cbtStatus.className = getQualityStatusClass('cbt', cbtValue);
    }
    
    // Status geral
    if (overallStatus) {
        const overallScore = calculateOverallQuality(fatValue, proteinValue, sccValue, cbtValue);
        overallStatus.className = `quality-overall-status w-3 h-3 rounded-full ${getOverallStatusClass(overallScore)}`;
    }
}

// Função para calcular status de qualidade
function getQualityStatusClass(type, value) {
    const baseClass = 'font-semibold';
    
    switch(type) {
        case 'fat':
            if (value >= 3.0 && value <= 6.0) return `${baseClass} text-green-600`;
            if (value >= 2.5 && value < 3.0 || value > 6.0 && value <= 7.0) return `${baseClass} text-yellow-600`;
            return `${baseClass} text-red-600`;
            
        case 'protein':
            if (value >= 2.8 && value <= 4.0) return `${baseClass} text-green-600`;
            if (value >= 2.5 && value < 2.8 || value > 4.0 && value <= 4.5) return `${baseClass} text-yellow-600`;
            return `${baseClass} text-red-600`;
            
        case 'scc':
            if (value <= 200) return `${baseClass} text-green-600`;
            if (value > 200 && value <= 400) return `${baseClass} text-yellow-600`;
            return `${baseClass} text-red-600`;
            
        case 'cbt':
            if (value <= 50) return `${baseClass} text-green-600`;
            if (value > 50 && value <= 100) return `${baseClass} text-yellow-600`;
            return `${baseClass} text-red-600`;
            
        default:
            return baseClass;
    }
}

// Função para calcular qualidade geral
function calculateOverallQuality(fat, protein, scc, cbt) {
    let score = 0;
    let count = 0;
    
    if (fat > 0) {
        if (fat >= 3.0 && fat <= 6.0) score += 100;
        else if (fat >= 2.5 && fat < 3.0 || fat > 6.0 && fat <= 7.0) score += 60;
        else score += 20;
        count++;
    }
    
    if (protein > 0) {
        if (protein >= 2.8 && protein <= 4.0) score += 100;
        else if (protein >= 2.5 && protein < 2.8 || protein > 4.0 && protein <= 4.5) score += 60;
        else score += 20;
        count++;
    }
    
    if (scc > 0) {
        if (scc <= 200) score += 100;
        else if (scc > 200 && scc <= 400) score += 60;
        else score += 20;
        count++;
    }
    
    if (cbt > 0) {
        if (cbt <= 50) score += 100;
        else if (cbt > 50 && cbt <= 100) score += 60;
        else score += 20;
        count++;
    }
    
    return count > 0 ? score / count : 0;
}

// Função para obter classe do status geral
function getOverallStatusClass(score) {
    if (score >= 80) return 'bg-green-500';
    if (score >= 60) return 'bg-yellow-500';
    return 'bg-red-500';
}

async function handleAddVolume(event) {
    event.preventDefault();
    const formData = new FormData(event.target);
    
    // Mapear valores do turno para inglês (conforme constraint da tabela)
    const shiftMapping = {
        'manha': 'morning',
        'tarde': 'afternoon', 
        'noite': 'evening',
        'madrugada': 'night'
    };
    
    const volumeData = {
        production_date: formData.get('production_date'),
        shift: shiftMapping[formData.get('shift')] || formData.get('shift'),
        volume: parseFloat(formData.get('volume')),
        temperature: formData.get('temperature') ? parseFloat(formData.get('temperature')) : null,
        observations: formData.get('observations') || null
    };
    
    console.log('📅 Data do formulário:', formData.get('production_date'));
    console.log('📅 Data processada:', volumeData.production_date);

    try {
        // // const supabase = await getSupabaseClient(); // REMOVIDO // REMOVIDO - usando MySQL
        const { data: { user: currentUser } } = await supabase.auth.getUser();
        if (!currentUser) throw new Error('User not authenticated');

        // Get current user's farm_id and name
        const { data: managerData, error: managerError } = await supabase
            .from('users')
            .select('farm_id, name')
            .eq('id', currentUser.id)
            .single();

        if (managerError) throw managerError;
        if (!managerData?.farm_id) throw new Error('Farm not found');

        // Preparar dados para inserção
        const insertData = {
                farm_id: managerData.farm_id,
                user_id: currentUser.id,
                // Nome do funcionário será obtido via relacionamento com users
                production_date: volumeData.production_date,
                milking_type: volumeData.shift,
                volume_liters: volumeData.volume,
                temperature: volumeData.temperature,
                notes: volumeData.observations,
                created_at: new Date().toISOString()
        };

        // Verificar se está online ou offline
        if (navigator.onLine && window.offlineSyncManager) {
            // Tentar salvar online primeiro
            try {
                const { error: volumeError } = await supabase
                    .from('volume_records')
                    .insert(insertData);

        if (volumeError) throw volumeError;

        showNotification('Registro de volume adicionado com sucesso!', 'success');
                
                // Notificação real do dispositivo
                if (window.nativeNotifications) {
                    window.nativeNotifications.showRealDeviceNotification(
                        'Nova Produção Registrada',
                        `${volumeData.volume}L registrado com sucesso!`,
                        'production'
                    );
                }

            } catch (onlineError) {
                console.log('Erro online, salvando offline:', onlineError);
                // Se falhar online, salvar offline
                const result = await window.offlineSyncManager.addVolumeRecord(insertData);
                if (result.success) {
                    showNotification('Registro salvo offline - será sincronizado quando voltar online!', 'success');
                } else {
                    throw new Error(result.error);
                }
            }
        } else {
            // Modo offline - usar sistema de sincronização
            if (window.offlineSyncManager) {
                const result = await window.offlineSyncManager.addVolumeRecord(insertData);
                if (result.success) {
                    showNotification('Registro salvo offline - será sincronizado quando voltar online!', 'success');
                } else {
                    throw new Error(result.error);
                }
            } else {
                throw new Error('Sistema offline não disponível');
            }
        }
        closeVolumeModal();
        
        // Limpar cache para forçar atualização
        CacheManager.clearCache();
        
        // Reload volume data and charts - FORÇAR ATUALIZAÇÃO
        console.log('🔄 Atualizando dados após registro de volume...');
        
        // Atualizar dados de volume
        await loadVolumeData();
        console.log('✅ Dados de volume carregados');
        
        // Atualizar todos os gráficos
        await loadWeeklyVolumeChart();
        console.log('✅ Gráfico semanal atualizado');
        
        await loadDailyVolumeChart();
        console.log('✅ Gráfico diário atualizado');
        
        await loadDashboardWeeklyChart();
        console.log('✅ Gráfico do dashboard atualizado');
        
        // Atualizar estatísticas do dashboard
        await updateDashboardStats();
        console.log('✅ Estatísticas do dashboard atualizadas');
        
        // Atualizar lista de registros de volume
        await updateVolumeRecordsList();
        console.log('✅ Lista de registros de volume atualizada');
        
        // Forçar atualização da interface
        setTimeout(() => {
            console.log('🔄 Forçando atualização final...');
            loadVolumeData();
            loadWeeklyVolumeChart();
            loadDailyVolumeChart();
            loadDashboardWeeklyChart();
        }, 1000);

        // Forçar atualização adicional após 2 segundos
        setTimeout(() => {
            console.log('🔄 Forçando atualização adicional...');
            loadVolumeData();
            loadDashboardWeeklyChart();
        }, 2000);
        // Get user's farm_id for recent activities
        const { data: { user } } = await supabase.auth.getUser();
        if (user) {
            const { data: userData } = await supabase
                .from('users')
                .select('farm_id')
                .eq('id', user.id)
                .single();
            
            if (userData?.farm_id) {
                await loadRecentActivities(userData.farm_id);
            }
        }
        
    } catch (error) {
        console.error('Error adding volume record:', error);
        showNotification('Erro ao adicionar registro de volume: ' + error.message, 'error');
    }
}

async function handleAddQuality(event) {
    event.preventDefault();
    const formData = new FormData(event.target);
    
    const qualityData = {
        test_date: formData.get('test_date'),
        fat_percentage: parseFloat(formData.get('fat_percentage')),
        protein_percentage: parseFloat(formData.get('protein_percentage')),
                        scc: parseInt(formData.get('scc')),
                        cbt: parseInt(formData.get('total_bacterial_count')),
        laboratory: formData.get('laboratory') || null,
        observations: formData.get('notes') || null
    };

    try {
        // // const supabase = await getSupabaseClient(); // REMOVIDO // REMOVIDO - usando MySQL
        // Usar a nova função RPC para registrar o teste de qualidade
        const { data, error } = await supabase.rpc('register_quality_test', {
            p_test_date: qualityData.test_date,
            p_fat_percentage: qualityData.fat_percentage,
            p_protein_percentage: qualityData.protein_percentage,
            p_scc: qualityData.scc,
            p_cbt: qualityData.cbt,
            p_laboratory: qualityData.laboratory,
            p_observations: qualityData.observations
        });

        if (error) throw error;

        showNotification('Teste de qualidade adicionado com sucesso!', 'success');
        closeQualityModal();
        
        // Reload quality data and charts
        await loadQualityData();
        await loadQualityTests();
        
        // Get user's farm_id for recent activities
        const { data: { user } } = await supabase.auth.getUser();
        if (user) {
            const { data: userData } = await supabase
                .from('users')
                .select('farm_id')
                .eq('id', user.id)
                .single();
            
            if (userData?.farm_id) {
                await loadRecentActivities(userData.farm_id);
            }
        }
        
    } catch (error) {
        console.error('Error adding quality test:', error);
        showNotification('Erro ao adicionar teste de qualidade: ' + error.message, 'error');
    }
}
async function handleAddPayment(event) {
    event.preventDefault();
    const formData = new FormData(event.target);
    
    const paymentData = {
        record_date: formData.get('due_date'), // Data do registro
        type: 'income', // Tipo de registro financeiro (income = receita)
        amount: parseFloat(formData.get('amount')), // Valor
        description: `${formData.get('description')} - Tipo: ${formData.get('payment_type')}${formData.get('notes') ? ' - ' + formData.get('notes') : ''}`, // Descrição
        category: formData.get('payment_type') || 'venda_leite' // Categoria
    };

    try {
        // // const supabase = await getSupabaseClient(); // REMOVIDO // REMOVIDO - usando MySQL
        const { data: { user: currentUser } } = await supabase.auth.getUser();
        if (!currentUser) throw new Error('User not authenticated');

        // Get current user's farm_id
        const { data: managerData, error: managerError } = await supabase
            .from('users')
            .select('farm_id')
            .eq('id', currentUser.id)
            .single();

        if (managerError) throw managerError;
        if (!managerData?.farm_id) throw new Error('Farm not found');

        // Insert financial record into database
        const { error: paymentError } = await supabase
            .from('financial_records')
            .insert({
                ...paymentData,
                farm_id: managerData.farm_id,
                type: 'income'
            });

        if (paymentError) throw paymentError;

        showNotification('Venda adicionada com sucesso!', 'success');
        closePaymentModal();
        
        // Reload sales data and recent activities
        await loadPaymentsData();
        
        // Get user's farm_id for recent activities
        if (currentUser) {
            const { data: userData } = await supabase
                .from('users')
                .select('farm_id')
                .eq('email', currentUser.email)
                .single();
            
            if (userData?.farm_id) {
                await loadRecentActivities(userData.farm_id);
            }
        }
        
    } catch (error) {
        console.error('Error adding payment:', error);
        showNotification('Erro ao adicionar venda: ' + error.message, 'error');
    }
}

// Modal functions
function openAddUserModal() {
    document.getElementById('addUserModal').classList.add('show');
    
    // Reset do select para "Selecione o cargo" e esconder a seção de foto
    const userRoleSelect = document.getElementById('userRole');
    const addPhotoSection = document.getElementById('addPhotoSection');
    
    if (userRoleSelect && addPhotoSection) {
        // Definir como vazio para mostrar "Selecione o cargo"
        userRoleSelect.value = '';
        
        // Esconder a seção de foto por padrão
        addPhotoSection.style.display = 'none';
        addPhotoSection.style.visibility = 'hidden';
        addPhotoSection.style.opacity = '0';
    }
}

function closeAddUserModal() {
    document.getElementById('addUserModal').classList.remove('show');
    document.getElementById('addUserFormModal').reset();
    
    // Reset profile photo preview
    const preview = document.getElementById('profilePreview');
    const placeholder = document.getElementById('profilePlaceholder');
    if (preview && placeholder) {
        preview.classList.add('hidden');
        placeholder.classList.remove('hidden');
        preview.src = '';
    }
    
    // Reset email preview
    const emailPreview = document.getElementById('emailPreview');
    if (emailPreview) {
        emailPreview.textContent = 'Digite o nome para ver o email';
    }
}

// Generate email based on name and farm
async function generateUserEmail(name, farmId) {
    try {
        // Validate input parameters
        if (!name || typeof name !== 'string' || name.trim() === '') {
            throw new Error('Nome do usuário é obrigatório');
        }
        
        if (!farmId) {
            throw new Error('ID da fazenda é obrigatório');
        }
        
        // // const supabase = await getSupabaseClient(); // REMOVIDO // REMOVIDO - usando MySQL
        // Get farm name
        const { data: farmData, error: farmError } = await supabase
            .from('farms')
            .select('name')
            .eq('id', farmId)
            .single();

        if (farmError) throw farmError;
        
        if (!farmData || !farmData.name || typeof farmData.name !== 'string' || farmData.name.trim() === '') {
            throw new Error('Nome da fazenda não encontrado ou inválido');
        }
        
        // Sanitizar o nome da fazenda (tudo minúsculo, sem espaço, sem acento)
        const farmName = farmData.name
            .trim()
            .toLowerCase()
            .normalize('NFD')
            .replace(/[\u0300-\u036f]/g, '') // Remove acentos
            .replace(/\s+/g, '') // Remove espaços
            .replace(/[^a-z0-9]/g, ''); // Remove caracteres especiais
        
        // Extrair o primeiro nome do usuário
        const firstName = name.trim().split(' ')[0]
            .toLowerCase()
            .normalize('NFD')
            .replace(/[\u0300-\u036f]/g, '') // Remove acentos
            .replace(/[^a-z0-9]/g, ''); // Remove caracteres especiais
            
        // Validar se o primeiro nome não está vazio após sanitização
        if (!firstName) {
            throw new Error('Nome do usuário inválido após sanitização');
        }
        
        let finalEmail;
        let attempts = 0;
        const maxAttempts = 50; // Evitar loop infinito
        
        // Verificar se o e-mail já existe no banco
        while (attempts < maxAttempts) {
            // Gerar dois números aleatórios entre 10 e 99
            const num1 = Math.floor(Math.random() * 90) + 10; // 10-99
            const num2 = Math.floor(Math.random() * 90) + 10; // 10-99
            
            finalEmail = `${firstName}${num1}${num2}@${farmName}.lactech.com`;
            
            // Verificar se email já existe
            const { data: existingUser, error } = await supabase
                .from('users')
                .select('id')
                .eq('email', finalEmail)
                .maybeSingle(); // Use maybeSingle() em vez de single()
            
            if (error) {
                console.error('Error checking email:', error);
                throw error;
            }
            
            if (!existingUser) {
                // Email disponível, sair do loop
                break;
            }
            
            attempts++;
        }
        
        if (attempts >= maxAttempts) {
            throw new Error('Não foi possível gerar um email único após várias tentativas');
        }
        
        return finalEmail;
    } catch (error) {
        console.error('Error generating email:', error);
        throw error;
    }
}

// Update email preview
async function updateEmailPreview(name) {
    const emailPreview = document.getElementById('emailPreview');
    
    if (!emailPreview) {
        console.error('Email preview element not found');
        return;
    }
    
    if (!name || typeof name !== 'string' || name.trim() === '') {
        emailPreview.textContent = 'Digite o nome para ver o email';
        return;
    }
    
    try {
        // // const supabase = await getSupabaseClient(); // REMOVIDO // REMOVIDO - usando MySQL
        const { data: { user: currentUser } } = await supabase.auth.getUser();
        if (!currentUser) {
            emailPreview.textContent = 'Usuário não autenticado';
            return;
        }

        const { data: managerData, error: managerError } = await supabase
            .from('users')
            .select('farm_id')
            .eq('id', currentUser.id)
            .single();

        if (managerError) throw managerError;
        
        if (!managerData || !managerData.farm_id) {
            emailPreview.textContent = 'Fazenda não encontrada';
            return;
        }
        
        const email = await generateUserEmail(name, managerData.farm_id);
        emailPreview.textContent = email;
    } catch (error) {
        console.error('Error in updateEmailPreview:', error);
        emailPreview.textContent = 'Erro ao gerar email';
    }
}

async function hashPassword(password) {
    const encoder = new TextEncoder();
    const data = encoder.encode(password);
    const hash = await crypto.subtle.digest('SHA-256', data);
    const hashArray = Array.from(new Uint8Array(hash));
    const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    return hashHex;
}

async function sendWhatsAppCredentials(whatsapp, name, email, password) {
    try {
        let formattedNumber = whatsapp.replace(/\D/g, '');
        if (!formattedNumber.startsWith('55')) {
            formattedNumber = '55' + formattedNumber;
        }
        
        const message = `🌱 *LACTECH - Sistema de Gestão Leiteira* 🥛\n\n` +
            `🎉 *Olá ${name}!*\n\n` +
            `Suas credenciais de acesso foram criadas com sucesso:\n\n` +
            `📧 *Email:* ${email}\n` +
            `🔑 *Senha:* ${password}\n\n` +
            `⚠️ *INSTRUÇÕES IMPORTANTES:*\n` +
            `✅ Mantenha suas credenciais seguras\n` +
            `✅ Não compartilhe com terceiros\n\n` +
            `🌐 *Acesse o sistema:*\n` +
            `https://lacteste.netlify.app/\n\n` +
            `📱 *Suporte técnico disponível*\n` +
            `Em caso de dúvidas, entre em contato\n\n` +
            `🚀 *Bem-vindo(a) à equipe LacTech!*\n` +
            `Juntos, vamos revolucionar a gestão leiteira! 🐄💚`;
        
        // Copiar mensagem para área de transferência
        try {
            await navigator.clipboard.writeText(message);
            
            // Mostrar modal com instruções
            showWhatsAppInstructions(formattedNumber, name, message);
            
            return true;
        } catch (clipboardError) {
            console.error('Erro ao copiar para área de transferência:', clipboardError);
            // Fallback: mostrar modal mesmo sem copiar
            showWhatsAppInstructions(formattedNumber, name, message);
            return true;
        }
        
    } catch (error) {
        console.error('Error sending WhatsApp message:', error);
        return false;
    }
}

// Mostrar modal com instruções para envio manual
function showWhatsAppInstructions(phoneNumber, userName, message) {
    // Criar modal se não existir
    let modal = document.getElementById('whatsappInstructionsModal');
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'whatsappInstructionsModal';
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        modal.innerHTML = `
            <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4" onclick="event.stopPropagation()">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-900">📱 Enviar Credenciais via WhatsApp</h3>
                    <button onclick="closeWhatsAppInstructions()" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                
                <div class="space-y-4">
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                        <p class="text-sm text-green-800">
                            ✅ <strong>Mensagem copiada!</strong><br>
                            As credenciais foram copiadas para sua área de transferência.
                        </p>
                    </div>
                    
                    <div class="space-y-2">
                        <p class="text-sm font-medium text-gray-700">Para enviar as credenciais:</p>
                        <ol class="text-sm text-gray-600 space-y-1 list-decimal list-inside">
                            <li>Abra o WhatsApp no seu celular ou computador</li>
                            <li>Procure pelo contato: <strong>${phoneNumber}</strong></li>
                            <li>Cole a mensagem (Ctrl+V) e envie</li>
                        </ol>
                    </div>
                    
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                        <p class="text-xs text-blue-800">
                            💡 <strong>Dica:</strong> Você também pode clicar no botão abaixo para abrir o WhatsApp Web automaticamente.
                        </p>
                    </div>
                    
                    <div class="flex space-x-3">
                        <button onclick="openWhatsAppWeb('${phoneNumber}', '${encodeURIComponent(message)}')" 
                                class="flex-1 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors text-sm">
                            🌐 Abrir WhatsApp Web
                        </button>
                        <button onclick="copyMessageAgain('${encodeURIComponent(message)}')" 
                                class="flex-1 bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors text-sm">
                            📋 Copiar Novamente
                        </button>
                    </div>
                    
                    <button onclick="closeWhatsAppInstructions()" 
                            class="w-full bg-gray-100 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-200 transition-colors text-sm">
                        Fechar
                    </button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
    }
    
    // Adicionar evento de clique no overlay para fechar
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            closeWhatsAppInstructions();
        }
    });
    
    // Atualizar conteúdo do modal
    const phoneElement = modal.querySelector('strong');
    if (phoneElement) {
        phoneElement.textContent = phoneNumber;
    }
    
    // Mostrar modal
    modal.style.display = 'flex';
    
    // Adicionar evento de tecla ESC para fechar
    const handleEscape = function(e) {
        if (e.key === 'Escape') {
            closeWhatsAppInstructions();
            document.removeEventListener('keydown', handleEscape);
        }
    };
    document.addEventListener('keydown', handleEscape);
}

// Fechar modal de instruções
function closeWhatsAppInstructions() {
    const modal = document.getElementById('whatsappInstructionsModal');
    if (modal) {
        modal.style.display = 'none';
        // Remover modal do DOM para evitar conflitos
        modal.remove();
    }
}

// Abrir WhatsApp Web (opção alternativa)
function openWhatsAppWeb(phoneNumber, encodedMessage) {
    const whatsappUrl = `https://wa.me/${phoneNumber}?text=${encodedMessage}`;
    window.open(whatsappUrl, '_blank');
    closeWhatsAppInstructions();
}

// Copiar mensagem novamente
async function copyMessageAgain(encodedMessage) {
    try {
        const message = decodeURIComponent(encodedMessage);
        await navigator.clipboard.writeText(message);
        showNotification('Mensagem copiada novamente!', 'success');
    } catch (error) {
        console.error('Erro ao copiar mensagem:', error);
        showNotification('Erro ao copiar mensagem', 'error');
    }
}

// Handle add user - VERSÃO SIMPLES
/**
 * Manipula a criação de novos usuários
 * Valida dados, gera email automático e envia credenciais via WhatsApp
 */
async function handleAddUser(e) {
    console.log('🔍 handleAddUser chamada!');
    e.preventDefault();
    console.log('🔍 Evento prevenido');

    
    const formData = new FormData(e.target);
    
    const userData = {
        name: formData.get('name'),
        whatsapp: formData.get('whatsapp'),
        password: formData.get('password'),
        role: formData.get('role'),
        photo_url: null
    };
    
    try {
        console.log('🔍 Iniciando criação do usuário...');
        // // const supabase = await getSupabaseClient(); // REMOVIDO // REMOVIDO - usando MySQL
        console.log('🔍 Cliente Supabase obtido');
        const { data: { user: currentUser } } = await supabase.auth.getUser();
        console.log('🔍 Usuário atual:', currentUser);
        if (!currentUser) throw new Error('Usuário não autenticado');

        // Get current user's farm_id
        const { data: managerData, error: managerError } = await supabase
            .from('users')
            .select('farm_id')
            .eq('id', currentUser.id)
            .single();

        if (managerError) throw managerError;
        if (!managerData?.farm_id) throw new Error('Fazenda não encontrada');
        
        // Gerar email automaticamente
        const email = await generateEmailFromName(userData.name);
        
        // Usar a senha fornecida pelo usuário ou gerar uma temporária
        const password = userData.password || generateTempPassword();
        
        // Criar usuário no Supabase Auth primeiro
        const { data: authData, error: authError } = await supabase.auth.signUp({
            email: email,
            password: password,
            options: {
                data: {
                    name: userData.name,
                    role: userData.role,
                    whatsapp: userData.whatsapp
                }
            }
        });
        
        if (authError) {
            console.error('Erro ao criar usuário no Auth:', authError);
            throw new Error('Erro ao criar conta de usuário: ' + authError.message);
        }
        
        if (!authData.user) {
            throw new Error('Falha ao criar usuário no Auth');
        }
        
        // Criar perfil do usuário na tabela users usando o ID do Auth
        const { data: result, error: profileError } = await supabase.rpc('create_farm_user', {
            p_user_id: authData.user.id,
            p_email: email,
            p_name: userData.name,
            p_whatsapp: userData.whatsapp,
            p_role: userData.role,
            p_farm_id: managerData.farm_id,
            p_profile_photo_url: null
        });
        
        if (profileError) throw profileError;
        
        if (!result.success) {
            throw new Error(result.error || 'Falha ao criar usuário');
        }
        
        // Fazer upload da foto se for funcionário
        const profilePhotoFile = formData.get('profilePhoto');
        if (userData.role === 'funcionario' && profilePhotoFile && profilePhotoFile.size > 0) {
            console.log('🔍 Foto detectada, fazendo upload...');
            try {
                // Fazer upload da foto com o ID do usuário
                const profilePhotoUrl = await uploadProfilePhoto(profilePhotoFile, authData.user.id);
                
                // Atualizar usuário com a URL da foto
                const { error: updateError } = await supabase
                    .from('users')
                    .update({ profile_photo_url: profilePhotoUrl })
                    .eq('id', authData.user.id);
                    
                if (updateError) throw updateError;
                
                console.log('✅ Foto enviada com sucesso:', profilePhotoUrl);
                
            } catch (error) {
                console.error('❌ Erro ao fazer upload da foto:', error);
                // Continuar sem a foto se houver erro
            }
        }

        // Enviar WhatsApp com credenciais
        const whatsappSent = await sendWhatsAppCredentials(
            userData.whatsapp, 
            userData.name, 
            email, 
            password
        );
        
        const successMessage = whatsappSent ? 
            `Usuário ${userData.name} criado com sucesso! Credenciais enviadas via WhatsApp.` : 
            `Usuário ${userData.name} criado com sucesso! Senha: ${password}`;
            
        showNotification(successMessage, 'success');
        
        // Notificação REAL do dispositivo para criação de usuário
        if (window.nativeNotifications) {
            window.nativeNotifications.showRealDeviceNotification(
                'Novo Usuário Criado',
                `Usuário ${userData.name} (${userData.role}) foi criado no sistema`,
                'user_created'
            );
        }
        
        closeAddUserModal();
        
        // Atualizar lista de usuários
        setTimeout(() => {
            loadUsersData();
        }, 1000);

    } catch (error) {
        console.error('Erro ao criar usuário:', error);
        showNotification('Erro ao criar usuário: ' + error.message, 'error');
    }
}

function addUser() {
    openAddUserModal();
}

async function exportVolumeReport() {
    try {
        // // const supabase = await getSupabaseClient(); // REMOVIDO // REMOVIDO - usando MySQL
        // Buscar dados de volume de leite
        const { data: volumeData, error } = await supabase
            .from('volume_records')
            .select(`
                *,
                users(name, email)
            `)
            .order('created_at', { ascending: false });

        if (error) throw error;

        // Gerar relatório em formato PDF
        await generateVolumePDF(volumeData);
        
        showNotification('Relatório de Volume exportado com sucesso!', 'success');
        
        // Notificação de exportação de relatório - REMOVIDA (não é crítica)
    } catch (error) {
        showNotification('Erro ao exportar relatório de volume', 'error');
    }
}

async function exportQualityReport() {
    try {
        // // const supabase = await getSupabaseClient(); // REMOVIDO // REMOVIDO - usando MySQL
        // Buscar dados de qualidade
        const { data: qualityData, error } = await supabase
            .from('quality_records')
            .select('*')
            .order('created_at', { ascending: false });

        if (error) throw error;

        // Gerar relatório em formato PDF
        await generateQualityPDF(qualityData);
        
        showNotification('Relatório de Qualidade exportado com sucesso!', 'success');
    } catch (error) {
        showNotification('Erro ao exportar relatório de qualidade', 'error');
    }
}

// Função para gerar relatório de vendas
async function generatePaymentsReport() {
    try {
        // // const supabase = await getSupabaseClient(); // REMOVIDO // REMOVIDO - usando MySQL
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) throw new Error('User not authenticated');

        const { data: userData, error: userError } = await supabase
            .from('users')
            .select('farm_id')
            .eq('id', user.id)
            .single();
        
        if (userError) throw userError;

        // Buscar dados de vendas
        const { data: salesData, error } = await supabase
            .from('financial_records')
            .select('*')
            .eq('farm_id', userData.farm_id)
            .eq('type', 'income')
            .order('created_at', { ascending: false });

        if (error) throw error;

        // Gerar relatório em formato PDF
        await generatePaymentsPDF(salesData);
        
        showNotification('Relatório de Vendas gerado com sucesso!', 'success');
    } catch (error) {
        showNotification('Erro ao gerar relatório de vendas', 'error');
    }
}

// Helper functions for PDF generation
// Definição da logo do sistema (Base64 ou URL)
// Logo do sistema em SVG Base64 para uso nos relatórios
const systemLogo = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjQwIiBoZWlnaHQ9IjQwIiByeD0iOCIgZmlsbD0iIzJhN2YyYSIvPgo8cGF0aCBkPSJNMTIgMjhIMjhWMjRIMTJWMjhaIiBmaWxsPSJ3aGl0ZSIvPgo8cGF0aCBkPSJNMTYgMjBIMjRWMTZIMTZWMjBaIiBmaWxsPSJ3aGl0ZSIvPgo8cGF0aCBkPSJNMjAgMTJWMzJNMTIgMjBIMjhNMTYgMTZIMjQiIHN0cm9rZT0id2hpdGUiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIi8+Cjwvc3ZnPgo=';

// Configurações de Relatórios - variável global
window.reportSettings = {
    farmName: 'Fazenda',
    farmLogo: null
};

// Carregar configurações salvas
async function loadReportSettings() {
    try {
        window.reportSettings.farmName = 'Lagoa do Mato';
        window.reportSettings.farmLogo = null;
    } catch (error) {
        window.reportSettings.farmName = 'Lagoa do Mato';
    }
}

// Função para lidar com upload da logo da fazenda
async function handleFarmLogoUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    // Validar tipo de arquivo
    if (!file.type.startsWith('image/')) {
        showNotification('Por favor, selecione um arquivo de imagem válido', 'error');
        return;
    }
    
    // Validar tamanho do arquivo (máx. 2MB)
    if (file.size > 2 * 1024 * 1024) {
        showNotification('A imagem deve ter no máximo 2MB', 'error');
        return;
    }
    
    try {
        // Converter para base64
        const base64 = await fileToBase64(file);
        window.reportSettings.farmLogo = base64;
        
        // Atualizar preview
        updateFarmLogoPreview(base64);
        
        showNotification('Logo carregada com sucesso! Clique em "Salvar Configurações" para aplicar', 'success');
    } catch (error) {
        console.error('Erro ao processar logo:', error);
        showNotification('Erro ao processar a imagem', 'error');
    }
}

// Função para converter arquivo para base64
function fileToBase64(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
    });
}

// Função para atualizar preview da logo (compatibilidade com elementos que podem não existir)
function updateFarmLogoPreview(base64Logo) {
    const preview = document.getElementById('farmLogoPreview');
    const placeholder = document.getElementById('farmLogoPlaceholder');
    const image = document.getElementById('farmLogoImage');
    const removeBtn = document.getElementById('removeFarmLogo');
    
    // Verificar se os elementos existem antes de tentar atualizá-los
    if (!preview || !placeholder || !image || !removeBtn) {
        // Elementos não existem (modal foi removido), não fazer nada
        return;
    }
    
    if (base64Logo) {
        image.src = base64Logo;
        preview.classList.remove('hidden');
        placeholder.classList.add('hidden');
        removeBtn.classList.remove('hidden');
    } else {
        image.src = '';
        preview.classList.add('hidden');
        placeholder.classList.remove('hidden');
        removeBtn.classList.add('hidden');
    }
}
// Função para remover logo da fazenda (compatibilidade)
function removeFarmLogo() {
    window.reportSettings.farmLogo = null;
    updateFarmLogoPreview(null);
    
    // Limpar input file se existir
    const fileInput = document.getElementById('farmLogoUpload');
    if (fileInput) {
        fileInput.value = '';
    }
    
    // Só mostrar notificação se a função existir
    if (typeof showNotification === 'function') {
    showNotification('Logo removida! Clique em "Salvar Configurações" para aplicar', 'info');
    }
}

async function saveReportSettings() {
    try {
        // // const supabase = await getSupabaseClient(); // REMOVIDO // REMOVIDO - usando MySQL
        
        // Usar o nome da fazenda das configurações globais ou padrão
        const farmName = window.reportSettings.farmName || 'Fazenda';
        
        const { error } = await supabase.rpc('update_user_report_settings', {
            p_report_farm_name: farmName,
            p_report_farm_logo_base64: window.reportSettings.farmLogo,
            p_report_footer_text: null,
            p_report_system_logo_base64: null
        });
        
        if (error) throw error;

        if (error) throw error;

        window.reportSettings.farmName = farmName;
        
        showNotification('Configurações salvas com sucesso!', 'success');
    } catch (error) {
        console.error('Error saving report settings:', error);
        showNotification('Erro ao salvar configurações', 'error');
    }
}

// Carregar configurações ao inicializar
document.addEventListener('DOMContentLoaded', function() {
    loadReportSettings();
});

// Função para traduzir milking_type de inglês para português
function getMilkingTypeInPortuguese(milkingType) {
    const translation = {
        'morning': 'Manhã',
        'afternoon': 'Tarde',
        'evening': 'Noite',
        'night': 'Madrugada'
    };
    return translation[milkingType] || milkingType;
}

// Função para traduzir type de financial_records de inglês para português
function getFinancialTypeInPortuguese(type) {
    const translation = {
        'income': 'Receita',
        'expense': 'Despesa'
    };
    return translation[type] || type;
}

// Função para gerar email a partir do nome
async function generateEmailFromName(name) {
    try {
        const cleanName = name.toLowerCase()
            .normalize('NFD')
            .replace(/[\u0300-\u036f]/g, '') // Remove acentos
            .replace(/[^a-z0-9]/g, '') // Remove caracteres especiais
            .replace(/\s+/g, '.'); // Substitui espaços por pontos
        
        // Obter nome da fazenda
        const farmName = await getFarmName();
        const cleanFarmName = farmName.toLowerCase()
            .normalize('NFD')
            .replace(/[\u0300-\u036f]/g, '') // Remove acentos
            .replace(/[^a-z0-9]/g, '') // Remove caracteres especiais
            .replace(/\s+/g, ''); // Remove espaços
        
        // Obter próximo número sequencial para esta fazenda
        const nextNumber = await getNextUserNumber(farmName);
        
        return `${cleanName}${nextNumber}@${cleanFarmName}.lactech.com`;
    } catch (error) {
        console.error('Erro ao gerar email:', error);
        // Fallback simples
        const cleanName = name.toLowerCase()
            .normalize('NFD')
            .replace(/[\u0300-\u036f]/g, '')
            .replace(/[^a-z0-9]/g, '')
            .replace(/\s+/g, '.');
        return `${cleanName}@lactech.com`;
    }
}

// Função para obter próximo número sequencial de usuário
async function getNextUserNumber(farmName) {
    try {
        // // const supabase = await getSupabaseClient(); // REMOVIDO // REMOVIDO - usando MySQL
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) return '001';

        // Obter farm_id do usuário atual
        const { data: userData, error: userError } = await supabase
            .from('users')
            .select('farm_id')
            .eq('id', user.id)
            .order('created_at', { ascending: true })
            .single();
        
        if (userError || !userData?.farm_id) return '001';

        // Contar usuários existentes na mesma fazenda
        const { data: existingUsers, error: countError } = await supabase
            .from('users')
            .select('id')
            .eq('farm_id', userData.farm_id);
        
        if (countError) return '001';

        // Próximo número será o total + 1
        const nextNumber = (existingUsers?.length || 0) + 1;
        return nextNumber.toString().padStart(3, '0');
        
    } catch (error) {
        console.error('Erro ao obter próximo número:', error);
        return '001';
    }
}

// Função para gerar senha temporária
function generateTempPassword() {
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
    let password = '';
    for (let i = 0; i < 8; i++) {
        password += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return password;
}

// Função para prévia do relatório
function previewReport() {
    // Gerar um relatório de exemplo com as configurações atuais
    const sampleData = [
        {
            production_date: new Date().toISOString(),
            volume_liters: 150.5,
            milking_type: 'morning',
            notes: 'Registro de exemplo',
            users: { name: 'Funcionário Exemplo' }
        }
    ];
    
    generateVolumePDF(sampleData, true); // true indica que é uma prévia
}


// Toggle password visibility function for user forms
function toggleUserPasswordVisibility(inputId, buttonId) {
    const passwordInput = document.getElementById(inputId);
    const toggleButton = document.getElementById(buttonId);
    
    if (passwordInput && toggleButton) {
        if (passwordInput.type === 'password') {
            passwordInput.type = 'text';
            toggleButton.innerHTML = `
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.878 9.878L3 3m6.878 6.878L21 21"></path>
                </svg>
            `;
        } else {
            passwordInput.type = 'password';
            toggleButton.innerHTML = `
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                </svg>
            `;
        }
    }
}



// Upload profile photo to Supabase Storage
async function uploadProfilePhoto(file, userId) {
    try {
        // // const supabase = await getSupabaseClient(); // REMOVIDO // REMOVIDO - usando MySQL
        
        // Get current authenticated user
        const { data: { user }, error: authError } = await supabase.auth.getUser();
        
        if (authError || !user) {
            console.error('DEBUG: Falha na autenticação:', authError);
            throw new Error('Usuário não autenticado');
        }
        
        // Get current user's farm_id for organizing photos by farm

        const { data: managerData, error: managerError } = await supabase
            .from('users')
            .select('farm_id')
            .eq('id', user.id)
            .single();
        

        
        if (managerError || !managerData?.farm_id) {
            console.error('DEBUG: Fazenda não encontrada:', managerError);
            throw new Error('Farm not found');
        }
        
        const fileExt = file.name.split('.').pop();
        // Ensure we always use the target userId, never fallback to current user
        if (!userId) {
            throw new Error('userId é obrigatório para upload de foto');
        }
        
        // Create unique filename with more specific naming
        const timestamp = Date.now();
        const randomId = Math.random().toString(36).substr(2, 9);
        const fileName = `user_${userId}_${timestamp}_${randomId}.${fileExt}`;
        const filePath = `farm_${managerData.farm_id}/${fileName}`;
        
        const { data, error } = await supabase.storage
            .from('profile-photos')
            .upload(filePath, file, {
                cacheControl: '3600',
                upsert: false
            });
        

        
        if (error) {
            console.error('DEBUG: Erro no upload:', {
                message: error.message,
                statusCode: error.statusCode,
                error: error
            });
            throw error;
        }
        

        
        const { data: { publicUrl } } = supabase.storage
            .from('profile-photos')
            .getPublicUrl(filePath);
        

        return publicUrl;
    } catch (error) {
        console.error('DEBUG: Erro final:', {
            message: error.message,
            stack: error.stack,
            error: error
        });
        throw error;
    }
}

// Function to refresh users list without reloading photos
async function refreshUsersListOnly() {

    try {
        // // const supabase = await getSupabaseClient(); // REMOVIDO // REMOVIDO - usando MySQL
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) {
            return;
        }
        
        // Get current user's farm_id
        const { data: userData, error: userError } = await supabase
            .from('users')
            .select('farm_id')
            .eq('id', user.id)
            .single();
        
        if (userError || !userData?.farm_id) {
            return;
        }
        
        // Get all users from the same farm (without photos to avoid cache issues)
        const { data: allUsers, error } = await supabase
            .from('users')
            .select('id, name, email, role, whatsapp, is_active, created_at')
            .eq('farm_id', userData.farm_id)
            .order('created_at', { ascending: false });
        
        if (error) {
            return;
        }
        
        // Update counts only
        if (allUsers) {
            const employeesCount = allUsers.filter(u => u.role === 'funcionario').length;
            const veterinariansCount = allUsers.filter(u => u.role === 'veterinario').length;
            const managersCount = allUsers.filter(u => u.role === 'gerente').length;
            const totalUsers = allUsers.length;
            
            document.getElementById('totalUsers').textContent = totalUsers;
            document.getElementById('employeesCount').textContent = employeesCount;
            document.getElementById('veterinariansCount').textContent = veterinariansCount;
            document.getElementById('managersCount').textContent = managersCount;
        }
        
    } catch (error) {
        console.error('DEBUG: Erro no refreshUsersListOnly:', error);
    }
}

// Function to update a specific user's photo in the list
async function updateUserPhotoInList(userId, newPhotoUrl) {

    
    try {
        const photoElement = document.getElementById(`user-photo-${userId}`);
        const iconElement = document.getElementById(`user-icon-${userId}`);
        
        if (photoElement && newPhotoUrl) {
            // Update the photo with cache buster
            const cacheBuster = Date.now();
            photoElement.src = newPhotoUrl + '?cb=' + cacheBuster;
            photoElement.style.display = 'block';
            
            if (iconElement) {
                iconElement.style.display = 'none';
            }
            

        } else if (iconElement && !newPhotoUrl) {
            // Show icon if no photo
            if (photoElement) {
                photoElement.style.display = 'none';
            }
            iconElement.style.display = 'flex';
            

        }
        
    } catch (error) {
        console.error('DEBUG: Erro ao atualizar foto na lista:', error);
    }
}
// Debug function to check all users photos
async function debugCheckAllPhotos() {

    try {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) {
            return;
        }
        
        // Get current user's farm_id
        const { data: userData, error: userError } = await supabase
            .from('users')
            .select('farm_id')
            .eq('id', user.id)
            .single();
        
        if (userError || !userData?.farm_id) {
            return;
        }
        
        // Get all users from the same farm
        const { data: allUsers, error } = await supabase
            .from('users')
            .select('id, name, email, role, profile_photo_url, created_at')
            .eq('farm_id', userData.farm_id)
            .order('created_at', { ascending: false });
        
        if (error) {
            return;
        }
        

        
    } catch (error) {
        console.error('DEBUG: Erro na verificação:', error);
    }
}

// Sign out function
async function signOut() {
        // Notificação de logout iniciado - REMOVIDA (não é crítica)
    
    showLogoutConfirmationModal();
}

// Função para mostrar modal de confirmação de logout
function showLogoutConfirmationModal() {
    // Criar modal se não existir
    let modal = document.getElementById('logoutConfirmationModal');
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'logoutConfirmationModal';
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[9999]';
        modal.innerHTML = `
            <div class="bg-white  rounded-2xl p-6 max-w-md w-full mx-4 shadow-2xl" onclick="event.stopPropagation()">
                <div class="text-center">
                    <!-- Ícone de logout -->
                    <div class="w-16 h-16 bg-red-100 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <svg class="w-8 h-8 text-red-600 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                        </svg>
                    </div>
                    
                    <!-- Título -->
                    <h3 class="text-xl font-bold text-gray-900  mb-2">
                        Confirmar Saída
                    </h3>
                    
                    <!-- Mensagem -->
                    <p class="text-gray-600  mb-6">
                        Tem certeza que deseja sair do sistema?
                    </p>
                    
                    <!-- Botões -->
                    <div class="flex space-x-3">
                        <button onclick="closeLogoutModal()" 
                                class="flex-1 px-4 py-3 border border-gray-300 border-gray-300 text-gray-700  font-medium rounded-xl hover:bg-gray-50 hover:bg-gray-50 transition-all">
                            Cancelar
                        </button>
                        <button onclick="confirmLogout()" 
                                class="flex-1 px-4 py-3 bg-red-600 hover:bg-red-700 text-white font-medium rounded-xl transition-all">
                            Sair
                        </button>
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
    }
    
    // Adicionar evento de clique no overlay para fechar
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            closeLogoutModal();
        }
    });
    
    // Adicionar evento de tecla ESC para fechar
    const escHandler = function(e) {
        if (e.key === 'Escape') {
            closeLogoutModal();
            document.removeEventListener('keydown', escHandler);
        }
    };
    document.addEventListener('keydown', escHandler);
    
    // Mostrar modal
    modal.style.display = 'flex';
}

// Função para fechar modal de logout
function closeLogoutModal() {
    console.log('🔒 Fechando modal de logout...');
    const modal = document.getElementById('logoutConfirmationModal');
    if (modal) {
        modal.style.display = 'none';
        modal.style.visibility = 'hidden';
        modal.style.opacity = '0';
        modal.style.pointerEvents = 'none';
        console.log('✅ Modal de logout fechado');
    } else {
        console.error('❌ Modal de logout não encontrado');
    }
}

// Função para confirmar logout
async function confirmLogout() {
    try {
        console.log('🚪 Iniciando logout...');
        closeLogoutModal();
        
        // Mostrar loading
        showNotification('Saindo do sistema...', 'info');
        
        // Notificação de logout em progresso - REMOVIDA (não é crítica)
        
        // Limpar atualizações em tempo real
        cleanupRealtimeUpdates();
        
        clearUserSession(); // Use new clearUserSession function
        // // const supabase = await getSupabaseClient(); // REMOVIDO // REMOVIDO - usando MySQL
        await supabase.auth.signOut();
        console.log('✅ Logout realizado com sucesso');
        
        // Notificação de logout concluído - REMOVIDA (não é crítica)
        
        safeRedirect('index.php'); // Use new safeRedirect function
    } catch (error) {
        console.error('❌ Erro no logout:', error);
        clearUserSession();
        safeRedirect('index.php');
    }
}

// Função para carregar dados da conta secundária existente
async function loadSecondaryAccountData() {
    try {
        // // const supabase = await getSupabaseClient(); // REMOVIDO // REMOVIDO - usando MySQL
        // Get current user data
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) {
            console.error('Usuário não autenticado');
            return;
        }
        
        // Get user details from users table
        const { data: userData, error: userError } = await supabase
            .from('users')
            .select('*')
            .eq('id', user.id)
            .single();
            
        if (userError) {
            console.error('Erro ao buscar dados do usuário:', userError);
            return;
        }
        
        // Verificar se existe uma conta secundária usando a tabela secondary_accounts
        let secondaryAccountRelation = null;
        try {
            const { data: relationData, error: relationError } = await supabase
                .from('secondary_accounts')
                .select('secondary_account_id')
                .eq('primary_account_id', user.id)
                .maybeSingle();
                
            if (relationError) {
                console.error('Erro ao verificar relação de conta secundária:', relationError);
            } else {
                secondaryAccountRelation = relationData;
            }
        } catch (error) {
            console.error('Erro ao acessar tabela secondary_accounts:', error);
        }
        
        // Se não encontrou na tabela de relações, tenta o método antigo
        if (!secondaryAccountRelation) {
            try {
                // Check if secondary account exists by email
                const { data: secondaryAccount, error: secondaryError } = await supabase
                    .from('users')
                    .select('*')
                    .eq('email', userData.email)
                    .eq('farm_id', userData.farm_id)
                    .neq('id', userData.id)
                    .maybeSingle();
                
                if (secondaryError) {
                    console.error('Erro ao verificar conta secundária:', secondaryError);
                }
                
                if (secondaryAccount) {
                    // Preencher o formulário com os dados da conta secundária
                    const nameField = document.getElementById('secondaryAccountName');
                    const roleField = document.getElementById('secondaryAccountRole');
                    const activeField = document.getElementById('secondaryAccountActive');
                    
                    if (nameField) nameField.value = secondaryAccount.name;
                    if (roleField) roleField.value = secondaryAccount.role;
                    if (activeField) activeField.checked = secondaryAccount.is_active;
                    
                    // Atualizar o status da conta secundária
                    const noAccountDiv = document.getElementById('noSecondaryAccount');
                    const hasAccountDiv = document.getElementById('hasSecondaryAccount');
                    const nameDisplay = document.getElementById('secondaryAccountNameDisplay');
                    const switchBtn = document.getElementById('switchAccountBtn');
                    
                    if (noAccountDiv) noAccountDiv.style.display = 'none';
                    if (hasAccountDiv) hasAccountDiv.style.display = 'block';
                    if (nameDisplay) nameDisplay.textContent = secondaryAccount.name;
                    if (switchBtn) switchBtn.disabled = false;
                    
                    // Criar a relação na tabela secondary_accounts se não existir
                    try {
                        const { error: insertError } = await supabase
                            .from('secondary_accounts')
                            .insert([
                                {
                                    primary_account_id: user.id,
                                    secondary_account_id: secondaryAccount.id
                                }
                            ]);
                            
                        if (insertError && !insertError.message.includes('duplicate key')) {
                            console.error('Erro ao criar relação de conta secundária:', insertError);
                        }
                    } catch (error) {
                        console.error('Erro ao criar relação:', error);
                    }
                } else {
                    // Limpar o formulário
                    const nameField = document.getElementById('secondaryAccountName');
                    const roleField = document.getElementById('secondaryAccountRole');
                    const activeField = document.getElementById('secondaryAccountActive');
                    
                    if (nameField) nameField.value = '';
                    if (roleField) roleField.value = 'funcionario';
                    if (activeField) activeField.checked = true;
                    
                    // Atualizar o status da conta secundária
                    const noAccountDiv = document.getElementById('noSecondaryAccount');
                    const hasAccountDiv = document.getElementById('hasSecondaryAccount');
                    const switchBtn = document.getElementById('switchAccountBtn');
                    
                    if (noAccountDiv) noAccountDiv.style.display = 'block';
                    if (hasAccountDiv) hasAccountDiv.style.display = 'none';
                    if (switchBtn) switchBtn.disabled = true;
                }
            } catch (error) {
                console.error('Erro ao verificar conta secundária:', error);
            }
        } else {
            try {
                // Buscar os dados da conta secundária usando o ID da relação
                const { data: secondaryAccount, error: accountError } = await supabase
                    .from('users')
                    .select('*')
                    .eq('id', secondaryAccountRelation.secondary_account_id)
                    .single();
                    
                if (accountError) {
                    console.error('Erro ao buscar dados da conta secundária:', accountError);
                    return;
                }
                
                // Preencher o formulário com os dados da conta secundária
                const nameField = document.getElementById('secondaryAccountName');
                const roleField = document.getElementById('secondaryAccountRole');
                const activeField = document.getElementById('secondaryAccountActive');
                
                if (nameField) nameField.value = secondaryAccount.name;
                if (roleField) roleField.value = secondaryAccount.role;
                if (activeField) activeField.checked = secondaryAccount.is_active;
                
                // Atualizar o status da conta secundária
                const noAccountDiv = document.getElementById('noSecondaryAccount');
                const hasAccountDiv = document.getElementById('hasSecondaryAccount');
                const nameDisplay = document.getElementById('secondaryAccountNameDisplay');
                const switchBtn = document.getElementById('switchAccountBtn');
                
                if (noAccountDiv) noAccountDiv.style.display = 'none';
                if (hasAccountDiv) hasAccountDiv.style.display = 'block';
                if (nameDisplay) nameDisplay.textContent = secondaryAccount.name;
                if (switchBtn) switchBtn.disabled = false;
            } catch (error) {
                console.error('Erro ao buscar dados da conta secundária:', error);
            }
        }
    } catch (error) {
        console.error('Erro ao carregar dados da conta secundária:', error);
    }
}

// Função para salvar a conta secundária
async function saveSecondaryAccount(event) {
    event.preventDefault();
    
    try {
        // Mostrar indicador de carregamento
        const submitBtn = event.target.querySelector('button[type="submit"]');
        const originalBtnText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<svg class="animate-spin h-5 w-5 mr-2" viewBox="0 0 24 24" fill="none"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Salvando...';
        submitBtn.disabled = true;
        
        // Get current user data
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) {
            console.error('Usuário não autenticado');
            return;
        }
        
        // Get user details from users table
        const { data: userData, error: userError } = await supabase
            .from('users')
            .select('*')
            .eq('id', user.id)
            .single();
            
        if (userError) {
            console.error('Erro ao buscar dados do usuário:', userError);
            return;
        }
        
        // Get form data
        const secondaryRole = document.getElementById('secondaryAccountRole').value;
        const roleSuffix = secondaryRole === 'veterinario' ? ' (Veterinário)' : ' (Funcionário)';
        const secondaryName = document.getElementById('secondaryAccountName').value.trim() || userData.name + roleSuffix;
        const isActive = document.getElementById('secondaryAccountActive').checked;
        
        // Gerar email único para a conta secundária
        const secondaryEmail = userData.email + (secondaryRole === 'veterinario' ? '.vet' : '.func');
        
        // Verificar se já existe uma conta secundária com o mesmo email modificado
        const { data: existingAccount, error: checkError } = await supabase
            .from('users')
            .select('*')
            .eq('email', secondaryEmail)
            .eq('farm_id', userData.farm_id)
            .maybeSingle();
        
        let secondaryAccount;
        
        if (!checkError && existingAccount) {
            // Update existing account
            const { data: updatedAccount, error: updateError } = await supabase
                .from('users')
                .update({
                    name: secondaryName,
                    role: secondaryRole,
                    is_active: isActive
                })
                .eq('id', existingAccount.id)
                .select()
                .single();
                
            if (updateError) {
                console.error('Erro ao atualizar conta secundária:', updateError);
                showNotification('Erro ao atualizar conta secundária. Por favor, tente novamente.', 'error');
                return;
            }
            
            secondaryAccount = updatedAccount;
            showNotification('Conta secundária atualizada com sucesso!', 'success');
            
            // Verificar se já existe uma relação na tabela secondary_accounts
            const { data: existingRelation, error: relationError } = await supabase
                .from('secondary_accounts')
                .select('*')
                .eq('primary_account_id', user.id)
                .eq('secondary_account_id', secondaryAccount.id)
                .single();
                
            if (relationError && relationError.code !== 'PGRST116') {
                console.error('Erro ao verificar relação de conta secundária:', relationError);
            }
            
            // Se não existir relação, criar uma
            if (!existingRelation) {
                const { error: insertError } = await supabase
                    .from('secondary_accounts')
                    .insert([
                        {
                            primary_account_id: user.id,
                            secondary_account_id: secondaryAccount.id
                        }
                    ]);
                    
                if (insertError) {
                    console.error('Erro ao criar relação de conta secundária:', insertError);
                }
            }
        } else {
            // Create new secondary account
            
            // Verificar se já existe um usuário com o mesmo email e farm_id
            const { data: existingUsers, error: existingError } = await supabase
                .from('users')
                .select('*')
                .eq('email', secondaryEmail)
                .eq('farm_id', userData.farm_id)
                .neq('id', userData.id);
                
            if (existingError) {
                console.error('Erro ao verificar usuários existentes:', existingError);
            } else {

                
                // Se já existir um usuário secundário, atualizar em vez de criar
                if (existingUsers && existingUsers.length > 0) {
                    const { data: updatedAccount, error: updateError } = await supabase
                        .from('users')
                        .update({
                            name: secondaryName,
                            role: secondaryRole,
                            is_active: isActive
                        })
                        .eq('id', existingUsers[0].id)
                        .select()
                        .single();
                        
                    if (updateError) {
                        console.error('Erro ao atualizar conta secundária existente:', updateError);
                        showNotification('Erro ao atualizar conta secundária. Por favor, tente novamente.', 'error');
                        return;
                    }
                    
                    secondaryAccount = updatedAccount;
                    showNotification('Conta secundária atualizada com sucesso!', 'success');
                    
                    // Verificar se já existe uma relação na tabela secondary_accounts
                    const { data: existingRelation, error: relationError } = await supabase
                        .from('secondary_accounts')
                        .select('*')
                        .eq('primary_account_id', user.id)
                        .eq('secondary_account_id', secondaryAccount.id)
                        .single();
                        
                    if (relationError && relationError.code !== 'PGRST116') {
                        console.error('Erro ao verificar relação de conta secundária:', relationError);
                    }
                    
                    // Se não existir relação, criar uma
                    if (!existingRelation) {
                        const { error: insertError } = await supabase
                            .from('secondary_accounts')
                            .insert([
                                {
                                    primary_account_id: user.id,
                                    secondary_account_id: secondaryAccount.id
                                }
                            ]);
                            
                        if (insertError) {
                            console.error('Erro ao criar relação de conta secundária:', insertError);
                        }
                    }
                } else {
                    // Create new secondary account
                    const { data: newAccount, error: createError } = await supabase
                        .from('users')
                        .insert([
                            {
                                farm_id: userData.farm_id,
                                name: secondaryName,
                                email: secondaryEmail,
                                role: secondaryRole,
                                whatsapp: userData.whatsapp,
                                is_active: isActive,
                                profile_photo_url: userData.profile_photo_url
                            }
                        ])
                        .select()
                        .single();
                        
                    if (createError) {
                        console.error('Erro ao criar nova conta secundária:', createError);
                        showNotification('Erro ao criar nova conta secundária. Por favor, tente novamente.', 'error');
                        return;
                    }
                    
                    secondaryAccount = newAccount;
                    showNotification('Nova conta secundária criada com sucesso!', 'success');
                    
                    // Create relation in secondary_accounts table
                    const { error: insertError } = await supabase
                        .from('secondary_accounts')
                        .insert([
                            {
                                primary_account_id: user.id,
                                secondary_account_id: secondaryAccount.id
                            }
                        ]);
                        
                    if (insertError) {
                        console.error('Erro ao criar relação de conta secundária:', insertError);
                    }
                }
            }
        }
    } catch (error) {
        console.error('Erro ao salvar conta secundária:', error);
        showNotification('Erro ao salvar conta secundária. Por favor, tente novamente.', 'error');
    } finally {
        // Restaurar botão de salvar
        const submitBtn = event.target.querySelector('button[type="submit"]');
        submitBtn.innerHTML = originalBtnText;
        submitBtn.disabled = false;
    }
}

// Função para alternar a visibilidade do painel de contas
function toggleAccountsPanel() {
    const panel = document.getElementById('accountsPanel');
    if (panel.classList.contains('hidden')) {
        panel.classList.remove('hidden');
        loadAccountCards();
    } else {
        panel.classList.add('hidden');
    }
}

// Função para carregar os cards de contas
async function loadAccountCards() {
    try {
        // Get current user data
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) {
            console.error('Usuário não autenticado');
            return;
        }
        
        // Get user details from users table
        const { data: userData, error: userError } = await supabase
            .from('users')
            .select('*')
            .eq('id', user.id)
            .single();
            
        if (userError) {
            console.error('Erro ao buscar dados do usuário:', userError);
            return;
        }
        
        // Limpar o container de cards
        const cardsContainer = document.getElementById('accountCards');
        cardsContainer.innerHTML = '';
        
        // Adicionar card da conta principal
        const primaryCard = document.createElement('div');
        primaryCard.className = 'bg-white border border-blue-100 rounded-xl p-4 shadow-sm hover:shadow-md transition-all';
        primaryCard.innerHTML = `
            <div class="flex items-center space-x-3">
                <div class="flex-shrink-0">
                    <div class="w-12 h-12 rounded-full bg-forest-100 flex items-center justify-center text-forest-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                        </svg>
                    </div>
                </div>
                <div class="flex-1">
                    <h5 class="font-medium text-blue-900">${userData.name}</h5>
                    <p class="text-sm text-blue-600 capitalize">${userData.role}</p>
                </div>
                <div>
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-forest-100 text-forest-800">
                        Atual
                    </span>
                </div>
            </div>
        `;
        cardsContainer.appendChild(primaryCard);
        
        // Buscar contas secundárias na tabela secondary_accounts
        const { data: secondaryRelations, error: relError } = await supabase
            .from('secondary_accounts')
            .select('secondary_account_id')
            .eq('primary_account_id', user.id);
            
        if (relError) {
            console.error('Erro ao buscar relações de contas secundárias:', relError);
            return;
        }
        
        if (secondaryRelations && secondaryRelations.length > 0) {
            // Buscar detalhes de cada conta secundária
            for (const relation of secondaryRelations) {
                const { data: secondaryAccount, error: accountError } = await supabase
                    .from('users')
                    .select('*')
                    .eq('id', relation.secondary_account_id)
                    .single();
                    
                if (accountError) {
                    console.error('Erro ao buscar detalhes da conta secundária:', accountError);
                    continue;
                }
                
                // Criar card para a conta secundária
                const secondaryCard = document.createElement('div');
                secondaryCard.className = 'bg-white border border-blue-100 rounded-xl p-4 shadow-sm hover:shadow-md transition-all';
                secondaryCard.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <div class="flex-shrink-0">
                            <div class="w-12 h-12 rounded-full bg-blue-100 flex items-center justify-center text-blue-600">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                </svg>
                            </div>
                        </div>
                        <div class="flex-1">
                            <h5 class="font-medium text-blue-900">${secondaryAccount.name}</h5>
                            <p class="text-sm text-blue-600 capitalize">${secondaryAccount.role}</p>
                        </div>
                        <div>
                            <button onclick="switchToAccount('${secondaryAccount.id}');" class="px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium rounded-lg transition-all">
                                Alternar
                            </button>
                        </div>
                    </div>
                `;
                cardsContainer.appendChild(secondaryCard);
            }
        } else {
            // Se não encontrou contas secundárias, mostrar mensagem
            const noAccountsMessage = document.createElement('div');
            noAccountsMessage.className = 'text-center p-4 text-blue-600';
            noAccountsMessage.innerHTML = `
                <p>Você ainda não possui contas secundárias configuradas.</p>
                <button onclick="showSecondaryAccountForm();" class="mt-2 px-3 py-1 bg-forest-500 hover:bg-forest-600 text-white text-sm font-medium rounded-lg transition-all">
                    Configurar Conta
                </button>
            `;
            cardsContainer.appendChild(noAccountsMessage);
        }
    } catch (error) {
        console.error('Erro ao carregar cards de contas:', error);
    }
}

// Função para alternar para uma conta específica
async function switchToAccount(accountId) {
    try {
        // Get current user data
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) {
            console.error('Usuário não autenticado');
            return;
        }
        
        // Get user details from users table
        const { data: userData, error: userError } = await supabase
            .from('users')
            .select('*')
            .eq('id', user.id)
            .single();
            
        if (userError) {
            console.error('Erro ao buscar dados do usuário:', userError);
            return;
        }
        
        // Store current role in session storage
        sessionStorage.setItem('previous_role', userData.role);
        
        // Get secondary account details
        const { data: secondaryAccount, error: secondaryError } = await supabase
            .from('users')
            .select('*')
            .eq('id', accountId)
            .single();
        
        if (secondaryError) {
            console.error('Erro ao buscar conta secundária:', secondaryError);
            return;
        }
        
        if (!secondaryAccount.is_active) {
            showNotification('Esta conta está desativada. Por favor, ative-a nas configurações.', 'warning');
            showSecondaryAccountForm();
            return;
        }
        
        // Secondary account exists and is active, switch to it

        
        // Store current user session data
        const currentSession = {
            id: userData.id,
            email: userData.email,
            name: userData.name,
            user_type: userData.role,
            farm_id: userData.farm_id,
            farm_name: sessionStorage.getItem('farm_name') || ''
        };
        
        // Store secondary account session data
        const secondarySession = {
            id: secondaryAccount.id,
            email: secondaryAccount.email,
            name: secondaryAccount.name,
            user_type: secondaryAccount.role,
            farm_id: secondaryAccount.farm_id,
            farm_name: sessionStorage.getItem('farm_name') || ''
        };
        // Save current session for later
        sessionStorage.setItem('primary_account', JSON.stringify(currentSession));
        
        // Set new session
        sessionStorage.setItem('user', JSON.stringify(secondarySession));
        
        // Redirect to appropriate page based on role
        if (secondaryAccount.role === 'funcionario') {
            window.location.href = 'funcionario.php';
        } else if (secondaryAccount.role === 'veterinario') {
            window.location.href = 'veterinario.php';
        } else {
            showNotification('Conta secundária encontrada, mas o tipo não é reconhecido.', 'warning');
        }
    } catch (error) {
        console.error('Erro ao alternar conta:', error);
        showNotification('Ocorreu um erro ao alternar para a conta secundária.', 'error');
    }
}

// Function to switch between manager and inseminator accounts (mantido para compatibilidade)
async function switchToSecondaryAccount() {
    try {
        // Get current user data
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) {
            console.error('Usuário não autenticado');
            return;
        }
        
        const { data: secondaryRelations, error: relError } = await supabase
            .from('secondary_accounts')
            .select('secondary_account_id')
            .eq('primary_account_id', user.id);
            
        if (relError || !secondaryRelations || secondaryRelations.length === 0) {
            showNotification('Você precisa configurar uma conta secundária primeiro.', 'warning');
            showSecondaryAccountForm();
            return;
        }
        
        if (secondaryRelations.length > 1) {
            toggleAccountsPanel();
            return;
        }
        
        switchToAccount(secondaryRelations[0].secondary_account_id);
    } catch (error) {
        console.error('Erro ao alternar conta:', error);
        showNotification('Ocorreu um erro ao alternar para a conta secundária.', 'error');
    }
}


async function checkIfSecondaryAccount() {
    try {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) return false;
        
        const { data: relation, error } = await supabase
            .from('secondary_accounts')
            .select('primary_account_id')
            .eq('secondary_account_id', user.id)
            .single();
        
        if (error || !relation) {
            return false;
        }
        
        return true;
    } catch (error) {
        console.error('Erro ao verificar se é conta secundária:', error);
        return false;
    }
}

async function showAlterSecondaryAccountSection() {
    const isSecondary = await checkIfSecondaryAccount();
    const alterSection = document.getElementById('alterSecondaryAccountSection');
    
    if (alterSection) {
        if (isSecondary) {
            alterSection.style.display = 'block';
    
        } else {
            alterSection.style.display = 'none';
    
        }
    }
}

// Função para mostrar formulário de alteração de conta secundária
function showAlterSecondaryAccountForm() {
    const form = document.getElementById('secondaryAccountForm');
    const alterBtn = document.getElementById('alterSecondaryAccountBtn');
    
    if (form) {
        form.style.display = 'block';
        // Mudar o texto do botão para indicar que é uma alteração
        const submitBtn = form.querySelector('button[type="submit"]');
        if (submitBtn) {
            submitBtn.innerHTML = 'Alterar Conta Secundária';
        }
        
        // Carregar dados atuais da conta
        loadCurrentSecondaryAccountData();
    }
    
    if (alterBtn) {
        alterBtn.style.display = 'none';
    }
}

// Função para carregar dados atuais da conta secundária
async function loadCurrentSecondaryAccountData() {
    try {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) return;
        
        // Buscar dados atuais do usuário
        const { data: userData, error } = await supabase
            .from('users')
            .select('name, email, role, is_active')
            .eq('id', user.id)
            .single();
        
        if (error) {
            console.error('Erro ao carregar dados atuais:', error);
            return;
        }
        
        // Preencher formulário com dados atuais
        const nameField = document.getElementById('secondaryAccountName');
        const roleField = document.getElementById('secondaryAccountRole');
        const activeField = document.getElementById('secondaryAccountActive');
        
        if (nameField) nameField.value = userData.name || '';
        if (roleField) roleField.value = userData.role || 'funcionario';
        if (activeField) activeField.checked = userData.is_active || false;
        

        
    } catch (error) {
        console.error('Erro ao carregar dados atuais:', error);
    }
}

// Função para salvar alterações da conta secundária
async function saveSecondaryAccountAlteration(event) {
    event.preventDefault();
    
    try {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) {
            showNotification('Usuário não autenticado', 'error');
            return;
        }
        
        // Obter dados do formulário
        const name = document.getElementById('secondaryAccountName').value.trim();
        const role = document.getElementById('secondaryAccountRole').value;
        const isActive = document.getElementById('secondaryAccountActive').checked;
        
        if (!name) {
            showNotification('Por favor, informe o nome da conta.', 'warning');
            return;
        }
        
        // Atualizar dados do usuário
        const { data: updatedUser, error: updateError } = await supabase
            .from('users')
            .update({
                name: name,
                role: role,
                is_active: isActive
            })
            .eq('id', user.id)
            .select()
            .single();
        
        if (updateError) {
            console.error('Erro ao atualizar conta:', updateError);
            showNotification('Erro ao atualizar a conta secundária.', 'error');
            return;
        }
        
        // Atualizar dados da sessão
        const sessionData = {
            id: updatedUser.id,
            email: updatedUser.email,
            name: updatedUser.name,
            role: updatedUser.role,
            farm_id: updatedUser.farm_id,
            is_active: updatedUser.is_active
        };
        
        localStorage.setItem('userData', JSON.stringify(sessionData));
        
        // Esconder formulário
        hideSecondaryAccountForm();
        
        // Mostrar modal de sucesso
        showSecondaryAccountSuccessModal(updatedUser, 'alteracao');
        
        // Recarregar dados da página
        await loadUserProfile();
        await setManagerName();
        

        
    } catch (error) {
        console.error('Erro ao alterar conta secundária:', error);
        showNotification('Ocorreu um erro ao alterar a conta secundária.', 'error');
    }
}

// Modificar a função showSecondaryAccountSuccessModal para suportar alterações
function showSecondaryAccountSuccessModal(account, action = 'criacao') {
    const modal = document.getElementById('secondaryAccountSuccessModal');
    const title = document.getElementById('successModalTitle');
    const message = document.getElementById('successModalMessage');
    const name = document.getElementById('successAccountName');
    const role = document.getElementById('successAccountRole');
    const email = document.getElementById('successAccountEmail');
    
    if (modal && title && message && name && role && email) {
        if (action === 'alteracao') {
            title.textContent = 'Conta Secundária Alterada!';
            message.textContent = 'Suas informações foram atualizadas com sucesso.';
        } else {
            title.textContent = 'Conta Secundária Criada!';
            message.textContent = 'Sua conta secundária foi configurada com sucesso.';
        }
        
        name.textContent = account.name || 'Não informado';
        role.textContent = account.role || 'Não informado';
        email.textContent = account.email || 'Não informado';
        
        modal.classList.remove('hidden');
        
        // Auto-close após 5 segundos
        setTimeout(() => {
            closeSecondaryAccountSuccessModal();
        }, 5000);
    }
}

// Função para lidar com submissão do formulário (criação ou alteração)
async function handleSecondaryAccountSubmit(event) {
    event.preventDefault();
    
    try {
        // Verificar se é uma conta secundária
        const isSecondary = await checkIfSecondaryAccount();
        
        if (isSecondary) {
            // Se é conta secundária, usar função de alteração
            await saveSecondaryAccountAlteration(event);
        } else {
            // Se não é conta secundária, usar função de criação
            await saveSecondaryAccount(event);
        }
        
    } catch (error) {
        console.error('Erro ao processar submissão do formulário:', error);
        showNotification('Ocorreu um erro ao processar a solicitação.', 'error');
    }
}





// LIMPEZA DAS FUNÇÕES DE CARREGAMENTO
// Remove console.logs e corrige problemas de carregamento

// Função limpa para carregar dados do usuário
async function loadUserProfileClean() {
    try {
        const whatsappElement = document.getElementById('profileWhatsApp');
        
        if (!whatsappElement) {
            return;
        }
        
        // Primeiro tentar obter da sessão local
        const sessionData = localStorage.getItem('userData') || sessionStorage.getItem('userData');
        
        if (sessionData) {
            try {
                const user = JSON.parse(sessionData);
                
                // Definir dados do perfil da sessão
                document.getElementById('profileEmail2').textContent = user.email || '';
                const whatsappValue = user.whatsapp || user.phone || 'Não informado';
                document.getElementById('profileWhatsApp').textContent = whatsappValue;
                return;
            } catch (error) {
                // Continuar para fallback
            }
        }
        
        // Fallback para Supabase Auth
        const { data: { user } } = await supabase.auth.getUser();
        
        if (!user) {
            document.getElementById('profileEmail2').textContent = 'Não logado';
            document.getElementById('profileWhatsApp').textContent = 'Não informado';
            return;
        }

        // Buscar dados do usuário no banco
        const { data: userData, error } = await supabase
            .from('users')
            .select('name, email, whatsapp')
            .eq('id', user.id)
            .single();
        
        // Se usuário não encontrado, mostrar erro
        if (error && error.code === 'PGRST116') {
            document.getElementById('profileEmail2').textContent = user.email || '';
            document.getElementById('profileWhatsApp').textContent = 'Usuário não encontrado';
            return;
        }
        
        if (error) {
            document.getElementById('profileEmail2').textContent = user.email || '';
            document.getElementById('profileWhatsApp').textContent = 'Erro ao carregar';
            return;
        }

        // Atualizar elementos do perfil
        if (userData) {
            const email = userData.email || user.email || '';
            const whatsapp = userData.whatsapp || 'Não informado';
            
            document.getElementById('profileEmail2').textContent = email;
            document.getElementById('profileWhatsApp').textContent = whatsapp;
        } else {
            document.getElementById('profileEmail2').textContent = user.email || '';
            document.getElementById('profileWhatsApp').textContent = 'Não informado';
        }
        
        // Atualizar foto do perfil se disponível
        if (userData?.profile_photo_url) {
            updateProfilePhotoDisplay(userData.profile_photo_url + '?t=' + Date.now());
        }
    } catch (error) {
        document.getElementById('profileEmail2').textContent = 'Erro';
        document.getElementById('profileWhatsApp').textContent = 'Erro';
    }
}

// Função limpa para definir nome da fazenda
async function setFarmNameClean() {
    try {
        const farmName = await getFarmName();
        const farmNameElement = document.getElementById('farmNameHeader');
        if (farmNameElement) {
            farmNameElement.textContent = farmName;
        }
    } catch (error) {
        const farmNameElement = document.getElementById('farmNameHeader');
        if (farmNameElement) {
            farmNameElement.textContent = 'Minha Fazenda';
        }
    }
}

// Função limpa para definir nome do gerente
async function setManagerNameClean() {
    try {
        const managerName = await getManagerName();
        const farmName = await getFarmName();
        
        const finalManagerName = managerName || 'Gerente';
        const finalFarmName = farmName || 'Minha Fazenda';
        
        // Extract formal name for welcome message
        const formalName = extractFormalName(finalManagerName);
        
        const elements = [
            'profileName',
            'profileFullName'
        ];
        
        elements.forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.textContent = finalManagerName;
            }
        });
        
        // Set header and welcome message with formal name
        const headerElement = document.getElementById('managerName');
        const welcomeElement = document.getElementById('managerWelcome');
        if (headerElement) {
            headerElement.textContent = formalName;
        }
        if (welcomeElement) {
            welcomeElement.textContent = formalName;
        }
        
        const farmElement = document.getElementById('profileFarmName');
        if (farmElement) {
            farmElement.textContent = finalFarmName;
        }
    } catch (error) {
        // Definir valores padrão em caso de erro
        const defaultName = 'Gerente';
        const defaultFarm = 'Minha Fazenda';
        
        const elements = [
            'profileName', 
            'profileFullName'
        ];
        
        elements.forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.textContent = defaultName;
            }
        });
        
        // Set header and welcome message with formal name
        const headerElement = document.getElementById('managerName');
        const welcomeElement = document.getElementById('managerWelcome');
        if (headerElement) {
            headerElement.textContent = defaultName;
        }
        if (welcomeElement) {
            welcomeElement.textContent = defaultName;
        }
        
        const farmElement = document.getElementById('profileFarmName');
        if (farmElement) {
            farmElement.textContent = defaultFarm;
        }
    }
}

// Substituir funções originais pelas versões limpas
window.loadUserProfile = loadUserProfileClean;
window.setFarmName = setFarmNameClean;
window.setManagerName = setManagerNameClean;

// Funções do gerente substituídas pelas versões limpas

// REMOÇÃO COMPLETA DE TODOS OS CONSOLE.LOGS PARA PROTEGER O BANCO
// Substituir console.log por função vazia para evitar sobrecarga
const originalConsoleLog = console.log;
const originalConsoleError = console.error;

// TEMPORARIAMENTE HABILITADO PARA DEBUG
// console.log = function() {
//     // Não fazer nada - silenciar completamente
// };

// console.error = function() {
//     // Não fazer nada - silenciar completamente
// };

window.restoreConsoleLogs = function() {
    
    console.error = originalConsoleError;
};

// Função para verificar se há muitas requisições
window.checkDatabaseRequests = function() {
    // Monitorar requisições ao banco
    const originalFetch = window.fetch;
    let requestCount = 0;
    
    window.fetch = function(...args) {
        requestCount++;
        if (requestCount > 100) {
        }
        return originalFetch.apply(this, args);
    };
    
    // Reset contador a cada 5 segundos
    setInterval(() => {
        requestCount = 0;
    }, 5000);
};

// Ativar proteção contra muitas requisições
checkDatabaseRequests();



// ===== FUNÇÕES PARA FOTO DO GERENTE =====

// Variável global para armazenar a foto selecionada
let selectedManagerPhoto = null;

// Função para alternar modo de edição da foto do gerente
function toggleManagerPhotoEdit() {
    const viewMode = document.getElementById('managerPhotoViewMode');
    const editMode = document.getElementById('managerPhotoEditMode');
    const editBtn = document.getElementById('editManagerPhotoBtn');
    
    if (viewMode.classList.contains('hidden')) {
        // Voltar para modo visualização
        viewMode.classList.remove('hidden');
        editMode.classList.add('hidden');
        editBtn.textContent = 'Alterar Foto';
        selectedManagerPhoto = null;
    } else {
        // Ir para modo edição
        viewMode.classList.add('hidden');
        editMode.classList.remove('hidden');
        editBtn.textContent = 'Cancelar';
    }
}

// Função para cancelar edição da foto do gerente
function cancelManagerPhotoEdit() {
    toggleManagerPhotoEdit();
    // Limpar preview
    const previewImage = document.getElementById('managerPhotoPreviewImage');
    const previewPlaceholder = document.getElementById('managerPhotoPreviewPlaceholder');
    if (previewImage) previewImage.classList.add('hidden');
    if (previewPlaceholder) previewPlaceholder.classList.remove('hidden');
    selectedManagerPhoto = null;
}

// Função para lidar com upload da foto do gerente
function handleManagerPhotoUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    // Validar tipo de arquivo
    const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
    if (!allowedTypes.includes(file.type)) {
        showNotification('Formato de arquivo não suportado. Use PNG, JPG, JPEG, GIF ou WEBP.', 'error');
        return;
    }
    
    // Validar tamanho (5MB)
    const maxSize = 5 * 1024 * 1024; // 5MB
    if (file.size > maxSize) {
        showNotification('Arquivo muito grande. Tamanho máximo: 5MB.', 'error');
        return;
    }
    
    // Armazenar arquivo selecionado
    selectedManagerPhoto = file;
    
    // Mostrar preview
    const reader = new FileReader();
    reader.onload = function(e) {
        const previewImage = document.getElementById('managerPhotoPreviewImage');
        const previewPlaceholder = document.getElementById('managerPhotoPreviewPlaceholder');
        
        if (previewImage && previewPlaceholder) {
            previewImage.src = e.target.result;
            previewImage.classList.remove('hidden');
            previewPlaceholder.classList.add('hidden');
        }
    };
    reader.readAsDataURL(file);
}

// Função para salvar foto do gerente
async function saveManagerPhoto() {
    if (!selectedManagerPhoto) {
        showNotification('Selecione uma foto primeiro.', 'error');
        return;
    }
    
    try {
        // Obter dados do usuário atual
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) {
            showNotification('Usuário não autenticado.', 'error');
            return;
        }
        
        // Upload da foto usando função específica para gerente
        const photoUrl = await uploadManagerProfilePhoto(selectedManagerPhoto, user.id);
        
        if (photoUrl) {
            // Atualizar foto no banco de dados
            const { error } = await supabase
                .from('users')
                .update({ profile_photo_url: photoUrl })
                .eq('id', user.id);
            
            if (error) throw error;
            
            // Atualizar interface
            updateManagerPhotoDisplay(photoUrl);
            
            // Atualizar lista de usuários
            await loadUsersData();
            
            // Voltar para modo visualização
            toggleManagerPhotoEdit();
            
            showNotification('Foto de perfil atualizada com sucesso!', 'success');
        }
        
    } catch (error) {
        console.error('Erro ao salvar foto do gerente:', error);
        showNotification('Erro ao salvar foto de perfil.', 'error');
    }
}

// Função específica para upload de foto do gerente
async function uploadManagerProfilePhoto(file, userId) {
    try {
        // Gerar nome único para o arquivo
        const timestamp = Date.now();
        const randomId = Math.random().toString(36).substr(2, 9);
        const fileExtension = file.name.split('.').pop();
        const fileName = `manager_${userId}_${timestamp}_${randomId}.${fileExtension}`;
        
        // Upload para Supabase Storage
        const { data, error } = await supabase.storage
            .from('profile-photos')
            .upload(fileName, file);
        
        if (error) throw error;
        
        // Obter URL pública
        const { data: urlData } = supabase.storage
            .from('profile-photos')
            .getPublicUrl(fileName);
        
        return urlData.publicUrl;
        
    } catch (error) {
        console.error('Erro no upload da foto do gerente:', error);
        throw new Error('Erro ao fazer upload da foto.');
    }
}

// Função para atualizar exibição da foto do gerente
function updateManagerPhotoDisplay(photoUrl) {
    const photoImage = document.getElementById('managerPhotoImage');
    const photoPlaceholder = document.getElementById('managerPhotoPlaceholder');
    
    if (photoUrl && photoImage && photoPlaceholder) {
        // Adicionar timestamp para evitar cache
        photoImage.src = photoUrl + '?t=' + Date.now();
        photoImage.classList.remove('hidden');
        photoPlaceholder.classList.add('hidden');
    } else if (photoPlaceholder) {
        // Mostrar placeholder se não há foto
        if (photoImage) photoImage.classList.add('hidden');
        photoPlaceholder.classList.remove('hidden');
    }
    
    // Atualizar também a foto no header
    updateHeaderProfilePhoto(photoUrl);
    
    // Atualizar também a foto no modal de perfil
    updateModalProfilePhoto(photoUrl);
}

// Função para atualizar foto no header
function updateHeaderProfilePhoto(photoUrl) {
    console.log('🖼️ Atualizando foto do header:', photoUrl);
    
    const headerPhoto = document.getElementById('headerProfilePhoto');
    const headerIcon = document.getElementById('headerProfileIcon');
    
    if (headerPhoto && headerIcon) {
        if (photoUrl) {
            // Adicionar timestamp para evitar cache
            const photoUrlWithTimestamp = photoUrl + '?t=' + Date.now();
            headerPhoto.src = photoUrlWithTimestamp;
            headerPhoto.style.display = 'block';
            headerPhoto.style.visibility = 'visible';
            headerPhoto.classList.remove('hidden');
            headerIcon.style.display = 'none';
            headerIcon.style.visibility = 'hidden';
            headerIcon.classList.add('hidden');
            console.log('✅ Foto do header atualizada com sucesso');
        } else {
            // Mostrar ícone padrão se não há foto
            headerPhoto.style.display = 'none';
            headerPhoto.style.visibility = 'hidden';
            headerPhoto.classList.add('hidden');
            headerIcon.style.display = 'block';
            headerIcon.style.visibility = 'visible';
            headerIcon.classList.remove('hidden');
            console.log('✅ Ícone padrão do header exibido');
        }
    } else {
        console.error('❌ Elementos do header não encontrados');
    }
}

// Função para atualizar foto no modal de perfil
function updateModalProfilePhoto(photoUrl) {
    const modalPhoto = document.getElementById('modalProfilePhoto');
    const modalIcon = document.getElementById('modalProfileIcon');
    
    if (modalPhoto && modalIcon) {
        if (photoUrl) {
            // Adicionar timestamp para evitar cache
            const photoUrlWithTimestamp = photoUrl + '?t=' + Date.now();
            modalPhoto.src = photoUrlWithTimestamp;
            modalPhoto.classList.remove('hidden');
            modalIcon.classList.add('hidden');
        } else {
            // Mostrar ícone padrão se não há foto
            modalPhoto.classList.add('hidden');
            modalIcon.classList.remove('hidden');
        }
    }
}
// Função para carregar foto do gerente ao abrir o modal
async function loadManagerPhoto() {
    try {
        // // const supabase = await getSupabaseClient(); // REMOVIDO // REMOVIDO - usando MySQL
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) return;
        
        // Buscar dados do usuário incluindo foto
        const { data: userData, error } = await supabase
            .from('users')
            .select('profile_photo_url')
            .eq('id', user.id)
            .single();
        
        if (error) {
            console.error('Erro ao carregar foto do gerente:', error);
            return;
        }
        
        // Atualizar exibição da foto
        if (userData && userData.profile_photo_url) {
        updateManagerPhotoDisplay(userData.profile_photo_url);
        }
        
    } catch (error) {
        console.error('Erro ao carregar foto do gerente:', error);
    }
}

// Modificar função openProfileModal para carregar foto
const originalOpenProfileModal = window.openProfileModal;
window.openProfileModal = function() {
    originalOpenProfileModal();
    // Carregar foto do gerente apenas quando o modal for aberto manualmente
    setTimeout(() => {
    loadManagerPhoto();
    }, 100);
};

// Função para carregar foto no header ao inicializar a página
async function loadHeaderPhoto() {
    try {
        console.log('🖼️ Carregando foto do header...');
        
        // // const supabase = await getSupabaseClient(); // REMOVIDO // REMOVIDO - usando MySQL
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) {
            console.log('❌ Usuário não autenticado');
            return;
        }
        
        // Buscar dados do usuário incluindo foto
        const { data: userData, error } = await supabase
            .from('users')
            .select('profile_photo_url')
            .eq('id', user.id)
            .single();
        
        if (error) {
            console.error('❌ Erro ao carregar foto do header:', error);
            return;
        }
        
        console.log('📋 Dados do usuário carregados:', userData);
        
        // Atualizar foto no header
        updateHeaderProfilePhoto(userData.profile_photo_url);
        
    } catch (error) {
        console.error('❌ Erro ao carregar foto do header:', error);
    }
}

// Função já é chamada no DOMContentLoaded principal

// ==================== FUNÇÕES DA ABA DE RELATÓRIOS ====================

// Variáveis globais para a aba de relatórios
let reportTabSettings = {
    farmName: '',
    farmLogo: null
};

// Função para carregar configurações na aba de relatórios
async function loadReportTabSettings() {
    try {
        // // const supabase = await getSupabaseClient(); // REMOVIDO // REMOVIDO - usando MySQL
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) return;

        // Buscar dados do usuário incluindo farm_id
        const { data: userData, error: userError } = await supabase
            .from('users')
            .select('report_farm_name, report_farm_logo_base64, farm_id')
            .eq('id', user.id)
            .single();

        if (userError) throw userError;

        // Se não tem nome da fazenda configurado, buscar do banco
        let farmName = userData.report_farm_name;
        if (!farmName && userData.farm_id) {
            const { data: farmData, error: farmError } = await supabase
                .from('farms')
                .select('name')
                .eq('id', userData.farm_id)
                .single();

            if (!farmError && farmData) {
                farmName = farmData.name;
            }
        }

        // Se ainda não tem nome, usar padrão
        if (!farmName) {
            farmName = 'Fazenda';
        }

        reportTabSettings.farmName = farmName;
        reportTabSettings.farmLogo = userData.report_farm_logo_base64;
        
        // Atualizar campos
        document.getElementById('reportFarmNameTab').value = farmName;
        updateFarmLogoPreviewTab(reportTabSettings.farmLogo);
        
        // Corrigir duplicação da logo
        setTimeout(() => {
            fixLogoDuplication();
        }, 100);
        

    } catch (error) {
        console.error('Erro ao carregar configurações:', error);
        // Em caso de erro, usar nome padrão
        document.getElementById('reportFarmNameTab').value = 'Fazenda';
    }
}

// Função para upload da logo na aba
async function handleFarmLogoUploadTab(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    if (!file.type.startsWith('image/')) {
        showNotification('Por favor, selecione um arquivo de imagem válido', 'error');
        return;
    }
    
    if (file.size > 2 * 1024 * 1024) {
        showNotification('A imagem deve ter no máximo 2MB', 'error');
        return;
    }
    
    try {
        const base64 = await fileToBase64(file);
        reportTabSettings.farmLogo = base64;
        updateFarmLogoPreviewTab(base64);
        showNotification('Logo carregada com sucesso! Clique em "Salvar Configurações" para aplicar', 'success');
    } catch (error) {
        console.error('Erro ao processar logo:', error);
        showNotification('Erro ao processar a imagem', 'error');
    }
}

// Função para atualizar preview da logo na aba
function updateFarmLogoPreviewTab(base64Logo) {
    const preview = document.getElementById('farmLogoPreviewTab');
    const placeholder = document.getElementById('farmLogoPlaceholderTab');
    const image = document.getElementById('farmLogoImageTab');
    const removeBtn = document.getElementById('removeFarmLogoTab');
    
    if (base64Logo) {
        image.src = base64Logo;
        preview.classList.remove('hidden');
        placeholder.classList.add('hidden');
        removeBtn.classList.remove('hidden');
        
        // Forçar ocultação do placeholder via CSS
        placeholder.style.display = 'none';
        placeholder.style.visibility = 'hidden';
        placeholder.style.opacity = '0';
        placeholder.style.position = 'absolute';
        placeholder.style.zIndex = '-1';
        placeholder.style.pointerEvents = 'none';
        placeholder.style.width = '0';
        placeholder.style.height = '0';
        placeholder.style.overflow = 'hidden';
        
        // Garantir que o botão remover seja visível
        removeBtn.style.display = 'flex';
        removeBtn.style.visibility = 'visible';
        removeBtn.style.opacity = '1';
        removeBtn.style.position = 'relative';
        removeBtn.style.zIndex = 'auto';
        removeBtn.style.pointerEvents = 'auto';
        removeBtn.style.width = 'auto';
        removeBtn.style.height = 'auto';
        removeBtn.style.overflow = 'visible';
    } else {
        image.src = '';
        preview.classList.add('hidden');
        placeholder.classList.remove('hidden');
        removeBtn.classList.add('hidden');
        
        // Forçar exibição do placeholder via CSS
        placeholder.style.display = 'flex';
        placeholder.style.visibility = 'visible';
        placeholder.style.opacity = '1';
        placeholder.style.position = 'relative';
        placeholder.style.zIndex = 'auto';
        placeholder.style.pointerEvents = 'auto';
        placeholder.style.width = 'auto';
        placeholder.style.height = 'auto';
        placeholder.style.overflow = 'visible';
        
        // Forçar ocultação completa do botão remover via CSS
        removeBtn.style.display = 'none';
        removeBtn.style.visibility = 'hidden';
        removeBtn.style.opacity = '0';
        removeBtn.style.position = 'absolute';
        removeBtn.style.zIndex = '-1';
        removeBtn.style.pointerEvents = 'none';
        removeBtn.style.width = '0';
        removeBtn.style.height = '0';
        removeBtn.style.overflow = 'hidden';
    }
}

// Função para corrigir duplicação da logo na inicialização
function fixLogoDuplication() {
    const preview = document.getElementById('farmLogoPreviewTab');
    const placeholder = document.getElementById('farmLogoPlaceholderTab');
    const removeBtn = document.getElementById('removeFarmLogoTab');
    
    if (preview && placeholder && removeBtn) {
        if (preview.classList.contains('hidden')) {
            // Se preview está oculta, mostrar placeholder e ocultar botão remover
            placeholder.style.display = 'flex';
            placeholder.style.visibility = 'visible';
            placeholder.style.opacity = '1';
            placeholder.style.position = 'relative';
            placeholder.style.zIndex = 'auto';
            placeholder.style.pointerEvents = 'auto';
            placeholder.style.width = 'auto';
            placeholder.style.height = 'auto';
            placeholder.style.overflow = 'visible';
            
            // Ocultar botão remover completamente
            removeBtn.style.display = 'none';
            removeBtn.style.visibility = 'hidden';
            removeBtn.style.opacity = '0';
            removeBtn.style.position = 'absolute';
            removeBtn.style.zIndex = '-1';
            removeBtn.style.pointerEvents = 'none';
            removeBtn.style.width = '0';
            removeBtn.style.height = '0';
            removeBtn.style.overflow = 'hidden';
        } else {
            // Se preview está visível, ocultar placeholder e mostrar botão remover
            placeholder.style.display = 'none';
            placeholder.style.visibility = 'hidden';
            placeholder.style.opacity = '0';
            placeholder.style.position = 'absolute';
            placeholder.style.zIndex = '-1';
            placeholder.style.pointerEvents = 'none';
            placeholder.style.width = '0';
            placeholder.style.height = '0';
            placeholder.style.overflow = 'hidden';
            
            // Mostrar botão remover
            removeBtn.style.display = 'flex';
            removeBtn.style.visibility = 'visible';
            removeBtn.style.opacity = '1';
            removeBtn.style.position = 'relative';
            removeBtn.style.zIndex = 'auto';
            removeBtn.style.pointerEvents = 'auto';
            removeBtn.style.width = 'auto';
            removeBtn.style.height = 'auto';
            removeBtn.style.overflow = 'visible';
        }
    }
}

// Função para remover logo da aba
function removeFarmLogoTab() {
    reportTabSettings.farmLogo = null;
    updateFarmLogoPreviewTab(null);
    document.getElementById('farmLogoUploadTab').value = '';
    showNotification('Logo removida! Clique em "Salvar Configurações" para aplicar', 'info');
}

// Função para salvar configurações da aba
async function saveReportSettingsTab() {
    try {
        const farmName = document.getElementById('reportFarmNameTab').value || 'Fazenda';
        
        const { error } = await supabase.rpc('update_user_report_settings', {
            p_report_farm_name: farmName,
            p_report_farm_logo_base64: reportTabSettings.farmLogo,
            p_report_footer_text: null,
            p_report_system_logo_base64: null
        });

        if (error) throw error;

        reportTabSettings.farmName = farmName;
        showNotification('Configurações salvas com sucesso!', 'success');
        
        // Sincronizar com as configurações do modal
        if (window.reportSettings) {
            window.reportSettings.farmName = farmName;
            window.reportSettings.farmLogo = reportTabSettings.farmLogo;
        }
        
    } catch (error) {
        console.error('Erro ao salvar configurações:', error);
        showNotification('Erro ao salvar configurações', 'error');
    }
}

// Função para carregar estatísticas dos relatórios
async function loadReportStats() {
    try {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) return;

        const { data: userData } = await supabase
            .from('users')
            .select('farm_id')
            .eq('id', user.id)
            .single();

        if (!userData?.farm_id) return;

        const hoje = new Date().toISOString().split('T')[0];
        const inicioMes = new Date();
        inicioMes.setDate(1);
        const seteDiasAtras = new Date();
        seteDiasAtras.setDate(seteDiasAtras.getDate() - 6);

        // Produção de hoje
        const { data: producaoHoje } = await supabase
            .from('volume_records')
            .select('volume_liters')
            .eq('farm_id', userData.farm_id)
            .eq('production_date', hoje);

        let volumeHoje = 0;
        if (producaoHoje) {
            volumeHoje = producaoHoje.reduce((sum, item) => sum + parseFloat(item.volume_liters || 0), 0);
        }

        // Média semanal
        const { data: producaoSemana } = await supabase
            .from('volume_records')
            .select('volume_liters, production_date')
            .eq('farm_id', userData.farm_id)
            .gte('production_date', seteDiasAtras.toISOString().split('T')[0]);

        let mediaSemana = 0;
        if (producaoSemana?.length > 0) {
            const volumesPorDia = {};
            producaoSemana.forEach(item => {
                if (!volumesPorDia[item.production_date]) {
                    volumesPorDia[item.production_date] = 0;
                }
                volumesPorDia[item.production_date] += parseFloat(item.volume_liters || 0);
            });
            
            const totalDias = Object.keys(volumesPorDia).length;
            const totalVolume = Object.values(volumesPorDia).reduce((sum, vol) => sum + vol, 0);
            mediaSemana = totalDias > 0 ? totalVolume / totalDias : 0;
        }

        // Total do mês
        const { data: producaoMes } = await supabase
            .from('volume_records')
            .select('volume_liters')
            .eq('farm_id', userData.farm_id)
            .gte('production_date', inicioMes.toISOString().split('T')[0]);

        let totalMes = 0;
        let registrosMes = 0;
        if (producaoMes) {
            totalMes = producaoMes.reduce((sum, item) => sum + parseFloat(item.volume_liters || 0), 0);
            registrosMes = producaoMes.length;
        }

        // Funcionários ativos
        const { data: funcionarios } = await supabase
            .from('users')
            .select('id')
            .eq('farm_id', userData.farm_id)
            .eq('role', 'funcionario');

        const funcionariosAtivos = funcionarios?.length || 0;

        // Atualizar elementos
        document.getElementById('reportTodayVolume').textContent = volumeHoje.toFixed(1) + ' L';
        document.getElementById('reportWeekAverage').textContent = mediaSemana.toFixed(1) + ' L';
        document.getElementById('reportMonthTotal').textContent = totalMes.toFixed(1) + ' L';
        document.getElementById('reportMonthRecords').textContent = registrosMes.toString();
        document.getElementById('reportActiveEmployees').textContent = funcionariosAtivos.toString();

        // Carregar lista de funcionários no select
        const selectEmployee = document.getElementById('reportEmployee');
        if (selectEmployee && funcionarios) {
            selectEmployee.innerHTML = '<option value="">Todos os funcionários</option>';
            
            for (const func of funcionarios) {
                const { data: userData } = await supabase
                    .from('users')
                    .select('name')
                    .eq('id', func.id)
                    .single();
                
                if (userData?.name) {
                    const option = document.createElement('option');
                    option.value = func.id;
                    option.textContent = userData.name;
                    selectEmployee.appendChild(option);
                }
            }
        }

    } catch (error) {
        console.error('Erro ao carregar estatísticas:', error);
    }
}

// Função para exportar Excel
async function exportExcelReport() {
    try {
        const startDate = document.getElementById('reportStartDate').value;
        const endDate = document.getElementById('reportEndDate').value;
        const employeeId = document.getElementById('reportEmployee').value;

        if (!startDate || !endDate) {
            showNotification('Por favor, selecione as datas inicial e final', 'warning');
            return;
        }

        const { data: { user } } = await supabase.auth.getUser();
        if (!user) return;

        const { data: userData } = await supabase
            .from('users')
            .select('farm_id')
            .eq('id', user.id)
            .single();

        if (!userData?.farm_id) return;

        // Buscar dados
        let query = supabase
            .from('volume_records')
            .select(`
                production_date,
                shift,
                volume_liters,
                temperature,
                observations,
                created_at,
                users!inner(name)
            `)
            .eq('farm_id', userData.farm_id)
            .gte('production_date', startDate)
            .lte('production_date', endDate)
            .order('production_date', { ascending: true })
            .order('created_at', { ascending: true });

        if (employeeId) {
            query = query.eq('user_id', employeeId);
        }

        const { data: dadosExcel, error } = await query;

        if (error) {
            throw error;
        }

        if (!dadosExcel || dadosExcel.length === 0) {
            showNotification('Nenhum dado encontrado para o período selecionado', 'info');
            return;
        }
        // Obter informações da fazenda para o cabeçalho
        const farmName = reportTabSettings.farmName || 'Fazenda';
        const dataInicio = new Date(startDate).toLocaleDateString('pt-BR');
        const dataFim = new Date(endDate).toLocaleDateString('pt-BR');
        const dataGeracao = new Date().toLocaleString('pt-BR');
        
        // Calcular estatísticas
        const totalVolume = dadosExcel.reduce((sum, item) => sum + (parseFloat(item.volume_liters) || 0), 0);
        const mediaVolume = dadosExcel.length > 0 ? totalVolume / dadosExcel.length : 0;
        const totalRegistros = dadosExcel.length;

        // Criar dados para Excel com design limpo
        const excelData = [
            // Cabeçalho Principal
            [`RELATÓRIO DE PRODUÇÃO DE LEITE - ${farmName.toUpperCase()}`],
            [''],
            ['INFORMAÇÕES DO RELATÓRIO'],
            ['Período:', `${dataInicio} até ${dataFim}`],
            ['Data de Geração:', dataGeracao],
            ['Total de Registros:', totalRegistros],
            ['Volume Total Produzido:', `${totalVolume.toFixed(2)} L`],
            ['Média por Registro:', `${mediaVolume.toFixed(2)} L`],
            [''],
            // Cabeçalho da Tabela
            ['Data', 'Funcionário', 'Turno', 'Volume (L)', 'Temperatura (°C)', 'Observações', 'Data/Hora Registro']
        ];

        dadosExcel.forEach(item => {
            const data = new Date(item.production_date).toLocaleDateString('pt-BR');
            const turno = {
                'manha': 'Manhã',
                'tarde': 'Tarde', 
                'noite': 'Noite'
            }[item.shift] || item.shift;
            const dataHora = new Date(item.created_at).toLocaleString('pt-BR');

            excelData.push([
                data,
                item.users?.name || 'N/A',
                turno,
                parseFloat(item.volume_liters) || 0,
                item.temperature ? `${item.temperature}°C` : '',
                item.observations || '',
                dataHora
            ]);
        });

        // Criar workbook e worksheet
        const ws = XLSX.utils.aoa_to_sheet(excelData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Produção de Leite');

        // Definir larguras das colunas melhoradas
        ws['!cols'] = [
            { width: 15 }, // Data
            { width: 25 }, // Funcionário
            { width: 15 }, // Turno
            { width: 15 }, // Volume
            { width: 18 }, // Temperatura
            { width: 35 }, // Observações
            { width: 22 }  // Data/Hora Registro
        ];

        // Estilizar cabeçalho principal
        if (ws['A1']) {
            ws['A1'].s = {
                font: { bold: true, color: { rgb: "FFFFFF" } },
                fill: { fgColor: { rgb: "2563EB" } },
                alignment: { horizontal: "center" }
            };
        }

        // Merge das células do título
        ws['!merges'] = [
            { s: { r: 0, c: 0 }, e: { r: 0, c: 6 } }, // Título principal
            { s: { r: 2, c: 0 }, e: { r: 2, c: 6 } }  // Subtítulo informações
        ];

        // Estilizar linha de informações
        for (let i = 3; i <= 8; i++) {
            const cellA = `A${i}`;
            const cellB = `B${i}`;
            if (ws[cellA]) {
                ws[cellA].s = {
                    font: { bold: true, color: { rgb: "1F2937" } },
                    fill: { fgColor: { rgb: "F3F4F6" } }
                };
            }
            if (ws[cellB]) {
                ws[cellB].s = {
                    font: { color: { rgb: "374151" } },
                    fill: { fgColor: { rgb: "F9FAFB" } }
                };
            }
        }

        // Estilizar cabeçalho da tabela
        for (let col = 0; col < 7; col++) {
            const cell = ws[XLSX.utils.encode_cell({ r: 9, c: col })];
            if (cell) {
                cell.s = {
                    font: { bold: true, color: { rgb: "FFFFFF" } },
                    fill: { fgColor: { rgb: "059669" } },
                    alignment: { horizontal: "center" },
                    border: {
                        top: { style: "thin", color: { rgb: "000000" } },
                        bottom: { style: "thin", color: { rgb: "000000" } },
                        left: { style: "thin", color: { rgb: "000000" } },
                        right: { style: "thin", color: { rgb: "000000" } }
                    }
                };
            }
        }

        // Estilizar dados da tabela
        for (let row = 10; row < excelData.length; row++) {
            for (let col = 0; col < 7; col++) {
                const cell = ws[XLSX.utils.encode_cell({ r: row, c: col })];
                if (cell) {
                    const isEvenRow = (row - 10) % 2 === 0;
                    cell.s = {
                        fill: { fgColor: { rgb: isEvenRow ? "F9FAFB" : "FFFFFF" } },
                        border: {
                            top: { style: "thin", color: { rgb: "E5E7EB" } },
                            bottom: { style: "thin", color: { rgb: "E5E7EB" } },
                            left: { style: "thin", color: { rgb: "E5E7EB" } },
                            right: { style: "thin", color: { rgb: "E5E7EB" } }
                        },
                        alignment: { 
                            horizontal: col === 3 ? "right" : "left", // Volume alinhado à direita
                            vertical: "center"
                        }
                    };
                    
                    // Destacar volumes acima da média
                    if (col === 3 && parseFloat(cell.v) > mediaVolume) {
                        cell.s.font = { bold: true, color: { rgb: "059669" } };
                    }
                }
            }
        }

        // Download
        const fileName = `Relatório_${farmName}_${startDate}_${endDate}.xlsx`;
        XLSX.writeFile(wb, fileName);

        showNotification('Arquivo Excel exportado com sucesso!', 'success');

    } catch (error) {
        console.error('Erro ao exportar Excel:', error);
        
        showNotification('Erro ao exportar relatório: ' + error.message, 'error');
    }
}

// Função para exportar PDF
async function exportPDFReport() {
    try {
        const startDate = document.getElementById('reportStartDate').value;
        const endDate = document.getElementById('reportEndDate').value;
        const employeeId = document.getElementById('reportEmployee').value;

        if (!startDate || !endDate) {
            showNotification('Por favor, selecione as datas inicial e final', 'warning');
            return;
        }

        const { data: { user } } = await supabase.auth.getUser();
        if (!user) return;

        const { data: userData } = await supabase
            .from('users')
            .select('farm_id')
            .eq('id', user.id)
            .single();

        if (!userData?.farm_id) return;

        let query = supabase
            .from('volume_records')
            .select(`
                production_date,
                shift,
                volume_liters,
                temperature,
                observations,
                created_at,
                users!inner(name)
            `)
            .eq('farm_id', userData.farm_id)
            .gte('production_date', startDate)
            .lte('production_date', endDate)
            .order('production_date', { ascending: true });

        if (employeeId) {
            query = query.eq('user_id', employeeId);
        }

        const { data: dadosPDF, error } = await query;

        if (error) throw error;

        if (!dadosPDF || dadosPDF.length === 0) {
            showNotification('Nenhum dado encontrado para o período selecionado', 'info');
            return;
        }

        // Gerar PDF usando a função existente
        generateVolumePDF(dadosPDF, false);

    } catch (error) {
        console.error('Erro ao exportar PDF:', error);
        showNotification('Erro ao exportar PDF: ' + error.message, 'error');
    }
}

// Resetar senha da conta
async function resetAccountPassword(userId, userName) {
    if (!confirm(`Tem certeza que deseja resetar a senha de ${userName}?`)) {
        return;
    }

    try {
        const newPassword = generateTempPassword();

        // Atualizar apenas a senha temporária na tabela
        // Nota: O usuário precisará usar a função de recuperação de senha do Supabase
        // ou o administrador do sistema precisará resetar via painel admin
        const { error: updateError } = await supabase
            .from('users')
            .update({ temp_password: newPassword })
            .eq('id', userId);

        if (updateError) throw updateError;

        showNotification('Nova senha temporária gerada! O usuário deve usar a recuperação de senha do sistema.', 'warning');
        showTempPasswordModal(userName, '', newPassword);

    } catch (error) {
        console.error('Erro ao resetar senha:', error);
        showNotification('Erro ao resetar senha: ' + error.message, 'error');
    }
}

// Event listener para formulário de conta secundária
const createSecondaryAccountForm = document.getElementById('createSecondaryAccountForm');
if (createSecondaryAccountForm) {
    // Função para lidar com o submit
    const handleSecondaryAccountSubmit = async function(e) {
    e.preventDefault();
    const formData = new FormData(this);
        await createSecondaryAccount(formData);
    };
    
    // Remover listener anterior se existir
    createSecondaryAccountForm.removeEventListener('submit', handleSecondaryAccountSubmit);
    createSecondaryAccountForm.addEventListener('submit', handleSecondaryAccountSubmit);
}

// Funções para gerenciar contas secundárias
function toggleSecondaryAccountForm() {
    const form = document.getElementById('secondaryAccountForm');
    if (form) {
        form.classList.toggle('hidden');
        
        if (!form.classList.contains('hidden')) {
            // Preencher dados automaticamente
            fillSecondaryAccountForm();
        }
    }
}

function cancelSecondaryAccountForm() {
    const form = document.getElementById('secondaryAccountForm');
    if (form) {
        form.classList.add('hidden');
    }
}

// Preencher formulário com dados do gerente atual
async function fillSecondaryAccountForm() {
    try {
        // // const supabase = await getSupabaseClient(); // REMOVIDO // REMOVIDO - usando MySQL
        const { data: { user } } = await supabase.auth.getUser();
        
        if (user) {
            // Buscar dados do usuário atual (gerente principal)
            const { data: userData, error } = await supabase
                .from('users')
                .select('name, whatsapp, role')
                .eq('id', user.id)
                .eq('role', 'gerente') // Garantir que é o gerente principal
                .single();
                
            if (!error && userData) {
                // Preencher campos ocultos
                document.getElementById('secondaryAccountName').value = userData.name;
                document.getElementById('secondaryAccountWhatsApp').value = userData.whatsapp || '';
                document.getElementById('secondaryAccountEmail').value = user.email;
                
                // Preencher campos de exibição
                document.getElementById('displayName').textContent = userData.name;
                document.getElementById('displayWhatsApp').textContent = userData.whatsapp || 'Não informado';
                document.getElementById('displayEmail').textContent = user.email;
                
                console.log('✅ Dados do gerente principal carregados:', {
                    name: userData.name,
                    email: user.email,
                    whatsapp: userData.whatsapp,
                    role: userData.role
                });
            } else {
                console.error('Erro ao buscar dados do gerente principal:', error);
                showNotification('Erro ao carregar dados da conta principal', 'error');
            }
        }
    } catch (error) {
        console.error('Erro ao preencher formulário:', error);
    }
}

// Criar conta secundária
async function createSecondaryAccount(formData) {
    try {
        // // const supabase = await getSupabaseClient(); // REMOVIDO // REMOVIDO - usando MySQL
        const { data: { user } } = await supabase.auth.getUser();
        
        if (!user) throw new Error('Usuário não autenticado');
        
        // Obter dados do gerente atual
        const { data: managerData, error: managerError } = await supabase
            .from('users')
            .select('farm_id, name, whatsapp')
            .eq('id', user.id)
            .single();
            
        if (managerError) throw managerError;
        
        const accountType = formData.get('account_type');
        const email = user.email; // Sempre usar o email do gerente
        const name = formData.get('name') || managerData.name;
        const whatsapp = formData.get('whatsapp') || managerData.whatsapp;
        
        // Verificar se já existe uma conta secundária deste tipo
        const { data: existingAccounts, error: checkError } = await supabase
            .from('users')
            .select('id, role')
            .eq('email', email)
            .eq('farm_id', managerData.farm_id);
            
        if (checkError) throw checkError;
        
        // Verificar se já existe uma conta com o mesmo role
        const hasAccountType = existingAccounts && existingAccounts.some(account => account.role === accountType);
        
        if (hasAccountType) {
            const roleText = accountType === 'funcionario' ? 'de funcionário' : 'de veterinário';
            throw new Error(`Você já possui uma conta ${roleText}`);
        }
        
        // Criar conta secundária usando RPC
        const { data: result, error } = await supabase.rpc('create_farm_user', {
            p_user_id: authData.user.id,
            p_email: email,
            p_name: name,
            p_whatsapp: whatsapp,
            p_role: accountType,
            p_farm_id: managerData.farm_id,
            p_profile_photo_url: null
        });
        
        if (error) throw error;
        
        if (!result.success) {
            throw new Error(result.error || 'Falha ao criar conta secundária');
        }
        
        showNotification(`Conta secundária ${accountType === 'funcionario' ? 'de funcionário' : 'de veterinário'} criada com sucesso!`, 'success');
        
        // Fechar formulário e recarregar lista
        cancelSecondaryAccountForm();
        loadSecondaryAccounts();
        
    } catch (error) {
        console.error('Erro ao criar conta secundária:', error);
        showNotification('Erro ao criar conta secundária: ' + error.message, 'error');
    }
}

// Verificar se já existe conta secundária do tipo selecionado
async function checkExistingSecondaryAccount(accountType) {
    if (!accountType) {
        const messageDiv = document.getElementById('existingAccountMessage');
        if (messageDiv) {
            messageDiv.classList.add('hidden');
        }
        return;
    }
    
    try {
        // // const supabase = await getSupabaseClient(); // REMOVIDO // REMOVIDO - usando MySQL
        const { data: { user } } = await supabase.auth.getUser();
        
        if (!user) return;
        
        // Buscar contas existentes com o mesmo email e role específico
        const { data: existingAccounts, error } = await supabase
            .from('users')
            .select('role')
            .eq('email', user.email)
            .eq('role', accountType);
            
        if (error) throw error;
        
        const hasAccountType = existingAccounts && existingAccounts.length > 0;
        
        const messageDiv = document.getElementById('existingAccountMessage');
        if (messageDiv) {
            if (hasAccountType) {
                const roleText = accountType === 'funcionario' ? 'de funcionário' : 'de veterinário';
                messageDiv.innerHTML = `<span class="text-red-600">⚠️ Você já possui uma conta ${roleText}</span>`;
                messageDiv.classList.remove('hidden');
            } else {
                messageDiv.classList.add('hidden');
            }
        }
        
    } catch (error) {
        console.error('Erro ao verificar conta existente:', error);
    }
}

// Carregar contas secundárias
async function loadSecondaryAccounts() {
    try {
        // // const supabase = await getSupabaseClient(); // REMOVIDO // REMOVIDO - usando MySQL
        const { data: { user } } = await supabase.auth.getUser();
        
        if (!user) return;
        
        // Buscar contas secundárias (mesmo email, diferentes roles)
        const { data: secondaryAccounts, error } = await supabase
            .from('users')
            .select('id, name, email, role, whatsapp, is_active, created_at')
            .eq('email', user.email) // Mesmo email do gerente
            .neq('role', 'gerente') // Excluir a conta principal (gerente)
            .order('created_at', { ascending: false });
            
        if (error) throw error;
        
        displaySecondaryAccounts(secondaryAccounts || []);
        
    } catch (error) {
        console.error('Erro ao carregar contas secundárias:', error);
        showNotification('Erro ao carregar contas secundárias', 'error');
    }
}

// Exibir contas secundárias
function displaySecondaryAccounts(accounts) {
    const container = document.getElementById('secondaryAccountsList');
    
    if (!accounts || accounts.length === 0) {
        container.innerHTML = `
            <div class="text-center py-8">
                <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                    </svg>
                </div>
                <p class="text-gray-500">Nenhuma conta secundária encontrada</p>
            </div>
        `;
        return;
    }
    
    const accountsHtml = accounts.map(account => {
        const roleText = {
            'funcionario': 'Funcionário',
            'veterinario': 'Veterinário',
            'gerente': 'Gerente'
        }[account.role] || account.role;
        
        const roleColor = {
            'funcionario': 'bg-green-100 text-green-800',
            'veterinario': 'bg-purple-100 text-purple-800',
            'gerente': 'bg-blue-100 text-blue-800'
        }[account.role] || 'bg-gray-100 text-gray-800';
        
        const statusColor = account.is_active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
        const statusText = account.is_active ? 'Ativo' : 'Inativo';
        
        return `
            <div class="bg-gray-50 rounded-xl p-4 border border-gray-200 hover:bg-gray-100 cursor-pointer transition-all duration-200 w-full" 
                 onclick="accessSecondaryAccount('${account.id}', '${account.name}', '${account.role}')">
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 bg-forest-100 rounded-full flex items-center justify-center flex-shrink-0">
                                <svg class="w-5 h-5 text-forest-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                </svg>
                            </div>
                            <div class="min-w-0 flex-1">
                                <h5 class="font-semibold text-gray-900 truncate">${account.name}</h5>
                                <p class="text-sm text-gray-600 truncate">${account.email}</p>
                                <p class="text-xs text-gray-500 truncate">${account.whatsapp || 'WhatsApp não informado'}</p>
                            </div>
                        </div>
                    </div>
                    <div class="flex flex-wrap items-center gap-2 flex-shrink-0">
                        <span class="px-2 py-1 text-xs font-medium rounded-full ${roleColor} whitespace-nowrap">${roleText}</span>
                        <span class="px-2 py-1 text-xs font-medium rounded-full ${statusColor} whitespace-nowrap">${statusText}</span>
                        <span class="px-2 py-1 text-xs font-medium rounded-full bg-orange-100 text-orange-800 whitespace-nowrap">
                            <svg class="w-3 h-3 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                            </svg>Secundária
                        </span>
                    </div>
                </div>
                <div class="mt-3 pt-3 border-t border-gray-200">
                    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 text-xs text-gray-500">
                        <span class="truncate">Criado em: ${new Date(account.created_at).toLocaleDateString('pt-BR')}</span>
                        <div class="flex items-center space-x-1">
                            <span class="text-blue-600 font-medium whitespace-nowrap">Clique para acessar →</span>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }).join('');
    
    container.innerHTML = accountsHtml;
}

// Obter farm_id do usuário atual
async function getCurrentUserFarmId() {
    try {
        // // const supabase = await getSupabaseClient(); // REMOVIDO // REMOVIDO - usando MySQL
        const { data: { user } } = await supabase.auth.getUser();
        
        if (!user) return null;
        
        const { data: userData, error } = await supabase
            .from('users')
            .select('farm_id')
            .eq('id', user.id)
            .single();
            
        if (error) return null;
        
        return userData.farm_id;
    } catch (error) {
        console.error('Erro ao obter farm_id:', error);
        return null;
    }
}

// Função removida - não mais necessária após remoção dos botões de bloquear/excluir

// Acessar conta secundária
async function accessSecondaryAccount(userId, userName, userRole) {
    const confirmed = confirm(`Deseja acessar a conta "${userName}" (${userRole})?\n\nVocê será redirecionado para esta conta.`);
    
    if (confirmed) {
        try {
            // Armazenar informações da conta atual
            const currentUser = {
                id: userId,
                name: userName,
                role: userRole,
                isSecondary: true
            };
            
            // Salvar no sessionStorage para poder voltar
            sessionStorage.setItem('currentSecondaryAccount', JSON.stringify(currentUser));
            
            // Redirecionar para a página apropriada baseada no role
            if (userRole === 'veterinario') {
                window.location.href = 'veterinario.php';
            } else if (userRole === 'funcionario') {
                window.location.href = 'funcionario.php';
            } else {
                showNotification('Tipo de conta não suportado', 'error');
            }
            
        } catch (error) {
            showNotification('Erro ao acessar conta secundária: ' + error.message, 'error');
        }
    }
}

// Função removida - não mais necessária após remoção dos botões de bloquear/excluir

// Mostrar/ocultar seção de foto baseado no cargo selecionado
function togglePhotoSection() {
    console.log('🔍 togglePhotoSection() chamada');
    
    const roleSelect = document.getElementById('userRole');
    const photoSection = document.getElementById('addPhotoSection');
    
    console.log('📋 Role selecionado:', roleSelect?.value);
    console.log('📸 Seção de foto encontrada:', !!photoSection);
    
    if (roleSelect && photoSection) {
        if (roleSelect.value === 'veterinario' || roleSelect.value === 'funcionario') {
            console.log('✅ Mostrando seção de foto para', roleSelect.value);
            photoSection.classList.remove('hidden');
            photoSection.style.display = 'block';
            photoSection.style.visibility = 'visible';
            photoSection.style.opacity = '1';
        } else {
            console.log('❌ Ocultando seção de foto');
            photoSection.classList.add('hidden');
            photoSection.style.display = 'none';
            
            // Limpar foto se não for veterinário
            const profilePhotoInput = document.getElementById('profilePhotoInput');
            const profilePreview = document.getElementById('profilePreview');
            const profilePlaceholder = document.getElementById('profilePlaceholder');
            
            if (profilePhotoInput) profilePhotoInput.value = '';
            if (profilePreview) {
                profilePreview.src = '';
                profilePreview.style.display = 'none';
            }
            if (profilePlaceholder) profilePlaceholder.style.display = 'flex';
        }
    } else {
        console.error('❌ Elementos não encontrados:', {
            roleSelect: !!roleSelect,
            photoSection: !!photoSection
        });
    }
}

// Carregar contas secundárias quando o modal for aberto
const currentOpenProfileModal = window.openProfileModal;
window.openProfileModal = function() {
    currentOpenProfileModal();
    setTimeout(() => {
        loadSecondaryAccounts();
    }, 100);
};

// Função removida - conflito resolvido na função openAddUserModal original

// Função para prévia do relatório na aba
function previewReportTab() {
    const startDate = document.getElementById('reportStartDate').value;
    const endDate = document.getElementById('reportEndDate').value;

    if (!startDate || !endDate) {
        showNotification('Por favor, selecione as datas inicial e final para a prévia', 'warning');
        return;
    }

    // Gerar relatório de exemplo
    const sampleData = [
        {
            production_date: startDate,
            volume_liters: 150.5,
            shift: 'manha',
            temperature: 4.2,
            observations: 'Exemplo de registro para prévia',
            users: { name: 'Funcionário Exemplo' },
            created_at: new Date().toISOString()
        }
    ];

    generateVolumePDF(sampleData, true);
}

// Inicializar datas padrão (último mês)
function initializeDateFilters() {
    const today = new Date();
    const lastMonth = new Date();
    lastMonth.setMonth(today.getMonth() - 1);

    document.getElementById('reportStartDate').value = lastMonth.toISOString().split('T')[0];
    document.getElementById('reportEndDate').value = today.toISOString().split('T')[0];
}

// ===== FUNÇÕES ESPECÍFICAS PARA FOTO DO GERENTE =====

// Abrir modal de escolha de foto do gerente
function openManagerPhotoModal() {
    console.log('🔍 openManagerPhotoModal() chamada');
    
    const modal = document.getElementById('managerPhotoChoiceModal');
    console.log('📋 Modal encontrado:', !!modal);
    
    if (modal) {
        // Garantir que outros modais estejam fechados
        const otherModals = ['photoChoiceModal', 'cameraModal', 'managerCameraModal'];
        otherModals.forEach(modalId => {
            const otherModal = document.getElementById(modalId);
            if (otherModal) {
                otherModal.style.display = 'none';
                otherModal.style.visibility = 'hidden';
                otherModal.style.opacity = '0';
                otherModal.style.pointerEvents = 'none';
            }
        });
        
        // Forçar abertura do modal com múltiplas propriedades
        modal.style.display = 'flex';
        modal.style.visibility = 'visible';
        modal.style.opacity = '1';
        modal.style.pointerEvents = 'auto';
        modal.style.position = 'fixed';
        modal.style.zIndex = '999999';
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        
        console.log('✅ Modal aberto com sucesso');
    } else {
        console.error('❌ Modal não encontrado');
    }
}

// Fechar modal de escolha de foto do gerente
function closeManagerPhotoModal() {
    const modal = document.getElementById('managerPhotoChoiceModal');
    if (modal) {
        // Remover todas as classes que podem estar causando problemas
        modal.classList.remove('show', 'flex', 'block');
        modal.classList.add('hidden');
        
        // Forçar ocultação com múltiplas propriedades
        modal.style.display = 'none';
        modal.style.visibility = 'hidden';
        modal.style.opacity = '0';
        modal.style.pointerEvents = 'none';
        modal.style.position = 'fixed';
        modal.style.zIndex = '-1';
        
        console.log('✅ Modal de foto do gerente fechado');
    } else {
        console.log('❌ Modal de foto do gerente não encontrado');
    }
}

// Abrir câmera do gerente com verificação facial
async function openManagerCamera() {
    try {
        console.log('🔍 Abrindo câmera do gerente...');
        
        closeManagerPhotoModal();
        
        const modal = document.getElementById('managerCameraModal');
        const video = document.getElementById('managerCameraVideo');
        const processingScreen = document.getElementById('managerPhotoProcessingScreen');
        
        // Garantir que a tela de processamento esteja oculta
        if (processingScreen) {
            processingScreen.classList.add('hidden');
            processingScreen.style.display = 'none';
            processingScreen.style.visibility = 'hidden';
            processingScreen.style.opacity = '0';
            processingScreen.style.pointerEvents = 'none';
            console.log('✅ Tela de processamento do gerente ocultada');
        }
        
        modal.classList.add('show');
        
        // Verificar câmeras disponíveis
        const devices = await navigator.mediaDevices.enumerateDevices();
        const videoDevices = devices.filter(device => device.kind === 'videoinput');
        
        console.log('📹 Câmeras disponíveis:', videoDevices.length);
        
        let stream;
        if (videoDevices.length >= 2) {
            // Se tem duas câmeras, usar a traseira primeiro
            try {
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: 'environment',
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    } 
                });
                console.log('✅ Usando câmera traseira');
            } catch (error) {
                // Fallback para câmera frontal
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: 'user',
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    } 
                });
                console.log('✅ Usando câmera frontal (fallback)');
            }
        } else {
            // Se tem apenas uma câmera, usar ela
            stream = await navigator.mediaDevices.getUserMedia({ 
                video: { 
                    facingMode: 'user',
                    width: { ideal: 1920 },
                    height: { ideal: 1080 }
                } 
            });
            console.log('✅ Usando única câmera disponível');
        }
        
        video.srcObject = stream;
        window.managerCameraStream = stream;
        window.managerCurrentFacingMode = stream.getVideoTracks()[0].getSettings().facingMode;
        
        // Inicializar verificação facial
        initializeFaceDetection();
        
        console.log('✅ Câmera do gerente aberta com sucesso');
        
    } catch (error) {
        console.error('❌ Erro ao abrir câmera:', error);
        showNotification('Erro ao acessar câmera: ' + error.message, 'error');
    }
}

// Fechar câmera do gerente
function closeManagerCamera() {
    const modal = document.getElementById('managerCameraModal');
    if (modal) {
        modal.classList.remove('show');
        modal.style.display = 'none';
        modal.style.visibility = 'hidden';
        modal.style.opacity = '0';
        modal.style.pointerEvents = 'none';
    }
    
    // Parar stream da câmera de forma segura
    if (window.managerCameraStream) {
        try {
            window.managerCameraStream.getTracks().forEach(track => {
                track.stop();
                console.log('✅ Track da câmera parada:', track.kind);
            });
        } catch (error) {
            console.log('⚠️ Erro ao parar tracks da câmera:', error);
        }
        window.managerCameraStream = null;
    }
    
    // Resetar vídeo
    const video = document.getElementById('managerCameraVideo');
    if (video) {
        try {
            video.pause();
            video.srcObject = null;
            video.load();
        } catch (error) {
            console.log('⚠️ Erro ao resetar vídeo:', error);
        }
    }
    
    // Resetar indicadores
    resetManagerFaceVerification();
    
    // Limpar detecção facial
    if (faceDetectionInterval) {
        clearInterval(faceDetectionInterval);
        faceDetectionInterval = null;
    }
    
    // Resetar estados
    isFaceDetected = false;
    faceCentered = false;
    
    console.log('✅ Câmera do gerente fechada');
}

// Trocar câmera do gerente
async function switchManagerCamera() {
    try {
        if (window.managerCameraStream) {
            window.managerCameraStream.getTracks().forEach(track => track.stop());
        }
        
        const video = document.getElementById('managerCameraVideo');
        const stream = await navigator.mediaDevices.getUserMedia({ 
            video: { 
                facingMode: window.managerCameraFacingMode === 'user' ? 'environment' : 'user',
                width: { ideal: 1920 },
                height: { ideal: 1080 }
            } 
        });
        
        video.srcObject = stream;
        window.managerCameraStream = stream;
        window.managerCameraFacingMode = window.managerCameraFacingMode === 'user' ? 'environment' : 'user';
        
    } catch (error) {
        console.error('Erro ao trocar câmera:', error);
        showNotification('Erro ao trocar câmera: ' + error.message, 'error');
    }
}

// Variáveis globais para verificação facial
let faceDetectionInterval;
let isFaceDetected = false;
let faceCentered = false;

// Inicializar detecção facial
function initializeFaceDetection() {
    console.log('🔍 Inicializando detecção facial...');
    
    // Resetar estados
    isFaceDetected = false;
    faceCentered = false;
    updateFaceUI();
    
    // Iniciar detecção facial
    startFaceDetection();
}

// Iniciar detecção facial
function startFaceDetection() {
    const video = document.getElementById('managerCameraVideo');
    
    if (faceDetectionInterval) {
        clearInterval(faceDetectionInterval);
    }
    
    // Simular detecção facial (em produção, usar uma biblioteca como face-api.js)
    faceDetectionInterval = setInterval(() => {
        detectFace(video);
    }, 100); // Verificar a cada 100ms
}

// Detectar rosto (simulação)
function detectFace(video) {
    // Esta é uma simulação. Em produção, você usaria uma biblioteca real de detecção facial
    const rect = video.getBoundingClientRect();
    const centerX = rect.width / 2;
    const centerY = rect.height / 2;
    
    // Simular detecção baseada em movimento ou outras heurísticas
    const hasMovement = Math.random() > 0.3; // Simular que há movimento/detecção
    const isCentered = Math.random() > 0.4; // Simular centralização
    
    if (hasMovement) {
        isFaceDetected = true;
        if (isCentered) {
            faceCentered = true;
            updateFaceUI();
        } else {
            faceCentered = false;
            updateFaceUI();
        }
    } else {
        isFaceDetected = false;
        faceCentered = false;
        updateFaceUI();
    }
}

// Atualizar interface baseada na detecção
function updateFaceUI() {
    const faceCircle = document.getElementById('managerFaceCircle');
    const captureBtn = document.getElementById('managerCaptureBtn');
    const faceStatus = document.getElementById('managerFaceStatus');
    const faceWarning = document.getElementById('managerFaceWarning');
    
    if (!isFaceDetected) {
        // Rosto não detectado
        faceCircle.style.borderColor = 'rgb(239, 68, 68)'; // Vermelho
        faceStatus.textContent = 'Centralizando rosto...';
        faceStatus.style.color = 'rgba(255, 255, 255, 0.7)';
        
        // Desabilitar botão
        captureBtn.disabled = true;
        captureBtn.classList.add('opacity-50', 'cursor-not-allowed');
        captureBtn.classList.remove('hover:scale-105', 'hover:bg-gray-100');
        captureBtn.style.backgroundColor = 'rgba(255, 255, 255, 0.5)';
        
    } else if (!faceCentered) {
        // Rosto detectado mas não centralizado
        faceCircle.style.borderColor = 'rgb(239, 68, 68)'; // Vermelho
        faceStatus.textContent = 'Centralize o rosto no círculo';
        faceStatus.style.color = 'rgba(255, 255, 255, 0.7)';
        
        // Desabilitar botão
        captureBtn.disabled = true;
        captureBtn.classList.add('opacity-50', 'cursor-not-allowed');
        captureBtn.classList.remove('hover:scale-105', 'hover:bg-gray-100');
        captureBtn.style.backgroundColor = 'rgba(255, 255, 255, 0.5)';
        
    } else {
        // Rosto centralizado
        faceCircle.style.borderColor = 'rgb(34, 197, 94)'; // Verde
        faceStatus.textContent = 'Rosto centralizado!';
        faceStatus.style.color = 'rgb(34, 197, 94)';
        
        // Habilitar botão
        captureBtn.disabled = false;
        captureBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        captureBtn.classList.add('hover:scale-105', 'hover:bg-gray-100');
        captureBtn.style.backgroundColor = 'white';
        
        // Ocultar aviso se estiver visível
        if (faceWarning) {
            faceWarning.style.opacity = '0';
        }
    }
}

// Capturar foto do gerente com verificação facial
async function captureManagerPhoto() {
    // Verificar se o rosto está centralizado
    if (!faceCentered) {
        const faceWarning = document.getElementById('managerFaceWarning');
        if (faceWarning) {
            faceWarning.style.opacity = '1';
            setTimeout(() => {
                faceWarning.style.opacity = '0';
            }, 3000);
        }
        return;
    }
    
    try {
        console.log('📸 Capturando foto do gerente...');
        
        const video = document.getElementById('managerCameraVideo');
        const canvas = document.getElementById('managerCameraCanvas');
        const processingScreen = document.getElementById('managerPhotoProcessingScreen');
        
        if (!video || !canvas) {
            throw new Error('Elementos de vídeo ou canvas não encontrados');
        }
        
        // Verificar se o vídeo está pronto
        if (video.readyState < 2) {
            throw new Error('Vídeo não está pronto');
        }
        
        // Mostrar tela de processamento
        if (processingScreen) {
            processingScreen.classList.remove('hidden');
        }
        
        // Configurar canvas
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        
        // Desenhar frame do vídeo no canvas
        const ctx = canvas.getContext('2d');
        ctx.drawImage(video, 0, 0);
        
        // Converter para blob
        canvas.toBlob(async (blob) => {
            try {
                if (!blob) {
                    throw new Error('Falha ao criar blob da imagem');
                }
                
                const file = new File([blob], 'manager-photo.jpg', { type: 'image/jpeg' });
                
                // Fechar câmera primeiro
                closeManagerCamera();
                
                // Processar foto
                await processManagerPhoto(file);
                
            } catch (error) {
                console.error('Erro ao processar foto:', error);
                showNotification('Erro ao processar foto: ' + error.message, 'error');
            } finally {
                if (processingScreen) {
                    processingScreen.classList.add('hidden');
                }
            }
        }, 'image/jpeg', 0.8);
        
    } catch (error) {
        console.error('Erro ao capturar foto:', error);
        showNotification('Erro ao capturar foto: ' + error.message, 'error');
        
        // Ocultar tela de processamento em caso de erro
        const processingScreen = document.getElementById('managerPhotoProcessingScreen');
        if (processingScreen) {
            processingScreen.classList.add('hidden');
        }
    }
}

// Processar foto do gerente
async function processManagerPhoto(file) {
    try {
        // Validar arquivo
        if (!file || file.size === 0) {
            throw new Error('Arquivo inválido');
        }
        
        if (file.size > 2 * 1024 * 1024) {
            throw new Error('Arquivo muito grande (máximo 2MB)');
        }
        
        // Mostrar preview
        previewManagerProfilePhoto(file);
        
        // Upload da foto
        // // const supabase = await getSupabaseClient(); // REMOVIDO // REMOVIDO - usando MySQL
        const { data: { user } } = await supabase.auth.getUser();
        
        if (!user) throw new Error('Usuário não autenticado');
        
        const photoUrl = await uploadManagerProfilePhoto(file, user.id);
        
        // Atualizar perfil
        const { error: updateError } = await supabase
            .from('users')
            .update({ profile_photo_url: photoUrl })
            .eq('id', user.id);
            
        if (updateError) throw updateError;
        
        // Atualizar exibição
        updateManagerPhotoDisplay(photoUrl);
        
        // Fechar modal automaticamente
        closeManagerPhotoModal();
        
        // Fechar câmera se estiver aberta
        closeManagerCamera();
        
        // Aguardar um pouco antes de mostrar notificação
        setTimeout(() => {
            showNotification('Foto de perfil atualizada com sucesso!', 'success');
        }, 200);
        
    } catch (error) {
        console.error('Erro ao processar foto do gerente:', error);
        showNotification('Erro ao processar foto: ' + error.message, 'error');
    }
}

// Preview da foto do gerente
function previewManagerProfilePhoto(file) {
    const preview = document.getElementById('managerProfilePreview');
    const placeholder = document.getElementById('managerProfilePlaceholder');
    
    if (preview && placeholder) {
        const url = URL.createObjectURL(file);
        preview.src = url;
        preview.style.display = 'block';
        placeholder.style.display = 'none';
    }
}

// Selecionar da galeria do gerente
function selectManagerFromGallery() {
    const input = document.getElementById('managerProfilePhotoInput');
    if (input) {
        input.click();
    }
}

// Preview da foto da galeria do gerente
function handleManagerGallerySelection(input) {
    if (input.files && input.files[0]) {
        const file = input.files[0];
        console.log('📸 Arquivo selecionado da galeria:', file.name);
        
        // Fechar modal de escolha primeiro
        closeManagerPhotoModal();
        
        // Aguardar um pouco antes de processar
        setTimeout(() => {
            processManagerPhoto(file);
        }, 100);
    }
}

// Verificação facial do gerente
function startManagerFaceVerification() {
    const focusText = document.getElementById('managerFocusText');
    const focusTimer = document.getElementById('managerFocusTimer');
    const focusIndicator = document.getElementById('managerFocusIndicator');
    const timerCount = document.getElementById('managerTimerCount');
    
    if (focusText) focusText.textContent = 'Focando...';
    if (focusTimer) focusTimer.classList.remove('hidden');
    if (focusIndicator) focusIndicator.classList.remove('opacity-0');
    
    let count = 3;
    const timer = setInterval(() => {
        if (timerCount) timerCount.textContent = count;
        
        if (count <= 0) {
            clearInterval(timer);
            captureManagerPhoto();
        }
        count--;
    }, 1000);
    
    window.managerFaceVerificationTimer = timer;
}

// Resetar verificação facial do gerente
function resetManagerFaceVerification() {
    const focusText = document.getElementById('managerFocusText');
    const focusTimer = document.getElementById('managerFocusTimer');
    const focusIndicator = document.getElementById('managerFocusIndicator');
    
    if (focusText) focusText.textContent = 'Posicione o rosto no centro';
    if (focusTimer) focusTimer.classList.add('hidden');
    if (focusIndicator) focusIndicator.classList.add('opacity-0');
    
    if (window.managerFaceVerificationTimer) {
        clearInterval(window.managerFaceVerificationTimer);
        window.managerFaceVerificationTimer = null;
    }
}

// Atualizar exibição da foto do gerente
function updateManagerPhotoDisplay(photoUrl) {
    console.log('🖼️ Atualizando exibição da foto:', photoUrl);
    
    if (!photoUrl) {
        console.log('❌ URL da foto não fornecida');
        return;
    }
    
    // Atualizar foto no header
    const headerPhoto = document.getElementById('headerProfilePhoto');
    const headerPlaceholder = document.getElementById('headerProfileIcon');
    if (headerPhoto && headerPlaceholder) {
        headerPhoto.src = photoUrl + '?t=' + Date.now();
        headerPhoto.style.display = 'block';
        headerPhoto.style.visibility = 'visible';
        headerPhoto.classList.remove('hidden');
        headerPhoto.classList.add('block');
        
        headerPlaceholder.style.display = 'none';
        headerPlaceholder.style.visibility = 'hidden';
        headerPlaceholder.classList.add('hidden');
        headerPlaceholder.classList.remove('block');
        
        console.log('✅ Foto do header atualizada');
    }
    
    // Atualizar foto no modal de perfil
    const modalPhoto = document.getElementById('modalProfilePhoto');
    const modalPlaceholder = document.getElementById('modalProfileIcon');
    if (modalPhoto && modalPlaceholder) {
        modalPhoto.src = photoUrl + '?t=' + Date.now();
        modalPhoto.style.display = 'block';
        modalPhoto.style.visibility = 'visible';
        modalPhoto.classList.remove('hidden');
        modalPhoto.classList.add('block');
        
        modalPlaceholder.style.display = 'none';
        modalPlaceholder.style.visibility = 'hidden';
        modalPlaceholder.classList.add('hidden');
        modalPlaceholder.classList.remove('block');
        
        console.log('✅ Foto do modal atualizada');
    }
    
    // Atualizar preview no formulário de edição
    const preview = document.getElementById('managerProfilePreview');
    const placeholder = document.getElementById('managerProfilePlaceholder');
    if (preview && placeholder) {
        preview.src = photoUrl + '?t=' + Date.now();
        preview.style.display = 'block';
        preview.style.visibility = 'visible';
        preview.classList.remove('hidden');
        preview.classList.add('block');
        
        placeholder.style.display = 'none';
        placeholder.style.visibility = 'hidden';
        placeholder.classList.add('hidden');
        placeholder.classList.remove('block');
        
        console.log('✅ Preview atualizado');
    }
}

// Upload da foto do gerente para o Supabase
async function uploadManagerProfilePhoto(file, userId) {
    try {
        // // const supabase = await getSupabaseClient(); // REMOVIDO // REMOVIDO - usando MySQL
        
        // Obter farm_id do usuário atual
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) throw new Error('Usuário não autenticado');
        
        const { data: userData, error: userError } = await supabase
            .from('users')
            .select('farm_id')
            .eq('id', user.id)
            .single();
            
        if (userError || !userData?.farm_id) {
            throw new Error('Farm ID não encontrado');
        }
        
        // Criar nome único para o arquivo
        const timestamp = Date.now();
        const randomId = Math.random().toString(36).substr(2, 9);
        const fileExt = file.name.split('.').pop() || 'jpg';
        const fileName = `manager_${userId}_${timestamp}_${randomId}.${fileExt}`;
        const filePath = `farm_${userData.farm_id}/${fileName}`;
        
        // Upload do arquivo
        const { data, error } = await supabase.storage
            .from('profile-photos')
            .upload(filePath, file, {
                cacheControl: '3600',
                upsert: false
            });
            
        if (error) {
            console.error('Erro no upload:', error);
            throw error;
        }
        
        // Obter URL pública
        const { data: { publicUrl } } = supabase.storage
            .from('profile-photos')
            .getPublicUrl(filePath);
            
        return publicUrl;
        
    } catch (error) {
        console.error('Erro no upload da foto do gerente:', error);
        throw error;
    }
}

// Carregar biblioteca Excel dinamicamente
function loadExcelLibrary() {
    if (typeof XLSX === 'undefined') {
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js';
        script.onload = function() {
    
        };
        script.onerror = function() {
        };
        document.head.appendChild(script);
    }
}

// Evento para carregar dados quando a aba de relatórios for aberta
document.addEventListener('DOMContentLoaded', function() {
    loadExcelLibrary();
    
    // Carregar dados quando a aba for aberta
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                const reportsTab = document.getElementById('reports-tab');
                if (reportsTab && !reportsTab.classList.contains('hidden')) {
                    loadReportTabSettings();
                    loadReportStats();
                    initializeDateFilters();
                }
            }
        });
    });
    
    const reportsTab = document.getElementById('reports-tab');
    if (reportsTab) {
        observer.observe(reportsTab, { attributes: true });
    }
});

            // App Version Display
        document.addEventListener('DOMContentLoaded', function() {
            // Adiciona versão do app no perfil do usuário
            const appVersion = '1.0.0';
            
            // Função para adicionar versão em elementos de perfil
            function addVersionToProfile() {
                const profileElements = document.querySelectorAll('.user-profile, .profile-info, .user-info');
                profileElements.forEach(element => {
                    if (!element.querySelector('.app-version')) {
                        const versionDiv = document.createElement('div');
                        versionDiv.className = 'app-version text-xs text-gray-500 mt-2';
                        versionDiv.innerHTML = `App v${appVersion}`;
                        element.appendChild(versionDiv);
                    }
                });
                
                // Adicionar no footer se existir
                const footer = document.querySelector('footer, .footer');
                if (footer && !footer.querySelector('.app-version')) {
                    const versionDiv = document.createElement('div');
                    versionDiv.className = 'app-version text-xs text-gray-500 text-center mt-4';
                    versionDiv.innerHTML = `LacTech v${appVersion}`;
                    footer.appendChild(versionDiv);
                }
            }
            
            // Função para adicionar versão no modal de perfil
            function addVersionToProfileModal() {
                const profileModal = document.getElementById('profileModal');
                if (profileModal && !profileModal.querySelector('.app-version')) {
                    const versionDiv = document.createElement('div');
                    versionDiv.className = 'app-version text-xs text-gray-500 text-center mt-4 p-4 border-t border-gray-200';
                    versionDiv.innerHTML = `LacTech v${appVersion}`;
                    profileModal.querySelector('.modal-content').appendChild(versionDiv);
                }
            }
            
            // Executar após carregamento
            setTimeout(addVersionToProfile, 1000);
            
            // Adicionar versão quando o modal de perfil for aberto
            const originalOpenProfileModal = window.openProfileModal;
            window.openProfileModal = function() {
                if (originalOpenProfileModal) {
                    originalOpenProfileModal();
                }
                setTimeout(addVersionToProfileModal, 100);
            };
        });
        
        // Sistema de Carregamento
        const loadingSteps = [
            { message: 'Inicializando sistema...', subMessage: 'Preparando ambiente...', progress: 10 },
            { message: 'Conectando ao banco de dados...', subMessage: 'Estabelecendo conexão...', progress: 25 },
            { message: 'Carregando dados da fazenda...', subMessage: 'Buscando informações...', progress: 40 },
            { message: 'Configurando interface...', subMessage: 'Preparando componentes...', progress: 60 },
            { message: 'Carregando gráficos...', subMessage: 'Preparando visualizações...', progress: 80 },
            { message: 'Finalizando carregamento...', subMessage: 'Quase pronto...', progress: 95 },
            { message: 'Sistema pronto!', subMessage: 'Bem-vindo ao LacTech', progress: 100 }
        ];

        let currentStep = 0;
        let loadingInterval;

        // DESABILITADO - função duplicada, usando apenas modal HTML
        function updateLoadingScreen() {
<<<<<<< HEAD
            // Função desabilitada - usando apenas a modal de carregamento HTML
            return;
            // Código do sistema de carregamento removido
=======
            const loadingMessage = document.getElementById('loadingMessage');
            const loadingSubMessage = document.getElementById('loadingSubMessage');
            const loadingProgress = document.getElementById('loadingProgress');
            const loadingPercentage = document.getElementById('loadingPercentage');
            const farmNameLoading = document.getElementById('farmNameLoading');

            if (currentStep < loadingSteps.length) {
                const step = loadingSteps[currentStep];
                
                if (loadingMessage) loadingMessage.textContent = step.message;
                if (loadingSubMessage) loadingSubMessage.textContent = step.subMessage;
                if (loadingProgress) loadingProgress.style.width = step.progress + '%';
                if (loadingPercentage) loadingPercentage.textContent = step.progress + '%';
                
                // Atualizar nome da fazenda quando disponível
                if (currentStep === 2 && farmNameLoading) {
                    // Tentar pegar o nome da fazenda do localStorage ou de outro lugar
                    const farmName = localStorage.getItem('farmName') || 'Sistema de Gestão';
                    farmNameLoading.textContent = farmName;
                }
                
                currentStep++;
            } else {
                // Carregamento completo
                clearInterval(loadingInterval);
                setTimeout(() => {
                    const loadingScreen = document.getElementById('loadingScreen');
                    if (loadingScreen) {
                        loadingScreen.style.opacity = '0';
                        loadingScreen.style.transition = 'opacity 0.5s ease-out';
                        setTimeout(() => {
                            loadingScreen.style.display = 'none';
                            loadingScreen.style.visibility = 'hidden';
                            loadingScreen.style.pointerEvents = 'none';
                        }, 500);
                    }
                }, 500);
            }
>>>>>>> parent of 0eb3d2f (.)
        }

        // Iniciar sistema
        document.addEventListener('DOMContentLoaded', function() {
<<<<<<< HEAD
            console.log('✅ Sistema carregado sem tela de loading');
            
            // GARANTIR que não haja tela de loading criada dinamicamente
            const loadingScreens = document.querySelectorAll('.loading-screen, #loadingScreen');
            loadingScreens.forEach(screen => {
                console.log('🗑️ Removendo tela de loading encontrada:', screen.id || screen.className);
                screen.remove();
            });
=======
                    // Forçar fechamento do modal de foto do gerente
        const managerPhotoChoiceModal = document.getElementById('managerPhotoChoiceModal');
        if (managerPhotoChoiceModal) {
            managerPhotoChoiceModal.style.display = 'none';
            managerPhotoChoiceModal.style.visibility = 'hidden';
            managerPhotoChoiceModal.style.opacity = '0';
            managerPhotoChoiceModal.style.pointerEvents = 'none';
            managerPhotoChoiceModal.classList.add('hidden');
            managerPhotoChoiceModal.classList.remove('flex');
        }
        
        // Garantir que o modal MAIS esteja fechado
        const moreModal = document.getElementById('moreModal');
        if (moreModal) {
            moreModal.style.display = 'none';
            moreModal.style.visibility = 'hidden';
            moreModal.style.opacity = '0';
            moreModal.style.pointerEvents = 'none';
            moreModal.classList.add('hidden');
        }
        
        // Garantir que o modal de foto do gerente esteja fechado
        const managerPhotoModal = document.getElementById('managerPhotoChoiceModal');
        if (managerPhotoModal) {
            managerPhotoModal.classList.remove('show', 'flex', 'block');
            managerPhotoModal.classList.add('hidden');
            managerPhotoModal.style.display = 'none';
            managerPhotoModal.style.visibility = 'hidden';
            managerPhotoModal.style.opacity = '0';
            managerPhotoModal.style.pointerEvents = 'none';
            managerPhotoModal.style.position = 'fixed';
            managerPhotoModal.style.zIndex = '-1';
            console.log('✅ Modal de foto do gerente fechado na inicialização');
        }
>>>>>>> parent of 0eb3d2f (.)
            
            // Iniciar sequência de carregamento
            loadingInterval = setInterval(updateLoadingScreen, 1000);
            
<<<<<<< HEAD
            criticalModals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.style.display = 'none';
                    modal.style.visibility = 'hidden';
                    modal.classList.add('hidden');
                    modal.classList.remove('show');
                }
            });
            console.log('✅ Modais HTML estáticos fechados');
            
            // PASSO 2: Limpar variáveis globais
            window.isCameraOpen = false;
            window.cameraStream = null;
            window.currentPhotoMode = '';
            
            // Sistema de carregamento REMOVIDO - sem tela de loading
            
            console.log('✅ Sistema inicializado com sucesso!');
=======
                    // Garantir que os modais fiquem fechados na inicialização
        const photoChoiceModal = document.getElementById('photoChoiceModal');
        const cameraModal = document.getElementById('cameraModal');
        const managerCameraModal = document.getElementById('managerCameraModal');
        
        if (photoChoiceModal) {
            photoChoiceModal.classList.add('hidden');
            photoChoiceModal.classList.remove('flex');
            photoChoiceModal.style.display = 'none';
        }
        
        if (cameraModal) {
            cameraModal.classList.add('hidden');
            cameraModal.style.display = 'none';
        }
        
        if (managerCameraModal) {
            managerCameraModal.style.display = 'none';
        }
        
        // Garantir que as variáveis estejam limpas
        isCameraOpen = false;
        cameraStream = null;
        currentPhotoMode = '';
        
        // Configurar header dinâmico do modal de perfil
        setupProfileModalHeader();
>>>>>>> parent of 0eb3d2f (.)
        });
        
        // Remover foto do gerente
        async function removeManagerPhoto() {
            try {
                const confirmed = confirm('Tem certeza que deseja remover sua foto de perfil?');
                if (!confirmed) return;
                
                // // const supabase = await getSupabaseClient(); // REMOVIDO // REMOVIDO - usando MySQL
                const { data: { user } } = await supabase.auth.getUser();
                
                if (!user) {
                    showNotification('Usuário não autenticado', 'error');
                    return;
                }
                
                // Remover foto do storage se existir
                const { data: userData } = await supabase
                    .from('users')
                    .select('profile_photo_url')
                    .eq('id', user.id)
                    .single();
                
                if (userData && userData.profile_photo_url) {
                    // Extrair o caminho do arquivo da URL
                    const photoPath = userData.profile_photo_url.split('/').pop();
                    if (photoPath) {
                        await supabase.storage
                            .from('profile-photos')
                            .remove([photoPath]);
                    }
                }
                
                // Atualizar o banco de dados removendo a referência da foto
                const { error: updateError } = await supabase
                    .from('users')
                    .update({ 
                        profile_photo_url: null,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', user.id);
                
                if (updateError) {
                    throw updateError;
                }
                
                // Atualizar a interface
                const headerPhoto = document.getElementById('headerProfilePhoto');
                const modalPhoto = document.getElementById('modalProfilePhoto');
                const modalIcon = document.getElementById('modalProfileIcon');
                
                if (headerPhoto) {
                    headerPhoto.classList.add('hidden');
                }
                
                if (modalPhoto) {
                    modalPhoto.classList.add('hidden');
                }
                
                if (modalIcon) {
                    modalIcon.classList.remove('hidden');
                }
                
                showNotification('Foto de perfil removida com sucesso!', 'success');
                
            } catch (error) {
                console.error('Erro ao remover foto do gerente:', error);
                showNotification('Erro ao remover foto de perfil', 'error');
            }
        }
        
        // Configurar header dinâmico do modal de perfil (apenas mobile)
        function setupProfileModalHeader() {
            const profileModal = document.querySelector('#profileModal .modal-content');
            const header = document.getElementById('profileModalHeader');
            let lastScrollTop = 0;
            let isScrolling = false;
            
            // Verificar se é mobile
            const isMobile = window.innerWidth <= 768;
            
            if (profileModal && header && isMobile) {
                // Função para controlar a visibilidade do header
                function handleScroll() {
                    if (!isScrolling) {
                        isScrolling = true;
                        requestAnimationFrame(function() {
                            const scrollTop = profileModal.scrollTop;
                            
                            // Detectar direção do scroll
                            if (scrollTop > lastScrollTop && scrollTop > 50) {
                                // Scroll para baixo - esconder header completamente
                                header.style.transform = 'translateY(-110%)';
                                header.style.opacity = '0';
                            } else if (scrollTop < lastScrollTop) {
                                // Scroll para cima - mostrar header
                                header.style.transform = 'translateY(0)';
                                header.style.opacity = '1';
                            }
                            
                            // Mostrar header quando estiver no topo
                            if (scrollTop <= 10) {
                                header.style.transform = 'translateY(0)';
                                header.style.opacity = '1';
                            }
                            
                            lastScrollTop = scrollTop;
                            isScrolling = false;
                        });
                    }
                }
                
                // Remover listener anterior se existir
                profileModal.removeEventListener('scroll', handleScroll);
                
                // Adicionar listener de scroll
                profileModal.addEventListener('scroll', handleScroll);
                
                // Inicializar estado do header
                header.style.transform = 'translateY(0)';
            } else if (header && !isMobile) {
                // No desktop, sempre mostrar o header
                header.style.transform = 'translateY(0)';
            }
        }
        
        // ==================== FUNÇÕES DO MODAL MAIS ====================
        
        // Abrir modal MAIS
        function openMoreModal() {
            const modal = document.getElementById('moreModal');
            if (modal) {
            
                modal.style.display = 'block';
                modal.style.visibility = 'visible';
                modal.style.opacity = '1';
                modal.style.pointerEvents = 'auto';
                modal.classList.remove('hidden');
            
            // Forçar reflow
            modal.offsetHeight;
            
            // Atualizar logo da Xandria Store
            setTimeout(updateXandriaStoreIcon, 100);
            }
        }
        
        // Fechar modal MAIS
        function closeMoreModal() {
            const modal = document.getElementById('moreModal');
            if (modal) {
                modal.style.display = 'none';
                modal.style.visibility = 'hidden';
                modal.style.opacity = '0';
                modal.style.pointerEvents = 'none';
                modal.classList.add('hidden');
            }
        }

        // ==================== FUNÇÕES REMOVIDAS - CHAT ====================
        // Sistema de chat removido para simplificar o sistema da Lagoa do Mato
        // Todas as funcionalidades de chat foram removidas
        console.log('ℹ️ Sistema de chat desabilitado - Lagoa do Mato');
        
        async function openChatModal() {
            
            const modal = document.getElementById('chatModal');
            if (modal) {
                modal.classList.remove('hidden');
                modal.style.display = 'flex';
                document.body.style.overflow = 'hidden';
                
                // Configurar listener de scroll do chat
                setTimeout(() => {
                    setupChatScrollListener();
                }, 100);
                
                // Atualizar status online do usuário atual
                try {
                    // // const supabase = await getSupabaseClient(); // REMOVIDO // REMOVIDO - usando MySQL
                    const { data: { user } } = await supabase.auth.getUser();
                    if (user) {
                        await updateUserLastLogin(user.id);
                        
                        // Buscar farm_id para configurar real-time
                        const { data: userData } = await supabase
                            .from('users')
                            .select('farm_id')
                            .eq('id', user.id)
                            .single();
                        
                        if (userData?.farm_id) {
                            // Configurar real-time para chat
                            setupChatRealtime(userData.farm_id);
                        }
                    }
                } catch (error) {
                    console.error('Erro ao atualizar status online:', error);
                }
                
                loadEmployees();
            }
        }

        // Fechar modal de chat
        function closeChatModal() {
            const modal = document.getElementById('chatModal');
            if (modal) {
                modal.classList.add('hidden');
                modal.style.display = 'none';
                document.body.style.overflow = 'auto';
                
                // Desconectar real-time do chat
                if (chatRealtimeChannel) {
                    disconnectRealtime(chatRealtimeChannel);
                    chatRealtimeChannel = null;
                    console.log('🔌 Real-time do chat desconectado');
                }
                
                // Parar polling
                if (chatPollingInterval) {
                    clearInterval(chatPollingInterval);
                    chatPollingInterval = null;
                    console.log('🔌 Polling do chat parado');
                }
            }
        }

        // Carregar funcionários da fazenda
        async function loadEmployees() {
            try {
                console.log('🔄 Carregando funcionários...');
                
                // // const supabase = await getSupabaseClient(); // REMOVIDO // REMOVIDO - usando MySQL
                const { data: { user } } = await supabase.auth.getUser();
                
                if (!user) {
                    console.error('❌ Usuário não autenticado');
                    return;
                }

                console.log('👤 Usuário autenticado:', user.email);
                
                // Definir currentUser globalmente
                window.currentUser = user;

                // Buscar farm_id do usuário
                const { data: userData, error: userError } = await supabase
                    .from('users')
                    .select('farm_id')
                    .eq('id', user.id)
                    .single();

                if (userError) {
                    console.error('❌ Erro ao buscar farm_id:', userError);
                    return;
                }

                if (!userData?.farm_id) {
                    console.error('❌ Farm ID não encontrado');
                    return;
                }

                console.log('🏢 Farm ID:', userData.farm_id);

                // Usar o serviço de sincronização para buscar funcionários
                const employees = await getFarmUsers(userData.farm_id);
                console.log('👥 Funcionários encontrados:', employees.length);
                
                // Incluir todos os usuários (gerente + funcionários)
                displayEmployees(employees);
            } catch (error) {
                console.error('❌ Erro ao carregar funcionários:', error);
                showNotification('Erro ao carregar funcionários: ' + error.message, 'error');
            }
        }

        // Exibir funcionários na lista
        function displayEmployees(employees) {
            console.log('📋 Exibindo funcionários:', employees);
            
            const employeesList = document.getElementById('employeesList');
            const onlineEmployees = document.getElementById('onlineEmployees');
            
            if (!employeesList) {
                console.error('❌ Elemento employeesList não encontrado');
                return;
            }
            
            if (!onlineEmployees) {
                console.error('❌ Elemento onlineEmployees não encontrado');
                return;
            }

            console.log('✅ Elementos encontrados, limpando listas...');
            employeesList.innerHTML = '';
            onlineEmployees.innerHTML = '';

            employees.forEach(employee => {
                // Debug: verificar IDs
                console.log('🔍 Comparando:', {
                    employeeId: employee.id,
                    currentUserId: window.currentUser?.id,
                    employeeEmail: employee.email,
                    currentUserEmail: window.currentUser?.email,
                    employeeName: employee.name
                });
                
                // Filtrar o próprio gerente da lista
                if (employee.id === window.currentUser?.id || employee.email === window.currentUser?.email) {
                    console.log('🚫 Filtrando próprio usuário da lista:', employee.name);
                    return; // Pular o próprio usuário
                }
                
                const isOnline = isEmployeeOnline(employee);
                const initial = employee.name.charAt(0).toUpperCase();
                const userColor = generateUserColor(employee.name);
                
                // Verificar se tem foto de perfil
                const hasPhoto = employee.profile_photo_url && employee.profile_photo_url.trim() !== '';
                
                // Gerar avatar (foto ou letra) para lista principal
                let mainAvatarHtml;
                if (hasPhoto) {
                    mainAvatarHtml = `
                        <img src="${employee.profile_photo_url}?t=${Date.now()}" 
                             alt="Foto de ${employee.name}" 
                             class="w-10 h-10 rounded-full object-cover"
                             onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
                             onload="this.nextElementSibling.style.display='none';">
                        <div class="w-10 h-10 bg-gradient-to-br ${userColor} rounded-full flex items-center justify-center" style="display: flex;">
                            <span class="text-white font-semibold text-sm">${initial}</span>
                        </div>
                    `;
                } else {
                    mainAvatarHtml = `
                        <div class="w-10 h-10 bg-gradient-to-br ${userColor} rounded-full flex items-center justify-center">
                            <span class="text-white font-semibold text-sm">${initial}</span>
                        </div>
                    `;
                }
                
                // Item da lista principal
                const employeeItem = document.createElement('div');
                employeeItem.className = 'flex items-center space-x-3 p-2.5 rounded-lg hover:bg-gray-50 cursor-pointer transition-colors';
                employeeItem.onclick = () => selectEmployee(employee);
                
                employeeItem.innerHTML = `
                    <div class="relative">
                        ${mainAvatarHtml}
                        ${isOnline ? '<div class="absolute -bottom-0.5 -right-0.5 w-3 h-3 bg-green-500 border-2 border-white rounded-full"></div>' : ''}
                    </div>
                    <div class="flex-1 min-w-0">
                        <h4 class="font-medium text-gray-900 truncate text-sm">${employee.name}</h4>
                        <p class="text-xs text-gray-500 truncate">${employee.role}</p>
                    </div>
                    <div class="text-xs text-gray-400">
                        ${isOnline ? 'Online' : formatLastSeen(employee.last_login)}
                    </div>
                `;
                
                employeesList.appendChild(employeeItem);

                // Funcionário online (se estiver online)
                if (isOnline) {
                    const onlineItem = document.createElement('div');
                    onlineItem.className = 'flex flex-col items-center space-y-1 cursor-pointer';
                    onlineItem.onclick = () => selectEmployee(employee);
                    
                    // Gerar avatar (foto ou letra) para seção online
                    let onlineAvatarHtml;
                    if (hasPhoto) {
                        onlineAvatarHtml = `
                            <img src="${employee.profile_photo_url}?t=${Date.now()}" 
                                 alt="Foto de ${employee.name}" 
                                 class="w-10 h-10 rounded-full object-cover"
                                 onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
                                 onload="this.nextElementSibling.style.display='none';">
                            <div class="w-10 h-10 bg-gradient-to-br ${userColor} rounded-full flex items-center justify-center" style="display: flex;">
                                <span class="text-white font-semibold text-xs">${initial}</span>
                            </div>
                        `;
                    } else {
                        onlineAvatarHtml = `
                            <div class="w-10 h-10 bg-gradient-to-br ${userColor} rounded-full flex items-center justify-center">
                                <span class="text-white font-semibold text-xs">${initial}</span>
                            </div>
                        `;
                    }
                    
                    onlineItem.innerHTML = `
                        <div class="relative">
                            ${onlineAvatarHtml}
                            <div class="absolute -bottom-0.5 -right-0.5 w-3 h-3 bg-green-500 border-2 border-white rounded-full"></div>
                        </div>
                        <span class="text-xs text-gray-600 text-center max-w-16 truncate">${employee.name}</span>
                    `;
                    
                    onlineEmployees.appendChild(onlineItem);
                }
            });
            
            console.log('✅ Funcionários exibidos com sucesso!');
            console.log('📊 Total de funcionários:', employees.length);
            console.log('🟢 Funcionários online:', document.querySelectorAll('#onlineEmployees > div').length);
        }

        // Verificar se funcionário está online
        function isEmployeeOnline(employee) {
            // Verificar se o objeto employee existe
            if (!employee) {
                console.warn('⚠️ Employee object is null or undefined');
                return false;
            }
            
            // Usar a coluna is_online se disponível, senão usar last_login
            if (employee.is_online !== undefined && employee.is_online !== null) {
                return employee.is_online;
            }
            
            // Fallback para last_login
            if (!employee.last_login) return false;
            const now = new Date();
            const loginTime = new Date(employee.last_login);
            const diffMinutes = (now - loginTime) / (1000 * 60);
            return diffMinutes < 15; // Considera online se fez login nos últimos 15 minutos
        }

        // Formatar última vez visto
        function formatLastSeen(lastLogin) {
            if (!lastLogin) return 'Nunca';
            
            try {
                const now = new Date();
                const loginTime = new Date(lastLogin);
                
                // Verificar se a data é válida
                if (isNaN(loginTime.getTime())) {
                    return 'Data inválida';
                }
                
                const diffMinutes = (now - loginTime) / (1000 * 60);
                
                if (diffMinutes < 60) return 'Há ' + Math.floor(diffMinutes) + 'min';
                if (diffMinutes < 1440) return 'Há ' + Math.floor(diffMinutes / 60) + 'h';
                return 'Há ' + Math.floor(diffMinutes / 1440) + ' dias';
            } catch (error) {
                console.error('Erro ao formatar lastLogin:', error);
                return 'Erro';
            }
        }

        // Selecionar funcionário para conversa
        function selectEmployee(employee) {
            // Verificar se o employee existe
            if (!employee) {
                console.error('❌ Employee object is null or undefined');
                return;
            }
            
            
            window.selectedEmployee = employee;
            
            // Verificar se os elementos existem antes de usar
            const nameElement = document.getElementById('selectedEmployeeName');
            const initialElement = document.getElementById('selectedEmployeeInitial');
            const statusElement = document.getElementById('selectedEmployeeStatus');
            const messageInput = document.getElementById('chatMessageInput');
            const sendBtn = document.getElementById('sendMessageBtn');
            
            if (nameElement) nameElement.textContent = employee.name || 'Nome não disponível';
            if (statusElement) statusElement.textContent = isEmployeeOnline(employee) ? 'Online' : 'Offline';
            
            // Atualizar avatar no header com foto de perfil ou inicial colorida
            if (initialElement) {
                const avatarContainer = initialElement.parentElement;
                if (avatarContainer) {
                    // Limpar conteúdo anterior
                    avatarContainer.innerHTML = '';
                    
                    if (employee.profile_photo_url) {
                        // Usar foto de perfil
                        const img = document.createElement('img');
                        img.src = employee.profile_photo_url;
                        img.alt = employee.name || 'Avatar';
                        img.className = 'w-10 h-10 rounded-full object-cover';
                        img.onerror = () => {
                            // Fallback para inicial colorida se a imagem falhar
                            const userColor = generateUserColor(employee.name);
                            const senderInitial = (employee.name || '?').charAt(0).toUpperCase();
                            avatarContainer.className = `w-10 h-10 bg-gradient-to-br ${userColor} rounded-full flex items-center justify-center`;
                            avatarContainer.innerHTML = `<span class="text-white font-semibold text-sm">${senderInitial}</span>`;
                        };
                        avatarContainer.appendChild(img);
                    } else {
                        // Usar inicial colorida
                        const userColor = generateUserColor(employee.name);
                        const senderInitial = (employee.name || '?').charAt(0).toUpperCase();
                        avatarContainer.className = `w-10 h-10 bg-gradient-to-br ${userColor} rounded-full flex items-center justify-center`;
                        avatarContainer.innerHTML = `<span class="text-white font-semibold text-sm">${senderInitial}</span>`;
                    }
                }
            }
            
            if (messageInput) messageInput.disabled = false;
            if (sendBtn) sendBtn.disabled = false;
            
            // Mostrar interface do chat e ocultar UI inicial
            const initialUI = document.getElementById('initialChatUI');
            const chatMessages = document.getElementById('chatMessages');
            const chatInputArea = document.getElementById('chatInputArea');
            const chatHeader = document.getElementById('chatHeader');
            
            if (initialUI) initialUI.classList.add('hidden');
            if (chatMessages) chatMessages.classList.remove('hidden');
            if (chatInputArea) chatInputArea.classList.remove('hidden');
            if (chatHeader) chatHeader.classList.remove('hidden');
            
            // Alternar entre sidebar e área principal no mobile
            const sidebar = document.getElementById('chatSidebar');
            const mainArea = document.getElementById('chatMainArea');
            
            if (window.innerWidth < 1024) {
                // Mobile: ocultar sidebar e mostrar área principal
                if (sidebar) {
                    sidebar.classList.add('hidden');
                    sidebar.classList.remove('flex');
                }
                if (mainArea) {
                    mainArea.classList.remove('hidden');
                    mainArea.classList.add('flex');
                }
            }
            
            // Carregar mensagens com este funcionário
            if (employee.id) {
                loadChatMessages(employee.id);
            } else {
                console.error('❌ Employee ID is missing');
            }
        }

        // Sair do chat e voltar para UI inicial
        function exitChat() {
            // Limpar funcionário selecionado
            window.selectedEmployee = null;
            
            // Ocultar interface do chat e mostrar UI inicial
            const initialUI = document.getElementById('initialChatUI');
            const chatMessages = document.getElementById('chatMessages');
            const chatInputArea = document.getElementById('chatInputArea');
            const chatHeader = document.getElementById('chatHeader');
            
            if (initialUI) initialUI.classList.remove('hidden');
            if (chatMessages) chatMessages.classList.add('hidden');
            if (chatInputArea) chatInputArea.classList.add('hidden');
            if (chatHeader) chatHeader.classList.add('hidden');
            
            // Voltar para sidebar no mobile
            const sidebar = document.getElementById('chatSidebar');
            const mainArea = document.getElementById('chatMainArea');
            
            if (window.innerWidth < 1024) {
                // Mobile: mostrar sidebar e ocultar área principal
                if (sidebar) {
                    sidebar.classList.remove('hidden');
                    sidebar.classList.add('flex');
                }
                if (mainArea) {
                    mainArea.classList.add('hidden');
                    mainArea.classList.remove('flex');
                }
            }
            
            // Limpar mensagens do chat
            if (chatMessages) {
                chatMessages.innerHTML = '';
            }
            
            // Limpar input de mensagem
            const messageInput = document.getElementById('chatMessageInput');
            if (messageInput) {
                messageInput.value = '';
                messageInput.disabled = true;
            }
            
            // Desabilitar botão de envio
            const sendBtn = document.getElementById('sendMessageBtn');
            if (sendBtn) {
                sendBtn.disabled = true;
            }
            
            // Ocultar picker de emojis se estiver aberto
            const emojiPicker = document.getElementById('emojiPicker');
            if (emojiPicker) {
                emojiPicker.classList.add('hidden');
            }
            
            // Resetar avatar e nome no header (se ainda estiver visível)
            const nameElement = document.getElementById('selectedEmployeeName');
            const initialElement = document.getElementById('selectedEmployeeInitial');
            const statusElement = document.getElementById('selectedEmployeeStatus');
            
            if (nameElement) nameElement.textContent = 'Selecione um funcionário';
            if (statusElement) statusElement.textContent = 'Para começar uma conversa';
            if (initialElement) {
                const avatarContainer = initialElement.parentElement;
                if (avatarContainer) {
                    avatarContainer.className = 'w-10 h-10 bg-gradient-to-br from-green-500 to-green-600 rounded-full flex items-center justify-center';
                    avatarContainer.innerHTML = '<span class="text-white font-semibold text-sm">?</span>';
                }
            }
        }

        // Limpar chat (apenas para gerente)
        function clearChat() {
            console.log('=== INICIANDO LIMPEZA DO CHAT ===');
            
            if (!window.selectedEmployee) {
                showNotification('Nenhum usuário selecionado para limpar chat', 'warning');
                return;
            }

            console.log('Usuário selecionado:', window.selectedEmployee);
            
            // Mostrar modal de confirmação diretamente
            showClearChatConfirmation();
        }

        // Função para mostrar modal de confirmação de limpeza do chat
        function showClearChatConfirmation() {
            console.log('Mostrando modal de confirmação de limpeza');
            
            // Remover modal existente se houver
            const existingModal = document.getElementById('clearChatModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            const modalHtml = `
                <div id="clearChatModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[99999]">
                    <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
                        <div class="p-6">
                            <div class="flex items-center justify-center w-12 h-12 mx-auto mb-4 bg-red-100 rounded-full">
                                <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.732-.833-2.5 0L4.268 19.5c-.77.833.192 2.5 1.732 2.5z"></path>
                                </svg>
                            </div>
                            <h3 class="text-lg font-medium text-gray-900 text-center mb-2">
                                Limpar Conversa
                            </h3>
                            <p class="text-sm text-gray-500 text-center mb-6">
                                Tem certeza que deseja limpar todo o histórico de mensagens desta conversa? Esta ação não pode ser desfeita.
                            </p>
                            <div class="flex space-x-3">
                                <button onclick="closeClearChatModal()" class="flex-1 px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-md transition-colors">
                                    Cancelar
                                </button>
                                <button onclick="confirmClearChat()" class="flex-1 px-4 py-2 text-sm font-medium text-white bg-red-600 hover:bg-red-700 rounded-md transition-colors">
                                    Limpar Chat
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            console.log('Modal de confirmação adicionado ao DOM');
        }

        // Função para fechar o modal de confirmação
        function closeClearChatModal() {
            const modal = document.getElementById('clearChatModal');
            if (modal) {
                modal.remove();
            }
        }

        // Função para confirmar a limpeza do chat
        async function confirmClearChat() {
            console.log('=== CONFIRMANDO LIMPEZA DO CHAT ===');
            closeClearChatModal();

            // Mostrar loading
            showNotification('Limpando conversa...', 'info');

            try {
                // // const supabase = await getSupabaseClient(); // REMOVIDO // REMOVIDO - usando MySQL
                const { data: { user } } = await supabase.auth.getUser();
                
                if (!user) {
                    console.error('Usuário não autenticado');
                    showNotification('Usuário não autenticado', 'error');
                    return;
                }

                console.log('Usuário autenticado:', user.id);

                const { data: userData } = await supabase
                    .from('users')
                    .select('farm_id')
                    .eq('id', user.id)
                    .single();

                if (!userData?.farm_id) {
                    console.error('Farm ID não encontrado');
                    showNotification('Erro ao obter dados da fazenda', 'error');
                    return;
                }

                console.log('Farm ID:', userData.farm_id);
                console.log('Funcionário selecionado:', window.selectedEmployee.id);

                // Deletar todas as mensagens entre os usuários
                console.log('Deletando mensagens do banco...');
                
                // Usar uma única query com OR para deletar todas as mensagens entre os dois usuários
                const { error: deleteError } = await supabase
                    .from('chat_messages')
                    .delete()
                    .eq('farm_id', userData.farm_id)
                    .or(`and(sender_id.eq.${user.id},receiver_id.eq.${window.selectedEmployee.id}),and(sender_id.eq.${window.selectedEmployee.id},receiver_id.eq.${user.id})`);

                if (deleteError) {
                    console.error('Erro ao deletar mensagens:', deleteError);
                    showNotification('Erro ao limpar o chat. Tente novamente.', 'error');
                    return;
                } else {
                    console.log('Todas as mensagens entre os usuários deletadas');
                
                // Verificar se as mensagens foram realmente deletadas
                const { data: remainingMessages, error: checkError } = await supabase
                    .from('chat_messages')
                    .select('id')
                    .eq('farm_id', userData.farm_id)
                    .or(`and(sender_id.eq.${user.id},receiver_id.eq.${window.selectedEmployee.id}),and(sender_id.eq.${window.selectedEmployee.id},receiver_id.eq.${user.id})`);

                if (checkError) {
                    console.error('Erro ao verificar mensagens restantes:', checkError);
                } else {
                    console.log('Mensagens restantes após delete:', remainingMessages?.length || 0);
                    if (remainingMessages && remainingMessages.length > 0) {
                        console.warn('Ainda existem mensagens no banco!');
                        showNotification('Algumas mensagens não foram deletadas. Tente novamente.', 'warning');
                    }
                }
                }

                // Limpar interface
                const chatMessages = document.getElementById('chatMessages');
                if (chatMessages) {
                    chatMessages.innerHTML = '';
                    console.log('Interface do chat limpa');
                }

                // Limpar cache
                if (window.chatMessagesCache) {
                    window.chatMessagesCache.clear();
                    console.log('Cache de mensagens limpo');
                }

                // Limpar cache de mensagens em tempo real
                if (window.chatMessages) {
                    window.chatMessages = [];
                    console.log('Array de mensagens limpo');
                }

                // Limpar timestamp da última mensagem
                lastMessageTimestamp = null;
                lastMessageCount = 0;

                // Forçar recarga das mensagens para garantir que não há mensagens restantes
                if (window.selectedEmployee && window.selectedEmployee.id) {
                    setTimeout(async () => {
                        console.log('Forçando recarga das mensagens...');
                        await loadChatMessages(window.selectedEmployee.id, false);
                    }, 500);
                }

                console.log('Chat limpo com sucesso');
                showNotification('Conversa limpa com sucesso!', 'success');

            } catch (error) {
                console.error('Erro ao limpar chat:', error);
                showNotification('Erro ao limpar o chat. Tente novamente.', 'error');
            }
        }

        // Toggle sidebar em mobile
        function toggleChatSidebar() {
            const sidebar = document.getElementById('chatSidebar');
            const mainArea = document.getElementById('chatMainArea');
            
            if (window.innerWidth < 1024) {
                // Mobile: alternar entre sidebar e área principal
                if (sidebar && mainArea) {
                    const isSidebarVisible = !sidebar.classList.contains('hidden');
                    
                    if (isSidebarVisible) {
                        // Ocultar sidebar e mostrar área principal
                        sidebar.classList.add('hidden');
                        sidebar.classList.remove('flex');
                        mainArea.classList.remove('hidden');
                        mainArea.classList.add('flex');
                    } else {
                        // Mostrar sidebar e ocultar área principal
                        sidebar.classList.remove('hidden');
                        sidebar.classList.add('flex');
                        mainArea.classList.add('hidden');
                        mainArea.classList.remove('flex');
                    }
                }
            }
        }

        // Função para reproduzir áudio
        function playAudio(audioUrl) {
            console.log('Reproduzindo áudio:', audioUrl);
            const audio = new Audio(audioUrl);
            audio.play().catch(error => {
                console.error('Erro ao reproduzir áudio:', error);
                showNotification('Erro ao reproduzir áudio', 'error');
            });
        }

        // Função para formatar tamanho de arquivo
        function formatFileSize(bytes) {
            if (!bytes) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        // Carregar mensagens do chat com funcionário específico
        // Cache para mensagens do chat
        let chatMessagesCache = new Map();
        let lastMessageTimestamp = null;

        async function loadChatMessages(employeeId = null, isPolling = false) {
            try {
                // // const supabase = await getSupabaseClient(); // REMOVIDO // REMOVIDO - usando MySQL
                const { data: { user } } = await supabase.auth.getUser();
                
                if (!user) return;

                // Definir currentUser globalmente
                window.currentUser = user;

                // Buscar farm_id do usuário
                const { data: userData } = await supabase
                    .from('users')
                    .select('farm_id')
                    .eq('id', user.id)
                    .single();

                if (!userData?.farm_id) return;

                // Verificar cache apenas para polling (evitar recarregamento desnecessário)
                if (isPolling) {
                    const cacheKey = `${userData.farm_id}_${user.id}_${employeeId}`;
                    const cachedData = chatMessagesCache.get(cacheKey);
                    
                    if (cachedData && (Date.now() - cachedData.timestamp < 2000)) { // Cache reduzido para 2 segundos
                        console.log('📨 Usando cache para polling, evitando recarregamento');
                        return;
                    }
                }

                // Usar o serviço de sincronização para buscar mensagens
                console.log('📨 Buscando mensagens para:', { farmId: userData.farm_id, userId: user.id, employeeId, isPolling });
                const messages = await getChatMessages(userData.farm_id, user.id, employeeId);
                console.log('📨 Mensagens encontradas:', messages?.length || 0);
                
                // Atualizar cache
                if (messages && messages.length > 0) {
                    const cacheKey = `${userData.farm_id}_${user.id}_${employeeId}`;
                    chatMessagesCache.set(cacheKey, {
                        messages: messages,
                        timestamp: Date.now()
                    });
                    
                    // Verificar se há mensagens novas
                    const latestMessage = messages[messages.length - 1];
                    if (lastMessageTimestamp && latestMessage.created_at > lastMessageTimestamp) {
                        console.log('📨 Nova mensagem detectada, atualizando display');
                displayChatMessages(messages);
                        lastMessageTimestamp = latestMessage.created_at;
                    } else if (!lastMessageTimestamp) {
                        // Primeira carga
                        displayChatMessages(messages);
                        lastMessageTimestamp = latestMessage.created_at;
                    } else {
                        console.log('📨 Nenhuma mensagem nova, mantendo display atual');
                    }
                } else {
                    displayChatMessages(messages);
                }
            } catch (error) {
                console.error('Erro ao carregar chat:', error);
            }
        }

        // Função para gerar cor baseada no nome do usuário
        function generateUserColor(name) {
            if (!name) return 'from-gray-500 to-gray-600';
            
            // Array de cores disponíveis
            const colors = [
                'from-green-500 to-green-600',
                'from-blue-500 to-blue-600', 
                'from-purple-500 to-purple-600',
                'from-pink-500 to-pink-600',
                'from-red-500 to-red-600',
                'from-yellow-500 to-yellow-600',
                'from-indigo-500 to-indigo-600',
                'from-teal-500 to-teal-600',
                'from-orange-500 to-orange-600',
                'from-cyan-500 to-cyan-600'
            ];
            
            // Gerar índice baseado no nome
            let hash = 0;
            for (let i = 0; i < name.length; i++) {
                hash = name.charCodeAt(i) + ((hash << 5) - hash);
            }
            
            return colors[Math.abs(hash) % colors.length];
        }

        // Cache para elementos de mensagem
        let lastMessageCount = 0;
        let isUserAtBottom = true;
        let newMessageIndicator = null;

        // Função para verificar se usuário está no final do chat
        function checkIfUserAtBottom() {
            const chatContainer = document.getElementById('chatMessages');
            if (!chatContainer) return true;
            
            const threshold = 100; // pixels do final
            const isAtBottom = chatContainer.scrollTop + chatContainer.clientHeight >= chatContainer.scrollHeight - threshold;
            isUserAtBottom = isAtBottom;
            return isAtBottom;
        }

        // Função para scroll suave para o final
        function scrollToBottom(smooth = true) {
            const chatContainer = document.getElementById('chatMessages');
            if (!chatContainer) {
                console.log('❌ Container de chat não encontrado para scroll');
                return;
            }
            
            console.log('📜 Fazendo scroll para o final:', {
                scrollHeight: chatContainer.scrollHeight,
                clientHeight: chatContainer.clientHeight,
                scrollTop: chatContainer.scrollTop
            });
            
            // Forçar scroll imediato primeiro
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            // Depois aplicar scroll suave se solicitado
            if (smooth) {
                setTimeout(() => {
                    chatContainer.scrollTo({
                        top: chatContainer.scrollHeight,
                        behavior: 'smooth'
                    });
                }, 50);
            }
            
            // Atualizar status de posição
            setTimeout(() => {
                isUserAtBottom = true;
                hideNewMessageIndicator();
            }, 100);
        }

        // Função para mostrar indicador de nova mensagem
        function showNewMessageIndicator() {
            if (newMessageIndicator) return; // Já existe
            
            const chatContainer = document.getElementById('chatMessages');
            if (!chatContainer) return;
            
            newMessageIndicator = document.createElement('div');
            newMessageIndicator.className = 'fixed bottom-20 right-4 bg-green-500 text-white px-4 py-2 rounded-full shadow-lg cursor-pointer z-50 flex items-center space-x-2 animate-bounce';
            newMessageIndicator.innerHTML = `
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M19 14l-7 7m0 0l-7-7m7 7V3"></path>
                </svg>
                <span class="text-sm font-medium">Nova mensagem</span>
            `;
            
            newMessageIndicator.onclick = () => {
                scrollToBottom();
                hideNewMessageIndicator();
            };
            
            document.body.appendChild(newMessageIndicator);
            
            // Auto-hide após 5 segundos
            setTimeout(() => {
                hideNewMessageIndicator();
            }, 5000);
        }

        // Função para esconder indicador de nova mensagem
        function hideNewMessageIndicator() {
            if (newMessageIndicator) {
                newMessageIndicator.remove();
                newMessageIndicator = null;
            }
        }

        // Função para mostrar indicador de digitando
        function showTypingIndicator(senderName) {
            const chatContainer = document.getElementById('chatMessages');
            if (!chatContainer) return;
            
            // Remover indicador anterior se existir
            hideTypingIndicator();
            
            const typingDiv = document.createElement('div');
            typingDiv.id = 'typingIndicator';
            typingDiv.className = 'flex justify-start mb-4';
            
            const userColor = generateUserColor(senderName);
            const senderInitial = senderName.charAt(0).toUpperCase();
            
            typingDiv.innerHTML = `
                <div class="max-w-xs lg:max-w-md">
                    <div class="flex items-end space-x-2">
                        <div class="w-8 h-8 bg-gradient-to-br ${userColor} rounded-full flex items-center justify-center flex-shrink-0">
                            <span class="text-white font-semibold text-xs">${senderInitial}</span>
                        </div>
                        <div class="flex flex-col items-start">
                            <div class="px-4 py-2 rounded-2xl bg-white text-gray-900 shadow-sm">
                                <div class="flex items-center space-x-1">
                                    <div class="typing-dot"></div>
                                    <div class="typing-dot"></div>
                                    <div class="typing-dot"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            chatContainer.appendChild(typingDiv);
            
            // Scroll para o final quando mostrar indicador
            setTimeout(() => {
                scrollToBottom(true);
            }, 100);
        }

        // Função para esconder indicador de digitando
        function hideTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        // Cache para status de leitura das mensagens
        let messageReadStatus = new Map();

        // Função para determinar status de leitura da mensagem
        function getReadStatus(message) {
            const messageId = message.id || `${message.created_at}_${message.sender_id}`;
            
            // Verificar se já temos status armazenado
            if (messageReadStatus.has(messageId)) {
                return messageReadStatus.get(messageId);
            }
            
            // Verificar se o destinatário está online
            const isRecipientOnline = window.selectedEmployee && isEmployeeOnline(window.selectedEmployee);
            
            // Simular status baseado no tempo da mensagem e se destinatário está online
            const messageTime = new Date(message.created_at);
            const now = new Date();
            const timeDiff = (now - messageTime) / 1000; // diferença em segundos
            
            let statusHtml;
            
            if (timeDiff < 1) {
                // Mensagem muito recente - apenas enviada (um verificado cinza)
                statusHtml = '<svg class="w-4 h-3 text-gray-400" fill="currentColor" viewBox="0 0 16 12"><path d="M6.5 9.5L3 6l1.4-1.4L6.5 6.7l5.1-5.1L13 2.8l-6.5 6.7z"></path></svg>';
            } else if (isRecipientOnline && timeDiff > 2) {
                // Destinatário online e tempo suficiente - mensagem lida (dois verificados azuis)
                statusHtml = `
                    <div class="relative w-5 h-3">
                        <svg class="absolute w-4 h-3 text-blue-500" fill="currentColor" viewBox="0 0 16 12">
                            <path d="M6.5 9.5L3 6l1.4-1.4L6.5 6.7l5.1-5.1L13 2.8l-6.5 6.7z"></path>
                        </svg>
                        <svg class="absolute w-4 h-3 text-blue-500" fill="currentColor" viewBox="0 0 16 12" style="left: 4px;">
                            <path d="M6.5 9.5L3 6l1.4-1.4L6.5 6.7l5.1-5.1L13 2.8l-6.5 6.7z"></path>
                        </svg>
                    </div>
                `;
            } else if (isRecipientOnline) {
                // Destinatário online - mensagem entregue (dois verificados cinza)
                statusHtml = `
                    <div class="relative w-5 h-3">
                        <svg class="absolute w-4 h-3 text-gray-400" fill="currentColor" viewBox="0 0 16 12">
                            <path d="M6.5 9.5L3 6l1.4-1.4L6.5 6.7l5.1-5.1L13 2.8l-6.5 6.7z"></path>
                        </svg>
                        <svg class="absolute w-4 h-3 text-gray-400" fill="currentColor" viewBox="0 0 16 12" style="left: 4px;">
                            <path d="M6.5 9.5L3 6l1.4-1.4L6.5 6.7l5.1-5.1L13 2.8l-6.5 6.7z"></path>
                        </svg>
                    </div>
                `;
            } else {
                // Destinatário offline - apenas enviada (um verificado cinza)
                statusHtml = '<svg class="w-4 h-3 text-gray-400" fill="currentColor" viewBox="0 0 16 12"><path d="M6.5 9.5L3 6l1.4-1.4L6.5 6.7l5.1-5.1L13 2.8l-6.5 6.7z"></path></svg>';
            }
            
            // Armazenar status para evitar recálculo
            messageReadStatus.set(messageId, statusHtml);
            
            // Simular progressão do status ao longo do tempo
            if (timeDiff < 2 && isRecipientOnline) {
                setTimeout(() => {
                    updateMessageReadStatus(messageId, 'delivered');
                }, 2000 - (timeDiff * 1000));
            }
            
            if (timeDiff < 5 && isRecipientOnline) {
                setTimeout(() => {
                    updateMessageReadStatus(messageId, 'read');
                }, 5000 - (timeDiff * 1000));
            }
            
            return statusHtml;
        }

        // Função para atualizar status de leitura de uma mensagem específica
        function updateMessageReadStatus(messageId, status) {
            let statusHtml;
            
            if (status === 'delivered') {
                // Dois verificados cinza
                statusHtml = `
                    <div class="relative w-5 h-3">
                        <svg class="absolute w-4 h-3 text-gray-400" fill="currentColor" viewBox="0 0 16 12">
                            <path d="M6.5 9.5L3 6l1.4-1.4L6.5 6.7l5.1-5.1L13 2.8l-6.5 6.7z"></path>
                        </svg>
                        <svg class="absolute w-4 h-3 text-gray-400" fill="currentColor" viewBox="0 0 16 12" style="left: 4px;">
                            <path d="M6.5 9.5L3 6l1.4-1.4L6.5 6.7l5.1-5.1L13 2.8l-6.5 6.7z"></path>
                        </svg>
                    </div>
                `;
            } else if (status === 'read') {
                // Dois verificados azuis
                statusHtml = `
                    <div class="relative w-5 h-3">
                        <svg class="absolute w-4 h-3 text-blue-500" fill="currentColor" viewBox="0 0 16 12">
                            <path d="M6.5 9.5L3 6l1.4-1.4L6.5 6.7l5.1-5.1L13 2.8l-6.5 6.7z"></path>
                        </svg>
                        <svg class="absolute w-4 h-3 text-blue-500" fill="currentColor" viewBox="0 0 16 12" style="left: 4px;">
                            <path d="M6.5 9.5L3 6l1.4-1.4L6.5 6.7l5.1-5.1L13 2.8l-6.5 6.7z"></path>
                        </svg>
                    </div>
                `;
            }
            
            if (statusHtml) {
                messageReadStatus.set(messageId, statusHtml);
                // Atualizar visualmente no chat
                updateReadStatusInChat(messageId, statusHtml);
            }
        }

        // Função para atualizar status de leitura visualmente no chat
        function updateReadStatusInChat(messageId, statusHtml) {
            const chatContainer = document.getElementById('chatMessages');
            if (!chatContainer) return;
            
            // Encontrar a mensagem específica e atualizar seu status
            const messages = chatContainer.querySelectorAll('[data-message-id]');
            messages.forEach(messageElement => {
                if (messageElement.getAttribute('data-message-id') === messageId) {
                    const readStatusElement = messageElement.querySelector('.read-status');
                    if (readStatusElement) {
                        readStatusElement.innerHTML = statusHtml;
                    }
                }
            });
        }

        // Exibir mensagens no chat
        function displayChatMessages(messages) {
            console.log('🎨 Exibindo mensagens no gerente:', messages?.length || 0);
            const chatContainer = document.getElementById('chatMessages');
            if (!chatContainer) {
                console.error('❌ Container de mensagens não encontrado no gerente');
                return;
            }

            // Esconder indicador de digitando quando exibir mensagens
            hideTypingIndicator();

            // Verificar se usuário está no final antes de atualizar
            const wasAtBottom = checkIfUserAtBottom();
            const hadMessages = lastMessageCount > 0;
            const hasNewMessages = messages.length > lastMessageCount;

            // Verificar se precisa atualizar (evitar recarregamento desnecessário)
            if (messages.length === lastMessageCount && messages.length > 0 && !hasNewMessages) {
                console.log('📨 Mesmo número de mensagens, evitando recarregamento');
                return;
            }

            chatContainer.innerHTML = '';
            lastMessageCount = messages.length;

            if (messages.length === 0) {
                chatContainer.innerHTML = `
                    <div class="text-center py-12">
                        <svg class="w-16 h-16 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                        </svg>
                        <h3 class="text-lg font-medium text-gray-900 mb-2">Nenhuma mensagem ainda</h3>
                        <p class="text-gray-500">Seja o primeiro a enviar uma mensagem!</p>
                    </div>
                `;
                return;
            }

            messages.forEach(message => {
                // Verificar se é uma mensagem de chamada
                if (message.call_data) {
                    console.log('=== MENSAGEM DE CHAMADA DETECTADA ===');
                    console.log('Message:', message);
                    console.log('Call data:', message.call_data);
                    
                    // Verificar se a mensagem é muito antiga (mais de 5 minutos)
                    const messageTime = new Date(message.created_at);
                    const now = new Date();
                    const timeDiff = now - messageTime;
                    const fiveMinutes = 5 * 60 * 1000;
                    
                    if (timeDiff > fiveMinutes) {
                        console.log('Mensagem de chamada muito antiga, ignorando');
                        return;
                    }
                    
                    handleCallMessage(message);
                    return; // Não exibir mensagem de chamada no chat
                }
                
                // Não exibir mensagens vazias (exceto se tiver file_data)
                if ((!message.message || message.message.trim() === '') && !message.file_data) {
                    return;
                }
                
                const isCurrentUser = message.sender_id === (window.currentUser?.id || '');
                const messageDiv = document.createElement('div');
                messageDiv.className = `flex ${isCurrentUser ? 'justify-end' : 'justify-start'} mb-4`;
                
                // Usar sender_name se disponível, senão usar 'Usuário'
                const senderName = message.sender_name || 'Usuário';
                
                // Usar sender_name se disponível, senão usar '?'
                const senderInitial = senderName.charAt(0).toUpperCase();
                const messageTime = new Date(message.created_at).toLocaleTimeString('pt-BR', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                // Verificar se tem foto de perfil
                const hasPhoto = message.sender_photo && message.sender_photo.trim() !== '';
                const userColor = generateUserColor(senderName);
                
                // Gerar avatar (foto ou letra) - sem timestamp para evitar recarregamento
                let avatarHtml;
                if (hasPhoto) {
                    avatarHtml = `
                        <img src="${message.sender_photo}" 
                             alt="Foto de ${senderName}" 
                             class="w-8 h-8 rounded-full object-cover flex-shrink-0"
                             onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
                             onload="this.nextElementSibling.style.display='none';">
                        <div class="w-8 h-8 bg-gradient-to-br ${userColor} rounded-full flex items-center justify-center flex-shrink-0" style="display: flex;">
                            <span class="text-white font-semibold text-xs">${senderInitial}</span>
                        </div>
                    `;
                } else {
                    avatarHtml = `
                        <div class="w-8 h-8 bg-gradient-to-br ${userColor} rounded-full flex items-center justify-center flex-shrink-0">
                            <span class="text-white font-semibold text-xs">${senderInitial}</span>
                        </div>
                    `;
                }
                
                // Gerar ícones de verificação para mensagens do usuário atual
                let readReceiptHtml = '';
                if (isCurrentUser) {
                    const readStatus = getReadStatus(message);
                    readReceiptHtml = `
                        <div class="flex items-center space-x-1 mt-1">
                            ${readStatus}
                        </div>
                    `;
                }

                const messageId = message.id || `${message.created_at}_${message.sender_id}`;
                
                messageDiv.setAttribute('data-message-id', messageId);
                messageDiv.innerHTML = `
                    <div class="max-w-xs lg:max-w-md">
                        <div class="flex items-end space-x-2 ${isCurrentUser ? 'flex-row-reverse space-x-reverse' : ''}">
                            <div class="relative">
                                ${avatarHtml}
                            </div>
                            <div class="flex flex-col ${isCurrentUser ? 'items-end' : 'items-start'}">
                                <div class="px-4 py-2 rounded-2xl ${isCurrentUser ? 'bg-green-500 text-white' : 'bg-white text-gray-900'} shadow-sm">
                                    ${message.file_data && message.file_data.type === 'audio' ? 
                                        `<div class="flex items-center space-x-3">
                                            <button onclick="playAudio('${message.file_data.url}')" class="flex items-center justify-center w-10 h-10 rounded-full ${isCurrentUser ? 'bg-white bg-opacity-20' : 'bg-green-500'} hover:bg-opacity-30 transition-colors">
                                                <svg class="w-5 h-5 ${isCurrentUser ? 'text-white' : 'text-white'}" fill="currentColor" viewBox="0 0 24 24">
                                                    <path d="M8 5v14l11-7z"/>
                                                </svg>
                                            </button>
                                            <div class="flex flex-col">
                                                <span class="text-sm font-medium">${message.file_data.name || 'Mensagem de voz'}</span>
                                                <span class="text-xs opacity-75">${formatFileSize(message.file_data.size)}</span>
                                            </div>
                                        </div>` :
                                        `<p class="text-sm">${message.message}</p>`
                                    }
                                </div>
                                <div class="flex items-center space-x-1 mt-1">
                                    <span class="text-xs text-gray-500">${messageTime}</span>
                                    <div class="read-status">${readReceiptHtml}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                chatContainer.appendChild(messageDiv);
            });

            // Lógica de scroll inteligente
            setTimeout(() => {
                console.log('📨 Verificando scroll:', { 
                    wasAtBottom, 
                    hadMessages, 
                    hasNewMessages,
                    messageCount: messages.length,
                    lastCount: lastMessageCount
                });
                
                if (wasAtBottom || !hadMessages || hasNewMessages) {
                    // Usuário estava no final, é primeira carga, ou há mensagens novas - scroll automático
                    console.log('📨 Fazendo scroll automático');
                    scrollToBottom(true);
                } else if (hasNewMessages && !wasAtBottom) {
                    // Há mensagens novas e usuário não está no final - mostrar indicador
                    console.log('📨 Mostrando indicador de nova mensagem');
                    showNewMessageIndicator();
                }
            }, 200); // Aumentado para 200ms para garantir que o DOM foi atualizado
        }

        // Enviar mensagem
        async function sendChatMessageLocal() {
            const messageInput = document.getElementById('chatMessageInput');
            const message = messageInput.value.trim();
            
            if (!message || !window.selectedEmployee) return;

            // Mostrar indicador de digitando
            showTypingIndicator(window.currentUser?.name || 'Você');

            try {
                // // const supabase = await getSupabaseClient(); // REMOVIDO // REMOVIDO - usando MySQL
                const { data: { user } } = await supabase.auth.getUser();
                
                if (!user) return;

                // Buscar farm_id do usuário
                const { data: userData } = await supabase
                    .from('users')
                    .select('farm_id')
                    .eq('id', user.id)
                    .single();

                if (!userData?.farm_id) return;

                // Usar o serviço de sincronização para enviar mensagem
                await sendChatMessage({
                    farm_id: userData.farm_id,
                    sender_id: user.id,
                    receiver_id: window.selectedEmployee.id,
                    message: message
                });

                // Limpar input IMEDIATAMENTE após enviar
                messageInput.value = '';
                
                // As mensagens serão atualizadas automaticamente via real-time
                console.log('✅ Mensagem enviada, aguardando atualização via real-time...');
                
                // Fazer scroll para o final após enviar mensagem
                setTimeout(() => {
                    scrollToBottom(true);
                }, 100);
                        
                        // Manter foco no input
                            messageInput.focus();
                
            } catch (error) {
                console.error('Erro ao enviar mensagem:', error);
                showNotification('Erro ao enviar mensagem', 'error');
                // Esconder indicador de digitando em caso de erro
                hideTypingIndicator();
            }
        }

        // Enviar mensagem com Enter
        function handleChatKeyPress(event) {
            if (event.key === 'Enter') {
                sendChatMessageLocal();
            }
        }

        // ==================== FUNÇÕES DE EMOJI E CLIPES ====================
        
        // Toggle do picker de emojis
        function toggleEmojiPicker() {
            const emojiPicker = document.getElementById('emojiPicker');
            if (emojiPicker) {
                emojiPicker.classList.toggle('hidden');
            }
        }

        // Inserir emoji no input
        function insertEmoji(emoji) {
            const messageInput = document.getElementById('chatMessageInput');
            if (messageInput) {
                const currentValue = messageInput.value;
                const cursorPos = messageInput.selectionStart;
                const newValue = currentValue.slice(0, cursorPos) + emoji + currentValue.slice(cursorPos);
                messageInput.value = newValue;
                
                // Reposicionar cursor após o emoji
                messageInput.setSelectionRange(cursorPos + emoji.length, cursorPos + emoji.length);
                messageInput.focus();
                
                // Esconder picker de emojis
                toggleEmojiPicker();
            }
        }

        // Toggle do input de arquivo
        function toggleFileInput() {
            const fileInput = document.getElementById('fileInput');
            if (fileInput) {
                fileInput.click();
            }
        }

        // Lidar com seleção de arquivo
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Verificar tamanho do arquivo (máximo 10MB)
            const maxSize = 10 * 1024 * 1024; // 10MB
            if (file.size > maxSize) {
                showNotification('Arquivo muito grande. Máximo permitido: 10MB', 'error');
                return;
            }

            // Verificar tipo de arquivo
            const allowedTypes = [
                'image/jpeg', 'image/png', 'image/gif', 'image/webp',
                'video/mp4', 'video/webm', 'video/ogg',
                'audio/mp3', 'audio/wav', 'audio/ogg',
                'application/pdf',
                'application/msword',
                'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
                'text/plain'
            ];

            if (!allowedTypes.includes(file.type)) {
                showNotification('Tipo de arquivo não suportado', 'error');
                return;
            }

            // Enviar arquivo
            sendFileMessage(file);
        }

        // Enviar mensagem com arquivo
        async function sendFileMessage(file) {
            if (!window.selectedEmployee) {
                showNotification('Selecione um funcionário primeiro', 'error');
                return;
            }

            try {
                // // const supabase = await getSupabaseClient(); // REMOVIDO // REMOVIDO - usando MySQL
                const { data: { user } } = await supabase.auth.getUser();
                
                if (!user) return;

                // Buscar farm_id do usuário
                const { data: userData } = await supabase
                    .from('users')
                    .select('farm_id')
                    .eq('id', user.id)
                    .single();

                if (!userData?.farm_id) return;

                // Mostrar loading
                showNotification('Enviando arquivo...', 'info');

                // Upload do arquivo para Supabase Storage
                const fileExt = file.name.split('.').pop();
                const fileName = `${Date.now()}_${Math.random().toString(36).substring(2)}.${fileExt}`;
                const filePath = `chat-files/${userData.farm_id}/${fileName}`;

                const { data: uploadData, error: uploadError } = await supabase.storage
                    .from('chat-files')
                    .upload(filePath, file);

                if (uploadError) {
                    console.error('Erro no upload:', uploadError);
                    showNotification('Erro ao enviar arquivo', 'error');
                    return;
                }

                // Obter URL pública do arquivo
                const { data: { publicUrl } } = supabase.storage
                    .from('chat-files')
                    .getPublicUrl(filePath);

                // Criar mensagem com arquivo
                const fileMessage = {
                    type: getFileType(file.type),
                    name: file.name,
                    size: file.size,
                    url: publicUrl
                };

                // Enviar mensagem
                await sendChatMessage({
                    farm_id: userData.farm_id,
                    sender_id: user.id,
                    receiver_id: window.selectedEmployee.id,
                    message: `📎 ${file.name}`,
                    file_data: fileMessage
                });

                showNotification('Arquivo enviado com sucesso!', 'success');
                
                // Limpar input de arquivo
                const fileInput = document.getElementById('fileInput');
                if (fileInput) {
                    fileInput.value = '';
                }

            } catch (error) {
                console.error('Erro ao enviar arquivo:', error);
                showNotification('Erro ao enviar arquivo', 'error');
            }
        }

        // Determinar tipo de arquivo
        function getFileType(mimeType) {
            if (mimeType.startsWith('image/')) return 'image';
            if (mimeType.startsWith('video/')) return 'video';
            if (mimeType.startsWith('audio/')) return 'audio';
            if (mimeType === 'application/pdf') return 'pdf';
            if (mimeType.includes('word') || mimeType.includes('document')) return 'document';
            return 'file';
        }

        // Esconder picker de emojis ao clicar fora
        document.addEventListener('click', function(event) {
            const emojiPicker = document.getElementById('emojiPicker');
            const emojiButton = event.target.closest('[onclick="toggleEmojiPicker()"]');
            
            if (emojiPicker && !emojiPicker.contains(event.target) && !emojiButton) {
                emojiPicker.classList.add('hidden');
            }
        });

        // ==================== FUNÇÕES DE CATEGORIAS DE EMOJIS ====================
        
        // Mostrar categoria de emojis
        function showEmojiCategory(category) {
            // Esconder todas as categorias
            const categories = document.querySelectorAll('.emoji-category');
            categories.forEach(cat => cat.classList.add('hidden'));
            
            // Mostrar categoria selecionada
            const selectedCategory = document.getElementById('emoji' + category.charAt(0).toUpperCase() + category.slice(1));
            if (selectedCategory) {
                selectedCategory.classList.remove('hidden');
                
                // Carregar emojis se ainda não foram carregados
                if (selectedCategory.children.length === 0) {
                    loadEmojiCategory(category);
                }
            }
            
            // Atualizar botões de categoria
            const categoryBtns = document.querySelectorAll('.emoji-category-btn');
            categoryBtns.forEach(btn => {
                btn.classList.remove('bg-green-100', 'text-green-700');
                btn.classList.add('hover:bg-gray-200');
            });
            
            // Destacar botão selecionado
            const selectedBtn = event.target;
            selectedBtn.classList.add('bg-green-100', 'text-green-700');
            selectedBtn.classList.remove('hover:bg-gray-200');
        }

        // Carregar emojis por categoria
        function loadEmojiCategory(category) {
            const container = document.getElementById('emoji' + category.charAt(0).toUpperCase() + category.slice(1));
            if (!container) return;

            const emojis = {
                gestures: ['👋', '🤚', '🖐️', '✋', '🖖', '👌', '🤏', '✌️', '🤞', '🤟', '🤘', '🤙', '👈', '👉', '👆', '🖕', '👇', '☝️', '👍', '👎', '👊', '✊', '🤛', '🤜', '👏', '🙌', '👐', '🤲', '🤝', '🙏', '✍️', '💅', '🤳', '💪', '🦾', '🦿', '🦵', '🦶', '👂', '🦻', '👃', '🧠', '🦷', '🦴', '👀', '👁️', '👅', '👄', '💋', '🩸'],
                objects: ['📱', '📲', '☎️', '📞', '📟', '📠', '🔋', '🔌', '💻', '🖥️', '🖨️', '⌨️', '🖱️', '🖲️', '💽', '💾', '💿', '📀', '🧮', '🎥', '📷', '📸', '📹', '📼', '🔍', '🔎', '🕯️', '💡', '🔦', '🏮', '🪔', '📔', '📕', '📖', '📗', '📘', '📙', '📚', '📓', '📒', '📃', '📜', '📄', '📰', '🗞️', '📑', '🔖', '🏷️', '💰', '💴', '💵', '💶', '💷', '💸', '💳', '🧾', '💎', '⚖️', '🧰', '🔧', '🔨', '⚒️', '🛠️', '⛏️', '🔩', '⚙️', '🧱', '⛓️', '🧲', '🔫', '💣', '🧨', '🪓', '🔪', '🗡️', '⚔️', '🛡️', '🚬', '⚰️', '🪦', '⚱️', '🏺', '🔮', '📿', '🧿', '💈', '⚗️', '🔭', '🔬', '🕳️', '🩹', '🩺', '💊', '💉', '🧬', '🦠', '🧫', '🧪', '🌡️', '🧹', '🧺', '🧻', '🚽', '🚰', '🚿', '🛁', '🛀', '🧴', '🧷', '🧸', '🧵', '🧶', '🪡', '🪢', '🪣', '🪤', '🪥', '🪦', '🪧', '🪨', '🪩', '🪪', '🪫', '🪬', '🪭', '🪮', '🪯', '🪰', '🪱', '🪲', '🪳', '🪴', '🪵', '🪶', '🪷', '🪸', '🪹', '🪺', '🪻', '🪼', '🪽', '🪾', '🪿', '🫀', '🫁', '🫂', '🫃', '🫄', '🫅', '🫆', '🫇', '🫈', '🫉', '🫊', '🫋', '🫌', '🫍', '🫎', '🫏', '🫐', '🫑', '🫒', '🫓', '🫔', '🫕', '🫖', '🫗', '🫘', '🫙', '🫚', '🫛', '🫜', '🫝', '🫞', '🫟', '🫠', '🫡', '🫢', '🫣', '🫤', '🫥', '🫦', '🫧', '🫨', '🫩', '🫪', '🫫', '🫬', '🫭', '🫮', '🫯', '🫰', '🫱', '🫲', '🫳', '🫴', '🫵', '🫶', '🫷', '🫸', '🫹', '🫺', '🫻', '🫼', '🫽', '🫾', '🫿', '🬀', '🬁', '🬂', '🬃', '🬄', '🬅', '🬆', '🬇', '🬈', '🬉', '🬊', '🬋', '🬌', '🬍', '🬎', '🬏', '🬐', '🬑', '🬒', '🬓', '🬔', '🬕', '🬖', '🬗', '🬘', '🬙', '🬚', '🬛', '🬜', '🬝', '🬞', '🬟', '🬠', '🬡', '🬢', '🬣', '🬤', '🬥', '🬦', '🬧', '🬨', '🬩', '🬪', '🬫', '🬬', '🬭', '🬮', '🬯', '🬰', '🬱', '🬲', '🬳', '🬴', '🬵', '🬶', '🬷', '🬸', '🬹', '🬺', '🬻', '🬼', '🬽', '🬾', '🬿', '🭀', '🭁', '🭂', '🭃', '🭄', '🭅', '🭆', '🭇', '🭈', '🭉', '🭊', '🭋', '🭌', '🭍', '🭎', '🭏', '🭐', '🭑', '🭒', '🭓', '🭔', '🭕', '🭖', '🭗', '🭘', '🭙', '🭚', '🭛', '🭜', '🭝', '🭞', '🭟', '🭠', '🭡', '🭢', '🭣', '🭤', '🭥', '🭦', '🭧', '🭨', '🭩', '🭪', '🭫', '🭬', '🭭', '🭮', '🭯', '🭰', '🭱', '🭲', '🭳', '🭴', '🭵', '🭶', '🭷', '🭸', '🭹', '🭺', '🭻', '🭼', '🭽', '🭾', '🭿', '🮀', '🮁', '🮂', '🮃', '🮄', '🮅', '🮆', '🮇', '🮈', '🮉', '🮊', '🮋', '🮌', '🮍', '🮎', '🮏', '🮐', '🮑', '🮒', '🮓', '🮔', '🮕', '🮖', '🮗', '🮘', '🮙', '🮚', '🮛', '🮜', '🮝', '🮞', '🮟', '🮠', '🮡', '🮢', '🮣', '🮤', '🮥', '🮦', '🮧', '🮨', '🮩', '🮪', '🮫', '🮬', '🮭', '🮮', '🮯', '🮰', '🮱', '🮲', '🮳', '🮴', '🮵', '🮶', '🮷', '🮸', '🮹', '🮺', '🮻', '🮼', '🮽', '🮾', '🮿', '🯀', '🯁', '🯂', '🯃', '🯄', '🯅', '🯆', '🯇', '🯈', '🯉', '🯊', '🯋', '🯌', '🯍', '🯎', '🯏', '🯐', '🯑', '🯒', '🯓', '🯔', '🯕', '🯖', '🯗', '🯘', '🯙', '🯚', '🯛', '🯜', '🯝', '🯞', '🯟', '🯠', '🯡', '🯢', '🯣', '🯤', '🯥', '🯦', '🯧', '🯨', '🯩', '🯪', '🯫', '🯬', '🯭', '🯮', '🯯', '🯰', '🯱', '🯲', '🯳', '🯴', '🯵', '🯶', '🯷', '🯸', '🯹', '🯺', '🯻', '🯼', '🯽', '🯾', '🯿', '🰀', '🰁', '🰂', '🰃', '🰄', '🰅', '🰆', '🰇', '🰈', '🰉', '🰊', '🰋', '🰌', '🰍', '🰎', '🰏', '🰐', '🰑', '🰒', '🰓', '🰔', '🰕', '🰖', '🰗', '🰘', '🰙', '🰚', '🰛', '🰜', '🰝', '🰞', '🰟', '🰠', '🰡', '🰢', '🰣', '🰤', '🰥', '🰦', '🰧', '🰨', '🰩', '🰪', '🰫', '🰬', '🰭', '🰮', '🰯', '🰰', '🰱', '🰲', '🰳', '🰴', '🰵', '🰶', '🰷', '🰸', '🰹', '🰺', '🰻', '🰼', '🰽', '🰾', '🰿', '🱀', '🱁', '🱂', '🱃', '🱄', '🱅', '🱆', '🱇', '🱈', '🱉', '🱊', '🱋', '🱌', '🱍', '🱎', '🱏', '🱐', '🱑', '🱒', '🱓', '🱔', '🱕', '🱖', '🱗', '🱘', '🱙', '🱚', '🱛', '🱜', '🱝', '🱞', '🱟', '🱠', '🱡', '🱢', '🱣', '🱤', '🱥', '🱦', '🱧', '🱨', '🱩', '🱪', '🱫', '🱬', '🱭', '🱮', '🱯', '🱰', '🱱', '🱲', '🱳', '🱴', '🱵', '🱶', '🱷', '🱸', '🱹', '🱺', '🱻', '🱼', '🱽', '🱾', '🱿', '🲀', '🲁', '🲂', '🲃', '🲄', '🲅', '🲆', '🲇', '🲈', '🲉', '🲊', '🲋', '🲌', '🲍', '🲎', '🲏', '🲐', '🲑', '🲒', '🲓', '🲔', '🲕', '🲖', '🲗', '🲘', '🲙', '🲚', '🲛', '🲜', '🲝', '🲞', '🲟', '🲠', '🲡', '🲢', '🲣', '🲤', '🲥', '🲦', '🲧', '🲨', '🲩', '🲪', '🲫', '🲬', '🲭', '🲮', '🲯', '🲰', '🲱', '🲲', '🲳', '🲴', '🲵', '🲶', '🲷', '🲸', '🲹', '🲺', '🲻', '🲼', '🲽', '🲾', '🲿', '🳀', '🳁', '🳂', '🳃', '🳄', '🳅', '🳆', '🳇', '🳈', '🳉', '🳊', '🳋', '🳌', '🳍', '🳎', '🳏', '🳐', '🳑', '🳒', '🳓', '🳔', '🳕', '🳖', '🳗', '🳘', '🳙', '🳚', '🳛', '🳜', '🳝', '🳞', '🳟', '🳠', '🳡', '🳢', '🳣', '🳤', '🳥', '🳦', '🳧', '🳨', '🳩', '🳪', '🳫', '🳬', '🳭', '🳮', '🳯', '🳰', '🳱', '🳲', '🳳', '🳴', '🳵', '🳶', '🳷', '🳸', '🳹', '🳺', '🳻', '🳼', '🳽', '🳾', '🳿', '🴀', '🴁', '🴂', '🴃', '🴄', '🴅', '🴆', '🴇', '🴈', '🴉', '🴊', '🴋', '🴌', '🴍', '🴎', '🴏', '🴐', '🴑', '🴒', '🴓', '🴔', '🴕', '🴖', '🴗', '🴘', '🴙', '🴚', '🴛', '🴜', '🴝', '🴞', '🴟', '🴠', '🴡', '🴢', '🴣', '🴤', '🴥', '🴦', '🴧', '🴨', '🴩', '🴪', '🴫', '🴬', '🴭', '🴮', '🴯', '🴰', '🴱', '🴲', '🴳', '🴴', '🴵', '🴶', '🴷', '🴸', '🴹', '🴺', '🴻', '🴼', '🴽', '🴾', '🴿', '🵀', '🵁', '🵂', '🵃', '🵄', '🵅', '🵆', '🵇', '🵈', '🵉', '🵊', '🵋', '🵌', '🵍', '🵎', '🵏', '🵐', '🵑', '🵒', '🵓', '🵔', '🵕', '🵖', '🵗', '🵘', '🵙', '🵚', '🵛', '🵜', '🵝', '🵞', '🵟', '🵠', '🵡', '🵢', '🵣', '🵤', '🵥', '🵦', '🵧', '🵨', '🵩', '🵪', '🵫', '🵬', '🵭', '🵮', '🵯', '🵰', '🵱', '🵲', '🵳', '🵴', '🵵', '🵶', '🵷', '🵸', '🵹', '🵺', '🵻', '🵼', '🵽', '🵾', '🵿', '🶀', '🶁', '🶂', '🶃', '🶄', '🶅', '🶆', '🶇', '🶈', '🶉', '🶊', '🶋', '🶌', '🶍', '🶎', '🶏', '🶐', '🶑', '🶒', '🶓', '🶔', '🶕', '🶖', '🶗', '🶘', '🶙', '🶚', '🶛', '🶜', '🶝', '🶞', '🶟', '🶠', '🶡', '🶢', '🶣', '🶤', '🶥', '🶦', '🶧', '🶨', '🶩', '🶪', '🶫', '🶬', '🶭', '🶮', '🶯', '🶰', '🶱', '🶲', '🶳', '🶴', '🶵', '🶶', '🶷', '🶸', '🶹', '🶺', '🶻', '🶼', '🶽', '🶾', '🶿', '🷀', '🷁', '🷂', '🷃', '🷄', '🷅', '🷆', '🷇', '🷈', '🷉', '🷊', '🷋', '🷌', '🷍', '🷎', '🷏', '🷐', '🷑', '🷒', '🷓', '🷔', '🷕', '🷖', '🷗', '🷘', '🷙', '🷚', '🷛', '🷜', '🷝', '🷞', '🷟', '🷠', '🷡', '🷢', '🷣', '🷤', '🷥', '🷦', '🷧', '🷨', '🷩', '🷪', '🷫', '🷬', '🷭', '🷮', '🷯', '🷰', '🷱', '🷲', '🷳', '🷴', '🷵', '🷶', '🷷', '🷸', '🷹', '🷺', '🷻', '🷼', '🷽', '🷾', '🷿', '🸀', '🸁', '🸂', '🸃', '🸄', '🸅', '🸆', '🸇', '🸈', '🸉', '🸊', '🸋', '🸌', '🸍', '🸎', '🸏', '🸐', '🸑', '🸒', '🸓', '🸔', '🸕', '🸖', '🸗', '🸘', '🸙', '🸚', '🸛', '🸜', '🸝', '🸞', '🸟', '🸠', '🸡', '🸢', '🸣', '🸤', '🸥', '🸦', '🸧', '🸨', '🸩', '🸪', '🸫', '🸬', '🸭', '🸮', '🸯', '🸰', '🸱', '🸲', '🸳', '🸴', '🸵', '🸶', '🸷', '🸸', '🸹', '🸺', '🸻', '🸼', '🸽', '🸾', '🸿', '🹀', '🹁', '🹂', '🹃', '🹄', '🹅', '🹆', '🹇', '🹈', '🹉', '🹊', '🹋', '🹌', '🹍', '🹎', '🹏', '🹐', '🹑', '🹒', '🹓', '🹔', '🹕', '🹖', '🹗', '🹘', '🹙', '🹚', '🹛', '🹜', '🹝', '🹞', '🹟', '🹠', '🹡', '🹢', '🹣', '🹤', '🹥', '🹦', '🹧', '🹨', '🹩', '🹪', '🹫', '🹬', '🹭', '🹮', '🹯', '🹰', '🹱', '🹲', '🹳', '🹴', '🹵', '🹶', '🹷', '🹸', '🹹', '🹺', '🹻', '🹼', '🹽', '🹾', '🹿', '🺀', '🺁', '🺂', '🺃', '🺄', '🺅', '🺆', '🺇', '🺈', '🺉', '🺊', '🺋', '🺌', '🺍', '🺎', '🺏', '🺐', '🺑', '🺒', '🺓', '🺔', '🺕', '🺖', '🺗', '🺘', '🺙', '🺚', '🺛', '🺜', '🺝', '🺞', '🺟', '🺠', '🺡', '🺢', '🺣', '🺤', '🺥', '🺦', '🺧', '🺨', '🺩', '🺪', '🺫', '🺬', '🺭', '🺮', '🺯', '🺰', '🺱', '🺲', '🺳', '🺴', '🺵', '🺶', '🺷', '🺸', '🺹', '🺺', '🺻', '🺼', '🺽', '🺾', '🺿', '🻀', '🻁', '🻂', '🻃', '🻄', '🻅', '🻆', '🻇', '🻈', '🻉', '🻊', '🻋', '🻌', '🻍', '🻎', '🻏', '🻐', '🻑', '🻒', '🻓', '🻔', '🻕', '🻖', '🻗', '🻘', '🻙', '🻚', '🻛', '🻜', '🻝', '🻞', '🻟', '🻠', '🻡', '🻢', '🻣', '🻤', '🻥', '🻦', '🻧', '🻨', '🻩', '🻪', '🻫', '🻬', '🻭', '🻮', '🻯', '🻰', '🻱', '🻲', '🻳', '🻴', '🻵', '🻶', '🻷', '🻸', '🻹', '🻺', '🻻', '🻼', '🻽', '🻾', '🻿', '🼀', '🼁', '🼂', '🼃', '🼄', '🼅', '🼆', '🼇', '🼈', '🼉', '🼊', '🼋', '🼌', '🼍', '🼎', '🼏', '🼐', '🼑', '🼒', '🼓', '🼔', '🼕', '🼖', '🼗', '🼘', '🼙', '🼚', '🼛', '🼜', '🼝', '🼞', '🼟', '🼠', '🼡', '🼢', '🼣', '🼤', '🼥', '🼦', '🼧', '🼨', '🼩', '🼪', '🼫', '🼬', '🼭', '🼮', '🼯', '🼰', '🼱', '🼲', '🼳', '🼴', '🼵', '🼶', '🼷', '🼸', '🼹', '🼺', '🼻', '🼼', '🼽', '🼾', '🼿', '🽀', '🽁', '🽂', '🽃', '🽄', '🽅', '🽆', '🽇', '🽈', '🽉', '🽊', '🽋', '🽌', '🽍', '🽎', '🽏', '🽐', '🽑', '🽒', '🽓', '🽔', '🽕', '🽖', '🽗', '🽘', '🽙', '🽚', '🽛', '🽜', '🽝', '🽞', '🽟', '🽠', '🽡', '🽢', '🽣', '🽤', '🽥', '🽦', '🽧', '🽨', '🽩', '🽪', '🽫', '🽬', '🽭', '🽮', '🽯', '🽰', '🽱', '🽲', '🽳', '🽴', '🽵', '🽶', '🽷', '🽸', '🽹', '🽺', '🽻', '🽼', '🽽', '🽾', '🽿', '🾀', '🾁', '🾂', '🾃', '🾄', '🾅', '🾆', '🾇', '🾈', '🾉', '🾊', '🾋', '🾌', '🾍', '🾎', '🾏', '🾐', '🾑', '🾒', '🾓', '🾔', '🾕', '🾖', '🾗', '🾘', '🾙', '🾚', '🾛', '🾜', '🾝', '🾞', '🾟', '🾠', '🾡', '🾢', '🾣', '🾤', '🾥', '🾦', '🾧', '🾨', '🾩', '🾪', '🾫', '🾬', '🾭', '🾮', '🾯', '🾰', '🾱', '🾲', '🾳', '🾴', '🾵', '🾶', '🾷', '🾸', '🾹', '🾺', '🾻', '🾼', '🾽', '🾾', '🾿', '🿀', '🿁', '🿂', '🿃', '🿄', '🿅', '🿆', '🿇', '🿈', '🿉', '🿊', '🿋', '🿌', '🿍', '🿎', '🿏', '🿐', '🿑', '🿒', '🿓', '🿔', '🿕', '🿖', '🿗', '🿘', '🿙', '🿚', '🿛', '🿜', '🿝', '🿞', '🿟', '🿠', '🿡', '🿢', '🿣', '🿤', '🿥', '🿦', '🿧', '🿨', '🿩', '🿪', '🿫', '🿬', '🿭', '🿮', '🿯', '🿰', '🿱', '🿲', '🿳', '🿴', '🿵', '🿶', '🿷', '🿸', '🿹', '🿺', '🿻', '🿼', '🿽', '🿾', '🿿']
            };

            if (emojis[category]) {
                emojis[category].forEach(emoji => {
                    const button = document.createElement('button');
                    button.className = 'emoji-btn p-2 hover:bg-gray-200 rounded text-lg';
                    button.textContent = emoji;
                    button.onclick = () => insertEmoji(emoji);
                    container.appendChild(button);
                });
            }
        }

        // ==================== FUNÇÕES DE GRAVAÇÃO DE ÁUDIO ====================
        
        let mediaRecorder = null;
        let audioChunks = [];
        let isRecording = false;

        // Toggle gravação de áudio
        async function toggleAudioRecording() {
            if (!isRecording) {
                await startAudioRecording();
            } else {
                stopAudioRecording();
            }
        }

        // Iniciar gravação de áudio
        async function startAudioRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];

                mediaRecorder.ondataavailable = event => {
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    sendAudioMessage(audioBlob);
                    stream.getTracks().forEach(track => track.stop());
                };

                mediaRecorder.start();
                isRecording = true;
                
                // Atualizar botão
                const btn = document.getElementById('audioRecordBtn');
                btn.classList.add('bg-red-500', 'text-white', 'animate-pulse');
                btn.classList.remove('text-gray-400');
                btn.innerHTML = `
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12 2C13.1 2 14 2.9 14 4V12C14 13.1 13.1 14 12 14C10.9 14 10 13.1 10 12V4C10 2.9 10.9 2 12 2M19 10V12C19 15.9 15.9 19 12 19S5 15.9 5 12V10H7V12C7 14.8 9.2 17 12 17S17 14.8 17 12V10H19Z"/>
                    </svg>
                `;
                btn.title = 'Parar gravação';
                
                showNotification('🎤 Gravando áudio...', 'info');

            } catch (error) {
                console.error('Erro ao acessar microfone:', error);
                showNotification('Erro ao acessar microfone', 'error');
            }
        }

        // Parar gravação de áudio
        function stopAudioRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                isRecording = false;
                
                // Atualizar botão
                const btn = document.getElementById('audioRecordBtn');
                btn.classList.remove('bg-red-500', 'text-white', 'animate-pulse');
                btn.classList.add('text-gray-400');
                btn.innerHTML = `
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path>
                    </svg>
                `;
                btn.title = 'Gravar áudio';
                
                showNotification('🎵 Processando áudio...', 'info');
            }
        }

        // Enviar mensagem de áudio
        async function sendAudioMessage(audioBlob) {
            if (!window.selectedEmployee) {
                showNotification('Selecione um funcionário primeiro', 'error');
                return;
            }

            try {
                // // const supabase = await getSupabaseClient(); // REMOVIDO // REMOVIDO - usando MySQL
                const { data: { user } } = await supabase.auth.getUser();
                
                if (!user) return;

                // Buscar farm_id do usuário
                const { data: userData } = await supabase
                    .from('users')
                    .select('farm_id')
                    .eq('id', user.id)
                    .single();

                if (!userData?.farm_id) return;

                // Upload do áudio para Supabase Storage
                const fileName = `audio_${Date.now()}_${Math.random().toString(36).substring(2)}.wav`;
                const filePath = `chat-files/${userData.farm_id}/${fileName}`;

                const { data: uploadData, error: uploadError } = await supabase.storage
                    .from('chat-files')
                    .upload(filePath, audioBlob);

                if (uploadError) {
                    console.error('Erro no upload:', uploadError);
                    showNotification('Erro ao enviar áudio', 'error');
                    return;
                }

                // Obter URL pública do áudio
                const { data: { publicUrl } } = supabase.storage
                    .from('chat-files')
                    .getPublicUrl(filePath);

                // Criar mensagem com áudio
                const audioMessage = {
                    type: 'audio',
                    name: 'Mensagem de voz',
                    size: audioBlob.size,
                    url: publicUrl
                };

                // Enviar mensagem
                await sendChatMessage({
                    farm_id: userData.farm_id,
                    sender_id: user.id,
                    receiver_id: window.selectedEmployee.id,
                    message: '🎵 Mensagem de voz',
                    file_data: audioMessage
                });

                showNotification('Áudio enviado com sucesso!', 'success');

            } catch (error) {
                console.error('Erro ao enviar áudio:', error);
                showNotification('Erro ao enviar áudio', 'error');
            }
        }



        // ==================== FUNÇÕES DOS CONTATOS ====================
        
        // Abrir modal de contatos
        async function openContactsModal() {
            try {
                console.log('Abrindo modal de contatos...');
                
                const modal = document.getElementById('contactsModal');
                if (modal) {
                    modal.classList.remove('hidden');
                    modal.style.display = 'flex';
                    document.body.style.overflow = 'hidden';
                    
                    // Carregar contatos
                    await loadContacts();
                }
            } catch (error) {
                console.error('Erro ao abrir modal de contatos:', error);
                showNotification('Erro ao abrir contatos', 'error');
            }
        }

        // Fechar modal de contatos
        function closeContactsModal() {
            const modal = document.getElementById('contactsModal');
            if (modal) {
                modal.classList.add('hidden');
                modal.style.display = 'none';
                document.body.style.overflow = 'auto';
            }
        }

        // Aprovar solicitação de senha
        async function approvePasswordRequest(requestId) {
            if (!requestId) {
                requestId = window.currentPasswordRequestId;
            }
            
            if (!requestId) {
                showNotification('ID da solicitação não encontrado', 'error');
                return;
            }
            
            try {
                // // const supabase = await getSupabaseClient(); // REMOVIDO // REMOVIDO - usando MySQL
                
                const { error: updateError } = await supabase
                    .from('password_requests')
                    .update({ 
                        status: 'approved',
                        approved_at: new Date().toISOString(),
                        approved_by: (await supabase.auth.getUser()).data.user.id
                    })
                    .eq('id', requestId);
                
                if (updateError) throw updateError;
                
                const { data: request, error: fetchError } = await supabase
                    .from('password_requests')
                    .select('*')
                    .eq('id', requestId)
                    .single();
                
                if (!fetchError && request) {
                    // Enviar notificação para o usuário (implementar conforme necessário)
                    showNotification('Solicitação aprovada com sucesso!', 'success');
                }
                
                // Fechar modal de detalhes se estiver aberto
                closePasswordRequestDetailsModal();
                
                // Recarregar lista de solicitações
                loadPasswordRequests();
                
            } catch (error) {
                console.error('Erro ao aprovar solicitação:', error);
                showNotification('Erro ao aprovar solicitação', 'error');
            }
        }
        
        // Rejeitar solicitação de senha
        async function rejectPasswordRequest(requestId) {
            if (!requestId) {
                requestId = window.currentPasswordRequestId;
            }
            
            if (!requestId) {
                requestId = window.currentPasswordRequestId;
            }
            
            if (!requestId) {
                showNotification('ID da solicitação não encontrado', 'error');
                return;
            }
            
            try {
                // // const supabase = await getSupabaseClient(); // REMOVIDO // REMOVIDO - usando MySQL
                
                // Atualizar status da solicitação
                const { error: updateError } = await supabase
                    .from('password_requests')
                    .update({ 
                        status: 'rejected',
                        rejected_at: new Date().toISOString(),
                        rejected_by: (await supabase.auth.getUser()).data.user.id
                    })
                    .eq('id', requestId);
                
                if (updateError) throw updateError;
                
                // Buscar dados da solicitação para notificar o usuário
                const { data: request, error: fetchError } = await supabase
                    .from('password_requests')
                    .select(`
                        *,
                        users!inner(name, email, role)
                    `)
                    .eq('id', requestId)
                    .single();
                
                if (!fetchError && request) {
                    // Enviar notificação para o usuário (implementar conforme necessário)
                    showNotification(`Solicitação de ${request.users.name} rejeitada.`, 'warning');
                }
                
                // Fechar modal de detalhes se estiver aberto
                closePasswordRequestDetailsModal();
                
                // Recarregar lista de solicitações
                loadPasswordRequests();
                
            } catch (error) {
                console.error('Erro ao rejeitar solicitação:', error);
                showNotification('Erro ao rejeitar solicitação', 'error');
            }
        }
        
        // Atualizar lista de solicitações
        function refreshPasswordRequests() {
            loadPasswordRequests();
        }
        
        // Aplicar filtro de solicitações
        document.addEventListener('DOMContentLoaded', function() {
            const filterSelect = document.getElementById('passwordRequestFilter');
            if (filterSelect) {
                filterSelect.addEventListener('change', function() {
                    const filterValue = this.value;
                    // Implementar filtro conforme necessário
                    loadPasswordRequests();
                });
            }
            
            // Garantir que ambos os modais estejam fechados ao carregar a página
            const detailsModal = document.getElementById('passwordRequestDetailsModal');
            const requestsModal = document.getElementById('passwordRequestsModal');
            
            if (detailsModal) {
                detailsModal.classList.add('hidden');
                detailsModal.style.display = 'none';
                detailsModal.style.visibility = 'hidden';
                detailsModal.style.opacity = '0';
                detailsModal.style.pointerEvents = 'none';
                detailsModal.style.zIndex = '-1';
            }
            
            if (requestsModal) {
                requestsModal.classList.add('hidden');
                requestsModal.style.display = 'none';
                requestsModal.style.visibility = 'hidden';
                requestsModal.style.opacity = '0';
                requestsModal.style.pointerEvents = 'none';
                requestsModal.style.zIndex = '-1';
            }
        });
        
        // Atualizar logo da Xandria Store baseada no tema
        function updateXandriaStoreIcon() {
            const icon = document.getElementById('xandriaStoreIcon');
            if (icon) {
                icon.src = 'https://i.postimg.cc/W17q41wM/lactechpreta.png'; // Logo preta para tema claro
            }
        }
    


    </script>
    
    <!-- Script para funções de solicitações de senha (escopo global) -->
    <script>
        // ==================== FUNÇÕES DE SOLICITAÇÕES DE SENHA (ESCOPO GLOBAL) ====================
        
        // Abrir modal de solicitações de senha
        function openPasswordRequests() {
            closeMoreModal();
            const modal = document.getElementById('passwordRequestsModal');
            if (modal) {
                modal.classList.remove('hidden');
                modal.style.display = 'flex';
                modal.style.visibility = 'visible';
                modal.style.opacity = '1';
                modal.style.pointerEvents = 'auto';
                modal.style.zIndex = '99999';
                
                // Carregar solicitações com refresh forçado
                console.log('🔄 Abrindo modal e carregando solicitações...');
                loadPasswordRequestsWithCache(true);
            }
        }
        
        // Fechar modal de solicitações de senha
        function closePasswordRequestsModal() {
            const modal = document.getElementById('passwordRequestsModal');
            if (modal) {
                modal.classList.add('hidden');
                modal.style.display = 'none';
                modal.style.visibility = 'hidden';
                modal.style.opacity = '0';
                modal.style.pointerEvents = 'none';
                modal.style.zIndex = '-1';
            }
        }
        
        // Fechar modal de detalhes da solicitação
        function closePasswordRequestDetailsModal() {
            const modal = document.getElementById('passwordRequestDetailsModal');
            if (modal) {
                modal.classList.add('hidden');
                modal.style.display = 'none';
                modal.style.visibility = 'hidden';
                modal.style.opacity = '0';
                modal.style.pointerEvents = 'none';
                modal.style.zIndex = '-1';
            }
        }
        
        // Carregar solicitações de senha
        async function loadPasswordRequests() {
            try {
                // // const supabase = await getSupabaseClient(); // REMOVIDO // REMOVIDO - usando MySQL
                const { data: { user } } = await supabase.auth.getUser();
                
                if (!user) {
                    showNotification('Usuário não autenticado', 'error');
                    return;
                }
                
                // Buscar dados do usuário atual para obter farm_id
                const { data: userData, error: userError } = await supabase
                    .from('users')
                    .select('farm_id')
                    .eq('id', user.id)
                    .single();
                
                if (userError || !userData?.farm_id) {
                    showNotification('Erro ao buscar dados da fazenda', 'error');
                    return;
                }
                
                // Buscar solicitações de senha da fazenda (abordagem corrigida)
                // Primeiro, buscar usuários da fazenda
                const { data: farmUsers, error: usersError } = await supabase
                    .from('users')
                    .select('id, name, email, role, profile_photo_url')
                    .eq('farm_id', userData.farm_id);
                
                if (usersError) {
                    console.error('❌ Erro ao buscar usuários da fazenda:', usersError);
                    showNotification('Erro ao buscar usuários da fazenda', 'error');
                    return;
                }
                
                if (!farmUsers || farmUsers.length === 0) {
                    console.log('📝 Nenhum usuário encontrado na fazenda');
                    displayPasswordRequests([]);
                    return;
                }
                
                const userIds = farmUsers.map(user => user.id);
                
                // Depois, buscar solicitações desses usuários
                const { data: requests, error } = await supabase
                    .from('password_requests')
                    .select('*')
                    .in('user_id', userIds)
                    .order('created_at', { ascending: false });
                
                if (error) {
                    console.error('Erro ao buscar solicitações:', error);
                    showNotification('Erro ao carregar solicitações', 'error');
                    return;
                }
                
                displayPasswordRequests(requests || []);
                
            } catch (error) {
                console.error('Erro ao carregar solicitações:', error);
                showNotification('Erro ao carregar solicitações', 'error');
            }
        }
        
        // Exibir solicitações de senha
        function displayPasswordRequests(requests) {
            const container = document.getElementById('passwordRequestsList');
            const emptyState = document.getElementById('emptyPasswordRequests');
            
            if (!container || !emptyState) return;
            
            // Atualizar contadores
            updateRequestCounters(requests || []);
            
            if (!requests || requests.length === 0) {
                container.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }
            
            emptyState.classList.add('hidden');
            container.innerHTML = '';
            
            requests.forEach(request => {
                const requestCard = createPasswordRequestCard(request);
                container.appendChild(requestCard);
            });
        }
        
        // Atualizar contadores de solicitações
        function updateRequestCounters(requests) {
            const pendingCount = requests.filter(r => r.status === 'pending').length;
            const approvedCount = requests.filter(r => r.status === 'approved').length;
            const rejectedCount = requests.filter(r => r.status === 'rejected').length;
            
            const pendingElement = document.getElementById('pendingCount');
            const approvedElement = document.getElementById('approvedCount');
            const rejectedElement = document.getElementById('rejectedCount');
            
            if (pendingElement) pendingElement.textContent = pendingCount;
            if (approvedElement) approvedElement.textContent = approvedCount;
            if (rejectedElement) rejectedElement.textContent = rejectedCount;
        }
        
        // Criar card de solicitação de senha
        function createPasswordRequestCard(request) {
            const card = document.createElement('div');
            card.className = 'bg-white bg-white rounded-xl border border-gray-200 border-gray-200 p-4 hover:shadow-md transition-all duration-200';
            
            const statusColors = {
                'pending': 'bg-yellow-100 text-yellow-800 bg-yellow-100/20 text-yellow-800',
                'approved': 'bg-green-100 text-green-800 bg-green-100/20 text-green-800',
                'rejected': 'bg-red-100 text-red-800 bg-red-100/20 text-red-800'
            };
            
            const statusTexts = {
                'pending': 'Pendente',
                'approved': 'Aprovada',
                'rejected': 'Rejeitada'
            };
            
            const typeTexts = {
                'change': 'Alteração de Senha',
                'reset': 'Redefinição de Senha'
            };
            
            const reasonTexts = {
                'forgot': 'Esqueci a senha',
                'security': 'Questões de segurança',
                'update': 'Atualização regular',
                'other': 'Outro motivo'
            };
            
            const formattedDate = new Date(request.created_at).toLocaleDateString('pt-BR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            
            card.innerHTML = `
                <div class="flex items-start justify-between mb-3">
                    <div class="flex items-center space-x-3">
                        <div class="w-8 h-8 bg-gray-300 bg-gray-300 rounded-full flex items-center justify-center">
                            <svg class="w-4 h-4 text-gray-600 " fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                            </svg>
                        </div>
                        <div>
                            <h4 class="font-bold text-gray-900 ">${request.users?.name || 'Usuário'}</h4>
                            <p class="text-sm text-gray-600 ">${request.users?.email || 'Email não informado'}</p>
                        </div>
                    </div>
                </div>
                
                <div class="mb-3">
                    <p class="font-bold text-gray-900 ">Motivo: ${reasonTexts[request.reason] || request.reason || 'Não especificado'}</p>
                </div>
                
                ${request.new_password || (request.notes && request.notes.includes('NOVA SENHA:')) ? `
                    <div class="mb-3">
                        <p class="text-gray-900  mb-1">Nova Senha:</p>
                        <div class="relative">
                            <input type="password" value="${request.new_password || (request.notes ? request.notes.split('NOVA SENHA: ')[1]?.split('\n')[0] : '')}" readonly class="w-full px-3 py-2 border border-gray-300 border-gray-300 rounded-lg bg-gray-50 bg-white text-gray-900  pr-10">
                            <button type="button" onclick="togglePasswordVisibility(this)" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700  hover:text-gray-700">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                ` : ''}
                
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-2 text-xs text-gray-500 ">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <span>${formattedDate}</span>
                    </div>
                    
                    <div class="flex items-center space-x-2">
                        <span class="px-3 py-1 text-xs font-medium rounded ${statusColors[request.status]}">
                            ${statusTexts[request.status]}
                        </span>
                        
                        <button onclick="viewPasswordRequestDetails('${request.id}')" class="px-3 py-1 bg-blue-500 hover:bg-blue-600 text-white text-xs rounded transition-colors duration-200">
                            Ver Detalhes
                        </button>
                        
                        ${request.status === 'pending' ? `
                            <button onclick="approvePasswordRequestDirect('${request.id}')" class="px-3 py-1 bg-green-500 hover:bg-green-600 text-white text-xs rounded transition-colors duration-200">
                                Aprovar
                            </button>
                            
                            <button onclick="rejectPasswordRequestDirect('${request.id}')" class="px-3 py-1 bg-red-500 hover:bg-red-600 text-white text-xs rounded transition-colors duration-200">
                                Rejeitar
                            </button>
                        ` : ''}
                        
                        <button onclick="deletePasswordRequest('${request.id}')" class="p-1.5 bg-gray-500 hover:bg-gray-600 text-white rounded transition-colors duration-200" title="Excluir solicitação">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            `;
            
            return card;
        }
        
        // Visualizar detalhes da solicitação (versão corrigida)
        async function viewPasswordRequestDetailsFixed(requestId) {
            try {
                // // const supabase = await getSupabaseClient(); // REMOVIDO // REMOVIDO - usando MySQL
                
                // Buscar solicitação sem JOIN
                const { data: request, error } = await supabase
                    .from('password_requests')
                    .select('*')
                    .eq('id', requestId)
                    .single();
                
                if (error || !request) {
                    showNotification('Erro ao carregar detalhes da solicitação', 'error');
                    return;
                }
                
                // Buscar dados do usuário separadamente
                let userData = { name: 'Usuário não encontrado', email: 'Email não encontrado', role: 'N/A' };
                try {
                    const { data: user } = await supabase
                        .from('users')
                        .select('name, email, role')
                        .eq('id', request.user_id)
                        .single();
                    
                    if (user) {
                        userData = user;
                    }
                } catch (userError) {
                }
                
                // Função para truncar texto
                function truncateText(text, maxLength = 30) {
                    if (!text) return 'Não informado';
                    if (text.length <= maxLength) return text;
                    return text.substring(0, maxLength) + '...';
                }
                
                // Traduzir motivo
                function translateReason(reason) {
                    const translations = {
                        'forgot_password': 'Esqueci minha senha',
                        'change_password': 'Alterar senha',
                        'reset_password': 'Redefinir senha',
                        'security_concern': 'Preocupação de segurança',
                        'account_compromised': 'Conta comprometida',
                        'regular_update': 'Atualização regular'
                    };
                    return translations[reason] || reason;
                }
                
                // Preencher modal de detalhes
                document.getElementById('requestUserName').textContent = truncateText(userData.name);
                document.getElementById('requestUserEmail').textContent = truncateText(userData.email, 40);
                document.getElementById('requestUserRole').textContent = userData.role || 'N/A';
                document.getElementById('requestDate').textContent = new Date(request.created_at).toLocaleDateString('pt-BR');
                document.getElementById('requestType').textContent = request.type === 'change' ? 'Alteração de Senha' : 'Redefinição de Senha';
                document.getElementById('requestReason').textContent = translateReason(request.reason) || 'N/A';
                document.getElementById('requestNotes').textContent = request.notes || 'N/A';
                
                // Armazenar ID da solicitação atual
                window.currentPasswordRequestId = requestId;
                
                // Abrir modal de detalhes
                const modal = document.getElementById('passwordRequestDetailsModal');
                if (modal) {
                    modal.classList.remove('hidden');
                    modal.style.display = 'flex';
                    modal.style.visibility = 'visible';
                    modal.style.opacity = '1';
                    modal.style.pointerEvents = 'auto';
                    modal.style.zIndex = '99999';
                }
                
            } catch (error) {
                console.error('Erro ao visualizar detalhes:', error);
                showNotification('Erro ao carregar detalhes', 'error');
            }
        }
        
        // Aprovar solicitação de senha
        async function approvePasswordRequest() {
            try {
                if (!window.currentPasswordRequestId) {
                    showNotification('ID da solicitação não encontrado', 'error');
                    return;
                }
                
                // // const supabase = await getSupabaseClient(); // REMOVIDO // REMOVIDO - usando MySQL
                const { data: { user } } = await supabase.auth.getUser();
                
                if (!user) {
                    showNotification('Usuário não autenticado', 'error');
                    return;
                }
                
                // Atualizar status da solicitação
                const { error } = await supabase
                    .from('password_requests')
                    .update({
                        status: 'approved',
                        approved_at: new Date().toISOString(),
                        approved_by: user.id
                    })
                    .eq('id', window.currentPasswordRequestId);
                
                if (error) throw error;
                
                showNotification('Solicitação aprovada com sucesso!', 'success');
                
                // Fechar modal e recarregar lista
                closePasswordRequestDetailsModal();
                loadPasswordRequests();
                
            } catch (error) {
                console.error('Erro ao aprovar solicitação:', error);
                showNotification('Erro ao aprovar solicitação: ' + error.message, 'error');
            }
        }
        
        // Rejeitar solicitação de senha
        async function rejectPasswordRequest() {
            try {
                if (!window.currentPasswordRequestId) {
                    showNotification('ID da solicitação não encontrado', 'error');
                    return;
                }
                
                // // const supabase = await getSupabaseClient(); // REMOVIDO // REMOVIDO - usando MySQL
                const { data: { user } } = await supabase.auth.getUser();
                
                if (!user) {
                    showNotification('Usuário não autenticado', 'error');
                    return;
                }
                
                // Atualizar status da solicitação
                const { error } = await supabase
                    .from('password_requests')
                    .update({
                        status: 'rejected',
                        rejected_at: new Date().toISOString(),
                        rejected_by: user.id
                    })
                    .eq('id', window.currentPasswordRequestId);
                
                if (error) throw error;
                
                // Log de auditoria
                logAuditEvent('password_request_rejected', requestId, {
                    managerId: user.id,
                    reason: 'manager_rejection'
                });
                
                // Limpar cache para forçar atualização
                clearCache();
                
                showNotification('Solicitação rejeitada com sucesso!', 'success');
                
                // Fechar modal e recarregar lista
                closePasswordRequestDetailsModal();
                loadPasswordRequests();
                
            } catch (error) {
                console.error('Erro ao rejeitar solicitação:', error);
                showNotification('Erro ao rejeitar solicitação: ' + error.message, 'error');
            }
        }
        
        // Atualizar solicitações de senha
        async function refreshPasswordRequests() {
            const btn = document.getElementById('refreshPasswordRequestsBtn');
            if (btn) {
                // Adicionar animação de loading
                btn.disabled = true;
                btn.innerHTML = `
                    <svg class="w-4 h-4 inline mr-2 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                    Atualizando...
                `;
            }
            
            try {
                await loadPasswordRequestsWithCache(true);
            } finally {
                if (btn) {
                    // Restaurar botão
                    btn.disabled = false;
                    btn.innerHTML = `
                        <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                        Atualizar
                    `;
                }
            }
        }
        
        // Event listener para filtro de solicitações
        document.addEventListener('DOMContentLoaded', function() {
            const filterSelect = document.getElementById('passwordRequestFilter');
            if (filterSelect) {
                filterSelect.addEventListener('change', function() {
                    const filterValue = this.value;
                    // Implementar filtro conforme necessário
                    loadPasswordRequests();
                });
            }
            
            // Garantir que ambos os modais estejam fechados ao carregar a página
            const detailsModal = document.getElementById('passwordRequestDetailsModal');
            const requestsModal = document.getElementById('passwordRequestsModal');
            
            if (detailsModal) {
                detailsModal.classList.add('hidden');
                detailsModal.style.display = 'none';
                detailsModal.style.visibility = 'hidden';
                detailsModal.style.opacity = '0';
                detailsModal.style.pointerEvents = 'none';
                detailsModal.style.zIndex = '-1';
            }
            
            if (requestsModal) {
                requestsModal.classList.add('hidden');
                requestsModal.style.display = 'none';
                requestsModal.style.visibility = 'hidden';
                requestsModal.style.opacity = '0';
                requestsModal.style.pointerEvents = 'none';
                requestsModal.style.zIndex = '-1';
            }
        });
<<<<<<< HEAD
    
        // ==================== CONTINUAÇÃO DO JAVASCRIPT - FUNÇÕES DE NOTIFICAÇÕES ====================
        
        // Abrir sidebar de notificações
        function openNotificationsModal() {
            const modal = document.getElementById('notificationsModal');
            const content = document.getElementById('notificationsModalContent');
            
            if (modal && content) {
                modal.classList.remove('hidden');
                
                // Pequeno delay para garantir que o modal está visível antes da animação
                setTimeout(() => {
                    content.classList.remove('translate-x-full');
                    content.classList.add('translate-x-0');
                }, 10);
                
                loadNotifications();
            }
        }
        
        // Fechar sidebar de notificações
        function closeNotificationsModal() {
            const modal = document.getElementById('notificationsModal');
            const content = document.getElementById('notificationsModalContent');
            
            if (modal && content) {
                content.classList.remove('translate-x-0');
                content.classList.add('translate-x-full');
                
                setTimeout(() => {
                    modal.classList.add('hidden');
                }, 300);
            }
        }
        
        // Carregar notificações
        async function loadNotifications() {
            try {
                const notificationsList = document.getElementById('notificationsList');
                if (notificationsList) {
                    notificationsList.innerHTML = '<p class="text-center text-gray-500 py-4">Nenhuma notificação</p>';
                }
                updateNotificationCounter(0);
            } catch (error) {
                // Silencioso
            }
        }
        
        // Atualizar contador de notificações
        function updateNotificationCounter(count) {
            const counter = document.getElementById('notificationCounter');
            if (counter) {
                if (count > 0) {
                    counter.textContent = count;
                    counter.classList.remove('hidden');
                } else {
                    counter.classList.add('hidden');
                }
            }
        }
        
        // ==================== FUNÇÕES CORRIGIDAS DE SOLICITAÇÕES DE SENHA ====================
        
        // Função corrigida para carregar solicitações de senha
        async function loadPasswordRequestsFixed() {
            try {
                // Usando MySQL direto através do objeto 'db'
                
                console.log('🔄 Carregando solicitações de senha...');
                
                // Buscar todas as solicitações de senha (SEM join com users para evitar problemas de RLS)
                const { data: requests, error } = await db
                    .from('password_requests')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) {
                    console.error('❌ Erro ao carregar solicitações:', error);
                    showNotification('Erro ao carregar solicitações de senha: ' + error.message, 'error');
                    return;
                }
                
                console.log('✅ Solicitações carregadas:', requests);
                
                // Para cada solicitação, buscar os dados do usuário separadamente (com tratamento de erro melhorado)
                if (requests && requests.length > 0) {
                    for (let request of requests) {
                        try {
                            const { data: userData, error: userError } = await db
                                .from('users')
                                .select('email, name')
                                .eq('id', request.user_id)
                                .maybeSingle(); // Usar maybeSingle para evitar erro se não encontrar
                            
                            if (userError) {
                                request.users = { email: 'Email indisponível', name: 'Usuário indisponível' };
                            } else if (userData) {
                                request.users = userData;
                            } else {
                                request.users = { email: 'Email não encontrado', name: 'Usuário não encontrado' };
                            }
                        } catch (userError) {
                            request.users = { email: 'Email indisponível', name: 'Usuário indisponível' };
                        }
                    }
                }
                
                displayPasswordRequests(requests || []);
                updateRequestCounters(requests || []);
                
            } catch (error) {
                console.error('❌ Erro geral ao carregar solicitações:', error);
                showNotification('Erro ao carregar solicitações de senha: ' + error.message, 'error');
            }
        }
        
        // Função corrigida mantida para referência
        // window.loadPasswordRequests será substituída pela versão otimizada mais abaixo
        
        // ==================== SISTEMA DE ATUALIZAÇÃO EM TEMPO REAL ====================
        
        // Variáveis para controle de WebSocket
        let realTimeInterval = null;
        let isRealTimeActive = false;
        let updateCount = 0;
        let lastUpdateTime = null;
        
        // Função para iniciar atualização em tempo real
        function startRealTimeUpdates() {
            if (isRealTimeActive) return;
            
            isRealTimeActive = true;
            console.log('🔄 Iniciando atualizações em tempo real...');
            
            // Mostrar indicador de tempo real
            const indicator = document.getElementById('realTimeIndicator');
            if (indicator) {
                indicator.classList.remove('hidden');
            }
            
            // Atualizar a cada 5 segundos
            realTimeInterval = setInterval(() => {
                updateRealTimeData();
            }, 5000);
            
            // Atualizar imediatamente
            updateRealTimeData();
        }
        
        // Função para parar atualização em tempo real
        function stopRealTimeUpdates() {
            if (realTimeInterval) {
                clearInterval(realTimeInterval);
                realTimeInterval = null;
            }
            isRealTimeActive = false;
            console.log('⏹️ Parando atualizações em tempo real...');
            
            // Ocultar indicador de tempo real
            const indicator = document.getElementById('realTimeIndicator');
            if (indicator) {
                indicator.classList.add('hidden');
            }
        }
        
        // Função principal de atualização em tempo real
        async function updateRealTimeData() {
            try {
                // Atualizar notificações
                await loadNotifications();
                
                // Atualizar solicitações de senha se o modal estiver aberto
                const passwordModal = document.getElementById('passwordRequestsModal');
                if (passwordModal && !passwordModal.classList.contains('hidden')) {
                    await loadPasswordRequests();
                }
                
                // Atualizar histórico se o modal estiver aberto
                const historyModal = document.getElementById('passwordHistoryModal');
                if (historyModal && !historyModal.classList.contains('hidden')) {
                    await loadPasswordHistory();
                }
                
                // Atualizar gráficos se necessário
                await updateCharts();
                
                // Atualizar indicador de status
                updateConnectionStatus('connected');
                
                // Atualizar estatísticas
                updateCount++;
                lastUpdateTime = new Date();
                
                console.log(`✅ Dados atualizados em tempo real (${updateCount} atualizações)`);
                
            } catch (error) {
                console.error('❌ Erro na atualização em tempo real:', error);
                updateConnectionStatus('error');
            }
        }
        
        // Função para atualizar status de conexão
        function updateConnectionStatus(status) {
            const indicator = document.getElementById('realTimeIndicator');
            if (!indicator) return;
            
            // Remover classes anteriores
            indicator.classList.remove('bg-green-500', 'bg-red-500', 'bg-yellow-500');
            
            switch (status) {
                case 'connected':
                    indicator.classList.add('bg-green-500');
                    indicator.title = 'Sistema automático ativo - Dados atualizados a cada 5 segundos';
                    break;
                case 'error':
                    indicator.classList.add('bg-red-500');
                    indicator.title = 'Erro de conexão - Sistema tentando reconectar...';
                    break;
                case 'connecting':
                    indicator.classList.add('bg-yellow-500');
                    indicator.title = 'Iniciando sistema automático...';
                    break;
            }
        }
        
        // Função para atualizar gráficos
        async function updateCharts() {
            try {
                // Aqui você pode adicionar lógica para atualizar gráficos específicos
                // Por exemplo, se houver gráficos de estatísticas
                console.log('📊 Atualizando gráficos...');
                
                // Exemplo: atualizar contadores de estatísticas
                await updateStatisticsCounters();
                
            } catch (error) {
                console.error('❌ Erro ao atualizar gráficos:', error);
            }
        }
        
        // Função para atualizar contadores de estatísticas
        async function updateStatisticsCounters() {
            try {
                console.log('📊 Atualizando contadores de estatísticas (MySQL)...');
                
                // Por enquanto, não há contadores no MySQL
                // Definir valores padrão
                const pendingCount = 0;
                const approvedCount = 0;
                const rejectedCount = 0;
                
                // Atualizar elementos na interface
                updateCounterElement('pendingCount', pendingCount);
                updateCounterElement('approvedCount', approvedCount);
                updateCounterElement('rejectedCount', rejectedCount);
                
                console.log('✅ Contadores atualizados (MySQL)');
                
            } catch (error) {
                console.error('❌ Erro ao atualizar contadores:', error);
            }
        }
        
        // Função para atualizar elemento de contador
        function updateCounterElement(elementId, count) {
            const element = document.getElementById(elementId);
            if (element) {
                const currentCount = parseInt(element.textContent) || 0;
                if (currentCount !== count) {
                    element.textContent = count;
                    
                    // Adicionar animação de mudança
                    element.classList.add('animate-pulse');
                    setTimeout(() => {
                        element.classList.remove('animate-pulse');
                    }, 1000);
                }
            }
        }
        
        // Função para atualizar contador de notificações
        function updateNotificationCounter(count) {
            const countElement = document.getElementById('notificationCounter');
            if (countElement) {
                const currentCount = parseInt(countElement.textContent) || 0;
                countElement.textContent = count;
                countElement.style.display = count > 0 ? 'block' : 'none';
                
                // Adicionar animação quando há mudança
                if (currentCount !== count && count > 0) {
                    countElement.classList.add('animate-pulse');
                    setTimeout(() => {
                        countElement.classList.remove('animate-pulse');
                    }, 1000);
                }
            }
        }
        
        // Iniciar atualizações em tempo real quando a página carrega
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                startRealTimeUpdates();
                loadNotifications();
            }, 2000);
        });
        
        // Parar atualizações quando a página for fechada
        window.addEventListener('beforeunload', () => {
            stopRealTimeUpdates();
        });
        
        // Pausar atualizações quando a aba não estiver ativa
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                stopRealTimeUpdates();
            } else {
                startRealTimeUpdates();
            }
        });
        
        
        // Função para mostrar informações de debug do sistema de tempo real
        function showRealTimeDebugInfo() {
            const status = isRealTimeActive ? 'Ativo' : 'Inativo';
            const lastUpdate = lastUpdateTime ? lastUpdateTime.toLocaleTimeString('pt-BR') : 'Nunca';
            
            const debugInfo = `
🔄 Sistema de Atualização em Tempo Real

Status: ${status}
Atualizações realizadas: ${updateCount}
Última atualização: ${lastUpdate}
Intervalo: 5 segundos
Indicador visual: ${document.getElementById('realTimeIndicator')?.classList.contains('hidden') ? 'Oculto' : 'Visível'}

Funcionalidades:
✅ Contador de notificações
✅ Lista de solicitações de senha
✅ Contadores de estatísticas
✅ Indicador de status de conexão
✅ Pausa automática quando aba inativa
✅ Sistema totalmente automático
✅ Limpeza automática (24h)
✅ Modal de histórico
✅ Exclusão individual de solicitações (botão lixeira em cada card)
            `;
            
            console.log(debugInfo);
            showNotification(`Debug: ${status} - ${updateCount} atualizações`, 'info');
        }
        
        // Adicionar função global para debug
        window.showRealTimeDebugInfo = showRealTimeDebugInfo;
        
        // ==================== SISTEMA DE LIMPEZA AUTOMÁTICA E HISTÓRICO ====================
        
        // Função para limpeza automática de solicitações antigas (24 horas)
        async function cleanupOldPasswordRequests() {
            try {
                // Usando MySQL direto através do objeto 'db'
                const twentyFourHoursAgo = new Date();
                twentyFourHoursAgo.setHours(twentyFourHoursAgo.getHours() - 24);
                
                console.log('🧹 Iniciando limpeza automática de solicitações antigas...');
                
                // Buscar solicitações antigas
                const { data: oldRequests, error: fetchError } = await db
                    .from('password_requests')
                    .select('id, status, created_at')
                    .lt('created_at', twentyFourHoursAgo.toISOString());
                
                if (fetchError) {
                    console.error('❌ Erro ao buscar solicitações antigas:', fetchError);
                    return;
                }
                
                if (oldRequests && oldRequests.length > 0) {
                    console.log(`🗑️ Encontradas ${oldRequests.length} solicitações antigas para remover`);
                    
                    // Remover solicitações antigas
                    const { error: deleteError } = await db
                        .from('password_requests')
                        .delete()
                        .lt('created_at', twentyFourHoursAgo.toISOString());
                    
                    if (deleteError) {
                        console.error('❌ Erro ao remover solicitações antigas:', deleteError);
                    } else {
                        console.log(`✅ ${oldRequests.length} solicitações antigas removidas com sucesso`);
                        
                        // Atualizar interface se necessário
                        await loadNotifications();
                        const passwordModal = document.getElementById('passwordRequestsModal');
                        if (passwordModal && !passwordModal.classList.contains('hidden')) {
                            await loadPasswordRequests();
                        }
                    }
                } else {
                    console.log('✅ Nenhuma solicitação antiga encontrada');
                }
                
            } catch (error) {
                console.error('❌ Erro na limpeza automática:', error);
            }
        }
        
        // Função para abrir modal de histórico
        function openPasswordHistoryModal() {
            const modal = document.getElementById('passwordHistoryModal');
            if (modal) {
                modal.classList.remove('hidden');
                modal.style.display = 'flex';
                modal.style.zIndex = '99999';
                
                // Carregar histórico automaticamente
                loadPasswordHistory();
            }
        }
        
        // Função para fechar modal de histórico
        function closePasswordHistoryModal() {
            const modal = document.getElementById('passwordHistoryModal');
            if (modal) {
                modal.classList.add('hidden');
                modal.style.display = 'none';
                modal.style.zIndex = '-1';
            }
        }
        
        // Função para carregar histórico de solicitações
        async function loadPasswordHistory() {
            const btn = document.getElementById('refreshPasswordHistoryBtn');
            if (btn) {
                // Adicionar animação de loading
                btn.disabled = true;
                btn.innerHTML = `
                    <svg class="w-4 h-4 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                    <span>Atualizando...</span>
                `;
            }
            
            try {
                // Usando MySQL direto através do objeto 'db'
                const loadingElement = document.getElementById('historyLoading');
                const emptyElement = document.getElementById('emptyHistory');
                const listElement = document.getElementById('passwordHistoryList');
                
                // Mostrar loading
                if (loadingElement) loadingElement.classList.remove('hidden');
                if (emptyElement) emptyElement.classList.add('hidden');
                
                // Obter filtros
                const statusFilter = document.getElementById('historyStatusFilter')?.value || '';
                const daysFilter = parseInt(document.getElementById('historyDateFilter')?.value || '30');
                
                // Calcular data limite
                const dateLimit = new Date();
                dateLimit.setDate(dateLimit.getDate() - daysFilter);
                
                console.log('📚 Carregando histórico de solicitações...');
                
                // Buscar solicitações do histórico
                let query = db
                    .from('password_requests')
                    .select('*')
                    .gte('created_at', dateLimit.toISOString())
                    .order('created_at', { ascending: false });
                
                if (statusFilter) {
                    query = query.eq('status', statusFilter);
                }
                
                const { data: requests, error } = await query;
                
                if (error) {
                    console.error('❌ Erro ao carregar histórico:', error);
                    throw error;
                }
                
                console.log('📚 Histórico carregado:', requests);
                
                // Ocultar loading
                if (loadingElement) loadingElement.classList.add('hidden');
                
                if (!requests || requests.length === 0) {
                    // Mostrar empty state
                    if (emptyElement) emptyElement.classList.remove('hidden');
                    return;
                }
                
                // Buscar dados dos usuários para cada solicitação (com tratamento de erro melhorado)
                const historyWithUsers = [];
                for (const request of requests) {
                    try {
                        // Tentar buscar dados do usuário com tratamento de erro
                        const { data: userData, error: userError } = await db
                            .from('users')
                            .select('email, name')
                            .eq('id', request.user_id)
                            .maybeSingle(); // Usar maybeSingle para evitar erro se não encontrar
                        
                        if (userError) {
                            historyWithUsers.push({
                                ...request,
                                user_email: 'Email indisponível',
                                user_name: 'Usuário indisponível'
                            });
                        } else if (userData) {
                            historyWithUsers.push({
                                ...request,
                                user_email: userData.email || 'Email não encontrado',
                                user_name: userData.name || 'Usuário não encontrado'
                            });
                        } else {
                            historyWithUsers.push({
                                ...request,
                                user_email: 'Email não encontrado',
                                user_name: 'Usuário não encontrado'
                            });
                        }
                    } catch (userError) {
                        historyWithUsers.push({
                            ...request,
                            user_email: 'Email indisponível',
                            user_name: 'Usuário indisponível'
                        });
                    }
                }
                
                // Exibir histórico
                displayPasswordHistory(historyWithUsers);
                
            } catch (error) {
                console.error('❌ Erro ao carregar histórico:', error);
                const loadingElement = document.getElementById('historyLoading');
                if (loadingElement) loadingElement.classList.add('hidden');
            } finally {
                if (btn) {
                    // Restaurar botão
                    btn.disabled = false;
                    btn.innerHTML = `
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                        <span>Atualizar</span>
                    `;
                }
            }
        }
        
        // Função para exibir histórico de solicitações
        function displayPasswordHistory(requests) {
            const listElement = document.getElementById('passwordHistoryList');
            const emptyElement = document.getElementById('emptyHistory');
            
            if (!listElement) return;
            
            if (!requests || requests.length === 0) {
                if (emptyElement) emptyElement.classList.remove('hidden');
                return;
            }
            
            if (emptyElement) emptyElement.classList.add('hidden');
            
            listElement.innerHTML = requests.map(request => createHistoryCard(request)).join('');
        }
        
        // Função para criar card de histórico
        function createHistoryCard(request) {
            const statusColors = {
                approved: 'bg-green-100 text-green-800 bg-green-100/20 dark:text-green-400',
                rejected: 'bg-red-100 text-red-800 bg-red-100/20 text-red-600',
                pending: 'bg-yellow-100 text-yellow-800 bg-yellow-100/20 text-yellow-600'
            };
            
            const statusTexts = {
                approved: 'Aprovada',
                rejected: 'Rejeitada',
                pending: 'Pendente'
            };
            
            const typeTexts = {
                change: 'Alteração de Senha',
                reset: 'Redefinição de Senha'
            };
            
            const reasonTexts = {
                forgot: 'Esqueci a senha',
                security: 'Questões de segurança',
                update: 'Atualização regular',
                other: 'Outro motivo'
            };
            
            const createdDate = new Date(request.created_at);
            const formattedDate = createdDate.toLocaleDateString('pt-BR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            return `
                <div class="bg-white  rounded-xl border border-gray-200 border-gray-200 p-4 hover:shadow-lg transition-all duration-200">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <div class="flex items-center space-x-3 mb-2">
                                <span class="px-2 py-1 text-xs font-medium rounded-full ${statusColors[request.status]}">
                                    ${statusTexts[request.status]}
                                </span>
                                <span class="text-sm text-gray-500 ">
                                    ${typeTexts[request.type] || 'Tipo não especificado'}
                                </span>
                            </div>
                            
                            <div class="space-y-1">
                                <p class="font-medium text-gray-900 ">
                                    ${request.user_name || 'Usuário não encontrado'}
                                </p>
                                <p class="text-sm text-gray-600 ">
                                    ${request.user_email || 'Email não encontrado'}
                                </p>
                                <p class="text-sm text-gray-500 ">
                                    Motivo: ${reasonTexts[request.reason] || request.reason || 'Não especificado'}
                                </p>
                            </div>
                            
                            ${request.notes ? `
                                <div class="mt-2 p-2 bg-gray-50 bg-white rounded-lg">
                                    <p class="text-sm text-gray-700 ">
                                        ${request.notes.length > 100 ? request.notes.substring(0, 100) + '...' : request.notes}
                                    </p>
                                </div>
                            ` : ''}
                        </div>
                        
                        <div class="text-right">
                            <p class="text-sm text-gray-500 ">
                                ${formattedDate}
                            </p>
                            ${request.approved_by ? `
                                <p class="text-xs text-gray-400  mt-1">
                                    Processado por: ${request.approved_by}
                                </p>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Executar limpeza automática a cada hora
        setInterval(cleanupOldPasswordRequests, 60 * 60 * 1000); // 1 hora
        
        // Executar limpeza inicial após 5 segundos
        setTimeout(cleanupOldPasswordRequests, 5000);
        
        // Função para alternar visibilidade da senha
        function togglePasswordVisibility(button) {
            const input = button.previousElementSibling;
            const icon = button.querySelector('svg');
            
            if (input.type === 'password') {
                input.type = 'text';
                icon.innerHTML = `
                    <path stroke-linecap="round" stroke-linejoin="round" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.878 9.878L3 3m6.878 6.878L21 21"></path>
                `;
            } else {
                input.type = 'password';
                icon.innerHTML = `
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                `;
            }
        }
        
        // Função para excluir solicitação individual
        async function deletePasswordRequest(requestId) {
            try {
                // Mostrar confirmação
                const confirmed = confirm('Tem certeza que deseja excluir esta solicitação? Esta ação não pode ser desfeita.');
                if (!confirmed) return;
                
                // Usando MySQL direto através do objeto 'db'
                
                console.log('🗑️ Excluindo solicitação:', requestId);
                
                // Excluir solicitação
                const { error } = await db
                    .from('password_requests')
                    .delete()
                    .eq('id', requestId);
                
                if (error) {
                    console.error('❌ Erro ao excluir solicitação:', error);
                    showNotification('Erro ao excluir solicitação', 'error');
                    return;
                }
                
                console.log('✅ Solicitação excluída com sucesso');
                showNotification('Solicitação excluída com sucesso', 'success');
                
                // Atualizar interface
                await loadNotifications();
                await loadPasswordRequests();
                
                // Atualizar histórico se estiver aberto
                const historyModal = document.getElementById('passwordHistoryModal');
                if (historyModal && !historyModal.classList.contains('hidden')) {
                    await loadPasswordHistory();
                }
                
            } catch (error) {
                console.error('❌ Erro ao excluir solicitação:', error);
                showNotification('Erro ao excluir solicitação', 'error');
            }
        }
        
        // Função para excluir múltiplas solicitações
        async function deleteMultiplePasswordRequests(requestIds) {
            try {
                if (!requestIds || requestIds.length === 0) {
                    showNotification('Nenhuma solicitação selecionada', 'warning');
                    return;
                }
                
                const confirmed = confirm(`Tem certeza que deseja excluir ${requestIds.length} solicitação(ões)? Esta ação não pode ser desfeita.`);
                if (!confirmed) return;
                
                // Usando MySQL direto através do objeto 'db'
                
                console.log('🗑️ Excluindo múltiplas solicitações:', requestIds);
                
                // Excluir múltiplas solicitações
                const { error } = await db
                    .from('password_requests')
                    .delete()
                    .in('id', requestIds);
                
                if (error) {
                    console.error('❌ Erro ao excluir solicitações:', error);
                    showNotification('Erro ao excluir solicitações', 'error');
                    return;
                }
                
                console.log(`✅ ${requestIds.length} solicitações excluídas com sucesso`);
                showNotification(`${requestIds.length} solicitações excluídas com sucesso`, 'success');
                
                // Atualizar interface
                await loadNotifications();
                await loadPasswordRequests();
                
                // Atualizar histórico se estiver aberto
                const historyModal = document.getElementById('passwordHistoryModal');
                if (historyModal && !historyModal.classList.contains('hidden')) {
                    await loadPasswordHistory();
                }
                
            } catch (error) {
                console.error('❌ Erro ao excluir solicitações:', error);
                showNotification('Erro ao excluir solicitações', 'error');
            }
        }
        
        
        // Event listeners para filtros do histórico
        document.addEventListener('DOMContentLoaded', () => {
            const statusFilter = document.getElementById('historyStatusFilter');
            const dateFilter = document.getElementById('historyDateFilter');
            
            if (statusFilter) {
                statusFilter.addEventListener('change', loadPasswordHistory);
            }
            
            if (dateFilter) {
                dateFilter.addEventListener('change', loadPasswordHistory);
            }
        });
        
        // ==================== FUNÇÃO CORRIGIDA PARA EXIBIR SOLICITAÇÕES ====================
        
        // Função corrigida para exibir solicitações
        function displayPasswordRequestsFixed(requests) {
            console.log('📋 Exibindo solicitações:', requests);
            console.log('📋 Número de solicitações:', requests?.length || 0);
            
            const container = document.getElementById('passwordRequestsList');
            const emptyState = document.getElementById('emptyPasswordRequests');
            const modal = document.getElementById('passwordRequestsModal');
            
            console.log('📋 Container encontrado:', !!container);
            console.log('📋 Empty state encontrado:', !!emptyState);
            console.log('📋 Modal encontrado:', !!modal);
            console.log('📋 Modal visível:', modal ? !modal.classList.contains('hidden') : false);
            
            if (!container) {
                console.error('❌ Container passwordRequestsList não encontrado');
                return;
            }
            
            if (!emptyState) {
                console.error('❌ EmptyState emptyPasswordRequests não encontrado');
                return;
            }
            
            // Se o modal não estiver visível, não exibir as solicitações
            if (modal && modal.classList.contains('hidden')) {
                console.log('📋 Modal não está visível, não exibindo solicitações');
                return;
            }
            
            // Atualizar contadores
            updateRequestCounters(requests || []);
            
            if (!requests || requests.length === 0) {
                container.innerHTML = '';
                emptyState.classList.remove('hidden');
                console.log('📝 Nenhuma solicitação encontrada');
                return;
            }
            
            emptyState.classList.add('hidden');
            container.innerHTML = '';
            
            requests.forEach((request, index) => {
                console.log(`📄 Criando card para solicitação ${index + 1}:`, request);
                
                const card = document.createElement('div');
                card.className = 'bg-white bg-white border border-gray-200 border-gray-200 rounded-xl p-4 shadow-lg hover:shadow-xl transition-all duration-300 hover:scale-[1.01] hover:border-blue-300 hover:border-blue-300';
                
                const statusColors = {
                    'pending': 'bg-yellow-100 text-yellow-800 bg-yellow-100/20 text-yellow-800',
                    'approved': 'bg-green-100 text-green-800 bg-green-100/20 text-green-800',
                    'rejected': 'bg-red-100 text-red-800 bg-red-100/20 text-red-800'
                };
                
                const statusText = {
                    'pending': 'Pendente',
                    'approved': 'Aprovada',
                    'rejected': 'Rejeitada'
                };
                
                const userName = request.users?.name || request.users?.email || 'Usuário desconhecido';
                const userEmail = request.users?.email || 'Email não disponível';
                
                // Extrair a nova senha das notas ou do campo new_password
                let newPassword = '';
                if (request.new_password) {
                    newPassword = request.new_password;
                } else if (request.notes && request.notes.includes('NOVA SENHA:')) {
                    const passwordMatch = request.notes.match(/NOVA SENHA:\s*([^\n\r]+)/);
                    newPassword = passwordMatch ? passwordMatch[1].trim() : '';
                }
                
                card.innerHTML = `
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <!-- Header do card -->
                            <div class="flex items-center justify-between mb-3">
                                <div class="flex items-center space-x-3">
                                    <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-600 rounded-lg flex items-center justify-center">
                                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                        </svg>
                                    </div>
                                    <div>
                                        <h4 class="text-base font-bold text-gray-900 ">${userName}</h4>
                                        <p class="text-xs text-gray-600 ">${userEmail}</p>
                                    </div>
                                </div>
                                <span class="px-2 py-1 text-xs font-semibold rounded-full ${statusColors[request.status] || statusColors.pending}">
                                    ${statusText[request.status] || 'Pendente'}
                                </span>
                            </div>
                            
                            <!-- Motivo -->
                            <div class="mb-3">
                                <p class="text-sm text-gray-700 ">
                                    <span class="font-semibold text-gray-900 ">Motivo:</span> ${request.reason || 'Não informado'}
                                </p>
                            </div>
                            
                            <!-- Nova Senha -->
                            ${newPassword ? `
                                <div class="bg-gradient-to-r from-blue-50 to-purple-50 from-blue-50 to-purple-50 border border-blue-200 border-blue-200 rounded-lg p-3 mb-3">
                                    <div class="flex items-center justify-between mb-2">
                                        <span class="text-xs font-semibold text-blue-800 text-blue-800">Nova Senha:</span>
                                        <button onclick="togglePasswordVisibility('${request.id}')" class="p-1 text-blue-600 hover:text-blue-800 text-blue-600 hover:bg-blue-100 hover:bg-blue-100 rounded transition-all">
                                            <svg id="eye-${request.id}" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                                <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                                <path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                            </svg>
                                        </button>
                                    </div>
                                    <div id="password-${request.id}" class="text-sm text-blue-700 dark:text-blue-300 font-mono bg-white  rounded p-2 border" style="display: none;">
                                        ${newPassword}
                                    </div>
                                    <div id="password-hidden-${request.id}" class="text-sm text-blue-700 dark:text-blue-300 font-mono bg-white  rounded p-2 border">
                                        ••••••••
                                    </div>
                                </div>
                            ` : ''}
                            
                            <!-- Data -->
                            <div class="flex items-center text-xs text-gray-500 ">
                                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                ${new Date(request.created_at).toLocaleString('pt-BR')}
                            </div>
                        </div>
                        
                        <!-- Botões de ação -->
                        <div class="flex flex-col space-y-2 ml-4">
                            <button onclick="viewPasswordRequestDetails('${request.id}')" class="px-3 py-1.5 text-xs bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white rounded-lg transition-all font-medium shadow hover:shadow-md">
                                Ver Detalhes
                            </button>
                            ${request.status === 'pending' ? `
                                <button onclick="approvePasswordRequestDirect('${request.id}')" class="px-3 py-1.5 text-xs bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white rounded-lg transition-all font-medium shadow hover:shadow-md">
                                    ✓ Aprovar
                                </button>
                                <button onclick="rejectPasswordRequestDirect('${request.id}')" class="px-3 py-1.5 text-xs bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white rounded-lg transition-all font-medium shadow hover:shadow-md">
                                    ✗ Rejeitar
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
                
                container.appendChild(card);
            });
            
            console.log(`✅ ${requests.length} solicitações exibidas com sucesso`);
        }
        
        // Substituir as funções pelas versões corrigidas
        window.displayPasswordRequests = displayPasswordRequestsFixed;
        window.viewPasswordRequestDetails = viewPasswordRequestDetailsFixed;
        
        // Funções diretas para aprovar e rejeitar (sem depender de currentPasswordRequestId)
        window.approvePasswordRequestDirect = async function(requestId) {
            if (!requestId) {
                showNotification('ID da solicitação não encontrado', 'error');
                return;
            }
            
            try {
                // Usando MySQL direto através do objeto 'db'
                const { data: { user } } = await db.auth.getUser();
                
                if (!user) {
                    showNotification('Usuário não autenticado', 'error');
                    return;
                }
                
                // Primeiro, buscar a solicitação para obter a nova senha
                const { data: request, error: fetchError } = await db
                    .from('password_requests')
                    .select('*')
                    .eq('id', requestId)
                    .single();
                
                if (fetchError || !request) {
                    showNotification('Erro ao buscar solicitação', 'error');
                    return;
                }
                
                // Verificar se a solicitação ainda está pendente
                if (request.status !== 'pending') {
                    showNotification('Esta solicitação já foi processada', 'warning');
                    return;
                }
                
                // Obter a nova senha (pode estar em new_password ou em notes)
                let newPassword = request.new_password;
                if (!newPassword && request.notes && request.notes.includes('NOVA SENHA:')) {
                    newPassword = request.notes.split('NOVA SENHA: ')[1]?.split('\n')[0];
                }
                
                if (!newPassword) {
                    showNotification('Nova senha não encontrada na solicitação', 'error');
                    return;
                }
                
                console.log('🔑 Aprovando solicitação e alterando senha...');
                console.log('User ID:', request.user_id);
                console.log('Nova senha:', newPassword);
                
                // Tentar atualizar a senha usando RPC function (alternativa ao admin)
                try {
                    const { error: updatePasswordError } = await db.rpc('update_user_password', {
                        user_id: request.user_id,
                        new_password: newPassword
                    });
                    
                    if (updatePasswordError) {
                        
                        // Método alternativo: atualizar na tabela auth.users diretamente
                        const { error: directUpdateError } = await db
                            .from('auth.users')
                            .update({ encrypted_password: newPassword })
                            .eq('id', request.user_id);
                        
                        if (directUpdateError) {
                            
                            // Fallback: apenas marcar como aprovado e notificar o usuário
                            showNotification('Solicitação aprovada. A senha será alterada pelo sistema automaticamente.', 'success');
                        } else {
                            console.log('✅ Senha atualizada via método direto');
                            showNotification('Solicitação aprovada e senha alterada com sucesso!', 'success');
                        }
                    } else {
                        console.log('✅ Senha atualizada via RPC function');
                        showNotification('Solicitação aprovada e senha alterada com sucesso!', 'success');
                    }
                } catch (rpcError) {
                    showNotification('Solicitação aprovada. A senha será alterada pelo sistema automaticamente.', 'success');
                }
                
                // Atualizar status da solicitação
                const { error: updateRequestError } = await db
                    .from('password_requests')
                    .update({
                        status: 'approved',
                        approved_at: new Date().toISOString(),
                        approved_by: user.id
                    })
                    .eq('id', requestId);
                
                if (updateRequestError) {
                    console.error('Erro ao atualizar solicitação:', updateRequestError);
                    showNotification('Senha alterada, mas erro ao atualizar solicitação', 'warning');
                    return;
                }
                
                // Garantir que o usuário está ativo após aprovação
                const { error: userError } = await db
                    .from('users')
                    .update({
                        is_active: true,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', request.user_id);
                
                if (userError) {
                    console.warn('Aviso: Não foi possível ativar o usuário:', userError);
                } else {
                    console.log('✅ Usuário ativado após aprovação da solicitação');
                }
                
                console.log('✅ Solicitação aprovada com sucesso!');
                
                // Log de auditoria
                logAuditEvent('password_request_approved', request.user_id, {
                    requestId: requestId,
                    managerId: user.id,
                    newPasswordLength: newPassword.length,
                    reason: request.reason
                });
                
                // Notificar o usuário sobre a alteração de senha e logout automático
                await notifyUserPasswordChanged(request.user_id, newPassword);
                
                // Limpar cache para forçar atualização
                clearCache();
                
                // Mover card para baixo e marcar como aprovado
                moveCardToBottom(requestId, 'approved');
                
                // Fechar modal se estiver aberto
                closePasswordRequestDetailsModal();
                
                // Remover card após 10 minutos
                setTimeout(() => {
                    removeCard(requestId);
                }, 10 * 60 * 1000); // 10 minutos
                
            } catch (error) {
                console.error('Erro ao aprovar solicitação:', error);
                showNotification('Erro ao aprovar solicitação: ' + error.message, 'error');
            }
        };
        
        window.rejectPasswordRequestDirect = async function(requestId) {
            if (!requestId) {
                showNotification('ID da solicitação não encontrado', 'error');
                return;
            }
            
            try {
                // Usando MySQL direto através do objeto 'db'
                const { data: { user } } = await db.auth.getUser();
                
                if (!user) {
                    showNotification('Usuário não autenticado', 'error');
                    return;
                }
                
                // Validar sessão do gerente
                const sessionValidation = await validateManagerSession();
                if (!sessionValidation.valid) {
                    showNotification('Sessão inválida. Faça login novamente.', 'error');
                    return;
                }
                
                // Atualizar status da solicitação
                const { error } = await db
                    .from('password_requests')
                    .update({
                        status: 'rejected',
                        rejected_at: new Date().toISOString(),
                        rejected_by: user.id
                    })
                    .eq('id', requestId);
                
                if (error) throw error;
                
                showNotification('Solicitação rejeitada com sucesso!', 'success');
                
                // Mover card para baixo e marcar como rejeitado
                moveCardToBottom(requestId, 'rejected');
                
                // Fechar modal se estiver aberto
                closePasswordRequestDetailsModal();
                
                // Remover card após 10 minutos
                setTimeout(() => {
                    removeCard(requestId);
                }, 10 * 60 * 1000); // 10 minutos
                
            } catch (error) {
                console.error('Erro ao rejeitar solicitação:', error);
                showNotification('Erro ao rejeitar solicitação: ' + error.message, 'error');
            }
        };
        
        // Função para mover card para baixo
        function moveCardToBottom(requestId, status) {
            const container = document.getElementById('passwordRequestsList');
            if (!container) return;
            
            // Encontrar o card pelo ID específico nos botões
            const cards = Array.from(container.children);
            const targetCard = cards.find(card => {
                const buttons = card.querySelectorAll('button[onclick*="' + requestId + '"]');
                return buttons.length > 0;
            });
            
            if (targetCard) {
                // Remover o card da posição atual
                targetCard.remove();
                
                // Atualizar o visual do card para mostrar o novo status
                updateCardStatus(targetCard, status);
                
                // Adicionar no final da lista
                container.appendChild(targetCard);
                
                console.log(`📋 Card movido para baixo: ${requestId} - Status: ${status}`);
            } else {
            }
        }
        
        // Função para atualizar o status visual do card
        function updateCardStatus(card, status) {
            const statusSpan = card.querySelector('span[class*="bg-"]');
            if (statusSpan) {
                const statusColors = {
                    'approved': 'bg-green-100 text-green-800 bg-green-100/20 text-green-800',
                    'rejected': 'bg-red-100 text-red-800 bg-red-100/20 text-red-800'
                };
                
                const statusText = {
                    'approved': 'APROVADA',
                    'rejected': 'REJEITADA'
                };
                
                statusSpan.className = `px-2 py-1 text-xs font-semibold rounded-full ${statusColors[status]}`;
                statusSpan.textContent = statusText[status];
            }
            
            // Remover botões de ação
            const actionButtons = card.querySelector('.flex.flex-col.space-y-2.ml-4');
            if (actionButtons) {
                actionButtons.innerHTML = '<div class="text-xs text-gray-500 ">Processada</div>';
            }
        }
        
        // Função para remover card completamente
        function removeCard(requestId) {
            const container = document.getElementById('passwordRequestsList');
            if (!container) return;
            
            const cards = Array.from(container.children);
            const targetCard = cards.find(card => {
                const buttons = card.querySelectorAll('button[onclick*="' + requestId + '"]');
                return buttons.length > 0;
            });
            
            if (targetCard) {
                targetCard.remove();
                console.log(`🗑️ Card removido após 10 minutos: ${requestId}`);
            }
        }
        
        // Funções principais para aprovar e rejeitar solicitações
        window.approvePasswordRequest = async function(requestId) {
            if (!requestId) {
                requestId = window.currentPasswordRequestId;
            }
            
            if (!requestId) {
                showNotification('ID da solicitação não encontrado', 'error');
                return;
            }
            
            try {
                // Usando MySQL direto através do objeto 'db'
                const { data: { user } } = await db.auth.getUser();
                
                if (!user) {
                    showNotification('Usuário não autenticado', 'error');
                    return;
                }
                
                // Primeiro, obter dados da solicitação para pegar o user_id
                const { data: requestData, error: requestError } = await db
                    .from('password_requests')
                    .select('user_id')
                    .eq('id', requestId)
                    .single();
                
                if (requestError) throw requestError;
                
                // Atualizar status da solicitação
                const { error } = await db
                    .from('password_requests')
                    .update({
                        status: 'approved',
                        approved_at: new Date().toISOString(),
                        approved_by: user.id
                    })
                    .eq('id', requestId);
                
                if (error) throw error;
                
                // Garantir que o usuário está ativo após aprovação
                if (requestData.user_id) {
                    const { error: userError } = await db
                        .from('users')
                        .update({
                            is_active: true,
                            updated_at: new Date().toISOString()
                        })
                        .eq('id', requestData.user_id);
                    
                    if (userError) {
                        console.warn('Aviso: Não foi possível ativar o usuário:', userError);
                    } else {
                        console.log('✅ Usuário ativado após aprovação da solicitação');
                    }
                }
                
                // Log de auditoria
                logAuditEvent('password_request_approved', requestId, {
                    managerId: user.id,
                    reason: 'manager_approval'
                });
                
                // Limpar cache para forçar atualização
                clearPasswordRequestsCache();
                
                // Recarregar lista
                await displayPasswordRequests();
                
                // Fechar modal de detalhes se estiver aberto
                const modal = document.getElementById('passwordRequestDetailsModal');
                if (modal && !modal.classList.contains('hidden')) {
                    closePasswordRequestDetailsModal();
                }
                
                showNotification('Solicitação aprovada com sucesso!', 'success');
                
            } catch (error) {
                console.error('Erro ao aprovar solicitação:', error);
                showNotification('Erro ao aprovar solicitação: ' + error.message, 'error');
            }
        };
        
        window.rejectPasswordRequest = async function(requestId) {
            if (!requestId) {
                requestId = window.currentPasswordRequestId;
            }
            
            if (!requestId) {
                showNotification('ID da solicitação não encontrado', 'error');
                return;
            }
            
            try {
                // Usando MySQL direto através do objeto 'db'
                const { data: { user } } = await db.auth.getUser();
                
                if (!user) {
                    showNotification('Usuário não autenticado', 'error');
                    return;
                }
                
                // Atualizar status da solicitação
                const { error } = await db
                    .from('password_requests')
                    .update({
                        status: 'rejected',
                        rejected_at: new Date().toISOString(),
                        rejected_by: user.id
                    })
                    .eq('id', requestId);
                
                if (error) throw error;
                
                // Log de auditoria
                logAuditEvent('password_request_rejected', requestId, {
                    managerId: user.id,
                    reason: 'manager_rejection'
                });
                
                // Limpar cache para forçar atualização
                clearPasswordRequestsCache();
                
                // Recarregar lista
                await displayPasswordRequests();
                
                // Fechar modal de detalhes se estiver aberto
                const modal = document.getElementById('passwordRequestDetailsModal');
                if (modal && !modal.classList.contains('hidden')) {
                    closePasswordRequestDetailsModal();
                }
                
                showNotification('Solicitação rejeitada com sucesso!', 'success');
                
            } catch (error) {
                console.error('Erro ao rejeitar solicitação:', error);
                showNotification('Erro ao rejeitar solicitação: ' + error.message, 'error');
            }
        };
        
        
        function togglePasswordVisibility(requestId) {
            const passwordElement = document.getElementById(`password-${requestId}`);
            const passwordHiddenElement = document.getElementById(`password-hidden-${requestId}`);
            const eyeIcon = document.getElementById(`eye-${requestId}`);
            
            if (passwordElement && passwordHiddenElement && eyeIcon) {
                if (passwordElement.style.display === 'none') {
                    passwordElement.style.display = 'block';
                    passwordHiddenElement.style.display = 'none';
                    eyeIcon.innerHTML = `
                        <path stroke-linecap="round" stroke-linejoin="round" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.878 9.878L8.464 8.464M9.878 9.878a3 3 0 00-.007 4.243m4.242-4.242L15.536 8.464M14.122 14.121a3 3 0 00-.007-4.243M14.122 14.121L15.536 15.536M14.122 14.121l-4.243 4.243m6.364-6.364L21.878 21.878m-6.364-6.364l-4.243-4.243m0 0L2.878 2.878 21.878 21.878"></path>
                    `;
                } else {
                    passwordElement.style.display = 'none';
                    passwordHiddenElement.style.display = 'block';
                    eyeIcon.innerHTML = `
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                    `;
                }
            }
        }
        
        window.togglePasswordVisibility = togglePasswordVisibility;
        
        
        
        // Logs de auditoria para o gerente
        function logAuditEvent(action, userId, details = {}) {
            const logEntry = {
                timestamp: new Date().toISOString(),
                action,
                userId,
                managerId: details.managerId || 'unknown',
                ip: details.ip || 'unknown',
                userAgent: navigator.userAgent,
                details
            };
            
            console.log(`[AUDIT] ${action} by manager:`, logEntry);
            
            // Armazenar no localStorage para persistência
            const auditLogs = JSON.parse(localStorage.getItem('manager_audit_logs') || '[]');
            auditLogs.push(logEntry);
            
            // Manter apenas os últimos 200 logs
            if (auditLogs.length > 200) {
                auditLogs.splice(0, auditLogs.length - 200);
            }
            
            localStorage.setItem('manager_audit_logs', JSON.stringify(auditLogs));
        }
        
        // Validação de sessão do gerente
        async function validateManagerSession() {
            try {
                // Usando MySQL direto através do objeto 'db'
                const { data: { user } } = await db.auth.getUser();
                
                if (!user) {
                    return { valid: false, reason: 'not_authenticated' };
                }
                
                // Verificar se o usuário ainda é um gerente ativo
                const { data: userData, error } = await db
                    .from('users')
                    .select('role, is_active, last_activity')
                    .eq('id', user.id)
                    .single();
                
                if (error || !userData) {
                    return { valid: false, reason: 'user_not_found' };
                }
                
                if (userData.role !== 'gerente') {
                    return { valid: false, reason: 'not_manager' };
                }
                
                if (!userData.is_active) {
                    return { valid: false, reason: 'inactive_user' };
                }
                
                return { valid: true, userData };
                
            } catch (error) {
                console.error('Erro ao validar sessão do gerente:', error);
                return { valid: false, reason: 'validation_error' };
            }
        }
        
        // Função para notificar usuário sobre alteração de senha
        async function notifyUserPasswordChanged(userId, newPassword) {
            try {
                // Usando MySQL direto através do objeto 'db'
                
                // Validar sessão do gerente
                const sessionValidation = await validateManagerSession();
                if (!sessionValidation.valid) {
                    console.error('Sessão do gerente inválida:', sessionValidation.reason);
                    return;
                }
                
                // Buscar dados do usuário
                const { data: userData, error: userError } = await db
                    .from('users')
                    .select('email, name')
                    .eq('id', userId)
                    .single();
                
                if (userError || !userData) {
                    console.error('Erro ao buscar dados do usuário:', userError);
                    return;
                }
                
                // Criar notificação para o usuário
                const { error: notificationError } = await db
                    .from('notifications')
                    .insert([{
                        user_id: userId,
                        type: 'password_changed',
                        title: 'Senha Alterada com Sucesso',
                        message: `Sua senha foi alterada com sucesso. Por segurança, você será deslogado automaticamente. Use a nova senha para fazer login novamente.`,
                        data: {
                            new_password: newPassword,
                            auto_logout: true,
                            logout_reason: 'password_changed'
                        },
                        is_read: false
                    }]);
                
                if (notificationError) {
                    console.error('Erro ao criar notificação:', notificationError);
                } else {
                    console.log('✅ Notificação de alteração de senha criada para o usuário');
                }
                
                // Criptografar a nova senha antes de armazenar
                const encryptedPassword = await encryptPassword(newPassword);
                
                // Enviar sinal para logout automático (usando WebSocket ou Server-Sent Events se disponível)
                // Por enquanto, vamos usar uma abordagem simples com localStorage
                const logoutSignal = {
                    userId: userId,
                    reason: 'password_changed',
                    timestamp: new Date().toISOString(),
                    newPassword: encryptedPassword,
                    encrypted: true
                };
                
                // Armazenar sinal de logout no localStorage (será verificado pelos outros usuários)
                const existingSignals = JSON.parse(localStorage.getItem('password_change_signals') || '[]');
                existingSignals.push(logoutSignal);
                localStorage.setItem('password_change_signals', JSON.stringify(existingSignals));
                
                console.log('🔔 Sinal de logout automático enviado para o usuário:', userId);
                
            } catch (error) {
                console.error('Erro ao notificar usuário sobre alteração de senha:', error);
            }
        }
        
        // Tornar função global
        window.notifyUserPasswordChanged = notifyUserPasswordChanged;
        
        // Sistema de indicadores de progresso
        function showProgressIndicator(message, progress = 0) {
            // Remover indicador existente
            const existingIndicator = document.getElementById('progressIndicator');
            if (existingIndicator) {
                existingIndicator.remove();
            }
            
            // Criar novo indicador
            const indicator = document.createElement('div');
            indicator.id = 'progressIndicator';
            indicator.className = 'fixed top-4 right-4 bg-white  rounded-xl shadow-2xl p-4 z-[99999] min-w-[300px]';
            indicator.innerHTML = `
                <div class="flex items-center space-x-3">
                    <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center">
                        <svg class="w-4 h-4 text-white animate-spin" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </div>
                    <div class="flex-1">
                        <p class="text-sm font-medium text-gray-900 ">${message}</p>
                        <div class="mt-2 bg-gray-200 bg-white rounded-full h-2">
                            <div class="bg-blue-500 h-2 rounded-full transition-all duration-300" style="width: ${progress}%"></div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(indicator);
            return indicator;
        }
        
        function updateProgressIndicator(progress, message = null) {
            const indicator = document.getElementById('progressIndicator');
            if (!indicator) return;
            
            const progressBar = indicator.querySelector('.bg-blue-500');
            const messageElement = indicator.querySelector('p');
            
            if (progressBar) {
                progressBar.style.width = `${progress}%`;
            }
            
            if (message && messageElement) {
                messageElement.textContent = message;
            }
        }
        
        function hideProgressIndicator() {
            const indicator = document.getElementById('progressIndicator');
            if (indicator) {
                indicator.remove();
            }
        }
        
        // Confirmações inteligentes baseadas no contexto
        function getConfirmationMessage(request, action) {
            const userEmail = request.users?.email || 'usuário';
            const requestAge = Math.floor((Date.now() - new Date(request.created_at)) / (1000 * 60 * 60)); // horas
            
            if (action === 'approve') {
                if (requestAge < 1) {
                    return `Aprovar solicitação de ${userEmail}? Esta solicitação foi feita há menos de 1 hora.`;
                } else if (requestAge < 24) {
                    return `Aprovar solicitação de ${userEmail}? Esta solicitação foi feita há ${requestAge} horas.`;
                } else {
                    return `Aprovar solicitação de ${userEmail}? Esta solicitação foi feita há ${Math.floor(requestAge / 24)} dias.`;
                }
            } else if (action === 'reject') {
                return `Rejeitar solicitação de ${userEmail}? Esta ação não pode ser desfeita.`;
            }
            
            return `Confirmar ${action} para ${userEmail}?`;
        }
        
        // Atalhos de teclado
        document.addEventListener('keydown', (e) => {
            // Ctrl + Enter para aprovar solicitação
            if (e.ctrlKey && e.key === 'Enter') {
                // Verificar se há uma solicitação selecionada
                if (window.currentPasswordRequestId) {
                const approveButton = document.querySelector('button[onclick*="approvePasswordRequest"]');
                if (approveButton && !approveButton.disabled) {
                    e.preventDefault();
                    approveButton.click();
                    }
                } else {
                    e.preventDefault();
                    showNotification('Nenhuma solicitação selecionada. Abra o modal de solicitações primeiro.', 'warning');
                }
            }
            
            // Ctrl + R para rejeitar solicitação
            if (e.ctrlKey && e.key === 'r') {
                // Verificar se há uma solicitação selecionada
                if (window.currentPasswordRequestId) {
                const rejectButton = document.querySelector('button[onclick*="rejectPasswordRequest"]');
                if (rejectButton && !rejectButton.disabled) {
                    e.preventDefault();
                    rejectButton.click();
                    }
                } else {
                    e.preventDefault();
                    showNotification('Nenhuma solicitação selecionada. Abra o modal de solicitações primeiro.', 'warning');
                }
            }
            
            // Escape para fechar modais
            if (e.key === 'Escape') {
                const openModal = document.querySelector('.modal:not(.hidden)');
                if (openModal) {
                    const closeButton = openModal.querySelector('button[onclick*="close"]');
                    if (closeButton) {
                        closeButton.click();
                    }
                }
            }
        });
        
        // Sistema de cache otimizado para melhorar performance
        const requestsCache = new Map();
        const CACHE_DURATION = 10 * 60 * 1000; // 10 minutos em vez de 5
        let lastCacheUpdate = 0;
        const MIN_CACHE_UPDATE_INTERVAL = 2 * 60 * 1000; // 2 minutos mínimo entre atualizações
        
        function getCachedRequests() {
            const cached = requestsCache.get('password_requests');
            if (cached && Date.now() - cached.timestamp < CACHE_DURATION) {
                return cached.data;
            }
            return null;
        }
        
        function setCachedRequests(data) {
            const now = Date.now();
            // Evitar atualizações muito frequentes do cache
            if (now - lastCacheUpdate < MIN_CACHE_UPDATE_INTERVAL) {
                return;
            }
            lastCacheUpdate = now;
            
            requestsCache.set('password_requests', {
                data,
                timestamp: now
            });
        }
        
        function clearCache() {
            requestsCache.clear();
            lastCacheUpdate = 0;
        }
        
        // Função otimizada para carregar solicitações com cache
        let isLoadingRequests = false;
        
        async function loadPasswordRequestsWithCache(forceRefresh = false) {
            console.log('🔄 Iniciando carregamento de solicitações...', forceRefresh ? '(forçando refresh)' : '');
            
            // Evitar múltiplas chamadas simultâneas
            if (isLoadingRequests) {
                console.log('⏳ Carregamento já em andamento, aguardando...');
                return;
            }
            
            // Verificar cache primeiro (a menos que seja forçado)
            if (!forceRefresh) {
                const cached = getCachedRequests();
                if (cached) {
                    console.log('📦 Carregando solicitações do cache:', cached.length, 'solicitações');
                    displayPasswordRequests(cached);
                    return;
                }
            } else {
                console.log('🔄 Forçando refresh - ignorando cache');
                clearCache();
            }
            
            console.log('🌐 Buscando dados do servidor...');
            isLoadingRequests = true;
            
            try {
                // Usando MySQL direto através do objeto 'db'
                const { data: { user } } = await db.auth.getUser();
                
                if (!user) {
                    console.error('❌ Usuário não autenticado');
                    showNotification('Usuário não autenticado', 'error');
                    return;
                }
                
                console.log('👤 Usuário autenticado:', user.id);
                
                // Sistema Lagoa Do Mato
                const { data: userData, error: userError } = await db
                    .from('users')
                    .select('id')
                    .eq('id', user.id)
                    .single();
                
                if (userError || !userData) {
                    console.error('❌ Erro ao buscar dados da fazenda:', userError);
                    showNotification('Erro ao buscar dados da fazenda', 'error');
                    return;
                }
                
                console.log('🏡 Fazenda: Lagoa Do Mato');
                
                // Buscar solicitações de senha da fazenda (abordagem corrigida)
                // Primeiro, buscar usuários da fazenda
                const { data: farmUsers, error: usersError } = await db
                    .from('users')
                    .select('id, name, email, role, profile_photo_url')
                    .eq('farm_id', 1);
                
                if (usersError) {
                    console.error('❌ Erro ao buscar usuários da fazenda:', usersError);
                    showNotification('Erro ao buscar usuários da fazenda', 'error');
                    return;
                }
                
                if (!farmUsers || farmUsers.length === 0) {
                    console.log('📝 Nenhum usuário encontrado na fazenda');
                    displayPasswordRequests([]);
                    return;
                }
                
                const userIds = farmUsers.map(user => user.id);
                
                // Depois, buscar solicitações desses usuários
                const { data: requests, error } = await db
                    .from('password_requests')
                    .select('*')
                    .in('user_id', userIds)
                    .order('created_at', { ascending: false });
                
                if (error) {
                    console.error('❌ Erro ao buscar solicitações:', error);
                    showNotification('Erro ao carregar solicitações', 'error');
                    return;
                }
                
                console.log('✅ Solicitações carregadas:', requests?.length || 0, 'solicitações');
                
                // Combinar dados das solicitações com dados dos usuários
                const requestsWithUsers = (requests || []).map(request => {
                    const user = farmUsers.find(u => u.id === request.user_id);
                    return {
                        ...request,
                        users: user || { name: 'Usuário não encontrado', email: '', role: 'unknown' }
                    };
                });
                
                console.log('✅ Solicitações combinadas com usuários:', requestsWithUsers.length);
                
                // Armazenar no cache
                setCachedRequests(requestsWithUsers);
                
                displayPasswordRequests(requestsWithUsers);
                
            } catch (error) {
                console.error('❌ Erro geral ao carregar solicitações:', error);
                showNotification('Erro ao carregar solicitações', 'error');
            } finally {
                isLoadingRequests = false;
            }
        }
        
        // Substituir a função original
        window.loadPasswordRequests = loadPasswordRequestsWithCache;
        
        // Função para limpar todos os intervalos e timers
        function cleanupAllIntervals() {
            stopBlockWatcher();
            clearCache();
            
            // Limpar outros intervalos se existirem
            const intervals = [
                'blockWatcherInterval',
                'logoutCheckInterval',
                'requestRateLimitInterval'
            ];
            
            intervals.forEach(intervalName => {
                if (window[intervalName]) {
                    clearInterval(window[intervalName]);
                    window[intervalName] = null;
                }
            });
        }
        
        // Limpar intervalos quando a página for descarregada
        window.addEventListener('beforeunload', cleanupAllIntervals);
        window.addEventListener('pagehide', cleanupAllIntervals);
        
        // Tornar função global para debug
        window.cleanupAllIntervals = cleanupAllIntervals;
        
        // Função de debug para testar o carregamento
        window.debugPasswordRequests = async function() {
            console.log('🔍 Debug: Testando carregamento de solicitações...');
            console.log('🔍 Modal existe:', !!document.getElementById('passwordRequestsModal'));
            console.log('🔍 Lista existe:', !!document.getElementById('passwordRequestsList'));
            console.log('🔍 Empty state existe:', !!document.getElementById('emptyPasswordRequests'));
            
            // Testar carregamento direto com refresh forçado
            await loadPasswordRequestsWithCache(true);
        };
        
        // Função de debug simples para testar exibição
        window.testDisplayRequests = function() {
            console.log('🧪 Testando exibição de solicitações...');
            const testRequests = [
                {
                    id: 'test-1',
                    status: 'pending',
                    users: { name: 'Teste Usuário', email: 'teste@teste.com', role: 'funcionario' },
                    created_at: new Date().toISOString(),
                    reason: 'Teste de exibição'
                }
            ];
            
            displayPasswordRequests(testRequests);
        };
        
        // Função para forçar refresh das solicitações
        window.refreshPasswordRequests = function() {
            loadPasswordRequestsWithCache(true);
        };
        
        // Sistema de criptografia simples para senhas
        async function encryptPassword(password) {
            try {
                // Usar Web Crypto API se disponível
                if (window.crypto && window.crypto.subtle) {
                    const encoder = new TextEncoder();
                    const data = encoder.encode(password);
                    const hashBuffer = await window.crypto.subtle.digest('SHA-256', data);
                    const hashArray = Array.from(new Uint8Array(hashBuffer));
                    const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
                    return `enc_${hashHex}`;
                } else {
                    // Fallback para navegadores mais antigos
                    return `enc_${btoa(password)}`;
                }
            } catch (error) {
                console.error('Erro ao criptografar senha:', error);
                // Fallback simples
                return `enc_${btoa(password)}`;
            }
        }
        
        async function decryptPassword(encryptedPassword) {
            try {
                if (encryptedPassword.startsWith('enc_')) {
                    const encrypted = encryptedPassword.substring(4);
                    // Para SHA-256, não podemos descriptografar, então retornamos o hash
                    // Em um sistema real, você usaria criptografia simétrica
                    return encrypted;
                }
                return encryptedPassword;
            } catch (error) {
                console.error('Erro ao descriptografar senha:', error);
                return encryptedPassword;
            }
        }
        
        // Tornar funções globais
        window.encryptPassword = encryptPassword;
        window.decryptPassword = decryptPassword;
        
        // ==================== SISTEMA PWA ====================
        
        let deferredPrompt;
        const CURRENT_VERSION = '2.0.1';
        
        // Capturar o evento beforeinstallprompt
        window.addEventListener('beforeinstallprompt', (e) => {
            console.log('PWA pode ser instalada');
            e.preventDefault();
            deferredPrompt = e;
            checkPWAStatus();
        });
        
        // Função para verificar status da PWA
        async function checkPWAStatus() {
            const isInstalled = await isPWAInstalled();
            const installedVersion = localStorage.getItem('pwa_version');
            
            console.log('PWA Status:', { 
                isInstalled, 
                installedVersion, 
                currentVersion: CURRENT_VERSION,
                displayMode: window.matchMedia('(display-mode: standalone)').matches
            });
            
            if (isInstalled) {
                showUninstallButton();
            } else if (deferredPrompt) {
                showInstallButton();
            }
        }
        
        // Verificar se PWA está instalada
        async function isPWAInstalled() {
            const isStandalone = window.matchMedia('(display-mode: standalone)').matches;
            const installData = localStorage.getItem('pwa_version');
            const hasValidInstallData = installData && JSON.parse(installData).version === CURRENT_VERSION;
            
            return isStandalone || hasValidInstallData;
        }
        
        // Função para instalar a PWA
        async function installPWA() {
            if (!deferredPrompt) {
                showNotification('App já está instalado ou não pode ser instalado', 'error');
                return;
            }
            
            try {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                
                if (outcome === 'accepted') {
                    console.log('Usuário aceitou a instalação');
                    
                    setTimeout(async () => {
                        const isReallyInstalled = await checkRealInstallation();
                        
                        if (isReallyInstalled) {
                            showNotification('App instalado com sucesso!', 'success');
                            
                            const installData = {
                                version: CURRENT_VERSION,
                                timestamp: Date.now(),
                                userInfo: getCurrentUserInfo(),
                                url: window.location.href
                            };
                            localStorage.setItem('pwa_version', JSON.stringify(installData));
                            
                            showUninstallButton();
                        } else {
                            showNotification('Erro: App não foi instalado corretamente', 'error');
                        }
                    }, 2000);
                    
                } else {
                    showNotification('Instalação cancelada', 'info');
                }
                
            } catch (error) {
                console.error('Erro durante instalação:', error);
                showNotification('Erro durante instalação: ' + error.message, 'error');
            }
            
            deferredPrompt = null;
        }
        
        // Verificar se realmente instalou
        async function checkRealInstallation() {
            const isStandalone = window.matchMedia('(display-mode: standalone)').matches;
            const hasServiceWorker = 'serviceWorker' in navigator && 
                await navigator.serviceWorker.getRegistration() !== null;
            
            return isStandalone;
        }
        
        // Obter informações do usuário atual
        function getCurrentUserInfo() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
            return {
                role: 'gerente',
                userId: currentUser?.id || 'unknown',
                userName: currentUser?.name || 'unknown',
                farmId: 1, // Lagoa Do Mato
                timestamp: Date.now()
            };
        }
        
        // Função para desinstalar a PWA
        async function uninstallPWA() {
            if (confirm('Tem certeza que deseja desinstalar o app?')) {
                try {
                    localStorage.removeItem('pwa_version');
                    
                    if ('serviceWorker' in navigator) {
                        const registrations = await navigator.serviceWorker.getRegistrations();
                        for (let registration of registrations) {
                            await registration.unregister();
                        }
                    }
                    
                    showNotification('App desinstalado com sucesso!', 'success');
                    showInstallButton();
                    
                } catch (error) {
                    console.error('Erro ao desinstalar:', error);
                    showNotification('Erro ao desinstalar app', 'error');
                }
            }
        }
        
        // Funções para mostrar/esconder botões
        function showInstallButton() {
            document.getElementById('pwaInstallButton')?.classList.remove('hidden');
            document.getElementById('pwaUninstallButton')?.classList.add('hidden');
        }
        
        function showUninstallButton() {
            document.getElementById('pwaInstallButton')?.classList.add('hidden');
            document.getElementById('pwaUninstallButton')?.classList.remove('hidden');
        }
        
        // Detectar se o app já está instalado
        window.addEventListener('appinstalled', () => {
            console.log('PWA foi instalada');
            showUninstallButton();
        });
        
        // Service Worker removido - sistema MySQL não precisa
        console.log('ℹ️ Service Worker desabilitado - sistema MySQL');

        // ==================== DETECÇÃO DE CONEXÃO COM INTERNET ====================
        let wasOffline = false;
        
        // Detectar quando volta a conexão
        window.addEventListener('online', () => {
            console.log('🌐 Conexão com internet restaurada');
            if (wasOffline) {
                showServerConnectionLoading();
                
                // Simular sincronização (você pode adicionar lógica real aqui)
                setTimeout(() => {
                    hideServerConnectionLoading();
                    showNotification('Conexão restaurada! Dados sincronizados.', 'success');
                }, 3000);
            }
            wasOffline = false;
        });
        
        // Detectar quando perde a conexão
        window.addEventListener('offline', () => {
            console.log('📴 Conexão com internet perdida');
            wasOffline = true;
            showNotification('Conexão perdida. Trabalhando offline...', 'warning');
        });
        
        // ==================== FUNÇÕES DO MODAL PWA ====================
        
        // Abrir modal PWA
        function openPWAModal() {
            console.log('🔧 DEBUG: openPWAModal chamada');
            const modal = document.getElementById('pwaModal');
            console.log('🔧 DEBUG: Modal encontrado:', modal);
            modal.classList.remove('hidden');
            updatePWAStatusInModal();
            console.log('🔧 DEBUG: Modal PWA aberto com sucesso');
        }
        
        // Fechar modal PWA
        function closePWAModal() {
            const modal = document.getElementById('pwaModal');
            modal.classList.add('hidden');
        }
        
        // Atualizar status PWA no modal
        async function updatePWAStatusInModal() {
            const statusDiv = document.getElementById('pwaStatus');
            const installButton = document.getElementById('modalInstallButton');
            const uninstallButton = document.getElementById('modalUninstallButton');
            
            const isInstalled = await isPWAInstalled();
            const installData = localStorage.getItem('pwa_version');
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            
            if (isInstalled) {
                statusDiv.innerHTML = `
                    <div class="flex items-center space-x-3 p-4 bg-green-100 dark:bg-green-900/20 rounded-xl">
                        <div class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"></path>
                            </svg>
                        </div>
                        <div>
                            <h4 class="font-semibold text-green-800 dark:text-green-200">App Instalado</h4>
                            <p class="text-green-600 dark:text-green-300 text-sm">LacTech está instalado e pronto para uso</p>
                        </div>
                    </div>
                `;
                installButton.classList.add('hidden');
                uninstallButton.classList.remove('hidden');
            } else if (deferredPrompt) {
                statusDiv.innerHTML = `
                    <div class="flex items-center space-x-3 p-4 bg-blue-100 dark:bg-blue-900/20 rounded-xl">
                        <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15"></path>
                            </svg>
                        </div>
                        <div>
                            <h4 class="font-semibold text-blue-800 dark:text-blue-200">Pronto para Instalar</h4>
                            <p class="text-blue-600 dark:text-blue-300 text-sm">Clique em "Instalar App" para adicionar à tela inicial</p>
                        </div>
                    </div>
                `;
                installButton.classList.remove('hidden');
                uninstallButton.classList.add('hidden');
            } else {
                statusDiv.innerHTML = `
                    <div class="flex items-center space-x-3 p-4 bg-gray-100 dark:bg-gray-800 rounded-xl">
                        <div class="w-8 h-8 bg-gray-500 rounded-full flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <div>
                            <h4 class="font-semibold text-gray-800 dark:text-gray-200">Instalação Indisponível</h4>
                            <p class="text-gray-600 dark:text-gray-300 text-sm">Use o navegador para instalar o app</p>
                        </div>
                    </div>
                `;
                installButton.classList.add('hidden');
                uninstallButton.classList.add('hidden');
            }
        }
        
        async function installPWAFromModal() {
            await installPWA();
            setTimeout(() => {
                updatePWAStatusInModal();
            }, 3000);
        }
        
        async function uninstallPWAFromModal() {
            await uninstallPWA();
            setTimeout(() => {
                updatePWAStatusInModal();
            }, 1000);
        }
        
        window.installPWA = installPWA;
        window.uninstallPWA = uninstallPWA;
        window.openPWAModal = openPWAModal;
        window.closePWAModal = closePWAModal;
        window.installPWAFromModal = installPWAFromModal;
        window.uninstallPWAFromModal = uninstallPWAFromModal;
        
        async function loadProductionDataWithCache(farmId, dateRange = 'week') {
            if (!window.offlineManager) {
                console.error('Offline Manager não disponível');
                return null;
            }
            
            const cacheKey = `production_${farmId}_${dateRange}`;
            
            const fetchOnlineData = async () => {
                // Usando MySQL direto através do objeto 'db'
                let query = db
                    .from('volume_records')
                    .select('volume_liters, production_date, milking_type')
                    .eq('farm_id', 1);
                
                // Aplicar filtro de data
                if (dateRange === 'today') {
                    const today = new Date().toISOString().split('T')[0];
                    query = query.eq('production_date', today);
                } else if (dateRange === 'week') {
                    const weekAgo = new Date();
                    weekAgo.setDate(weekAgo.getDate() - 7);
                    query = query.gte('production_date', weekAgo.toISOString().split('T')[0]);
                } else if (dateRange === 'month') {
                    const monthAgo = new Date();
                    monthAgo.setMonth(monthAgo.getMonth() - 1);
                    query = query.gte('production_date', monthAgo.toISOString().split('T')[0]);
                }
                
                const { data, error } = await query.order('production_date', { ascending: true });
                
                if (error) throw error;
                return data;
            };
            
            // Usar Offline Manager para obter dados
            return await window.offlineManager.getData(cacheKey, fetchOnlineData);
        }
        
        // Função para salvar dados de produção com sincronização
        async function saveProductionDataWithSync(volumeData) {
            if (!window.offlineManager) {
                console.error('Offline Manager não disponível');
                return false;
            }
            
            // Salvar usando Offline Manager
            return await window.offlineManager.saveData('volume_record', volumeData, true);
        }
        
        // Função para carregar dados do usuário com cache
        async function loadUserDataWithCache() {
            if (!window.offlineManager) {
                console.error('Offline Manager não disponível');
                return null;
            }
            
            const cacheKey = 'user_data';
            
            const fetchOnlineData = async () => {
                // Usando MySQL direto através do objeto 'db'
                const { data: { user } } = await db.auth.getUser();
                
                if (!user) throw new Error('Usuário não autenticado');
                
                const { data: userData, error } = await db
                    .from('users')
                    .select('*')
                    .eq('id', user.id)
                    .single();
                
                if (error) throw error;
                return userData;
            };
            
            return await window.offlineManager.getData(cacheKey, fetchOnlineData);
        }
        
        // Função para carregar dados da fazenda com cache
        async function loadFarmDataWithCache(farmId) {
            if (!window.offlineManager) {
                console.error('Offline Manager não disponível');
                return null;
            }
            
            const cacheKey = `farm_data_${farmId}`;
            
            const fetchOnlineData = async () => {
                // Usando MySQL direto através do objeto 'db'
                const { data: farmData, error } = await db
                    .from('farms')
                    .select('*')
                    .eq('id', farmId)
                    .single();
                
                if (error) throw error;
                return farmData;
            };
            
            return await window.offlineManager.getData(cacheKey, fetchOnlineData);
        }
        
        // Service Worker listener removido - sistema MySQL
        console.log('ℹ️ Service Worker listener desabilitado - sistema MySQL');
        
        // Tornar funções offline globais
        window.loadProductionDataWithCache = loadProductionDataWithCache;
        window.saveProductionDataWithSync = saveProductionDataWithSync;
        window.loadUserDataWithCache = loadUserDataWithCache;
        window.loadFarmDataWithCache = loadFarmDataWithCache;
        
        
    
        // ==================== CONTINUAÇÃO - INICIALIZAÇÃO ====================
        document.addEventListener('DOMContentLoaded', function() {
        // Inicializar notificações nativas
        if (window.nativeNotifications) {
            window.nativeNotifications.init();
            
            // Solicitar permissão de notificações automaticamente
            setTimeout(() => {
                window.nativeNotifications.requestNotificationPermission();
            }, 3000);
        }

        // Inicializar sistema de sincronização offline
        if (window.offlineSyncManager) {
            console.log('🔄 Sistema de sincronização offline inicializado');
        }

        // Funções para atualização em tempo real dos gráficos
        window.updateVolumeCharts = async function() {
            try {
                await loadWeeklyVolumeChart();
                await loadDailyVolumeChart();
                await loadDashboardWeeklyChart();
                console.log('📊 Gráficos de volume atualizados');
            } catch (error) {
                console.error('❌ Erro ao atualizar gráficos de volume:', error);
            }
        };

        window.updateVolumeStats = async function() {
            try {
                await loadVolumeData();
                console.log('📈 Estatísticas de volume atualizadas');
            } catch (error) {
                console.error('❌ Erro ao atualizar estatísticas de volume:', error);
            }
        };

        window.updateVolumeRecordsList = async function() {
            try {
                console.log('🔄 Atualizando lista de registros de volume...');
                
                // Usando MySQL direto através do objeto 'db'
                const { data: { user } } = await db.auth.getUser();
                if (!user) return;

                const { data: userData } = await db
                    .from('users')
                    .select('id')
                    .eq('id', user.id)
                    .single();

                if (!userData) return;

                // Buscar registros do servidor
                const { data: volumeRecords, error } = await db
                    .from('volume_records')
                    .select('*')
                    .eq('farm_id', 1)
                    .order('production_date', { ascending: false })
                    .limit(10);

                if (error) {
                    console.error('❌ Erro ao buscar registros:', error);
                    return;
                }

                // Adicionar registros locais
                let allRecords = [...(volumeRecords || [])];
                if (window.offlineSyncManager) {
                    const localRecords = window.offlineSyncManager.getLocalData('volume');
                    const localFiltered = localRecords.filter(record => 
                        record.farm_id === 1 && !record.synced
                    );
                    allRecords = [...localFiltered, ...allRecords];
                }

                // Atualizar interface
                const tbody = document.getElementById('volumeRecords');
                if (tbody) {
                    if (allRecords.length === 0) {
                        tbody.innerHTML = `
                            <tr>
                                <td colspan="5" class="text-center py-8 text-gray-500">
                                    Nenhum registro encontrado
                                </td>
                            </tr>
                        `;
                    } else {
                        tbody.innerHTML = allRecords.map(record => `
                            <tr class="border-b border-gray-100 hover:bg-gray-50">
                                <td class="py-3 px-4 text-sm text-gray-900">
                                    ${new Date(record.production_date + 'T00:00:00').toLocaleDateString('pt-BR')}
                                </td>
                                <td class="py-3 px-4 text-sm text-gray-900 font-medium">
                                    ${record.volume_liters}L
                                </td>
                                <td class="py-3 px-4 text-sm text-gray-600">
                                    ${record.users?.name || record.user_name || 'N/A'}
                                </td>
                                <td class="py-3 px-4 text-sm text-gray-600">
                                    ${record.notes || '-'}
                                </td>
                                <td class="py-3 px-4 text-sm">
                                    <button onclick="deleteVolumeRecord('${record.id}');" class="text-red-600 hover:text-red-800 font-medium">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                        </svg>
                                    </button>
                                </td>
                            </tr>
                        `).join('');
                    }
                }

                console.log(`✅ Lista de registros atualizada: ${allRecords.length} registros`);
            } catch (error) {
                console.error('❌ Erro ao atualizar lista de registros:', error);
            }
        };

        window.updateDashboardStats = async function() {
            try {
                console.log('🔄 Atualizando estatísticas do dashboard...');
                
                // Atualizar volume de hoje
                await loadVolumeData();
                
                // Atualizar gráfico semanal do dashboard
                await loadDashboardWeeklyChart();
                
                // Atualizar estatísticas gerais
                await loadDashboardData();
                
                console.log('✅ Estatísticas do dashboard atualizadas');
            } catch (error) {
                console.error('❌ Erro ao atualizar estatísticas do dashboard:', error);
            }
        };

        // Função para forçar atualização completa dos registros de volume
        window.forceRefreshVolumeRecords = async function() {
            try {
                console.log('🔄 Forçando atualização completa dos registros de volume...');
                
                // Limpar cache
                if (CacheManager) {
                    CacheManager.clearCache();
                    CacheManager.forceRefresh = true;
                }
                
                // Recarregar dados
                await loadVolumeRecords();
                await updateVolumeRecordsList();
                
                console.log('✅ Registros de volume atualizados com sucesso');
            } catch (error) {
                console.error('❌ Erro ao forçar atualização dos registros:', error);
            }
        };

        // Função para corrigir registros existentes sem nome do funcionário
        window.fixVolumeRecordsEmployeeNames = async function() {
            try {
                console.log('🔧 Corrigindo nomes de funcionários nos registros existentes...');
                
                // Usando MySQL direto através do objeto 'db'
                const { data: { user } } = await db.auth.getUser();
                if (!user) return;

                const { data: userData } = await db
                    .from('users')
                    .select('id')
                    .eq('id', user.id)
                    .single();

                if (!userData) return;

                // Buscar registros para verificar se têm nomes de funcionários
                const { data: recordsWithoutName, error: fetchError } = await db
                    .from('volume_records')
                    .select(`
                        id,
                        user_id,
                        users(name)
                    `)
                    .eq('farm_id', 1)
                    .limit(10);

                if (fetchError) {
                    console.error('❌ Erro ao buscar registros:', fetchError);
                    return;
                }

                if (recordsWithoutName && recordsWithoutName.length > 0) {
                    console.log(`✅ Encontrados ${recordsWithoutName.length} registros com dados de funcionários`);
                    console.log('ℹ️ Os nomes dos funcionários são obtidos automaticamente via relacionamento com a tabela users');
                } else {
                    console.log('ℹ️ Nenhum registro encontrado para verificação');
                }
                
            } catch (error) {
                console.error('❌ Erro ao corrigir nomes de funcionários:', error);
            }
        };
        });

        // ==================== RELATÓRIOS MODAL ====================
        function openReportsModal() {
            const modal = document.getElementById('reportsModal');
            if (modal) {
                modal.classList.remove('hidden');
                modal.style.display = 'flex';
                document.body.style.overflow = 'hidden';
            }
        }

        function closeReportsModal() {
            const modal = document.getElementById('reportsModal');
            if (modal) {
                modal.classList.add('hidden');
                modal.style.display = 'none';
                document.body.style.overflow = 'auto';
            }
        }

        // Funções de geração de relatórios
        async function generateVolumeReport() {
            try {
                showCustomLoading('Gerando relatório de volume...', 'generate');
                
                // Usando MySQL direto através do objeto 'db'
                const { data: { user } } = await db.auth.getUser();
                
                if (!user) {
                    throw new Error('Usuário não autenticado');
                }

                // Sistema Lagoa Do Mato
                const { data: userData } = await db
                    .from('users')
                    .select('id')
                    .eq('id', user.id)
                    .single();

                if (!userData) {
                    throw new Error('Farm ID não encontrado');
                }

                // Buscar dados de volume
                const { data: volumeData, error } = await db
                            .from('volume_records')
                    .select('*')
                    .eq('farm_id', 1)
                    .order('production_date', { ascending: false })
                    .limit(100);

                if (error) {
                    throw error;
                }

                // Gerar PDF
                await generateVolumePDF(volumeData || []);
                
                hideCustomLoading();
                showNotification('Relatório de volume gerado com sucesso!', 'success');
                
            } catch (error) {
                hideCustomLoading();
                console.error('Erro ao gerar relatório de volume:', error);
                showNotification('Erro ao gerar relatório: ' + error.message, 'error');
            }
        }

        async function generateQualityReport() {
            try {
                showCustomLoading('Gerando relatório de qualidade...', 'generate');
                
                // Usando MySQL direto através do objeto 'db'
                const { data: { user } } = await db.auth.getUser();
                
                if (!user) {
                    throw new Error('Usuário não autenticado');
                }

                // Sistema Lagoa Do Mato
                const { data: userData } = await db
                    .from('users')
                    .select('id')
                    .eq('id', user.id)
                    .single();

                if (!userData) {
                    throw new Error('Farm ID não encontrado');
                }

                // Buscar dados de qualidade
                const { data: qualityData, error } = await db
                    .from('quality_tests')
                    .select('*')
                    .eq('farm_id', 1)
                    .order('test_date', { ascending: false })
                    .limit(100);

                if (error) {
                    throw error;
                }

                // Gerar PDF
                await generateQualityPDF(qualityData || []);
                
                hideCustomLoading();
                showNotification('Relatório de qualidade gerado com sucesso!', 'success');
                
            } catch (error) {
                hideCustomLoading();
                console.error('Erro ao gerar relatório de qualidade:', error);
                showNotification('Erro ao gerar relatório: ' + error.message, 'error');
            }
        }

        async function generateFinancialReport() {
            try {
                showCustomLoading('Gerando relatório financeiro...', 'generate');
                
                // Usando MySQL direto através do objeto 'db'
                const { data: { user } } = await db.auth.getUser();
                
                if (!user) {
                    throw new Error('Usuário não autenticado');
                }

                // Sistema Lagoa Do Mato
                const { data: userData } = await db
                    .from('users')
                    .select('id')
                    .eq('id', user.id)
                    .single();

                if (!userData) {
                    throw new Error('Farm ID não encontrado');
                }

                // Buscar dados financeiros
                const { data: financialData, error } = await db
                    .from('financial_records')
                    .select('*')
                    .eq('farm_id', 1)
                    .order('record_date', { ascending: false })
                    .limit(100);

                if (error) {
                    throw error;
                }

                // Gerar PDF
                await generatePaymentsPDF(financialData || []);
                
                hideCustomLoading();
                showNotification('Relatório financeiro gerado com sucesso!', 'success');
                
            } catch (error) {
                hideCustomLoading();
                console.error('Erro ao gerar relatório financeiro:', error);
                showNotification('Erro ao gerar relatório: ' + error.message, 'error');
            }
        }


        // ==================== RELATÓRIO PERSONALIZADO ====================
        function openCustomReportModal() {
            const modal = document.getElementById('customReportModal');
            if (modal) {
                modal.classList.remove('hidden');
                modal.style.display = 'flex';
                document.body.style.overflow = 'hidden';
                loadCustomReportSettings();
            }
        }

        function closeCustomReportModal() {
            const modal = document.getElementById('customReportModal');
            if (modal) {
                modal.classList.add('hidden');
                modal.style.display = 'none';
                document.body.style.overflow = 'auto';
            }
        }

        async function loadCustomReportSettings() {
            try {
                // Usando MySQL direto através do objeto 'db'
                const { data: { user } } = await db.auth.getUser();
                
                if (!user) return;

                // Buscar dados do usuário
                const { data: userData, error: userError } = await db
                    .from('users')
                    .select('report_farm_name, report_farm_logo_base64')
                    .eq('id', user.id)
                    .single();

                if (userError) {
                    console.error('Erro ao buscar dados do usuário:', userError);
                    return;
                }

                if (userData) {
                    // Usar o nome personalizado salvo ou buscar o nome da fazenda
                    let farmName = userData.report_farm_name;
                    
                    if (!farmName) {
                        // Buscar nome da fazenda se não tiver personalizado
                        const { data: farmData, error: farmError } = await db
                            .from('farms')
                            .select('name')
                            .eq('id', 1)
                            .single();
                        
                        if (!farmError && farmData) {
                            farmName = farmData.name;
                        }
                    }
                    
                    // Fallback para nome padrão
                    if (!farmName) {
                        farmName = await getFarmName() || 'Minha Fazenda';
                    }
                    
                    document.getElementById('customReportFarmName').value = farmName;
                    
                    if (userData.report_farm_logo_base64) {
                        updateCustomReportLogoPreview(userData.report_farm_logo_base64);
                    }
                }
            } catch (error) {
                console.error('Erro ao carregar configurações:', error);
            }
        }

        async function handleCustomReportLogoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.type.startsWith('image/')) {
                showNotification('Por favor, selecione um arquivo de imagem válido', 'error');
                return;
            }
            
            if (file.size > 2 * 1024 * 1024) {
                showNotification('A imagem deve ter no máximo 2MB', 'error');
                return;
            }
            
            try {
                const base64 = await fileToBase64(file);
                updateCustomReportLogoPreview(base64);
                showNotification('Logo carregada com sucesso!', 'success');
            } catch (error) {
                console.error('Erro ao processar logo:', error);
                showNotification('Erro ao processar a imagem', 'error');
            }
        }

        function updateCustomReportLogoPreview(base64Logo) {
            const preview = document.getElementById('customReportLogoPreview');
            const placeholder = document.getElementById('customReportLogoPlaceholder');
            const image = document.getElementById('customReportLogoImage');
            const removeBtn = document.getElementById('removeCustomReportLogo');
            
            if (base64Logo) {
                image.src = base64Logo;
                preview.classList.remove('hidden');
                placeholder.classList.add('hidden');
                removeBtn.classList.remove('hidden');
                } else {
                preview.classList.add('hidden');
                placeholder.classList.remove('hidden');
                removeBtn.classList.add('hidden');
            }
        }

        function removeCustomReportLogo() {
            updateCustomReportLogoPreview(null);
            document.getElementById('customReportLogoUpload').value = '';
            showNotification('Logo removida!', 'info');
        }

        async function saveCustomReportSettings() {
            try {
                showCustomLoading('Salvando configurações...', 'save');
                
                // Usando MySQL direto através do objeto 'db'
                const { data: { user } } = await db.auth.getUser();
                
                if (!user) {
                    throw new Error('Usuário não autenticado');
                }

                const farmName = document.getElementById('customReportFarmName').value;
                const logoImage = document.getElementById('customReportLogoImage');
                const farmLogo = logoImage.src.includes('data:image') ? logoImage.src : null;

                // Atualizar diretamente na tabela users
                const { error } = await db
                    .from('users')
                    .update({
                        report_farm_name: farmName,
                        report_farm_logo_base64: farmLogo
                    })
                    .eq('id', user.id);

                if (error) {
                    throw error;
                }

                // Atualizar configurações globais
                if (window.reportSettings) {
                    window.reportSettings.farmName = farmName;
                    window.reportSettings.farmLogo = farmLogo;
                }

                hideCustomLoading();
                showNotification('Configurações salvas com sucesso!', 'success');
                closeCustomReportModal();
                
            } catch (error) {
                hideCustomLoading();
                console.error('Erro ao salvar configurações:', error);
                showNotification('Erro ao salvar configurações: ' + error.message, 'error');
            }
        }

        async function generateCustomReport() {
            try {
                showCustomLoading('Gerando relatório personalizado...', 'generate');
                
                // Usando MySQL direto através do objeto 'db'
                const { data: { user } } = await db.auth.getUser();
                
                if (!user) {
                    throw new Error('Usuário não autenticado');
                }

                // Sistema Lagoa Do Mato
                const { data: userData } = await db
                    .from('users')
                    .select('id')
                    .eq('id', user.id)
                    .single();

                if (!userData) {
                    throw new Error('Farm ID não encontrado');
                }

                // Obter configurações do modal
                const farmName = document.getElementById('customReportFarmName').value;
                const logoImage = document.getElementById('customReportLogoImage');
                const farmLogo = logoImage.src.includes('data:image') ? logoImage.src : null;

                // Configurar window.reportSettings com as configurações do modal
                if (!window.reportSettings) {
                    window.reportSettings = {};
                }
                window.reportSettings.farmName = farmName;
                window.reportSettings.farmLogo = farmLogo;

                console.log('Configurações do relatório personalizado:');
                console.log('- Nome da fazenda:', farmName);
                console.log('- Logo da fazenda:', farmLogo ? 'Carregada' : 'Não carregada');

                // Buscar dados de volume (relatório personalizado combina volume + qualidade)
                const { data: volumeData, error: volumeError } = await db
                    .from('volume_records')
                    .select('*')
                    .eq('farm_id', 1)
                    .order('production_date', { ascending: false })
                    .limit(50);

                if (volumeError) {
                    throw volumeError;
                }

                // Gerar PDF personalizado (usando função de volume como base)
                await generateVolumePDF(volumeData || []);
                
                hideCustomLoading();
                showNotification('Relatório personalizado gerado com sucesso!', 'success');
                closeCustomReportModal();
                
            } catch (error) {
                hideCustomLoading();
                console.error('Erro ao gerar relatório personalizado:', error);
                showNotification('Erro ao gerar relatório: ' + error.message, 'error');
            }
        }

        // ==================== LOADING PERSONALIZADO ====================
        function showCustomLoading(message, type) {
            const loadingModal = document.getElementById('customLoadingModal');
            const loadingMessage = document.getElementById('customLoadingMessage');
            const loadingIcon = document.getElementById('customLoadingIcon');
            
            if (loadingModal && loadingMessage && loadingIcon) {
                loadingMessage.textContent = message;
                
                // Definir ícone baseado no tipo
                if (type === 'save') {
                    loadingIcon.innerHTML = `
                        <svg class="w-8 h-8 text-indigo-600 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                    `;
                } else if (type === 'generate') {
                    loadingIcon.innerHTML = `
                        <svg class="w-8 h-8 text-green-600 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                    `;
                }
                
                loadingModal.classList.remove('hidden');
                loadingModal.style.display = 'flex';
                document.body.style.overflow = 'hidden';
            }
        }

        function hideCustomLoading() {
            const loadingModal = document.getElementById('customLoadingModal');
            if (loadingModal) {
                loadingModal.classList.add('hidden');
                loadingModal.style.display = 'none';
                document.body.style.overflow = 'auto';
            }
        }
    
// CONTINUA O SCRIPT - NÃO FECHAR AQUI!
// ========== O CÓDIGO ABAIXO É CSS/HTML MAS FAZ PARTE DO DOCUMENTO, NÃO DO SCRIPT ==========
</script>

    <!-- <link href="assets/css/loading-screen.css" rel="stylesheet"> DESABILITADO - usando apenas modal de carregamento -->
    <!-- <link href="assets/css/offline-loading.css" rel="stylesheet"> --> <!-- Desabilitado -->
    <link href="assets/css/weather-modal.css" rel="stylesheet">
    <link href="assets/css/native-notifications.css" rel="stylesheet">
    <link href="assets/css/quality-modal.css" rel="stylesheet">
    
    <!-- Responsividade Customizada -->
    <style>
        /* Gradiente de texto estilo Xandria Store */
        .gradient-text {
            background: linear-gradient(135deg, #01875f, #10b981);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        /* Card hover effect estilo Xandria Store */
        .card-hover {
            transition: all 0.3s ease;
        }
        
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }
        
        .dark .card-hover:hover {
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.6);
        }
        
        /* Responsividade para telas muito pequenas */
        @media (max-width: 360px) {
            .text-xs { font-size: 0.65rem !important; line-height: 0.9rem !important; }
            .text-sm { font-size: 0.75rem !important; line-height: 1rem !important; }
            .text-base { font-size: 0.8rem !important; line-height: 1.1rem !important; }
            .text-lg { font-size: 0.9rem !important; line-height: 1.2rem !important; }
            .text-xl { font-size: 1rem !important; line-height: 1.3rem !important; }
            .text-2xl { font-size: 1.1rem !important; line-height: 1.4rem !important; }
            
            /* Espaçamentos reduzidos */
            .p-2 { padding: 0.3rem !important; }
            .p-3 { padding: 0.5rem !important; }
            .p-4 { padding: 0.6rem !important; }
            .p-6 { padding: 0.8rem !important; }
            .px-3 { padding-left: 0.5rem !important; padding-right: 0.5rem !important; }
            .px-4 { padding-left: 0.6rem !important; padding-right: 0.6rem !important; }
            .px-6 { padding-left: 0.8rem !important; padding-right: 0.8rem !important; }
            .py-2 { padding-top: 0.3rem !important; padding-bottom: 0.3rem !important; }
            .py-3 { padding-top: 0.5rem !important; padding-bottom: 0.5rem !important; }
            .py-4 { padding-top: 0.6rem !important; padding-bottom: 0.6rem !important; }
            
            /* Margens reduzidas */
            .m-2 { margin: 0.3rem !important; }
            .m-3 { margin: 0.5rem !important; }
            .m-4 { margin: 0.6rem !important; }
            .mb-2 { margin-bottom: 0.3rem !important; }
            .mb-3 { margin-bottom: 0.5rem !important; }
            .mb-4 { margin-bottom: 0.6rem !important; }
            .mb-6 { margin-bottom: 0.8rem !important; }
            .mt-2 { margin-top: 0.3rem !important; }
            .mt-3 { margin-top: 0.5rem !important; }
            .mt-4 { margin-top: 0.6rem !important; }
            
            /* Grid gaps reduzidos */
            .gap-2 { gap: 0.3rem !important; }
            .gap-3 { gap: 0.5rem !important; }
            .gap-4 { gap: 0.6rem !important; }
            .gap-6 { gap: 0.8rem !important; }
            
            /* Espaçamentos entre elementos */
            .space-y-2 > * + * { margin-top: 0.3rem !important; }
            .space-y-3 > * + * { margin-top: 0.5rem !important; }
            .space-y-4 > * + * { margin-top: 0.6rem !important; }
            .space-y-6 > * + * { margin-top: 0.8rem !important; }
            
            /* Botões menores */
            .btn-sm { padding: 0.3rem 0.6rem !important; font-size: 0.7rem !important; }
            .btn-md { padding: 0.5rem 0.8rem !important; font-size: 0.8rem !important; }
            
            /* Cards mais compactos */
            .card-compact { padding: 0.6rem !important; }
            .card-compact .text-lg { font-size: 0.85rem !important; }
            .card-compact .text-xl { font-size: 0.95rem !important; }
            
            /* Headers mais compactos */
            .header-compact { padding: 0.5rem 0.8rem !important; }
            .header-compact .text-xl { font-size: 0.9rem !important; }
            .header-compact .text-2xl { font-size: 1rem !important; }
        }
        
        /* Responsividade para telas pequenas */
        @media (max-width: 480px) {
            .text-xs { font-size: 0.7rem !important; line-height: 0.95rem !important; }
            .text-sm { font-size: 0.8rem !important; line-height: 1.05rem !important; }
            .text-base { font-size: 0.85rem !important; line-height: 1.15rem !important; }
            .text-lg { font-size: 0.95rem !important; line-height: 1.25rem !important; }
            .text-xl { font-size: 1.05rem !important; line-height: 1.35rem !important; }
            .text-2xl { font-size: 1.15rem !important; line-height: 1.45rem !important; }
            
            /* Espaçamentos moderados */
            .p-2 { padding: 0.4rem !important; }
            .p-3 { padding: 0.6rem !important; }
            .p-4 { padding: 0.7rem !important; }
            .p-6 { padding: 0.9rem !important; }
            .px-3 { padding-left: 0.6rem !important; padding-right: 0.6rem !important; }
            .px-4 { padding-left: 0.7rem !important; padding-right: 0.7rem !important; }
            .px-6 { padding-left: 0.9rem !important; padding-right: 0.9rem !important; }
            .py-2 { padding-top: 0.4rem !important; padding-bottom: 0.4rem !important; }
            .py-3 { padding-top: 0.6rem !important; padding-bottom: 0.6rem !important; }
            .py-4 { padding-top: 0.7rem !important; padding-bottom: 0.7rem !important; }
            
            /* Margens moderadas */
            .m-2 { margin: 0.4rem !important; }
            .m-3 { margin: 0.6rem !important; }
            .m-4 { margin: 0.7rem !important; }
            .mb-2 { margin-bottom: 0.4rem !important; }
            .mb-3 { margin-bottom: 0.6rem !important; }
            .mb-4 { margin-bottom: 0.7rem !important; }
            .mb-6 { margin-bottom: 0.9rem !important; }
            .mt-2 { margin-top: 0.4rem !important; }
            .mt-3 { margin-top: 0.6rem !important; }
            .mt-4 { margin-top: 0.7rem !important; }
            
            /* Grid gaps moderados */
            .gap-2 { gap: 0.4rem !important; }
            .gap-3 { gap: 0.6rem !important; }
            .gap-4 { gap: 0.7rem !important; }
            .gap-6 { gap: 0.9rem !important; }
            
            /* Espaçamentos entre elementos */
            .space-y-2 > * + * { margin-top: 0.4rem !important; }
            .space-y-3 > * + * { margin-top: 0.6rem !important; }
            .space-y-4 > * + * { margin-top: 0.7rem !important; }
            .space-y-6 > * + * { margin-top: 0.9rem !important; }
        }
        
        /* Prevenir quebra de linha em textos importantes */
        .no-wrap { white-space: nowrap !important; }
        .text-ellipsis { overflow: hidden !important; text-overflow: ellipsis !important; white-space: nowrap !important; }
        
        /* Ajustes específicos para elementos que quebram */
        .metric-value { font-size: clamp(0.8rem, 2.5vw, 1.25rem) !important; }
        .metric-label { font-size: clamp(0.6rem, 2vw, 0.875rem) !important; }
        .card-title { font-size: clamp(0.75rem, 2.2vw, 1.125rem) !important; }
        .button-text { font-size: clamp(0.7rem, 2vw, 0.875rem) !important; }
        
        /* Melhorar espaçamento em grids */
        .grid-compact { gap: 0.5rem !important; }
        .grid-compact > * { padding: 0.5rem !important; }
        
        /* Ajustes para modais em telas pequenas */
        @media (max-width: 480px) {
            .modal-content { padding: 0.8rem !important; }
            .modal-title { font-size: 1rem !important; }
            .modal-body { font-size: 0.85rem !important; }
            .modal-button { padding: 0.5rem 0.8rem !important; font-size: 0.8rem !important; }
        }
        
        @media (max-width: 360px) {
            .modal-content { padding: 0.6rem !important; }
            .modal-title { font-size: 0.9rem !important; }
            .modal-body { font-size: 0.75rem !important; }
            .modal-button { padding: 0.4rem 0.6rem !important; font-size: 0.7rem !important; }
        }
        
        /* Ajustes específicos para cards de dados */
        @media (max-width: 480px) {
            .data-card { padding: 0.8rem !important; }
            .data-card h3 { font-size: 0.9rem !important; margin-bottom: 0.6rem !important; }
            .data-card .text-lg { font-size: 0.85rem !important; }
            .data-card .text-xl { font-size: 0.95rem !important; }
            .data-card .text-2xl { font-size: 1.05rem !important; }
        }
        
        @media (max-width: 360px) {
            .data-card { padding: 0.6rem !important; }
            .data-card h3 { font-size: 0.8rem !important; margin-bottom: 0.5rem !important; }
            .data-card .text-lg { font-size: 0.75rem !important; }
            .data-card .text-xl { font-size: 0.85rem !important; }
            .data-card .text-2xl { font-size: 0.95rem !important; }
        }
        
        /* Ajustes para botões em telas pequenas */
        @media (max-width: 480px) {
            .btn-primary, .btn-secondary, .btn-success, .btn-danger { 
                padding: 0.4rem 0.8rem !important; 
                font-size: 0.8rem !important; 
            }
            .btn-sm { 
                padding: 0.3rem 0.6rem !important; 
                font-size: 0.7rem !important; 
            }
        }
        
        @media (max-width: 360px) {
            .btn-primary, .btn-secondary, .btn-success, .btn-danger { 
                padding: 0.3rem 0.6rem !important; 
                font-size: 0.7rem !important; 
            }
            .btn-sm { 
                padding: 0.25rem 0.5rem !important; 
                font-size: 0.65rem !important; 
            }
        }
        
        /* Ajustes para tabelas em telas pequenas */
        @media (max-width: 480px) {
            .table-responsive { font-size: 0.75rem !important; }
            .table-responsive th, .table-responsive td { 
                padding: 0.4rem 0.3rem !important; 
            }
        }
        
        @media (max-width: 360px) {
            .table-responsive { font-size: 0.7rem !important; }
            .table-responsive th, .table-responsive td { 
                padding: 0.3rem 0.2rem !important; 
            }
        }
        
        /* Ajustes para inputs e formulários */
        @media (max-width: 480px) {
            input, select, textarea { 
                font-size: 0.85rem !important; 
                padding: 0.4rem 0.6rem !important; 
            }
            label { font-size: 0.8rem !important; }
        }
        
        @media (max-width: 360px) {
            input, select, textarea { 
                font-size: 0.8rem !important; 
                padding: 0.3rem 0.5rem !important; 
            }
            label { font-size: 0.75rem !important; }
        }
        
        /* Ajustes específicos para modal de logout */
        @media (max-width: 480px) {
            #logoutConfirmationModal .bg-white,
            #logoutConfirmationModal .bg-white {
                margin: 1rem !important;
                padding: 1.5rem !important;
            }
            
            #logoutConfirmationModal h3 {
                font-size: 1.1rem !important;
            }
            
            #logoutConfirmationModal p {
                font-size: 0.9rem !important;
            }
            
            #logoutConfirmationModal .w-16 {
                width: 3rem !important;
                height: 3rem !important;
            }
            
            #logoutConfirmationModal .w-8 {
                width: 1.5rem !important;
                height: 1.5rem !important;
            }
        }
        
        /* Garantir que os botões de edição sejam ocultados corretamente */
        #profileEditButtons.hidden {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
            pointer-events: none !important;
        }
        
        /* Forçar ocultação dos botões quando não há mudanças */
        #profileEditButtons[style*="display: none"] {
            visibility: hidden !important;
            opacity: 0 !important;
            pointer-events: none !important;
        }
        
        /* Garantir que as telas de processamento sejam ocultadas */
        #photoProcessingScreen.hidden,
        #managerPhotoProcessingScreen.hidden {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
            pointer-events: none !important;
        }
        
        /* Forçar ocultação das telas de processamento */
        #photoProcessingScreen[style*="display: none"],
        #managerPhotoProcessingScreen[style*="display: none"] {
            visibility: hidden !important;
            opacity: 0 !important;
            pointer-events: none !important;
        }
        
        /* Garantir que o modal de foto do gerente seja exibido corretamente */
        #managerPhotoChoiceModal[style*="display: flex"] {
            visibility: visible !important;
            opacity: 1 !important;
            pointer-events: auto !important;
        }
        
        #managerPhotoChoiceModal.flex {
            display: flex !important;
            visibility: visible !important;
            opacity: 1 !important;
            pointer-events: auto !important;
        }
        
        /* Garantir que o modal MAIS seja exibido corretamente */
        #moreModal[style*="display: block"] {
            visibility: visible !important;
            opacity: 1 !important;
            pointer-events: auto !important;
        }
        
        #moreModal:not(.hidden) {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            pointer-events: auto !important;
        }
        
        
        /* Melhorar aparência dos apps no modal estilo mobile */
        #moreModal .app-item {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
            padding: 8px;
            border-radius: 12px;
        }
        
        #moreModal .app-item:hover {
            background-color: rgba(0, 0, 0, 0.05) !important;
            transform: translateY(-2px) !important;
        }
        
        
        #moreModal .app-item:active {
            transform: scale(0.95) !important;
        }
        
        
        /* Garantir que o ícone de perfil seja ocultado quando há foto */
        #headerProfileIcon.hidden,
        #modalProfileIcon.hidden,
        #managerProfilePlaceholder.hidden {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
            pointer-events: none !important;
        }
        
        /* Garantir que a foto de perfil seja exibida */
        #headerProfilePhoto:not(.hidden),
        #modalProfilePhoto:not(.hidden),
        #managerProfilePreview:not(.hidden) {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            pointer-events: auto !important;
        }
        
        /* Forçar fechamento do modal de foto do gerente */
        #managerPhotoChoiceModal.hidden {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
            pointer-events: none !important;
            position: fixed !important;
            z-index: -1 !important;
        }
        
        #managerPhotoChoiceModal[style*="display: none"] {
            visibility: hidden !important;
            opacity: 0 !important;
            pointer-events: none !important;
            position: fixed !important;
            z-index: -1 !important;
        }
        
        /* Garantir que o modal de foto do gerente seja exibido corretamente */
        #managerPhotoChoiceModal.flex {
            display: flex !important;
            visibility: visible !important;
            opacity: 1 !important;
            pointer-events: auto !important;
            position: fixed !important;
            z-index: 999999 !important;
        }
        
        #managerPhotoChoiceModal[style*="display: flex"] {
            visibility: visible !important;
            opacity: 1 !important;
            pointer-events: auto !important;
            position: fixed !important;
            z-index: 999999 !important;
        }
        
        /* Corrigir overflow nas contas secundárias */
        #secondaryAccountsList {
            overflow-x: hidden;
            overflow-y: auto;
            width: 100%;
        }
        
        #secondaryAccountsList > div {
            max-width: 100%;
            overflow: hidden;
            width: 100%;
        }
        
        /* Corrigir centralização no desktop */
        @media (min-width: 640px) {
            #secondaryAccountsList {
                display: flex;
                flex-direction: column;
                align-items: stretch;
                width: 100%;
            }
            
            #secondaryAccountsList > div {
                width: 100%;
                max-width: none;
                flex: 1;
            }
        }
        
        /* Garantir que o container das contas secundárias ocupe toda a largura */
        .bg-white.rounded-2xl.p-4.sm\\:p-8.border.border-gray-200.mx-0.sm\\:mx-4.mb-8 {
            width: 100%;
        }
        
        /* ==================== ANIMAÇÃO DE CONEXÃO COM SERVIDOR ==================== */
        /* From Uiverse.io by Juanes200122 */ 
        #svg_svg {
            zoom: 0.3;
        }
        .estrobo_animation {
            animation:
                floatAndBounce 4s infinite ease-in-out,
                strobe 0.8s infinite;
        }

        .estrobo_animationV2 {
            animation:
                floatAndBounce 4s infinite ease-in-out,
                strobev2 0.8s infinite;
        }

        #float_server {
            animation: floatAndBounce 4s infinite ease-in-out;
        }

        @keyframes floatAndBounce {
            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-20px);
            }
        }

        @keyframes strobe {
            0%,
            50%,
            100% {
                fill: #17e300;
            }

            25%,
            75% {
                fill: #17e300b4;
            }
        }

        @keyframes strobev2 {
            0%,
            50%,
            100% {
                fill: rgb(255, 95, 74);
            }

            25%,
            75% {
                fill: rgb(16, 53, 115);
            }
        }

        /* Animación de los colores del gradiente */
        @keyframes animateGradient {
            0% {
                stop-color: #313f8773;
            }

            50% {
                stop-color: #040d3a;
            }

            100% {
                stop-color: #313f8773;
            }
        }

        /* Animación aplicada a los puntos del gradiente */
        #paint13_linear_163_1030 stop {
            animation: animateGradient 4s infinite alternate;
        }
        
        /* Garantir que os textos longos sejam truncados */
        .truncate {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        /* Animações do header dinâmico - Global */
        #profileModalHeader {
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out !important;
        }
        
        /* Responsividade para telas pequenas */
        @media (max-width: 640px) {
            #secondaryAccountsList > div {
                padding: 0.75rem;
            }
            
            #secondaryAccountsList .flex-col {
                gap: 0.5rem;
            }
            
            /* Modal de perfil ocupar toda a tela no mobile */
            #profileModal {
                width: 100vw;
                height: 100vh;
                max-width: none;
                max-height: none;
                border-radius: 0;
                margin: 0;
            }
            
            #profileModal .modal-content {
                width: 100%;
                height: 100%;
                border-radius: 0;
                margin: 0;
            }
            
            /* Header do modal de perfil */
            #profileModalHeader {
                border-radius: 0;
                margin: 0;
                width: 100vw;
                margin-left: -1rem;
                margin-right: -1rem;
            }
            
            @media (min-width: 640px) {
                #profileModalHeader {
                    width: 100%;
                    margin-left: 0;
                    margin-right: 0;
                }
            }
            
            /* Conteúdo do modal responsivo - padding removido para evitar conflito com sticky header */
            
            /* Animações do header dinâmico */
            #profileModalHeader {
                transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out !important;
            }
        }
        
        @media (max-width: 360px) {
            #logoutConfirmationModal .bg-white,
            #logoutConfirmationModal .bg-white {
                margin: 0.5rem !important;
                padding: 1rem !important;
            }
            
            #logoutConfirmationModal h3 {
                font-size: 1rem !important;
            }
            
            #logoutConfirmationModal p {
                font-size: 0.85rem !important;
            }
            
            #logoutConfirmationModal .w-16 {
                width: 2.5rem !important;
                height: 2.5rem !important;
            }
            
            #logoutConfirmationModal .w-8 {
                width: 1.25rem !important;
                height: 1.25rem !important;
            }
        }
        
        /* Animação dos três pontinhos para indicador de digitando */
        .typing-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background-color: #9CA3AF;
            animation: typing 1.4s infinite ease-in-out;
        }
        
        .typing-dot:nth-child(1) {
            animation-delay: -0.32s;
        }
        
        .typing-dot:nth-child(2) {
            animation-delay: -0.16s;
        }
        
        @keyframes typing {
            0%, 80%, 100% {
                transform: scale(0.8);
                opacity: 0.5;
            }
            40% {
                transform: scale(1);
                opacity: 1;
            }
        }
    </style>
    
    
<!-- Estilos personalizados para animações premium da seção de relatórios -->
    <style>
        /* Animações customizadas */
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-6px); }
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        .animate-float {
            animation: float 4s ease-in-out infinite;
        }
        
        /* Efeito shimmer nos botões */
        .btn-shimmer {
            position: relative;
            overflow: hidden;
        }
        
        .btn-shimmer::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                90deg,
                transparent,
                rgba(255, 255, 255, 0.4),
                transparent
            );
            transition: left 0.6s ease-in-out;
        }
        
        .btn-shimmer:hover::before {
            left: 100%;
        }
        
        /* Efeito de vidro melhorado */
        .glass-effect {
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }
        
        /* Sombras coloridas personalizadas */
        .shadow-red-glow {
            box-shadow: 0 10px 40px rgba(239, 68, 68, 0.3);
        }
        
        .shadow-green-glow {
            box-shadow: 0 10px 40px rgba(34, 197, 94, 0.3);
        }
        
        .shadow-purple-glow {
            box-shadow: 0 10px 40px rgba(147, 51, 234, 0.3);
        }
        
        /* Efeito de partículas flutuantes */
        .floating-particles::before,
        .floating-particles::after {
            content: '';
            position: absolute;
            width: 4px;
            height: 4px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            animation: float 3s ease-in-out infinite;
        }
        
        .floating-particles::before {
            top: 20%;
            right: 15%;
            animation-delay: -1s;
        }
        
        .floating-particles::after {
            bottom: 25%;
            left: 10%;
            animation-delay: -2s;
        }
    </style>

        
    
<!-- Script fix_data_sync_complete.js removido para evitar conflitos -->

    <link rel="icon" href="https://i.postimg.cc/vmrkgDcB/lactech.png" type="image/x-icon">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="assets/css/style.css">
    <style>

        

        
        /* Efeito de foco nos botões */ 
        button:focus { 
            outline: none; 
        } 
        
        /* Classes Tailwind para focus-visible */ 
        .focus-visible:focus { 
            --tw-ring-offset-shadow: var(--tw-ring-inset) 0 0 0 var(--tw-ring-offset-width) var(--tw-ring-offset-color); 
            --tw-ring-shadow: var(--tw-ring-inset) 0 0 0 calc(2px + var(--tw-ring-offset-width)) var(--tw-ring-color); 
            box-shadow: var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow, 0 0 #0000); 
            --tw-ring-color: rgba(134, 209, 134, 0.5); 
            --tw-ring-offset-width: 2px; 
        } 
        
        /* Classe para background do ícone */ 
        .bg-forest-100 { 
            background-color: #f0f9f0; 
        } 
        
        /* Definição de cores personalizadas para o ring */
        :root {
            --forest-300: #86d186;
        }
        
        /* Animações da Câmera */
        @keyframes focusPulse {
            0%, 100% { transform: scale(1); opacity: 0.4; }
            50% { transform: scale(1.05); opacity: 0.8; }
        }
        
        @keyframes focusSuccess {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .focus-pulse {
            animation: focusPulse 2s ease-in-out infinite;
        }
        
        .focus-success {
            animation: focusSuccess 0.5s ease-in-out;
        }
        
        /* Estilos da câmera */
        .camera-overlay {
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        
        .camera-button {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .camera-button:hover {
            transform: scale(1.05);
        }
        
        /* Modal de Foto */
        #photoModal.show #photoModalContent {
            transform: scale(1);
            opacity: 1;
        }
        

    </style>
    
<!-- ========== HTML MODALS - MOVIDOS PARA FORA DO SCRIPT ========== -->
=======
    </script>
>>>>>>> parent of 0eb3d2f (.)
    
    <!-- Modal de Escolha de Foto do Gerente (FORA do modal de perfil) -->
    <div id="managerPhotoChoiceModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[999999]" style="display: none !important; visibility: hidden !important; opacity: 0 !important; pointer-events: none !important;">
        <div class="bg-white rounded-2xl p-6 w-full max-w-md mx-4">
            <div class="flex items-center justify-between mb-6">
                                            <h2 class="text-xl font-bold text-gray-900">Mudar Foto de Perfil</h2>
                <button onclick="closeManagerPhotoModal()" class="p-2 hover:bg-gray-100 rounded-lg transition-all">
                    <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <div>
                <div class="text-center space-y-6">
                    <div class="w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mx-auto">
                        <svg class="w-12 h-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                        </svg>
                    </div>
                    
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900 mb-2">Como você quer adicionar sua foto?</h3>
                        <p class="text-gray-600">Escolha entre tirar uma foto ou selecionar da galeria</p>
                    </div>
                    
                    <div class="flex flex-col sm:flex-row gap-4 justify-center">
                        <button onclick="openManagerCamera()" class="flex items-center justify-center space-x-3 px-6 py-4 bg-forest-600 hover:bg-forest-700 text-white font-medium rounded-xl transition-all">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>
                            <span>Tirar Foto</span>
                        </button>
                        
                        <button onclick="selectManagerFromGallery()" class="flex items-center justify-center space-x-3 px-6 py-4 bg-gray-600 hover:bg-gray-700 text-white font-medium rounded-xl transition-all">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                            </svg>
                            <span>Galeria</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
<div id="moreModal" class="fixed inset-0 bg-white bg-white z-[99999] hidden">
        <div class="w-full h-full overflow-y-auto">
        
        <!-- Header melhorado -->
        <div class="flex items-center justify-between p-6 border-b border-gray-200 border-gray-200 bg-white bg-white sticky top-0 z-10 shadow-sm more-modal-header">
                <div class="flex items-center space-x-4">
                <div class="w-10 h-10 bg-gradient-to-br from-green-500 to-green-600 rounded-2xl flex items-center justify-center shadow-lg">
                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path>
                        </svg>
                    </div>
                    <div>
                    <h2 class="text-xl font-bold text-gray-900 ">Mais Opções</h2>
                    <p class="text-sm text-gray-600 ">Acesse ferramentas e recursos</p>
                    </div>
                </div>
            <button onclick="closeMoreModal()" class="w-10 h-10 flex items-center justify-center hover:bg-gray-100 hover:bg-gray-100 rounded-xl transition-colors">
                    <svg class="w-6 h-6 text-gray-600 " fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
        <!-- Conteúdo melhorado -->
        <div class="p-6">
            <div class="max-w-2xl mx-auto">
                <!-- Seção: Ferramentas Principais -->
                <div class="mb-8">
                    <h3 class="text-lg font-semibold text-gray-900  mb-4 flex items-center">
                        <svg class="w-5 h-5 text-green-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path>
                        </svg>
                        Ferramentas Principais
                    </h3>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                    <!-- Relatórios -->
                        <div class="app-item bg-white border-2 border-gray-200 rounded-2xl p-4 cursor-pointer shadow-sm hover:shadow-md transition-all duration-200" onclick="openReportsTab()">
                            <div class="flex flex-col items-center text-center space-y-3">
                                <div class="w-16 h-16 bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl flex items-center justify-center shadow-lg">
                                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                            </div>
                            <div>
                                    <p class="font-semibold text-gray-900  text-sm">Relatórios</p>
                                    <p class="text-xs text-gray-600 ">Análises e dados</p>
                            </div>
                        </div>
                    </div>
                    
                        <!-- Suporte -->
                        <div class="app-item bg-white border-2 border-gray-200 rounded-2xl p-4 cursor-pointer shadow-sm hover:shadow-md transition-all duration-200" onclick="openSupportHub()">
                            <div class="flex flex-col items-center text-center space-y-3">
                                <div class="w-16 h-16 bg-gradient-to-br from-purple-500 to-purple-600 rounded-2xl flex items-center justify-center shadow-lg">
                                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <div>
                                    <p class="font-semibold text-gray-900  text-sm">Suporte</p>
                                    <p class="text-xs text-gray-600 ">Ajuda e contato</p>
                            </div>
                        </div>
                    </div>
                    
                        <!-- Xandria Store -->
                        <div class="app-item bg-white border-2 border-gray-200 rounded-2xl p-4 cursor-pointer shadow-sm hover:shadow-md transition-all duration-200" onclick="openXandriaStore()">
                            <div class="flex flex-col items-center text-center space-y-3">
                                <div class="w-16 h-16 bg-gradient-to-br from-white to-white rounded-2xl flex items-center justify-center shadow-lg">
                                    <img id="xandriaStoreIcon" src="https://i.postimg.cc/W17q41wM/lactechpreta.png" alt="Xandria Store" class="w-12 h-12 rounded-xl">
                            </div>
                            <div>
                                    <p class="font-semibold text-gray-900  text-sm">Xandria Store</p>
                                    <p class="text-xs text-gray-600 ">Apps e sistemas</p>
                            </div>
                        </div>
                        </div>
                        </div>
                    </div>
                    
                <!-- Seção: Utilitários -->
                <div class="mb-8">
                    <h3 class="text-lg font-semibold text-gray-900  mb-4 flex items-center">
                        <svg class="w-5 h-5 text-blue-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4"></path>
                        </svg>
                        Utilitários
                    </h3>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                        
                        <!-- Contatos -->
                        <div class="app-item bg-white border-2 border-gray-200 rounded-2xl p-4 cursor-pointer shadow-sm hover:shadow-md transition-all duration-200" onclick="openContactsModal()">
                            <div class="flex flex-col items-center text-center space-y-3">
                                <div class="w-16 h-16 bg-gradient-to-br from-indigo-500 to-indigo-600 rounded-2xl flex items-center justify-center shadow-lg">
                                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                    </svg>
                                </div>
                                <div>
                                    <p class="font-semibold text-gray-900  text-sm">Contatos</p>
                                    <p class="text-xs text-gray-600 ">Lista telefônica</p>
                                </div>
                        </div>
                    </div>
                    
                    

                    
                    
                    
                        <!-- Chat removido - sistema simplificado para Lagoa do Mato -->
                        </div>
                    </div>
                    
        </div>
    </div>

    <!-- Modal de Contatos - Full Screen -->
    <div id="contactsModal" class="fixed inset-0 bg-white z-[99999] hidden flex flex-col" style="display: none;">
        <!-- Header -->
        <div class="flex-shrink-0 p-4 sm:p-6 bg-gradient-to-br from-indigo-500 via-indigo-600 to-indigo-700 text-white shadow-2xl">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <div class="w-12 h-12 bg-white bg-opacity-20 rounded-2xl flex items-center justify-center">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                </svg>
                            </div>
                            <div>
                        <h1 class="text-2xl font-bold">Lista Telefônica</h1>
                        <p class="text-indigo-100 text-sm">Gerencie contatos da fazenda</p>
                            </div>
                        </div>
                <div class="flex items-center space-x-3">
                    <button onclick="openContactForm()" class="px-4 py-2 bg-white bg-opacity-20 hover:bg-opacity-30 rounded-xl transition-colors flex items-center space-x-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                        </svg>
                        <span>Adicionar</span>
                    </button>
                    <button onclick="closeContactsModal()" class="p-2 hover:bg-white hover:bg-opacity-20 rounded-xl transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                        </div>
                        </div>
                    </div>
                    
        <!-- Conteúdo -->
        <div class="flex-1 overflow-y-auto p-4 sm:p-6 bg-gray-50">
            <div class="max-w-4xl mx-auto">
                <div id="contactsList" class="space-y-4">
                    <!-- Contatos serão carregados aqui -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Formulário de Contato -->
    <div id="contactFormModal" class="fixed inset-0 bg-black bg-opacity-50 z-[99999] hidden flex items-center justify-center" style="display: none;">
        <div class="bg-white rounded-2xl p-6 shadow-2xl max-w-md w-full mx-4">
            <div class="flex items-center justify-between mb-6">
                <h3 id="contactFormTitle" class="text-xl font-bold text-gray-900">Adicionar Contato</h3>
                <button onclick="closeContactForm()" class="p-2 hover:bg-gray-100 rounded-xl transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                </button>
                            </div>

            <form id="contactForm" onsubmit="saveContact(event)">
                <div class="space-y-4">
                    <!-- Nome -->
                            <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Nome *</label>
                        <input type="text" name="name" id="contactName" required
                               class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 focus:outline-none"
                               placeholder="Nome do contato">
                            </div>

                    <!-- Telefone -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Telefone *</label>
                        <input type="tel" name="phone" id="contactPhone" required
                               class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 focus:outline-none"
                               placeholder="(11) 99999-9999">
                        </div>

                    <!-- Email -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Email</label>
                        <input type="email" name="email" id="contactEmail"
                               class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 focus:outline-none"
                               placeholder="email@exemplo.com">
                        </div>

                    <!-- Categoria -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Categoria *</label>
                        <select name="category" id="contactCategory" required
                                class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 focus:outline-none">
                            <option value="">Selecione uma categoria</option>
                            <option value="Distribuidora">Distribuidora</option>
                            <option value="Comprador">Comprador</option>
                            <option value="Fornecedor">Fornecedor</option>
                            <option value="Veterinário">Veterinário</option>
                            <option value="Técnico">Técnico</option>
                            <option value="Transportadora">Transportadora</option>
                            <option value="Banco">Banco</option>
                            <option value="Seguro">Seguro</option>
                            <option value="Outros">Outros</option>
                        </select>
                        </div>

                    <!-- Observações -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Observações</label>
                        <textarea name="notes" id="contactNotes" rows="3"
                                  class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 focus:outline-none"
                                  placeholder="Informações adicionais..."></textarea>
                    </div>
                </div>

                <!-- Botões -->
                <div class="flex space-x-3 mt-6">
                    <button type="button" onclick="closeContactForm()"
                            class="flex-1 px-4 py-3 border border-gray-300 text-gray-700 rounded-xl hover:bg-gray-50 transition-colors">
                        Cancelar
                    </button>
                    <button type="submit" id="contactFormSubmit"
                            class="flex-1 px-4 py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl transition-colors">
                        Adicionar
                    </button>
            </div>
            </form>
        </div>
    </div>
    
    <!-- Modal de Solicitações de Senha - Full Screen -->
    <div id="passwordRequestsModal" class="fixed inset-0 bg-white bg-white z-[99999] hidden flex flex-col" style="display: none !important;">
        <!-- Header -->
        <div class="flex-shrink-0 p-4 sm:p-6 bg-gradient-to-br from-forest-500 via-forest-600 to-forest-700 text-white shadow-2xl">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3 sm:space-x-6">
                        <div class="w-12 h-12 sm:w-16 sm:h-16 bg-white bg-opacity-20 backdrop-blur-sm rounded-2xl sm:rounded-3xl flex items-center justify-center shadow-xl">
                            <svg class="w-6 h-6 sm:w-8 sm:h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"></path>
                            </svg>
                        </div>
                        <div>
                            <h2 class="text-lg sm:text-xl font-bold mb-1">Solicitações de Senha</h2>
                            <p class="text-forest-100 text-xs sm:text-sm">Gerencie solicitações de alteração e redefinição de senha</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <!-- Botão de Histórico -->
                        <button onclick="openPasswordHistoryModal()" class="w-10 h-10 sm:w-12 sm:h-12 lg:w-14 lg:h-14 flex items-center justify-center hover:bg-white hover:bg-opacity-20 rounded-xl sm:rounded-2xl transition-all duration-200" title="Ver histórico de solicitações">
                            <svg class="w-5 h-5 sm:w-6 sm:h-6 lg:w-8 lg:h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </button>
                        <!-- Botão de Fechar -->
                        <button onclick="closePasswordRequestsModal()" class="w-10 h-10 sm:w-12 sm:h-12 lg:w-14 lg:h-14 flex items-center justify-center hover:bg-white hover:bg-opacity-20 rounded-xl sm:rounded-2xl transition-all duration-200">
                            <svg class="w-5 h-5 sm:w-6 sm:h-6 lg:w-8 lg:h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                </div>
        </div>
        
        <!-- Conteúdo -->
        <div class="flex-1 overflow-y-auto p-4 sm:p-6">
                <!-- Filtros e Estatísticas -->
                <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 mb-8">
                    <!-- Estatísticas -->
                    <div class="lg:col-span-3 grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <div class="bg-gradient-to-br from-amber-50 to-amber-100 rounded-2xl p-4 border border-amber-200">
                            <div class="flex items-center space-x-3">
                                <div class="w-10 h-10 bg-amber-500 rounded-xl flex items-center justify-center">
                                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                </div>
                                <div>
                                    <p class="text-2xl font-bold text-amber-800" id="pendingCount">0</p>
                                    <p class="text-sm text-amber-600">Pendentes</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-gradient-to-br from-green-50 to-green-100 rounded-2xl p-4 border border-green-200">
                            <div class="flex items-center space-x-3">
                                <div class="w-10 h-10 bg-green-500 rounded-xl flex items-center justify-center">
                                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"></path>
                                    </svg>
                                </div>
                                <div>
                                    <p class="text-2xl font-bold text-green-800" id="approvedCount">0</p>
                                    <p class="text-sm text-green-600">Aprovadas</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-gradient-to-br from-red-50 to-red-100 rounded-2xl p-4 border border-red-200">
                            <div class="flex items-center space-x-3">
                                <div class="w-10 h-10 bg-red-500 rounded-xl flex items-center justify-center">
                                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </div>
                                <div>
                                    <p class="text-2xl font-bold text-red-800" id="rejectedCount">0</p>
                                    <p class="text-sm text-red-600">Rejeitadas</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Filtros -->
                    <div class="space-y-4">
                        <select id="passwordRequestFilter" class="w-full px-4 py-3 border border-gray-200 rounded-xl text-sm focus:border-forest-500 focus:ring-2 focus:ring-forest-100 focus:outline-none bg-white text-gray-900">
                            <option value="all">Todas as solicitações</option>
                            <option value="pending">Pendentes</option>
                            <option value="approved">Aprovadas</option>
                            <option value="rejected">Rejeitadas</option>
                        </select>
                        <button onclick="refreshPasswordRequests()" id="refreshPasswordRequestsBtn" class="w-full px-4 py-3 bg-gradient-to-r from-forest-500 to-forest-600 text-white rounded-xl hover:from-forest-600 hover:to-forest-700 transition-all font-semibold text-sm shadow-lg hover:shadow-xl">
                            <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                            </svg>
                            Atualizar
                        </button>
                    </div>
                </div>
                
                <!-- Lista de Solicitações -->
                <div class="bg-white rounded-2xl border border-gray-200 overflow-hidden">
                    <div class="px-6 py-4 border-b border-gray-200 bg-gray-50">
                        <h3 class="text-lg font-semibold text-gray-900">Lista de Solicitações</h3>
                        <p class="text-sm text-gray-600">Gerencie todas as solicitações de alteração de senha</p>
                    </div>
                    
                    <div class="p-6">
                        <div class="space-y-4" id="passwordRequestsList">
                            <!-- Solicitações serão carregadas aqui -->
                        </div>
                        
                        <!-- Estado vazio -->
                        <div id="emptyPasswordRequests" class="text-center py-16 hidden">
                            <div class="w-20 h-20 bg-gradient-to-br from-forest-100 to-forest-200 rounded-full flex items-center justify-center mx-auto mb-6">
                                <svg class="w-10 h-10 text-forest-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"></path>
                                </svg>
                            </div>
                            <h3 class="text-xl font-semibold text-gray-900 mb-3">Nenhuma Solicitação</h3>
                            <p class="text-gray-600 mb-6">Não há solicitações de senha no momento.</p>
                            <div class="w-32 h-1 bg-gradient-to-r from-forest-400 to-forest-600 rounded-full mx-auto"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal de Detalhes da Solicitação -->
    <div id="passwordRequestDetailsModal" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center z-[99999] hidden" style="display: none !important;">
        <div class="bg-white bg-white rounded-2xl shadow-2xl max-w-2xl w-full mx-4">
            <!-- Header -->
            <div class="flex items-center justify-between p-6 border-b border-gray-200 border-gray-200">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-gradient-to-br from-yellow-500 to-yellow-600 rounded-xl flex items-center justify-center">
                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"></path>
                        </svg>
                    </div>
                    <div>
                        <h2 class="text-xl font-bold text-gray-900 ">Detalhes da Solicitação</h2>
                        <p class="text-sm text-gray-600 ">Analise e tome uma decisão</p>
                    </div>
                </div>
                <button onclick="closePasswordRequestDetailsModal()" class="w-10 h-10 flex items-center justify-center hover:bg-gray-100 hover:bg-gray-50 rounded-xl transition-colors">
                    <svg class="w-6 h-6 text-gray-600 " fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <!-- Conteúdo -->
            <div class="p-6 space-y-6">
                <!-- Informações do usuário -->
                <div class="bg-gray-50  rounded-xl p-4">
                    <h3 class="font-semibold text-gray-900  mb-3">Informações do Usuário</h3>
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div>
                            <span class="text-gray-600 ">Nome:</span>
                            <span class="font-medium text-gray-900  ml-2" id="requestUserName">-</span>
                        </div>
                        <div>
                            <span class="text-gray-600 ">Email:</span>
                            <span class="font-medium text-gray-900  ml-2" id="requestUserEmail">-</span>
                        </div>
                        <div>
                            <span class="text-gray-600 ">Cargo:</span>
                            <span class="font-medium text-gray-900  ml-2" id="requestUserRole">-</span>
                        </div>
                        <div>
                            <span class="text-gray-600 ">Data da Solicitação:</span>
                            <span class="font-medium text-gray-900  ml-2" id="requestDate">-</span>
                        </div>
                    </div>
                </div>
                
                <!-- Detalhes da solicitação -->
                <div class="bg-gray-50  rounded-xl p-4">
                    <h3 class="font-semibold text-gray-900  mb-3">Detalhes da Solicitação</h3>
                    <div class="space-y-3">
                        <div>
                            <span class="text-gray-600 ">Tipo:</span>
                            <span class="font-medium text-gray-900  ml-2" id="requestType">-</span>
                        </div>
                        <div>
                            <span class="text-gray-600 ">Motivo:</span>
                            <span class="font-medium text-gray-900  ml-2" id="requestReason">-</span>
                        </div>
                        <div>
                            <span class="text-gray-600 ">Observações:</span>
                            <span class="font-medium text-gray-900  ml-2" id="requestNotes">-</span>
                        </div>
                    </div>
                </div>
                
                <!-- Ações -->
                <div class="flex flex-col sm:flex-row gap-3 pt-4 border-t border-gray-200 border-gray-200">
                    <button onclick="approvePasswordRequest()" class="flex-1 px-6 py-3 bg-green-500 text-white rounded-xl hover:bg-green-600 transition-all font-semibold">
                        <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"></path>
                        </svg>
                        Aprovar
                    </button>
                    <button onclick="rejectPasswordRequest()" class="flex-1 px-6 py-3 bg-red-500 text-white rounded-xl hover:bg-red-600 transition-all font-semibold">
                        <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                        Rejeitar
                    </button>
                    <button onclick="closePasswordRequestDetailsModal()" class="px-6 py-3 border border-gray-300 border-gray-300 text-gray-700  rounded-xl hover:bg-gray-50 hover:bg-gray-50 transition-all font-semibold">
                        Cancelar
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal de Histórico de Solicitações de Senha -->
    <div id="passwordHistoryModal" class="fixed inset-0 bg-white bg-white z-[99999] hidden flex flex-col" style="display: none !important;">
        <!-- Header -->
        <div class="flex-shrink-0 p-4 sm:p-6 bg-gradient-to-br from-forest-500 via-forest-600 to-forest-700 text-white shadow-2xl">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3 sm:space-x-6">
                    <div class="w-12 h-12 sm:w-16 sm:h-16 bg-white bg-opacity-20 backdrop-blur-sm rounded-2xl sm:rounded-3xl flex items-center justify-center shadow-xl">
                        <svg class="w-6 h-6 sm:w-8 sm:h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <div>
                        <h2 class="text-lg sm:text-xl font-bold mb-1">Histórico de Solicitações</h2>
                        <p class="text-forest-100 text-xs sm:text-sm">Visualize todas as solicitações processadas nos últimos 30 dias</p>
                    </div>
                </div>
                <button onclick="closePasswordHistoryModal()" class="w-10 h-10 sm:w-12 sm:h-12 lg:w-14 lg:h-14 flex items-center justify-center hover:bg-white hover:bg-opacity-20 rounded-xl sm:rounded-2xl transition-all duration-200">
                    <svg class="w-5 h-5 sm:w-6 sm:h-6 lg:w-8 lg:h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
        </div>
        
        <!-- Conteúdo -->
        <div class="flex-1 overflow-y-auto p-4 sm:p-6">
            <!-- Filtros -->
            <div class="mb-6">
                <div class="flex flex-col sm:flex-row gap-4 items-start sm:items-center justify-between">
                    <div class="flex flex-col sm:flex-row gap-4">
                        <select id="historyStatusFilter" class="px-4 py-2 border border-gray-300 rounded-lg bg-white text-gray-900 focus:ring-2 focus:ring-forest-500 focus:border-transparent">
                            <option value="">Todos os status</option>
                            <option value="approved">Aprovadas</option>
                            <option value="rejected">Rejeitadas</option>
                            <option value="pending">Pendentes</option>
                        </select>
                        <select id="historyDateFilter" class="px-4 py-2 border border-gray-300 rounded-lg bg-white text-gray-900 focus:ring-2 focus:ring-forest-500 focus:border-transparent">
                            <option value="7">Últimos 7 dias</option>
                            <option value="15">Últimos 15 dias</option>
                            <option value="30" selected>Últimos 30 dias</option>
                            <option value="90">Últimos 90 dias</option>
                        </select>
                    </div>
                    <button onclick="loadPasswordHistory()" id="refreshPasswordHistoryBtn" class="px-4 py-2 bg-forest-500 hover:bg-forest-600 text-white rounded-lg transition-colors duration-200 flex items-center space-x-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                        <span>Atualizar</span>
                    </button>
                </div>
            </div>
            
            <!-- Lista de Histórico -->
            <div id="passwordHistoryList" class="space-y-4">
                <!-- Loading -->
                <div id="historyLoading" class="flex items-center justify-center py-12">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-forest-500"></div>
                    <span class="ml-3 text-gray-600">Carregando histórico...</span>
                </div>
                
                <!-- Empty State -->
                <div id="emptyHistory" class="hidden text-center py-12">
                    <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">Nenhum histórico encontrado</h3>
                    <p class="text-gray-500">Não há solicitações no período selecionado</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Sidebar de Notificações -->
    <div id="notificationsModal" class="fixed inset-0 z-[99999] hidden transition-all duration-300">
        <!-- Overlay -->
        <div class="absolute inset-0 bg-black bg-opacity-50 backdrop-blur-sm" onclick="closeNotificationsModal()"></div>
        
        <!-- Sidebar -->
        <div class="absolute right-0 top-0 h-full w-full max-w-md bg-white shadow-2xl transform transition-transform duration-300 translate-x-full flex flex-col" id="notificationsModalContent">
            <!-- Header -->
            <div class="flex-shrink-0 p-6 bg-white border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <div class="w-12 h-12 bg-forest-100 rounded-2xl flex items-center justify-center">
                            <svg class="w-7 h-7 text-forest-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15 17h5l-5 5v-5zM9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold text-black">Notificações</h3>
                            <p class="text-gray-600 text-sm">Solicitações e alertas do sistema</p>
                        </div>
                    </div>
                    <button onclick="closeNotificationsModal()" class="w-10 h-10 hover:bg-gray-100 rounded-xl flex items-center justify-center transition-all">
                        <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>
            
            <!-- Content -->
            <div class="flex-1 overflow-y-auto p-6">
                <div id="notificationsList" class="space-y-3">
                    <!-- Estado vazio -->
                    <div class="text-center py-12">
                        <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <h3 class="text-lg font-semibold text-black mb-2">Tudo em dia!</h3>
                        <p class="text-gray-600">Não há notificações pendentes no momento</p>
                    </div>
                </div>
            </div>
            
            <!-- Footer -->
            <div class="flex-shrink-0 p-6 bg-white border-t border-gray-200">
                <button onclick="closeNotificationsModal()" class="w-full px-4 py-3 bg-forest-600 hover:bg-forest-700 text-white rounded-xl transition-all font-medium shadow-lg hover:shadow-xl">
                    Fechar
                </button>
            </div>
        </div>
    </div>
    
    <script>
        // ==================== FUNÇÕES DE NOTIFICAÇÕES ====================
        
        // Abrir sidebar de notificações
        function openNotificationsModal() {
            const modal = document.getElementById('notificationsModal');
            const content = document.getElementById('notificationsModalContent');
            
            if (modal && content) {
                modal.classList.remove('hidden');
                
                // Pequeno delay para garantir que o modal está visível antes da animação
                setTimeout(() => {
                    content.classList.remove('translate-x-full');
                    content.classList.add('translate-x-0');
                }, 10);
                
                loadNotifications();
            }
        }
        
        // Fechar sidebar de notificações
        function closeNotificationsModal() {
            const modal = document.getElementById('notificationsModal');
            const content = document.getElementById('notificationsModalContent');
            
            if (modal && content) {
                content.classList.remove('translate-x-0');
                content.classList.add('translate-x-full');
                
                setTimeout(() => {
                    modal.classList.add('hidden');
                }, 300);
            }
        }
        
        // Carregar notificações
        async function loadNotifications() {
            try {
                const notificationsList = document.getElementById('notificationsList');
                if (notificationsList) {
                    notificationsList.innerHTML = '<p class="text-center text-gray-500 py-4">Nenhuma notificação</p>';
                }
                updateNotificationCounter(0);
            } catch (error) {
                // Silencioso
            }
        }
        
        // Atualizar contador de notificações
        function updateNotificationCounter(count) {
            const counter = document.getElementById('notificationCounter');
            if (counter) {
                if (count > 0) {
                    counter.textContent = count;
                    counter.classList.remove('hidden');
                } else {
                    counter.classList.add('hidden');
                }
            }
        }
        
        // ==================== FUNÇÕES CORRIGIDAS DE SOLICITAÇÕES DE SENHA ====================
        
        // Função corrigida para carregar solicitações de senha
        async function loadPasswordRequestsFixed() {
            try {
                // // const supabase = await getSupabaseClient(); // REMOVIDO // REMOVIDO - usando MySQL
                
                console.log('🔄 Carregando solicitações de senha...');
                
                // Buscar todas as solicitações de senha (SEM join com users para evitar problemas de RLS)
                const { data: requests, error } = await supabase
                    .from('password_requests')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) {
                    console.error('❌ Erro ao carregar solicitações:', error);
                    showNotification('Erro ao carregar solicitações de senha: ' + error.message, 'error');
                    return;
                }
                
                console.log('✅ Solicitações carregadas:', requests);
                
                // Para cada solicitação, buscar os dados do usuário separadamente (com tratamento de erro melhorado)
                if (requests && requests.length > 0) {
                    for (let request of requests) {
                        try {
                            const { data: userData, error: userError } = await supabase
                                .from('users')
                                .select('email, name')
                                .eq('id', request.user_id)
                                .maybeSingle(); // Usar maybeSingle para evitar erro se não encontrar
                            
                            if (userError) {
                                request.users = { email: 'Email indisponível', name: 'Usuário indisponível' };
                            } else if (userData) {
                                request.users = userData;
                            } else {
                                request.users = { email: 'Email não encontrado', name: 'Usuário não encontrado' };
                            }
                        } catch (userError) {
                            request.users = { email: 'Email indisponível', name: 'Usuário indisponível' };
                        }
                    }
                }
                
                displayPasswordRequests(requests || []);
                updateRequestCounters(requests || []);
                
            } catch (error) {
                console.error('❌ Erro geral ao carregar solicitações:', error);
                showNotification('Erro ao carregar solicitações de senha: ' + error.message, 'error');
            }
        }
        
        // Função corrigida mantida para referência
        // window.loadPasswordRequests será substituída pela versão otimizada mais abaixo
        
        // ==================== SISTEMA DE ATUALIZAÇÃO EM TEMPO REAL ====================
        
        // Variáveis para controle de WebSocket
        let realTimeInterval = null;
        let isRealTimeActive = false;
        let updateCount = 0;
        let lastUpdateTime = null;
        
        // Função para iniciar atualização em tempo real
        function startRealTimeUpdates() {
            if (isRealTimeActive) return;
            
            isRealTimeActive = true;
            console.log('🔄 Iniciando atualizações em tempo real...');
            
            // Mostrar indicador de tempo real
            const indicator = document.getElementById('realTimeIndicator');
            if (indicator) {
                indicator.classList.remove('hidden');
            }
            
            // Atualizar a cada 5 segundos
            realTimeInterval = setInterval(() => {
                updateRealTimeData();
            }, 5000);
            
            // Atualizar imediatamente
            updateRealTimeData();
        }
        
        // Função para parar atualização em tempo real
        function stopRealTimeUpdates() {
            if (realTimeInterval) {
                clearInterval(realTimeInterval);
                realTimeInterval = null;
            }
            isRealTimeActive = false;
            console.log('⏹️ Parando atualizações em tempo real...');
            
            // Ocultar indicador de tempo real
            const indicator = document.getElementById('realTimeIndicator');
            if (indicator) {
                indicator.classList.add('hidden');
            }
        }
        
        // Função principal de atualização em tempo real
        async function updateRealTimeData() {
            try {
                // Atualizar notificações
                await loadNotifications();
                
                // Atualizar solicitações de senha se o modal estiver aberto
                const passwordModal = document.getElementById('passwordRequestsModal');
                if (passwordModal && !passwordModal.classList.contains('hidden')) {
                    await loadPasswordRequests();
                }
                
                // Atualizar histórico se o modal estiver aberto
                const historyModal = document.getElementById('passwordHistoryModal');
                if (historyModal && !historyModal.classList.contains('hidden')) {
                    await loadPasswordHistory();
                }
                
                // Atualizar gráficos se necessário
                await updateCharts();
                
                // Atualizar indicador de status
                updateConnectionStatus('connected');
                
                // Atualizar estatísticas
                updateCount++;
                lastUpdateTime = new Date();
                
                console.log(`✅ Dados atualizados em tempo real (${updateCount} atualizações)`);
                
            } catch (error) {
                console.error('❌ Erro na atualização em tempo real:', error);
                updateConnectionStatus('error');
            }
        }
        
        // Função para atualizar status de conexão
        function updateConnectionStatus(status) {
            const indicator = document.getElementById('realTimeIndicator');
            if (!indicator) return;
            
            // Remover classes anteriores
            indicator.classList.remove('bg-green-500', 'bg-red-500', 'bg-yellow-500');
            
            switch (status) {
                case 'connected':
                    indicator.classList.add('bg-green-500');
                    indicator.title = 'Sistema automático ativo - Dados atualizados a cada 5 segundos';
                    break;
                case 'error':
                    indicator.classList.add('bg-red-500');
                    indicator.title = 'Erro de conexão - Sistema tentando reconectar...';
                    break;
                case 'connecting':
                    indicator.classList.add('bg-yellow-500');
                    indicator.title = 'Iniciando sistema automático...';
                    break;
            }
        }
        
        // Função para atualizar gráficos
        async function updateCharts() {
            try {
                // Aqui você pode adicionar lógica para atualizar gráficos específicos
                // Por exemplo, se houver gráficos de estatísticas
                console.log('📊 Atualizando gráficos...');
                
                // Exemplo: atualizar contadores de estatísticas
                await updateStatisticsCounters();
                
            } catch (error) {
                console.error('❌ Erro ao atualizar gráficos:', error);
            }
        }
        
        // Função para atualizar contadores de estatísticas
        async function updateStatisticsCounters() {
            try {
                console.log('📊 Atualizando contadores de estatísticas (MySQL)...');
                
                // Por enquanto, não há contadores no MySQL
                // Definir valores padrão
                const pendingCount = 0;
                const approvedCount = 0;
                const rejectedCount = 0;
                
                // Atualizar elementos na interface
                updateCounterElement('pendingCount', pendingCount);
                updateCounterElement('approvedCount', approvedCount);
                updateCounterElement('rejectedCount', rejectedCount);
                
                console.log('✅ Contadores atualizados (MySQL)');
                
            } catch (error) {
                console.error('❌ Erro ao atualizar contadores:', error);
            }
        }
        
        // Função para atualizar elemento de contador
        function updateCounterElement(elementId, count) {
            const element = document.getElementById(elementId);
            if (element) {
                const currentCount = parseInt(element.textContent) || 0;
                if (currentCount !== count) {
                    element.textContent = count;
                    
                    // Adicionar animação de mudança
                    element.classList.add('animate-pulse');
                    setTimeout(() => {
                        element.classList.remove('animate-pulse');
                    }, 1000);
                }
            }
        }
        
        // Função para atualizar contador de notificações
        function updateNotificationCounter(count) {
            const countElement = document.getElementById('notificationCounter');
            if (countElement) {
                const currentCount = parseInt(countElement.textContent) || 0;
                countElement.textContent = count;
                countElement.style.display = count > 0 ? 'block' : 'none';
                
                // Adicionar animação quando há mudança
                if (currentCount !== count && count > 0) {
                    countElement.classList.add('animate-pulse');
                    setTimeout(() => {
                        countElement.classList.remove('animate-pulse');
                    }, 1000);
                }
            }
        }
        
        // Iniciar atualizações em tempo real quando a página carrega
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                startRealTimeUpdates();
                loadNotifications();
            }, 2000);
        });
        
        // Parar atualizações quando a página for fechada
        window.addEventListener('beforeunload', () => {
            stopRealTimeUpdates();
        });
        
        // Pausar atualizações quando a aba não estiver ativa
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                stopRealTimeUpdates();
            } else {
                startRealTimeUpdates();
            }
        });
        
        
        // Função para mostrar informações de debug do sistema de tempo real
        function showRealTimeDebugInfo() {
            const status = isRealTimeActive ? 'Ativo' : 'Inativo';
            const lastUpdate = lastUpdateTime ? lastUpdateTime.toLocaleTimeString('pt-BR') : 'Nunca';
            
            const debugInfo = `
🔄 Sistema de Atualização em Tempo Real

Status: ${status}
Atualizações realizadas: ${updateCount}
Última atualização: ${lastUpdate}
Intervalo: 5 segundos
Indicador visual: ${document.getElementById('realTimeIndicator')?.classList.contains('hidden') ? 'Oculto' : 'Visível'}

Funcionalidades:
✅ Contador de notificações
✅ Lista de solicitações de senha
✅ Contadores de estatísticas
✅ Indicador de status de conexão
✅ Pausa automática quando aba inativa
✅ Sistema totalmente automático
✅ Limpeza automática (24h)
✅ Modal de histórico
✅ Exclusão individual de solicitações (botão lixeira em cada card)
            `;
            
            console.log(debugInfo);
            showNotification(`Debug: ${status} - ${updateCount} atualizações`, 'info');
        }
        
        // Adicionar função global para debug
        window.showRealTimeDebugInfo = showRealTimeDebugInfo;
        
        // ==================== SISTEMA DE LIMPEZA AUTOMÁTICA E HISTÓRICO ====================
        
        // Função para limpeza automática de solicitações antigas (24 horas)
        async function cleanupOldPasswordRequests() {
            try {
                // // const supabase = await getSupabaseClient(); // REMOVIDO // REMOVIDO - usando MySQL
                const twentyFourHoursAgo = new Date();
                twentyFourHoursAgo.setHours(twentyFourHoursAgo.getHours() - 24);
                
                console.log('🧹 Iniciando limpeza automática de solicitações antigas...');
                
                // Buscar solicitações antigas
                const { data: oldRequests, error: fetchError } = await supabase
                    .from('password_requests')
                    .select('id, status, created_at')
                    .lt('created_at', twentyFourHoursAgo.toISOString());
                
                if (fetchError) {
                    console.error('❌ Erro ao buscar solicitações antigas:', fetchError);
                    return;
                }
                
                if (oldRequests && oldRequests.length > 0) {
                    console.log(`🗑️ Encontradas ${oldRequests.length} solicitações antigas para remover`);
                    
                    // Remover solicitações antigas
                    const { error: deleteError } = await supabase
                        .from('password_requests')
                        .delete()
                        .lt('created_at', twentyFourHoursAgo.toISOString());
                    
                    if (deleteError) {
                        console.error('❌ Erro ao remover solicitações antigas:', deleteError);
                    } else {
                        console.log(`✅ ${oldRequests.length} solicitações antigas removidas com sucesso`);
                        
                        // Atualizar interface se necessário
                        await loadNotifications();
                        const passwordModal = document.getElementById('passwordRequestsModal');
                        if (passwordModal && !passwordModal.classList.contains('hidden')) {
                            await loadPasswordRequests();
                        }
                    }
                } else {
                    console.log('✅ Nenhuma solicitação antiga encontrada');
                }
                
            } catch (error) {
                console.error('❌ Erro na limpeza automática:', error);
            }
        }
        
        // Função para abrir modal de histórico
        function openPasswordHistoryModal() {
            const modal = document.getElementById('passwordHistoryModal');
            if (modal) {
                modal.classList.remove('hidden');
                modal.style.display = 'flex';
                modal.style.zIndex = '99999';
                
                // Carregar histórico automaticamente
                loadPasswordHistory();
            }
        }
        
        // Função para fechar modal de histórico
        function closePasswordHistoryModal() {
            const modal = document.getElementById('passwordHistoryModal');
            if (modal) {
                modal.classList.add('hidden');
                modal.style.display = 'none';
                modal.style.zIndex = '-1';
            }
        }
        
        // Função para carregar histórico de solicitações
        async function loadPasswordHistory() {
            const btn = document.getElementById('refreshPasswordHistoryBtn');
            if (btn) {
                // Adicionar animação de loading
                btn.disabled = true;
                btn.innerHTML = `
                    <svg class="w-4 h-4 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                    <span>Atualizando...</span>
                `;
            }
            
            try {
                // // const supabase = await getSupabaseClient(); // REMOVIDO // REMOVIDO - usando MySQL
                const loadingElement = document.getElementById('historyLoading');
                const emptyElement = document.getElementById('emptyHistory');
                const listElement = document.getElementById('passwordHistoryList');
                
                // Mostrar loading
                if (loadingElement) loadingElement.classList.remove('hidden');
                if (emptyElement) emptyElement.classList.add('hidden');
                
                // Obter filtros
                const statusFilter = document.getElementById('historyStatusFilter')?.value || '';
                const daysFilter = parseInt(document.getElementById('historyDateFilter')?.value || '30');
                
                // Calcular data limite
                const dateLimit = new Date();
                dateLimit.setDate(dateLimit.getDate() - daysFilter);
                
                console.log('📚 Carregando histórico de solicitações...');
                
                // Buscar solicitações do histórico
                let query = supabase
                    .from('password_requests')
                    .select('*')
                    .gte('created_at', dateLimit.toISOString())
                    .order('created_at', { ascending: false });
                
                if (statusFilter) {
                    query = query.eq('status', statusFilter);
                }
                
                const { data: requests, error } = await query;
                
                if (error) {
                    console.error('❌ Erro ao carregar histórico:', error);
                    throw error;
                }
                
                console.log('📚 Histórico carregado:', requests);
                
                // Ocultar loading
                if (loadingElement) loadingElement.classList.add('hidden');
                
                if (!requests || requests.length === 0) {
                    // Mostrar empty state
                    if (emptyElement) emptyElement.classList.remove('hidden');
                    return;
                }
                
                // Buscar dados dos usuários para cada solicitação (com tratamento de erro melhorado)
                const historyWithUsers = [];
                for (const request of requests) {
                    try {
                        // Tentar buscar dados do usuário com tratamento de erro
                        const { data: userData, error: userError } = await supabase
                            .from('users')
                            .select('email, name')
                            .eq('id', request.user_id)
                            .maybeSingle(); // Usar maybeSingle para evitar erro se não encontrar
                        
                        if (userError) {
                            historyWithUsers.push({
                                ...request,
                                user_email: 'Email indisponível',
                                user_name: 'Usuário indisponível'
                            });
                        } else if (userData) {
                            historyWithUsers.push({
                                ...request,
                                user_email: userData.email || 'Email não encontrado',
                                user_name: userData.name || 'Usuário não encontrado'
                            });
                        } else {
                            historyWithUsers.push({
                                ...request,
                                user_email: 'Email não encontrado',
                                user_name: 'Usuário não encontrado'
                            });
                        }
                    } catch (userError) {
                        historyWithUsers.push({
                            ...request,
                            user_email: 'Email indisponível',
                            user_name: 'Usuário indisponível'
                        });
                    }
                }
                
                // Exibir histórico
                displayPasswordHistory(historyWithUsers);
                
            } catch (error) {
                console.error('❌ Erro ao carregar histórico:', error);
                const loadingElement = document.getElementById('historyLoading');
                if (loadingElement) loadingElement.classList.add('hidden');
            } finally {
                if (btn) {
                    // Restaurar botão
                    btn.disabled = false;
                    btn.innerHTML = `
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                        <span>Atualizar</span>
                    `;
                }
            }
        }
        
        // Função para exibir histórico de solicitações
        function displayPasswordHistory(requests) {
            const listElement = document.getElementById('passwordHistoryList');
            const emptyElement = document.getElementById('emptyHistory');
            
            if (!listElement) return;
            
            if (!requests || requests.length === 0) {
                if (emptyElement) emptyElement.classList.remove('hidden');
                return;
            }
            
            if (emptyElement) emptyElement.classList.add('hidden');
            
            listElement.innerHTML = requests.map(request => createHistoryCard(request)).join('');
        }
        
        // Função para criar card de histórico
        function createHistoryCard(request) {
            const statusColors = {
                approved: 'bg-green-100 text-green-800 bg-green-100/20 dark:text-green-400',
                rejected: 'bg-red-100 text-red-800 bg-red-100/20 text-red-600',
                pending: 'bg-yellow-100 text-yellow-800 bg-yellow-100/20 text-yellow-600'
            };
            
            const statusTexts = {
                approved: 'Aprovada',
                rejected: 'Rejeitada',
                pending: 'Pendente'
            };
            
            const typeTexts = {
                change: 'Alteração de Senha',
                reset: 'Redefinição de Senha'
            };
            
            const reasonTexts = {
                forgot: 'Esqueci a senha',
                security: 'Questões de segurança',
                update: 'Atualização regular',
                other: 'Outro motivo'
            };
            
            const createdDate = new Date(request.created_at);
            const formattedDate = createdDate.toLocaleDateString('pt-BR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            return `
                <div class="bg-white  rounded-xl border border-gray-200 border-gray-200 p-4 hover:shadow-lg transition-all duration-200">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <div class="flex items-center space-x-3 mb-2">
                                <span class="px-2 py-1 text-xs font-medium rounded-full ${statusColors[request.status]}">
                                    ${statusTexts[request.status]}
                                </span>
                                <span class="text-sm text-gray-500 ">
                                    ${typeTexts[request.type] || 'Tipo não especificado'}
                                </span>
                            </div>
                            
                            <div class="space-y-1">
                                <p class="font-medium text-gray-900 ">
                                    ${request.user_name || 'Usuário não encontrado'}
                                </p>
                                <p class="text-sm text-gray-600 ">
                                    ${request.user_email || 'Email não encontrado'}
                                </p>
                                <p class="text-sm text-gray-500 ">
                                    Motivo: ${reasonTexts[request.reason] || request.reason || 'Não especificado'}
                                </p>
                            </div>
                            
                            ${request.notes ? `
                                <div class="mt-2 p-2 bg-gray-50 bg-white rounded-lg">
                                    <p class="text-sm text-gray-700 ">
                                        ${request.notes.length > 100 ? request.notes.substring(0, 100) + '...' : request.notes}
                                    </p>
                                </div>
                            ` : ''}
                        </div>
                        
                        <div class="text-right">
                            <p class="text-sm text-gray-500 ">
                                ${formattedDate}
                            </p>
                            ${request.approved_by ? `
                                <p class="text-xs text-gray-400  mt-1">
                                    Processado por: ${request.approved_by}
                                </p>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Executar limpeza automática a cada hora
        setInterval(cleanupOldPasswordRequests, 60 * 60 * 1000); // 1 hora
        
        // Executar limpeza inicial após 5 segundos
        setTimeout(cleanupOldPasswordRequests, 5000);
        
        // Função para alternar visibilidade da senha
        function togglePasswordVisibility(button) {
            const input = button.previousElementSibling;
            const icon = button.querySelector('svg');
            
            if (input.type === 'password') {
                input.type = 'text';
                icon.innerHTML = `
                    <path stroke-linecap="round" stroke-linejoin="round" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.878 9.878L3 3m6.878 6.878L21 21"></path>
                `;
            } else {
                input.type = 'password';
                icon.innerHTML = `
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                `;
            }
        }
        
        // Função para excluir solicitação individual
        async function deletePasswordRequest(requestId) {
            try {
                // Mostrar confirmação
                const confirmed = confirm('Tem certeza que deseja excluir esta solicitação? Esta ação não pode ser desfeita.');
                if (!confirmed) return;
                
                // // const supabase = await getSupabaseClient(); // REMOVIDO // REMOVIDO - usando MySQL
                
                console.log('🗑️ Excluindo solicitação:', requestId);
                
                // Excluir solicitação
                const { error } = await supabase
                    .from('password_requests')
                    .delete()
                    .eq('id', requestId);
                
                if (error) {
                    console.error('❌ Erro ao excluir solicitação:', error);
                    showNotification('Erro ao excluir solicitação', 'error');
                    return;
                }
                
                console.log('✅ Solicitação excluída com sucesso');
                showNotification('Solicitação excluída com sucesso', 'success');
                
                // Atualizar interface
                await loadNotifications();
                await loadPasswordRequests();
                
                // Atualizar histórico se estiver aberto
                const historyModal = document.getElementById('passwordHistoryModal');
                if (historyModal && !historyModal.classList.contains('hidden')) {
                    await loadPasswordHistory();
                }
                
            } catch (error) {
                console.error('❌ Erro ao excluir solicitação:', error);
                showNotification('Erro ao excluir solicitação', 'error');
            }
        }
        
        // Função para excluir múltiplas solicitações
        async function deleteMultiplePasswordRequests(requestIds) {
            try {
                if (!requestIds || requestIds.length === 0) {
                    showNotification('Nenhuma solicitação selecionada', 'warning');
                    return;
                }
                
                const confirmed = confirm(`Tem certeza que deseja excluir ${requestIds.length} solicitação(ões)? Esta ação não pode ser desfeita.`);
                if (!confirmed) return;
                
                // // const supabase = await getSupabaseClient(); // REMOVIDO // REMOVIDO - usando MySQL
                
                console.log('🗑️ Excluindo múltiplas solicitações:', requestIds);
                
                // Excluir múltiplas solicitações
                const { error } = await supabase
                    .from('password_requests')
                    .delete()
                    .in('id', requestIds);
                
                if (error) {
                    console.error('❌ Erro ao excluir solicitações:', error);
                    showNotification('Erro ao excluir solicitações', 'error');
                    return;
                }
                
                console.log(`✅ ${requestIds.length} solicitações excluídas com sucesso`);
                showNotification(`${requestIds.length} solicitações excluídas com sucesso`, 'success');
                
                // Atualizar interface
                await loadNotifications();
                await loadPasswordRequests();
                
                // Atualizar histórico se estiver aberto
                const historyModal = document.getElementById('passwordHistoryModal');
                if (historyModal && !historyModal.classList.contains('hidden')) {
                    await loadPasswordHistory();
                }
                
            } catch (error) {
                console.error('❌ Erro ao excluir solicitações:', error);
                showNotification('Erro ao excluir solicitações', 'error');
            }
        }
        
        
        // Event listeners para filtros do histórico
        document.addEventListener('DOMContentLoaded', () => {
            const statusFilter = document.getElementById('historyStatusFilter');
            const dateFilter = document.getElementById('historyDateFilter');
            
            if (statusFilter) {
                statusFilter.addEventListener('change', loadPasswordHistory);
            }
            
            if (dateFilter) {
                dateFilter.addEventListener('change', loadPasswordHistory);
            }
        });
        
        // ==================== FUNÇÃO CORRIGIDA PARA EXIBIR SOLICITAÇÕES ====================
        
        // Função corrigida para exibir solicitações
        function displayPasswordRequestsFixed(requests) {
            console.log('📋 Exibindo solicitações:', requests);
            console.log('📋 Número de solicitações:', requests?.length || 0);
            
            const container = document.getElementById('passwordRequestsList');
            const emptyState = document.getElementById('emptyPasswordRequests');
            const modal = document.getElementById('passwordRequestsModal');
            
            console.log('📋 Container encontrado:', !!container);
            console.log('📋 Empty state encontrado:', !!emptyState);
            console.log('📋 Modal encontrado:', !!modal);
            console.log('📋 Modal visível:', modal ? !modal.classList.contains('hidden') : false);
            
            if (!container) {
                console.error('❌ Container passwordRequestsList não encontrado');
                return;
            }
            
            if (!emptyState) {
                console.error('❌ EmptyState emptyPasswordRequests não encontrado');
                return;
            }
            
            // Se o modal não estiver visível, não exibir as solicitações
            if (modal && modal.classList.contains('hidden')) {
                console.log('📋 Modal não está visível, não exibindo solicitações');
                return;
            }
            
            // Atualizar contadores
            updateRequestCounters(requests || []);
            
            if (!requests || requests.length === 0) {
                container.innerHTML = '';
                emptyState.classList.remove('hidden');
                console.log('📝 Nenhuma solicitação encontrada');
                return;
            }
            
            emptyState.classList.add('hidden');
            container.innerHTML = '';
            
            requests.forEach((request, index) => {
                console.log(`📄 Criando card para solicitação ${index + 1}:`, request);
                
                const card = document.createElement('div');
                card.className = 'bg-white bg-white border border-gray-200 border-gray-200 rounded-xl p-4 shadow-lg hover:shadow-xl transition-all duration-300 hover:scale-[1.01] hover:border-blue-300 hover:border-blue-300';
                
                const statusColors = {
                    'pending': 'bg-yellow-100 text-yellow-800 bg-yellow-100/20 text-yellow-800',
                    'approved': 'bg-green-100 text-green-800 bg-green-100/20 text-green-800',
                    'rejected': 'bg-red-100 text-red-800 bg-red-100/20 text-red-800'
                };
                
                const statusText = {
                    'pending': 'Pendente',
                    'approved': 'Aprovada',
                    'rejected': 'Rejeitada'
                };
                
                const userName = request.users?.name || request.users?.email || 'Usuário desconhecido';
                const userEmail = request.users?.email || 'Email não disponível';
                
                // Extrair a nova senha das notas ou do campo new_password
                let newPassword = '';
                if (request.new_password) {
                    newPassword = request.new_password;
                } else if (request.notes && request.notes.includes('NOVA SENHA:')) {
                    const passwordMatch = request.notes.match(/NOVA SENHA:\s*([^\n\r]+)/);
                    newPassword = passwordMatch ? passwordMatch[1].trim() : '';
                }
                
                card.innerHTML = `
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <!-- Header do card -->
                            <div class="flex items-center justify-between mb-3">
                                <div class="flex items-center space-x-3">
                                    <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-600 rounded-lg flex items-center justify-center">
                                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                        </svg>
                                    </div>
                                    <div>
                                        <h4 class="text-base font-bold text-gray-900 ">${userName}</h4>
                                        <p class="text-xs text-gray-600 ">${userEmail}</p>
                                    </div>
                                </div>
                                <span class="px-2 py-1 text-xs font-semibold rounded-full ${statusColors[request.status] || statusColors.pending}">
                                    ${statusText[request.status] || 'Pendente'}
                                </span>
                            </div>
                            
                            <!-- Motivo -->
                            <div class="mb-3">
                                <p class="text-sm text-gray-700 ">
                                    <span class="font-semibold text-gray-900 ">Motivo:</span> ${request.reason || 'Não informado'}
                                </p>
                            </div>
                            
                            <!-- Nova Senha -->
                            ${newPassword ? `
                                <div class="bg-gradient-to-r from-blue-50 to-purple-50 from-blue-50 to-purple-50 border border-blue-200 border-blue-200 rounded-lg p-3 mb-3">
                                    <div class="flex items-center justify-between mb-2">
                                        <span class="text-xs font-semibold text-blue-800 text-blue-800">Nova Senha:</span>
                                        <button onclick="togglePasswordVisibility('${request.id}')" class="p-1 text-blue-600 hover:text-blue-800 text-blue-600 hover:bg-blue-100 hover:bg-blue-100 rounded transition-all">
                                            <svg id="eye-${request.id}" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                                <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                                <path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                            </svg>
                                        </button>
                                    </div>
                                    <div id="password-${request.id}" class="text-sm text-blue-700 dark:text-blue-300 font-mono bg-white  rounded p-2 border" style="display: none;">
                                        ${newPassword}
                                    </div>
                                    <div id="password-hidden-${request.id}" class="text-sm text-blue-700 dark:text-blue-300 font-mono bg-white  rounded p-2 border">
                                        ••••••••
                                    </div>
                                </div>
                            ` : ''}
                            
                            <!-- Data -->
                            <div class="flex items-center text-xs text-gray-500 ">
                                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                ${new Date(request.created_at).toLocaleString('pt-BR')}
                            </div>
                        </div>
                        
                        <!-- Botões de ação -->
                        <div class="flex flex-col space-y-2 ml-4">
                            <button onclick="viewPasswordRequestDetails('${request.id}')" class="px-3 py-1.5 text-xs bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white rounded-lg transition-all font-medium shadow hover:shadow-md">
                                Ver Detalhes
                            </button>
                            ${request.status === 'pending' ? `
                                <button onclick="approvePasswordRequestDirect('${request.id}')" class="px-3 py-1.5 text-xs bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white rounded-lg transition-all font-medium shadow hover:shadow-md">
                                    ✓ Aprovar
                                </button>
                                <button onclick="rejectPasswordRequestDirect('${request.id}')" class="px-3 py-1.5 text-xs bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white rounded-lg transition-all font-medium shadow hover:shadow-md">
                                    ✗ Rejeitar
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
                
                container.appendChild(card);
            });
            
            console.log(`✅ ${requests.length} solicitações exibidas com sucesso`);
        }
        
        // Substituir as funções pelas versões corrigidas
        window.displayPasswordRequests = displayPasswordRequestsFixed;
        window.viewPasswordRequestDetails = viewPasswordRequestDetailsFixed;
        
        // Funções diretas para aprovar e rejeitar (sem depender de currentPasswordRequestId)
        window.approvePasswordRequestDirect = async function(requestId) {
            if (!requestId) {
                showNotification('ID da solicitação não encontrado', 'error');
                return;
            }
            
            try {
                // // const supabase = await getSupabaseClient(); // REMOVIDO // REMOVIDO - usando MySQL
                const { data: { user } } = await supabase.auth.getUser();
                
                if (!user) {
                    showNotification('Usuário não autenticado', 'error');
                    return;
                }
                
                // Primeiro, buscar a solicitação para obter a nova senha
                const { data: request, error: fetchError } = await supabase
                    .from('password_requests')
                    .select('*')
                    .eq('id', requestId)
                    .single();
                
                if (fetchError || !request) {
                    showNotification('Erro ao buscar solicitação', 'error');
                    return;
                }
                
                // Verificar se a solicitação ainda está pendente
                if (request.status !== 'pending') {
                    showNotification('Esta solicitação já foi processada', 'warning');
                    return;
                }
                
                // Obter a nova senha (pode estar em new_password ou em notes)
                let newPassword = request.new_password;
                if (!newPassword && request.notes && request.notes.includes('NOVA SENHA:')) {
                    newPassword = request.notes.split('NOVA SENHA: ')[1]?.split('\n')[0];
                }
                
                if (!newPassword) {
                    showNotification('Nova senha não encontrada na solicitação', 'error');
                    return;
                }
                
                console.log('🔑 Aprovando solicitação e alterando senha...');
                console.log('User ID:', request.user_id);
                console.log('Nova senha:', newPassword);
                
                // Tentar atualizar a senha usando RPC function (alternativa ao admin)
                try {
                    const { error: updatePasswordError } = await supabase.rpc('update_user_password', {
                        user_id: request.user_id,
                        new_password: newPassword
                    });
                    
                    if (updatePasswordError) {
                        
                        // Método alternativo: atualizar na tabela auth.users diretamente
                        const { error: directUpdateError } = await supabase
                            .from('auth.users')
                            .update({ encrypted_password: newPassword })
                            .eq('id', request.user_id);
                        
                        if (directUpdateError) {
                            
                            // Fallback: apenas marcar como aprovado e notificar o usuário
                            showNotification('Solicitação aprovada. A senha será alterada pelo sistema automaticamente.', 'success');
                        } else {
                            console.log('✅ Senha atualizada via método direto');
                            showNotification('Solicitação aprovada e senha alterada com sucesso!', 'success');
                        }
                    } else {
                        console.log('✅ Senha atualizada via RPC function');
                        showNotification('Solicitação aprovada e senha alterada com sucesso!', 'success');
                    }
                } catch (rpcError) {
                    showNotification('Solicitação aprovada. A senha será alterada pelo sistema automaticamente.', 'success');
                }
                
                // Atualizar status da solicitação
                const { error: updateRequestError } = await supabase
                    .from('password_requests')
                    .update({
                        status: 'approved',
                        approved_at: new Date().toISOString(),
                        approved_by: user.id
                    })
                    .eq('id', requestId);
                
                if (updateRequestError) {
                    console.error('Erro ao atualizar solicitação:', updateRequestError);
                    showNotification('Senha alterada, mas erro ao atualizar solicitação', 'warning');
                    return;
                }
                
                // Garantir que o usuário está ativo após aprovação
                const { error: userError } = await supabase
                    .from('users')
                    .update({
                        is_active: true,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', request.user_id);
                
                if (userError) {
                    console.warn('Aviso: Não foi possível ativar o usuário:', userError);
                } else {
                    console.log('✅ Usuário ativado após aprovação da solicitação');
                }
                
                console.log('✅ Solicitação aprovada com sucesso!');
                
                // Log de auditoria
                logAuditEvent('password_request_approved', request.user_id, {
                    requestId: requestId,
                    managerId: user.id,
                    newPasswordLength: newPassword.length,
                    reason: request.reason
                });
                
                // Notificar o usuário sobre a alteração de senha e logout automático
                await notifyUserPasswordChanged(request.user_id, newPassword);
                
                // Limpar cache para forçar atualização
                clearCache();
                
                // Mover card para baixo e marcar como aprovado
                moveCardToBottom(requestId, 'approved');
                
                // Fechar modal se estiver aberto
                closePasswordRequestDetailsModal();
                
                // Remover card após 10 minutos
                setTimeout(() => {
                    removeCard(requestId);
                }, 10 * 60 * 1000); // 10 minutos
                
            } catch (error) {
                console.error('Erro ao aprovar solicitação:', error);
                showNotification('Erro ao aprovar solicitação: ' + error.message, 'error');
            }
        };
        
        window.rejectPasswordRequestDirect = async function(requestId) {
            if (!requestId) {
                showNotification('ID da solicitação não encontrado', 'error');
                return;
            }
            
            try {
                // // const supabase = await getSupabaseClient(); // REMOVIDO // REMOVIDO - usando MySQL
                const { data: { user } } = await supabase.auth.getUser();
                
                if (!user) {
                    showNotification('Usuário não autenticado', 'error');
                    return;
                }
                
                // Validar sessão do gerente
                const sessionValidation = await validateManagerSession();
                if (!sessionValidation.valid) {
                    showNotification('Sessão inválida. Faça login novamente.', 'error');
                    return;
                }
                
                // Atualizar status da solicitação
                const { error } = await supabase
                    .from('password_requests')
                    .update({
                        status: 'rejected',
                        rejected_at: new Date().toISOString(),
                        rejected_by: user.id
                    })
                    .eq('id', requestId);
                
                if (error) throw error;
                
                showNotification('Solicitação rejeitada com sucesso!', 'success');
                
                // Mover card para baixo e marcar como rejeitado
                moveCardToBottom(requestId, 'rejected');
                
                // Fechar modal se estiver aberto
                closePasswordRequestDetailsModal();
                
                // Remover card após 10 minutos
                setTimeout(() => {
                    removeCard(requestId);
                }, 10 * 60 * 1000); // 10 minutos
                
            } catch (error) {
                console.error('Erro ao rejeitar solicitação:', error);
                showNotification('Erro ao rejeitar solicitação: ' + error.message, 'error');
            }
        };
        
        // Função para mover card para baixo
        function moveCardToBottom(requestId, status) {
            const container = document.getElementById('passwordRequestsList');
            if (!container) return;
            
            // Encontrar o card pelo ID específico nos botões
            const cards = Array.from(container.children);
            const targetCard = cards.find(card => {
                const buttons = card.querySelectorAll('button[onclick*="' + requestId + '"]');
                return buttons.length > 0;
            });
            
            if (targetCard) {
                // Remover o card da posição atual
                targetCard.remove();
                
                // Atualizar o visual do card para mostrar o novo status
                updateCardStatus(targetCard, status);
                
                // Adicionar no final da lista
                container.appendChild(targetCard);
                
                console.log(`📋 Card movido para baixo: ${requestId} - Status: ${status}`);
            } else {
            }
        }
        
        // Função para atualizar o status visual do card
        function updateCardStatus(card, status) {
            const statusSpan = card.querySelector('span[class*="bg-"]');
            if (statusSpan) {
                const statusColors = {
                    'approved': 'bg-green-100 text-green-800 bg-green-100/20 text-green-800',
                    'rejected': 'bg-red-100 text-red-800 bg-red-100/20 text-red-800'
                };
                
                const statusText = {
                    'approved': 'APROVADA',
                    'rejected': 'REJEITADA'
                };
                
                statusSpan.className = `px-2 py-1 text-xs font-semibold rounded-full ${statusColors[status]}`;
                statusSpan.textContent = statusText[status];
            }
            
            // Remover botões de ação
            const actionButtons = card.querySelector('.flex.flex-col.space-y-2.ml-4');
            if (actionButtons) {
                actionButtons.innerHTML = '<div class="text-xs text-gray-500 ">Processada</div>';
            }
        }
        
        // Função para remover card completamente
        function removeCard(requestId) {
            const container = document.getElementById('passwordRequestsList');
            if (!container) return;
            
            const cards = Array.from(container.children);
            const targetCard = cards.find(card => {
                const buttons = card.querySelectorAll('button[onclick*="' + requestId + '"]');
                return buttons.length > 0;
            });
            
            if (targetCard) {
                targetCard.remove();
                console.log(`🗑️ Card removido após 10 minutos: ${requestId}`);
            }
        }
        
        // Funções principais para aprovar e rejeitar solicitações
        window.approvePasswordRequest = async function(requestId) {
            if (!requestId) {
                requestId = window.currentPasswordRequestId;
            }
            
            if (!requestId) {
                showNotification('ID da solicitação não encontrado', 'error');
                return;
            }
            
            try {
                // // const supabase = await getSupabaseClient(); // REMOVIDO // REMOVIDO - usando MySQL
                const { data: { user } } = await supabase.auth.getUser();
                
                if (!user) {
                    showNotification('Usuário não autenticado', 'error');
                    return;
                }
                
                // Primeiro, obter dados da solicitação para pegar o user_id
                const { data: requestData, error: requestError } = await supabase
                    .from('password_requests')
                    .select('user_id')
                    .eq('id', requestId)
                    .single();
                
                if (requestError) throw requestError;
                
                // Atualizar status da solicitação
                const { error } = await supabase
                    .from('password_requests')
                    .update({
                        status: 'approved',
                        approved_at: new Date().toISOString(),
                        approved_by: user.id
                    })
                    .eq('id', requestId);
                
                if (error) throw error;
                
                // Garantir que o usuário está ativo após aprovação
                if (requestData.user_id) {
                    const { error: userError } = await supabase
                        .from('users')
                        .update({
                            is_active: true,
                            updated_at: new Date().toISOString()
                        })
                        .eq('id', requestData.user_id);
                    
                    if (userError) {
                        console.warn('Aviso: Não foi possível ativar o usuário:', userError);
                    } else {
                        console.log('✅ Usuário ativado após aprovação da solicitação');
                    }
                }
                
                // Log de auditoria
                logAuditEvent('password_request_approved', requestId, {
                    managerId: user.id,
                    reason: 'manager_approval'
                });
                
                // Limpar cache para forçar atualização
                clearPasswordRequestsCache();
                
                // Recarregar lista
                await displayPasswordRequests();
                
                // Fechar modal de detalhes se estiver aberto
                const modal = document.getElementById('passwordRequestDetailsModal');
                if (modal && !modal.classList.contains('hidden')) {
                    closePasswordRequestDetailsModal();
                }
                
                showNotification('Solicitação aprovada com sucesso!', 'success');
                
            } catch (error) {
                console.error('Erro ao aprovar solicitação:', error);
                showNotification('Erro ao aprovar solicitação: ' + error.message, 'error');
            }
        };
        
        window.rejectPasswordRequest = async function(requestId) {
            if (!requestId) {
                requestId = window.currentPasswordRequestId;
            }
            
            if (!requestId) {
                showNotification('ID da solicitação não encontrado', 'error');
                return;
            }
            
            try {
                // // const supabase = await getSupabaseClient(); // REMOVIDO // REMOVIDO - usando MySQL
                const { data: { user } } = await supabase.auth.getUser();
                
                if (!user) {
                    showNotification('Usuário não autenticado', 'error');
                    return;
                }
                
                // Atualizar status da solicitação
                const { error } = await supabase
                    .from('password_requests')
                    .update({
                        status: 'rejected',
                        rejected_at: new Date().toISOString(),
                        rejected_by: user.id
                    })
                    .eq('id', requestId);
                
                if (error) throw error;
                
                // Log de auditoria
                logAuditEvent('password_request_rejected', requestId, {
                    managerId: user.id,
                    reason: 'manager_rejection'
                });
                
                // Limpar cache para forçar atualização
                clearPasswordRequestsCache();
                
                // Recarregar lista
                await displayPasswordRequests();
                
                // Fechar modal de detalhes se estiver aberto
                const modal = document.getElementById('passwordRequestDetailsModal');
                if (modal && !modal.classList.contains('hidden')) {
                    closePasswordRequestDetailsModal();
                }
                
                showNotification('Solicitação rejeitada com sucesso!', 'success');
                
            } catch (error) {
                console.error('Erro ao rejeitar solicitação:', error);
                showNotification('Erro ao rejeitar solicitação: ' + error.message, 'error');
            }
        };
        
        
        function togglePasswordVisibility(requestId) {
            const passwordElement = document.getElementById(`password-${requestId}`);
            const passwordHiddenElement = document.getElementById(`password-hidden-${requestId}`);
            const eyeIcon = document.getElementById(`eye-${requestId}`);
            
            if (passwordElement && passwordHiddenElement && eyeIcon) {
                if (passwordElement.style.display === 'none') {
                    passwordElement.style.display = 'block';
                    passwordHiddenElement.style.display = 'none';
                    eyeIcon.innerHTML = `
                        <path stroke-linecap="round" stroke-linejoin="round" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.878 9.878L8.464 8.464M9.878 9.878a3 3 0 00-.007 4.243m4.242-4.242L15.536 8.464M14.122 14.121a3 3 0 00-.007-4.243M14.122 14.121L15.536 15.536M14.122 14.121l-4.243 4.243m6.364-6.364L21.878 21.878m-6.364-6.364l-4.243-4.243m0 0L2.878 2.878 21.878 21.878"></path>
                    `;
                } else {
                    passwordElement.style.display = 'none';
                    passwordHiddenElement.style.display = 'block';
                    eyeIcon.innerHTML = `
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                    `;
                }
            }
        }
        
        window.togglePasswordVisibility = togglePasswordVisibility;
        
        
        
        // Logs de auditoria para o gerente
        function logAuditEvent(action, userId, details = {}) {
            const logEntry = {
                timestamp: new Date().toISOString(),
                action,
                userId,
                managerId: details.managerId || 'unknown',
                ip: details.ip || 'unknown',
                userAgent: navigator.userAgent,
                details
            };
            
            console.log(`[AUDIT] ${action} by manager:`, logEntry);
            
            // Armazenar no localStorage para persistência
            const auditLogs = JSON.parse(localStorage.getItem('manager_audit_logs') || '[]');
            auditLogs.push(logEntry);
            
            // Manter apenas os últimos 200 logs
            if (auditLogs.length > 200) {
                auditLogs.splice(0, auditLogs.length - 200);
            }
            
            localStorage.setItem('manager_audit_logs', JSON.stringify(auditLogs));
        }
        
        // Validação de sessão do gerente
        async function validateManagerSession() {
            try {
                // // const supabase = await getSupabaseClient(); // REMOVIDO // REMOVIDO - usando MySQL
                const { data: { user } } = await supabase.auth.getUser();
                
                if (!user) {
                    return { valid: false, reason: 'not_authenticated' };
                }
                
                // Verificar se o usuário ainda é um gerente ativo
                const { data: userData, error } = await supabase
                    .from('users')
                    .select('role, is_active, last_activity')
                    .eq('id', user.id)
                    .single();
                
                if (error || !userData) {
                    return { valid: false, reason: 'user_not_found' };
                }
                
                if (userData.role !== 'gerente') {
                    return { valid: false, reason: 'not_manager' };
                }
                
                if (!userData.is_active) {
                    return { valid: false, reason: 'inactive_user' };
                }
                
                return { valid: true, userData };
                
            } catch (error) {
                console.error('Erro ao validar sessão do gerente:', error);
                return { valid: false, reason: 'validation_error' };
            }
        }
        
        // Função para notificar usuário sobre alteração de senha
        async function notifyUserPasswordChanged(userId, newPassword) {
            try {
                // // const supabase = await getSupabaseClient(); // REMOVIDO // REMOVIDO - usando MySQL
                
                // Validar sessão do gerente
                const sessionValidation = await validateManagerSession();
                if (!sessionValidation.valid) {
                    console.error('Sessão do gerente inválida:', sessionValidation.reason);
                    return;
                }
                
                // Buscar dados do usuário
                const { data: userData, error: userError } = await supabase
                    .from('users')
                    .select('email, name')
                    .eq('id', userId)
                    .single();
                
                if (userError || !userData) {
                    console.error('Erro ao buscar dados do usuário:', userError);
                    return;
                }
                
                // Criar notificação para o usuário
                const { error: notificationError } = await supabase
                    .from('notifications')
                    .insert([{
                        user_id: userId,
                        type: 'password_changed',
                        title: 'Senha Alterada com Sucesso',
                        message: `Sua senha foi alterada com sucesso. Por segurança, você será deslogado automaticamente. Use a nova senha para fazer login novamente.`,
                        data: {
                            new_password: newPassword,
                            auto_logout: true,
                            logout_reason: 'password_changed'
                        },
                        is_read: false
                    }]);
                
                if (notificationError) {
                    console.error('Erro ao criar notificação:', notificationError);
                } else {
                    console.log('✅ Notificação de alteração de senha criada para o usuário');
                }
                
                // Criptografar a nova senha antes de armazenar
                const encryptedPassword = await encryptPassword(newPassword);
                
                // Enviar sinal para logout automático (usando WebSocket ou Server-Sent Events se disponível)
                // Por enquanto, vamos usar uma abordagem simples com localStorage
                const logoutSignal = {
                    userId: userId,
                    reason: 'password_changed',
                    timestamp: new Date().toISOString(),
                    newPassword: encryptedPassword,
                    encrypted: true
                };
                
                // Armazenar sinal de logout no localStorage (será verificado pelos outros usuários)
                const existingSignals = JSON.parse(localStorage.getItem('password_change_signals') || '[]');
                existingSignals.push(logoutSignal);
                localStorage.setItem('password_change_signals', JSON.stringify(existingSignals));
                
                console.log('🔔 Sinal de logout automático enviado para o usuário:', userId);
                
            } catch (error) {
                console.error('Erro ao notificar usuário sobre alteração de senha:', error);
            }
        }
        
        // Tornar função global
        window.notifyUserPasswordChanged = notifyUserPasswordChanged;
        
        // Sistema de indicadores de progresso
        function showProgressIndicator(message, progress = 0) {
            // Remover indicador existente
            const existingIndicator = document.getElementById('progressIndicator');
            if (existingIndicator) {
                existingIndicator.remove();
            }
            
            // Criar novo indicador
            const indicator = document.createElement('div');
            indicator.id = 'progressIndicator';
            indicator.className = 'fixed top-4 right-4 bg-white  rounded-xl shadow-2xl p-4 z-[99999] min-w-[300px]';
            indicator.innerHTML = `
                <div class="flex items-center space-x-3">
                    <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center">
                        <svg class="w-4 h-4 text-white animate-spin" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </div>
                    <div class="flex-1">
                        <p class="text-sm font-medium text-gray-900 ">${message}</p>
                        <div class="mt-2 bg-gray-200 bg-white rounded-full h-2">
                            <div class="bg-blue-500 h-2 rounded-full transition-all duration-300" style="width: ${progress}%"></div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(indicator);
            return indicator;
        }
        
        function updateProgressIndicator(progress, message = null) {
            const indicator = document.getElementById('progressIndicator');
            if (!indicator) return;
            
            const progressBar = indicator.querySelector('.bg-blue-500');
            const messageElement = indicator.querySelector('p');
            
            if (progressBar) {
                progressBar.style.width = `${progress}%`;
            }
            
            if (message && messageElement) {
                messageElement.textContent = message;
            }
        }
        
        function hideProgressIndicator() {
            const indicator = document.getElementById('progressIndicator');
            if (indicator) {
                indicator.remove();
            }
        }
        
        // Confirmações inteligentes baseadas no contexto
        function getConfirmationMessage(request, action) {
            const userEmail = request.users?.email || 'usuário';
            const requestAge = Math.floor((Date.now() - new Date(request.created_at)) / (1000 * 60 * 60)); // horas
            
            if (action === 'approve') {
                if (requestAge < 1) {
                    return `Aprovar solicitação de ${userEmail}? Esta solicitação foi feita há menos de 1 hora.`;
                } else if (requestAge < 24) {
                    return `Aprovar solicitação de ${userEmail}? Esta solicitação foi feita há ${requestAge} horas.`;
                } else {
                    return `Aprovar solicitação de ${userEmail}? Esta solicitação foi feita há ${Math.floor(requestAge / 24)} dias.`;
                }
            } else if (action === 'reject') {
                return `Rejeitar solicitação de ${userEmail}? Esta ação não pode ser desfeita.`;
            }
            
            return `Confirmar ${action} para ${userEmail}?`;
        }
        
        // Atalhos de teclado
        document.addEventListener('keydown', (e) => {
            // Ctrl + Enter para aprovar solicitação
            if (e.ctrlKey && e.key === 'Enter') {
                // Verificar se há uma solicitação selecionada
                if (window.currentPasswordRequestId) {
                const approveButton = document.querySelector('button[onclick*="approvePasswordRequest"]');
                if (approveButton && !approveButton.disabled) {
                    e.preventDefault();
                    approveButton.click();
                    }
                } else {
                    e.preventDefault();
                    showNotification('Nenhuma solicitação selecionada. Abra o modal de solicitações primeiro.', 'warning');
                }
            }
            
            // Ctrl + R para rejeitar solicitação
            if (e.ctrlKey && e.key === 'r') {
                // Verificar se há uma solicitação selecionada
                if (window.currentPasswordRequestId) {
                const rejectButton = document.querySelector('button[onclick*="rejectPasswordRequest"]');
                if (rejectButton && !rejectButton.disabled) {
                    e.preventDefault();
                    rejectButton.click();
                    }
                } else {
                    e.preventDefault();
                    showNotification('Nenhuma solicitação selecionada. Abra o modal de solicitações primeiro.', 'warning');
                }
            }
            
            // Escape para fechar modais
            if (e.key === 'Escape') {
                const openModal = document.querySelector('.modal:not(.hidden)');
                if (openModal) {
                    const closeButton = openModal.querySelector('button[onclick*="close"]');
                    if (closeButton) {
                        closeButton.click();
                    }
                }
            }
        });
        
        // Sistema de cache otimizado para melhorar performance
        const requestsCache = new Map();
        const CACHE_DURATION = 10 * 60 * 1000; // 10 minutos em vez de 5
        let lastCacheUpdate = 0;
        const MIN_CACHE_UPDATE_INTERVAL = 2 * 60 * 1000; // 2 minutos mínimo entre atualizações
        
        function getCachedRequests() {
            const cached = requestsCache.get('password_requests');
            if (cached && Date.now() - cached.timestamp < CACHE_DURATION) {
                return cached.data;
            }
            return null;
        }
        
        function setCachedRequests(data) {
            const now = Date.now();
            // Evitar atualizações muito frequentes do cache
            if (now - lastCacheUpdate < MIN_CACHE_UPDATE_INTERVAL) {
                return;
            }
            lastCacheUpdate = now;
            
            requestsCache.set('password_requests', {
                data,
                timestamp: now
            });
        }
        
        function clearCache() {
            requestsCache.clear();
            lastCacheUpdate = 0;
        }
        
        // Função otimizada para carregar solicitações com cache
        let isLoadingRequests = false;
        
        async function loadPasswordRequestsWithCache(forceRefresh = false) {
            console.log('🔄 Iniciando carregamento de solicitações...', forceRefresh ? '(forçando refresh)' : '');
            
            // Evitar múltiplas chamadas simultâneas
            if (isLoadingRequests) {
                console.log('⏳ Carregamento já em andamento, aguardando...');
                return;
            }
            
            // Verificar cache primeiro (a menos que seja forçado)
            if (!forceRefresh) {
                const cached = getCachedRequests();
                if (cached) {
                    console.log('📦 Carregando solicitações do cache:', cached.length, 'solicitações');
                    displayPasswordRequests(cached);
                    return;
                }
            } else {
                console.log('🔄 Forçando refresh - ignorando cache');
                clearCache();
            }
            
            console.log('🌐 Buscando dados do servidor...');
            isLoadingRequests = true;
            
            try {
                // // const supabase = await getSupabaseClient(); // REMOVIDO // REMOVIDO - usando MySQL
                const { data: { user } } = await supabase.auth.getUser();
                
                if (!user) {
                    console.error('❌ Usuário não autenticado');
                    showNotification('Usuário não autenticado', 'error');
                    return;
                }
                
                console.log('👤 Usuário autenticado:', user.id);
                
                // Buscar dados do usuário atual para obter farm_id
                const { data: userData, error: userError } = await supabase
                    .from('users')
                    .select('farm_id')
                    .eq('id', user.id)
                    .single();
                
                if (userError || !userData?.farm_id) {
                    console.error('❌ Erro ao buscar dados da fazenda:', userError);
                    showNotification('Erro ao buscar dados da fazenda', 'error');
                    return;
                }
                
                console.log('🏡 Farm ID encontrado:', userData.farm_id);
                
                // Buscar solicitações de senha da fazenda (abordagem corrigida)
                // Primeiro, buscar usuários da fazenda
                const { data: farmUsers, error: usersError } = await supabase
                    .from('users')
                    .select('id, name, email, role, profile_photo_url')
                    .eq('farm_id', userData.farm_id);
                
                if (usersError) {
                    console.error('❌ Erro ao buscar usuários da fazenda:', usersError);
                    showNotification('Erro ao buscar usuários da fazenda', 'error');
                    return;
                }
                
                if (!farmUsers || farmUsers.length === 0) {
                    console.log('📝 Nenhum usuário encontrado na fazenda');
                    displayPasswordRequests([]);
                    return;
                }
                
                const userIds = farmUsers.map(user => user.id);
                
                // Depois, buscar solicitações desses usuários
                const { data: requests, error } = await supabase
                    .from('password_requests')
                    .select('*')
                    .in('user_id', userIds)
                    .order('created_at', { ascending: false });
                
                if (error) {
                    console.error('❌ Erro ao buscar solicitações:', error);
                    showNotification('Erro ao carregar solicitações', 'error');
                    return;
                }
                
                console.log('✅ Solicitações carregadas:', requests?.length || 0, 'solicitações');
                
                // Combinar dados das solicitações com dados dos usuários
                const requestsWithUsers = (requests || []).map(request => {
                    const user = farmUsers.find(u => u.id === request.user_id);
                    return {
                        ...request,
                        users: user || { name: 'Usuário não encontrado', email: '', role: 'unknown' }
                    };
                });
                
                console.log('✅ Solicitações combinadas com usuários:', requestsWithUsers.length);
                
                // Armazenar no cache
                setCachedRequests(requestsWithUsers);
                
                displayPasswordRequests(requestsWithUsers);
                
            } catch (error) {
                console.error('❌ Erro geral ao carregar solicitações:', error);
                showNotification('Erro ao carregar solicitações', 'error');
            } finally {
                isLoadingRequests = false;
            }
        }
        
        // Substituir a função original
        window.loadPasswordRequests = loadPasswordRequestsWithCache;
        
        // Função para limpar todos os intervalos e timers
        function cleanupAllIntervals() {
            stopBlockWatcher();
            clearCache();
            
            // Limpar outros intervalos se existirem
            const intervals = [
                'blockWatcherInterval',
                'logoutCheckInterval',
                'requestRateLimitInterval'
            ];
            
            intervals.forEach(intervalName => {
                if (window[intervalName]) {
                    clearInterval(window[intervalName]);
                    window[intervalName] = null;
                }
            });
        }
        
        // Limpar intervalos quando a página for descarregada
        window.addEventListener('beforeunload', cleanupAllIntervals);
        window.addEventListener('pagehide', cleanupAllIntervals);
        
        // Tornar função global para debug
        window.cleanupAllIntervals = cleanupAllIntervals;
        
        // Função de debug para testar o carregamento
        window.debugPasswordRequests = async function() {
            console.log('🔍 Debug: Testando carregamento de solicitações...');
            console.log('🔍 Modal existe:', !!document.getElementById('passwordRequestsModal'));
            console.log('🔍 Lista existe:', !!document.getElementById('passwordRequestsList'));
            console.log('🔍 Empty state existe:', !!document.getElementById('emptyPasswordRequests'));
            
            // Testar carregamento direto com refresh forçado
            await loadPasswordRequestsWithCache(true);
        };
        
        // Função de debug simples para testar exibição
        window.testDisplayRequests = function() {
            console.log('🧪 Testando exibição de solicitações...');
            const testRequests = [
                {
                    id: 'test-1',
                    status: 'pending',
                    users: { name: 'Teste Usuário', email: 'teste@teste.com', role: 'funcionario' },
                    created_at: new Date().toISOString(),
                    reason: 'Teste de exibição'
                }
            ];
            
            displayPasswordRequests(testRequests);
        };
        
        // Função para forçar refresh das solicitações
        window.refreshPasswordRequests = function() {
            loadPasswordRequestsWithCache(true);
        };
        
        // Sistema de criptografia simples para senhas
        async function encryptPassword(password) {
            try {
                // Usar Web Crypto API se disponível
                if (window.crypto && window.crypto.subtle) {
                    const encoder = new TextEncoder();
                    const data = encoder.encode(password);
                    const hashBuffer = await window.crypto.subtle.digest('SHA-256', data);
                    const hashArray = Array.from(new Uint8Array(hashBuffer));
                    const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
                    return `enc_${hashHex}`;
                } else {
                    // Fallback para navegadores mais antigos
                    return `enc_${btoa(password)}`;
                }
            } catch (error) {
                console.error('Erro ao criptografar senha:', error);
                // Fallback simples
                return `enc_${btoa(password)}`;
            }
        }
        
        async function decryptPassword(encryptedPassword) {
            try {
                if (encryptedPassword.startsWith('enc_')) {
                    const encrypted = encryptedPassword.substring(4);
                    // Para SHA-256, não podemos descriptografar, então retornamos o hash
                    // Em um sistema real, você usaria criptografia simétrica
                    return encrypted;
                }
                return encryptedPassword;
            } catch (error) {
                console.error('Erro ao descriptografar senha:', error);
                return encryptedPassword;
            }
        }
        
        // Tornar funções globais
        window.encryptPassword = encryptPassword;
        window.decryptPassword = decryptPassword;
        
        // ==================== SISTEMA PWA ====================
        
        let deferredPrompt;
        const CURRENT_VERSION = '2.0.1';
        
        // Capturar o evento beforeinstallprompt
        window.addEventListener('beforeinstallprompt', (e) => {
            console.log('PWA pode ser instalada');
            e.preventDefault();
            deferredPrompt = e;
            checkPWAStatus();
        });
        
        // Função para verificar status da PWA
        async function checkPWAStatus() {
            const isInstalled = await isPWAInstalled();
            const installedVersion = localStorage.getItem('pwa_version');
            
            console.log('PWA Status:', { 
                isInstalled, 
                installedVersion, 
                currentVersion: CURRENT_VERSION,
                displayMode: window.matchMedia('(display-mode: standalone)').matches
            });
            
            if (isInstalled) {
                showUninstallButton();
            } else if (deferredPrompt) {
                showInstallButton();
            }
        }
        
        // Verificar se PWA está instalada
        async function isPWAInstalled() {
            const isStandalone = window.matchMedia('(display-mode: standalone)').matches;
            const installData = localStorage.getItem('pwa_version');
            const hasValidInstallData = installData && JSON.parse(installData).version === CURRENT_VERSION;
            
            return isStandalone || hasValidInstallData;
        }
        
        // Função para instalar a PWA
        async function installPWA() {
            if (!deferredPrompt) {
                showNotification('App já está instalado ou não pode ser instalado', 'error');
                return;
            }
            
            try {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                
                if (outcome === 'accepted') {
                    console.log('Usuário aceitou a instalação');
                    
                    setTimeout(async () => {
                        const isReallyInstalled = await checkRealInstallation();
                        
                        if (isReallyInstalled) {
                            showNotification('App instalado com sucesso!', 'success');
                            
                            const installData = {
                                version: CURRENT_VERSION,
                                timestamp: Date.now(),
                                userInfo: getCurrentUserInfo(),
                                url: window.location.href
                            };
                            localStorage.setItem('pwa_version', JSON.stringify(installData));
                            
                            showUninstallButton();
                        } else {
                            showNotification('Erro: App não foi instalado corretamente', 'error');
                        }
                    }, 2000);
                    
                } else {
                    showNotification('Instalação cancelada', 'info');
                }
                
            } catch (error) {
                console.error('Erro durante instalação:', error);
                showNotification('Erro durante instalação: ' + error.message, 'error');
            }
            
            deferredPrompt = null;
        }
        
        // Verificar se realmente instalou
        async function checkRealInstallation() {
            const isStandalone = window.matchMedia('(display-mode: standalone)').matches;
            const hasServiceWorker = 'serviceWorker' in navigator && 
                await navigator.serviceWorker.getRegistration() !== null;
            
            return isStandalone;
        }
        
        // Obter informações do usuário atual
        function getCurrentUserInfo() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
            return {
                role: 'gerente',
                userId: currentUser?.id || 'unknown',
                userName: currentUser?.name || 'unknown',
                farmId: currentUser?.farm_id || 'unknown',
                timestamp: Date.now()
            };
        }
        
        // Função para desinstalar a PWA
        async function uninstallPWA() {
            if (confirm('Tem certeza que deseja desinstalar o app?')) {
                try {
                    localStorage.removeItem('pwa_version');
                    
                    if ('serviceWorker' in navigator) {
                        const registrations = await navigator.serviceWorker.getRegistrations();
                        for (let registration of registrations) {
                            await registration.unregister();
                        }
                    }
                    
                    showNotification('App desinstalado com sucesso!', 'success');
                    showInstallButton();
                    
                } catch (error) {
                    console.error('Erro ao desinstalar:', error);
                    showNotification('Erro ao desinstalar app', 'error');
                }
            }
        }
        
        // Funções para mostrar/esconder botões
        function showInstallButton() {
            document.getElementById('pwaInstallButton')?.classList.remove('hidden');
            document.getElementById('pwaUninstallButton')?.classList.add('hidden');
        }
        
        function showUninstallButton() {
            document.getElementById('pwaInstallButton')?.classList.add('hidden');
            document.getElementById('pwaUninstallButton')?.classList.remove('hidden');
        }
        
        // Detectar se o app já está instalado
        window.addEventListener('appinstalled', () => {
            console.log('PWA foi instalada');
            showUninstallButton();
        });
        
        // Service Worker removido - sistema MySQL não precisa
        console.log('ℹ️ Service Worker desabilitado - sistema MySQL');

        // ==================== DETECÇÃO DE CONEXÃO COM INTERNET ====================
        let wasOffline = false;
        
        // Detectar quando volta a conexão
        window.addEventListener('online', () => {
            console.log('🌐 Conexão com internet restaurada');
            if (wasOffline) {
                showServerConnectionLoading();
                
                // Simular sincronização (você pode adicionar lógica real aqui)
                setTimeout(() => {
                    hideServerConnectionLoading();
                    showNotification('Conexão restaurada! Dados sincronizados.', 'success');
                }, 3000);
            }
            wasOffline = false;
        });
        
        // Detectar quando perde a conexão
        window.addEventListener('offline', () => {
            console.log('📴 Conexão com internet perdida');
            wasOffline = true;
            showNotification('Conexão perdida. Trabalhando offline...', 'warning');
        });
        
        // ==================== FUNÇÕES DO MODAL PWA ====================
        
        // Abrir modal PWA
        function openPWAModal() {
            console.log('🔧 DEBUG: openPWAModal chamada');
            const modal = document.getElementById('pwaModal');
            console.log('🔧 DEBUG: Modal encontrado:', modal);
            modal.classList.remove('hidden');
            updatePWAStatusInModal();
            console.log('🔧 DEBUG: Modal PWA aberto com sucesso');
        }
        
        // Fechar modal PWA
        function closePWAModal() {
            const modal = document.getElementById('pwaModal');
            modal.classList.add('hidden');
        }
        
        // Atualizar status PWA no modal
        async function updatePWAStatusInModal() {
            const statusDiv = document.getElementById('pwaStatus');
            const installButton = document.getElementById('modalInstallButton');
            const uninstallButton = document.getElementById('modalUninstallButton');
            
            const isInstalled = await isPWAInstalled();
            const installData = localStorage.getItem('pwa_version');
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            
            if (isInstalled) {
                statusDiv.innerHTML = `
                    <div class="flex items-center space-x-3 p-4 bg-green-100 dark:bg-green-900/20 rounded-xl">
                        <div class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"></path>
                            </svg>
                        </div>
                        <div>
                            <h4 class="font-semibold text-green-800 dark:text-green-200">App Instalado</h4>
                            <p class="text-green-600 dark:text-green-300 text-sm">LacTech está instalado e pronto para uso</p>
                        </div>
                    </div>
                `;
                installButton.classList.add('hidden');
                uninstallButton.classList.remove('hidden');
            } else if (deferredPrompt) {
                statusDiv.innerHTML = `
                    <div class="flex items-center space-x-3 p-4 bg-blue-100 dark:bg-blue-900/20 rounded-xl">
                        <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15"></path>
                            </svg>
                        </div>
                        <div>
                            <h4 class="font-semibold text-blue-800 dark:text-blue-200">Pronto para Instalar</h4>
                            <p class="text-blue-600 dark:text-blue-300 text-sm">Clique em "Instalar App" para adicionar à tela inicial</p>
                        </div>
                    </div>
                `;
                installButton.classList.remove('hidden');
                uninstallButton.classList.add('hidden');
            } else {
                statusDiv.innerHTML = `
                    <div class="flex items-center space-x-3 p-4 bg-gray-100 dark:bg-gray-800 rounded-xl">
                        <div class="w-8 h-8 bg-gray-500 rounded-full flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <div>
                            <h4 class="font-semibold text-gray-800 dark:text-gray-200">Instalação Indisponível</h4>
                            <p class="text-gray-600 dark:text-gray-300 text-sm">Use o navegador para instalar o app</p>
                        </div>
                    </div>
                `;
                installButton.classList.add('hidden');
                uninstallButton.classList.add('hidden');
            }
        }
        
        async function installPWAFromModal() {
            await installPWA();
            setTimeout(() => {
                updatePWAStatusInModal();
            }, 3000);
        }
        
        async function uninstallPWAFromModal() {
            await uninstallPWA();
            setTimeout(() => {
                updatePWAStatusInModal();
            }, 1000);
        }
        
        window.installPWA = installPWA;
        window.uninstallPWA = uninstallPWA;
        window.openPWAModal = openPWAModal;
        window.closePWAModal = closePWAModal;
        window.installPWAFromModal = installPWAFromModal;
        window.uninstallPWAFromModal = uninstallPWAFromModal;
        
        async function loadProductionDataWithCache(farmId, dateRange = 'week') {
            if (!window.offlineManager) {
                console.error('Offline Manager não disponível');
                return null;
            }
            
            const cacheKey = `production_${farmId}_${dateRange}`;
            
            const fetchOnlineData = async () => {
                // // const supabase = await getSupabaseClient(); // REMOVIDO // REMOVIDO - usando MySQL
                let query = supabase
                    .from('volume_records')
                    .select('volume_liters, production_date, milking_type')
                    .eq('farm_id', farmId);
                
                // Aplicar filtro de data
                if (dateRange === 'today') {
                    const today = new Date().toISOString().split('T')[0];
                    query = query.eq('production_date', today);
                } else if (dateRange === 'week') {
                    const weekAgo = new Date();
                    weekAgo.setDate(weekAgo.getDate() - 7);
                    query = query.gte('production_date', weekAgo.toISOString().split('T')[0]);
                } else if (dateRange === 'month') {
                    const monthAgo = new Date();
                    monthAgo.setMonth(monthAgo.getMonth() - 1);
                    query = query.gte('production_date', monthAgo.toISOString().split('T')[0]);
                }
                
                const { data, error } = await query.order('production_date', { ascending: true });
                
                if (error) throw error;
                return data;
            };
            
            // Usar Offline Manager para obter dados
            return await window.offlineManager.getData(cacheKey, fetchOnlineData);
        }
        
        // Função para salvar dados de produção com sincronização
        async function saveProductionDataWithSync(volumeData) {
            if (!window.offlineManager) {
                console.error('Offline Manager não disponível');
                return false;
            }
            
            // Salvar usando Offline Manager
            return await window.offlineManager.saveData('volume_record', volumeData, true);
        }
        
        // Função para carregar dados do usuário com cache
        async function loadUserDataWithCache() {
            if (!window.offlineManager) {
                console.error('Offline Manager não disponível');
                return null;
            }
            
            const cacheKey = 'user_data';
            
            const fetchOnlineData = async () => {
                // // const supabase = await getSupabaseClient(); // REMOVIDO // REMOVIDO - usando MySQL
                const { data: { user } } = await supabase.auth.getUser();
                
                if (!user) throw new Error('Usuário não autenticado');
                
                const { data: userData, error } = await supabase
                    .from('users')
                    .select('*')
                    .eq('id', user.id)
                    .single();
                
                if (error) throw error;
                return userData;
            };
            
            return await window.offlineManager.getData(cacheKey, fetchOnlineData);
        }
        
        // Função para carregar dados da fazenda com cache
        async function loadFarmDataWithCache(farmId) {
            if (!window.offlineManager) {
                console.error('Offline Manager não disponível');
                return null;
            }
            
            const cacheKey = `farm_data_${farmId}`;
            
            const fetchOnlineData = async () => {
                // // const supabase = await getSupabaseClient(); // REMOVIDO // REMOVIDO - usando MySQL
                const { data: farmData, error } = await supabase
                    .from('farms')
                    .select('*')
                    .eq('id', farmId)
                    .single();
                
                if (error) throw error;
                return farmData;
            };
            
            return await window.offlineManager.getData(cacheKey, fetchOnlineData);
        }
        
        // Service Worker listener removido - sistema MySQL
        console.log('ℹ️ Service Worker listener desabilitado - sistema MySQL');
        
        // Tornar funções offline globais
        window.loadProductionDataWithCache = loadProductionDataWithCache;
        window.saveProductionDataWithSync = saveProductionDataWithSync;
        window.loadUserDataWithCache = loadUserDataWithCache;
        window.loadFarmDataWithCache = loadFarmDataWithCache;
        
        
    </script>

    <!-- Modal PWA Full Screen - Estilo Xandria Store -->
    <div id="pwaModal" class="fixed inset-0 bg-gray-50 dark:bg-play-dark z-[9999] hidden dark">
        <div class="w-full h-full flex flex-col overflow-y-auto">
            <!-- Header do Modal - Estilo Xandria Store -->
            <header class="bg-white dark:bg-play-dark no-border sticky top-0 z-50 backdrop-blur-sm bg-opacity-95 dark:bg-opacity-95">
                <div class="flex items-center justify-between px-6 py-4">
                    <div class="flex items-center space-x-4">
                        <div class="w-10 h-10 flex items-center justify-center">
                            <img src="assets/img/xandria-preta.png" alt="LacTech" class="w-8 h-8">
                        </div>
                        <div>
                            <h1 class="text-xl font-bold tracking-tight text-black dark:text-white">LacTech - Gerente</h1>
                            <p class="text-xs text-gray-500 dark:text-gray-400 -mt-1">Sistema Agropecuário</p>
                        </div>
                    </div>
                    <button onclick="closePWAModal()" class="w-10 h-10 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-xl flex items-center justify-center transition-colors">
                        <svg class="w-6 h-6 text-gray-600 dark:text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </header>

            <!-- Featured Banner -->
            <div class="px-6 py-6">
                <div class="max-w-4xl mx-auto">
                    <div class="rounded-3xl overflow-hidden shadow-xl card-hover cursor-pointer">
                        <img src="https://i.postimg.cc/7LcySj3K/agroneg-cio.png" alt="Banner LacTech" class="w-full h-48 sm:h-56 md:h-64 lg:h-72 object-cover">
                    </div>
                </div>
            </div>

            <!-- Conteúdo do Modal -->
            <div class="flex-1 px-6 pb-6">
                <div class="max-w-4xl mx-auto">
                    <!-- Status da Instalação - Layout Melhorado -->
                    <div class="bg-gradient-to-br from-green-50 to-emerald-100 dark:from-green-900/30 dark:to-emerald-900/30 rounded-2xl p-6 mb-6 border border-green-200 dark:border-green-800">
                        <div class="flex flex-col sm:flex-row items-center space-y-4 sm:space-y-0 sm:space-x-4 mb-4">
                            <div class="w-14 h-14 bg-gradient-to-br from-green-500 to-green-600 rounded-2xl flex items-center justify-center shadow-lg">
                                <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15"></path>
                                </svg>
                            </div>
                            <div class="text-center sm:text-left">
                                <h3 class="text-lg font-bold text-gray-900 dark:text-white">Instalar App LacTech</h3>
                                <p class="text-sm text-gray-600 dark:text-gray-400">Acesso rápido ao sistema</p>
                            </div>
                        </div>
                        
                        <div id="pwaStatus" class="space-y-3">
                            <!-- Status será preenchido dinamicamente -->
                        </div>
                    </div>

                    <!-- Informações do Sistema - Layout 2 Colunas -->
                    <div class="grid grid-cols-2 gap-4 mb-8">
                        <!-- Acesso Offline -->
                        <div class="bg-white dark:bg-play-card rounded-2xl p-4 border border-gray-200 dark:border-gray-700 hover:shadow-lg transition-all duration-300">
                            <div class="flex flex-col items-center text-center space-y-3">
                                <div class="w-12 h-12 bg-gradient-to-br from-green-500 to-green-600 rounded-2xl flex items-center justify-center shadow-lg">
                                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-gray-900 dark:text-white text-sm">Acesso Offline</h4>
                                    <p class="text-gray-600 dark:text-gray-400 text-xs mt-1">Funcione sem internet</p>
                                </div>
                            </div>
                        </div>

                        <!-- Acesso Rápido -->
                        <div class="bg-white dark:bg-play-card rounded-2xl p-4 border border-gray-200 dark:border-gray-700 hover:shadow-lg transition-all duration-300">
                            <div class="flex flex-col items-center text-center space-y-3">
                                <div class="w-12 h-12 bg-gradient-to-br from-green-500 to-green-600 rounded-2xl flex items-center justify-center shadow-lg">
                                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                    </svg>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-gray-900 dark:text-white text-sm">Acesso Rápido</h4>
                                    <p class="text-gray-600 dark:text-gray-400 text-xs mt-1">Da tela inicial</p>
                                </div>
                            </div>
                        </div>

                        <!-- Interface Nativa -->
                        <div class="bg-white dark:bg-play-card rounded-2xl p-4 border border-gray-200 dark:border-gray-700 hover:shadow-lg transition-all duration-300">
                            <div class="flex flex-col items-center text-center space-y-3">
                                <div class="w-12 h-12 bg-gradient-to-br from-green-500 to-green-600 rounded-2xl flex items-center justify-center shadow-lg">
                                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                                    </svg>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-gray-900 dark:text-white text-sm">Interface Nativa</h4>
                                    <p class="text-gray-600 dark:text-gray-400 text-xs mt-1">Experiência nativa</p>
                                </div>
                            </div>
                        </div>

                        <!-- Segurança -->
                        <div class="bg-white dark:bg-play-card rounded-2xl p-4 border border-gray-200 dark:border-gray-700 hover:shadow-lg transition-all duration-300">
                            <div class="flex flex-col items-center text-center space-y-3">
                                <div class="w-12 h-12 bg-gradient-to-br from-green-500 to-green-600 rounded-2xl flex items-center justify-center shadow-lg">
                                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                                    </svg>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-gray-900 dark:text-white text-sm">Segurança</h4>
                                    <p class="text-gray-600 dark:text-gray-400 text-xs mt-1">Dados protegidos</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Botões de Ação - Layout Melhorado -->
                    <div class="flex flex-col gap-3">
                        <button id="modalInstallButton" onclick="installPWAFromModal()" class="w-full px-6 py-4 bg-gradient-to-r from-green-500 to-green-600 text-white font-semibold rounded-xl hover:from-green-600 hover:to-green-700 transition-all shadow-lg hidden">
                            <div class="flex items-center justify-center space-x-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15"></path>
                                </svg>
                                <span>Instalar App</span>
                            </div>
                        </button>
                        
                        <button id="modalUninstallButton" onclick="uninstallPWAFromModal()" class="w-full px-6 py-4 bg-gradient-to-r from-gray-500 to-gray-600 text-white font-semibold rounded-xl hover:from-gray-600 hover:to-gray-700 transition-all shadow-lg hidden">
                            <div class="flex items-center justify-center space-x-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0"></path>
                                </svg>
                                <span>Desinstalar App</span>
                            </div>
                        </button>
                        
                        <button onclick="closePWAModal()" class="w-full px-6 py-3 bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300 font-medium rounded-xl hover:bg-gray-200 dark:hover:bg-gray-700 transition-all border border-gray-200 dark:border-gray-600">
                            Fechar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Clima com Backgrounds Animados -->
    <div id="weatherModal" class="weather-modal hidden">
        <!-- Background Animado -->
        <div id="weatherBackground" class="weather-background">
            <!-- Elementos animados baseados no clima -->
            <div class="weather-particles"></div>
        </div>
        
        <!-- Conteúdo do Modal -->
        <div class="weather-content">
            <!-- Header -->
            <div class="weather-header">
                <button class="close-btn" onclick="closeWeatherModal()">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 6L6 18M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            
            <!-- Informações Principais -->
            <div class="weather-main">
                <div class="location-info">
                    <div class="location-name" id="weatherLocation">Carregando...</div>
                    <div class="location-date" id="weatherDate">Loading...</div>
                </div>
                
                <div class="temperature-section">
                    <div class="temperature-display">
                        <div class="temperature-value" id="weatherTemp">22°</div>
                        <div class="weather-icon" id="weatherIcon">
                            <!-- SVG será inserido aqui -->
                        </div>
                    </div>
                    <div class="weather-condition" id="weatherCondition">Nublado</div>
                </div>
            </div>
            
            <!-- Estatísticas -->
            <div class="weather-stats">
                <div class="stat-item">
                    <div class="stat-icon">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M17.7 7.7a2.5 2.5 0 1 1 1.8 4.3H2"/>
                            <path d="M9.6 4.6A2 2 0 1 1 11 8H2"/>
                            <path d="M12.6 1.6A6 6 0 0 1 18 7.6H2"/>
                        </svg>
                    </div>
                    <div class="stat-label">Vento</div>
                    <div class="stat-value" id="weatherWind">10 m/s</div>
                </div>
                
                <div class="stat-item">
                    <div class="stat-icon">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"/>
                        </svg>
                    </div>
                    <div class="stat-label">Umidade</div>
                    <div class="stat-value" id="weatherHumidity">78%</div>
                </div>
            </div>
            
            <!-- Previsão por Hora -->
            <div class="hourly-forecast">
                <div class="forecast-item">
                    <div class="forecast-time">10:00</div>
                    <div class="forecast-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"/>
                        </svg>
                    </div>
                    <div class="forecast-temp">18°</div>
                </div>
                
                <div class="forecast-item">
                    <div class="forecast-time">11:00</div>
                    <div class="forecast-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"/>
                        </svg>
                    </div>
                    <div class="forecast-temp">19°</div>
                </div>
                
                <div class="forecast-item">
                    <div class="forecast-time">12:00</div>
                    <div class="forecast-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <circle cx="12" cy="12" r="5"/>
                            <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>
                        </svg>
                    </div>
                    <div class="forecast-temp">22°</div>
                </div>
                
                <div class="forecast-item">
                    <div class="forecast-time">13:00</div>
                    <div class="forecast-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <circle cx="12" cy="12" r="5"/>
                            <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>
                        </svg>
                    </div>
                    <div class="forecast-temp">24°</div>
                </div>
                
                <div class="forecast-item">
                    <div class="forecast-time">14:00</div>
                    <div class="forecast-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <circle cx="12" cy="12" r="5"/>
                            <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>
                        </svg>
                    </div>
                    <div class="forecast-temp">25°</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Inicializar notificações nativas -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
        // Inicializar notificações nativas
        if (window.nativeNotifications) {
            window.nativeNotifications.init();
            
            // Solicitar permissão de notificações automaticamente
            setTimeout(() => {
                window.nativeNotifications.requestNotificationPermission();
            }, 3000);
        }

        // Inicializar sistema de sincronização offline
        if (window.offlineSyncManager) {
            console.log('🔄 Sistema de sincronização offline inicializado');
        }

        // Funções para atualização em tempo real dos gráficos
        window.updateVolumeCharts = async function() {
            try {
                await loadWeeklyVolumeChart();
                await loadDailyVolumeChart();
                await loadDashboardWeeklyChart();
                console.log('📊 Gráficos de volume atualizados');
            } catch (error) {
                console.error('❌ Erro ao atualizar gráficos de volume:', error);
            }
        };

        window.updateVolumeStats = async function() {
            try {
                await loadVolumeData();
                console.log('📈 Estatísticas de volume atualizadas');
            } catch (error) {
                console.error('❌ Erro ao atualizar estatísticas de volume:', error);
            }
        };

        window.updateVolumeRecordsList = async function() {
            try {
                console.log('🔄 Atualizando lista de registros de volume...');
                
                // // const supabase = await getSupabaseClient(); // REMOVIDO // REMOVIDO - usando MySQL
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) return;

                const { data: userData } = await supabase
                    .from('users')
                    .select('farm_id')
                    .eq('id', user.id)
                    .single();

                if (!userData?.farm_id) return;

                // Buscar registros do servidor
                const { data: volumeRecords, error } = await supabase
                    .from('volume_records')
                    .select('*')
                    .eq('farm_id', userData.farm_id)
                    .order('production_date', { ascending: false })
                    .limit(10);

                if (error) {
                    console.error('❌ Erro ao buscar registros:', error);
                    return;
                }

                // Adicionar registros locais
                let allRecords = [...(volumeRecords || [])];
                if (window.offlineSyncManager) {
                    const localRecords = window.offlineSyncManager.getLocalData('volume');
                    const localFiltered = localRecords.filter(record => 
                        record.farm_id === userData.farm_id && !record.synced
                    );
                    allRecords = [...localFiltered, ...allRecords];
                }

                // Atualizar interface
                const tbody = document.getElementById('volumeRecords');
                if (tbody) {
                    if (allRecords.length === 0) {
                        tbody.innerHTML = `
                            <tr>
                                <td colspan="5" class="text-center py-8 text-gray-500">
                                    Nenhum registro encontrado
                                </td>
                            </tr>
                        `;
                    } else {
                        tbody.innerHTML = allRecords.map(record => `
                            <tr class="border-b border-gray-100 hover:bg-gray-50">
                                <td class="py-3 px-4 text-sm text-gray-900">
                                    ${new Date(record.production_date + 'T00:00:00').toLocaleDateString('pt-BR')}
                                </td>
                                <td class="py-3 px-4 text-sm text-gray-900 font-medium">
                                    ${record.volume_liters}L
                                </td>
                                <td class="py-3 px-4 text-sm text-gray-600">
                                    ${record.users?.name || record.user_name || 'N/A'}
                                </td>
                                <td class="py-3 px-4 text-sm text-gray-600">
                                    ${record.notes || '-'}
                                </td>
                                <td class="py-3 px-4 text-sm">
                                    <button onclick="deleteVolumeRecord('${record.id}');" class="text-red-600 hover:text-red-800 font-medium">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                        </svg>
                                    </button>
                                </td>
                            </tr>
                        `).join('');
                    }
                }

                console.log(`✅ Lista de registros atualizada: ${allRecords.length} registros`);
            } catch (error) {
                console.error('❌ Erro ao atualizar lista de registros:', error);
            }
        };

        window.updateDashboardStats = async function() {
            try {
                console.log('🔄 Atualizando estatísticas do dashboard...');
                
                // Atualizar volume de hoje
                await loadVolumeData();
                
                // Atualizar gráfico semanal do dashboard
                await loadDashboardWeeklyChart();
                
                // Atualizar estatísticas gerais
                await loadDashboardData();
                
                console.log('✅ Estatísticas do dashboard atualizadas');
            } catch (error) {
                console.error('❌ Erro ao atualizar estatísticas do dashboard:', error);
            }
        };

        // Função para forçar atualização completa dos registros de volume
        window.forceRefreshVolumeRecords = async function() {
            try {
                console.log('🔄 Forçando atualização completa dos registros de volume...');
                
                // Limpar cache
                if (CacheManager) {
                    CacheManager.clearCache();
                    CacheManager.forceRefresh = true;
                }
                
                // Recarregar dados
                await loadVolumeRecords();
                await updateVolumeRecordsList();
                
                console.log('✅ Registros de volume atualizados com sucesso');
            } catch (error) {
                console.error('❌ Erro ao forçar atualização dos registros:', error);
            }
        };

        // Função para corrigir registros existentes sem nome do funcionário
        window.fixVolumeRecordsEmployeeNames = async function() {
            try {
                console.log('🔧 Corrigindo nomes de funcionários nos registros existentes...');
                
                // // const supabase = await getSupabaseClient(); // REMOVIDO // REMOVIDO - usando MySQL
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) return;

                const { data: userData } = await supabase
                    .from('users')
                    .select('farm_id')
                    .eq('id', user.id)
                    .single();

                if (!userData?.farm_id) return;

                // Buscar registros para verificar se têm nomes de funcionários
                const { data: recordsWithoutName, error: fetchError } = await supabase
                    .from('volume_records')
                    .select(`
                        id,
                        user_id,
                        users(name)
                    `)
                    .eq('farm_id', userData.farm_id)
                    .limit(10);

                if (fetchError) {
                    console.error('❌ Erro ao buscar registros:', fetchError);
                    return;
                }

                if (recordsWithoutName && recordsWithoutName.length > 0) {
                    console.log(`✅ Encontrados ${recordsWithoutName.length} registros com dados de funcionários`);
                    console.log('ℹ️ Os nomes dos funcionários são obtidos automaticamente via relacionamento com a tabela users');
                } else {
                    console.log('ℹ️ Nenhum registro encontrado para verificação');
                }
                
            } catch (error) {
                console.error('❌ Erro ao corrigir nomes de funcionários:', error);
            }
        };
        });

        // ==================== RELATÓRIOS MODAL ====================
        function openReportsModal() {
            const modal = document.getElementById('reportsModal');
            if (modal) {
                modal.classList.remove('hidden');
                modal.style.display = 'flex';
                document.body.style.overflow = 'hidden';
            }
        }

        function closeReportsModal() {
            const modal = document.getElementById('reportsModal');
            if (modal) {
                modal.classList.add('hidden');
                modal.style.display = 'none';
                document.body.style.overflow = 'auto';
            }
        }

        // Funções de geração de relatórios
        async function generateVolumeReport() {
            try {
                showCustomLoading('Gerando relatório de volume...', 'generate');
                
                // // const supabase = await getSupabaseClient(); // REMOVIDO // REMOVIDO - usando MySQL
                const { data: { user } } = await supabase.auth.getUser();
                
                if (!user) {
                    throw new Error('Usuário não autenticado');
                }

                // Buscar dados do usuário para obter farm_id
                const { data: userData } = await supabase
                    .from('users')
                    .select('farm_id')
                    .eq('id', user.id)
                    .single();

                if (!userData?.farm_id) {
                    throw new Error('Farm ID não encontrado');
                }

                // Buscar dados de volume
                const { data: volumeData, error } = await supabase
                            .from('volume_records')
                    .select('*')
                    .eq('farm_id', userData.farm_id)
                    .order('production_date', { ascending: false })
                    .limit(100);

                if (error) {
                    throw error;
                }

                // Gerar PDF
                await generateVolumePDF(volumeData || []);
                
                hideCustomLoading();
                showNotification('Relatório de volume gerado com sucesso!', 'success');
                
            } catch (error) {
                hideCustomLoading();
                console.error('Erro ao gerar relatório de volume:', error);
                showNotification('Erro ao gerar relatório: ' + error.message, 'error');
            }
        }

        async function generateQualityReport() {
            try {
                showCustomLoading('Gerando relatório de qualidade...', 'generate');
                
                // // const supabase = await getSupabaseClient(); // REMOVIDO // REMOVIDO - usando MySQL
                const { data: { user } } = await supabase.auth.getUser();
                
                if (!user) {
                    throw new Error('Usuário não autenticado');
                }

                // Buscar dados do usuário para obter farm_id
                const { data: userData } = await supabase
                    .from('users')
                    .select('farm_id')
                    .eq('id', user.id)
                    .single();

                if (!userData?.farm_id) {
                    throw new Error('Farm ID não encontrado');
                }

                // Buscar dados de qualidade
                const { data: qualityData, error } = await supabase
                    .from('quality_tests')
                    .select('*')
                    .eq('farm_id', userData.farm_id)
                    .order('test_date', { ascending: false })
                    .limit(100);

                if (error) {
                    throw error;
                }

                // Gerar PDF
                await generateQualityPDF(qualityData || []);
                
                hideCustomLoading();
                showNotification('Relatório de qualidade gerado com sucesso!', 'success');
                
            } catch (error) {
                hideCustomLoading();
                console.error('Erro ao gerar relatório de qualidade:', error);
                showNotification('Erro ao gerar relatório: ' + error.message, 'error');
            }
        }

        async function generateFinancialReport() {
            try {
                showCustomLoading('Gerando relatório financeiro...', 'generate');
                
                // // const supabase = await getSupabaseClient(); // REMOVIDO // REMOVIDO - usando MySQL
                const { data: { user } } = await supabase.auth.getUser();
                
                if (!user) {
                    throw new Error('Usuário não autenticado');
                }

                // Buscar dados do usuário para obter farm_id
                const { data: userData } = await supabase
                    .from('users')
                    .select('farm_id')
                    .eq('id', user.id)
                    .single();

                if (!userData?.farm_id) {
                    throw new Error('Farm ID não encontrado');
                }

                // Buscar dados financeiros
                const { data: financialData, error } = await supabase
                    .from('financial_records')
                    .select('*')
                    .eq('farm_id', userData.farm_id)
                    .order('record_date', { ascending: false })
                    .limit(100);

                if (error) {
                    throw error;
                }

                // Gerar PDF
                await generatePaymentsPDF(financialData || []);
                
                hideCustomLoading();
                showNotification('Relatório financeiro gerado com sucesso!', 'success');
                
            } catch (error) {
                hideCustomLoading();
                console.error('Erro ao gerar relatório financeiro:', error);
                showNotification('Erro ao gerar relatório: ' + error.message, 'error');
            }
        }


        // ==================== RELATÓRIO PERSONALIZADO ====================
        function openCustomReportModal() {
            const modal = document.getElementById('customReportModal');
            if (modal) {
                modal.classList.remove('hidden');
                modal.style.display = 'flex';
                document.body.style.overflow = 'hidden';
                loadCustomReportSettings();
            }
        }

        function closeCustomReportModal() {
            const modal = document.getElementById('customReportModal');
            if (modal) {
                modal.classList.add('hidden');
                modal.style.display = 'none';
                document.body.style.overflow = 'auto';
            }
        }

        async function loadCustomReportSettings() {
            try {
                // // const supabase = await getSupabaseClient(); // REMOVIDO // REMOVIDO - usando MySQL
                const { data: { user } } = await supabase.auth.getUser();
                
                if (!user) return;

                // Buscar dados do usuário
                const { data: userData, error: userError } = await supabase
                    .from('users')
                    .select('report_farm_name, report_farm_logo_base64, farm_id')
                    .eq('id', user.id)
                    .single();

                if (userError) {
                    console.error('Erro ao buscar dados do usuário:', userError);
                    return;
                }

                if (userData) {
                    // Usar o nome personalizado salvo ou buscar o nome da fazenda
                    let farmName = userData.report_farm_name;
                    
                    if (!farmName && userData.farm_id) {
                        // Buscar nome da fazenda se não tiver personalizado
                        const { data: farmData, error: farmError } = await supabase
                            .from('farms')
                            .select('name')
                            .eq('id', userData.farm_id)
                            .single();
                        
                        if (!farmError && farmData) {
                            farmName = farmData.name;
                        }
                    }
                    
                    // Fallback para nome padrão
                    if (!farmName) {
                        farmName = await getFarmName() || 'Minha Fazenda';
                    }
                    
                    document.getElementById('customReportFarmName').value = farmName;
                    
                    if (userData.report_farm_logo_base64) {
                        updateCustomReportLogoPreview(userData.report_farm_logo_base64);
                    }
                }
            } catch (error) {
                console.error('Erro ao carregar configurações:', error);
            }
        }

        async function handleCustomReportLogoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.type.startsWith('image/')) {
                showNotification('Por favor, selecione um arquivo de imagem válido', 'error');
                return;
            }
            
            if (file.size > 2 * 1024 * 1024) {
                showNotification('A imagem deve ter no máximo 2MB', 'error');
                return;
            }
            
            try {
                const base64 = await fileToBase64(file);
                updateCustomReportLogoPreview(base64);
                showNotification('Logo carregada com sucesso!', 'success');
            } catch (error) {
                console.error('Erro ao processar logo:', error);
                showNotification('Erro ao processar a imagem', 'error');
            }
        }

        function updateCustomReportLogoPreview(base64Logo) {
            const preview = document.getElementById('customReportLogoPreview');
            const placeholder = document.getElementById('customReportLogoPlaceholder');
            const image = document.getElementById('customReportLogoImage');
            const removeBtn = document.getElementById('removeCustomReportLogo');
            
            if (base64Logo) {
                image.src = base64Logo;
                preview.classList.remove('hidden');
                placeholder.classList.add('hidden');
                removeBtn.classList.remove('hidden');
                } else {
                preview.classList.add('hidden');
                placeholder.classList.remove('hidden');
                removeBtn.classList.add('hidden');
            }
        }

        function removeCustomReportLogo() {
            updateCustomReportLogoPreview(null);
            document.getElementById('customReportLogoUpload').value = '';
            showNotification('Logo removida!', 'info');
        }

        async function saveCustomReportSettings() {
            try {
                showCustomLoading('Salvando configurações...', 'save');
                
                // // const supabase = await getSupabaseClient(); // REMOVIDO // REMOVIDO - usando MySQL
                const { data: { user } } = await supabase.auth.getUser();
                
                if (!user) {
                    throw new Error('Usuário não autenticado');
                }

                const farmName = document.getElementById('customReportFarmName').value;
                const logoImage = document.getElementById('customReportLogoImage');
                const farmLogo = logoImage.src.includes('data:image') ? logoImage.src : null;

                // Atualizar diretamente na tabela users
                const { error } = await supabase
                    .from('users')
                    .update({
                        report_farm_name: farmName,
                        report_farm_logo_base64: farmLogo
                    })
                    .eq('id', user.id);

                if (error) {
                    throw error;
                }

                // Atualizar configurações globais
                if (window.reportSettings) {
                    window.reportSettings.farmName = farmName;
                    window.reportSettings.farmLogo = farmLogo;
                }

                hideCustomLoading();
                showNotification('Configurações salvas com sucesso!', 'success');
                closeCustomReportModal();
                
            } catch (error) {
                hideCustomLoading();
                console.error('Erro ao salvar configurações:', error);
                showNotification('Erro ao salvar configurações: ' + error.message, 'error');
            }
        }

        async function generateCustomReport() {
            try {
                showCustomLoading('Gerando relatório personalizado...', 'generate');
                
                // // const supabase = await getSupabaseClient(); // REMOVIDO // REMOVIDO - usando MySQL
                const { data: { user } } = await supabase.auth.getUser();
                
                if (!user) {
                    throw new Error('Usuário não autenticado');
                }

                // Buscar dados do usuário para obter farm_id
                const { data: userData } = await supabase
                    .from('users')
                    .select('farm_id')
                    .eq('id', user.id)
                    .single();

                if (!userData?.farm_id) {
                    throw new Error('Farm ID não encontrado');
                }

                // Obter configurações do modal
                const farmName = document.getElementById('customReportFarmName').value;
                const logoImage = document.getElementById('customReportLogoImage');
                const farmLogo = logoImage.src.includes('data:image') ? logoImage.src : null;

                // Configurar window.reportSettings com as configurações do modal
                if (!window.reportSettings) {
                    window.reportSettings = {};
                }
                window.reportSettings.farmName = farmName;
                window.reportSettings.farmLogo = farmLogo;

                console.log('Configurações do relatório personalizado:');
                console.log('- Nome da fazenda:', farmName);
                console.log('- Logo da fazenda:', farmLogo ? 'Carregada' : 'Não carregada');

                // Buscar dados de volume (relatório personalizado combina volume + qualidade)
                const { data: volumeData, error: volumeError } = await supabase
                    .from('volume_records')
                    .select('*')
                    .eq('farm_id', userData.farm_id)
                    .order('production_date', { ascending: false })
                    .limit(50);

                if (volumeError) {
                    throw volumeError;
                }

                // Gerar PDF personalizado (usando função de volume como base)
                await generateVolumePDF(volumeData || []);
                
                hideCustomLoading();
                showNotification('Relatório personalizado gerado com sucesso!', 'success');
                closeCustomReportModal();
                
            } catch (error) {
                hideCustomLoading();
                console.error('Erro ao gerar relatório personalizado:', error);
                showNotification('Erro ao gerar relatório: ' + error.message, 'error');
            }
        }

        // ==================== LOADING PERSONALIZADO ====================
        function showCustomLoading(message, type) {
            const loadingModal = document.getElementById('customLoadingModal');
            const loadingMessage = document.getElementById('customLoadingMessage');
            const loadingIcon = document.getElementById('customLoadingIcon');
            
            if (loadingModal && loadingMessage && loadingIcon) {
                loadingMessage.textContent = message;
                
                // Definir ícone baseado no tipo
                if (type === 'save') {
                    loadingIcon.innerHTML = `
                        <svg class="w-8 h-8 text-indigo-600 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                    `;
                } else if (type === 'generate') {
                    loadingIcon.innerHTML = `
                        <svg class="w-8 h-8 text-green-600 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                    `;
                }
                
                loadingModal.classList.remove('hidden');
                loadingModal.style.display = 'flex';
                document.body.style.overflow = 'hidden';
            }
        }

        function hideCustomLoading() {
            const loadingModal = document.getElementById('customLoadingModal');
            if (loadingModal) {
                loadingModal.classList.add('hidden');
                loadingModal.style.display = 'none';
                document.body.style.overflow = 'auto';
            }
        }
    </script>

    <!-- Modal de Relatórios Full Screen -->
    <div id="reportsModal" class="fixed inset-0 bg-white z-[99999] hidden flex flex-col" style="display: none;">
        <!-- Header -->
        <div class="flex-shrink-0 p-4 sm:p-6 bg-gradient-to-br from-forest-500 via-forest-600 to-forest-700 text-white shadow-2xl">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <div class="w-12 h-12 bg-white bg-opacity-20 rounded-2xl flex items-center justify-center">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold">Relatórios</h1>
                        <p class="text-forest-100 text-sm">Gere relatórios personalizados da sua fazenda</p>
                    </div>
                </div>
                <button onclick="closeReportsModal()" class="p-2 hover:bg-white hover:bg-opacity-20 rounded-xl transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Conteúdo -->
        <div class="flex-1 overflow-y-auto p-4 sm:p-6 bg-gray-50">
            <div class="max-w-6xl mx-auto">
                <!-- Grid de Relatórios -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    
                    <!-- Relatório de Volume -->
                    <div class="bg-white rounded-2xl p-6 shadow-lg hover:shadow-xl transition-all duration-300 border border-gray-100">
                        <div class="flex items-center mb-4">
                            <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center mr-4">
                                <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M19 14l-7 7m0 0l-7-7m7 7V3"></path>
                                </svg>
                            </div>
                            <div>
                                <h3 class="text-lg font-bold text-gray-900">Relatório de Volume</h3>
                                <p class="text-sm text-gray-600">Produção de leite</p>
                            </div>
                        </div>
                        <p class="text-gray-600 text-sm mb-4">Relatório detalhado da produção de leite com volumes, datas e funcionários responsáveis.</p>
                        <button onclick="generateVolumeReport()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-xl transition-colors">
                            Gerar PDF
                        </button>
                    </div>

                    <!-- Relatório de Qualidade -->
                    <div class="bg-white rounded-2xl p-6 shadow-lg hover:shadow-xl transition-all duration-300 border border-gray-100">
                        <div class="flex items-center mb-4">
                            <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center mr-4">
                                <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <div>
                                <h3 class="text-lg font-bold text-gray-900">Relatório de Qualidade</h3>
                                <p class="text-sm text-gray-600">Testes de qualidade</p>
                            </div>
                        </div>
                        <p class="text-gray-600 text-sm mb-4">Análise de gordura, proteína, CCS e CBT do leite produzido.</p>
                        <button onclick="generateQualityReport()" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-4 rounded-xl transition-colors">
                            Gerar PDF
                        </button>
                    </div>

                    <!-- Relatório Financeiro -->
                    <div class="bg-white rounded-2xl p-6 shadow-lg hover:shadow-xl transition-all duration-300 border border-gray-100">
                        <div class="flex items-center mb-4">
                            <div class="w-12 h-12 bg-yellow-100 rounded-xl flex items-center justify-center mr-4">
                                <svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                                </svg>
                            </div>
                            <div>
                                <h3 class="text-lg font-bold text-gray-900">Relatório Financeiro</h3>
                                <p class="text-sm text-gray-600">Pagamentos e receitas</p>
                            </div>
                        </div>
                        <p class="text-gray-600 text-sm mb-4">Relatório de pagamentos, receitas e movimentação financeira da fazenda.</p>
                        <button onclick="generateFinancialReport()" class="w-full bg-yellow-600 hover:bg-yellow-700 text-white font-semibold py-3 px-4 rounded-xl transition-colors">
                            Gerar PDF
                        </button>
                    </div>


                    <!-- Relatório Personalizado -->
                    <div class="bg-white rounded-2xl p-6 shadow-lg hover:shadow-xl transition-all duration-300 border border-gray-100">
                        <div class="flex items-center mb-4">
                            <div class="w-12 h-12 bg-indigo-100 rounded-xl flex items-center justify-center mr-4">
                                <svg class="w-6 h-6 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                </svg>
                            </div>
                            <div>
                                <h3 class="text-lg font-bold text-gray-900">Relatório Personalizado</h3>
                                <p class="text-sm text-gray-600">Crie seu próprio relatório</p>
                            </div>
                        </div>
                        <p class="text-gray-600 text-sm mb-4">Crie relatórios personalizados com os dados que você precisa.</p>
                        <button onclick="openCustomReportModal()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-4 rounded-xl transition-colors">
                            Configurar
                        </button>
                    </div>

                </div>

                <!-- Informações Adicionais -->
                <div class="mt-8 bg-white rounded-2xl p-6 shadow-lg border border-gray-100">
                    <h3 class="text-lg font-bold text-gray-900 mb-4">Informações sobre os Relatórios</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h4 class="font-semibold text-gray-800 mb-2">📊 Dados Incluídos</h4>
                            <ul class="text-sm text-gray-600 space-y-1">
                                <li>• Últimos 100 registros</li>
                                <li>• Logos da fazenda e sistema</li>
                                <li>• Resumos estatísticos</li>
                                <li>• Tabelas detalhadas</li>
                            </ul>
                        </div>
                        <div>
                            <h4 class="font-semibold text-gray-800 mb-2">⚙️ Configurações</h4>
                            <ul class="text-sm text-gray-600 space-y-1">
                                <li>• Formato PDF profissional</li>
                                <li>• Marca d'água personalizada</li>
                                <li>• Download automático</li>
                                <li>• Compatível com impressão</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Relatório Personalizado -->
    <div id="customReportModal" class="fixed inset-0 bg-white z-[99999] hidden flex flex-col" style="display: none;">
        <!-- Header -->
        <div class="flex-shrink-0 p-4 sm:p-6 bg-gradient-to-br from-indigo-500 via-indigo-600 to-indigo-700 text-white shadow-2xl">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <div class="w-12 h-12 bg-white bg-opacity-20 rounded-2xl flex items-center justify-center">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold">Relatório Personalizado</h1>
                        <p class="text-indigo-100 text-sm">Configure seu relatório com logo personalizada</p>
                    </div>
                </div>
                <button onclick="closeCustomReportModal()" class="p-2 hover:bg-white hover:bg-opacity-20 rounded-xl transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Conteúdo -->
        <div class="flex-1 overflow-y-auto p-4 sm:p-6 bg-gray-50">
            <div class="max-w-4xl mx-auto">
                <div class="bg-white rounded-2xl p-6 shadow-lg border border-gray-100">
                    <h3 class="text-xl font-bold text-gray-900 mb-6">Configurações do Relatório</h3>
                    
                    <!-- Nome da Fazenda -->
                    <div class="mb-6">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            Nome da Fazenda
                        </label>
                        <input type="text" id="customReportFarmName" 
                               class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 focus:outline-none bg-white shadow-sm transition-all" 
                               placeholder="Digite o nome da fazenda">
                    </div>

                    <!-- Upload da Logo -->
                    <div class="mb-6">
                        <label class="block text-sm font-semibold text-gray-700 mb-3">
                            Logo da Fazenda
                        </label>
                        
                        <!-- Preview da Logo -->
                        <div id="customReportLogoPreview" class="hidden mb-4">
                            <div class="relative inline-block">
                                <img id="customReportLogoImage" src="" alt="Logo da Fazenda" 
                                     class="w-32 h-32 object-contain border-2 border-gray-200 rounded-xl shadow-sm">
                                <button id="removeCustomReportLogo" onclick="removeCustomReportLogo()" 
                                        class="absolute -top-2 -right-2 w-6 h-6 bg-red-500 text-white rounded-full flex items-center justify-center hover:bg-red-600 transition-colors">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>

                        <!-- Placeholder -->
                        <div id="customReportLogoPlaceholder" class="border-2 border-dashed border-gray-300 rounded-xl p-8 text-center hover:border-indigo-400 transition-colors">
                            <svg class="w-12 h-12 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                            </svg>
                            <p class="text-gray-500 text-sm mb-4">Clique para fazer upload da logo da fazenda</p>
                            <button onclick="document.getElementById('customReportLogoUpload').click()" 
                                    class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors">
                                Selecionar Imagem
                            </button>
                            <input type="file" id="customReportLogoUpload" accept="image/*" class="hidden" onchange="handleCustomReportLogoUpload(event)">
                        </div>
                        
                        <p class="text-xs text-gray-500 mt-2">
                            Formatos aceitos: JPG, PNG, GIF. Tamanho máximo: 2MB
                        </p>
                    </div>

                    <!-- Informações do Relatório -->
                    <div class="mb-6 p-4 bg-blue-50 rounded-xl">
                        <h4 class="font-semibold text-blue-900 mb-2">📊 Sobre o Relatório Personalizado</h4>
                        <ul class="text-sm text-blue-800 space-y-1">
                            <li>• Inclui dados de produção dos últimos 50 registros</li>
                            <li>• Logo da fazenda aparece no cabeçalho e como marca d'água</li>
                            <li>• Nome da fazenda personalizado no título</li>
                            <li>• Formato PDF profissional pronto para impressão</li>
                        </ul>
                    </div>

                    <!-- Botões de Ação -->
                    <div class="flex flex-col sm:flex-row gap-4">
                        <button onclick="saveCustomReportSettings()" 
                                class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-6 rounded-xl transition-colors">
                            Salvar Configurações
                        </button>
                        <button onclick="generateCustomReport()" 
                                class="flex-1 bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-xl transition-colors">
                            Gerar Relatório
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Loading Personalizado -->
    <div id="customLoadingModal" class="fixed inset-0 bg-black bg-opacity-50 z-[99999] hidden flex items-center justify-center" style="display: none;">
        <div class="bg-white rounded-2xl p-8 shadow-2xl max-w-sm w-full mx-4">
            <div class="text-center">
                <!-- Ícone de Loading -->
                <div id="customLoadingIcon" class="flex justify-center mb-4">
                    <svg class="w-8 h-8 text-indigo-600 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                </div>
                
                <!-- Mensagem -->
                <h3 id="customLoadingMessage" class="text-lg font-semibold text-gray-900 mb-2">
                    Salvando configurações...
                </h3>
                
                <!-- Barra de Progresso -->
                <div class="w-full bg-gray-200 rounded-full h-2 mb-4">
                    <div class="bg-indigo-600 h-2 rounded-full animate-pulse" style="width: 100%"></div>
                </div>
                
                <!-- Texto de Ajuda -->
                <p class="text-sm text-gray-500">
                    Por favor, aguarde...
                </p>
            </div>
        </div>
    </div>

    <!-- Modal Adicionar Animal - Removido completamente (usando modal dinâmico) -->

    <!-- Modal Adicionar Tratamento -->
    <div id="addTreatmentModal" class="modal hidden">
        <div class="modal-content">
            <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 z-10">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-blue-100 rounded-xl flex items-center justify-center">
                            <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                            </svg>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900">Registrar Tratamento</h3>
                            <p class="text-sm text-gray-500">Registre um tratamento para um animal</p>
                        </div>
                    </div>
                    <button onclick="closeModal('addTreatmentModal')" class="p-2 hover:bg-gray-100 rounded-xl transition-colors">
                        <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>
            
            <div class="p-6">
                <form id="addTreatmentForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Animal</label>
                        <select name="animal_id" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none">
                            <option value="">Selecione o animal</option>
                        </select>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Tipo de Tratamento</label>
                            <select name="treatment_type" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none">
                                <option value="">Selecione o tipo</option>
                                <option value="Medicamento">Medicamento</option>
                                <option value="Vacinação">Vacinação</option>
                                <option value="Vermifugação">Vermifugação</option>
                                <option value="Suplementação">Suplementação</option>
                                <option value="Cirurgia">Cirurgia</option>
                                <option value="Outros">Outros</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Medicamento</label>
                            <input type="text" name="medication" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none" placeholder="Nome do medicamento">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Data do Tratamento</label>
                        <input type="date" name="treatment_date" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Observações</label>
                        <textarea name="observations" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none" placeholder="Observações sobre o tratamento"></textarea>
                    </div>
                    
                    <div class="flex justify-end space-x-3 pt-4">
                        <button type="button" onclick="closeModal('addTreatmentModal')" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                            Cancelar
                        </button>
                        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                            Registrar Tratamento
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Adicionar Inseminação -->
    <div id="addInseminationModal" class="modal hidden">
        <div class="modal-content">
            <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 z-10">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-purple-100 rounded-xl flex items-center justify-center">
                            <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                            </svg>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900">Registrar Inseminação</h3>
                            <p class="text-sm text-gray-500">Registre uma inseminação artificial</p>
                        </div>
                    </div>
                    <button onclick="closeModal('addInseminationModal')" class="p-2 hover:bg-gray-100 rounded-xl transition-colors">
                        <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>
            
            <div class="p-6">
                <form id="addInseminationForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Animal</label>
                        <select name="animal_id" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-purple-500 focus:outline-none">
                            <option value="">Selecione o animal</option>
                        </select>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Data da Inseminação</label>
                            <input type="date" name="insemination_date" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-purple-500 focus:outline-none">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Lote do Sêmen</label>
                            <input type="text" name="semen_batch" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-purple-500 focus:outline-none" placeholder="Número do lote">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Técnico Responsável</label>
                        <input type="text" name="technician" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-purple-500 focus:outline-none" placeholder="Nome do técnico">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Observações</label>
                        <textarea name="observations" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-purple-500 focus:outline-none" placeholder="Observações sobre a inseminação"></textarea>
                    </div>
                    
                    <div class="flex justify-end space-x-3 pt-4">
                        <button type="button" onclick="closeModal('addInseminationModal')" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                            Cancelar
                        </button>
                        <button type="submit" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors">
                            Registrar Inseminação
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Registro Individual por Vaca -->
    <div id="individualVolumeModal" class="modal hidden">
        <div class="modal-content">
            <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 z-10">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-blue-100 rounded-xl flex items-center justify-center">
                            <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19 14l-7 7m0 0l-7-7m7 7V3"></path>
                            </svg>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900">Registro Individual por Vaca</h3>
                            <p class="text-sm text-gray-500">Registre a produção de cada animal individualmente</p>
                        </div>
                    </div>
                    <button onclick="closeModal('individualVolumeModal')" class="p-2 hover:bg-gray-100 rounded-xl transition-colors">
                        <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>
            
            <div class="p-6">
                <form id="individualVolumeForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Vaca</label>
                        <select name="animal_id" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none">
                            <option value="">Selecione a vaca</option>
                        </select>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Data da Ordenha</label>
                            <input type="date" name="production_date" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Horário</label>
                            <select name="milking_time" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none">
                                <option value="">Selecione o horário</option>
                                <option value="manha">Manhã (05:00-07:00)</option>
                                <option value="tarde">Tarde (15:00-17:00)</option>
                                <option value="noite">Noite (19:00-21:00)</option>
                            </select>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Volume Produzido (Litros)</label>
                        <input type="number" name="volume" step="0.1" min="0" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none" placeholder="Ex: 25.5">
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Responsável pela Ordenha</label>
                            <input type="text" name="milker" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none" placeholder="Nome do responsável">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Temperatura do Leite (°C)</label>
                            <input type="number" name="temperature" step="0.1" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none" placeholder="Ex: 37.5">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Observações</label>
                        <textarea name="observations" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none" placeholder="Observações sobre a ordenha (ex: comportamento do animal, problemas, etc.)"></textarea>
                    </div>
                    
                    <div class="flex justify-end space-x-3 pt-4">
                        <button type="button" onclick="closeModal('individualVolumeModal')" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                            Cancelar
                        </button>
                        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                            Registrar Produção
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

<<<<<<< HEAD
<script>
// ===============================================
// JAVASCRIPT - FUNÇÕES AVANÇADAS (CONTINUAÇÃO)
// ===============================================

console.log('✅ Script de funções avançadas carregado');

// Teste: Verificar se as funções estão disponíveis
window.testAdvancedFunctions = function() {
    console.log('🧪 Testando funções avançadas...');
    console.log('showAnimalManagement:', typeof showAnimalManagement);
    console.log('showHealthManagement:', typeof showHealthManagement);
    console.log('showReproductionManagement:', typeof showReproductionManagement);
    console.log('showAnalyticsDashboard:', typeof showAnalyticsDashboard);
};

// Funções para modais de cadastro
function showAddVolumeModal() {
    const modal = document.createElement('div');
    modal.id = 'addVolumeModal';
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    modal.innerHTML = `
        <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Adicionar Volume de Leite</h3>
            <form id="addVolumeForm">
                <div class="mb-4">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Data da Coleta</label>
                    <input type="date" name="collection_date" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Período</label>
                    <select name="period" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none">
                        <option value="manha">Manhã</option>
                        <option value="tarde">Tarde</option>
                        <option value="noite">Noite</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Volume (Litros)</label>
                    <input type="number" name="volume" step="0.1" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none" placeholder="Ex: 25.5">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Temperatura (°C)</label>
                    <input type="number" name="temperature" step="0.1" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none" placeholder="Ex: 4.2">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Observações</label>
                    <textarea name="notes" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none" placeholder="Observações sobre a coleta"></textarea>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="closeAddVolumeModal()" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                        Cancelar
                    </button>
                    <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                        Adicionar
                    </button>
                </div>
            </form>
        </div>
    `;
    document.body.appendChild(modal);
    
    const today = new Date().toISOString().split('T')[0];
    modal.querySelector('input[name="collection_date"]').value = today;
    modal.querySelector('#addVolumeForm').addEventListener('submit', handleAddVolume);
}

function closeAddVolumeModal() {
    const modal = document.getElementById('addVolumeModal');
    if (modal) modal.remove();
}

function showAddQualityModal() {
    const modal = document.createElement('div');
    modal.id = 'addQualityModal';
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    modal.innerHTML = `
        <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Adicionar Teste de Qualidade</h3>
            <form id="addQualityForm">
                <div class="mb-4">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Data do Teste</label>
                    <input type="date" name="test_date" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Gordura (%)</label>
                    <input type="number" name="fat_percentage" step="0.1" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none" placeholder="Ex: 3.5">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Proteína (%)</label>
                    <input type="number" name="protein_percentage" step="0.1" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none" placeholder="Ex: 3.2">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Contagem de Células Somáticas</label>
                    <input type="number" name="scc" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none" placeholder="Ex: 150000">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Contagem Bacteriana Total</label>
                    <input type="number" name="cbt" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none" placeholder="Ex: 25000">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Laboratório</label>
                    <input type="text" name="laboratory" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none" placeholder="Ex: Laboratório ABC">
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="closeAddQualityModal()" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                        Cancelar
                    </button>
                    <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                        Adicionar
                    </button>
                </div>
            </form>
        </div>
    `;
    document.body.appendChild(modal);
    
    const today = new Date().toISOString().split('T')[0];
    modal.querySelector('input[name="test_date"]').value = today;
    modal.querySelector('#addQualityForm').addEventListener('submit', handleAddQuality);
}

function closeAddQualityModal() {
    const modal = document.getElementById('addQualityModal');
    if (modal) modal.remove();
}

function showVolumeByCowModal() {
    const modal = document.createElement('div');
    modal.id = 'volumeByCowModal';
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    modal.innerHTML = `
        <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Volume por Vaca</h3>
            <form id="volumeByCowForm">
                <div class="mb-4">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Número da Vaca</label>
                    <input type="text" name="cow_number" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none" placeholder="Ex: 001, 002, etc.">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Data da Ordenha</label>
                    <input type="date" name="milking_date" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Período</label>
                    <select name="period" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none">
                        <option value="manha">Manhã</option>
                        <option value="tarde">Tarde</option>
                        <option value="noite">Noite</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Volume (Litros)</label>
                    <input type="number" name="volume" step="0.1" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none" placeholder="Ex: 15.5">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Temperatura (°C)</label>
                    <input type="number" name="temperature" step="0.1" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none" placeholder="Ex: 37.5">
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="closeVolumeByCowModal()" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                        Cancelar
                    </button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                        Registrar
                    </button>
                </div>
            </form>
        </div>
    `;
    document.body.appendChild(modal);
    
    const today = new Date().toISOString().split('T')[0];
    modal.querySelector('input[name="milking_date"]').value = today;
    modal.querySelector('#volumeByCowForm').addEventListener('submit', handleVolumeByCow);
}

function closeVolumeByCowModal() {
    const modal = document.getElementById('volumeByCowModal');
    if (modal) modal.remove();
}

// Funções de manipulação dos formulários
async function handleAddVolume(e) {
    e.preventDefault();
    const formData = new FormData(e.target);
    const data = Object.fromEntries(formData.entries());
    
    try {
        const response = await fetch('api/volume.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'insert', ...data, farm_id: 1 })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showNotification('Volume adicionado com sucesso!', 'success');
            closeAddVolumeModal();
            await loadVolumeData();
            await loadVolumeRecords();
        } else {
            showNotification('Erro ao adicionar volume: ' + result.error, 'error');
        }
    } catch (error) {
        showNotification('Erro ao adicionar volume: ' + error.message, 'error');
    }
}

async function handleAddQuality(e) {
    e.preventDefault();
    const formData = new FormData(e.target);
    const data = Object.fromEntries(formData.entries());
    
    try {
        const response = await fetch('api/quality.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'insert', ...data, farm_id: 1 })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showNotification('Teste de qualidade adicionado com sucesso!', 'success');
            closeAddQualityModal();
            await loadQualityData();
            await loadQualityTests();
        } else {
            showNotification('Erro ao adicionar teste: ' + result.error, 'error');
        }
    } catch (error) {
        showNotification('Erro ao adicionar teste: ' + error.message, 'error');
    }
}

async function handleVolumeByCow(e) {
    e.preventDefault();
    const formData = new FormData(e.target);
    const data = Object.fromEntries(formData.entries());
    
    try {
        const response = await fetch('api/volume.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'insert', ...data, farm_id: 1, cow_number: data.cow_number })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showNotification('Volume por vaca registrado com sucesso!', 'success');
            closeVolumeByCowModal();
            await loadVolumeData();
            await loadVolumeRecords();
        } else {
            showNotification('Erro ao registrar volume: ' + result.error, 'error');
        }
    } catch (error) {
        showNotification('Erro ao registrar volume: ' + error.message, 'error');
    }
}

// =====================================================
// FUNÇÕES PARA GESTÃO DE ANIMAIS
// =====================================================

function showAnimalManagement() {
    try {
        console.log('🐄 Abrindo Gestão de Rebanho...');
        
        // Remover modal anterior se existir
        const existingModal = document.getElementById('animalManagementModal');
        if (existingModal) {
            existingModal.remove();
        }
        
        const modal = document.createElement('div');
        modal.id = 'animalManagementModal';
        modal.className = 'fixed inset-0 bg-white z-[99999] overflow-y-auto';
        modal.style.display = 'block';
        modal.innerHTML = `
        <div class="w-full h-full">
            <!-- Header -->
            <div class="sticky top-0 bg-gradient-to-br from-emerald-600 to-teal-600 text-white shadow-lg z-10 p-6">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <button onclick="closeAnimalManagement()" class="w-10 h-10 flex items-center justify-center hover:bg-white hover:bg-opacity-20 rounded-xl transition-colors">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"></path>
                            </svg>
                        </button>
                        <div>
                            <h3 class="text-2xl font-bold">Gestão de Rebanho</h3>
                            <p class="text-emerald-100 text-sm">Gerencie animais e inseminações</p>
                        </div>
                    </div>
                    <div class="w-12 h-12 bg-white bg-opacity-20 rounded-2xl flex items-center justify-center">
                        <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                        </svg>
                    </div>
                </div>
            </div>
            
            <!-- Conteúdo -->
            <div class="p-6">
            
            <!-- Abas -->
            <div class="flex border-b border-gray-200 mb-6">
                <button onclick="switchAnimalTab('animals')" id="animalsTab" class="px-4 py-2 text-sm font-medium text-blue-600 border-b-2 border-blue-600">
                    Cadastro de Animais
                </button>
                <button onclick="switchAnimalTab('inseminations')" id="inseminationsTab" class="px-4 py-2 text-sm font-medium text-gray-500 border-b-2 border-transparent">
                    Inseminações
                </button>
                <button onclick="switchAnimalTab('pedigree')" id="pedigreeTab" class="px-4 py-2 text-sm font-medium text-gray-500 border-b-2 border-transparent">
                    Árvore Genealógica
                </button>
                <button onclick="switchAnimalTab('productivity')" id="productivityTab" class="px-4 py-2 text-sm font-medium text-gray-500 border-b-2 border-transparent">
                    Produtividade
                </button>
            </div>
            
            <!-- Conteúdo das Abas -->
            <div id="animalsContent" class="tab-content">
                <div class="flex justify-between items-center mb-4">
                    <h4 class="text-lg font-semibold">Lista de Animais</h4>
                    <button onclick="showAddAnimalModal()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                        + Novo Animal
                    </button>
                </div>
                
                <!-- Barra de Pesquisa -->
                <div class="mb-4">
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                            </svg>
                        </div>
                        <input type="text" id="animalsSearchInput" 
                            class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
                            placeholder="Pesquisar por número, nome, raça ou sexo...">
                    </div>
                </div>
                
                <div id="animalsList" class="overflow-x-auto">
                    <!-- Lista será carregada aqui -->
                </div>
            </div>
            
            <div id="inseminationsContent" class="tab-content hidden">
                <div class="flex justify-between items-center mb-4">
                    <h4 class="text-lg font-semibold">Histórico de Inseminações</h4>
                    <button onclick="showAddInseminationModal()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                        + Nova Inseminação
                    </button>
                </div>
                <div id="inseminationsList" class="overflow-x-auto">
                    <!-- Lista será carregada aqui -->
                </div>
            </div>
            
            <div id="pedigreeContent" class="tab-content hidden">
                <div class="flex items-center justify-between mb-4">
                    <h4 class="text-lg font-semibold">Árvore Genealógica</h4>
                </div>
                
                <!-- Barra de Pesquisa -->
                <div class="mb-6">
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                            </svg>
                        </div>
                        <input type="text" id="pedigreeSearchInput" 
                            class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
                            placeholder="Pesquisar animal por número ou nome...">
                    </div>
                    <div class="mt-3">
                        <select id="pedigreeAnimalSelect" 
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500">
                            <option value="">Selecione um animal ou use a pesquisa acima</option>
                        </select>
                    </div>
                </div>
                
                <div id="pedigreeTree" class="bg-gray-50 p-4 rounded-lg min-h-[200px]">
                    <div class="text-center text-gray-500 py-8">
                        <svg class="w-16 h-16 mx-auto text-gray-300 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/>
                        </svg>
                        <p>Selecione um animal para visualizar sua árvore genealógica</p>
                    </div>
                </div>
            </div>
            
            <div id="productivityContent" class="tab-content hidden">
                <h4 class="text-lg font-semibold mb-4">Produtividade dos Animais</h4>
                <div id="productivityList" class="overflow-x-auto">
                    <!-- Lista será carregada aqui -->
                </div>
            </div>
        </div>
    `;
        document.body.appendChild(modal);
        
        console.log('✅ Modal de Gestão de Rebanho criado e adicionado');
        
        // Carregar dados iniciais
        loadAnimalsList();
        loadInseminationsList();
        loadAnimalsForPedigree();
        loadProductivityData();
        
    } catch (error) {
        console.error('❌ Erro ao abrir Gestão de Rebanho:', error);
        showNotification('Erro ao abrir Gestão de Rebanho: ' + error.message, 'error');
    }
}

function closeAnimalManagement() {
    const modal = document.getElementById('animalManagementModal');
    if (modal) modal.remove();
}

function switchAnimalTab(tabName) {
    // Esconder todas as abas
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.add('hidden');
    });
    
    // Remover estilo ativo de todos os botões
    document.querySelectorAll('[id$="Tab"]').forEach(btn => {
        btn.classList.remove('text-blue-600', 'border-blue-600');
        btn.classList.add('text-gray-500', 'border-transparent');
    });
    
    // Mostrar aba selecionada
    document.getElementById(tabName + 'Content').classList.remove('hidden');
    document.getElementById(tabName + 'Tab').classList.remove('text-gray-500', 'border-transparent');
    document.getElementById(tabName + 'Tab').classList.add('text-blue-600', 'border-blue-600');
}

// =====================================================
// MODAIS DE CADASTRO - GESTÃO DE ANIMAIS
// =====================================================

function showAddAnimalModal() {
    const modal = document.createElement('div');
    modal.id = 'addAnimalModal';
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[100000] p-4';
    modal.innerHTML = `
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-3xl max-h-[95vh] overflow-hidden flex flex-col">
            <!-- Header -->
            <div class="bg-gradient-to-r from-emerald-600 to-teal-600 text-white p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-2xl font-bold">Cadastrar Novo Animal</h3>
                        <p class="text-emerald-100 text-sm mt-1">Preencha os dados do animal</p>
                    </div>
                    <button type="button" onclick="document.getElementById('addAnimalModal').remove()" 
                        class="text-white hover:bg-white hover:bg-opacity-20 rounded-lg p-2 transition">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
            </div>
            
            <!-- Body -->
            <form id="addAnimalForm" class="flex-1 overflow-y-auto p-6 space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Número do Animal *</label>
                        <input type="text" name="animal_number" required 
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
                            placeholder="Ex: 001" tabindex="1">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Nome</label>
                        <input type="text" name="animal_name" 
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
                            placeholder="Ex: Mimosa" tabindex="2">
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Raça *</label>
                        <select name="breed" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500" tabindex="3">
                            <option value="">Selecione...</option>
                            <option value="Holandês">Holandês</option>
                            <option value="Jersey">Jersey</option>
                            <option value="Gir">Gir</option>
                            <option value="Girolando">Girolando</option>
                            <option value="Mestiço">Mestiço</option>
                            <option value="Outro">Outro</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Data de Nascimento *</label>
                        <input type="date" name="birth_date" required 
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500" 
                            tabindex="4">
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Sexo *</label>
                        <select name="gender" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500" tabindex="5">
                            <option value="Fêmea">Fêmea</option>
                            <option value="Macho">Macho</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Status *</label>
                        <select name="status" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500" tabindex="6">
                            <option value="">Selecione o status</option>
                            <option value="Lactante">Lactante</option>
                            <option value="Seco">Seco</option>
                            <option value="Novilha">Novilha</option>
                            <option value="Vaca">Vaca</option>
                            <option value="Bezerra">Bezerra</option>
                            <option value="Bezerro">Bezerro</option>
                            <option value="Touro">Touro</option>
                        </select>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Peso ao Nascer (kg)</label>
                        <input type="number" name="birth_weight" step="0.1" min="0" max="100"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
                            placeholder="Ex: 35.5" tabindex="7">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Observações</label>
                        <textarea name="notes" rows="2" 
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
                            placeholder="Informações adicionais sobre o animal..." tabindex="8"></textarea>
                    </div>
                </div>
                
                <div class="border-t pt-4 mt-4">
                    <h4 class="font-semibold text-gray-700 mb-3">📋 Informações Genealógicas (Opcional)</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Pai</label>
                            <select name="father_id" id="fatherSelect" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500">
                                <option value="">Selecione o pai (ou deixe em branco)</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Mãe</label>
                            <select name="mother_id" id="motherSelect" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500">
                                <option value="">Selecione a mãe (ou deixe em branco)</option>
                            </select>
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">
                        <strong>Dica:</strong> Cadastre primeiro os reprodutores (touros e vacas adultas) sem pedigree, depois cadastre os filhotes com pedigree completo.
                    </p>
                </div>
            </form>
            
            <!-- Footer -->
            <div class="bg-gray-50 px-6 py-4 border-t flex flex-col sm:flex-row gap-3">
                <button type="button" onclick="document.getElementById('addAnimalModal').remove()" 
                    class="flex-1 sm:order-1 bg-gray-500 text-white py-3 px-6 rounded-lg hover:bg-gray-600 transition font-semibold flex items-center justify-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                    <span>Cancelar</span>
                </button>
                <button type="submit" form="addAnimalForm"
                    class="flex-1 sm:order-2 bg-gradient-to-r from-emerald-600 to-teal-600 text-white py-3 px-6 rounded-lg hover:from-emerald-700 hover:to-teal-700 transition font-bold flex items-center justify-center gap-2 shadow-lg">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                    </svg>
                    <span>Cadastrar Animal</span>
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Carregar animais disponíveis para pedigree
    loadAnimalsForPedigreeSelection();
    
    // Handler do formulário
    document.getElementById('addAnimalForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData);
        
        // Converter dados para o formato esperado pelo backend
        const payload = {
            animal_number: data.animal_number,
            name: data.animal_name || null, // Converter animal_name para name
            breed: data.breed,
            gender: data.gender === 'Fêmea' ? 'femea' : 'macho', // Converter para lowercase
            birth_date: data.birth_date,
            birth_weight: data.birth_weight || null,
            father_id: data.father_id || null,
            mother_id: data.mother_id || null,
            status: data.status,
            health_status: 'saudavel', // Valor padrão
            reproductive_status: 'vazia', // Valor padrão
            notes: data.notes || null
        };
        
        // Debug: Log dos dados do formulário
        console.log('DEBUG - Dados do formulário:', data);
        console.log('DEBUG - Payload processado:', payload);
        
        try {
            const response = await fetch('api/animals/create.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            
            console.log('DEBUG - Response status:', response.status);
            const result = await response.json();
            console.log('DEBUG - Resultado da API:', result);
            
            if (result.success) {
                showNotification('✅ Animal cadastrado com sucesso!', 'success');
                modal.remove();
                // Aguardar um pouco antes de recarregar a lista
                setTimeout(() => {
                    loadAnimalsList();
                }, 500);
            } else {
                showNotification('❌ Erro: ' + result.error, 'error');
            }
        } catch (error) {
            console.error('DEBUG - Erro na requisição:', error);
            showNotification('❌ Erro ao cadastrar: ' + error.message, 'error');
        }
    });
}

function showAddInseminationModal() {
    const modal = document.createElement('div');
    modal.id = 'addInseminationModal';
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[100000] p-4';
    modal.innerHTML = `
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[95vh] overflow-hidden flex flex-col">
            <!-- Header -->
            <div class="bg-gradient-to-r from-teal-600 to-cyan-600 text-white p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-2xl font-bold">Registrar Inseminação</h3>
                        <p class="text-teal-100 text-sm mt-1">Registre a inseminação artificial</p>
                    </div>
                    <button type="button" onclick="document.getElementById('addInseminationModal').remove()" 
                        class="text-white hover:bg-white hover:bg-opacity-20 rounded-lg p-2 transition">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
            </div>
            
            <!-- Body -->
            <form id="addInseminationForm" class="flex-1 overflow-y-auto p-6 space-y-5">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Animal *</label>
                    <select name="animal_id" id="inseminationAnimalSelect" required 
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500">
                        <option value="">Carregando animais...</option>
                    </select>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Data da Inseminação *</label>
                        <input type="date" name="insemination_date" required 
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Touro/Sêmen *</label>
                        <input type="text" name="bull_id" required 
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500"
                            placeholder="Nome ou código do touro">
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Técnico Responsável</label>
                    <input type="text" name="technician_name" 
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500"
                        placeholder="Nome do técnico">
                </div>
                
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        Observações <span class="text-gray-400 font-normal">(opcional)</span>
                    </label>
                    <textarea name="notes" rows="3" 
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500 resize-none"
                        placeholder="Informações adicionais sobre a inseminação"></textarea>
                </div>
            </form>
            
            <!-- Footer -->
            <div class="bg-gray-50 px-6 py-4 border-t flex flex-col sm:flex-row gap-3">
                <button type="button" onclick="document.getElementById('addInseminationModal').remove()" 
                    class="flex-1 sm:order-1 bg-gray-500 text-white py-3 px-6 rounded-lg hover:bg-gray-600 transition font-semibold flex items-center justify-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                    <span>Cancelar</span>
                </button>
                <button type="submit" form="addInseminationForm"
                    class="flex-1 sm:order-2 bg-gradient-to-r from-teal-600 to-cyan-600 text-white py-3 px-6 rounded-lg hover:from-teal-700 hover:to-cyan-700 transition font-bold flex items-center justify-center gap-2 shadow-lg">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                    </svg>
                    <span>Registrar Inseminação</span>
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Carregar lista de animais
    loadAnimalsForInsemination();
    
    // Handler do formulário
    document.getElementById('addInseminationForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData);
        
        try {
            const response = await fetch('api/inseminations.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'insert', ...data })
            });
            
            const result = await response.json();
            
            if (result.success) {
                showNotification('✅ Inseminação registrada com sucesso!', 'success');
                modal.remove();
                loadInseminationsList();
            } else {
                showNotification('❌ Erro: ' + result.error, 'error');
            }
        } catch (error) {
            showNotification('❌ Erro ao registrar: ' + error.message, 'error');
        }
    });
}

async function loadAnimalsForInsemination() {
    try {
        const response = await fetch('api/animals.php?action=select');
        const result = await response.json();
        
        if (result.success) {
            const select = document.getElementById('inseminationAnimalSelect');
            const females = result.data.filter(a => a.gender === 'Fêmea');
            
            select.innerHTML = '<option value="">Selecione uma vaca...</option>' +
                females.map(a => `<option value="${a.id}">${a.animal_number} - ${a.animal_name || 'Sem nome'}</option>`).join('');
        }
    } catch (error) {
        console.error('Erro ao carregar animais:', error);
    }
}

async function loadAnimalsForPedigreeSelection() {
    try {
        const response = await fetch('api/animals.php?action=select');
        const result = await response.json();
        
        if (result.success && result.data) {
            const fatherSelect = document.getElementById('fatherSelect');
            const motherSelect = document.getElementById('motherSelect');
            
            // Filtrar machos para pai
            const males = result.data.filter(a => a.gender === 'Macho');
            if (fatherSelect) {
                fatherSelect.innerHTML = '<option value="">Selecione o pai (ou deixe em branco)</option>' +
                    males.map(a => `<option value="${a.id}">${a.animal_number} - ${a.animal_name || a.breed}</option>`).join('');
            }
            
            // Filtrar fêmeas para mãe
            const females = result.data.filter(a => a.gender === 'Fêmea');
            if (motherSelect) {
                motherSelect.innerHTML = '<option value="">Selecione a mãe (ou deixe em branco)</option>' +
                    females.map(a => `<option value="${a.id}">${a.animal_number} - ${a.animal_name || a.breed}</option>`).join('');
            }
        }
    } catch (error) {
        console.error('Erro ao carregar animais para pedigree:', error);
    }
}

// =====================================================
// SELETOR DE DATA CUSTOMIZADO PARA MOBILE
// =====================================================

function initializeDatePicker() {
    // Preencher anos (últimos 10 anos)
    const yearSelect = document.getElementById('year_select');
    const currentYear = new Date().getFullYear();
    
    for (let i = 0; i < 10; i++) {
        const year = currentYear - i;
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        yearSelect.appendChild(option);
    }
    
    // Preencher dias (1-31)
    const daySelect = document.getElementById('day_select');
    for (let i = 1; i <= 31; i++) {
        const option = document.createElement('option');
        option.value = i.toString().padStart(2, '0');
        option.textContent = i;
        daySelect.appendChild(option);
    }
    
    // Event listener para abrir seletor
    const birthDateDisplay = document.getElementById('birth_date_display');
    if (birthDateDisplay) {
        birthDateDisplay.addEventListener('click', openDatePicker);
    }
    
    // Event listeners para mudanças nos selects
    const monthSelect = document.getElementById('month_select');
    const daySelectEl = document.getElementById('day_select');
    
    if (monthSelect) {
        monthSelect.addEventListener('change', updateDaysForMonth);
    }
    
    if (daySelectEl) {
        daySelectEl.addEventListener('change', updateDaysForMonth);
    }
}

function openDatePicker() {
    const modal = document.getElementById('date_picker_modal');
    if (modal) {
        modal.classList.remove('hidden');
        
        // Definir valores padrão (data atual)
        const today = new Date();
        document.getElementById('day_select').value = today.getDate().toString().padStart(2, '0');
        document.getElementById('month_select').value = (today.getMonth() + 1).toString().padStart(2, '0');
        document.getElementById('year_select').value = today.getFullYear();
        
        updateDaysForMonth();
    }
}

function closeDatePicker() {
    const modal = document.getElementById('date_picker_modal');
    if (modal) {
        modal.classList.add('hidden');
    }
}

function updateDaysForMonth() {
    const monthSelect = document.getElementById('month_select');
    const daySelect = document.getElementById('day_select');
    const yearSelect = document.getElementById('year_select');
    
    if (!monthSelect || !daySelect || !yearSelect) return;
    
    const month = parseInt(monthSelect.value);
    const year = parseInt(yearSelect.value);
    
    if (month && year) {
        // Calcular dias no mês
        const daysInMonth = new Date(year, month, 0).getDate();
        const currentDay = parseInt(daySelect.value);
        
        // Remover opções de dias que não existem no mês
        const options = daySelect.querySelectorAll('option');
        options.forEach(option => {
            if (option.value && parseInt(option.value) > daysInMonth) {
                option.style.display = 'none';
            } else {
                option.style.display = 'block';
            }
        });
        
        // Se o dia atual não existe no mês, ajustar para o último dia
        if (currentDay > daysInMonth) {
            daySelect.value = daysInMonth.toString().padStart(2, '0');
        }
    }
}

function confirmDateSelection() {
    const day = document.getElementById('day_select').value;
    const month = document.getElementById('month_select').value;
    const year = document.getElementById('year_select').value;
    
    if (!day || !month || !year) {
        showNotification('Por favor, selecione dia, mês e ano', 'warning');
        return;
    }
    
    // Formatar data para YYYY-MM-DD
    const formattedDate = `${year}-${month}-${day}`;
    
    // Validar se a data é válida
    const date = new Date(year, month - 1, day);
    if (date.getFullYear() != year || date.getMonth() != month - 1 || date.getDate() != day) {
        showNotification('Data inválida', 'error');
        return;
    }
    
    // Validar se não é data futura
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    if (date > today) {
        showNotification('A data de nascimento não pode ser futura', 'error');
        return;
    }
    
    // Validar se não é muito antiga (mais de 20 anos)
    const twentyYearsAgo = new Date();
    twentyYearsAgo.setFullYear(twentyYearsAgo.getFullYear() - 20);
    if (date < twentyYearsAgo) {
        showNotification('A data de nascimento não pode ser há mais de 20 anos', 'error');
        return;
    }
    
    // Atualizar campos
    document.getElementById('birth_date_value').value = formattedDate;
    document.getElementById('birth_date_display').value = `${day}/${month}/${year}`;
    
    closeDatePicker();
    showNotification('Data selecionada com sucesso!', 'success');
}

async function loadAnimalsList() {
    try {
        const response = await fetch('api/animals.php?action=select');
        const result = await response.json();
        
        if (!result.success) {
            throw new Error(result.error);
        }
        
        const animals = result.data || [];
        const container = document.getElementById('animalsList');
        const searchInput = document.getElementById('animalsSearchInput');
        
        if (animals.length === 0) {
            container.innerHTML = '<p class="text-gray-500 text-center py-8">Nenhum animal cadastrado</p>';
            return;
        }
        
        // Função para renderizar a tabela
        function renderAnimalsTable(animalsToRender) {
            if (animalsToRender.length === 0) {
                return '<p class="text-gray-500 text-center py-8">Nenhum animal encontrado com esses critérios</p>';
            }
            
            return `
            <table class="min-w-full bg-white border border-gray-200 rounded-lg">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Número</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nome</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Raça</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nascimento</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sexo</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Prenha</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ações</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
                    ${animals.map(animal => `
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${animal.animal_number}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${animal.name || '-'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${animal.breed}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${new Date(animal.birth_date).toLocaleDateString('pt-BR')}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 capitalize">${animal.sex}</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="px-2 py-1 text-xs font-semibold rounded-full ${animal.status === 'ativo' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                    ${animal.status}
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                ${animal.is_pregnant ? 
                                    `<span class="px-2 py-1 text-xs font-semibold rounded-full bg-pink-100 text-pink-800">
                                        ${animal.expected_birth_date ? 'DPP: ' + new Date(animal.expected_birth_date).toLocaleDateString('pt-BR') : 'Prenha'}
                                    </span>` : 
                                    '<span class="text-gray-400">-</span>'
                                }
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                <button onclick="viewAnimal(${animal.id})" class="text-blue-600 hover:text-blue-900 mr-2">Ver</button>
                                <button onclick="editAnimal(${animal.id})" class="text-green-600 hover:text-green-900 mr-2">Editar</button>
                                <button onclick="deleteAnimal(${animal.id})" class="text-red-600 hover:text-red-900">Excluir</button>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
            `;
        }
        
        // Renderizar lista completa
        container.innerHTML = renderAnimalsTable(animals);
        
        // Adicionar evento de pesquisa
        if (searchInput) {
            searchInput.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase().trim();
                
                if (searchTerm === '') {
                    container.innerHTML = renderAnimalsTable(animals);
                } else {
                    const filtered = animals.filter(animal => {
                        const number = animal.animal_number?.toLowerCase() || '';
                        const name = animal.animal_name?.toLowerCase() || '';
                        const breed = animal.breed?.toLowerCase() || '';
                        const gender = animal.gender?.toLowerCase() || '';
                        
                        return number.includes(searchTerm) || 
                               name.includes(searchTerm) || 
                               breed.includes(searchTerm) ||
                               gender.includes(searchTerm);
                    });
                    
                    container.innerHTML = renderAnimalsTable(filtered);
                }
            });
        }
        
    } catch (error) {
        document.getElementById('animalsList').innerHTML = '<p class="text-red-500 text-center py-8">Erro ao carregar animais: ' + error.message + '</p>';
    }
}

async function loadInseminationsList() {
    try {
        const response = await fetch('api/inseminations.php?action=select');
        const result = await response.json();
        
        if (!result.success) {
            throw new Error(result.error);
        }
        
        const inseminations = result.data || [];
        const container = document.getElementById('inseminationsList');
        
        if (inseminations.length === 0) {
            container.innerHTML = '<p class="text-gray-500 text-center py-8">Nenhuma inseminação registrada</p>';
            return;
        }
        
        container.innerHTML = `
            <table class="min-w-full bg-white border border-gray-200 rounded-lg">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Animal</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Touro</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Técnico</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Resultado</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ações</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
                    ${inseminations.map(ins => `
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                ${ins.animal_number} ${ins.animal_name ? '(' + ins.animal_name + ')' : ''}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                ${new Date(ins.insemination_date).toLocaleDateString('pt-BR')}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                ${ins.bull_name || '-'}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                ${ins.technician_name || '-'}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="px-2 py-1 text-xs font-semibold rounded-full ${
                                    ins.pregnancy_result === 'positivo' ? 'bg-green-100 text-green-800' :
                                    ins.pregnancy_result === 'negativo' ? 'bg-red-100 text-red-800' :
                                    'bg-yellow-100 text-yellow-800'
                                }">
                                    ${ins.pregnancy_result || 'Pendente'}
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                <button onclick="viewInsemination(${ins.id})" class="text-blue-600 hover:text-blue-900 mr-2">Ver</button>
                                <button onclick="editInsemination(${ins.id})" class="text-green-600 hover:text-green-900 mr-2">Editar</button>
                                <button onclick="deleteInsemination(${ins.id})" class="text-red-600 hover:text-red-900">Excluir</button>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
    } catch (error) {
        document.getElementById('inseminationsList').innerHTML = '<p class="text-red-500 text-center py-8">Erro ao carregar inseminações: ' + error.message + '</p>';
    }
}

async function loadAnimalsForPedigree() {
    try {
        const response = await fetch('api/animals.php?action=select');
        const result = await response.json();
        
        if (result.success && result.data) {
            const select = document.getElementById('pedigreeAnimalSelect');
            const searchInput = document.getElementById('pedigreeSearchInput');
            const allAnimals = result.data;
            
            // Função para renderizar a lista
            function renderAnimalsList(animals) {
                select.innerHTML = '<option value="">Selecione um animal ou use a pesquisa acima</option>' +
                    animals.map(animal => 
                        `<option value="${animal.id}">${animal.animal_number} ${animal.animal_name ? '- ' + animal.animal_name : ''} (${animal.breed})</option>`
                    ).join('');
            }
            
            // Renderizar lista completa
            renderAnimalsList(allAnimals);
            
            // Evento de mudança no select
            select.addEventListener('change', function() {
                if (this.value) {
                    loadPedigreeTree(this.value);
                } else {
                    document.getElementById('pedigreeTree').innerHTML = `
                        <div class="text-center text-gray-500 py-8">
                            <svg class="w-16 h-16 mx-auto text-gray-300 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/>
                            </svg>
                            <p>Selecione um animal para visualizar sua árvore genealógica</p>
                        </div>
                    `;
                }
            });
            
            // Evento de pesquisa
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    const searchTerm = this.value.toLowerCase().trim();
                    
                    if (searchTerm === '') {
                        renderAnimalsList(allAnimals);
                    } else {
                        const filtered = allAnimals.filter(animal => {
                            const number = animal.animal_number?.toLowerCase() || '';
                            const name = animal.animal_name?.toLowerCase() || '';
                            const breed = animal.breed?.toLowerCase() || '';
                            
                            return number.includes(searchTerm) || 
                                   name.includes(searchTerm) || 
                                   breed.includes(searchTerm);
                        });
                        
                        renderAnimalsList(filtered);
                        
                        // Se houver apenas 1 resultado, selecionar automaticamente
                        if (filtered.length === 1) {
                            select.value = filtered[0].id;
                            select.dispatchEvent(new Event('change'));
                        }
                    }
                });
            }
        }
    } catch (error) {
        console.error('Erro ao carregar animais para pedigree:', error);
    }
}

async function loadPedigreeTree(animalId) {
    try {
        const response = await fetch(`api/animals.php?action=get_pedigree&id=${animalId}`);
        const result = await response.json();
        
        if (!result.success) {
            throw new Error(result.error);
        }
        
        const pedigree = result.data || {};
        const container = document.getElementById('pedigreeTree');
        
        // Verificar se há dados de pedigree
        if (!pedigree.father_id && !pedigree.mother_id) {
            container.innerHTML = `
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 text-center">
                    <p class="text-yellow-800">
                        ⚠️ Este animal não possui informações genealógicas cadastradas.
                    </p>
                    <p class="text-sm text-yellow-600 mt-2">
                        Para visualizar a árvore genealógica, cadastre as informações de pai e mãe.
                    </p>
                </div>
            `;
            return;
        }
        
        container.innerHTML = `
            <div class="space-y-4">
                <h5 class="font-semibold text-gray-900">Árvore Genealógica</h5>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <!-- Avós Paternos -->
                    <div class="bg-white p-4 rounded-lg border">
                        <h6 class="font-medium text-gray-700 mb-2">Avós Paternos</h6>
                        <div class="space-y-2 text-sm">
                            <div><strong>Avô:</strong> ${pedigree.grandfather_number || 'Não cadastrado'}</div>
                            <div><strong>Avó:</strong> ${pedigree.grandmother_father_number || 'Não cadastrado'}</div>
                        </div>
                    </div>
                    
                    <!-- Pais -->
                    <div class="bg-white p-4 rounded-lg border">
                        <h6 class="font-medium text-gray-700 mb-2">Pais</h6>
                        <div class="space-y-2 text-sm">
                            <div><strong>Pai:</strong> ${pedigree.father_number || 'Não cadastrado'}</div>
                            <div><strong>Mãe:</strong> ${pedigree.mother_number || 'Não cadastrado'}</div>
                        </div>
                    </div>
                    
                    <!-- Avós Maternos -->
                    <div class="bg-white p-4 rounded-lg border">
                        <h6 class="font-medium text-gray-700 mb-2">Avós Maternos</h6>
                        <div class="space-y-2 text-sm">
                            <div><strong>Avô:</strong> ${pedigree.grandfather_mother_number || '-'} ${pedigree.grandfather_mother_name ? '(' + pedigree.grandfather_mother_name + ')' : ''}</div>
                            <div><strong>Avó:</strong> ${pedigree.grandmother_mother_number || '-'} ${pedigree.grandmother_mother_name ? '(' + pedigree.grandmother_mother_name + ')' : ''}</div>
                        </div>
                    </div>
                </div>
                
                <!-- Animal Principal -->
                <div class="bg-blue-50 p-4 rounded-lg border-2 border-blue-200">
                    <h6 class="font-medium text-blue-900 mb-2">Animal Principal</h6>
                    <div class="text-sm">
                        <div><strong>Número:</strong> ${pedigree.animal_number}</div>
                        <div><strong>Nome:</strong> ${pedigree.name || '-'}</div>
                        <div><strong>Raça:</strong> ${pedigree.breed}</div>
                        <div><strong>Nascimento:</strong> ${new Date(pedigree.birth_date).toLocaleDateString('pt-BR')}</div>
                    </div>
                </div>
            </div>
        `;
    } catch (error) {
        document.getElementById('pedigreeTree').innerHTML = '<p class="text-red-500">Erro ao carregar pedigree: ' + error.message + '</p>';
    }
}

async function loadProductivityData() {
    try {
        const response = await fetch('api/animals.php?action=get_productivity');
        const result = await response.json();
        
        if (!result.success) {
            throw new Error(result.error);
        }
        
        const animals = result.data || [];
        const container = document.getElementById('productivityList');
        
        if (animals.length === 0) {
            container.innerHTML = '<p class="text-gray-500 text-center py-8">Nenhum dado de produtividade disponível</p>';
            return;
        }
        
        container.innerHTML = `
            <table class="min-w-full bg-white border border-gray-200 rounded-lg">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Animal</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Lactação</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Média Diária</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Lactação</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
                    ${animals.map(animal => `
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                ${animal.animal_number} ${animal.name ? '(' + animal.name + ')' : ''}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                ${animal.lactation_number || 0}ª
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                ${animal.current_lactation_avg ? animal.current_lactation_avg.toFixed(1) + ' L' : '-'}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                ${animal.current_lactation_total ? animal.current_lactation_total.toFixed(0) + ' L' : '-'}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                ${animal.is_pregnant ? 
                                    `<span class="px-2 py-1 text-xs font-semibold rounded-full bg-pink-100 text-pink-800">
                                        Prenha
                                    </span>` : 
                                    '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">Lactando</span>'
                                }
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
    } catch (error) {
        document.getElementById('productivityList').innerHTML = '<p class="text-red-500 text-center py-8">Erro ao carregar produtividade: ' + error.message + '</p>';
    }
}

// =====================================================
// FUNÇÕES PARA GESTÃO SANITÁRIA
// =====================================================

function showHealthManagement() {
    try {
        console.log('💚 Abrindo Gestão Sanitária...');
        
        // Remover modal anterior se existir
        const existingModal = document.getElementById('healthManagementModal');
        if (existingModal) {
            existingModal.remove();
        }
        
        const modal = document.createElement('div');
        modal.id = 'healthManagementModal';
        modal.className = 'fixed inset-0 bg-white z-[99999] overflow-y-auto';
        modal.style.display = 'block';
        modal.innerHTML = `
        <div class="w-full h-full">
            <!-- Header -->
            <div class="sticky top-0 bg-gradient-to-br from-green-600 to-emerald-700 text-white shadow-lg z-10 p-6">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <button onclick="closeHealthManagement()" class="w-10 h-10 flex items-center justify-center hover:bg-white hover:bg-opacity-20 rounded-xl transition-colors">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"></path>
                            </svg>
                        </button>
                        <div>
                            <h3 class="text-2xl font-bold">Gestão Sanitária Proativa</h3>
                            <p class="text-green-100 text-sm">Controle de saúde e medicamentos</p>
                        </div>
                    </div>
                    <div class="w-12 h-12 bg-white bg-opacity-20 rounded-2xl flex items-center justify-center">
                        <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                </div>
            </div>
            
            <!-- Conteúdo -->
            <div class="p-6">
            
            <!-- Abas -->
            <div class="flex border-b border-gray-200 mb-6">
                <button onclick="switchHealthTab('alerts')" id="alertsTab" class="px-4 py-2 text-sm font-medium text-red-600 border-b-2 border-red-600">
                    Alertas Ativos
                </button>
                <button onclick="switchHealthTab('medications')" id="medicationsTab" class="px-4 py-2 text-sm font-medium text-gray-500 border-b-2 border-transparent">
                    Medicamentos
                </button>
                <button onclick="switchHealthTab('withdrawal')" id="withdrawalTab" class="px-4 py-2 text-sm font-medium text-gray-500 border-b-2 border-transparent">
                    Controle de Carência
                </button>
                <button onclick="switchHealthTab('stock')" id="stockTab" class="px-4 py-2 text-sm font-medium text-gray-500 border-b-2 border-transparent">
                    Estoque
                </button>
            </div>
            
            <!-- Conteúdo das Abas -->
            <div id="alertsContent" class="tab-content">
                <div class="flex justify-between items-center mb-4">
                    <h4 class="text-lg font-semibold">Alertas Sanitários Ativos</h4>
                    <div class="flex space-x-2">
                        <button onclick="refreshHealthAlerts()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                            Atualizar
                        </button>
                        <button onclick="resolveAllAlerts()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                            Resolver Todos
                        </button>
                    </div>
                </div>
                <div id="healthAlertsList" class="space-y-4">
                    <!-- Alertas serão carregados aqui -->
                </div>
            </div>
            
            <div id="medicationsContent" class="tab-content hidden">
                <div class="flex justify-between items-center mb-4">
                    <h4 class="text-lg font-semibold">Medicamentos e Vacinas</h4>
                    <button onclick="showAddMedicationModal()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                        + Novo Medicamento
                    </button>
                </div>
                <div id="medicationsList" class="overflow-x-auto">
                    <!-- Lista será carregada aqui -->
                </div>
            </div>
            
            <div id="withdrawalContent" class="tab-content hidden">
                <div class="flex justify-between items-center mb-4">
                    <h4 class="text-lg font-semibold">Controle de Período de Carência</h4>
                    <button onclick="refreshWithdrawalControl()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                        Atualizar
                    </button>
                </div>
                <div id="withdrawalList" class="overflow-x-auto">
                    <!-- Lista será carregada aqui -->
                </div>
            </div>
            
            <div id="stockContent" class="tab-content hidden">
                <div class="flex justify-between items-center mb-4">
                    <h4 class="text-lg font-semibold">Controle de Estoque</h4>
                    <button onclick="refreshStockControl()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                        Atualizar
                    </button>
                </div>
                <div id="stockList" class="overflow-x-auto">
                    <!-- Lista será carregada aqui -->
                </div>
            </div>
        </div>
    `;
        document.body.appendChild(modal);
        
        console.log('✅ Modal de Gestão Sanitária criado e adicionado');
        
        // Carregar dados iniciais
        loadHealthAlerts();
        loadMedicationsList();
        loadWithdrawalControl();
        loadStockControl();
        
    } catch (error) {
        console.error('❌ Erro ao abrir Gestão Sanitária:', error);
        showNotification('Erro ao abrir Gestão Sanitária: ' + error.message, 'error');
    }
}

function closeHealthManagement() {
    const modal = document.getElementById('healthManagementModal');
    if (modal) modal.remove();
}

function switchHealthTab(tabName) {
    // Esconder todas as abas
    document.querySelectorAll('#healthManagementModal .tab-content').forEach(tab => {
        tab.classList.add('hidden');
    });
    
    // Remover estilo ativo de todos os botões
    document.querySelectorAll('#healthManagementModal [id$="Tab"]').forEach(btn => {
        btn.classList.remove('text-red-600', 'border-red-600');
        btn.classList.add('text-gray-500', 'border-transparent');
    });
    
    // Mostrar aba selecionada
    document.getElementById(tabName + 'Content').classList.remove('hidden');
    document.getElementById(tabName + 'Tab').classList.remove('text-gray-500', 'border-transparent');
    document.getElementById(tabName + 'Tab').classList.add('text-red-600', 'border-red-600');
}

async function loadHealthAlerts() {
    try {
        const response = await fetch('api/health_alerts.php?action=select');
        const result = await response.json();
        
        if (!result.success) {
            throw new Error(result.error);
        }
        
        const alerts = result.data || [];
        const container = document.getElementById('healthAlertsList');
        
        if (alerts.length === 0) {
            container.innerHTML = '<div class="text-center py-8 text-gray-500">Nenhum alerta sanitário ativo</div>';
            return;
        }
        
        container.innerHTML = alerts.map(alert => `
            <div class="bg-white border-l-4 ${getAlertBorderColor(alert.alert_level)} p-4 rounded-lg shadow-sm">
                <div class="flex justify-between items-start">
                    <div class="flex-1">
                        <div class="flex items-center space-x-2 mb-2">
                            <span class="px-2 py-1 text-xs font-semibold rounded-full ${getAlertBadgeColor(alert.alert_level)}">
                                ${alert.alert_level.toUpperCase()}
                            </span>
                            <span class="px-2 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800">
                                ${getAlertTypeLabel(alert.alert_type)}
                            </span>
                        </div>
                        <h5 class="font-semibold text-gray-900 mb-1">${alert.title}</h5>
                        <p class="text-gray-700 text-sm mb-2">${alert.message}</p>
                        <div class="text-xs text-gray-500">
                            ${alert.animal_number ? `Animal: ${alert.animal_number} ${alert.animal_name ? '(' + alert.animal_name + ')' : ''}` : ''}
                            ${alert.medication_name ? ` | Medicamento: ${alert.medication_name}` : ''}
                            ${alert.due_date ? ` | Vence em: ${new Date(alert.due_date).toLocaleDateString('pt-BR')}` : ''}
                        </div>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="resolveAlert(${alert.id})" class="px-3 py-1 bg-green-600 text-white text-sm rounded hover:bg-green-700 transition-colors">
                            Resolver
                        </button>
                    </div>
                </div>
            </div>
        `).join('');
    } catch (error) {
        document.getElementById('healthAlertsList').innerHTML = '<div class="text-center py-8 text-red-500">Erro ao carregar alertas: ' + error.message + '</div>';
    }
}

async function loadMedicationsList() {
    try {
        const response = await fetch('api/medications.php?action=select');
        const result = await response.json();
        
        if (!result.success) {
            throw new Error(result.error);
        }
        
        const medications = result.data || [];
        const container = document.getElementById('medicationsList');
        
        if (medications.length === 0) {
            container.innerHTML = '<p class="text-gray-500 text-center py-8">Nenhum medicamento cadastrado</p>';
            return;
        }
        
        container.innerHTML = `
            <table class="min-w-full bg-white border border-gray-200 rounded-lg">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nome</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipo</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estoque</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Carência Leite</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Carência Carne</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ações</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
                    ${medications.map(med => `
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${med.name}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 capitalize">${med.type}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${med.stock_quantity} unidades</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${med.milk_withdrawal_period} dias</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${med.meat_withdrawal_period} dias</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                ${getStockStatusBadge(med.stock_quantity, med.min_stock_level)}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                <button onclick="viewMedication(${med.id})" class="text-blue-600 hover:text-blue-900 mr-2">Ver</button>
                                <button onclick="editMedication(${med.id})" class="text-green-600 hover:text-green-900 mr-2">Editar</button>
                                <button onclick="deleteMedication(${med.id})" class="text-red-600 hover:text-red-900">Excluir</button>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
    } catch (error) {
        document.getElementById('medicationsList').innerHTML = '<p class="text-red-500 text-center py-8">Erro ao carregar medicamentos: ' + error.message + '</p>';
    }
}

async function loadWithdrawalControl() {
    try {
        // Simular dados de controle de carência
        const container = document.getElementById('withdrawalList');
        container.innerHTML = `
            <div class="bg-blue-50 p-4 rounded-lg">
                <h5 class="font-semibold text-blue-900 mb-2">Controle de Período de Carência</h5>
                <p class="text-blue-800 text-sm">Sistema de controle automático de carência implementado. Os períodos são calculados automaticamente quando medicamentos são aplicados.</p>
            </div>
        `;
    } catch (error) {
        document.getElementById('withdrawalList').innerHTML = '<p class="text-red-500 text-center py-8">Erro ao carregar controle de carência: ' + error.message + '</p>';
    }
}

async function loadStockControl() {
    try {
        const response = await fetch('api/medications.php?action=get_low_stock');
        const result = await response.json();
        
        if (!result.success) {
            throw new Error(result.error);
        }
        
        const medications = result.data || [];
        const container = document.getElementById('stockList');
        
        if (medications.length === 0) {
            container.innerHTML = '<div class="text-center py-8 text-green-600">Todos os medicamentos com estoque adequado</div>';
            return;
        }
        
        container.innerHTML = `
            <div class="space-y-4">
                <h5 class="font-semibold text-red-900">Medicamentos com Estoque Baixo</h5>
                ${medications.map(med => `
                    <div class="bg-red-50 border border-red-200 p-4 rounded-lg">
                        <div class="flex justify-between items-center">
                            <div>
                                <h6 class="font-semibold text-red-900">${med.name}</h6>
                                <p class="text-red-700 text-sm">Estoque atual: ${med.stock_quantity} unidades | Mínimo: ${med.min_stock_level}</p>
                            </div>
                            <span class="px-3 py-1 bg-red-600 text-white text-sm rounded-full">Baixo</span>
                        </div>
                    </div>
                `).join('')}
            </div>
        `;
    } catch (error) {
        document.getElementById('stockList').innerHTML = '<p class="text-red-500 text-center py-8">Erro ao carregar controle de estoque: ' + error.message + '</p>';
    }
}

// Funções auxiliares
function getAlertBorderColor(level) {
    switch(level) {
        case 'crítico': return 'border-red-600';
        case 'alto': return 'border-red-500';
        case 'médio': return 'border-yellow-500';
        case 'baixo': return 'border-blue-500';
        default: return 'border-gray-500';
    }
}

function getAlertBadgeColor(level) {
    switch(level) {
        case 'crítico': return 'bg-red-600 text-white';
        case 'alto': return 'bg-red-500 text-white';
        case 'médio': return 'bg-yellow-500 text-white';
        case 'baixo': return 'bg-blue-500 text-white';
        default: return 'bg-gray-500 text-white';
    }
}

function getAlertTypeLabel(type) {
    const labels = {
        'vacinação_pendente': 'Vacinação Pendente',
        'carência_leite': 'Carência Leite',
        'carência_carne': 'Carência Carne',
        'medicamento_vencido': 'Medicamento Vencendo',
        'estoque_baixo': 'Estoque Baixo',
        'reteste_necessário': 'Reteste Necessário'
    };
    return labels[type] || type;
}

function getStockStatusBadge(quantity, minLevel) {
    if (quantity <= minLevel) {
        return '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800">Baixo</span>';
    } else if (quantity <= minLevel * 2) {
        return '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800">Atenção</span>';
    } else {
        return '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">Normal</span>';
    }
}

// Funções de ação
async function resolveAlert(alertId) {
    try {
        const response = await fetch('api/health_alerts.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'resolve', id: alertId })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showNotification('Alerta resolvido com sucesso!', 'success');
            await loadHealthAlerts();
        } else {
            showNotification('Erro ao resolver alerta: ' + result.error, 'error');
        }
    } catch (error) {
        showNotification('Erro ao resolver alerta: ' + error.message, 'error');
    }
}

async function refreshHealthAlerts() {
    await loadHealthAlerts();
    showNotification('Alertas atualizados!', 'success');
}

async function refreshWithdrawalControl() {
    await loadWithdrawalControl();
    showNotification('Controle de carência atualizado!', 'success');
}

async function refreshStockControl() {
    await loadStockControl();
    showNotification('Controle de estoque atualizado!', 'success');
}

// =====================================================
// FUNÇÕES PARA SISTEMA DE REPRODUÇÃO
// =====================================================

function showReproductionManagement() {
    try {
        console.log('🌊 Abrindo Sistema de Reprodução...');
        
        // Remover modal anterior se existir
        const existingModal = document.getElementById('reproductionManagementModal');
        if (existingModal) {
            existingModal.remove();
        }
        
        const modal = document.createElement('div');
        modal.id = 'reproductionManagementModal';
        modal.className = 'fixed inset-0 bg-white z-[99999] overflow-y-auto';
        modal.style.display = 'block';
        modal.innerHTML = `
        <div class="w-full h-full">
            <!-- Header -->
            <div class="sticky top-0 bg-gradient-to-br from-teal-600 to-cyan-600 text-white shadow-lg z-10 p-6">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <button onclick="closeReproductionManagement()" class="w-10 h-10 flex items-center justify-center hover:bg-white hover:bg-opacity-20 rounded-xl transition-colors">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"></path>
                            </svg>
                        </button>
                        <div>
                            <h3 class="text-2xl font-bold">Sistema de Reprodução Avançado</h3>
                            <p class="text-teal-100 text-sm">Controle de prenhez e maternidade</p>
                        </div>
                    </div>
                    <div class="w-12 h-12 bg-white bg-opacity-20 rounded-2xl flex items-center justify-center">
                        <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                        </svg>
                    </div>
                </div>
            </div>
            
            <!-- Conteúdo -->
            <div class="p-6">
            
            <!-- Abas -->
            <div class="flex border-b border-gray-200 mb-6">
                <button onclick="switchReproductionTab('pregnancies')" id="pregnanciesTab" class="px-4 py-2 text-sm font-medium text-pink-600 border-b-2 border-pink-600">
                    Prenhezes Ativas
                </button>
                <button onclick="switchReproductionTab('maternity')" id="maternityTab" class="px-4 py-2 text-sm font-medium text-gray-500 border-b-2 border-transparent">
                    Alertas de Maternidade
                </button>
                <button onclick="switchReproductionTab('performance')" id="performanceTab" class="px-4 py-2 text-sm font-medium text-gray-500 border-b-2 border-transparent">
                    Performance Reprodutiva
                </button>
                <button onclick="switchReproductionTab('indicators')" id="indicatorsTab" class="px-4 py-2 text-sm font-medium text-gray-500 border-b-2 border-transparent">
                    Indicadores
                </button>
            </div>
            
            <!-- Conteúdo das Abas -->
            <div id="pregnanciesContent" class="tab-content">
                <div class="flex justify-between items-center mb-4">
                    <h4 class="text-lg font-semibold">Controle de Prenhezes</h4>
                    <div class="flex space-x-2">
                        <button onclick="showConfirmPregnancyModal()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                            Confirmar Prenhez
                        </button>
                        <button onclick="refreshPregnancies()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                            Atualizar
                        </button>
                    </div>
                </div>
                <div id="pregnanciesList" class="space-y-4">
                    <!-- Lista será carregada aqui -->
                </div>
            </div>
            
            <div id="maternityContent" class="tab-content hidden">
                <div class="flex justify-between items-center mb-4">
                    <h4 class="text-lg font-semibold">Alertas de Maternidade</h4>
                    <div class="flex space-x-2">
                        <button onclick="showRecordBirthModal()" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors">
                            Registrar Parto
                        </button>
                        <button onclick="refreshMaternityAlerts()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                            Atualizar
                        </button>
                    </div>
                </div>
                <div id="maternityAlertsList" class="space-y-4">
                    <!-- Alertas serão carregados aqui -->
                </div>
            </div>
            
            <div id="performanceContent" class="tab-content hidden">
                <div class="flex justify-between items-center mb-4">
                    <h4 class="text-lg font-semibold">Performance Reprodutiva por Animal</h4>
                    <button onclick="refreshReproductivePerformance()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                        Atualizar
                    </button>
                </div>
                <div id="reproductivePerformanceList" class="overflow-x-auto">
                    <!-- Lista será carregada aqui -->
                </div>
            </div>
            
            <div id="indicatorsContent" class="tab-content hidden">
                <div class="flex justify-between items-center mb-4">
                    <h4 class="text-lg font-semibold">Indicadores de Prenhez</h4>
                    <button onclick="refreshPregnancyIndicators()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                        Atualizar
                    </button>
                </div>
                <div id="pregnancyIndicatorsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <!-- Indicadores serão carregados aqui -->
                </div>
            </div>
        </div>
    `;
        document.body.appendChild(modal);
        
        console.log('✅ Modal de Reprodução criado e adicionado');
        
        // Carregar dados iniciais
        loadActivePregnancies();
        loadMaternityAlerts();
        loadReproductivePerformance();
        loadPregnancyIndicators();
        
    } catch (error) {
        console.error('❌ Erro ao abrir Sistema de Reprodução:', error);
        showNotification('Erro ao abrir Sistema de Reprodução: ' + error.message, 'error');
    }
}

function closeReproductionManagement() {
    const modal = document.getElementById('reproductionManagementModal');
    if (modal) modal.remove();
}

function switchReproductionTab(tabName) {
    // Esconder todas as abas
    document.querySelectorAll('#reproductionManagementModal .tab-content').forEach(tab => {
        tab.classList.add('hidden');
    });
    
    // Remover estilo ativo de todos os botões
    document.querySelectorAll('#reproductionManagementModal [id$="Tab"]').forEach(btn => {
        btn.classList.remove('text-pink-600', 'border-pink-600');
        btn.classList.add('text-gray-500', 'border-transparent');
    });
    
    // Mostrar aba selecionada
    document.getElementById(tabName + 'Content').classList.remove('hidden');
    document.getElementById(tabName + 'Tab').classList.remove('text-gray-500', 'border-transparent');
    document.getElementById(tabName + 'Tab').classList.add('text-pink-600', 'border-pink-600');
}

async function loadActivePregnancies() {
    try {
        const response = await fetch('api/reproduction.php?action=get_active_pregnancies');
        const result = await response.json();
        
        if (!result.success) {
            throw new Error(result.error);
        }
        
        const pregnancies = result.data || [];
        const container = document.getElementById('pregnanciesList');
        
        if (pregnancies.length === 0) {
            container.innerHTML = '<div class="text-center py-8 text-gray-500">Nenhuma prenhez ativa</div>';
            return;
        }
        
        container.innerHTML = pregnancies.map(pregnancy => `
            <div class="bg-white border-l-4 ${getPregnancyStageColor(pregnancy.pregnancy_stage)} p-4 rounded-lg shadow-sm">
                <div class="flex justify-between items-start">
                    <div class="flex-1">
                        <div class="flex items-center space-x-2 mb-2">
                            <span class="px-2 py-1 text-xs font-semibold rounded-full ${getPregnancyStageBadge(pregnancy.pregnancy_stage)}">
                                ${pregnancy.pregnancy_stage}
                            </span>
                            <span class="px-2 py-1 text-xs font-semibold rounded-full bg-gray-100 text-gray-800">
                                ${pregnancy.days_until_birth} dias restantes
                            </span>
                        </div>
                        <h5 class="font-semibold text-gray-900 mb-1">${pregnancy.animal_number} ${pregnancy.animal_name ? '(' + pregnancy.animal_name + ')' : ''}</h5>
                        <p class="text-gray-700 text-sm mb-2">Raça: ${pregnancy.breed}</p>
                        <div class="text-xs text-gray-500">
                            DPP: ${new Date(pregnancy.expected_birth_date).toLocaleDateString('pt-BR')} | 
                            Confirmação: ${new Date(pregnancy.pregnancy_confirmation_date).toLocaleDateString('pt-BR')}
                        </div>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="viewPregnancyDetails(${pregnancy.id})" class="px-3 py-1 bg-blue-600 text-white text-sm rounded hover:bg-blue-700 transition-colors">
                            Ver Detalhes
                        </button>
                        <button onclick="recordBirthForPregnancy(${pregnancy.id})" class="px-3 py-1 bg-purple-600 text-white text-sm rounded hover:bg-purple-700 transition-colors">
                            Registrar Parto
                        </button>
                    </div>
                </div>
            </div>
        `).join('');
    } catch (error) {
        document.getElementById('pregnanciesList').innerHTML = '<div class="text-center py-8 text-red-500">Erro ao carregar prenhezes: ' + error.message + '</div>';
    }
}

async function loadMaternityAlerts() {
    try {
        const response = await fetch('api/reproduction.php?action=get_maternity_alerts');
        const result = await response.json();
        
        if (!result.success) {
            throw new Error(result.error);
        }
        
        const alerts = result.data || [];
        const container = document.getElementById('maternityAlertsList');
        
        if (alerts.length === 0) {
            container.innerHTML = '<div class="text-center py-8 text-gray-500">Nenhum alerta de maternidade ativo</div>';
            return;
        }
        
        container.innerHTML = alerts.map(alert => `
            <div class="bg-white border-l-4 ${getMaternityAlertColor(alert.alert_type)} p-4 rounded-lg shadow-sm">
                <div class="flex justify-between items-start">
                    <div class="flex-1">
                        <div class="flex items-center space-x-2 mb-2">
                            <span class="px-2 py-1 text-xs font-semibold rounded-full ${getMaternityAlertBadge(alert.alert_type)}">
                                ${getMaternityAlertLabel(alert.alert_type)}
                            </span>
                            <span class="px-2 py-1 text-xs font-semibold rounded-full bg-pink-100 text-pink-800">
                                ${alert.alert_level.toUpperCase()}
                            </span>
                        </div>
                        <h5 class="font-semibold text-gray-900 mb-1">${alert.title}</h5>
                        <p class="text-gray-700 text-sm mb-2">${alert.message}</p>
                        <div class="text-xs text-gray-500">
                            Animal: ${alert.animal_number} ${alert.animal_name ? '(' + alert.animal_name + ')' : ''} | 
                            DPP: ${new Date(alert.expected_birth_date).toLocaleDateString('pt-BR')}
                            ${alert.due_date ? ` | Vence em: ${new Date(alert.due_date).toLocaleDateString('pt-BR')}` : ''}
                        </div>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="resolveMaternityAlert(${alert.id})" class="px-3 py-1 bg-green-600 text-white text-sm rounded hover:bg-green-700 transition-colors">
                            Resolver
                        </button>
                    </div>
                </div>
            </div>
        `).join('');
    } catch (error) {
        document.getElementById('maternityAlertsList').innerHTML = '<div class="text-center py-8 text-red-500">Erro ao carregar alertas: ' + error.message + '</div>';
    }
}

async function loadReproductivePerformance() {
    try {
        const response = await fetch('api/reproduction.php?action=get_reproductive_performance');
        const result = await response.json();
        
        if (!result.success) {
            throw new Error(result.error);
        }
        
        const performance = result.data || [];
        const container = document.getElementById('reproductivePerformanceList');
        
        if (performance.length === 0) {
            container.innerHTML = '<p class="text-gray-500 text-center py-8">Nenhum dado de performance reprodutiva disponível</p>';
            return;
        }
        
        container.innerHTML = `
            <table class="min-w-full bg-white border border-gray-200 rounded-lg">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Animal</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total IA</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sucessos</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Taxa Prenhez</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Último Parto</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
                    ${performance.map(animal => `
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                ${animal.animal_number} ${animal.animal_name ? '(' + animal.animal_name + ')' : ''}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${animal.total_inseminations || 0}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${animal.successful_inseminations || 0}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${animal.pregnancy_rate ? animal.pregnancy_rate.toFixed(1) + '%' : '0%'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                ${animal.last_birth_date ? new Date(animal.last_birth_date).toLocaleDateString('pt-BR') : '-'}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="px-2 py-1 text-xs font-semibold rounded-full ${animal.reproductive_status === 'Prenha' ? 'bg-pink-100 text-pink-800' : 'bg-green-100 text-green-800'}">
                                    ${animal.reproductive_status}
                                </span>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
    } catch (error) {
        document.getElementById('reproductivePerformanceList').innerHTML = '<p class="text-red-500 text-center py-8">Erro ao carregar performance: ' + error.message + '</p>';
    }
}

async function loadPregnancyIndicators() {
    try {
        const response = await fetch('api/reproduction.php?action=get_pregnancy_indicators');
        const result = await response.json();
        
        if (!result.success) {
            throw new Error(result.error);
        }
        
        const indicators = result.data || {};
        const container = document.getElementById('pregnancyIndicatorsContainer');
        
        container.innerHTML = `
            <div class="bg-gradient-to-r from-pink-500 to-pink-600 rounded-lg p-6 text-white">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-pink-400 bg-opacity-50">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                        </svg>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium opacity-90">Total Prenhes</p>
                        <p class="text-2xl font-semibold">${indicators.total_pregnant_animals || 0}</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-gradient-to-r from-orange-500 to-orange-600 rounded-lg p-6 text-white">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-orange-400 bg-opacity-50">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium opacity-90">Pré-parto</p>
                        <p class="text-2xl font-semibold">${indicators.pre_partum_animals || 0}</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-gradient-to-r from-red-500 to-red-600 rounded-lg p-6 text-white">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-red-400 bg-opacity-50">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                        </svg>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium opacity-90">Parto Iminente</p>
                        <p class="text-2xl font-semibold">${indicators.imminent_birth_animals || 0}</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-gradient-to-r from-blue-500 to-blue-600 rounded-lg p-6 text-white">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-blue-400 bg-opacity-50">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium opacity-90">Média DPP</p>
                        <p class="text-2xl font-semibold">${indicators.avg_days_until_birth ? Math.round(indicators.avg_days_until_birth) + ' dias' : '-'}</p>
                    </div>
                </div>
            </div>
        `;
    } catch (error) {
        document.getElementById('pregnancyIndicatorsContainer').innerHTML = '<div class="text-center py-8 text-red-500">Erro ao carregar indicadores: ' + error.message + '</div>';
    }
}

// Funções auxiliares para reprodução
function getPregnancyStageColor(stage) {
    switch(stage) {
        case 'Parto Iminente': return 'border-red-600';
        case 'Pré-parto': return 'border-orange-500';
        case 'Vencido': return 'border-red-800';
        default: return 'border-pink-500';
    }
}

function getPregnancyStageBadge(stage) {
    switch(stage) {
        case 'Parto Iminente': return 'bg-red-600 text-white';
        case 'Pré-parto': return 'bg-orange-500 text-white';
        case 'Vencido': return 'bg-red-800 text-white';
        default: return 'bg-pink-500 text-white';
    }
}

function getMaternityAlertColor(type) {
    switch(type) {
        case 'parto_iminente': return 'border-red-600';
        case 'pré_parto': return 'border-orange-500';
        case 'pós_parto': return 'border-green-500';
        default: return 'border-pink-500';
    }
}

function getMaternityAlertBadge(type) {
    switch(type) {
        case 'parto_iminente': return 'bg-red-600 text-white';
        case 'pré_parto': return 'bg-orange-500 text-white';
        case 'pós_parto': return 'bg-green-500 text-white';
        default: return 'bg-pink-500 text-white';
    }
}

function getMaternityAlertLabel(type) {
    const labels = {
        'pré_parto': 'Pré-parto',
        'parto_iminente': 'Parto Iminente',
        'pós_parto': 'Pós-parto',
        'cuidados_especiais': 'Cuidados Especiais'
    };
    return labels[type] || type;
}

// Funções de ação
async function resolveMaternityAlert(alertId) {
    try {
        const response = await fetch('api/reproduction.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'resolve_maternity_alert', id: alertId })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showNotification('Alerta de maternidade resolvido!', 'success');
            await loadMaternityAlerts();
        } else {
            showNotification('Erro ao resolver alerta: ' + result.error, 'error');
        }
    } catch (error) {
        showNotification('Erro ao resolver alerta: ' + error.message, 'error');
    }
}

async function refreshPregnancies() {
    await loadActivePregnancies();
    showNotification('Prenhezes atualizadas!', 'success');
}

async function refreshMaternityAlerts() {
    await loadMaternityAlerts();
    showNotification('Alertas de maternidade atualizados!', 'success');
}

async function refreshReproductivePerformance() {
    await loadReproductivePerformance();
    showNotification('Performance reprodutiva atualizada!', 'success');
}

async function refreshPregnancyIndicators() {
    await loadPregnancyIndicators();
    showNotification('Indicadores atualizados!', 'success');
}

// =====================================================
// FUNÇÕES PARA DASHBOARD ANALÍTICO
// =====================================================

function showAnalyticsDashboard() {
    try {
        console.log('📊 Abrindo Dashboard Analítico...');
        
        // Remover modal anterior se existir
        const existingModal = document.getElementById('analyticsDashboardModal');
        if (existingModal) {
            existingModal.remove();
        }
        
        const modal = document.createElement('div');
        modal.id = 'analyticsDashboardModal';
        modal.className = 'fixed inset-0 bg-white z-[99999] overflow-y-auto';
        modal.style.display = 'block';
        modal.innerHTML = `
        <div class="w-full h-full">
            <!-- Header -->
            <div class="sticky top-0 bg-gradient-to-br from-slate-600 to-slate-700 text-white shadow-lg z-10 p-6">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <button onclick="closeAnalyticsDashboard()" class="w-10 h-10 flex items-center justify-center hover:bg-white hover:bg-opacity-20 rounded-xl transition-colors">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"></path>
                            </svg>
                        </button>
                        <div>
                            <h3 class="text-2xl font-bold">Dashboard Analítico</h3>
                            <p class="text-slate-100 text-sm">Indicadores gerenciais e KPIs</p>
                        </div>
                    </div>
                    <div class="w-12 h-12 bg-white bg-opacity-20 rounded-2xl flex items-center justify-center">
                        <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                    </div>
                </div>
            </div>
            
            <!-- Conteúdo -->
            <div class="p-6">
            
            <!-- Abas -->
            <div class="flex border-b border-gray-200 mb-6">
                <button onclick="switchAnalyticsTab('overview')" id="overviewTab" class="px-4 py-2 text-sm font-medium text-indigo-600 border-b-2 border-indigo-600">
                    Visão Geral
                </button>
                <button onclick="switchAnalyticsTab('production')" id="productionTab" class="px-4 py-2 text-sm font-medium text-gray-500 border-b-2 border-transparent">
                    Produção
                </button>
                <button onclick="switchAnalyticsTab('reproductive')" id="reproductiveTab" class="px-4 py-2 text-sm font-medium text-gray-500 border-b-2 border-transparent">
                    Reprodutivo
                </button>
                <button onclick="switchAnalyticsTab('health')" id="healthTab" class="px-4 py-2 text-sm font-medium text-gray-500 border-b-2 border-transparent">
                    Sanitário
                </button>
                <button onclick="switchAnalyticsTab('financial')" id="financialTab" class="px-4 py-2 text-sm font-medium text-gray-500 border-b-2 border-transparent">
                    Financeiro
                </button>
            </div>
            
            <!-- Conteúdo das Abas -->
            <div id="overviewContent" class="tab-content">
                <div class="mb-6">
                    <h4 class="text-lg font-semibold mb-4">Score de Eficiência da Fazenda</h4>
                    <div id="efficiencyScoreContainer" class="bg-gradient-to-r from-indigo-500 to-purple-600 rounded-lg p-8 text-white text-center">
                        <!-- Score será carregado aqui -->
                    </div>
                </div>
                
                <div class="mb-6">
                    <h4 class="text-lg font-semibold mb-4">Resumo Executivo</h4>
                    <div id="executiveSummary" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <!-- Resumo será carregado aqui -->
                    </div>
                </div>
                
                <div>
                    <h4 class="text-lg font-semibold mb-4">Indicadores de Performance (KPIs)</h4>
                    <div id="performanceKPIs" class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <!-- KPIs serão carregados aqui -->
                    </div>
                </div>
            </div>
            
            <div id="productionContent" class="tab-content hidden">
                <div class="mb-6">
                    <h4 class="text-lg font-semibold mb-4">Tendências de Produção (30 dias)</h4>
                    <div id="productionTrendsChart" class="bg-white p-4 rounded-lg border border-gray-200">
                        <canvas id="productionTrendsCanvas" height="80"></canvas>
                    </div>
                </div>
                
                <div>
                    <h4 class="text-lg font-semibold mb-4">Análise de Qualidade</h4>
                    <div id="qualityAnalysisContainer" class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <!-- Análise de qualidade será carregada aqui -->
                    </div>
                </div>
            </div>
            
            <div id="reproductiveContent" class="tab-content hidden">
                <div class="mb-6">
                    <h4 class="text-lg font-semibold mb-4">Taxa de Prenhez por Período</h4>
                    <div id="pregnancyRateChart" class="bg-white p-4 rounded-lg border border-gray-200">
                        <canvas id="pregnancyRateCanvas" height="80"></canvas>
                    </div>
                </div>
                
                <div>
                    <h4 class="text-lg font-semibold mb-4">Intervalo Entre Partos (IEP)</h4>
                    <div id="calvingIntervalContainer" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Análise de IEP será carregada aqui -->
                    </div>
                </div>
            </div>
            
            <div id="healthContent" class="tab-content hidden">
                <div class="mb-6">
                    <h4 class="text-lg font-semibold mb-4">Análise Sanitária</h4>
                    <div id="healthAnalysisContainer" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Análise sanitária será carregada aqui -->
                    </div>
                </div>
            </div>
            
            <div id="financialContent" class="tab-content hidden">
                <div class="mb-6">
                    <h4 class="text-lg font-semibold mb-4">Análise Financeira (30 dias)</h4>
                    <div id="financialAnalysisContainer" class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <!-- Análise financeira será carregada aqui -->
                    </div>
                </div>
            </div>
        </div>
    `;
        document.body.appendChild(modal);
        
        console.log('✅ Modal de Dashboard Analítico criado e adicionado');
        
        // Carregar dados iniciais
        loadEfficiencyScore();
        loadExecutiveSummary();
        loadPerformanceKPIs();
        
    } catch (error) {
        console.error('❌ Erro ao abrir Dashboard Analítico:', error);
        showNotification('Erro ao abrir Dashboard Analítico: ' + error.message, 'error');
    }
}

function closeAnalyticsDashboard() {
    const modal = document.getElementById('analyticsDashboardModal');
    if (modal) modal.remove();
}

function switchAnalyticsTab(tabName) {
    // Esconder todas as abas
    document.querySelectorAll('#analyticsDashboardModal .tab-content').forEach(tab => {
        tab.classList.add('hidden');
    });
    
    // Remover estilo ativo de todos os botões
    document.querySelectorAll('#analyticsDashboardModal [id$="Tab"]').forEach(btn => {
        btn.classList.remove('text-indigo-600', 'border-indigo-600');
        btn.classList.add('text-gray-500', 'border-transparent');
    });
    
    // Mostrar aba selecionada
    document.getElementById(tabName + 'Content').classList.remove('hidden');
    document.getElementById(tabName + 'Tab').classList.remove('text-gray-500', 'border-transparent');
    document.getElementById(tabName + 'Tab').classList.add('text-indigo-600', 'border-indigo-600');
    
    // Carregar dados específicos da aba
    switch(tabName) {
        case 'production':
            loadProductionTrends();
            loadQualityAnalysis();
            break;
        case 'reproductive':
            loadReproductiveAnalytics();
            break;
        case 'health':
            loadHealthAnalytics();
            break;
        case 'financial':
            loadFinancialAnalytics();
            break;
    }
}

async function loadEfficiencyScore() {
    try {
        const response = await fetch('api/analytics.php?action=get_efficiency_score');
        const result = await response.json();
        
        if (!result.success) {
            throw new Error(result.error);
        }
        
        const score = result.data || { total_score: 0, breakdown: {}, rating: 'Não disponível' };
        const container = document.getElementById('efficiencyScoreContainer');
        
        const scoreColor = score.total_score >= 80 ? 'from-green-500 to-green-600' : 
                          score.total_score >= 60 ? 'from-yellow-500 to-yellow-600' : 
                          'from-red-500 to-red-600';
        
        container.className = `bg-gradient-to-r ${scoreColor} rounded-lg p-8 text-white text-center`;
        container.innerHTML = `
            <div class="mb-4">
                <div class="text-6xl font-bold mb-2">${score.total_score.toFixed(1)}</div>
                <div class="text-xl font-semibold">${score.rating}</div>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-6">
                <div class="bg-white bg-opacity-20 rounded-lg p-3">
                    <div class="text-2xl font-bold">${score.breakdown.production?.toFixed(1) || 0}</div>
                    <div class="text-sm opacity-90">Produção</div>
                </div>
                <div class="bg-white bg-opacity-20 rounded-lg p-3">
                    <div class="text-2xl font-bold">${score.breakdown.reproductive?.toFixed(1) || 0}</div>
                    <div class="text-sm opacity-90">Reprodutivo</div>
                </div>
                <div class="bg-white bg-opacity-20 rounded-lg p-3">
                    <div class="text-2xl font-bold">${score.breakdown.quality?.toFixed(1) || 0}</div>
                    <div class="text-sm opacity-90">Qualidade</div>
                </div>
                <div class="bg-white bg-opacity-20 rounded-lg p-3">
                    <div class="text-2xl font-bold">${score.breakdown.health?.toFixed(1) || 0}</div>
                    <div class="text-sm opacity-90">Saúde</div>
                </div>
            </div>
        `;
    } catch (error) {
        document.getElementById('efficiencyScoreContainer').innerHTML = '<div class="text-center py-8">Erro ao carregar score: ' + error.message + '</div>';
    }
}

async function loadExecutiveSummary() {
    try {
        const response = await fetch('api/analytics.php?action=get_dashboard_summary');
        const result = await response.json();
        
        if (!result.success) {
            throw new Error(result.error);
        }
        
        const summary = result.data || {};
        const container = document.getElementById('executiveSummary');
        
        container.innerHTML = `
            <div class="bg-gradient-to-r from-blue-500 to-blue-600 rounded-lg p-6 text-white">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-blue-400 bg-opacity-50">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                        </svg>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium opacity-90">Produção (30d)</p>
                        <p class="text-2xl font-semibold">${summary.production?.total_volume_30d?.toFixed(0) || 0} L</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-gradient-to-r from-green-500 to-green-600 rounded-lg p-6 text-white">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-green-400 bg-opacity-50">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium opacity-90">Gordura Média</p>
                        <p class="text-2xl font-semibold">${summary.quality?.avg_fat_30d?.toFixed(2) || 0}%</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-gradient-to-r from-pink-500 to-pink-600 rounded-lg p-6 text-white">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-pink-400 bg-opacity-50">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                        </svg>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium opacity-90">Prenhezes Ativas</p>
                        <p class="text-2xl font-semibold">${summary.reproductive?.total_pregnant || 0}</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-gradient-to-r from-orange-500 to-orange-600 rounded-lg p-6 text-white">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-orange-400 bg-opacity-50">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                        </svg>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium opacity-90">Alertas Ativos</p>
                        <p class="text-2xl font-semibold">${summary.alerts?.active_alerts_count || 0}</p>
                    </div>
                </div>
            </div>
        `;
    } catch (error) {
        document.getElementById('executiveSummary').innerHTML = '<div class="col-span-4 text-center py-8 text-red-500">Erro ao carregar resumo: ' + error.message + '</div>';
    }
}

async function loadPerformanceKPIs() {
    try {
        const response = await fetch('api/analytics.php?action=get_performance_indicators');
        const result = await response.json();
        
        if (!result.success) {
            throw new Error(result.error);
        }
        
        const kpis = result.data || {};
        const container = document.getElementById('performanceKPIs');
        
        container.innerHTML = `
            <div class="bg-white rounded-lg border border-gray-200 p-6">
                <h5 class="text-sm font-medium text-gray-500 mb-2">Taxa de Prenhez</h5>
                <div class="text-3xl font-bold text-pink-600 mb-1">
                    ${kpis.pregnancy_rate?.pregnancy_rate?.toFixed(1) || 0}%
                </div>
                <div class="text-sm text-gray-500">
                    ${kpis.pregnancy_rate?.successful || 0} de ${kpis.pregnancy_rate?.total || 0} inseminações
                </div>
            </div>
            
            <div class="bg-white rounded-lg border border-gray-200 p-6">
                <h5 class="text-sm font-medium text-gray-500 mb-2">Produção por Animal</h5>
                <div class="text-3xl font-bold text-blue-600 mb-1">
                    ${kpis.production_efficiency?.production_per_animal?.toFixed(1) || 0} L
                </div>
                <div class="text-sm text-gray-500">
                    Média diária
                </div>
            </div>
            
            <div class="bg-white rounded-lg border border-gray-200 p-6">
                <h5 class="text-sm font-medium text-gray-500 mb-2">CCS Média</h5>
                <div class="text-3xl font-bold text-green-600 mb-1">
                    ${kpis.milk_quality?.avg_scc?.toFixed(0) || 0}
                </div>
                <div class="text-sm text-gray-500">
                    Células/mL
                </div>
            </div>
        `;
    } catch (error) {
        document.getElementById('performanceKPIs').innerHTML = '<div class="col-span-3 text-center py-8 text-red-500">Erro ao carregar KPIs: ' + error.message + '</div>';
    }
}

async function loadProductionTrends() {
    try {
        const response = await fetch('api/analytics.php?action=get_production_trends&days=30');
        const result = await response.json();
        
        if (!result.success || !result.data || result.data.length === 0) {
            document.getElementById('productionTrendsChart').innerHTML = '<div class="text-center py-8 text-gray-500">Sem dados de produção disponíveis</div>';
            return;
        }
        
        const trends = result.data.reverse(); // Ordem cronológica
        const ctx = document.getElementById('productionTrendsCanvas').getContext('2d');
        
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: trends.map(t => new Date(t.date).toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' })),
                datasets: [{
                    label: 'Volume de Produção (L)',
                    data: trends.map(t => parseFloat(t.total_volume)),
                    borderColor: 'rgb(59, 130, 246)',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: { display: true },
                    tooltip: { mode: 'index', intersect: false }
                },
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });
    } catch (error) {
        document.getElementById('productionTrendsChart').innerHTML = '<div class="text-center py-8 text-red-500">Erro ao carregar tendências: ' + error.message + '</div>';
    }
}

async function loadQualityAnalysis() {
    try {
        const response = await fetch('api/analytics.php?action=get_performance_indicators');
        const result = await response.json();
        
        if (!result.success) {
            throw new Error(result.error);
        }
        
        const quality = result.data?.milk_quality || {};
        const container = document.getElementById('qualityAnalysisContainer');
        
        container.innerHTML = `
            <div class="bg-white rounded-lg border border-gray-200 p-6">
                <h5 class="text-sm font-medium text-gray-500 mb-2">Gordura Média</h5>
                <div class="text-3xl font-bold text-green-600">${quality.avg_fat?.toFixed(2) || 0}%</div>
            </div>
            
            <div class="bg-white rounded-lg border border-gray-200 p-6">
                <h5 class="text-sm font-medium text-gray-500 mb-2">Proteína Média</h5>
                <div class="text-3xl font-bold text-blue-600">${quality.avg_protein?.toFixed(2) || 0}%</div>
            </div>
            
            <div class="bg-white rounded-lg border border-gray-200 p-6">
                <h5 class="text-sm font-medium text-gray-500 mb-2">CCS Médio</h5>
                <div class="text-3xl font-bold text-orange-600">${quality.avg_scc?.toFixed(0) || 0}</div>
            </div>
        `;
    } catch (error) {
        document.getElementById('qualityAnalysisContainer').innerHTML = '<div class="col-span-3 text-center py-8 text-red-500">Erro ao carregar análise: ' + error.message + '</div>';
    }
}

async function loadReproductiveAnalytics() {
    try {
        const response = await fetch('api/analytics.php?action=get_reproductive_analysis');
        const result = await response.json();
        
        if (!result.success) {
            throw new Error(result.error);
        }
        
        const analysis = result.data || {};
        
        // Gráfico de taxa de prenhez
        if (analysis.monthly_pregnancy_rates && analysis.monthly_pregnancy_rates.length > 0) {
            const ctx = document.getElementById('pregnancyRateCanvas').getContext('2d');
            const monthly = analysis.monthly_pregnancy_rates.reverse();
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: monthly.map(m => m.month),
                    datasets: [{
                        label: 'Taxa de Prenhez (%)',
                        data: monthly.map(m => parseFloat(m.pregnancy_rate)),
                        backgroundColor: 'rgba(236, 72, 153, 0.7)',
                        borderColor: 'rgb(236, 72, 153)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: true }
                    },
                    scales: {
                        y: { beginAtZero: true, max: 100 }
                    }
                }
            });
        }
        
        // Análise de IEP
        const iepContainer = document.getElementById('calvingIntervalContainer');
        iepContainer.innerHTML = `
            <div class="bg-white rounded-lg border border-gray-200 p-6">
                <h5 class="text-sm font-medium text-gray-500 mb-2">Intervalo Médio Entre Partos</h5>
                <div class="text-3xl font-bold text-purple-600">${analysis.calving_interval?.avg_calving_interval?.toFixed(0) || 'N/A'}</div>
                <div class="text-sm text-gray-500 mt-1">dias</div>
            </div>
            
            <div class="bg-white rounded-lg border border-gray-200 p-6">
                <h5 class="text-sm font-medium text-gray-500 mb-2">Meta IEP</h5>
                <div class="text-3xl font-bold text-green-600">365-390</div>
                <div class="text-sm text-gray-500 mt-1">dias (ideal)</div>
            </div>
        `;
    } catch (error) {
        console.error('Erro ao carregar análise reprodutiva:', error);
    }
}

async function loadHealthAnalytics() {
    try {
        const response = await fetch('api/analytics.php?action=get_health_analysis');
        const result = await response.json();
        
        if (!result.success) {
            throw new Error(result.error);
        }
        
        const analysis = result.data || {};
        const container = document.getElementById('healthAnalysisContainer');
        
        container.innerHTML = `
            <div class="bg-white rounded-lg border border-gray-200 p-6">
                <h5 class="text-sm font-medium text-gray-500 mb-2">Alertas Sanitários Ativos</h5>
                <div class="text-3xl font-bold text-red-600">${analysis.active_alerts?.length || 0}</div>
                <div class="text-sm text-gray-500 mt-1">alertas pendentes</div>
            </div>
            
            <div class="bg-white rounded-lg border border-gray-200 p-6">
                <h5 class="text-sm font-medium text-gray-500 mb-2">Medicamentos em Estoque Baixo</h5>
                <div class="text-3xl font-bold text-orange-600">${analysis.low_stock_medications?.low_stock_count || 0}</div>
                <div class="text-sm text-gray-500 mt-1">necessitam reposição</div>
            </div>
        `;
    } catch (error) {
        document.getElementById('healthAnalysisContainer').innerHTML = '<div class="col-span-2 text-center py-8 text-red-500">Erro ao carregar análise: ' + error.message + '</div>';
    }
}

async function loadFinancialAnalytics() {
    try {
        const response = await fetch('api/analytics.php?action=get_financial_analysis');
        const result = await response.json();
        
        if (!result.success) {
            throw new Error(result.error);
        }
        
        const analysis = result.data || {};
        const container = document.getElementById('financialAnalysisContainer');
        
        const formatCurrency = (value) => {
            return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value || 0);
        };
        
        container.innerHTML = `
            <div class="bg-white rounded-lg border border-gray-200 p-6">
                <h5 class="text-sm font-medium text-gray-500 mb-2">Receita Total (30d)</h5>
                <div class="text-3xl font-bold text-green-600">${formatCurrency(analysis.total_income)}</div>
            </div>
            
            <div class="bg-white rounded-lg border border-gray-200 p-6">
                <h5 class="text-sm font-medium text-gray-500 mb-2">Despesas Totais (30d)</h5>
                <div class="text-3xl font-bold text-red-600">${formatCurrency(analysis.total_expenses)}</div>
            </div>
            
            <div class="bg-white rounded-lg border border-gray-200 p-6">
                <h5 class="text-sm font-medium text-gray-500 mb-2">Lucro Líquido (30d)</h5>
                <div class="text-3xl font-bold ${parseFloat(analysis.net_profit) >= 0 ? 'text-green-600' : 'text-red-600'}">
                    ${formatCurrency(analysis.net_profit)}
                </div>
            </div>
        `;
    } catch (error) {
        document.getElementById('financialAnalysisContainer').innerHTML = '<div class="col-span-3 text-center py-8 text-red-500">Erro ao carregar análise: ' + error.message + '</div>';
    }
}


</script>

<!-- Performance initialization -->
<script>
// Initialize performance optimizations
document.addEventListener('DOMContentLoaded', function() {
    // Register service worker for caching
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/sw.js')
            .then(registration => console.log('✅ Service Worker registered'))
            .catch(error => console.log('❌ Service Worker registration failed:', error));
    }
    
    // Mark content as loaded
    setTimeout(function() {
        document.body.classList.add('loaded');
        document.querySelector('.main-content').classList.add('loaded');
    }, 100);
});

// Performance monitoring
window.addEventListener('load', function() {
    // Log performance metrics
    if ('performance' in window) {
        const perfData = performance.getEntriesByType('navigation')[0];
        console.log('🚀 Performance Metrics:');
        console.log('DOM Content Loaded:', perfData.domContentLoadedEventEnd - perfData.domContentLoadedEventStart, 'ms');
        console.log('Page Load Complete:', perfData.loadEventEnd - perfData.loadEventStart, 'ms');
        console.log('Total Load Time:', perfData.loadEventEnd - perfData.fetchStart, 'ms');
    }
});
</script>

=======
>>>>>>> parent of 0eb3d2f (.)
</body>
</html>


