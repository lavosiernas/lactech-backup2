<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel do Gerente - Sistema Leiteiro</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Painel do Gerente - Sistema completo para gestão de produção leiteira, controle de qualidade e relatórios">
    <meta name="theme-color" content="#166534">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="LacTech Gerente">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="msapplication-TileColor" content="#166534">
    <meta name="msapplication-config" content="/browserconfig.xml">
    
    <!-- PWA Icons -->
    <link rel="icon" href="https://i.postimg.cc/vmrkgDcB/lactech.png" type="image/x-icon">
    <link rel="apple-touch-icon" href="https://i.postimg.cc/vmrkgDcB/lactech.png">
    <link rel="apple-touch-icon" sizes="72x72" href="https://i.postimg.cc/vmrkgDcB/lactech.png">
    <link rel="apple-touch-icon" sizes="96x96" href="https://i.postimg.cc/vmrkgDcB/lactech.png">
    <link rel="apple-touch-icon" sizes="128x128" href="https://i.postimg.cc/vmrkgDcB/lactech.png">
    <link rel="apple-touch-icon" sizes="144x144" href="https://i.postimg.cc/vmrkgDcB/lactech.png">
    <link rel="apple-touch-icon" sizes="152x152" href="https://i.postimg.cc/vmrkgDcB/lactech.png">
    <link rel="apple-touch-icon" sizes="192x192" href="https://i.postimg.cc/vmrkgDcB/lactech.png">
    <link rel="apple-touch-icon" sizes="384x384" href="https://i.postimg.cc/vmrkgDcB/lactech.png">
    <link rel="apple-touch-icon" sizes="512x512" href="https://i.postimg.cc/vmrkgDcB/lactech.png">
    
    <!-- PWA Manifest -->
    
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="assets/js/pdf-generator.js"></script>
    <script src="assets/js/modal-system.js"></script>
    
    <!-- CSS Files -->
    <link href="assets/css/dark-theme-fixes.css?v=2.0" rel="stylesheet">
    <link href="assets/css/loading-screen.css" rel="stylesheet">
    
    <!-- Responsividade Customizada -->
    <style>
        /* Responsividade para telas muito pequenas */
        @media (max-width: 360px) {
            .text-xs { font-size: 0.65rem !important; line-height: 0.9rem !important; }
            .text-sm { font-size: 0.75rem !important; line-height: 1rem !important; }
            .text-base { font-size: 0.8rem !important; line-height: 1.1rem !important; }
            .text-lg { font-size: 0.9rem !important; line-height: 1.2rem !important; }
            .text-xl { font-size: 1rem !important; line-height: 1.3rem !important; }
            .text-2xl { font-size: 1.1rem !important; line-height: 1.4rem !important; }
            
            /* Espaçamentos reduzidos */
            .p-2 { padding: 0.3rem !important; }
            .p-3 { padding: 0.5rem !important; }
            .p-4 { padding: 0.6rem !important; }
            .p-6 { padding: 0.8rem !important; }
            .px-3 { padding-left: 0.5rem !important; padding-right: 0.5rem !important; }
            .px-4 { padding-left: 0.6rem !important; padding-right: 0.6rem !important; }
            .px-6 { padding-left: 0.8rem !important; padding-right: 0.8rem !important; }
            .py-2 { padding-top: 0.3rem !important; padding-bottom: 0.3rem !important; }
            .py-3 { padding-top: 0.5rem !important; padding-bottom: 0.5rem !important; }
            .py-4 { padding-top: 0.6rem !important; padding-bottom: 0.6rem !important; }
            
            /* Margens reduzidas */
            .m-2 { margin: 0.3rem !important; }
            .m-3 { margin: 0.5rem !important; }
            .m-4 { margin: 0.6rem !important; }
            .mb-2 { margin-bottom: 0.3rem !important; }
            .mb-3 { margin-bottom: 0.5rem !important; }
            .mb-4 { margin-bottom: 0.6rem !important; }
            .mb-6 { margin-bottom: 0.8rem !important; }
            .mt-2 { margin-top: 0.3rem !important; }
            .mt-3 { margin-top: 0.5rem !important; }
            .mt-4 { margin-top: 0.6rem !important; }
            
            /* Grid gaps reduzidos */
            .gap-2 { gap: 0.3rem !important; }
            .gap-3 { gap: 0.5rem !important; }
            .gap-4 { gap: 0.6rem !important; }
            .gap-6 { gap: 0.8rem !important; }
            
            /* Espaçamentos entre elementos */
            .space-y-2 > * + * { margin-top: 0.3rem !important; }
            .space-y-3 > * + * { margin-top: 0.5rem !important; }
            .space-y-4 > * + * { margin-top: 0.6rem !important; }
            .space-y-6 > * + * { margin-top: 0.8rem !important; }
            
            /* Botões menores */
            .btn-sm { padding: 0.3rem 0.6rem !important; font-size: 0.7rem !important; }
            .btn-md { padding: 0.5rem 0.8rem !important; font-size: 0.8rem !important; }
            
            /* Cards mais compactos */
            .card-compact { padding: 0.6rem !important; }
            .card-compact .text-lg { font-size: 0.85rem !important; }
            .card-compact .text-xl { font-size: 0.95rem !important; }
            
            /* Headers mais compactos */
            .header-compact { padding: 0.5rem 0.8rem !important; }
            .header-compact .text-xl { font-size: 0.9rem !important; }
            .header-compact .text-2xl { font-size: 1rem !important; }
        }
        
        /* Responsividade para telas pequenas */
        @media (max-width: 480px) {
            .text-xs { font-size: 0.7rem !important; line-height: 0.95rem !important; }
            .text-sm { font-size: 0.8rem !important; line-height: 1.05rem !important; }
            .text-base { font-size: 0.85rem !important; line-height: 1.15rem !important; }
            .text-lg { font-size: 0.95rem !important; line-height: 1.25rem !important; }
            .text-xl { font-size: 1.05rem !important; line-height: 1.35rem !important; }
            .text-2xl { font-size: 1.15rem !important; line-height: 1.45rem !important; }
            
            /* Espaçamentos moderados */
            .p-2 { padding: 0.4rem !important; }
            .p-3 { padding: 0.6rem !important; }
            .p-4 { padding: 0.7rem !important; }
            .p-6 { padding: 0.9rem !important; }
            .px-3 { padding-left: 0.6rem !important; padding-right: 0.6rem !important; }
            .px-4 { padding-left: 0.7rem !important; padding-right: 0.7rem !important; }
            .px-6 { padding-left: 0.9rem !important; padding-right: 0.9rem !important; }
            .py-2 { padding-top: 0.4rem !important; padding-bottom: 0.4rem !important; }
            .py-3 { padding-top: 0.6rem !important; padding-bottom: 0.6rem !important; }
            .py-4 { padding-top: 0.7rem !important; padding-bottom: 0.7rem !important; }
            
            /* Margens moderadas */
            .m-2 { margin: 0.4rem !important; }
            .m-3 { margin: 0.6rem !important; }
            .m-4 { margin: 0.7rem !important; }
            .mb-2 { margin-bottom: 0.4rem !important; }
            .mb-3 { margin-bottom: 0.6rem !important; }
            .mb-4 { margin-bottom: 0.7rem !important; }
            .mb-6 { margin-bottom: 0.9rem !important; }
            .mt-2 { margin-top: 0.4rem !important; }
            .mt-3 { margin-top: 0.6rem !important; }
            .mt-4 { margin-top: 0.7rem !important; }
            
            /* Grid gaps moderados */
            .gap-2 { gap: 0.4rem !important; }
            .gap-3 { gap: 0.6rem !important; }
            .gap-4 { gap: 0.7rem !important; }
            .gap-6 { gap: 0.9rem !important; }
            
            /* Espaçamentos entre elementos */
            .space-y-2 > * + * { margin-top: 0.4rem !important; }
            .space-y-3 > * + * { margin-top: 0.6rem !important; }
            .space-y-4 > * + * { margin-top: 0.7rem !important; }
            .space-y-6 > * + * { margin-top: 0.9rem !important; }
        }
        
        /* Prevenir quebra de linha em textos importantes */
        .no-wrap { white-space: nowrap !important; }
        .text-ellipsis { overflow: hidden !important; text-overflow: ellipsis !important; white-space: nowrap !important; }
        
        /* Ajustes específicos para elementos que quebram */
        .metric-value { font-size: clamp(0.8rem, 2.5vw, 1.25rem) !important; }
        .metric-label { font-size: clamp(0.6rem, 2vw, 0.875rem) !important; }
        .card-title { font-size: clamp(0.75rem, 2.2vw, 1.125rem) !important; }
        .button-text { font-size: clamp(0.7rem, 2vw, 0.875rem) !important; }
        
        /* Melhorar espaçamento em grids */
        .grid-compact { gap: 0.5rem !important; }
        .grid-compact > * { padding: 0.5rem !important; }
        
        /* Ajustes para modais em telas pequenas */
        @media (max-width: 480px) {
            .modal-content { padding: 0.8rem !important; }
            .modal-title { font-size: 1rem !important; }
            .modal-body { font-size: 0.85rem !important; }
            .modal-button { padding: 0.5rem 0.8rem !important; font-size: 0.8rem !important; }
        }
        
        @media (max-width: 360px) {
            .modal-content { padding: 0.6rem !important; }
            .modal-title { font-size: 0.9rem !important; }
            .modal-body { font-size: 0.75rem !important; }
            .modal-button { padding: 0.4rem 0.6rem !important; font-size: 0.7rem !important; }
        }
        
        /* Ajustes específicos para cards de dados */
        @media (max-width: 480px) {
            .data-card { padding: 0.8rem !important; }
            .data-card h3 { font-size: 0.9rem !important; margin-bottom: 0.6rem !important; }
            .data-card .text-lg { font-size: 0.85rem !important; }
            .data-card .text-xl { font-size: 0.95rem !important; }
            .data-card .text-2xl { font-size: 1.05rem !important; }
        }
        
        @media (max-width: 360px) {
            .data-card { padding: 0.6rem !important; }
            .data-card h3 { font-size: 0.8rem !important; margin-bottom: 0.5rem !important; }
            .data-card .text-lg { font-size: 0.75rem !important; }
            .data-card .text-xl { font-size: 0.85rem !important; }
            .data-card .text-2xl { font-size: 0.95rem !important; }
        }
        
        /* Ajustes para botões em telas pequenas */
        @media (max-width: 480px) {
            .btn-primary, .btn-secondary, .btn-success, .btn-danger { 
                padding: 0.4rem 0.8rem !important; 
                font-size: 0.8rem !important; 
            }
            .btn-sm { 
                padding: 0.3rem 0.6rem !important; 
                font-size: 0.7rem !important; 
            }
        }
        
        @media (max-width: 360px) {
            .btn-primary, .btn-secondary, .btn-success, .btn-danger { 
                padding: 0.3rem 0.6rem !important; 
                font-size: 0.7rem !important; 
            }
            .btn-sm { 
                padding: 0.25rem 0.5rem !important; 
                font-size: 0.65rem !important; 
            }
        }
        
        /* Ajustes para tabelas em telas pequenas */
        @media (max-width: 480px) {
            .table-responsive { font-size: 0.75rem !important; }
            .table-responsive th, .table-responsive td { 
                padding: 0.4rem 0.3rem !important; 
            }
        }
        
        @media (max-width: 360px) {
            .table-responsive { font-size: 0.7rem !important; }
            .table-responsive th, .table-responsive td { 
                padding: 0.3rem 0.2rem !important; 
            }
        }
        
        /* Ajustes para inputs e formulários */
        @media (max-width: 480px) {
            input, select, textarea { 
                font-size: 0.85rem !important; 
                padding: 0.4rem 0.6rem !important; 
            }
            label { font-size: 0.8rem !important; }
        }
        
        @media (max-width: 360px) {
            input, select, textarea { 
                font-size: 0.8rem !important; 
                padding: 0.3rem 0.5rem !important; 
            }
            label { font-size: 0.75rem !important; }
        }
        
        /* Ajustes específicos para modal de logout */
        @media (max-width: 480px) {
            #logoutConfirmationModal .bg-white,
            #logoutConfirmationModal .dark\\:bg-gray-800 {
                margin: 1rem !important;
                padding: 1.5rem !important;
            }
            
            #logoutConfirmationModal h3 {
                font-size: 1.1rem !important;
            }
            
            #logoutConfirmationModal p {
                font-size: 0.9rem !important;
            }
            
            #logoutConfirmationModal .w-16 {
                width: 3rem !important;
                height: 3rem !important;
            }
            
            #logoutConfirmationModal .w-8 {
                width: 1.5rem !important;
                height: 1.5rem !important;
            }
        }
        
        /* Garantir que os botões de edição sejam ocultados corretamente */
        #profileEditButtons.hidden {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
            pointer-events: none !important;
        }
        
        /* Forçar ocultação dos botões quando não há mudanças */
        #profileEditButtons[style*="display: none"] {
            visibility: hidden !important;
            opacity: 0 !important;
            pointer-events: none !important;
        }
        
        /* Garantir que as telas de processamento sejam ocultadas */
        #photoProcessingScreen.hidden,
        #managerPhotoProcessingScreen.hidden {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
            pointer-events: none !important;
        }
        
        /* Forçar ocultação das telas de processamento */
        #photoProcessingScreen[style*="display: none"],
        #managerPhotoProcessingScreen[style*="display: none"] {
            visibility: hidden !important;
            opacity: 0 !important;
            pointer-events: none !important;
        }
        
        /* Garantir que o modal de foto do gerente seja exibido corretamente */
        #managerPhotoChoiceModal[style*="display: flex"] {
            visibility: visible !important;
            opacity: 1 !important;
            pointer-events: auto !important;
        }
        
        #managerPhotoChoiceModal.flex {
            display: flex !important;
            visibility: visible !important;
            opacity: 1 !important;
            pointer-events: auto !important;
        }
        
        /* Garantir que o modal MAIS seja exibido corretamente */
        #moreModal[style*="display: block"] {
            visibility: visible !important;
            opacity: 1 !important;
            pointer-events: auto !important;
        }
        
        #moreModal:not(.hidden) {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            pointer-events: auto !important;
        }
        
        /* Forçar tema correto no modal MAIS - Hub de Apps */
        #moreModal.dark {
            background-color: #000000 !important; /* black */
        }
        
        #moreModal.dark .bg-white {
            background-color: #000000 !important; /* black */
        }
        
        #moreModal.dark .bg-gray-900 {
            background-color: #000000 !important; /* black */
        }
        
        #moreModal.dark .text-gray-900 {
            color: #f9fafb !important; /* gray-50 */
        }
        
        #moreModal.dark .text-gray-600 {
            color: #d1d5db !important; /* gray-300 */
        }
        
        #moreModal.dark .text-gray-700 {
            color: #d1d5db !important; /* gray-300 */
        }
        
        #moreModal.dark .border-gray-200 {
            border-color: #374151 !important; /* gray-700 */
        }
        
        #moreModal.dark .hover\\:bg-gray-100:hover {
            background-color: #374151 !important; /* gray-700 */
        }
        
        /* Garantir que o modal MAIS não seja escuro quando o tema é claro */
        #moreModal:not(.dark) {
            background-color: #ffffff !important; /* white */
        }
        
        #moreModal:not(.dark) .bg-gray-900 {
            background-color: #ffffff !important; /* white */
        }
        
        #moreModal:not(.dark) .text-white {
            color: #111827 !important; /* gray-900 */
        }
        
        #moreModal:not(.dark) .text-gray-400 {
            color: #6b7280 !important; /* gray-500 */
        }
        
        #moreModal:not(.dark) .border-gray-700 {
            border-color: #e5e7eb !important; /* gray-200 */
        }
        
        #moreModal:not(.dark) .hover\\:bg-gray-800:hover {
            background-color: #f3f4f6 !important; /* gray-100 */
        }
        
        /* Melhorar aparência dos apps no modal estilo mobile */
        #moreModal .app-item {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
            padding: 8px;
            border-radius: 12px;
        }
        
        #moreModal .app-item:hover {
            background-color: rgba(0, 0, 0, 0.05) !important;
            transform: translateY(-2px) !important;
        }
        
        #moreModal.dark .app-item:hover {
            background-color: rgba(255, 255, 255, 0.1) !important;
        }
        
        #moreModal .app-item:active {
            transform: scale(0.95) !important;
        }
        
        /* Melhorar legibilidade no modo claro */
        #moreModal:not(.dark) .text-gray-800 {
            color: #1f2937 !important; /* gray-800 */
        }
        
        #moreModal:not(.dark) .text-gray-600 {
            color: #4b5563 !important; /* gray-600 */
        }
        
        #moreModal:not(.dark) .text-gray-700 {
            color: #374151 !important; /* gray-700 */
        }
        
        #moreModal:not(.dark) .text-gray-900 {
            color: #111827 !important; /* gray-900 */
        }
        
        /* Forçar cores corretas no modo claro */
        #moreModal:not(.dark) .text-white {
            color: #111827 !important; /* gray-900 */
        }
        
        #moreModal:not(.dark) .text-gray-400 {
            color: #6b7280 !important; /* gray-500 */
        }
        
        /* Garantir que o fundo seja branco no modo claro */
        #moreModal:not(.dark) {
            background-color: #ffffff !important; /* white */
        }
        
        #moreModal:not(.dark) .bg-black {
            background-color: #ffffff !important; /* white */
        }
        
        /* Garantir que os cards sejam brancos no modo claro e pretos no modo escuro */
        #moreModal:not(.dark) .app-item {
            background-color: #ffffff !important; /* white */
            border: 1px solid #e5e7eb !important; /* gray-200 */
        }
        
        #moreModal.dark .app-item {
            background-color: #000000 !important; /* black */
            border: 1px solid #374151 !important; /* gray-700 */
        }
        
        /* Forçar header do modal a respeitar o tema */
        #moreModal:not(.dark) .more-modal-header {
            background-color: #ffffff !important; /* white */
            border-bottom-color: #e5e7eb !important; /* gray-200 */
        }
        
        #moreModal.dark .more-modal-header {
            background-color: #000000 !important; /* black */
            border-bottom-color: #374151 !important; /* gray-700 */
        }
        
        /* Garantir que o ícone de perfil seja ocultado quando há foto */
        #headerProfileIcon.hidden,
        #modalProfileIcon.hidden,
        #managerProfilePlaceholder.hidden {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
            pointer-events: none !important;
        }
        
        /* Garantir que a foto de perfil seja exibida */
        #headerProfilePhoto:not(.hidden),
        #modalProfilePhoto:not(.hidden),
        #managerProfilePreview:not(.hidden) {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            pointer-events: auto !important;
        }
        
        /* Forçar fechamento do modal de foto do gerente */
        #managerPhotoChoiceModal.hidden {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
            pointer-events: none !important;
            position: fixed !important;
            z-index: -1 !important;
        }
        
        #managerPhotoChoiceModal[style*="display: none"] {
            visibility: hidden !important;
            opacity: 0 !important;
            pointer-events: none !important;
            position: fixed !important;
            z-index: -1 !important;
        }
        
        /* Garantir que o modal de foto do gerente seja exibido corretamente */
        #managerPhotoChoiceModal.flex {
            display: flex !important;
            visibility: visible !important;
            opacity: 1 !important;
            pointer-events: auto !important;
            position: fixed !important;
            z-index: 999999 !important;
        }
        
        #managerPhotoChoiceModal[style*="display: flex"] {
            visibility: visible !important;
            opacity: 1 !important;
            pointer-events: auto !important;
            position: fixed !important;
            z-index: 999999 !important;
        }
        
        /* Corrigir overflow nas contas secundárias */
        #secondaryAccountsList {
            overflow-x: hidden;
            overflow-y: auto;
            width: 100%;
        }
        
        #secondaryAccountsList > div {
            max-width: 100%;
            overflow: hidden;
            width: 100%;
        }
        
        /* Corrigir centralização no desktop */
        @media (min-width: 640px) {
            #secondaryAccountsList {
                display: flex;
                flex-direction: column;
                align-items: stretch;
                width: 100%;
            }
            
            #secondaryAccountsList > div {
                width: 100%;
                max-width: none;
                flex: 1;
            }
        }
        
        /* Garantir que o container das contas secundárias ocupe toda a largura */
        .bg-white.rounded-2xl.p-4.sm\\:p-8.border.border-gray-200.mx-0.sm\\:mx-4.mb-8 {
            width: 100%;
        }
        
        /* Garantir que os textos longos sejam truncados */
        .truncate {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        /* Animações do header dinâmico - Global */
        #profileModalHeader {
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out !important;
        }
        
        /* Responsividade para telas pequenas */
        @media (max-width: 640px) {
            #secondaryAccountsList > div {
                padding: 0.75rem;
            }
            
            #secondaryAccountsList .flex-col {
                gap: 0.5rem;
            }
            
            /* Modal de perfil ocupar toda a tela no mobile */
            #profileModal {
                width: 100vw;
                height: 100vh;
                max-width: none;
                max-height: none;
                border-radius: 0;
                margin: 0;
            }
            
            #profileModal .modal-content {
                width: 100%;
                height: 100%;
                border-radius: 0;
                margin: 0;
            }
            
            /* Header do modal de perfil */
            #profileModalHeader {
                border-radius: 0;
                margin: 0;
                width: 100vw;
                margin-left: -1rem;
                margin-right: -1rem;
            }
            
            @media (min-width: 640px) {
                #profileModalHeader {
                    width: 100%;
                    margin-left: 0;
                    margin-right: 0;
                }
            }
            
            /* Conteúdo do modal responsivo */
            #profileModal .modal-content > div:not(#profileModalHeader) {
                /* Removido padding-top para evitar conflito com sticky header */
            }
            
            /* Animações do header dinâmico */
            #profileModalHeader {
                transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out !important;
            }
        }
        
        @media (max-width: 360px) {
            #logoutConfirmationModal .bg-white,
            #logoutConfirmationModal .dark\\:bg-gray-800 {
                margin: 0.5rem !important;
                padding: 1rem !important;
            }
            
            #logoutConfirmationModal h3 {
                font-size: 1rem !important;
            }
            
            #logoutConfirmationModal p {
                font-size: 0.85rem !important;
            }
            
            #logoutConfirmationModal .w-16 {
                width: 2.5rem !important;
                height: 2.5rem !important;
            }
            
            #logoutConfirmationModal .w-8 {
                width: 1.25rem !important;
                height: 1.25rem !important;
            }
        }
    </style>
    
    <script>
        // Chart.js theme helper to adapt to dark mode
        function getChartTheme(isDark) {
            return {
                gridColor: isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.08)',
                tickColor: isDark ? '#e5e7eb' : '#475569',
                lineBorder: isDark ? '#34d399' : '#369e36',
                lineFill: isDark ? 'rgba(52, 211, 153, 0.15)' : 'rgba(54, 158, 54, 0.1)',
                barColor: isDark ? '#60a5fa' : '#2563eb'
            };
        }

        function applyChartTheme() {
            try {
                const isDark = document.documentElement.classList.contains('dark');
                const t = getChartTheme(isDark);
                const charts = [
                    window.volumeChart,
                    window.dashboardWeeklyChart,
                    window.temperatureChart,
                    window.qualityChart,
                    window.weeklyVolumeChart,
                    window.dailyVolumeChart,
                    window.qualityTrendChart,
                    window.qualityDistributionChart,
                    window.paymentsChart,
                    window.weeklySummaryChart,
                    window.monthlyVolumeChart
                ].filter(Boolean);

                charts.forEach((ch) => {
                    try {
                        if (ch.config.type === 'line') {
                            ch.data.datasets.forEach(ds => {
                                ds.borderColor = t.lineBorder;
                                ds.backgroundColor = t.lineFill;
                            });
                        }
                        if (ch.config.type === 'bar') {
                            ch.data.datasets.forEach(ds => {
                                ds.backgroundColor = t.barColor;
                            });
                        }
                        if (ch.options && ch.options.scales) {
                            Object.values(ch.options.scales).forEach(scale => {
                                if (!scale.grid) scale.grid = {};
                                if (!scale.ticks) scale.ticks = {};
                                scale.grid.color = t.gridColor;
                                scale.ticks.color = t.tickColor;
                            });
                        }
                        if (ch.options && ch.options.plugins && ch.options.plugins.legend && ch.options.plugins.legend.labels) {
                            ch.options.plugins.legend.labels.color = t.tickColor;
                        }
                        ch.update('none');
                    } catch (_) {}
                });
            } catch (_) {}
        }
    </script>
    
    <!-- Estilos personalizados para animações premium da seção de relatórios -->
    <style>
        /* Animações customizadas */
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-6px); }
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        .animate-float {
            animation: float 4s ease-in-out infinite;
        }
        
        /* Efeito shimmer nos botões */
        .btn-shimmer {
            position: relative;
            overflow: hidden;
        }
        
        .btn-shimmer::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                90deg,
                transparent,
                rgba(255, 255, 255, 0.4),
                transparent
            );
            transition: left 0.6s ease-in-out;
        }
        
        .btn-shimmer:hover::before {
            left: 100%;
        }
        
        /* Efeito de vidro melhorado */
        .glass-effect {
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }
        
        /* Sombras coloridas personalizadas */
        .shadow-red-glow {
            box-shadow: 0 10px 40px rgba(239, 68, 68, 0.3);
        }
        
        .shadow-green-glow {
            box-shadow: 0 10px 40px rgba(34, 197, 94, 0.3);
        }
        
        .shadow-purple-glow {
            box-shadow: 0 10px 40px rgba(147, 51, 234, 0.3);
        }
        
        /* Efeito de partículas flutuantes */
        .floating-particles::before,
        .floating-particles::after {
            content: '';
            position: absolute;
            width: 4px;
            height: 4px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            animation: float 3s ease-in-out infinite;
        }
        
        .floating-particles::before {
            top: 20%;
            right: 15%;
            animation-delay: -1s;
        }
        
        .floating-particles::after {
            bottom: 25%;
            left: 10%;
            animation-delay: -2s;
        }
    </style>

        
    <script>
        // Non-blocking alert shim routed to showNotification when available
        (function(){
            var nativeAlert = window.alert;
            window.alert = function(message){
                try {
                    var msg = String(message);
                    if (typeof showNotification === 'function') {
                        showNotification(msg, 'warning');
                        return;
                    }
                    if (console && console.warn) console.warn('ALERT:', msg);
                    var host = (window.location && window.location.hostname) || '';
                    if (host === 'localhost' || host === '127.0.0.1' || host === '::1') {
                        nativeAlert(msg);
                    }
                } catch(_){}
            };
        })();
    </script>
    <!-- Script fix_data_sync_complete.js removido para evitar conflitos -->

    <link rel="icon" href="https://i.postimg.cc/vmrkgDcB/lactech.png" type="image/x-icon">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="assets/css/style.css">
    <style>

        

        
        /* Efeito de foco nos botões */ 
        button:focus { 
            outline: none; 
        } 
        
        /* Classes Tailwind para focus-visible */ 
        .focus-visible:focus { 
            --tw-ring-offset-shadow: var(--tw-ring-inset) 0 0 0 var(--tw-ring-offset-width) var(--tw-ring-offset-color); 
            --tw-ring-shadow: var(--tw-ring-inset) 0 0 0 calc(2px + var(--tw-ring-offset-width)) var(--tw-ring-color); 
            box-shadow: var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow, 0 0 #0000); 
            --tw-ring-color: rgba(134, 209, 134, 0.5); 
            --tw-ring-offset-width: 2px; 
        } 
        
        /* Classe para background do ícone */ 
        .bg-forest-100 { 
            background-color: #f0f9f0; 
        } 
        
        /* Definição de cores personalizadas para o ring */
        :root {
            --forest-300: #86d186;
        }
        
        /* Animações da Câmera */
        @keyframes focusPulse {
            0%, 100% { transform: scale(1); opacity: 0.4; }
            50% { transform: scale(1.05); opacity: 0.8; }
        }
        
        @keyframes focusSuccess {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .focus-pulse {
            animation: focusPulse 2s ease-in-out infinite;
        }
        
        .focus-success {
            animation: focusSuccess 0.5s ease-in-out;
        }
        
        /* Estilos da câmera */
        .camera-overlay {
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        
        .camera-button {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .camera-button:hover {
            transform: scale(1.05);
        }
        
        /* Modal de Foto */
        #photoModal.show #photoModalContent {
            transform: scale(1);
            opacity: 1;
        }
        

    </style>
    <script>
        
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'forest': {
                            50: '#f0f9f0', 100: '#dcf2dc', 200: '#bce5bc', 300: '#8dd18d',
                            400: '#5bb85b', 500: '#369e36', 600: '#2a7f2a', 700: '#236523',
                            800: '#1f511f', 900: '#1a431a',
                        }
                    }
                }
            }
        }
    </script>
    

</head>
<!-- Tela de Carregamento -->
<div id="loadingScreen" class="fixed inset-0 bg-black bg-opacity-75 backdrop-blur-sm flex items-center justify-center z-50">
    <div class="bg-white rounded-3xl p-8 max-w-md w-full mx-4 shadow-2xl text-center">
        <!-- Logo -->
        <div class="mb-6">
            <img src="assets/img/lactech-logo.png" alt="LacTech" class="w-20 h-20 mx-auto mb-4">
            <h2 class="text-2xl font-bold text-gray-800">LacTech</h2>
            <p class="text-gray-600" id="farmNameLoading">Carregando sistema...</p>
        </div>
        
        <!-- Mensagem de Status -->
        <div class="mb-6">
            <div id="loadingMessage" class="text-lg font-medium text-gray-700 mb-2">Inicializando sistema...</div>
            <div id="loadingSubMessage" class="text-sm text-gray-500">Preparando ambiente...</div>
        </div>
        
        <!-- Barra de Progresso -->
        <div class="mb-6">
            <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden">
                <div id="loadingProgress" class="bg-gradient-to-r from-forest-500 to-forest-600 h-3 rounded-full transition-all duration-500 ease-out" style="width: 0%"></div>
            </div>
            <div class="mt-2 text-sm text-gray-600">
                <span id="loadingPercentage">0%</span> concluído
            </div>
        </div>
        
        <!-- Indicador de Carregamento -->
        <div class="flex justify-center">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-forest-600"></div>
        </div>
    </div>
</div>

<body class="gradient-mesh antialiased transition-colors duration-300" id="mainBody">

    <!-- Header -->
    <header class="gradient-forest shadow-xl sticky top-0 z-40 border-b border-forest-800 header-compact">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-14 sm:h-16">
                <div class="flex items-center space-x-3">
                    <div class="header-logo-container">
                        <img src="assets/img/lactech-logo.png" alt="LacTech Logo" class="header-logo">
                    </div>
                    <div>
                        <h1 class="text-lg font-bold text-white tracking-tight">PAINEL DO GERENTE</h1>
                        <p class="text-xs text-forest-200" id="farmNameHeader">Carregando...</p>
                    </div>
                </div>

                <!-- Desktop Navigation -->
                <nav class="hidden md:flex space-x-1">
                    <button class="nav-item active relative px-3 py-2 text-sm font-semibold text-white hover:text-forest-200 transition-all rounded-lg" data-tab="dashboard">
                        Dashboard
                    </button>
                    <button class="nav-item relative px-3 py-2 text-sm font-semibold text-white hover:text-forest-200 transition-all rounded-lg" data-tab="volume">
                        Volume
                    </button>
                    <button class="nav-item relative px-3 py-2 text-sm font-semibold text-white hover:text-forest-200 transition-all rounded-lg" data-tab="quality">
                        Qualidade
                    </button>
                    <button class="nav-item relative px-3 py-2 text-sm font-semibold text-white hover:text-forest-200 transition-all rounded-lg" data-tab="payments">
                        Financeiro
                    </button>
                    <button class="nav-item relative px-3 py-2 text-sm font-semibold text-white hover:text-forest-200 transition-all rounded-lg" data-tab="users">
                        Usuários
                    </button>
                    <button onclick="openMoreModal()" class="relative px-3 py-2 text-sm font-semibold text-white hover:text-forest-200 transition-all rounded-lg">
                        MAIS
                    </button>
                </nav>

                <div class="flex items-center space-x-4">
                    <!-- Botão de Notificações -->
                    <button onclick="openNotificationsModal()" class="relative p-2 text-white hover:text-forest-200 transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 17h5l-5 5v-5zM9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <span id="notificationCounter" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center hidden">0</span>
                        <!-- Indicador de tempo real -->
                        <div id="realTimeIndicator" class="absolute -bottom-1 -right-1 w-3 h-3 bg-green-500 rounded-full animate-pulse hidden" title="Sistema de atualização automática ativo"></div>
                    </button>
                    
                    
                    <button onclick="openProfileModal()" class="flex items-center space-x-3 text-white hover:text-forest-200 p-2 rounded-lg transition-all">
                        <div class="relative w-8 h-8">
                            <!-- Foto do usuário -->
                            <img id="headerProfilePhoto" src="" alt="Foto de Perfil" class="w-8 h-8 object-cover rounded-full hidden">
                            <!-- Ícone padrão -->
                            <div id="headerProfileIcon" class="w-8 h-8 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                </svg>
                            </div>
                        </div>
                        <div class="text-left hidden sm:block">
                            <div class="text-sm font-semibold" id="managerName">Carregando...</div>
                            <div class="text-xs text-forest-200">Gerente</div>
                        </div>
                    </button>
                </div>
            </div>
        </div>
    </header>
    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-2 sm:px-4 lg:px-6 xl:px-8 py-4 sm:py-6 lg:py-8 pb-16 sm:pb-20 md:pb-4">
        
        <!-- Dashboard Tab -->
        <div id="dashboard-tab" class="tab-content">
            <!-- Welcome Section -->
            <div class="gradient-forest rounded-2xl p-4 sm:p-6 mb-4 sm:mb-6 text-white shadow-xl relative overflow-hidden">
                <div class="relative z-10">
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="text-xl sm:text-2xl font-bold mb-1 sm:mb-2">Bem-vindo, <span id="managerWelcome">Carregando...</span>!</h2>
                            <p class="text-forest-200 text-sm sm:text-base font-medium mb-2 sm:mb-3">Painel de controle gerencial</p>
                            <div class="flex items-center space-x-2 sm:space-x-4">
                                <div class="text-xs font-medium">Última atualização: <span id="lastUpdate">Agora</span></div>
                            </div>
                        </div>
                        <div class="hidden sm:block">
                            <div class="w-12 h-12 sm:w-16 sm:h-16 bg-white bg-opacity-20 rounded-2xl flex items-center justify-center backdrop-blur-sm">
                                <svg class="w-6 h-6 sm:w-8 sm:h-8" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
                                </svg>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Key Metrics -->
            <div class="grid grid-cols-2 gap-3 sm:gap-4 mb-4 sm:mb-6 grid-compact">
                <div class="metric-card rounded-2xl p-3 sm:p-4 text-center card-compact">
                    <div class="w-10 h-10 sm:w-12 sm:h-12 bg-blue-500 rounded-xl flex items-center justify-center mx-auto mb-2 sm:mb-3 shadow-lg">
                        <svg class="w-5 h-5 sm:w-6 sm:h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path>
                        </svg>
                    </div>
                    <div class="metric-value font-bold text-slate-900 mb-1" id="todayVolume">-- L</div>
                    <div class="metric-label text-slate-500 font-medium">Volume Hoje</div>
                    <div class="metric-label text-slate-600 font-semibold mt-1">Litros</div>
                </div>
                
                <div class="metric-card rounded-2xl p-3 sm:p-4 text-center card-compact">
                    <div class="w-10 h-10 sm:w-12 sm:h-12 bg-green-500 rounded-xl flex items-center justify-center mx-auto mb-2 sm:mb-3 shadow-lg">
                        <svg class="w-5 h-5 sm:w-6 sm:h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <div class="metric-value font-bold text-slate-900 mb-1" id="qualityAverage">--%</div>
                    <div class="metric-label text-slate-500 font-medium">Qualidade Média</div>
                    <div class="metric-label text-slate-600 font-semibold mt-1">Hoje</div>
                </div>
                
                <div class="metric-card rounded-2xl p-3 sm:p-4 text-center card-compact">
                    <div class="w-10 h-10 sm:w-12 sm:h-12 bg-purple-500 rounded-xl flex items-center justify-center mx-auto mb-2 sm:mb-3 shadow-lg">
                        <svg class="w-5 h-5 sm:w-6 sm:h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                        </svg>
                    </div>
                    <div class="metric-value font-bold text-slate-900 mb-1" id="pendingPayments">R$ --</div>
                    <div class="metric-label text-slate-500 font-medium">Pagamentos Pendentes</div>
                    <div class="metric-label text-slate-600 font-semibold mt-1">Este Mês</div>
                </div>
                
                <div class="metric-card rounded-2xl p-3 sm:p-4 text-center card-compact">
                    <div class="w-10 h-10 sm:w-12 sm:h-12 bg-orange-500 rounded-xl flex items-center justify-center mx-auto mb-2 sm:mb-3 shadow-lg">
                        <svg class="w-5 h-5 sm:w-6 sm:h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                        </svg>
                    </div>
                    <div class="metric-value font-bold text-slate-900 mb-1" id="activeUsers">--</div>
                    <div class="metric-label text-slate-500 font-medium">Usuários Ativos</div>
                    <div class="metric-label text-slate-600 font-semibold mt-1">Sistema</div>
                </div>
            </div>

            <!-- Charts Section -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-6 mb-4 sm:mb-6">
                <!-- Volume Chart -->
                <div class="data-card rounded-2xl p-4 sm:p-6 card-compact">
                    <h3 class="card-title font-bold text-slate-900 mb-3 sm:mb-4">Volume Semanal</h3>
                    <div class="chart-container">
                        <canvas id="volumeChart"></canvas>
                    </div>
                </div>

                <!-- Weekly Production Chart -->
                <div class="data-card rounded-2xl p-6">
                    <h3 class="text-lg font-bold text-slate-900 mb-4">Produção dos Últimos 7 Dias</h3>
                    <div class="chart-container">
                        <canvas id="dashboardWeeklyChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Temperature Chart Section -->
            <div class="grid grid-cols-1 gap-6 mb-6">
                <div class="data-card rounded-2xl p-6">
                    <h3 class="text-lg font-bold text-slate-900 mb-4">Controle de Temperatura</h3>
                    <div class="chart-container">
                        <canvas id="temperatureChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Recent Activities -->
            <div class="data-card rounded-2xl p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-bold text-slate-900">Atividades Recentes</h3>
                    <button onclick="showTab('volume')" class="text-forest-600 hover:text-forest-700 font-semibold text-sm">Ver Tudo</button>
                </div>
                <div class="space-y-3" id="recentActivities">
                    <div class="text-center py-8">
                        <div class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <p class="text-gray-500 text-sm">Nenhuma atividade recente</p>
                        <p class="text-gray-400 text-xs">Registros aparecerão aqui</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Volume Tab -->
        <div id="volume-tab" class="tab-content hidden">
            <div class="space-y-6">
                <!-- Volume Header -->
                <div class="data-card rounded-2xl p-6">
                    <div class="flex flex-col sm:flex-row sm:items-center justify-between mb-6 gap-4">
                        <div>
                            <h2 class="text-xl md:text-2xl font-bold text-slate-900 mb-1">Controle de Volume</h2>
            <p class="text-slate-600 text-sm">Monitore a produção de leite em tempo real</p>
                        </div>
                        <div class="flex flex-col sm:flex-row gap-3 w-full sm:w-auto">
                            <select id="volumePeriod" class="px-4 py-2 border border-slate-200 rounded-lg text-sm focus:border-forest-500 focus:outline-none bg-white">
                                <option value="today">Hoje</option>
                                <option value="week">Esta Semana</option>
                                <option value="month">Este Mês</option>
                            </select>
                            <button onclick="exportVolumeReport()" class="px-4 py-2 bg-forest-600 text-white rounded-lg hover:shadow-lg transition-all font-semibold text-sm">
                                <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 10v6m0 0l-4-4m4 4l4-4m3 8H5a2 2 0 01-2-2V7a2 2 0 012-2h4l2 2h4a2 2 0 012 2v1"></path>
                                </svg>
                                Exportar
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Volume Metrics -->
                <div class="grid grid-cols-2 gap-4">
                    <div class="metric-card rounded-2xl p-4 text-center">
                        <div class="w-12 h-12 bg-blue-500 rounded-xl flex items-center justify-center mx-auto mb-3 shadow-lg">
                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path>
                            </svg>
                        </div>
                        <div class="text-xl font-bold text-slate-900 mb-1" id="volumeToday">-- L</div>
                    <div class="text-xs text-slate-500 font-medium">Hoje</div>
                    <div class="text-xs text-slate-600 font-semibold mt-1">Total</div>
                    </div>
                    
                    <div class="metric-card rounded-2xl p-4 text-center">
                        <div class="w-12 h-12 bg-green-500 rounded-xl flex items-center justify-center mx-auto mb-3 shadow-lg">
                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                            </svg>
                        </div>
                        <div class="text-xl font-bold text-slate-900 mb-1" id="volumeWeekAvg">-- L</div>
                    <div class="text-xs text-slate-500 font-medium">Média Semanal</div>
                    <div class="text-xs text-slate-600 font-semibold mt-1">Por Dia</div>
                    </div>
                    
                    <div class="metric-card rounded-2xl p-4 text-center">
                        <div class="w-12 h-12 bg-purple-500 rounded-xl flex items-center justify-center mx-auto mb-3 shadow-lg">
                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                            </svg>
                        </div>
                        <div class="text-xl font-bold text-slate-900 mb-1" id="volumeGrowth">+0%</div>
                    <div class="text-xs text-slate-500 font-medium">Crescimento</div>
                    <div class="text-xs text-slate-600 font-semibold mt-1">vs. Semana Anterior</div>
                    </div>
                    
                    <div class="metric-card rounded-2xl p-4 text-center">
                        <div class="w-12 h-12 bg-orange-500 rounded-xl flex items-center justify-center mx-auto mb-3 shadow-lg">
                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <div class="text-lg font-bold text-slate-900 mb-1" id="lastCollection">--/--/---- - --:--</div>
                    <div class="text-xs text-slate-500 font-medium">Última Coleta</div>
                    <div class="text-xs text-slate-600 font-semibold mt-1">Data e Hora</div>
                    </div>
                </div>

                <!-- Volume Charts -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Daily Production Chart -->
                    <div class="data-card rounded-2xl p-6">
                        <h3 class="text-lg font-bold text-slate-900 mb-4">Produção Diária</h3>
                        <div class="chart-container">
                            <canvas id="dailyVolumeChart"></canvas>
                        </div>
                    </div>

                    <!-- Weekly Production Chart -->
                    <div class="data-card rounded-2xl p-6">
                        <h3 class="text-lg font-bold text-slate-900 mb-4">Produção Semanal</h3>
                        <div class="chart-container">
                            <canvas id="weeklyVolumeChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Weekly Summary Chart (only visible on Sundays) -->
                <div id="weeklySummaryChartContainer" class="data-card rounded-2xl p-6" style="display: none;">
                    <h3 class="text-lg font-bold text-slate-900 mb-4">Resumo Semanal</h3>
                    <div class="chart-container">
                        <canvas id="weeklySummaryChart"></canvas>
                    </div>
                </div>

                <!-- Monthly Volume Chart (only visible on last day of month) -->
                <div id="monthlyVolumeChartContainer" class="data-card rounded-2xl p-6" style="display: none;">
                    <h3 class="text-lg font-bold text-slate-900 mb-4">Produção Mensal</h3>
                    <div class="chart-container">
                        <canvas id="monthlyVolumeChart"></canvas>
                    </div>
                </div>

                <!-- Volume Records -->
                <div class="data-card rounded-2xl p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-bold text-slate-900">Registros de Volume</h3>
                        <button onclick="addVolumeRecord()" class="px-4 py-2 bg-forest-600 text-white rounded-lg hover:shadow-lg transition-all font-semibold text-sm">
                            <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                            </svg>
                            Novo Registro
                        </button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="border-b border-gray-200">
                                    <th class="text-left py-3 px-4 font-semibold text-slate-900">Data/Hora</th>
                                    <th class="text-left py-3 px-4 font-semibold text-slate-900">Volume (L)</th>
                                    <th class="text-left py-3 px-4 font-semibold text-slate-900">Funcionário</th>
                                    <th class="text-left py-3 px-4 font-semibold text-slate-900">Observações</th>
                                    <th class="text-left py-3 px-4 font-semibold text-slate-900">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="volumeRecords">
                                <tr>
                                    <td colspan="5" class="text-center py-8 text-gray-500">
                                        Nenhum registro encontrado
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quality Tab -->
        <div id="quality-tab" class="tab-content hidden">
            <div class="space-y-6">
                <!-- Quality Header -->
                <div class="data-card rounded-2xl p-6">
                    <div class="flex flex-col sm:flex-row sm:items-center justify-between mb-6 gap-4">
                        <div>
                            <h2 class="text-xl md:text-2xl font-bold text-slate-900 mb-1">Controle de Qualidade</h2>
            <p class="text-slate-600 text-sm">Monitore os parâmetros de qualidade do leite</p>
                        </div>
                        <div class="flex flex-col sm:flex-row gap-3 w-full sm:w-auto">
                            <select id="qualityPeriod" class="px-4 py-2 border border-slate-200 rounded-lg text-sm focus:border-forest-500 focus:outline-none bg-white">
                                <option value="today">Hoje</option>
                                <option value="week">Esta Semana</option>
                                <option value="month">Este Mês</option>
                            </select>
                            <button onclick="exportQualityReport()" class="px-4 py-2 bg-forest-600 text-white rounded-lg hover:shadow-lg transition-all font-semibold text-sm">
                                <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                Relatório
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Quality Indicators -->
                <div class="grid grid-cols-2 gap-4">
                    <div class="data-card rounded-2xl p-4">
                        <div class="flex items-center justify-between mb-3">
                            <h4 class="font-semibold text-slate-900">Gordura</h4>
                            <span class="text-lg font-bold text-slate-900" id="fatContent">-</span>
                        </div>
                        <div class="quality-indicator">
                            <div class="quality-bar" id="fatQualityBar" style="width: 0%"></div>
                        </div>
                        <p class="text-xs text-slate-500 mt-2" id="fatQualityText">-</p>
                    </div>

                    <div class="data-card rounded-2xl p-4">
                        <div class="flex items-center justify-between mb-3">
                            <h4 class="font-semibold text-slate-900">Proteína</h4>
                            <span class="text-lg font-bold text-slate-900" id="proteinContent">-</span>
                        </div>
                        <div class="quality-indicator">
                            <div class="quality-bar" id="proteinQualityBar" style="width: 0%"></div>
                        </div>
                        <p class="text-xs text-slate-500 mt-2" id="proteinQualityText">-</p>
                    </div>

                    <div class="data-card rounded-2xl p-4">
                        <div class="flex items-center justify-between mb-3">
                            <h4 class="font-semibold text-slate-900">CCS</h4>
                            <span class="text-lg font-bold text-slate-900" id="sccCount">-</span>
                        </div>
                        <div class="quality-indicator">
                            <div class="quality-bar" id="sccQualityBar" style="width: 0%"></div>
                        </div>
                        <p class="text-xs text-slate-500 mt-2" id="sccQualityText">-</p>
                    </div>

                    <div class="data-card rounded-2xl p-4">
                        <div class="flex items-center justify-between mb-3">
                            <h4 class="font-semibold text-slate-900">CBT</h4>
                            <span class="text-lg font-bold text-slate-900" id="tbc">-</span>
                        </div>
                        <div class="quality-indicator">
                            <div class="quality-bar" id="tbcQualityBar" style="width: 0%"></div>
                        </div>
                        <p class="text-xs text-slate-500 mt-2" id="tbcQualityText">-</p>
                    </div>
                </div>
                <!-- Quality Trends -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="data-card rounded-2xl p-6">
                        <h3 class="text-lg font-bold text-slate-900 mb-4">Tendência de Qualidade</h3>
                        <div class="chart-container">
                            <canvas id="qualityTrendChart"></canvas>
                        </div>
                    </div>

                    <div class="data-card rounded-2xl p-6">
                        <h3 class="text-lg font-bold text-slate-900 mb-4">Distribuição de Qualidade</h3>
                        <div class="chart-container">
                            <canvas id="qualityDistributionChart"></canvas>
                        </div>
                    </div>

                    <div class="data-card rounded-2xl p-6">
                        <h3 class="text-lg font-bold text-slate-900 mb-4">Qualidade Semanal</h3>
                        <div class="chart-container">
                            <canvas id="qualityChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Quality Tests -->
                <div class="data-card rounded-2xl p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-bold text-slate-900">Testes de Qualidade</h3>
                        <button onclick="addQualityTest()" class="px-4 py-2 bg-forest-600 text-white rounded-lg hover:shadow-lg transition-all font-semibold text-sm">
                            <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                            </svg>
                            Novo Teste
                        </button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="border-b border-gray-200">
                                    <th class="text-left py-3 px-4 font-semibold text-slate-900">Data</th>
                                    <th class="text-left py-3 px-4 font-semibold text-slate-900">Gordura</th>
                                    <th class="text-left py-3 px-4 font-semibold text-slate-900">Proteína</th>
                                    <th class="text-left py-3 px-4 font-semibold text-slate-900">CCS</th>
                                    <th class="text-left py-3 px-4 font-semibold text-slate-900">CBT</th>
                                    <th class="text-left py-3 px-4 font-semibold text-slate-900">Laboratório</th>
                                    <th class="text-left py-3 px-4 font-semibold text-slate-900">Observações</th>
                                    <th class="text-left py-3 px-4 font-semibold text-slate-900">Status</th>
                                    <th class="text-left py-3 px-4 font-semibold text-slate-900">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="qualityTests">
                                <tr>
                                    <td colspan="9" class="text-center py-8 text-gray-500">
                                        Nenhum teste encontrado
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Financial Records Tab -->
        <div id="payments-tab" class="tab-content hidden">
            <div class="space-y-6">
                <!-- Financial Records Header -->
                <div class="data-card rounded-2xl p-6">
                    <div class="flex flex-col sm:flex-row sm:items-center justify-between mb-6 gap-4">
                        <div>
                            <h2 class="text-xl md:text-2xl font-bold text-slate-900 mb-1">Controle de Vendas</h2>
                <p class="text-slate-600 text-sm">Gerencie vendas de leite e recebimentos</p>
                        </div>
                        <div class="flex flex-col sm:flex-row gap-3 w-full sm:w-auto">
                            <select id="paymentPeriod" class="px-4 py-2 border border-slate-200 rounded-lg text-sm focus:border-forest-500 focus:outline-none bg-white">
                                <option value="month">Este Mês</option>
                                <option value="quarter">Trimestre</option>
                                <option value="year">Ano</option>
                            </select>
                            <button onclick="generatePaymentsReport()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:shadow-lg transition-all font-semibold text-sm">
                                <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                Relatório
                            </button>
                            <button onclick="addPayment()" class="px-4 py-2 bg-forest-600 text-white rounded-lg hover:shadow-lg transition-all font-semibold text-sm">
                        <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                        </svg>
                        Nova Venda
                    </button>
                        </div>
                    </div>
                </div>

                <!-- Payment Summary -->
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="data-card rounded-2xl p-6 text-center">
                        <div class="w-16 h-16 bg-green-100 rounded-2xl flex items-center justify-center mx-auto mb-4">
                            <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <div class="text-2xl font-bold text-slate-900 mb-2" id="paidAmount">-</div>
                        <div class="text-sm text-slate-600 font-medium">Vendas Realizadas</div>
                        <div class="text-xs text-green-600 font-semibold mt-2">Este Mês</div>
                    </div>

                    <div class="data-card rounded-2xl p-6 text-center">
                        <div class="w-16 h-16 bg-yellow-100 rounded-2xl flex items-center justify-center mx-auto mb-4">
                            <svg class="w-8 h-8 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <div class="text-2xl font-bold text-slate-900 mb-2" id="pendingAmount">-</div>
                        <div class="text-sm text-slate-600 font-medium">Vendas Pendentes</div>
                        <div class="text-xs text-yellow-600 font-semibold mt-2">A Vencer</div>
                    </div>

                    <div class="data-card rounded-2xl p-6 text-center">
                        <div class="w-16 h-16 bg-red-100 rounded-2xl flex items-center justify-center mx-auto mb-4">
                            <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                            </svg>
                        </div>
                        <div class="text-2xl font-bold text-slate-900 mb-2" id="overdueAmount">-</div>
                        <div class="text-sm text-slate-600 font-medium">Vendas Atrasadas</div>
                        <div class="text-xs text-red-600 font-semibold mt-2">Vencidos</div>
                    </div>
                </div>

                <!-- Payment Chart -->
                <div class="data-card rounded-2xl p-6">
                    <h3 class="text-lg font-bold text-slate-900 mb-4">Fluxo de Vendas</h3>
                    <div class="chart-container">
                        <canvas id="paymentsChart"></canvas>
                    </div>
                </div>
                <!-- Payments List -->
                <div class="data-card rounded-2xl p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-bold text-slate-900">Lista de Vendas</h3>
                        <div class="flex gap-2">
                            <select id="paymentFilter" class="px-3 py-2 border border-slate-200 rounded-lg text-sm focus:border-forest-500 focus:outline-none bg-white">
                                <option value="all">Todos</option>
                                <option value="paid">Pagos</option>
                                <option value="pending">Pendentes</option>
                                <option value="overdue">Atrasados</option>
                            </select>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="border-b border-gray-200">
                                    <th class="text-left py-3 px-4 font-semibold text-slate-900">Beneficiário</th>
                                    <th class="text-left py-3 px-4 font-semibold text-slate-900">Tipo</th>
                                    <th class="text-left py-3 px-4 font-semibold text-slate-900">Valor</th>
                                    <th class="text-left py-3 px-4 font-semibold text-slate-900">Vencimento</th>
                                    <th class="text-left py-3 px-4 font-semibold text-slate-900">Status</th>
                                    <th class="text-left py-3 px-4 font-semibold text-slate-900">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="paymentsList">
                                <tr>
                                    <td colspan="6" class="text-center py-8 text-gray-500">
                                        Nenhuma venda encontrada
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Users Tab -->
        <div id="users-tab" class="tab-content hidden users-section">
            <div class="space-y-6 sm:space-y-8">
                <!-- Users Header -->
                <div class="data-card rounded-2xl p-4 sm:p-6">
                    <div class="flex flex-col sm:flex-row sm:items-center justify-between mb-4 sm:mb-6 gap-3 sm:gap-4">
                        <div>
                            <h2 class="text-lg sm:text-xl md:text-2xl font-bold text-slate-900 mb-1">Gestão de Usuários</h2>
                            <p class="text-slate-600 text-xs sm:text-sm">Gerencie funcionários e suas permissões</p>
                        </div>
                        <div class="flex flex-col sm:flex-row gap-2 sm:gap-3 w-full sm:w-auto">
                            <select id="userFilter" class="px-3 sm:px-4 py-2 border border-slate-200 rounded-lg text-sm focus:border-forest-500 focus:outline-none bg-white">
                                <option value="all">Todos os usuários</option>
                                <option value="funcionario">Funcionários</option>
                                <option value="veterinario">Veterinários</option>
                                <option value="proprietario">Proprietários</option>
                            </select>
                            <button onclick="addUser()" class="px-3 sm:px-4 py-2 bg-forest-600 text-white rounded-lg hover:shadow-lg transition-all font-semibold text-sm">
                                <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                </svg>
                                Adicionar Usuário
                            </button>
                        </div>
                    </div>
                </div>

                <!-- User Stats -->
                <div class="grid grid-cols-2 gap-4 sm:gap-6">
                    <div class="data-card rounded-2xl p-4 sm:p-6 text-center metric-card-responsive">
                        <div class="w-10 h-10 sm:w-12 sm:h-12 bg-blue-500 rounded-xl flex items-center justify-center mx-auto mb-2 sm:mb-3 shadow-lg">
                            <svg class="w-5 h-5 sm:w-6 sm:h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                            </svg>
                        </div>
                        <div class="text-lg sm:text-xl font-bold text-slate-900 mb-1" id="totalUsers">--</div>
                        <div class="text-xs text-slate-500 font-medium">Total</div>
                        <div class="text-xs text-slate-600 font-semibold mt-1">Usuários</div>
                    </div>
                    
                    <div class="data-card rounded-2xl p-4 sm:p-6 text-center metric-card-responsive">
                        <div class="w-10 h-10 sm:w-12 sm:h-12 bg-green-500 rounded-xl flex items-center justify-center mx-auto mb-2 sm:mb-3 shadow-lg">
                            <svg class="w-5 h-5 sm:w-6 sm:h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                            </svg>
                        </div>
                        <div class="text-lg sm:text-xl font-bold text-slate-900 mb-1" id="employeesCount">--</div>
                        <div class="text-xs text-slate-500 font-medium">Funcionários</div>
                        <div class="text-xs text-slate-600 font-semibold mt-1">Ativos</div>
                    </div>
                    
                    <div class="data-card rounded-2xl p-4 sm:p-6 text-center metric-card-responsive">
                        <div class="w-10 h-10 sm:w-12 sm:h-12 bg-purple-500 rounded-xl flex items-center justify-center mx-auto mb-2 sm:mb-3 shadow-lg">
                            <svg class="w-5 h-5 sm:w-6 sm:h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                            </svg>
                        </div>
                        <div class="text-lg sm:text-xl font-bold text-slate-900 mb-1" id="veterinariansCount">--</div>
                        <div class="text-xs text-slate-500 font-medium">Veterinários</div>
                        <div class="text-xs text-slate-600 font-semibold mt-1">Ativos</div>
                    </div>
                    
                    <div class="data-card rounded-2xl p-4 sm:p-6 text-center metric-card-responsive">
                        <div class="w-10 h-10 sm:w-12 sm:h-12 bg-orange-500 rounded-xl flex items-center justify-center mx-auto mb-2 sm:mb-3 shadow-lg">
                            <svg class="w-5 h-5 sm:w-6 sm:h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                            </svg>
                        </div>
                        <div class="text-lg sm:text-xl font-bold text-slate-900 mb-1" id="managersCount">--</div>
                        <div class="text-xs text-slate-500 font-medium">Gerentes</div>
                        <div class="text-xs text-slate-600 font-semibold mt-1">Ativos</div>
                    </div>
                </div>

                <!-- Users List -->
                <div class="data-card rounded-2xl p-4 sm:p-6">
                    <h3 class="text-base sm:text-lg font-bold text-slate-900 mb-4 sm:mb-6">Lista de Usuários</h3>
                    <div class="space-y-4 sm:space-y-6" id="usersList">
                        <div class="text-center py-8 sm:py-12">
                            <div class="w-16 h-16 sm:w-20 sm:h-20 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4 sm:mb-6">
                                <svg class="w-8 h-8 sm:w-10 sm:h-10 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                </svg>
                            </div>
                            <h3 class="text-base sm:text-lg font-semibold text-gray-900 mb-2">Nenhum Usuário Cadastrado</h3>
                            <p class="text-gray-600 mb-3 sm:mb-4 text-sm">Adicione usuários para gerenciar sua equipe</p>
                            <button onclick="addUser()" class="px-4 sm:px-6 py-2 sm:py-3 gradient-forest text-white font-semibold rounded-xl hover:shadow-lg transition-all text-sm">
                                <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                </svg>
                                Adicionar Primeiro Usuário
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Enhanced Mobile Navigation -->
    <nav class="fixed bottom-0 left-0 right-0 md:hidden mobile-nav-enhanced shadow-2xl z-40">
        <div class="grid grid-cols-6 gap-1 p-2">
            <button class="mobile-nav-item active flex flex-col items-center py-2 px-1 transition-all" data-tab="dashboard">
                <svg class="w-4 h-4 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2H5a2 2 0 00-2-2z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" d="M8 7V5a2 2 0 012-2h4a2 2 0 012 2v2"></path>
                </svg>
                <span class="text-xs font-semibold">Dashboard</span>
            </button>
            <button class="mobile-nav-item flex flex-col items-center py-2 px-1 transition-all" data-tab="volume">
                <svg class="w-4 h-4 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path>
                            </svg>
                <span class="text-xs font-semibold">Volume</span>
            </button>
            <button class="mobile-nav-item flex flex-col items-center py-2 px-1 transition-all" data-tab="quality">
                <svg class="w-4 h-4 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <span class="text-xs font-semibold">Qualidade</span>
            </button>
            <button class="mobile-nav-item flex flex-col items-center py-2 px-1 transition-all" data-tab="payments">
                <svg class="w-4 h-4 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                </svg>
                <span class="text-xs font-semibold">Financeiro</span>
            </button>
            <button class="mobile-nav-item flex flex-col items-center py-2 px-1 transition-all" data-tab="users">
                <svg class="w-4 h-4 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 19.128a9.38 9.38 0 002.625.372 9.337 9.337 0 004.121-.952 4.125 4.125 0 00-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 018.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0111.964-3.07M12 6.375a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zm8.25 2.25a2.625 2.625 0 11-5.25 0 2.625 2.625 0 015.25 0z"></path>
                </svg>
                <span class="text-xs font-semibold">Usuários</span>
            </button>
            <button class="mobile-nav-item flex flex-col items-center py-2 px-1 transition-all" onclick="openMoreModal()">
                <svg class="w-4 h-4 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"></path>
                            </svg>
                <span class="text-xs font-semibold">Mais</span>
            </button>
        </div>
    </nav>
    <!-- Reports Tab -->
    <div id="reports-tab" class="tab-content hidden">
        <div class="px-4 sm:px-6 lg:px-8 py-6">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <!-- Configurações de Relatórios -->
            <div class="bg-gradient-to-br from-white to-slate-50 rounded-2xl p-8 border border-slate-200 shadow-lg">
                <!-- Header da Seção -->
                <div class="flex items-center mb-6">
                    <div class="p-3 bg-gradient-to-br from-green-500 to-green-600 rounded-xl mr-4">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>
                        </div>
                    <div>
                        <h3 class="text-xl font-bold text-slate-900">Configurações de Relatórios</h3>
                        <p class="text-sm text-slate-600">Personalize a aparência dos seus relatórios</p>
                    </div>
                    </div>
                    
                <div class="space-y-6">
                    <!-- Nome da Fazenda -->
                    <div class="space-y-2">
                        <label class="block text-sm font-semibold text-slate-700 flex items-center">
                            <svg class="w-4 h-4 mr-2 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2H5a2 2 0 00-2-2z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V5a2 2 0 012-2h4a2 2 0 012 2v2"></path>
                            </svg>
                            Nome da Fazenda
                        </label>
                        <input type="text" id="reportFarmNameTab" class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:border-green-500 focus:ring-2 focus:ring-green-100 focus:outline-none bg-white shadow-sm transition-all" placeholder="Digite o nome da fazenda">
                </div>

                    <!-- Upload da Logo da Fazenda -->
                    <div class="space-y-3">
                        <label class="block text-sm font-semibold text-slate-700 flex items-center">
                            <svg class="w-4 h-4 mr-2 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                            </svg>
                            Logo da Fazenda
                        </label>
                        
                        <div class="bg-white rounded-xl p-4 border border-slate-200 shadow-sm">
                            <div class="flex items-center space-x-4">
                                <div class="relative">
                                    <!-- Preview da logo -->
                                    <div id="farmLogoPreviewTab" class="w-20 h-20 border-2 border-dashed border-green-300 rounded-xl flex items-center justify-center bg-green-50 hidden">
                                        <img id="farmLogoImageTab" src="" alt="Logo da Fazenda" class="w-full h-full object-cover rounded-xl">
                        </div>
                                    <!-- Placeholder quando não há logo -->
                                    <div id="farmLogoPlaceholderTab" class="w-20 h-20 border-2 border-dashed border-slate-300 rounded-xl flex items-center justify-center bg-slate-50">
                                        <svg class="w-8 h-8 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                        </svg>
                    </div>
                </div>
                                <div class="flex-1 space-y-2">
                                    <div class="flex flex-wrap gap-2">
                                        <button onclick="document.getElementById('farmLogoUploadTab').click()" class="flex items-center px-4 py-2 bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-medium rounded-lg transition-all text-sm shadow-md hover:shadow-lg">
                                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                                <path stroke-linecap="round" stroke-linejoin="round" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                            </svg>
                                            Escolher Logo
                                        </button>
                                        <button id="removeFarmLogoTab" onclick="removeFarmLogoTab()" class="flex items-center px-4 py-2 bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white font-medium rounded-lg transition-all text-sm shadow-md hover:shadow-lg hidden">
                                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                                <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                            </svg>
                                            Remover
                                        </button>
                    </div>
                                    <input type="file" id="farmLogoUploadTab" accept="image/*" class="hidden" onchange="handleFarmLogoUploadTab(event)">
                                    <p class="text-xs text-slate-500 flex items-center">
                                        <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                        PNG, JPG, JPEG (máx. 2MB) - Preferência: formato quadrado
                                    </p>
                </div>
                            </div>
                    </div>
                </div>

                    <!-- Botão Salvar -->
                    <div class="pt-4 border-t border-slate-200">
                        <button onclick="saveReportSettingsTab()" class="w-full sm:w-auto flex items-center justify-center px-8 py-3 bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white font-semibold rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 transform hover:-translate-y-0.5">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"></path>
                            </svg>
                            Salvar Configurações
                        </button>
                </div>
            </div>
        </div>

            <!-- Estatísticas Rápidas -->
            <div class="bg-gradient-to-br from-green-50 to-emerald-50 rounded-2xl p-4 sm:p-6 lg:p-8 border border-green-200 shadow-lg relative overflow-hidden">
                <!-- Background Pattern -->
                <div class="absolute inset-0 opacity-5">
                    <div class="absolute inset-0 bg-gradient-to-br from-green-500 to-emerald-600"></div>
                    <svg class="absolute top-0 right-0 w-20 sm:w-24 lg:w-32 h-20 sm:h-24 lg:h-32 transform translate-x-4 sm:translate-x-6 lg:translate-x-8 -translate-y-4 sm:-translate-y-6 lg:-translate-y-8" fill="currentColor" viewBox="0 0 100 100">
                        <circle cx="50" cy="50" r="35"/>
                    </svg>
                    <svg class="absolute bottom-0 left-0 w-16 sm:w-20 lg:w-24 h-16 sm:h-20 lg:h-24 transform -translate-x-2 sm:-translate-x-3 lg:-translate-x-4 translate-y-2 sm:translate-y-3 lg:translate-y-4" fill="currentColor" viewBox="0 0 100 100">
                        <rect x="30" y="30" width="40" height="40" rx="8"/>
                    </svg>
                        </div>
                
                <!-- Header da Seção -->
                <div class="relative flex flex-col sm:flex-row items-start sm:items-center mb-4 sm:mb-6">
                    <div class="p-2 sm:p-3 bg-gradient-to-br from-green-500 to-emerald-600 rounded-lg sm:rounded-xl mr-0 sm:mr-4 mb-3 sm:mb-0">
                        <svg class="w-5 h-5 sm:w-6 sm:h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                </svg>
                        </div>
                    <div>
                        <h3 class="text-lg sm:text-xl font-bold text-slate-900">Resumo de Produção</h3>
                        <p class="text-xs sm:text-sm text-slate-600">Indicadores em tempo real</p>
                    </div>
                </div>

                <div class="relative space-y-3 sm:space-y-4">
                    <!-- Produção de Hoje - Destaque -->
                    <div class="bg-white/80 backdrop-blur-sm rounded-xl p-3 sm:p-4 border border-white/50 shadow-sm hover:shadow-md transition-all duration-300">
                        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between space-y-3 sm:space-y-0">
                            <div class="flex items-center space-x-2 sm:space-x-3">
                                <div class="p-1.5 sm:p-2 bg-gradient-to-br from-green-400 to-green-500 rounded-lg flex-shrink-0">
                                    <svg class="w-4 h-4 sm:w-5 sm:h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                        </div>
                                <div>
                                    <p class="text-sm sm:text-base font-medium text-slate-600">Produção de Hoje</p>
                                    <p class="text-xs text-slate-500">Volume registrado</p>
                        </div>
                    </div>
                            <div class="text-left sm:text-right">
                                <p class="text-xl sm:text-2xl font-bold text-green-600" id="reportTodayVolume">0.0 L</p>
                                <p class="text-xs text-slate-500">litros</p>
                        </div>
                        </div>
                    </div>

                    <!-- Outras Métricas -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 sm:gap-3">
                        <div class="bg-white/60 backdrop-blur-sm rounded-lg p-2 sm:p-3 border border-white/30 hover:bg-white/80 transition-all duration-300">
                            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between space-y-2 sm:space-y-0">
                                <div class="flex items-center space-x-2">
                                    <div class="p-1 sm:p-1.5 bg-blue-100 rounded-md flex-shrink-0">
                                        <svg class="w-3 h-3 sm:w-4 sm:h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"></path>
                                        </svg>
                        </div>
                                    <span class="text-xs sm:text-sm font-medium text-slate-700">Média Semanal</span>
                        </div>
                                <span class="text-sm sm:text-base font-bold text-blue-600" id="reportWeekAverage">0.0 L</span>
                            </div>
                    </div>

                        <div class="bg-white/60 backdrop-blur-sm rounded-lg p-2 sm:p-3 border border-white/30 hover:bg-white/80 transition-all duration-300">
                            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between space-y-2 sm:space-y-0">
                                <div class="flex items-center space-x-2">
                                    <div class="p-1 sm:p-1.5 bg-emerald-100 rounded-md flex-shrink-0">
                                        <svg class="w-3 h-3 sm:w-4 sm:h-4 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                        </svg>
                        </div>
                                    <span class="text-xs sm:text-sm font-medium text-slate-700">Total do Mês</span>
                        </div>
                                <span class="text-sm sm:text-base font-bold text-emerald-600" id="reportMonthTotal">0.0 L</span>
                            </div>
                    </div>

                        <div class="bg-white/60 backdrop-blur-sm rounded-lg p-2 sm:p-3 border border-white/30 hover:bg-white/80 transition-all duration-300">
                            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between space-y-2 sm:space-y-0">
                                <div class="flex items-center space-x-2">
                                    <div class="p-1 sm:p-1.5 bg-orange-100 rounded-md flex-shrink-0">
                                        <svg class="w-3 h-3 sm:w-4 sm:h-4 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                        </svg>
                        </div>
                                    <span class="text-xs sm:text-sm font-medium text-slate-700">Registros</span>
                    </div>
                                <span class="text-sm sm:text-base font-bold text-orange-600" id="reportMonthRecords">0</span>
                        </div>
                    </div>

                        <div class="bg-white/60 backdrop-blur-sm rounded-lg p-2 sm:p-3 border border-white/30 hover:bg-white/80 transition-all duration-300">
                            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between space-y-2 sm:space-y-0">
                                <div class="flex items-center space-x-2">
                                    <div class="p-1 sm:p-1.5 bg-teal-100 rounded-md flex-shrink-0">
                                        <svg class="w-3 h-3 sm:w-4 sm:h-4 text-teal-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"></path>
                                        </svg>
                        </div>
                                    <span class="text-xs sm:text-sm font-medium text-slate-700">Funcionários</span>
                    </div>
                                <span class="text-sm sm:text-base font-bold text-teal-600" id="reportActiveEmployees">0</span>
                </div>
                    </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Exportar Relatórios -->
        <div class="bg-gradient-to-br from-white to-slate-50 rounded-2xl p-8 border border-slate-200 shadow-lg">
            <!-- Header da Seção -->
            <div class="flex items-center mb-8">
                <div class="p-3 bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl mr-4">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.207A1 1 0 013 6.5V4z"></path>
                                </svg>
                        </div>
                <div>
                    <h3 class="text-xl font-bold text-slate-900">Exportar Relatórios</h3>
                    <p class="text-sm text-slate-600">Gere relatórios personalizados da produção</p>
                    </div>
                </div>

            <!-- Filtros de Data - Design Melhorado -->
            <div class="bg-white rounded-xl p-6 border border-slate-200 shadow-sm mb-8">
                <h4 class="text-lg font-semibold text-slate-800 mb-4 flex items-center">
                    <svg class="w-5 h-5 mr-2 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.207A1 1 0 013 6.5V4z"></path>
                    </svg>
                    Filtros de Relatório
                </h4>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="space-y-2">
                        <label class="block text-sm font-semibold text-slate-700">Data Inicial</label>
                        <div class="relative">
                            <input type="date" id="reportStartDate" class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all bg-white shadow-sm">
                            <svg class="absolute right-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-slate-400 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                            </svg>
                        </div>
                    </div>
                    <div class="space-y-2">
                        <label class="block text-sm font-semibold text-slate-700">Data Final</label>
                        <div class="relative">
                            <input type="date" id="reportEndDate" class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all bg-white shadow-sm">
                            <svg class="absolute right-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-slate-400 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                            </svg>
                        </div>
                    </div>
                    <div class="space-y-2">
                        <label class="block text-sm font-semibold text-slate-700">Funcionário</label>
                        <div class="relative">
                            <select id="reportEmployee" class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all bg-white shadow-sm appearance-none">
                                <option value="">Todos os funcionários</option>
                            </select>
                            <svg class="absolute right-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-slate-400 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </div>
                    </div>
                    </div>
                </div>

            <!-- Botões de Exportação - Design Responsivo -->
            <!-- Botões de Exportação - Design Simples -->
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-8">
                <!-- PDF -->
                <button onclick="exportPDFReport()" class="bg-red-600 hover:bg-red-700 text-white rounded-lg p-4 transition-colors duration-200 shadow-md">
                    <div class="flex flex-col items-center space-y-2">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        <div class="text-center">
                            <h4 class="font-bold">Exportar PDF</h4>
                            <p class="text-sm opacity-90">Relatório completo formatado</p>
                        </div>
                    </div>
                </button>
                
                <!-- Excel -->
                <button onclick="exportExcelReport()" class="bg-green-600 hover:bg-green-700 text-white rounded-lg p-4 transition-colors duration-200 shadow-md">
                    <div class="flex flex-col items-center space-y-2">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        <div class="text-center">
                            <h4 class="font-bold">Exportar Excel</h4>
                            <p class="text-sm opacity-90">Planilha para análise</p>
                        </div>
                    </div>
                </button>
                
                <!-- Prévia -->
                <button onclick="previewReportTab()" class="bg-purple-600 hover:bg-purple-700 text-white rounded-lg p-4 transition-colors duration-200 shadow-md">
                    <div class="flex flex-col items-center space-y-2">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                        </svg>
                        <div class="text-center">
                            <h4 class="font-bold">Visualizar Prévia</h4>
                            <p class="text-sm opacity-90">Amostra do relatório</p>
                        </div>
                    </div>
                </button>
                        </div>
                    </div>
                </div>
                
                <!-- Espaço adicional para rolagem -->
                <div class="h-32"></div>
            </div>
        </div>
    <!-- Modal de Adicionar Usuário -->
    <div id="addUserModal" class="fullscreen-modal">
        <div class="modal-content">
            <!-- Header do Modal -->
            <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 z-10">
                <div class="flex items-center justify-between">
                    <h2 class="text-xl font-bold text-gray-900">Adicionar Novo Usuário</h2>
                    <button onclick="closeAddUserModal()" class="p-2 hover:bg-gray-100 rounded-lg transition-all">
                        <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>
            
            <!-- Conteúdo do Modal -->
            <div class="p-6 space-y-6">
                <!-- Formulário de Adicionar Usuário -->
                <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-200">
                    <h4 class="text-lg font-semibold text-gray-900 mb-4">Informações do Usuário</h4>
                    <form id="addUserFormModal" class="space-y-4">
                        <div class="form-floating">
                            <input type="text" id="userName" name="name" class="w-full px-3 py-4 border border-slate-200 rounded-xl focus:border-forest-500 focus:ring-2 focus:ring-forest-100 focus:outline-none" placeholder=" " required>
                            <label for="userName" class="text-slate-600">Nome Completo *</label>
                        </div>
                                                
                        <!-- Email Preview -->
                        <div class="bg-gray-50 border border-gray-200 rounded-xl p-4">
                            <div class="flex items-center">
                                <svg class="w-5 h-5 text-gray-500 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V5a2 2 0 00-2-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                <div>
                                    <h5 class="text-sm font-semibold text-gray-900 mb-1">Email será gerado automaticamente:</h5>
                                    <p class="text-sm text-gray-600" id="emailPreview">Digite o nome para ver o email</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="form-floating">
                                <input type="tel" id="userWhatsapp" name="whatsapp" class="w-full px-3 py-4 border border-slate-200 rounded-xl focus:border-forest-500 focus:ring-2 focus:ring-forest-100 focus:outline-none" placeholder=" " required>
                                <label for="userWhatsapp" class="text-slate-600">WhatsApp *</label>
                            </div>
                            <div class="form-floating">
                                <select id="userRole" name="role" class="w-full px-3 py-4 border border-slate-200 rounded-xl focus:border-forest-500 focus:ring-2 focus:ring-forest-100 focus:outline-none" required onchange="togglePhotoSection();">
                                    <option value="">Selecione o cargo</option>
                                    <option value="funcionario">Funcionário</option>
                                    <option value="veterinario">Veterinário</option>
                                </select>
                                <label for="userRole" class="text-slate-600">Cargo *</label>
                            </div>
                        </div>
                        
                        <!-- Seção de Foto de Perfil para Add User (funcionários e veterinários) -->
                        <div id="addPhotoSection" class="hidden" style="display: none !important;">
                            <label class="block text-sm font-semibold text-gray-800 mb-2">Foto de Perfil (Opcional)</label>
                            <div class="flex items-center space-x-4">
                                <div class="relative">
                                    <img id="profilePreview" src="" alt="Preview da foto" class="w-16 h-16 rounded-xl object-cover hidden" style="display: none;">
                                    <div id="profilePlaceholder" class="w-16 h-16 bg-gray-100 rounded-xl flex items-center justify-center">
                                        <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                        </svg>
                                    </div>
                                </div>
                                <div>
                                    <button type="button" onclick="addPhotoToNewUser()" class="px-4 py-2 bg-forest-600 hover:bg-forest-700 text-white font-medium rounded-lg transition-all text-sm">
                                        Escolher Foto
                                    </button>
                                    <input type="file" id="profilePhotoInput" name="profilePhoto" accept="image/*" class="hidden" onchange="previewProfilePhoto(this)">
                                    <p class="text-xs text-gray-500 mt-1">Formatos: JPG, PNG (máx. 2MB) - Opcional</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-floating relative">
                            <input type="password" id="userPassword" name="password" class="w-full px-3 py-4 pr-12 border border-slate-200 rounded-xl focus:border-forest-500 focus:ring-2 focus:ring-forest-100 focus:outline-none" placeholder=" " required>
                            <label for="userPassword" class="text-slate-600">Senha *</label>
                            <button type="button" onclick="togglePasswordVisibility('userPassword', 'userPasswordToggle')" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700 focus:outline-none" id="userPasswordToggle">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                </svg>
                            </button>
                        </div>
                        
                        <div class="bg-blue-50 border border-blue-200 rounded-xl p-4">
                            <div class="flex items-start">
                                <svg class="w-5 h-5 text-blue-500 mt-0.5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                <div>
                                    <h5 class="text-sm font-semibold text-blue-900 mb-1">Informações Importantes</h5>
                                    <p class="text-sm text-blue-700">• Como gerente, você pode criar perfis de funcionários e veterinários</p>
                                    <p class="text-sm text-blue-700">• O usuário receberá as credenciais por WhatsApp</p>
                                    <p class="text-sm text-blue-700">• O email será gerado automaticamente baseado no nome da fazenda</p>
                                    <p class="text-sm text-blue-700">• Recomenda-se que o usuário altere a senha no primeiro acesso</p>
                                    <p class="text-sm text-blue-700">• O acesso será ativado imediatamente após a criação</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex justify-end space-x-3 pt-4">
                            <button type="button" onclick="closeAddUserModal()" class="px-6 py-3 border border-gray-300 text-gray-700 font-semibold rounded-xl hover:bg-gray-50 transition-all">
                                Cancelar
                            </button>
                            <button type="submit" id="createUserBtn" class="px-6 py-3 gradient-forest text-white font-semibold rounded-xl hover:shadow-lg transition-all">
                                <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                </svg>
                                Criar Usuário
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Editar Usuário -->
    <div id="editUserModal" class="fullscreen-modal">
        <div class="modal-content">
            <!-- Header do Modal -->
            <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 z-10">
                <div class="flex items-center justify-between">
                    <h2 class="text-xl font-bold text-gray-900">Editar Usuário</h2>
                    <button onclick="closeEditUserModal()" class="p-2 hover:bg-gray-100 rounded-lg transition-all">
                        <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>
            
            <!-- Conteúdo do Modal -->
            <div class="p-6 space-y-6">
                <!-- Formulário de Editar Usuário -->
                <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-200">
                    <h4 class="text-lg font-semibold text-gray-900 mb-4">Informações do Usuário</h4>
                    <form id="editUserFormModal" class="space-y-4">
                        <input type="hidden" id="editUserId" name="id">
                        
                        <div class="form-floating">
                            <input type="text" id="editUserName" name="name" class="w-full px-3 py-4 border border-slate-200 rounded-xl focus:border-forest-500 focus:ring-2 focus:ring-forest-100 focus:outline-none" placeholder=" " required>
                            <label for="editUserName" class="text-slate-600">Nome Completo *</label>
                        </div>
                                                
                        <div class="form-floating">
                            <input type="email" id="editUserEmail" name="email" class="w-full px-3 py-4 border border-slate-200 rounded-xl bg-gray-100 text-gray-500" placeholder=" " readonly>
                            <label for="editUserEmail" class="text-slate-600">Email (não pode ser alterado)</label>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="form-floating">
                                <input type="tel" id="editUserWhatsapp" name="whatsapp" class="w-full px-3 py-4 border border-slate-200 rounded-xl focus:border-forest-500 focus:ring-2 focus:ring-forest-100 focus:outline-none" placeholder=" " required>
                                <label for="editUserWhatsapp" class="text-slate-600">WhatsApp *</label>
                            </div>
                            <div class="form-floating">
                                <select id="editUserRole" name="role" class="w-full px-3 py-4 border border-slate-200 rounded-xl focus:border-forest-500 focus:ring-2 focus:ring-forest-100 focus:outline-none" required>
                                    <option value="">Selecione o cargo</option>
                                    <option value="funcionario">Funcionário</option>
                                    <option value="veterinario">Veterinário</option>
                                </select>
                                <label for="editUserRole" class="text-slate-600">Cargo *</label>
                            </div>
                        </div>
                        
                        <!-- Seção de Foto de Perfil para Edit User -->
                        <div id="editPhotoSection" class="hidden">
                            <label class="block text-sm font-semibold text-gray-800 mb-2">Foto de Perfil</label>
                            <div class="flex items-center space-x-4">
                                <div class="relative">
                                    <img id="editProfilePreview" src="" alt="Preview da foto" class="w-16 h-16 rounded-xl object-cover hidden">
                                    <div id="editProfilePlaceholder" class="w-16 h-16 bg-gray-100 rounded-xl flex items-center justify-center">
                                        <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                        </svg>
                                    </div>
                                </div>
                                <div>
                                    <button type="button" onclick="addPhotoToEditUser()" class="px-4 py-2 bg-forest-600 hover:bg-forest-700 text-white font-medium rounded-lg transition-all text-sm">
                                        Alterar Foto
                                    </button>
                                    <input type="file" id="editProfilePhoto" name="profilePhoto" accept="image/*" class="hidden" onchange="previewEditProfilePhoto(this)">
                                    <p class="text-xs text-gray-500 mt-1">Formatos: JPG, PNG (máx. 2MB)</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-floating relative">
                            <input type="password" id="editUserPassword" name="password" class="w-full px-3 py-4 pr-12 border border-slate-200 rounded-xl focus:border-forest-500 focus:ring-2 focus:ring-forest-100 focus:outline-none" placeholder=" ">
                            <label for="editUserPassword" class="text-slate-600">Nova Senha (deixe em branco para manter a atual)</label>
                            <button type="button" onclick="togglePasswordVisibility('editUserPassword', 'editUserPasswordToggle')" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700 focus:outline-none" id="editUserPasswordToggle">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                </svg>
                            </button>
                        </div>
                        
                        <div class="bg-blue-50 border border-blue-200 rounded-xl p-4">
                            <div class="flex items-start">
                                <svg class="w-5 h-5 text-blue-500 mt-0.5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                <div>
                                    <h5 class="text-sm font-semibold text-blue-900 mb-1">Informações sobre Edição</h5>
                                    <p class="text-sm text-blue-700">• O email não pode ser alterado após a criação</p>
                                    <p class="text-sm text-blue-700">• Deixe o campo senha em branco para manter a senha atual</p>
                                    <p class="text-sm text-blue-700">• As alterações serão aplicadas imediatamente</p>
                                    <p class="text-sm text-blue-700">• O usuário será notificado sobre as mudanças por WhatsApp</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex justify-end space-x-3 pt-4">
                            <button type="button" onclick="closeEditUserModal()" class="px-6 py-3 border border-gray-300 text-gray-700 font-semibold rounded-xl hover:bg-gray-50 transition-all">
                                Cancelar
                            </button>
                            <button type="submit" class="px-6 py-3 gradient-forest text-white font-semibold rounded-xl hover:shadow-lg transition-all">
                                <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"></path>
                                </svg>
                                Salvar Alterações
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>



    <!-- Modal de Escolha de Foto Novo -->
    <div id="photoChoiceModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-[99999]" style="display: none;">
        <div class="bg-white rounded-2xl p-6 max-w-sm w-full mx-4 shadow-xl">
            <div class="text-center mb-6">
                <h3 class="text-xl font-bold text-gray-800 mb-2">Adicionar Foto</h3>
                <p class="text-gray-600 text-sm">Escolha como adicionar a foto do funcionário</p>
            </div> 
    
            <div class="space-y-3">
                <button onclick="selectFromGallery()" class="w-full p-4 bg-blue-500 hover:bg-blue-600 text-white rounded-xl transition-colors flex items-center justify-center space-x-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"> 
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                    </svg> 
                    <span>Galeria</span>
                </button> 
                
                <button onclick="takePhoto()" class="w-full p-4 bg-green-500 hover:bg-green-600 text-white rounded-xl transition-colors flex items-center justify-center space-x-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"> 
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0118.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg> 
                    <span>Câmera</span>
                </button> 
            </div> 
    
            <button onclick="closePhotoChoiceModal()" class="w-full mt-4 p-3 border border-gray-300 text-gray-700 rounded-xl hover:bg-gray-50 transition-colors">
                Cancelar 
            </button> 
        </div> 
    </div>

    <!-- Modal da Câmera -->
    <div id="cameraModal" class="fixed inset-0 bg-black z-[10001] hidden">
        <div class="relative w-full h-full bg-black overflow-hidden">
            <!-- Header Minimalista -->
            <div class="absolute top-0 left-0 right-0 z-20 p-6">
                <div class="flex items-center justify-between">
                    <!-- Logo LacTech -->
                    <div class="flex items-center space-x-3">
                        <img src="assets/img/lactech-logo.png" alt="LacTech" class="w-8 h-8 rounded-lg">
                        <div class="text-white">
                            <div class="text-sm font-semibold">LacTech</div>
                            <div class="text-xs opacity-70">Verificação Facial</div>
                        </div>
                    </div>
                    
                    <!-- Botão Fechar -->
                    <button onclick="closeCamera()" class="p-2 bg-black/30 backdrop-blur-md rounded-full hover:bg-black/50 transition-all">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Video da Câmera -->
            <video id="cameraVideo" class="w-full h-full object-cover" autoplay playsinline></video>
            
            <!-- Overlay de Verificação Facial -->
            <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                <!-- Círculo de Foco Principal -->
                <div id="focusCircle" class="relative">
                    <!-- Círculo Externo Animado -->
                    <div class="w-80 h-80 border-2 border-white/40 rounded-full flex items-center justify-center animate-pulse">
                        <!-- Círculo Interno -->
                        <div class="w-72 h-72 border-2 border-white/60 rounded-full flex items-center justify-center">
                            <!-- Círculo de Foco -->
                            <div class="w-64 h-64 border-3 border-white/80 rounded-full flex items-center justify-center">
                                <!-- Indicador de Foco -->
                                <div id="focusIndicator" class="w-56 h-56 border-2 border-green-400 rounded-full flex items-center justify-center opacity-0 transition-opacity duration-500">
                                    <div class="w-48 h-48 border border-green-300 rounded-full"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Instruções -->
                    <div class="absolute -bottom-16 left-1/2 transform -translate-x-1/2 text-center">
                        <div id="focusText" class="text-white text-lg font-medium mb-2">Posicione o rosto no centro</div>
                        <div id="focusTimer" class="text-white/70 text-sm hidden">Focando em <span id="timerCount">3</span>s...</div>
                    </div>
                </div>
            </div>

            <!-- Controles Minimalistas -->
            <div class="absolute bottom-0 left-0 right-0 z-20 p-8">
                <div class="flex items-center justify-center space-x-12">
                    <!-- Botão Trocar Câmera -->
                    <button onclick="switchCamera()" class="p-4 bg-black/30 backdrop-blur-md rounded-full hover:bg-black/50 transition-all">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                    </button>
                    
                    <!-- Botão de Captura -->
                    <button id="captureBtn" onclick="startFaceVerification()" class="p-6 bg-white rounded-full hover:bg-gray-100 transition-all shadow-2xl transform hover:scale-105">
                        <div class="w-20 h-20 border-4 border-gray-200 rounded-full flex items-center justify-center">
                            <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center">
                                <svg class="w-8 h-8 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                </svg>
                            </div>
                        </div>
                    </button>
                    
                    <!-- Botão Cancelar -->
                    <button onclick="closeCamera()" class="p-4 bg-black/30 backdrop-blur-md rounded-full hover:bg-black/50 transition-all">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Canvas para Captura -->
            <canvas id="cameraCanvas" class="hidden"></canvas>
            
            <!-- Tela de Carregamento da Foto -->
            <div id="photoProcessingScreen" class="absolute inset-0 bg-black bg-opacity-90 flex items-center justify-center z-30 hidden">
                <div class="text-center text-white">
                    <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-white mx-auto mb-4"></div>
                    <h3 class="text-xl font-semibold mb-2">Processando foto...</h3>
                    <p class="text-white/70">Aguarde enquanto processamos sua imagem</p>
                </div>
            </div>
        </div>
    </div>

<!-- Modal de Perfil do Gerente -->
    <div id="profileModal" class="fullscreen-modal">
        <div class="modal-content overflow-y-auto">
            <!-- Header do Modal -->
            <div id="profileModalHeader" class="sticky top-0 left-0 right-0 bg-white border-b border-gray-200 px-4 sm:px-6 py-4 z-20 transition-transform duration-300 ease-in-out -mx-4 sm:mx-0">
                <div class="flex items-center justify-between">
                    <h2 class="text-xl font-bold text-gray-900">Perfil do Gerente</h2>
                    <button onclick="closeProfileModal()" class="p-2 hover:bg-gray-100 rounded-lg transition-all">
                        <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>
            
            <!-- Conteúdo do Perfil -->
            <div class="p-4 sm:p-6 pb-8">
                <div class="flex items-center justify-between mb-6">
                                            <div class="flex items-center space-x-4">
                            <div class="relative">
                                <!-- Foto do usuário -->
                                <img id="modalProfilePhoto" src="" alt="Foto de Perfil" class="w-16 h-16 object-cover rounded-2xl shadow-lg hidden">
                                <!-- Ícone padrão -->
                                <div id="modalProfileIcon" class="w-16 h-16 gradient-forest rounded-2xl flex items-center justify-center shadow-lg">
                                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                    </svg>
                                </div>
                            </div>
                        <div>
                            <h2 class="text-2xl font-bold text-slate-900" id="profileName">Carregando...</h2>
                            <p class="text-slate-600 text-base">Gerente</p>
                            <p class="text-sm text-slate-500" id="profileFarmName">Carregando...</p>
                        </div>
                    </div>
                </div>
                
                <!-- Informações Pessoais -->
                <div class="bg-white rounded-2xl p-4 sm:p-6 border border-gray-200 mt-4">
                    <div class="flex items-center justify-between mb-4">
                        <h4 class="text-lg font-semibold text-gray-900">Informações Pessoais</h4>
                        <button id="editProfileBtn" onclick="toggleProfileEdit()" class="px-4 py-2 text-sm bg-forest-600 hover:bg-forest-700 text-white font-medium rounded-lg transition-all">
                            <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                            </svg>
                            Editar
                        </button>
                    </div>
                    
                    <!-- Modo Visualização -->
                    <div id="profileViewMode" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-800 mb-1">Nome Completo</label>
                            <p class="text-gray-900 font-semibold text-base" id="profileFullName">Carregando...</p>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-800 mb-1">Email</label>
                            <p class="text-gray-900 font-semibold text-base" id="profileEmail2">Carregando...</p>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-800 mb-1">WhatsApp</label>
                            <p class="text-gray-900 font-semibold text-base" id="profileWhatsApp">Carregando...</p>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-800 mb-1">Cargo</label>
                            <p class="text-gray-900 font-semibold text-base">Gerente</p>
                        </div>
                    </div>
                    
                    <!-- Modo Edição -->
                    <div id="profileEditMode" class="hidden">
                        <form id="updateProfileForm" class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-800 mb-2">Nome Completo</label>
                                    <input type="text" id="editProfileName" name="name" class="w-full px-4 py-3 border border-slate-200 rounded-xl focus:border-forest-500 focus:ring-2 focus:ring-forest-100 focus:outline-none bg-white" placeholder="Digite seu nome completo">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-800 mb-2">Email</label>
                                    <input type="email" id="editProfileEmail" name="email" class="w-full px-4 py-3 border border-slate-200 rounded-xl bg-gray-100 text-gray-500" readonly placeholder="Email não pode ser alterado">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-800 mb-2">WhatsApp</label>
                                    <input type="tel" id="editProfileWhatsApp" name="whatsapp" class="w-full px-4 py-3 border border-slate-200 rounded-xl focus:border-forest-500 focus:ring-2 focus:ring-forest-100 focus:outline-none bg-white" placeholder="(00) 00000-0000">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-800 mb-2">Cargo</label>
                                    <input type="text" value="Gerente" class="w-full px-4 py-3 border border-slate-200 rounded-xl bg-gray-100 text-gray-500" readonly>
                                </div>
                            </div>
                            
                            </div>
                            
                            <!-- Seção de Foto de Perfil do Gerente -->
                            <div class="border-t border-gray-200 pt-6 mt-6">
                                <h5 class="text-lg font-semibold text-gray-900 mb-4">Foto de Perfil</h5>
                                <div class="flex flex-col space-y-3">
                                    <div class="flex items-center space-x-3">
                                        <button type="button" onclick="openManagerPhotoModal()" class="px-4 py-2 bg-forest-600 hover:bg-forest-700 text-white font-medium rounded-lg transition-all text-sm">
                                            Mudar Foto
                                        </button>
                                        <button type="button" onclick="removeManagerPhoto()" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white font-medium rounded-lg transition-all text-sm">
                                            Remover Foto
                                        </button>
                                    </div>
                                    <input type="file" id="managerProfilePhotoInput" name="managerProfilePhoto" accept="image/*" class="hidden" onchange="handleManagerGallerySelection(this)">
                                    <p class="text-xs text-gray-500">Formatos: JPG, PNG (máx. 2MB)</p>
                                </div>
                            </div>
                            
                            <div id="profileEditButtons" class="flex justify-end space-x-3 pt-4 hidden">
                                <button type="button" onclick="cancelProfileEdit()" class="px-6 py-3 border border-gray-300 text-gray-700 font-semibold rounded-xl hover:bg-gray-50 transition-all">
                                    Cancelar
                                </button>
                                <button type="submit" class="px-6 py-3 gradient-forest text-white font-semibold rounded-xl hover:shadow-lg transition-all">
                                    <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"></path>
                                    </svg>
                                    Salvar Alterações
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Theme Toggle Section -->
                <div class="bg-white rounded-2xl p-8 border border-gray-200 mx-4 mb-8">
                    <h4 class="text-lg font-semibold text-gray-900 mb-4">Preferências</h4>
                    <div class="flex items-center justify-between">
                        <div>
                            <h5 class="font-medium text-gray-900">Modo Escuro</h5>
                            <p class="text-sm text-gray-600">Alternar entre tema claro e escuro</p>
                        </div>
                        <div class="theme-toggle" onclick="toggleTheme()">
                            <div class="theme-toggle-slider">
                                <svg class="w-4 h-4 text-yellow-500 sun-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>
                                </svg>
                                <svg class="w-4 h-4 text-blue-400 moon-icon hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
                                </svg>
                            </div>
                        </div>
                    </div>
                </div>
                
                
                <!-- Alterar Senha -->
                <div class="bg-white rounded-2xl p-6 border border-gray-200 mx-4 mb-8">
                    <div class="flex items-center justify-between">
                        <div>
                            <h4 class="text-lg font-semibold text-gray-900 mb-2">Segurança da Conta</h4>
                            <p class="text-sm text-gray-600">Altere sua senha para manter sua conta segura</p>
                        </div>
                        <button onclick="window.location.href='alterar-senha.html'" class="px-6 py-3 gradient-forest text-white font-semibold rounded-xl hover:shadow-lg transition-all">
                            <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"></path>
                            </svg>
                            Alterar Senha
                        </button>
                    </div>
                </div>
                
                <!-- Criação de Contas Secundárias -->
                <div class="bg-white rounded-2xl p-4 sm:p-8 border border-gray-200 mx-0 sm:mx-4 mb-8">
                    <div class="flex items-center justify-between mb-4">
                        <h4 class="text-lg font-semibold text-gray-900">Contas Secundárias</h4>
                        <button onclick="toggleSecondaryAccountForm()" class="px-4 py-2 text-sm bg-forest-600 hover:bg-forest-700 text-white font-medium rounded-lg transition-all">
                            <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                            </svg>
                            Nova Conta
                        </button>
                    </div>
                    
                    <p class="text-sm text-gray-600 mb-4">Crie contas de funcionário ou veterinário usando seus dados como base</p>
                    
                    <!-- Lista de Contas Secundárias -->
                    <div id="secondaryAccountsList" class="space-y-3 mb-4 overflow-hidden">
                        <!-- Contas serão carregadas aqui -->
                    </div>
                    
                    <!-- Formulário de Nova Conta -->
                    <div id="secondaryAccountForm" class="hidden border-t border-gray-200 pt-4">
                        <form id="createSecondaryAccountForm" class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-800 mb-2">Tipo de Conta</label>
                                    <select name="account_type" required class="w-full px-4 py-3 border border-slate-200 rounded-xl focus:border-forest-500 focus:ring-2 focus:ring-forest-100 focus:outline-none bg-white" onchange="checkExistingSecondaryAccount(this.value)">
                                        <option value="">Selecione o tipo</option>
                                        <option value="funcionario">Funcionário</option>
                                        <option value="veterinario">Veterinário</option>
                                    </select>
                                    <div id="existingAccountMessage" class="mt-2 text-sm hidden"></div>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-800 mb-2">Email da Nova Conta</label>
                                    <input type="email" name="email" id="secondaryAccountEmail" readonly class="w-full px-4 py-3 border border-slate-200 rounded-xl bg-gray-50 text-gray-600" placeholder="Email será copiado automaticamente">
                                    <p class="text-xs text-gray-500 mt-1">Mesmo email da sua conta principal</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-800 mb-2">Nome Completo</label>
                                    <input type="text" name="name" id="secondaryAccountName" class="w-full px-4 py-3 border border-slate-200 rounded-xl focus:border-forest-500 focus:ring-2 focus:ring-forest-100 focus:outline-none bg-white" placeholder="Nome será copiado automaticamente">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-800 mb-2">WhatsApp</label>
                                    <input type="tel" name="whatsapp" id="secondaryAccountWhatsApp" class="w-full px-4 py-3 border border-slate-200 rounded-xl focus:border-forest-500 focus:ring-2 focus:ring-forest-100 focus:outline-none bg-white" placeholder="WhatsApp será copiado automaticamente">
                                </div>
                            </div>
                            
                            <div class="bg-blue-50 border border-blue-200 rounded-xl p-4">
                                <div class="flex items-start">
                                    <svg class="w-5 h-5 text-blue-600 mt-0.5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    <div>
                                        <h5 class="text-sm font-semibold text-blue-800 mb-1">Contas Secundárias - Para Você Mesmo</h5>
                                        <ul class="text-sm text-blue-700 space-y-1">
                                            <li>• Crie contas para você mesmo (ex: veterinário, funcionário)</li>
                                            <li>• Use o mesmo email da sua conta principal</li>
                                            <li>• Útil para fazendas menores onde você faz múltiplas funções</li>
                                            <li>• Acesso rápido entre diferentes perfis</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="flex justify-end space-x-3">
                                <button type="button" onclick="cancelSecondaryAccountForm()" class="px-6 py-3 border border-gray-300 text-gray-700 font-semibold rounded-xl hover:bg-gray-50 transition-all">
                                    Cancelar
                                </button>
                                <button type="submit" class="px-6 py-3 gradient-forest text-white font-semibold rounded-xl hover:shadow-lg transition-all">
                                    <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                    </svg>
                                    Criar Conta
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <!-- Sair do Sistema -->
                <div class="bg-white rounded-2xl p-4 sm:p-8 border border-red-200 mx-0 sm:mx-4 mb-8">
                    <h4 class="text-lg font-semibold text-red-900 mb-4">Zona de Perigo</h4>
                    <div class="flex items-center justify-between">
                        <div>
                            <h5 class="font-medium text-red-900">Sair do Sistema</h5>
                            <p class="text-sm text-red-600">Encerrar sua sessão atual</p>
                        </div>
                        <button onclick="signOut()" class="px-6 py-3 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-xl transition-all">
                            <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                            </svg>
                            Sair
                        </button>
                    </div>
                </div>
                
                <!-- Modal de Escolha de Foto do Gerente (dentro do modal de perfil) -->
                <div id="managerPhotoChoiceModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[-999999]" style="display: none !important; visibility: hidden !important;">
                    <div class="bg-white rounded-2xl p-6 w-full max-w-md mx-4">
                        <div class="flex items-center justify-between mb-6">
                            <h2 class="text-xl font-bold text-gray-900">Mudar Foto de Perfil</h2>
                            <button onclick="closeManagerPhotoModal()" class="p-2 hover:bg-gray-100 rounded-lg transition-all">
                                <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
            </div>
                        
                        <div>
                            <div class="text-center space-y-6">
                                <div class="w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mx-auto">
                                    <svg class="w-12 h-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                    </svg>
                                </div>
                                
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-900 mb-2">Como você quer adicionar sua foto?</h3>
                                    <p class="text-gray-600">Escolha entre tirar uma foto ou selecionar da galeria</p>
                                </div>
                                
                                <div class="flex flex-col sm:flex-row gap-4 justify-center">
                                    <button onclick="openManagerCamera()" class="flex items-center justify-center space-x-3 px-6 py-4 bg-forest-600 hover:bg-forest-700 text-white font-medium rounded-xl transition-all">
                                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                        </svg>
                                        <span>Tirar Foto</span>
                                    </button>
                                    
                                    <button onclick="selectManagerFromGallery()" class="flex items-center justify-center space-x-3 px-6 py-4 bg-gray-600 hover:bg-gray-700 text-white font-medium rounded-xl transition-all">
                                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                        </svg>
                                        <span>Galeria</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Câmera do Gerente -->
    <div id="managerCameraModal" class="fullscreen-modal" style="display: none;">
        <div class="modal-content bg-black">
            <!-- Header com Logo -->
            <div class="absolute top-0 left-0 right-0 z-30 p-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <img src="https://i.postimg.cc/vmrkgDcB/lactech.png" alt="LacTech" class="w-8 h-8">
                        <span class="text-white font-semibold">LacTech</span>
                    </div>
                    <button onclick="closeManagerCamera()" class="p-2 bg-black/30 backdrop-blur-md rounded-full hover:bg-black/50 transition-all">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Video da Câmera -->
            <video id="managerCameraVideo" class="w-full h-full object-cover" autoplay playsinline></video>
            
            <!-- Overlay de Verificação Facial -->
            <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                <div id="managerFocusCircle" class="relative">
                    <div class="w-80 h-80 border-2 border-white/40 rounded-full flex items-center justify-center animate-pulse">
                        <div class="w-72 h-72 border-2 border-white/60 rounded-full flex items-center justify-center">
                            <div class="w-64 h-64 border-3 border-white/80 rounded-full flex items-center justify-center">
                                <div id="managerFocusIndicator" class="w-56 h-56 border-2 border-green-400 rounded-full flex items-center justify-center opacity-0 transition-opacity duration-500">
                                    <div class="w-48 h-48 border border-green-300 rounded-full"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="absolute -bottom-16 left-1/2 transform -translate-x-1/2 text-center">
                        <div id="managerFocusText" class="text-white text-lg font-medium mb-2">Posicione o rosto no centro</div>
                        <div id="managerFocusTimer" class="text-white/70 text-sm hidden">Focando em <span id="managerTimerCount">3</span>s...</div>
                    </div>
                </div>
            </div>

            <!-- Controles -->
            <div class="absolute bottom-0 left-0 right-0 z-20 p-8">
                <div class="flex items-center justify-center space-x-12">
                    <button onclick="switchManagerCamera()" class="p-4 bg-black/30 backdrop-blur-md rounded-full hover:bg-black/50 transition-all">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                    </button>
                    
                    <button id="managerCaptureBtn" onclick="startManagerFaceVerification()" class="p-6 bg-white rounded-full hover:bg-gray-100 transition-all shadow-2xl transform hover:scale-105">
                        <div class="w-20 h-20 border-4 border-gray-200 rounded-full flex items-center justify-center">
                            <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center">
                                <svg class="w-8 h-8 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                </svg>
                            </div>
                        </div>
                    </button>
                    
                    <button onclick="closeManagerCamera()" class="p-4 bg-black/30 backdrop-blur-md rounded-full hover:bg-black/50 transition-all">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Canvas para Captura -->
            <canvas id="managerCameraCanvas" class="hidden"></canvas>
            
            <!-- Tela de Carregamento -->
            <div id="managerPhotoProcessingScreen" class="absolute inset-0 bg-black bg-opacity-90 flex items-center justify-center z-30 hidden">
                <div class="text-center text-white">
                    <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-white mx-auto mb-4"></div>
                    <h3 class="text-xl font-semibold mb-2">Processando foto...</h3>
                    <p class="text-white/70">Aguarde enquanto processamos sua imagem</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Toast -->
    <div id="notificationToast" class="notification-toast">
        <div class="bg-white    rounded-lg shadow-lg border border-gray-200    p-4 max-w-sm">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <svg class="w-5 h-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </div>
                <div class="ml-3">
                    <p class="text-sm font-medium text-gray-900   " id="toastMessage">Sucesso!</p>
                </div>
                <div class="ml-auto pl-3">
                    <button onclick="hideNotification()" class="text-gray-400 hover:text-gray-600   :text-gray-300">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>


    <script>
    // Função para verificar autenticação
    async function checkAuthentication() {
        try {
            // Verificando autenticação
            
            // Aguardar Supabase estar disponível
            let attempts = 0;
            while (!window.supabase) {
                await new Promise(resolve => setTimeout(resolve, 500));
                attempts++;
                if (attempts > 20) {
                    console.error('❌ Supabase não disponível após 10 segundos');
                    return false;
                }
            }
            
            const supabase = await getSupabaseClient();
            
            // Verificar autenticação do Supabase
            const { data: { user }, error: authError } = await supabase.auth.getUser();
            if (authError || !user) {
                // Usuário não autenticado no Supabase
                // Limpar dados de sessão locais
                clearUserSession();
                
                showNotification('Sessão expirada. Redirecionando para login...', 'error');
                setTimeout(() => {
                    safeRedirect('login.html');
                }, 2000);
                return false;
            }
            
            // Verificar se o usuário existe na tabela users
            const { data: userData, error: userError } = await supabase
                .from('users')
                .select('*')
                .eq('id', user.id)
                .single();
                
            if (userError || !userData) {
                // Usuário não encontrado na tabela users
                // Limpar dados de sessão locais
                clearUserSession();
                
                showNotification('Usuário não encontrado. Redirecionando para login...', 'error');
                setTimeout(() => {
                    safeRedirect('login.html');
                }, 2000);
                return false;
            }
            
            // Verificar se o usuário está ativo
            if (!userData.is_active) {
                // Usuário bloqueado
                showNotification('Conta bloqueada. Redirecionando...', 'error');
                setTimeout(() => {
                    safeRedirect('acesso-bloqueado.html');
                }, 2000);
                return false;
            }
            
            // Autenticação verificada com sucesso
            return true;
            
        } catch (error) {
            console.error('❌ Erro na verificação de autenticação:', error);
            // Em caso de erro, limpar dados e redirecionar
            clearUserSession();
            
            setTimeout(() => {
                safeRedirect('login.html');
            }, 2000);
            return false;
        }
    }
    
    // Função para limpar completamente a sessão
function clearUserSession() {
    // Limpando sessão do usuário
    
    // Limpar atualizações em tempo real
    cleanupRealtimeUpdates();
    
    // Limpar localStorage
    localStorage.removeItem('userData');
    localStorage.removeItem('userSession');
    localStorage.removeItem('farmData');
    localStorage.removeItem('setupCompleted');
    
    // Limpar sessionStorage
    sessionStorage.removeItem('userData');
    sessionStorage.removeItem('userSession');
    sessionStorage.removeItem('farmData');
    sessionStorage.removeItem('setupCompleted');
    sessionStorage.removeItem('redirectCount');
    
    // Limpar cookies relacionados
    document.cookie.split(";").forEach(function(c) { 
        document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/"); 
    });
    
    // Sessão limpa com sucesso
}

// Função para gerenciar redirecionamentos
function safeRedirect(url) {
    const currentCount = parseInt(sessionStorage.getItem('redirectCount') || '0');
    sessionStorage.setItem('redirectCount', (currentCount + 1).toString());
    
    // Redirecionando para página
    window.location.replace(url);
    }
    
    // Função para monitorar bloqueio de usuário
    function startBlockWatcher(interval = 15000) {
        setInterval(async () => {
            try {
                if (!window.supabase) return;
                
            const supabase = await getSupabaseClient();
                const { data: { user } } = await supabase.auth.getUser();
                
            if (!user) {
                // Usuário não autenticado no watcher
                clearUserSession();
                safeRedirect('login.html');
                return;
            }
                
                const { data: userData, error } = await supabase
                    .from('users')
                    .select('is_active')
                    .eq('id', user.id)
                    .single();
                    
                if (!error && userData && !userData.is_active) {
                // Usuário bloqueado detectado
                clearUserSession();
                safeRedirect('acesso-bloqueado.html');
                }
            } catch (error) {
            console.error('❌ Erro no block watcher:', error);
            // Em caso de erro persistente, limpar sessão
            clearUserSession();
            safeRedirect('login.html');
            }
        }, interval);
    }
    
    document.addEventListener('DOMContentLoaded', async function() {
        // Flag para evitar múltiplas inicializações
        if (window.pageInitialized) {
            // Página já inicializada, ignorando
            return;
        }
        
        window.pageInitialized = true;
        // Inicializando página do gerente
        
        // Verificar se há dados de sessão válidos
        const userData = localStorage.getItem('userData') || sessionStorage.getItem('userData');
        if (!userData) {
            // Nenhum dado de sessão encontrado
            safeRedirect('login.html');
            return;
        }
        
        // Verificar se não estamos em um loop de redirecionamento
        const redirectCount = sessionStorage.getItem('redirectCount') || 0;
        if (redirectCount > 3) {
            // Muitas tentativas de redirecionamento, limpando sessão
            clearUserSession();
            sessionStorage.removeItem('redirectCount');
            safeRedirect('login.html');
            return;
        }
        
        try {
            // Verificar se os dados são válidos
            const parsedUserData = JSON.parse(userData);
            if (!parsedUserData || !parsedUserData.id) {
                // Dados de sessão inválidos
                clearUserSession();
                safeRedirect('login.html');
                return;
            }
        } catch (error) {
            // Erro ao parsear dados de sessão
            clearUserSession();
            safeRedirect('login.html');
            return;
        }
        
        // Check authentication first
        const isAuthenticated = await checkAuthentication();
        if (!isAuthenticated) {
            // Falha na autenticação
            return; // Stop execution if not authenticated
        }
        
        // Autenticação aprovada, inicializando componentes
        
        initializeTheme(); // Initialize theme first
        initializeCharts(); // Initialize charts before loading data
        await initializePage();
        setupEventListeners();
        
        // Carregar foto do header
        await loadHeaderPhoto();
        
        // Garantir que o modal de foto esteja fechado na inicialização
        const photoModal = document.getElementById('photoChoiceModal');
        if (photoModal) {
            photoModal.classList.remove('show');
            photoModal.classList.add('hidden');
            photoModal.classList.remove('flex');
            photoModal.style.display = 'none';
            photoModal.style.visibility = 'hidden';
            photoModal.style.opacity = '0';
            photoModal.style.pointerEvents = 'none';
        }
        
        // Garantir que as telas de processamento estejam ocultas
        const photoProcessingScreen = document.getElementById('photoProcessingScreen');
        if (photoProcessingScreen) {
            photoProcessingScreen.classList.add('hidden');
            photoProcessingScreen.style.display = 'none';
            photoProcessingScreen.style.visibility = 'hidden';
            photoProcessingScreen.style.opacity = '0';
            photoProcessingScreen.style.pointerEvents = 'none';
            console.log('✅ Tela de processamento de foto ocultada na inicialização');
        }
        
        const managerPhotoProcessingScreen = document.getElementById('managerPhotoProcessingScreen');
        if (managerPhotoProcessingScreen) {
            managerPhotoProcessingScreen.classList.add('hidden');
            managerPhotoProcessingScreen.style.display = 'none';
            managerPhotoProcessingScreen.style.visibility = 'hidden';
            managerPhotoProcessingScreen.style.opacity = '0';
            managerPhotoProcessingScreen.style.pointerEvents = 'none';
            console.log('✅ Tela de processamento de foto do gerente ocultada na inicialização');
        }
        
        updateDateTime();
        setInterval(updateDateTime, 60000); // Update every minute
        // Iniciar verificação de bloqueio durante a sessão
        startBlockWatcher(15000);
        
        console.log('✅ Página do gerente inicializada com sucesso');
    });
    
    // Função para limpar todos os event listeners (útil para debugging)
    window.clearAllEventListeners = function() {
        console.log('🧹 Limpando todos os event listeners...');
        
        // Limpar listeners de formulários
        const forms = [
            'addUserFormModal', 
            'updateProfileForm',
            'editUserForm',
            'createSecondaryAccountForm'
        ];
        
        forms.forEach(formId => {
            const form = document.getElementById(formId);
            if (form) {
                const newForm = form.cloneNode(true);
                form.parentNode.replaceChild(newForm, form);
                console.log(`✅ Listener removido do formulário: ${formId}`);
            }
        });
        
        console.log('✅ Todos os event listeners foram limpos');
    };

/**
 * Inicializa a página do gerente
 * Carrega dados do dashboard, volume, qualidade, pagamentos e usuários
 * Configura autenticação e verifica status do usuário
 */
// Inicializar Supabase uma única vez
if (!window.supabaseClient) {
    window.supabaseClient = null;
}

async function getSupabaseClient() {
    if (window.supabaseClient) {
        return window.supabaseClient;
    }
    
    // Aguardar Supabase estar disponível
    let attempts = 0;
    while (!window.supabase) {
        await new Promise(resolve => setTimeout(resolve, 500));
        attempts++;
        if (attempts > 20) {
            console.error('❌ Supabase não disponível após 10 segundos');
            throw new Error('Supabase não disponível');
        }
    }
    
    // Criar cliente uma única vez
    window.supabaseClient = window.supabase.createClient(
        'https://tmaamwuyucaspqcrhuck.supabase.co',
        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRtYWFtd3V5dWNhc3BxY3JodWNrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY2OTY1MzMsImV4cCI6MjA3MjI3MjUzM30.AdDXp0xrX_xKutFHQrJ47LhFdLTtanTSku7fcK1eTB0'
    );
    
    return window.supabaseClient;
    
    window.supabaseClient = window.supabase.createClient(
        'https://tmaamwuyucaspqcrhuck.supabase.co',
        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRtYWFtd3V5dWNhc3BxY3JodWNrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY2OTY1MzMsImV4cCI6MjA3MjI3MjUzM30.AdDXp0xrX_xKutFHQrJ47LhFdLTtanTSku7fcK1eTB0'
    );
    
    return window.supabaseClient;
}

async function initializePage() {
    try {
        const supabase = await getSupabaseClient();

        
        // Verify Supabase authentication
        const { data: { user }, error: authError } = await supabase.auth.getUser();
        if (authError || !user) {
            console.error('Supabase authentication failed:', authError);
            showNotification('Erro de autenticação. Redirecionando para login...', 'error');
            setTimeout(() => {
                window.location.href = 'login.html';
            }, 2000);
            return;
        }
        

        
        // Check if user is active
        const { data: userData, error: userError } = await supabase
            .from('users')
            .select('is_active')
            .eq('id', user.id)
            .single();
            
        if (userError) {
            console.error('Error checking user status:', userError);
        } else if (!userData.is_active) {
    
            window.location.href = 'acesso-bloqueado.html';
            return;
        }
        
        // Execute each function independently to avoid blocking
        try {
            await setFarmName();
        } catch (error) {
            console.error('Error setting farm name:', error);
        }
        
        try {
            await setManagerName();
        } catch (error) {
            console.error('Error setting manager name:', error);
        }
        

        
        try {
            await loadUserProfile();
        } catch (error) {
            console.error('Error loading user profile:', error);
        }
        
        try {
            if (typeof loadHeaderProfilePhoto === 'function') {
                await loadHeaderProfilePhoto();
            }
        } catch (error) {
            console.error('Error loading header profile photo:', error);
        }
        
        try {
    
            await loadDashboardData();
        } catch (error) {
            console.error('❌ ERRO ao chamar loadDashboardData:', error);
        }
        
        try {
            await loadVolumeData();
            await loadVolumeRecords();
        } catch (error) {
            console.error('Error loading volume data:', error);
        }
        
        try {
            await loadQualityData();
            await loadQualityTests();
        } catch (error) {
            console.error('Error loading quality data:', error);
        }
        
        try {
            await loadTemperatureChart();
        } catch (error) {
            console.error('Error loading temperature chart:', error);
        }
        
        try {
            await loadPaymentsData();
        } catch (error) {
            console.error('Error loading payments data:', error);
        }
        
        try {
            await loadDashboardVolumeChart();
        } catch (error) {
            console.error('Error loading dashboard volume chart:', error);
        }
        
        try {
            await loadWeeklyVolumeChart();
        } catch (error) {
            console.error('Error loading weekly volume chart:', error);
        }
        
        try {
            await loadDailyVolumeChart();
        } catch (error) {
            console.error('Error loading daily volume chart:', error);
        }
        
        try {
            await loadDashboardWeeklyChart();
        } catch (error) {
            console.error('Error loading dashboard weekly chart:', error);
        }
        
        try {
            // Get user's farm_id for recent activities
            const { data: { user } } = await supabase.auth.getUser();
            if (user) {
                const { data: usersData } = await supabase
                    .from('users')
                    .select('farm_id')
                    .eq('id', user.id)
                    .order('created_at', { ascending: true }); // Sempre usar conta primária
                
                const userData = usersData?.[0]; // Primeira conta = primária
                
                if (userData?.farm_id) {
                    await loadRecentActivities(userData.farm_id);
                }
            }
        } catch (error) {
            console.error('Error loading recent activities:', error);
        }
        
        try {
            await loadUsersData();
        } catch (error) {
            console.error('Error loading users data:', error);
        }
        
        // Configurar atualizações em tempo real
        try {
            setupRealtimeUpdates();
        } catch (error) {
            console.error('Error setting up realtime updates:', error);
        }
    } catch (error) {
        console.error('Error initializing page:', error);
        // Show user-friendly message
        showNotification('Algumas informações não puderam ser carregadas. Verifique sua conexão.', 'warning');
    }
}
// Function to create user if not exists using RPC functions
async function createUserIfNotExists(authUser) {
    try {

        
        // First check if user already exists
        const { data: existingUser, error: userCheckError } = await supabase
            .from('users')
            .select('id, farm_id')
            .eq('id', authUser.id)
            .maybeSingle();
        
        if (userCheckError) {
            console.error('Error checking existing user:', userCheckError);
            throw userCheckError;
        }
        
        if (existingUser) {
    
            return;
        }
        
        // Check if farm already exists with the same name
        const farmName = authUser.user_metadata?.farm_name || 'fazenda nascimento';

        
        const { data: existingFarm, error: farmCheckError } = await supabase
            .from('farms')
            .select('id')
            .eq('name', farmName)
            .maybeSingle();
        
        if (farmCheckError) {
            console.error('Error checking existing farm:', farmCheckError);
            throw farmCheckError;
        }
        
        let farmId;
        
        if (existingFarm) {
    
            farmId = existingFarm.id;
        } else {
            // Try to create new farm, but handle duplicate name error
    
            const { data: newFarmId, error: farmError } = await supabase
                .rpc('create_initial_farm', {
                    p_name: farmName,
                    p_owner_name: authUser.user_metadata?.name || authUser.email?.split('@')[0] || 'Proprietário',
                    p_city: authUser.user_metadata?.city || 'Cidade',
                    p_state: authUser.user_metadata?.state || 'MG'
                });
            
            if (farmError) {
                console.error('Error creating farm via RPC:', farmError);
                // If it's a duplicate name error, try to find the existing farm
                if (farmError.code === '23505' || farmError.message?.includes('duplicate') || farmError.message?.includes('already exists')) {
            
                    
                    // Wait a bit and try again
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                    const { data: retryFarm, error: retryError } = await supabase
                        .from('farms')
                        .select('id')
                        .eq('name', farmName)
                        .maybeSingle();
                    
                    if (retryError) {
                        console.error('Error searching for existing farm:', retryError);
                        throw retryError;
                    }
                    
                    if (retryFarm) {
                        farmId = retryFarm.id;
                
                    } else {
                        console.error('Could not find or create farm');
                        throw new Error('Failed to create or find farm');
                    }
                } else {
                    throw farmError;
                }
            } else {
                farmId = newFarmId;
        
            }
        }
        
        if (!farmId) {
            throw new Error('No farm ID available for user creation');
        }
        
        // Create user with the farm_id

        const { data: userResult, error: userError } = await supabase
            .rpc('create_initial_user', {
                p_user_id: authUser.id,
                p_farm_id: farmId,
                p_name: authUser.user_metadata?.name || authUser.email?.split('@')[0] || 'Usuário',
                p_email: authUser.email,
                p_role: authUser.user_metadata?.role || 'funcionario',
                p_whatsapp: authUser.user_metadata?.whatsapp || authUser.user_metadata?.phone || ''
            });
        
        if (userError) {
            console.error('Error creating user via RPC:', userError);
            throw userError;
        } else {
    
        }
    } catch (error) {
        console.error('Error in createUserIfNotExists:', error);
        throw error; // Re-throw the error so it can be handled by the caller
    }
}

// Function to get farm name from session or Supabase
async function getFarmName() {
    try {

        
        // First try to get from local session
        const userData = localStorage.getItem('userData') || sessionStorage.getItem('userData');
        if (userData) {
            try {
                const user = JSON.parse(userData);
                if (user.farm_name) {
            
                    return user.farm_name;
                }
            } catch (error) {
                console.error('Error parsing session data:', error);
            }
        }
        
        // Get current user and their farm
        const supabase = await getSupabaseClient();
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) {
            return 'Minha Fazenda';
        }

        // Get user's farm_id from users table - SEMPRE USAR CONTA PRIMÁRIA
        const { data: userDbData, error: userError } = await supabase
            .from('users')
            .select('farm_id')
            .eq('id', user.id)
            .single();
            
        if (userError) {
            console.warn('Error fetching user data:', userError);
            throw userError;
        }
        
        if (!userDbData?.farm_id) {
            // Fallback to auth metadata
            if (user.user_metadata?.farm_name) {
                return user.user_metadata.farm_name;
            }
            return 'Minha Fazenda';
        }

        // Get farm name from farms table
        const { data: farmData, error: farmError } = await supabase
            .from('farms')
            .select('name')
            .eq('id', userDbData.farm_id)
            .single();
        
        if (farmError || !farmData?.name) {
            return 'Minha Fazenda';
        }
        
        return farmData.name;
        
    } catch (error) {
        console.error('Error fetching farm name:', error);
        return 'Minha Fazenda';
    }
}

// Toggle theme function
function toggleTheme() {
    const html = document.documentElement;
    const body = document.body;
    const isDark = html.classList.contains('dark');
    
    if (isDark) {
        // Mudar para modo claro
        html.classList.remove('dark');
        body.classList.remove('dark');
        localStorage.setItem('theme', 'light');
        showNotification('Modo claro ativado', 'success');
        applyChartTheme();
    } else {
        // Mudar para modo escuro
        html.classList.add('dark');
        body.classList.add('dark');
        localStorage.setItem('theme', 'dark');
        showNotification('Modo escuro ativado', 'success');
        applyChartTheme();
    }
    
    // Garantir que modais permaneçam fechados após mudança de tema
    const managerPhotoChoiceModal = document.getElementById('managerPhotoChoiceModal');
    const managerCameraModal = document.getElementById('managerCameraModal');
    const moreModal = document.getE