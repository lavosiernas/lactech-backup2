<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel do Gerente - Sistema Leiteiro</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Painel do Gerente - Sistema completo para gest√£o de produ√ß√£o leiteira, controle de qualidade e relat√≥rios">
    <meta name="theme-color" content="#166534">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="LacTech Gerente">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="msapplication-TileColor" content="#166534">
    <meta name="msapplication-config" content="/browserconfig.xml">
    
    <!-- PWA Icons -->
    <link rel="icon" href="https://i.postimg.cc/vmrkgDcB/lactech.png" type="image/x-icon">
    <link rel="apple-touch-icon" href="https://i.postimg.cc/vmrkgDcB/lactech.png">
    <link rel="apple-touch-icon" sizes="72x72" href="https://i.postimg.cc/vmrkgDcB/lactech.png">
    <link rel="apple-touch-icon" sizes="96x96" href="https://i.postimg.cc/vmrkgDcB/lactech.png">
    <link rel="apple-touch-icon" sizes="128x128" href="https://i.postimg.cc/vmrkgDcB/lactech.png">
    <link rel="apple-touch-icon" sizes="144x144" href="https://i.postimg.cc/vmrkgDcB/lactech.png">
    <link rel="apple-touch-icon" sizes="152x152" href="https://i.postimg.cc/vmrkgDcB/lactech.png">
    <link rel="apple-touch-icon" sizes="192x192" href="https://i.postimg.cc/vmrkgDcB/lactech.png">
    <link rel="apple-touch-icon" sizes="384x384" href="https://i.postimg.cc/vmrkgDcB/lactech.png">
    <link rel="apple-touch-icon" sizes="512x512" href="https://i.postimg.cc/vmrkgDcB/lactech.png">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="assets/js/console-guard.js"></script>
    <script src="pwa-manager.js"></script>
    <script src="lactech-core.js"></script>
    
    <!-- CSS Files -->
    <link href="assets/css/dark-theme-fixes.css" rel="stylesheet">
    
    <script>
        // Chart.js theme helper to adapt to dark mode
        function getChartTheme(isDark) {
            return {
                gridColor: isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.08)',
                tickColor: isDark ? '#e5e7eb' : '#475569',
                lineBorder: isDark ? '#34d399' : '#369e36',
                lineFill: isDark ? 'rgba(52, 211, 153, 0.15)' : 'rgba(54, 158, 54, 0.1)',
                barColor: isDark ? '#60a5fa' : '#2563eb'
            };
        }

        function applyChartTheme() {
            try {
                const isDark = document.documentElement.classList.contains('dark');
                const t = getChartTheme(isDark);
                const charts = [
                    window.volumeChart,
                    window.dashboardWeeklyChart,
                    window.temperatureChart,
                    window.qualityChart,
                    window.weeklyVolumeChart,
                    window.dailyVolumeChart,
                    window.qualityTrendChart,
                    window.qualityDistributionChart,
                    window.paymentsChart,
                    window.weeklySummaryChart,
                    window.monthlyVolumeChart
                ].filter(Boolean);

                charts.forEach((ch) => {
                    try {
                        if (ch.config.type === 'line') {
                            ch.data.datasets.forEach(ds => {
                                ds.borderColor = t.lineBorder;
                                ds.backgroundColor = t.lineFill;
                            });
                        }
                        if (ch.config.type === 'bar') {
                            ch.data.datasets.forEach(ds => {
                                ds.backgroundColor = t.barColor;
                            });
                        }
                        if (ch.options && ch.options.scales) {
                            Object.values(ch.options.scales).forEach(scale => {
                                if (!scale.grid) scale.grid = {};
                                if (!scale.ticks) scale.ticks = {};
                                scale.grid.color = t.gridColor;
                                scale.ticks.color = t.tickColor;
                            });
                        }
                        if (ch.options && ch.options.plugins && ch.options.plugins.legend && ch.options.plugins.legend.labels) {
                            ch.options.plugins.legend.labels.color = t.tickColor;
                        }
                        ch.update('none');
                    } catch (_) {}
                });
            } catch (_) {}
        }
    </script>
    
    <!-- Estilos personalizados para anima√ß√µes premium da se√ß√£o de relat√≥rios -->
    <style>
        /* Anima√ß√µes customizadas */
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-6px); }
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        .animate-float {
            animation: float 4s ease-in-out infinite;
        }
        
        /* Efeito shimmer nos bot√µes */
        .btn-shimmer {
            position: relative;
            overflow: hidden;
        }
        
        .btn-shimmer::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                90deg,
                transparent,
                rgba(255, 255, 255, 0.4),
                transparent
            );
            transition: left 0.6s ease-in-out;
        }
        
        .btn-shimmer:hover::before {
            left: 100%;
        }
        
        /* Efeito de vidro melhorado */
        .glass-effect {
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }
        
        /* Sombras coloridas personalizadas */
        .shadow-red-glow {
            box-shadow: 0 10px 40px rgba(239, 68, 68, 0.3);
        }
        
        .shadow-green-glow {
            box-shadow: 0 10px 40px rgba(34, 197, 94, 0.3);
        }
        
        .shadow-purple-glow {
            box-shadow: 0 10px 40px rgba(147, 51, 234, 0.3);
        }
        
        /* Efeito de part√≠culas flutuantes */
        .floating-particles::before,
        .floating-particles::after {
            content: '';
            position: absolute;
            width: 4px;
            height: 4px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            animation: float 3s ease-in-out infinite;
        }
        
        .floating-particles::before {
            top: 20%;
            right: 15%;
            animation-delay: -1s;
        }
        
        .floating-particles::after {
            bottom: 25%;
            left: 10%;
            animation-delay: -2s;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Non-blocking alert shim routed to showNotification when available
        (function(){
            var nativeAlert = window.alert;
            window.alert = function(message){
                try {
                    var msg = String(message);
                    if (typeof showNotification === 'function') {
                        showNotification(msg, 'warning');
                        return;
                    }
                    if (console && console.warn) console.warn('ALERT:', msg);
                    var host = (window.location && window.location.hostname) || '';
                    if (host === 'localhost' || host === '127.0.0.1' || host === '::1') {
                        nativeAlert(msg);
                    }
                } catch(_){}
            };
        })();
    </script>
    <script>
        // Aguardar configura√ß√£o do Supabase antes de carregar fix_data_sync_complete.js
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(function() {
                const script = document.createElement('script');
                script.src = 'fix_data_sync_complete.js';
                document.head.appendChild(script);
            }, 1000);
        });
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="assets/js/pdf-generator.js"></script>
    <link rel="icon" href="https://i.postimg.cc/vmrkgDcB/lactech.png" type="image/x-icon">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="assets/css/style.css">
    <style>
        /* Anima√ß√µes para o modal */ 
        #photoChoiceModal.show #modalContent { 
            transform: scale(1); 
            opacity: 1; 
        } 
        
        /* Efeito de foco nos bot√µes */ 
        button:focus { 
            outline: none; 
        } 
        
        /* Classes Tailwind para focus-visible */ 
        .focus-visible:focus { 
            --tw-ring-offset-shadow: var(--tw-ring-inset) 0 0 0 var(--tw-ring-offset-width) var(--tw-ring-offset-color); 
            --tw-ring-shadow: var(--tw-ring-inset) 0 0 0 calc(2px + var(--tw-ring-offset-width)) var(--tw-ring-color); 
            box-shadow: var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow, 0 0 #0000); 
            --tw-ring-color: rgba(134, 209, 134, 0.5); 
            --tw-ring-offset-width: 2px; 
        } 
        
        /* Classe para background do √≠cone */ 
        .bg-forest-100 { 
            background-color: #f0f9f0; 
        } 
        
        /* Defini√ß√£o de cores personalizadas para o ring */
        :root {
            --forest-300: #86d186;
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'forest': {
                            50: '#f0f9f0', 100: '#dcf2dc', 200: '#bce5bc', 300: '#8dd18d',
                            400: '#5bb85b', 500: '#369e36', 600: '#2a7f2a', 700: '#236523',
                            800: '#1f511f', 900: '#1a431a',
                        }
                    }
                }
            }
        }
    </script>
    
        <!-- CORRE√á√ÉO AUTOM√ÅTICA DO MODAL -->
    <script>
        // Script para corrigir modal que abre automaticamente
        (function() {
            'use strict';
            
            console.log('üö® PROTE√á√ÉO ULTRA AGRESSIVA ATIVADA');
            
            // Fun√ß√£o para destruir completamente os modais
            function destroyModals() {
                // Destruir modal de exclus√£o
                const deleteModal = document.getElementById('deleteUserModal');
                if (deleteModal) {
                    deleteModal.remove();
                    console.log('üí• Modal de exclus√£o destru√≠do');
                }
                
                // Destruir modal de escolha de foto
                const photoModal = document.getElementById('photoChoiceModal');
                if (photoModal) {
                    photoModal.remove();
                    console.log('üí• Modal de foto destru√≠do');
                }
                
                // Limpar vari√°veis
                if (typeof userToDelete !== 'undefined') {
                    userToDelete = null;
                }
                
                // Remover backdrop do body
                document.body.style.overflow = 'auto';
                document.body.style.position = 'static';
                document.body.style.pointerEvents = 'auto';
            }
            
            // Executar imediatamente
            destroyModals();
            
            // Prote√ß√£o cont√≠nua - destruir modais a cada 100ms
            setInterval(destroyModals, 100);
            
            // Substituir completamente a fun√ß√£o deleteUser
            window.deleteUser = function(userId, userName) {
                console.log('üö´ Fun√ß√£o deleteUser completamente bloqueada');
                return false;
            };
            
            // Substituir fun√ß√µes de modal de foto
            window.closePhotoChoiceModal = function() {
                console.log('üö´ Fun√ß√£o closePhotoChoiceModal bloqueada');
                const photoModal = document.getElementById('photoChoiceModal');
                if (photoModal) {
                    photoModal.remove();
                }
            };
            
            window.choosePhotoSource = function(source) {
                console.log('üö´ Fun√ß√£o choosePhotoSource bloqueada');
                const photoModal = document.getElementById('photoChoiceModal');
                if (photoModal) {
                    photoModal.remove();
                }
            };
            
            // Interceptar todas as tentativas de criar modais
            const originalCreateElement = document.createElement;
            document.createElement = function(tagName) {
                const element = originalCreateElement.call(this, tagName);
                if (element.id === 'deleteUserModal' || element.id === 'photoChoiceModal') {
                    console.log('üö´ Tentativa de criar modal bloqueada:', element.id);
                    return originalCreateElement.call(this, 'div');
                }
                return element;
            };
            
            console.log('üõ°Ô∏è Todos os modais completamente bloqueados e destru√≠dos');
            
        })();
    </script>
</head>
<body class="gradient-mesh antialiased transition-colors duration-300" id="mainBody">

    <!-- Header -->
    <header class="gradient-forest shadow-xl sticky top-0 z-40 border-b border-forest-800">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-white rounded-xl flex items-center justify-center shadow-lg">
                        <svg class="w-6 h-6 text-forest-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-lg font-bold text-white tracking-tight">PAINEL DO GERENTE</h1>
                        <p class="text-xs text-forest-200" id="farmNameHeader">Carregando...</p>
                    </div>
                </div>

                <!-- Desktop Navigation -->
                <nav class="hidden md:flex space-x-1">
                    <button class="nav-item active relative px-3 py-2 text-sm font-semibold text-white hover:text-forest-200 transition-all rounded-lg" data-tab="dashboard">
                        Dashboard
                    </button>
                    <button class="nav-item relative px-3 py-2 text-sm font-semibold text-white hover:text-forest-200 transition-all rounded-lg" data-tab="volume">
                        Volume
                    </button>
                    <button class="nav-item relative px-3 py-2 text-sm font-semibold text-white hover:text-forest-200 transition-all rounded-lg" data-tab="quality">
                        Qualidade
                    </button>
                    <button class="nav-item relative px-3 py-2 text-sm font-semibold text-white hover:text-forest-200 transition-all rounded-lg" data-tab="payments">
                        Financeiro
                    </button>
                    <button class="nav-item relative px-3 py-2 text-sm font-semibold text-white hover:text-forest-200 transition-all rounded-lg" data-tab="users">
                        Usu√°rios
                    </button>
                    <button class="nav-item relative px-3 py-2 text-sm font-semibold text-white hover:text-forest-200 transition-all rounded-lg" data-tab="reports">
                        Relat√≥rios
                    </button>
                </nav>

                <div class="flex items-center space-x-4">
                    <button onclick="openProfileModal()" class="flex items-center space-x-3 text-white hover:text-forest-200 p-2 rounded-lg transition-all">
                        <div class="relative w-8 h-8">
                            <!-- Foto do usu√°rio -->
                            <img id="headerProfilePhoto" src="" alt="Foto de Perfil" class="w-8 h-8 object-cover rounded-full hidden">
                            <!-- √çcone padr√£o -->
                            <div id="headerProfileIcon" class="w-8 h-8 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                </svg>
                            </div>
                        </div>
                        <div class="text-left hidden sm:block">
                            <div class="text-sm font-semibold" id="managerName">Carregando...</div>
                            <div class="text-xs text-forest-200">Gerente</div>
                        </div>
                    </button>
                </div>
            </div>
        </div>
    </header>
    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-3 sm:px-4 lg:px-6 xl:px-8 py-6 sm:py-8 pb-20 sm:pb-24 md:pb-4">
        
        <!-- Dashboard Tab -->
        <div id="dashboard-tab" class="tab-content">
            <!-- Welcome Section -->
            <div class="gradient-forest rounded-2xl p-6 mb-6 text-white shadow-xl relative overflow-hidden">
                <div class="relative z-10">
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="text-2xl font-bold mb-2">Bem-vindo, <span id="managerWelcome">Carregando...</span>!</h2>
                            <p class="text-forest-200 text-base font-medium mb-3">Painel de controle gerencial</p>
                            <div class="flex items-center space-x-4">
                                <div class="text-xs font-medium">√öltima atualiza√ß√£o: <span id="lastUpdate">Agora</span></div>
                            </div>
                        </div>
                        <div class="hidden sm:block">
                            <div class="w-16 h-16 bg-white bg-opacity-20 rounded-2xl flex items-center justify-center backdrop-blur-sm">
                                <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
                                </svg>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Key Metrics -->
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="metric-card rounded-2xl p-4 text-center">
                    <div class="w-12 h-12 bg-blue-500 rounded-xl flex items-center justify-center mx-auto mb-3 shadow-lg">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path>
                        </svg>
                    </div>
                    <div class="text-xl font-bold text-slate-900 mb-1" id="todayVolume">-- L</div>
                    <div class="text-xs text-slate-500 font-medium">Volume Hoje</div>
                    <div class="text-xs text-slate-600 font-semibold mt-1">Litros</div>
                </div>
                
                <div class="metric-card rounded-2xl p-4 text-center">
                    <div class="w-12 h-12 bg-green-500 rounded-xl flex items-center justify-center mx-auto mb-3 shadow-lg">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <div class="text-xl font-bold text-slate-900 mb-1" id="qualityAverage">--%</div>
                    <div class="text-xs text-slate-500 font-medium">Qualidade M√©dia</div>
                    <div class="text-xs text-slate-600 font-semibold mt-1">Hoje</div>
                </div>
                
                <div class="metric-card rounded-2xl p-4 text-center">
                    <div class="w-12 h-12 bg-purple-500 rounded-xl flex items-center justify-center mx-auto mb-3 shadow-lg">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                        </svg>
                    </div>
                    <div class="text-xl font-bold text-slate-900 mb-1" id="pendingPayments">R$ --</div>
                    <div class="text-xs text-slate-500 font-medium">Pagamentos Pendentes</div>
                    <div class="text-xs text-slate-600 font-semibold mt-1">Este M√™s</div>
                </div>
                
                <div class="metric-card rounded-2xl p-4 text-center">
                    <div class="w-12 h-12 bg-orange-500 rounded-xl flex items-center justify-center mx-auto mb-3 shadow-lg">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                        </svg>
                    </div>
                    <div class="text-xl font-bold text-slate-900 mb-1" id="activeUsers">--</div>
                    <div class="text-xs text-slate-500 font-medium">Usu√°rios Ativos</div>
                    <div class="text-xs text-slate-600 font-semibold mt-1">Sistema</div>
                </div>
            </div>

            <!-- Charts Section -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <!-- Volume Chart -->
                <div class="data-card rounded-2xl p-6">
                    <h3 class="text-lg font-bold text-slate-900 mb-4">Volume Semanal</h3>
                    <div class="chart-container">
                        <canvas id="volumeChart"></canvas>
                    </div>
                </div>

                <!-- Weekly Production Chart -->
                <div class="data-card rounded-2xl p-6">
                    <h3 class="text-lg font-bold text-slate-900 mb-4">Produ√ß√£o dos √öltimos 7 Dias</h3>
                    <div class="chart-container">
                        <canvas id="dashboardWeeklyChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Temperature Chart Section -->
            <div class="grid grid-cols-1 gap-6 mb-6">
                <div class="data-card rounded-2xl p-6">
                    <h3 class="text-lg font-bold text-slate-900 mb-4">Controle de Temperatura</h3>
                    <div class="chart-container">
                        <canvas id="temperatureChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Recent Activities -->
            <div class="data-card rounded-2xl p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-bold text-slate-900">Atividades Recentes</h3>
                    <button onclick="showTab('volume')" class="text-forest-600 hover:text-forest-700 font-semibold text-sm">Ver Tudo</button>
                </div>
                <div class="space-y-3" id="recentActivities">
                    <div class="text-center py-8">
                        <div class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <p class="text-gray-500 text-sm">Nenhuma atividade recente</p>
                        <p class="text-gray-400 text-xs">Registros aparecer√£o aqui</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Volume Tab -->
        <div id="volume-tab" class="tab-content hidden">
            <div class="space-y-6">
                <!-- Volume Header -->
                <div class="data-card rounded-2xl p-6">
                    <div class="flex flex-col sm:flex-row sm:items-center justify-between mb-6 gap-4">
                        <div>
                            <h2 class="text-xl md:text-2xl font-bold text-slate-900 mb-1">Controle de Volume</h2>
            <p class="text-slate-600 text-sm">Monitore a produ√ß√£o de leite em tempo real</p>
                        </div>
                        <div class="flex flex-col sm:flex-row gap-3 w-full sm:w-auto">
                            <select id="volumePeriod" class="px-4 py-2 border border-slate-200 rounded-lg text-sm focus:border-forest-500 focus:outline-none bg-white">
                                <option value="today">Hoje</option>
                                <option value="week">Esta Semana</option>
                                <option value="month">Este M√™s</option>
                            </select>
                            <button onclick="exportVolumeReport()" class="px-4 py-2 bg-forest-600 text-white rounded-lg hover:shadow-lg transition-all font-semibold text-sm">
                                <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 10v6m0 0l-4-4m4 4l4-4m3 8H5a2 2 0 01-2-2V7a2 2 0 012-2h4l2 2h4a2 2 0 012 2v1"></path>
                                </svg>
                                Exportar
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Volume Metrics -->
                <div class="grid grid-cols-2 gap-4">
                    <div class="metric-card rounded-2xl p-4 text-center">
                        <div class="w-12 h-12 bg-blue-500 rounded-xl flex items-center justify-center mx-auto mb-3 shadow-lg">
                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path>
                            </svg>
                        </div>
                        <div class="text-xl font-bold text-slate-900 mb-1" id="volumeToday">-- L</div>
                    <div class="text-xs text-slate-500 font-medium">Hoje</div>
                    <div class="text-xs text-slate-600 font-semibold mt-1">Total</div>
                    </div>
                    
                    <div class="metric-card rounded-2xl p-4 text-center">
                        <div class="w-12 h-12 bg-green-500 rounded-xl flex items-center justify-center mx-auto mb-3 shadow-lg">
                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                            </svg>
                        </div>
                        <div class="text-xl font-bold text-slate-900 mb-1" id="volumeWeekAvg">-- L</div>
                    <div class="text-xs text-slate-500 font-medium">M√©dia Semanal</div>
                    <div class="text-xs text-slate-600 font-semibold mt-1">Por Dia</div>
                    </div>
                    
                    <div class="metric-card rounded-2xl p-4 text-center">
                        <div class="w-12 h-12 bg-purple-500 rounded-xl flex items-center justify-center mx-auto mb-3 shadow-lg">
                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                            </svg>
                        </div>
                        <div class="text-xl font-bold text-slate-900 mb-1" id="volumeGrowth">+0%</div>
                    <div class="text-xs text-slate-500 font-medium">Crescimento</div>
                    <div class="text-xs text-slate-600 font-semibold mt-1">vs. Semana Anterior</div>
                    </div>
                    
                    <div class="metric-card rounded-2xl p-4 text-center">
                        <div class="w-12 h-12 bg-orange-500 rounded-xl flex items-center justify-center mx-auto mb-3 shadow-lg">
                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <div class="text-lg font-bold text-slate-900 mb-1" id="lastCollection">--/--/---- - --:--</div>
                    <div class="text-xs text-slate-500 font-medium">√öltima Coleta</div>
                    <div class="text-xs text-slate-600 font-semibold mt-1">Data e Hora</div>
                    </div>
                </div>

                <!-- Volume Charts -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Daily Production Chart -->
                    <div class="data-card rounded-2xl p-6">
                        <h3 class="text-lg font-bold text-slate-900 mb-4">Produ√ß√£o Di√°ria</h3>
                        <div class="chart-container">
                            <canvas id="dailyVolumeChart"></canvas>
                        </div>
                    </div>

                    <!-- Weekly Production Chart -->
                    <div class="data-card rounded-2xl p-6">
                        <h3 class="text-lg font-bold text-slate-900 mb-4">Produ√ß√£o Semanal</h3>
                        <div class="chart-container">
                            <canvas id="weeklyVolumeChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Weekly Summary Chart (only visible on Sundays) -->
                <div id="weeklySummaryChartContainer" class="data-card rounded-2xl p-6" style="display: none;">
                    <h3 class="text-lg font-bold text-slate-900 mb-4">Resumo Semanal</h3>
                    <div class="chart-container">
                        <canvas id="weeklySummaryChart"></canvas>
                    </div>
                </div>

                <!-- Monthly Volume Chart (only visible on last day of month) -->
                <div id="monthlyVolumeChartContainer" class="data-card rounded-2xl p-6" style="display: none;">
                    <h3 class="text-lg font-bold text-slate-900 mb-4">Produ√ß√£o Mensal</h3>
                    <div class="chart-container">
                        <canvas id="monthlyVolumeChart"></canvas>
                    </div>
                </div>

                <!-- Volume Records -->
                <div class="data-card rounded-2xl p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-bold text-slate-900">Registros de Volume</h3>
                        <button onclick="addVolumeRecord()" class="px-4 py-2 bg-forest-600 text-white rounded-lg hover:shadow-lg transition-all font-semibold text-sm">
                            <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                            </svg>
                            Novo Registro
                        </button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="border-b border-gray-200">
                                    <th class="text-left py-3 px-4 font-semibold text-slate-900">Data/Hora</th>
                                    <th class="text-left py-3 px-4 font-semibold text-slate-900">Volume (L)</th>
                                    <th class="text-left py-3 px-4 font-semibold text-slate-900">Funcion√°rio</th>
                                    <th class="text-left py-3 px-4 font-semibold text-slate-900">Observa√ß√µes</th>
                                    <th class="text-left py-3 px-4 font-semibold text-slate-900">A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="volumeRecords">
                                <tr>
                                    <td colspan="5" class="text-center py-8 text-gray-500">
                                        Nenhum registro encontrado
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quality Tab -->
        <div id="quality-tab" class="tab-content hidden">
            <div class="space-y-6">
                <!-- Quality Header -->
                <div class="data-card rounded-2xl p-6">
                    <div class="flex flex-col sm:flex-row sm:items-center justify-between mb-6 gap-4">
                        <div>
                            <h2 class="text-xl md:text-2xl font-bold text-slate-900 mb-1">Controle de Qualidade</h2>
            <p class="text-slate-600 text-sm">Monitore os par√¢metros de qualidade do leite</p>
                        </div>
                        <div class="flex flex-col sm:flex-row gap-3 w-full sm:w-auto">
                            <select id="qualityPeriod" class="px-4 py-2 border border-slate-200 rounded-lg text-sm focus:border-forest-500 focus:outline-none bg-white">
                                <option value="today">Hoje</option>
                                <option value="week">Esta Semana</option>
                                <option value="month">Este M√™s</option>
                            </select>
                            <button onclick="exportQualityReport()" class="px-4 py-2 bg-forest-600 text-white rounded-lg hover:shadow-lg transition-all font-semibold text-sm">
                                <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                Relat√≥rio
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Quality Indicators -->
                <div class="grid grid-cols-2 gap-4">
                    <div class="data-card rounded-2xl p-4">
                        <div class="flex items-center justify-between mb-3">
                            <h4 class="font-semibold text-slate-900">Gordura</h4>
                            <span class="text-lg font-bold text-slate-900" id="fatContent">-</span>
                        </div>
                        <div class="quality-indicator">
                            <div class="quality-bar" id="fatQualityBar" style="width: 0%"></div>
                        </div>
                        <p class="text-xs text-slate-500 mt-2" id="fatQualityText">-</p>
                    </div>

                    <div class="data-card rounded-2xl p-4">
                        <div class="flex items-center justify-between mb-3">
                            <h4 class="font-semibold text-slate-900">Prote√≠na</h4>
                            <span class="text-lg font-bold text-slate-900" id="proteinContent">-</span>
                        </div>
                        <div class="quality-indicator">
                            <div class="quality-bar" id="proteinQualityBar" style="width: 0%"></div>
                        </div>
                        <p class="text-xs text-slate-500 mt-2" id="proteinQualityText">-</p>
                    </div>

                    <div class="data-card rounded-2xl p-4">
                        <div class="flex items-center justify-between mb-3">
                            <h4 class="font-semibold text-slate-900">CCS</h4>
                            <span class="text-lg font-bold text-slate-900" id="sccCount">-</span>
                        </div>
                        <div class="quality-indicator">
                            <div class="quality-bar" id="sccQualityBar" style="width: 0%"></div>
                        </div>
                        <p class="text-xs text-slate-500 mt-2" id="sccQualityText">-</p>
                    </div>

                    <div class="data-card rounded-2xl p-4">
                        <div class="flex items-center justify-between mb-3">
                            <h4 class="font-semibold text-slate-900">CBT</h4>
                            <span class="text-lg font-bold text-slate-900" id="tbc">-</span>
                        </div>
                        <div class="quality-indicator">
                            <div class="quality-bar" id="tbcQualityBar" style="width: 0%"></div>
                        </div>
                        <p class="text-xs text-slate-500 mt-2" id="tbcQualityText">-</p>
                    </div>
                </div>
                <!-- Quality Trends -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="data-card rounded-2xl p-6">
                        <h3 class="text-lg font-bold text-slate-900 mb-4">Tend√™ncia de Qualidade</h3>
                        <div class="chart-container">
                            <canvas id="qualityTrendChart"></canvas>
                        </div>
                    </div>

                    <div class="data-card rounded-2xl p-6">
                        <h3 class="text-lg font-bold text-slate-900 mb-4">Distribui√ß√£o de Qualidade</h3>
                        <div class="chart-container">
                            <canvas id="qualityDistributionChart"></canvas>
                        </div>
                    </div>

                    <div class="data-card rounded-2xl p-6">
                        <h3 class="text-lg font-bold text-slate-900 mb-4">Qualidade Semanal</h3>
                        <div class="chart-container">
                            <canvas id="qualityChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Quality Tests -->
                <div class="data-card rounded-2xl p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-bold text-slate-900">Testes de Qualidade</h3>
                        <button onclick="addQualityTest()" class="px-4 py-2 bg-forest-600 text-white rounded-lg hover:shadow-lg transition-all font-semibold text-sm">
                            <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                            </svg>
                            Novo Teste
                        </button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="border-b border-gray-200">
                                    <th class="text-left py-3 px-4 font-semibold text-slate-900">Data</th>
                                    <th class="text-left py-3 px-4 font-semibold text-slate-900">Gordura</th>
                                    <th class="text-left py-3 px-4 font-semibold text-slate-900">Prote√≠na</th>
                                    <th class="text-left py-3 px-4 font-semibold text-slate-900">CCS</th>
                                    <th class="text-left py-3 px-4 font-semibold text-slate-900">CBT</th>
                                    <th class="text-left py-3 px-4 font-semibold text-slate-900">Status</th>
                                    <th class="text-left py-3 px-4 font-semibold text-slate-900">A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="qualityTests">
                                <tr>
                                    <td colspan="7" class="text-center py-8 text-gray-500">
                                        Nenhum teste encontrado
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Financial Records Tab -->
        <div id="payments-tab" class="tab-content hidden">
            <div class="space-y-6">
                <!-- Financial Records Header -->
                <div class="data-card rounded-2xl p-6">
                    <div class="flex flex-col sm:flex-row sm:items-center justify-between mb-6 gap-4">
                        <div>
                            <h2 class="text-xl md:text-2xl font-bold text-slate-900 mb-1">Controle de Vendas</h2>
                <p class="text-slate-600 text-sm">Gerencie vendas de leite e recebimentos</p>
                        </div>
                        <div class="flex flex-col sm:flex-row gap-3 w-full sm:w-auto">
                            <select id="paymentPeriod" class="px-4 py-2 border border-slate-200 rounded-lg text-sm focus:border-forest-500 focus:outline-none bg-white">
                                <option value="month">Este M√™s</option>
                                <option value="quarter">Trimestre</option>
                                <option value="year">Ano</option>
                            </select>
                            <button onclick="generatePaymentsReport()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:shadow-lg transition-all font-semibold text-sm">
                                <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                Relat√≥rio
                            </button>
                            <button onclick="addPayment()" class="px-4 py-2 bg-forest-600 text-white rounded-lg hover:shadow-lg transition-all font-semibold text-sm">
                        <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                        </svg>
                        Nova Venda
                    </button>
                        </div>
                    </div>
                </div>

                <!-- Payment Summary -->
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="data-card rounded-2xl p-6 text-center">
                        <div class="w-16 h-16 bg-green-100 rounded-2xl flex items-center justify-center mx-auto mb-4">
                            <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <div class="text-2xl font-bold text-slate-900 mb-2" id="paidAmount">-</div>
                        <div class="text-sm text-slate-600 font-medium">Vendas Realizadas</div>
                        <div class="text-xs text-green-600 font-semibold mt-2">Este M√™s</div>
                    </div>

                    <div class="data-card rounded-2xl p-6 text-center">
                        <div class="w-16 h-16 bg-yellow-100 rounded-2xl flex items-center justify-center mx-auto mb-4">
                            <svg class="w-8 h-8 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <div class="text-2xl font-bold text-slate-900 mb-2" id="pendingAmount">-</div>
                        <div class="text-sm text-slate-600 font-medium">Vendas Pendentes</div>
                        <div class="text-xs text-yellow-600 font-semibold mt-2">A Vencer</div>
                    </div>

                    <div class="data-card rounded-2xl p-6 text-center">
                        <div class="w-16 h-16 bg-red-100 rounded-2xl flex items-center justify-center mx-auto mb-4">
                            <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                            </svg>
                        </div>
                        <div class="text-2xl font-bold text-slate-900 mb-2" id="overdueAmount">-</div>
                        <div class="text-sm text-slate-600 font-medium">Vendas Atrasadas</div>
                        <div class="text-xs text-red-600 font-semibold mt-2">Vencidos</div>
                    </div>
                </div>

                <!-- Payment Chart -->
                <div class="data-card rounded-2xl p-6">
                    <h3 class="text-lg font-bold text-slate-900 mb-4">Fluxo de Vendas</h3>
                    <div class="chart-container">
                        <canvas id="paymentsChart"></canvas>
                    </div>
                </div>
                <!-- Payments List -->
                <div class="data-card rounded-2xl p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-bold text-slate-900">Lista de Vendas</h3>
                        <div class="flex gap-2">
                            <select id="paymentFilter" class="px-3 py-2 border border-slate-200 rounded-lg text-sm focus:border-forest-500 focus:outline-none bg-white">
                                <option value="all">Todos</option>
                                <option value="paid">Pagos</option>
                                <option value="pending">Pendentes</option>
                                <option value="overdue">Atrasados</option>
                            </select>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="border-b border-gray-200">
                                    <th class="text-left py-3 px-4 font-semibold text-slate-900">Benefici√°rio</th>
                                    <th class="text-left py-3 px-4 font-semibold text-slate-900">Tipo</th>
                                    <th class="text-left py-3 px-4 font-semibold text-slate-900">Valor</th>
                                    <th class="text-left py-3 px-4 font-semibold text-slate-900">Vencimento</th>
                                    <th class="text-left py-3 px-4 font-semibold text-slate-900">Status</th>
                                    <th class="text-left py-3 px-4 font-semibold text-slate-900">A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="paymentsList">
                                <tr>
                                    <td colspan="6" class="text-center py-8 text-gray-500">
                                        Nenhuma venda encontrada
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Users Tab -->
        <div id="users-tab" class="tab-content hidden users-section">
            <div class="space-y-6 sm:space-y-8">
                <!-- Users Header -->
                <div class="data-card rounded-2xl p-4 sm:p-6">
                    <div class="flex flex-col sm:flex-row sm:items-center justify-between mb-4 sm:mb-6 gap-3 sm:gap-4">
                        <div>
                            <h2 class="text-lg sm:text-xl md:text-2xl font-bold text-slate-900 mb-1">Gest√£o de Usu√°rios</h2>
                            <p class="text-slate-600 text-xs sm:text-sm">Gerencie funcion√°rios e suas permiss√µes</p>
                        </div>
                        <div class="flex flex-col sm:flex-row gap-2 sm:gap-3 w-full sm:w-auto">
                            <select id="userFilter" class="px-3 sm:px-4 py-2 border border-slate-200 rounded-lg text-sm focus:border-forest-500 focus:outline-none bg-white">
                                <option value="all">Todos os usu√°rios</option>
                                <option value="funcionario">Funcion√°rios</option>
                                <option value="veterinario">Veterin√°rios</option>
                                <option value="proprietario">Propriet√°rios</option>
                            </select>
                            <button onclick="addUser()" class="px-3 sm:px-4 py-2 bg-forest-600 text-white rounded-lg hover:shadow-lg transition-all font-semibold text-sm">
                                <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                </svg>
                                Adicionar Usu√°rio
                            </button>
                        </div>
                    </div>
                </div>

                <!-- User Stats -->
                <div class="grid grid-cols-2 gap-4 sm:gap-6">
                    <div class="data-card rounded-2xl p-4 sm:p-6 text-center metric-card-responsive">
                        <div class="w-10 h-10 sm:w-12 sm:h-12 bg-blue-500 rounded-xl flex items-center justify-center mx-auto mb-2 sm:mb-3 shadow-lg">
                            <svg class="w-5 h-5 sm:w-6 sm:h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                            </svg>
                        </div>
                        <div class="text-lg sm:text-xl font-bold text-slate-900 mb-1" id="totalUsers">--</div>
                        <div class="text-xs text-slate-500 font-medium">Total</div>
                        <div class="text-xs text-slate-600 font-semibold mt-1">Usu√°rios</div>
                    </div>
                    
                    <div class="data-card rounded-2xl p-4 sm:p-6 text-center metric-card-responsive">
                        <div class="w-10 h-10 sm:w-12 sm:h-12 bg-green-500 rounded-xl flex items-center justify-center mx-auto mb-2 sm:mb-3 shadow-lg">
                            <svg class="w-5 h-5 sm:w-6 sm:h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                            </svg>
                        </div>
                        <div class="text-lg sm:text-xl font-bold text-slate-900 mb-1" id="employeesCount">--</div>
                        <div class="text-xs text-slate-500 font-medium">Funcion√°rios</div>
                        <div class="text-xs text-slate-600 font-semibold mt-1">Ativos</div>
                    </div>
                    
                    <div class="data-card rounded-2xl p-4 sm:p-6 text-center metric-card-responsive">
                        <div class="w-10 h-10 sm:w-12 sm:h-12 bg-purple-500 rounded-xl flex items-center justify-center mx-auto mb-2 sm:mb-3 shadow-lg">
                            <svg class="w-5 h-5 sm:w-6 sm:h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                            </svg>
                        </div>
                        <div class="text-lg sm:text-xl font-bold text-slate-900 mb-1" id="veterinariansCount">--</div>
                        <div class="text-xs text-slate-500 font-medium">Veterin√°rios</div>
                        <div class="text-xs text-slate-600 font-semibold mt-1">Ativos</div>
                    </div>
                    
                    <div class="data-card rounded-2xl p-4 sm:p-6 text-center metric-card-responsive">
                        <div class="w-10 h-10 sm:w-12 sm:h-12 bg-orange-500 rounded-xl flex items-center justify-center mx-auto mb-2 sm:mb-3 shadow-lg">
                            <svg class="w-5 h-5 sm:w-6 sm:h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                            </svg>
                        </div>
                        <div class="text-lg sm:text-xl font-bold text-slate-900 mb-1" id="managersCount">--</div>
                        <div class="text-xs text-slate-500 font-medium">Gerentes</div>
                        <div class="text-xs text-slate-600 font-semibold mt-1">Ativos</div>
                    </div>
                </div>

                <!-- Users List -->
                <div class="data-card rounded-2xl p-4 sm:p-6">
                    <h3 class="text-base sm:text-lg font-bold text-slate-900 mb-4 sm:mb-6">Lista de Usu√°rios</h3>
                    <div class="space-y-4 sm:space-y-6" id="usersList">
                        <div class="text-center py-8 sm:py-12">
                            <div class="w-16 h-16 sm:w-20 sm:h-20 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4 sm:mb-6">
                                <svg class="w-8 h-8 sm:w-10 sm:h-10 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                </svg>
                            </div>
                            <h3 class="text-base sm:text-lg font-semibold text-gray-900 mb-2">Nenhum Usu√°rio Cadastrado</h3>
                            <p class="text-gray-600 mb-3 sm:mb-4 text-sm">Adicione usu√°rios para gerenciar sua equipe</p>
                            <button onclick="addUser()" class="px-4 sm:px-6 py-2 sm:py-3 gradient-forest text-white font-semibold rounded-xl hover:shadow-lg transition-all text-sm">
                                <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                </svg>
                                Adicionar Primeiro Usu√°rio
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Enhanced Mobile Navigation -->
    <nav class="fixed bottom-0 left-0 right-0 md:hidden mobile-nav-enhanced shadow-2xl z-40">
        <div class="grid grid-cols-6 gap-1 p-2">
            <button class="mobile-nav-item active flex flex-col items-center py-2 px-1 transition-all" data-tab="dashboard">
                <svg class="w-4 h-4 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2H5a2 2 0 00-2-2z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" d="M8 7V5a2 2 0 012-2h4a2 2 0 012 2v2"></path>
                </svg>
                <span class="text-xs font-semibold">Dashboard</span>
            </button>
            <button class="mobile-nav-item flex flex-col items-center py-2 px-1 transition-all" data-tab="volume">
                <svg class="w-4 h-4 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path>
                            </svg>
                <span class="text-xs font-semibold">Volume</span>
            </button>
            <button class="mobile-nav-item flex flex-col items-center py-2 px-1 transition-all" data-tab="quality">
                <svg class="w-4 h-4 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <span class="text-xs font-semibold">Qualidade</span>
            </button>
            <button class="mobile-nav-item flex flex-col items-center py-2 px-1 transition-all" data-tab="payments">
                <svg class="w-4 h-4 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                </svg>
                <span class="text-xs font-semibold">Financeiro</span>
            </button>
            <button class="mobile-nav-item flex flex-col items-center py-2 px-1 transition-all" data-tab="users">
                <svg class="w-4 h-4 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 19.128a9.38 9.38 0 002.625.372 9.337 9.337 0 004.121-.952 4.125 4.125 0 00-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 018.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0111.964-3.07M12 6.375a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zm8.25 2.25a2.625 2.625 0 11-5.25 0 2.625 2.625 0 015.25 0z"></path>
                </svg>
                <span class="text-xs font-semibold">Usu√°rios</span>
            </button>
            <button class="mobile-nav-item flex flex-col items-center py-2 px-1 transition-all" data-tab="reports">
                <svg class="w-4 h-4 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                            </svg>
                <span class="text-xs font-semibold">Relat√≥rios</span>
            </button>
        </div>
    </nav>
    <!-- Reports Tab -->
    <div id="reports-tab" class="tab-content hidden">
        <div class="px-4 sm:px-6 lg:px-8 py-6">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <!-- Configura√ß√µes de Relat√≥rios -->
            <div class="bg-gradient-to-br from-white to-slate-50 rounded-2xl p-8 border border-slate-200 shadow-lg">
                <!-- Header da Se√ß√£o -->
                <div class="flex items-center mb-6">
                    <div class="p-3 bg-gradient-to-br from-green-500 to-green-600 rounded-xl mr-4">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>
                        </div>
                    <div>
                        <h3 class="text-xl font-bold text-slate-900">Configura√ß√µes de Relat√≥rios</h3>
                        <p class="text-sm text-slate-600">Personalize a apar√™ncia dos seus relat√≥rios</p>
                    </div>
                    </div>
                    
                <div class="space-y-6">
                    <!-- Nome da Fazenda -->
                    <div class="space-y-2">
                        <label class="block text-sm font-semibold text-slate-700 flex items-center">
                            <svg class="w-4 h-4 mr-2 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2H5a2 2 0 00-2-2z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V5a2 2 0 012-2h4a2 2 0 012 2v2"></path>
                            </svg>
                            Nome da Fazenda
                        </label>
                        <input type="text" id="reportFarmNameTab" class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:border-green-500 focus:ring-2 focus:ring-green-100 focus:outline-none bg-white shadow-sm transition-all" placeholder="Digite o nome da fazenda">
                </div>

                    <!-- Upload da Logo da Fazenda -->
                    <div class="space-y-3">
                        <label class="block text-sm font-semibold text-slate-700 flex items-center">
                            <svg class="w-4 h-4 mr-2 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                            </svg>
                            Logo da Fazenda
                        </label>
                        
                        <div class="bg-white rounded-xl p-4 border border-slate-200 shadow-sm">
                            <div class="flex items-center space-x-4">
                                <div class="relative">
                                    <!-- Preview da logo -->
                                    <div id="farmLogoPreviewTab" class="w-20 h-20 border-2 border-dashed border-green-300 rounded-xl flex items-center justify-center bg-green-50 hidden">
                                        <img id="farmLogoImageTab" src="" alt="Logo da Fazenda" class="w-full h-full object-cover rounded-xl">
                        </div>
                                    <!-- Placeholder quando n√£o h√° logo -->
                                    <div id="farmLogoPlaceholderTab" class="w-20 h-20 border-2 border-dashed border-slate-300 rounded-xl flex items-center justify-center bg-slate-50">
                                        <svg class="w-8 h-8 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                        </svg>
                    </div>
                </div>
                                <div class="flex-1 space-y-2">
                                    <div class="flex flex-wrap gap-2">
                                        <button onclick="document.getElementById('farmLogoUploadTab').click()" class="flex items-center px-4 py-2 bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-medium rounded-lg transition-all text-sm shadow-md hover:shadow-lg">
                                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                                <path stroke-linecap="round" stroke-linejoin="round" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                            </svg>
                                            Escolher Logo
                                        </button>
                                        <button id="removeFarmLogoTab" onclick="removeFarmLogoTab()" class="flex items-center px-4 py-2 bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white font-medium rounded-lg transition-all text-sm shadow-md hover:shadow-lg hidden">
                                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                                <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                            </svg>
                                            Remover
                                        </button>
                    </div>
                                    <input type="file" id="farmLogoUploadTab" accept="image/*" class="hidden" onchange="handleFarmLogoUploadTab(event)">
                                    <p class="text-xs text-slate-500 flex items-center">
                                        <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                        PNG, JPG, JPEG (m√°x. 2MB) - Prefer√™ncia: formato quadrado
                                    </p>
                </div>
                            </div>
                    </div>
                </div>

                    <!-- Bot√£o Salvar -->
                    <div class="pt-4 border-t border-slate-200">
                        <button onclick="saveReportSettingsTab()" class="w-full sm:w-auto flex items-center justify-center px-8 py-3 bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white font-semibold rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 transform hover:-translate-y-0.5">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"></path>
                            </svg>
                            Salvar Configura√ß√µes
                        </button>
                </div>
            </div>
        </div>

            <!-- Estat√≠sticas R√°pidas -->
            <div class="bg-gradient-to-br from-green-50 to-emerald-50 rounded-2xl p-4 sm:p-6 lg:p-8 border border-green-200 shadow-lg relative overflow-hidden">
                <!-- Background Pattern -->
                <div class="absolute inset-0 opacity-5">
                    <div class="absolute inset-0 bg-gradient-to-br from-green-500 to-emerald-600"></div>
                    <svg class="absolute top-0 right-0 w-20 sm:w-24 lg:w-32 h-20 sm:h-24 lg:h-32 transform translate-x-4 sm:translate-x-6 lg:translate-x-8 -translate-y-4 sm:-translate-y-6 lg:-translate-y-8" fill="currentColor" viewBox="0 0 100 100">
                        <circle cx="50" cy="50" r="35"/>
                    </svg>
                    <svg class="absolute bottom-0 left-0 w-16 sm:w-20 lg:w-24 h-16 sm:h-20 lg:h-24 transform -translate-x-2 sm:-translate-x-3 lg:-translate-x-4 translate-y-2 sm:translate-y-3 lg:translate-y-4" fill="currentColor" viewBox="0 0 100 100">
                        <rect x="30" y="30" width="40" height="40" rx="8"/>
                    </svg>
                        </div>
                
                <!-- Header da Se√ß√£o -->
                <div class="relative flex flex-col sm:flex-row items-start sm:items-center mb-4 sm:mb-6">
                    <div class="p-2 sm:p-3 bg-gradient-to-br from-green-500 to-emerald-600 rounded-lg sm:rounded-xl mr-0 sm:mr-4 mb-3 sm:mb-0">
                        <svg class="w-5 h-5 sm:w-6 sm:h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                </svg>
                        </div>
                    <div>
                        <h3 class="text-lg sm:text-xl font-bold text-slate-900">Resumo de Produ√ß√£o</h3>
                        <p class="text-xs sm:text-sm text-slate-600">Indicadores em tempo real</p>
                    </div>
                </div>

                <div class="relative space-y-3 sm:space-y-4">
                    <!-- Produ√ß√£o de Hoje - Destaque -->
                    <div class="bg-white/80 backdrop-blur-sm rounded-xl p-3 sm:p-4 border border-white/50 shadow-sm hover:shadow-md transition-all duration-300">
                        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between space-y-3 sm:space-y-0">
                            <div class="flex items-center space-x-2 sm:space-x-3">
                                <div class="p-1.5 sm:p-2 bg-gradient-to-br from-green-400 to-green-500 rounded-lg flex-shrink-0">
                                    <svg class="w-4 h-4 sm:w-5 sm:h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                        </div>
                                <div>
                                    <p class="text-sm sm:text-base font-medium text-slate-600">Produ√ß√£o de Hoje</p>
                                    <p class="text-xs text-slate-500">Volume registrado</p>
                        </div>
                    </div>
                            <div class="text-left sm:text-right">
                                <p class="text-xl sm:text-2xl font-bold text-green-600" id="reportTodayVolume">0.0 L</p>
                                <p class="text-xs text-slate-500">litros</p>
                        </div>
                        </div>
                    </div>

                    <!-- Outras M√©tricas -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 sm:gap-3">
                        <div class="bg-white/60 backdrop-blur-sm rounded-lg p-2 sm:p-3 border border-white/30 hover:bg-white/80 transition-all duration-300">
                            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between space-y-2 sm:space-y-0">
                                <div class="flex items-center space-x-2">
                                    <div class="p-1 sm:p-1.5 bg-blue-100 rounded-md flex-shrink-0">
                                        <svg class="w-3 h-3 sm:w-4 sm:h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"></path>
                                        </svg>
                        </div>
                                    <span class="text-xs sm:text-sm font-medium text-slate-700">M√©dia Semanal</span>
                        </div>
                                <span class="text-sm sm:text-base font-bold text-blue-600" id="reportWeekAverage">0.0 L</span>
                            </div>
                    </div>

                        <div class="bg-white/60 backdrop-blur-sm rounded-lg p-2 sm:p-3 border border-white/30 hover:bg-white/80 transition-all duration-300">
                            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between space-y-2 sm:space-y-0">
                                <div class="flex items-center space-x-2">
                                    <div class="p-1 sm:p-1.5 bg-emerald-100 rounded-md flex-shrink-0">
                                        <svg class="w-3 h-3 sm:w-4 sm:h-4 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                        </svg>
                        </div>
                                    <span class="text-xs sm:text-sm font-medium text-slate-700">Total do M√™s</span>
                        </div>
                                <span class="text-sm sm:text-base font-bold text-emerald-600" id="reportMonthTotal">0.0 L</span>
                    </div>
                </div>

                        <div class="bg-white/60 backdrop-blur-sm rounded-lg p-2 sm:p-3 border border-white/30 hover:bg-white/80 transition-all duration-300">
                            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between space-y-2 sm:space-y-0">
                                <div class="flex items-center space-x-2">
                                    <div class="p-1 sm:p-1.5 bg-orange-100 rounded-md flex-shrink-0">
                                        <svg class="w-3 h-3 sm:w-4 sm:h-4 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                        </svg>
                        </div>
                                    <span class="text-xs sm:text-sm font-medium text-slate-700">Registros</span>
                    </div>
                                <span class="text-sm sm:text-base font-bold text-orange-600" id="reportMonthRecords">0</span>
                        </div>
                    </div>

                        <div class="bg-white/60 backdrop-blur-sm rounded-lg p-2 sm:p-3 border border-white/30 hover:bg-white/80 transition-all duration-300">
                            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between space-y-2 sm:space-y-0">
                                <div class="flex items-center space-x-2">
                                    <div class="p-1 sm:p-1.5 bg-teal-100 rounded-md flex-shrink-0">
                                        <svg class="w-3 h-3 sm:w-4 sm:h-4 text-teal-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"></path>
                                        </svg>
                        </div>
                                    <span class="text-xs sm:text-sm font-medium text-slate-700">Funcion√°rios</span>
                    </div>
                                <span class="text-sm sm:text-base font-bold text-teal-600" id="reportActiveEmployees">0</span>
                </div>
                    </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Exportar Relat√≥rios -->
        <div class="bg-gradient-to-br from-white to-slate-50 rounded-2xl p-8 border border-slate-200 shadow-lg">
            <!-- Header da Se√ß√£o -->
            <div class="flex items-center mb-8">
                <div class="p-3 bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl mr-4">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                        </div>
                <div>
                    <h3 class="text-xl font-bold text-slate-900">Exportar Relat√≥rios</h3>
                    <p class="text-sm text-slate-600">Gere relat√≥rios personalizados da produ√ß√£o</p>
                    </div>
                </div>

            <!-- Filtros de Data - Design Melhorado -->
            <div class="bg-white rounded-xl p-6 border border-slate-200 shadow-sm mb-8">
                <h4 class="text-lg font-semibold text-slate-800 mb-4 flex items-center">
                    <svg class="w-5 h-5 mr-2 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.207A1 1 0 013 6.5V4z"></path>
                    </svg>
                    Filtros de Relat√≥rio
                </h4>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="space-y-2">
                        <label class="block text-sm font-semibold text-slate-700">Data Inicial</label>
                        <div class="relative">
                            <input type="date" id="reportStartDate" class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all bg-white shadow-sm">
                            <svg class="absolute right-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-slate-400 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                            </svg>
                        </div>
                    </div>
                    <div class="space-y-2">
                        <label class="block text-sm font-semibold text-slate-700">Data Final</label>
                        <div class="relative">
                            <input type="date" id="reportEndDate" class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all bg-white shadow-sm">
                            <svg class="absolute right-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-slate-400 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                            </svg>
                        </div>
                    </div>
                    <div class="space-y-2">
                        <label class="block text-sm font-semibold text-slate-700">Funcion√°rio</label>
                        <div class="relative">
                            <select id="reportEmployee" class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all bg-white shadow-sm appearance-none">
                                <option value="">Todos os funcion√°rios</option>
                            </select>
                            <svg class="absolute right-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-slate-400 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </div>
                    </div>
                    </div>
                </div>

            <!-- Bot√µes de Exporta√ß√£o - Design Responsivo -->
            <!-- Bot√µes de Exporta√ß√£o - Design Simples -->
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-8">
                <!-- PDF -->
                <button onclick="exportPDFReport()" class="bg-red-600 hover:bg-red-700 text-white rounded-lg p-4 transition-colors duration-200 shadow-md">
                    <div class="flex flex-col items-center space-y-2">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        <div class="text-center">
                            <h4 class="font-bold">Exportar PDF</h4>
                            <p class="text-sm opacity-90">Relat√≥rio completo formatado</p>
                        </div>
                    </div>
                </button>
                
                <!-- Excel -->
                <button onclick="exportExcelReport()" class="bg-green-600 hover:bg-green-700 text-white rounded-lg p-4 transition-colors duration-200 shadow-md">
                    <div class="flex flex-col items-center space-y-2">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        <div class="text-center">
                            <h4 class="font-bold">Exportar Excel</h4>
                            <p class="text-sm opacity-90">Planilha para an√°lise</p>
                        </div>
                    </div>
                </button>
                
                <!-- Pr√©via -->
                <button onclick="previewReportTab()" class="bg-purple-600 hover:bg-purple-700 text-white rounded-lg p-4 transition-colors duration-200 shadow-md">
                    <div class="flex flex-col items-center space-y-2">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                        </svg>
                        <div class="text-center">
                            <h4 class="font-bold">Visualizar Pr√©via</h4>
                            <p class="text-sm opacity-90">Amostra do relat√≥rio</p>
                        </div>
                    </div>
                </button>
                        </div>
                    </div>
                </div>
                
                <!-- Espa√ßo adicional para rolagem -->
                <div class="h-32"></div>
            </div>
        </div>
    <!-- Modal de Adicionar Usu√°rio -->
    <div id="addUserModal" class="fullscreen-modal">
        <div class="modal-content">
            <!-- Header do Modal -->
            <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 z-10">
                <div class="flex items-center justify-between">
                    <h2 class="text-xl font-bold text-gray-900">Adicionar Novo Usu√°rio</h2>
                    <button onclick="closeAddUserModal()" class="p-2 hover:bg-gray-100 rounded-lg transition-all">
                        <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>
            
            <!-- Conte√∫do do Modal -->
            <div class="p-6 space-y-6">
                <!-- Formul√°rio de Adicionar Usu√°rio -->
                <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-200">
                    <h4 class="text-lg font-semibold text-gray-900 mb-4">Informa√ß√µes do Usu√°rio</h4>
                    <form id="addUserForm" class="space-y-4">
                        <div class="form-floating">
                            <input type="text" id="userName" name="name" class="w-full px-3 py-4 border border-slate-200 rounded-xl focus:border-forest-500 focus:ring-2 focus:ring-forest-100 focus:outline-none" placeholder=" " required>
                            <label for="userName" class="text-slate-600">Nome Completo *</label>
                        </div>
                                                
                        <!-- Email Preview -->
                        <div class="bg-gray-50 border border-gray-200 rounded-xl p-4">
                            <div class="flex items-center">
                                <svg class="w-5 h-5 text-gray-500 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                                </svg>
                                <div>
                                    <h5 class="text-sm font-semibold text-gray-900 mb-1">Email ser√° gerado automaticamente:</h5>
                                    <p class="text-sm text-gray-600" id="emailPreview">Digite o nome para ver o email</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="form-floating">
                                <input type="tel" id="userWhatsapp" name="whatsapp" class="w-full px-3 py-4 border border-slate-200 rounded-xl focus:border-forest-500 focus:ring-2 focus:ring-forest-100 focus:outline-none" placeholder=" " required>
                                <label for="userWhatsapp" class="text-slate-600">WhatsApp *</label>
                            </div>
                            <div class="form-floating">
                                <select id="userRole" name="role" class="w-full px-3 py-4 border border-slate-200 rounded-xl focus:border-forest-500 focus:ring-2 focus:ring-forest-100 focus:outline-none" required>
                                    <option value="">Selecione o cargo</option>
                                    <option value="funcionario">Funcion√°rio</option>
                                    <option value="veterinario">Veterin√°rio</option>
                                </select>
                                <label for="userRole" class="text-slate-600">Cargo *</label>
                            </div>
                        </div>
                        
                        <!-- Se√ß√£o de Foto de Perfil para Add User -->
                        <div id="addPhotoSection" class="hidden">
                            <label class="block text-sm font-semibold text-gray-800 mb-2">Foto de Perfil</label>
                            <div class="flex items-center space-x-4">
                                <div class="relative">
                                    <img id="profilePreview" src="" alt="Preview da foto" class="w-16 h-16 rounded-xl object-cover hidden">
                                    <div id="profilePlaceholder" class="w-16 h-16 bg-gray-100 rounded-xl flex items-center justify-center">
                                        <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                        </svg>
                                    </div>
                                </div>
                                <div>
                                    <button type="button" onclick="addPhotoToNewUser()" class="px-4 py-2 bg-forest-600 hover:bg-forest-700 text-white font-medium rounded-lg transition-all text-sm">
                                        Escolher Foto
                                    </button>
                                    <input type="file" id="profilePhotoInput" name="profilePhoto" accept="image/*" class="hidden" onchange="previewProfilePhoto(this)">
                                    <p class="text-xs text-gray-500 mt-1">Formatos: JPG, PNG (m√°x. 2MB)</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-floating relative">
                            <input type="password" id="userPassword" name="password" class="w-full px-3 py-4 pr-12 border border-slate-200 rounded-xl focus:border-forest-500 focus:ring-2 focus:ring-forest-100 focus:outline-none" placeholder=" " required>
                            <label for="userPassword" class="text-slate-600">Senha *</label>
                            <button type="button" onclick="togglePasswordVisibility('userPassword', 'userPasswordToggle')" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700 focus:outline-none" id="userPasswordToggle">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                </svg>
                            </button>
                        </div>
                        
                        <div class="bg-blue-50 border border-blue-200 rounded-xl p-4">
                            <div class="flex items-start">
                                <svg class="w-5 h-5 text-blue-500 mt-0.5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                <div>
                                    <h5 class="text-sm font-semibold text-blue-900 mb-1">Informa√ß√µes Importantes</h5>
                                    <p class="text-sm text-blue-700">‚Ä¢ Como gerente, voc√™ pode criar perfis de funcion√°rios e veterin√°rios</p>
                                    <p class="text-sm text-blue-700">‚Ä¢ O usu√°rio receber√° as credenciais por WhatsApp</p>
                                    <p class="text-sm text-blue-700">‚Ä¢ O email ser√° gerado automaticamente baseado no nome da fazenda</p>
                                    <p class="text-sm text-blue-700">‚Ä¢ Recomenda-se que o usu√°rio altere a senha no primeiro acesso</p>
                                    <p class="text-sm text-blue-700">‚Ä¢ O acesso ser√° ativado imediatamente ap√≥s a cria√ß√£o</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex justify-end space-x-3 pt-4">
                            <button type="button" onclick="closeAddUserModal()" class="px-6 py-3 border border-gray-300 text-gray-700 font-semibold rounded-xl hover:bg-gray-50 transition-all">
                                Cancelar
                            </button>
                            <button type="submit" class="px-6 py-3 gradient-forest text-white font-semibold rounded-xl hover:shadow-lg transition-all">
                                <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                </svg>
                                Criar Usu√°rio
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Editar Usu√°rio -->
    <div id="editUserModal" class="fullscreen-modal">
        <div class="modal-content">
            <!-- Header do Modal -->
            <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 z-10">
                <div class="flex items-center justify-between">
                    <h2 class="text-xl font-bold text-gray-900">Editar Usu√°rio</h2>
                    <button onclick="closeEditUserModal()" class="p-2 hover:bg-gray-100 rounded-lg transition-all">
                        <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>
            
            <!-- Conte√∫do do Modal -->
            <div class="p-6 space-y-6">
                <!-- Formul√°rio de Editar Usu√°rio -->
                <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-200">
                    <h4 class="text-lg font-semibold text-gray-900 mb-4">Informa√ß√µes do Usu√°rio</h4>
                    <form id="editUserForm" class="space-y-4">
                        <input type="hidden" id="editUserId" name="id">
                        
                        <div class="form-floating">
                            <input type="text" id="editUserName" name="name" class="w-full px-3 py-4 border border-slate-200 rounded-xl focus:border-forest-500 focus:ring-2 focus:ring-forest-100 focus:outline-none" placeholder=" " required>
                            <label for="editUserName" class="text-slate-600">Nome Completo *</label>
                        </div>
                                                
                        <div class="form-floating">
                            <input type="email" id="editUserEmail" name="email" class="w-full px-3 py-4 border border-slate-200 rounded-xl bg-gray-100 text-gray-500" placeholder=" " readonly>
                            <label for="editUserEmail" class="text-slate-600">Email (n√£o pode ser alterado)</label>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="form-floating">
                                <input type="tel" id="editUserWhatsapp" name="whatsapp" class="w-full px-3 py-4 border border-slate-200 rounded-xl focus:border-forest-500 focus:ring-2 focus:ring-forest-100 focus:outline-none" placeholder=" " required>
                                <label for="editUserWhatsapp" class="text-slate-600">WhatsApp *</label>
                            </div>
                            <div class="form-floating">
                                <select id="editUserRole" name="role" class="w-full px-3 py-4 border border-slate-200 rounded-xl focus:border-forest-500 focus:ring-2 focus:ring-forest-100 focus:outline-none" required>
                                    <option value="">Selecione o cargo</option>
                                    <option value="funcionario">Funcion√°rio</option>
                                    <option value="veterinario">Veterin√°rio</option>
                                </select>
                                <label for="editUserRole" class="text-slate-600">Cargo *</label>
                            </div>
                        </div>
                        
                        <!-- Se√ß√£o de Foto de Perfil para Edit User -->
                        <div id="editPhotoSection" class="hidden">
                            <label class="block text-sm font-semibold text-gray-800 mb-2">Foto de Perfil</label>
                            <div class="flex items-center space-x-4">
                                <div class="relative">
                                    <img id="editProfilePreview" src="" alt="Preview da foto" class="w-16 h-16 rounded-xl object-cover hidden">
                                    <div id="editProfilePlaceholder" class="w-16 h-16 bg-gray-100 rounded-xl flex items-center justify-center">
                                        <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                        </svg>
                                    </div>
                                </div>
                                <div>
                                    <button type="button" onclick="addPhotoToEditUser()" class="px-4 py-2 bg-forest-600 hover:bg-forest-700 text-white font-medium rounded-lg transition-all text-sm">
                                        Alterar Foto
                                    </button>
                                    <input type="file" id="editProfilePhoto" name="profilePhoto" accept="image/*" class="hidden" onchange="previewEditProfilePhoto(this)">
                                    <p class="text-xs text-gray-500 mt-1">Formatos: JPG, PNG (m√°x. 2MB)</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-floating relative">
                            <input type="password" id="editUserPassword" name="password" class="w-full px-3 py-4 pr-12 border border-slate-200 rounded-xl focus:border-forest-500 focus:ring-2 focus:ring-forest-100 focus:outline-none" placeholder=" ">
                            <label for="editUserPassword" class="text-slate-600">Nova Senha (deixe em branco para manter a atual)</label>
                            <button type="button" onclick="togglePasswordVisibility('editUserPassword', 'editUserPasswordToggle')" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700 focus:outline-none" id="editUserPasswordToggle">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                </svg>
                            </button>
                        </div>
                        
                        <div class="bg-blue-50 border border-blue-200 rounded-xl p-4">
                            <div class="flex items-start">
                                <svg class="w-5 h-5 text-blue-500 mt-0.5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                <div>
                                    <h5 class="text-sm font-semibold text-blue-900 mb-1">Informa√ß√µes sobre Edi√ß√£o</h5>
                                    <p class="text-sm text-blue-700">‚Ä¢ O email n√£o pode ser alterado ap√≥s a cria√ß√£o</p>
                                    <p class="text-sm text-blue-700">‚Ä¢ Deixe o campo senha em branco para manter a senha atual</p>
                                    <p class="text-sm text-blue-700">‚Ä¢ As altera√ß√µes ser√£o aplicadas imediatamente</p>
                                    <p class="text-sm text-blue-700">‚Ä¢ O usu√°rio ser√° notificado sobre as mudan√ßas por WhatsApp</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex justify-end space-x-3 pt-4">
                            <button type="button" onclick="closeEditUserModal()" class="px-6 py-3 border border-gray-300 text-gray-700 font-semibold rounded-xl hover:bg-gray-50 transition-all">
                                Cancelar
                            </button>
                            <button type="submit" class="px-6 py-3 gradient-forest text-white font-semibold rounded-xl hover:shadow-lg transition-all">
                                <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"></path>
                                </svg>
                                Salvar Altera√ß√µes
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Escolha de Fonte da Foto - REMOVIDO TEMPORARIAMENTE --> 
    <!-- <div id="photoChoiceModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[10000] hidden backdrop-blur-sm"> 
        <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4 shadow-2xl transform transition-all duration-300 scale-95 opacity-0" id="modalContent"> 
            <div class="text-center mb-8"> 
                <div class="w-16 h-16 bg-forest-100 rounded-full flex items-center justify-center mx-auto mb-4"> 
                    <svg class="w-8 h-8 text-forest-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"> 
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path> 
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path> 
                    </svg> 
                </div> 
                <h3 class="text-xl font-bold text-gray-800 mb-2">Escolher fonte da foto</h3> 
                <p class="text-sm text-gray-500">Selecione de onde deseja obter sua foto</p> 
            </div> 
    
            <div class="space-y-4 mb-6"> 
                <button onclick="choosePhotoSource('camera')" class="group w-full px-6 py-4 bg-forest-600 text-white rounded-xl hover:bg-forest-700 transition-all duration-200 transform hover:scale-[1.02] hover:shadow-lg flex items-center justify-center space-x-3 font-medium"> 
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"> 
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path> 
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path> 
                    </svg> 
                    <span>Abrir C√¢mera</span> 
                </button> 
                
                <button onclick="choosePhotoSource('gallery')" class="group w-full px-6 py-4 bg-forest-600 text-white rounded-xl hover:bg-forest-700 transition-all duration-200 transform hover:scale-[1.02] hover:shadow-lg flex items-center justify-center space-x-3 font-medium"> 
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"> 
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path> 
                    </svg> 
                    <span>Abrir Galeria</span> 
                </button> 
            </div> 
    
            <button onclick="closePhotoChoiceModal()" class="w-full px-6 py-3 border-2 border-gray-200 text-gray-600 rounded-xl hover:bg-gray-50 hover:border-gray-300 transition-all duration-200 font-medium"> 
                Cancelar 
            </button> 
        </div> 
    </div> -->

<!-- Modal de Perfil do Gerente -->
    <div id="profileModal" class="fullscreen-modal">
        <div class="modal-content">
            <!-- Header do Modal -->
            <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 z-10">
                <div class="flex items-center justify-between">
                    <h2 class="text-xl font-bold text-gray-900">Perfil do Gerente</h2>
                    <button onclick="closeProfileModal()" class="p-2 hover:bg-gray-100 rounded-lg transition-all">
                        <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>
            
            <!-- Conte√∫do do Perfil -->
            <div class="p-6 space-y-6">
                <!-- Header do Perfil -->
                <div class="flex items-center justify-between mb-6">
                                            <div class="flex items-center space-x-4">
                            <div class="relative">
                                <!-- Foto do usu√°rio -->
                                <img id="modalProfilePhoto" src="" alt="Foto de Perfil" class="w-16 h-16 object-cover rounded-2xl shadow-lg hidden">
                                <!-- √çcone padr√£o -->
                                <div id="modalProfileIcon" class="w-16 h-16 gradient-forest rounded-2xl flex items-center justify-center shadow-lg">
                                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                    </svg>
                                </div>
                            </div>
                        <div>
                            <h2 class="text-2xl font-bold text-slate-900" id="profileName">Carregando...</h2>
                            <p class="text-slate-600 text-base">Gerente</p>
                            <p class="text-sm text-slate-500" id="profileFarmName">Carregando...</p>
                        </div>
                    </div>
                </div>
                <!-- Informa√ß√µes Pessoais -->
                <div class="bg-white rounded-2xl p-6 border border-gray-200">
                    <div class="flex items-center justify-between mb-4">
                        <h4 class="text-lg font-semibold text-gray-900">Informa√ß√µes Pessoais</h4>
                        <button id="editProfileBtn" onclick="toggleProfileEdit()" class="px-4 py-2 text-sm bg-forest-600 hover:bg-forest-700 text-white font-medium rounded-lg transition-all">
                            <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                            </svg>
                            Editar
                        </button>
                    </div>
                    
                    <!-- Modo Visualiza√ß√£o -->
                    <div id="profileViewMode" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-800 mb-1">Nome Completo</label>
                            <p class="text-gray-900 font-semibold text-base" id="profileFullName">Carregando...</p>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-800 mb-1">Email</label>
                            <p class="text-gray-900 font-semibold text-base" id="profileEmail2">Carregando...</p>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-800 mb-1">WhatsApp</label>
                            <p class="text-gray-900 font-semibold text-base" id="profileWhatsApp">Carregando...</p>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-800 mb-1">Cargo</label>
                            <p class="text-gray-900 font-semibold text-base">Gerente</p>
                        </div>
                    </div>
                    
                    <!-- Modo Edi√ß√£o -->
                    <div id="profileEditMode" class="hidden">
                        <form id="updateProfileForm" class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-800 mb-2">Nome Completo</label>
                                    <input type="text" id="editProfileName" name="name" class="w-full px-4 py-3 border border-slate-200 rounded-xl focus:border-forest-500 focus:ring-2 focus:ring-forest-100 focus:outline-none bg-white" placeholder="Digite seu nome completo">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-800 mb-2">Email</label>
                                    <input type="email" id="editProfileEmail" name="email" class="w-full px-4 py-3 border border-slate-200 rounded-xl bg-gray-100 text-gray-500" readonly placeholder="Email n√£o pode ser alterado">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-800 mb-2">WhatsApp</label>
                                    <input type="tel" id="editProfileWhatsApp" name="whatsapp" class="w-full px-4 py-3 border border-slate-200 rounded-xl focus:border-forest-500 focus:ring-2 focus:ring-forest-100 focus:outline-none bg-white" placeholder="(00) 00000-0000">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-800 mb-2">Cargo</label>
                                    <input type="text" value="Gerente" class="w-full px-4 py-3 border border-slate-200 rounded-xl bg-gray-100 text-gray-500" readonly>
                                </div>
                            </div>
                            
                            <div class="flex justify-end space-x-3 pt-4">
                                <button type="button" onclick="cancelProfileEdit()" class="px-6 py-3 border border-gray-300 text-gray-700 font-semibold rounded-xl hover:bg-gray-50 transition-all">
                                    Cancelar
                                </button>
                                <button type="submit" class="px-6 py-3 gradient-forest text-white font-semibold rounded-xl hover:shadow-lg transition-all">
                                    <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"></path>
                                    </svg>
                                    Salvar Altera√ß√µes
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Theme Toggle Section -->
                <div class="bg-white rounded-2xl p-6 border border-gray-200">
                    <h4 class="text-lg font-semibold text-gray-900 mb-4">Prefer√™ncias</h4>
                    <div class="flex items-center justify-between">
                        <div>
                            <h5 class="font-medium text-gray-900">Modo Escuro</h5>
                            <p class="text-sm text-gray-600">Alternar entre tema claro e escuro</p>
                        </div>
                        <div class="theme-toggle" onclick="toggleTheme()">
                            <div class="theme-toggle-slider">
                                <svg class="w-4 h-4 text-yellow-500 sun-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>
                                </svg>
                                <svg class="w-4 h-4 text-blue-400 moon-icon hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
                                </svg>
                            </div>
                        </div>
                    </div>
                </div>
                
                
                <!-- Alterar Senha -->
                <div class="bg-white rounded-2xl p-6 border border-gray-200">
                    <h4 class="text-lg font-semibold text-gray-900 mb-4">Alterar Senha</h4>
                    <form id="changePasswordForm" class="space-y-4">
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 mb-2">Senha Atual</label>
                            <input type="password" required name="current_password" class="w-full px-4 py-3 border border-slate-200 rounded-xl focus:border-forest-500 focus:ring-2 focus:ring-forest-100 focus:outline-none bg-white" placeholder="Digite sua senha atual">
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-2">Nova Senha</label>
                                <input type="password" required name="new_password" class="w-full px-4 py-3 border border-slate-200 rounded-xl focus:border-forest-500 focus:ring-2 focus:ring-forest-100 focus:outline-none bg-white" placeholder="Nova senha">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-2">Confirmar Nova Senha</label>
                                <input type="password" required name="confirm_password" class="w-full px-4 py-3 border border-slate-200 rounded-xl focus:border-forest-500 focus:ring-2 focus:ring-forest-100 focus:outline-none bg-white" placeholder="Confirme a nova senha">
                            </div>
                        </div>
                        <button type="submit" class="px-6 py-3 gradient-forest text-white font-semibold rounded-xl hover:shadow-lg transition-all">
                            Alterar Senha
                        </button>
                    </form>
                </div>
                
                <!-- Cria√ß√£o de Contas Secund√°rias -->
                <div class="bg-white rounded-2xl p-6 border border-gray-200">
                    <div class="flex items-center justify-between mb-4">
                        <h4 class="text-lg font-semibold text-gray-900">Contas Secund√°rias</h4>
                        <button onclick="toggleSecondaryAccountForm()" class="px-4 py-2 text-sm bg-forest-600 hover:bg-forest-700 text-white font-medium rounded-lg transition-all">
                            <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                            </svg>
                            Nova Conta
                        </button>
                    </div>
                    
                    <p class="text-sm text-gray-600 mb-4">Crie contas de funcion√°rio ou veterin√°rio usando seus dados como base</p>
                    
                    <!-- Lista de Contas Secund√°rias -->
                    <div id="secondaryAccountsList" class="space-y-3 mb-4">
                        <!-- Contas ser√£o carregadas aqui -->
                    </div>
                    
                    <!-- Formul√°rio de Nova Conta -->
                    <div id="secondaryAccountForm" class="hidden border-t border-gray-200 pt-4">
                        <form id="createSecondaryAccountForm" class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-800 mb-2">Tipo de Conta</label>
                                    <select name="account_type" required class="w-full px-4 py-3 border border-slate-200 rounded-xl focus:border-forest-500 focus:ring-2 focus:ring-forest-100 focus:outline-none bg-white">
                                        <option value="">Selecione o tipo</option>
                                        <option value="funcionario">Funcion√°rio</option>
                                        <option value="veterinario">Veterin√°rio</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-800 mb-2">Email da Nova Conta</label>
                                    <input type="email" name="email" required class="w-full px-4 py-3 border border-slate-200 rounded-xl focus:border-forest-500 focus:ring-2 focus:ring-forest-100 focus:outline-none bg-white" placeholder="email@exemplo.com">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-800 mb-2">Nome Completo</label>
                                    <input type="text" name="name" id="secondaryAccountName" class="w-full px-4 py-3 border border-slate-200 rounded-xl focus:border-forest-500 focus:ring-2 focus:ring-forest-100 focus:outline-none bg-white" placeholder="Nome ser√° copiado automaticamente">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-800 mb-2">WhatsApp</label>
                                    <input type="tel" name="whatsapp" id="secondaryAccountWhatsApp" class="w-full px-4 py-3 border border-slate-200 rounded-xl focus:border-forest-500 focus:ring-2 focus:ring-forest-100 focus:outline-none bg-white" placeholder="WhatsApp ser√° copiado automaticamente">
                                </div>
                            </div>
                            
                            <div class="bg-blue-50 border border-blue-200 rounded-xl p-4">
                                <div class="flex items-start">
                                    <svg class="w-5 h-5 text-blue-600 mt-0.5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    <div>
                                        <h5 class="text-sm font-semibold text-blue-800 mb-1">Informa√ß√µes Importantes</h5>
                                        <ul class="text-sm text-blue-700 space-y-1">
                                            <li>‚Ä¢ A conta ser√° criada com seus dados pessoais como base</li>
                                            <li>‚Ä¢ Uma senha tempor√°ria ser√° gerada automaticamente</li>
                                            <li>‚Ä¢ O usu√°rio dever√° alterar a senha no primeiro acesso</li>
                                            <li>‚Ä¢ A conta ter√° acesso apenas √† sua fazenda</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="flex justify-end space-x-3">
                                <button type="button" onclick="cancelSecondaryAccountForm()" class="px-6 py-3 border border-gray-300 text-gray-700 font-semibold rounded-xl hover:bg-gray-50 transition-all">
                                    Cancelar
                                </button>
                                <button type="submit" class="px-6 py-3 gradient-forest text-white font-semibold rounded-xl hover:shadow-lg transition-all">
                                    <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                    </svg>
                                    Criar Conta
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <!-- Sair do Sistema -->
                <div class="bg-white rounded-2xl p-6 border border-red-200">
                    <h4 class="text-lg font-semibold text-red-900 mb-4">Zona de Perigo</h4>
                    <div class="flex items-center justify-between">
                        <div>
                            <h5 class="font-medium text-red-900">Sair do Sistema</h5>
                            <p class="text-sm text-red-600">Encerrar sua sess√£o atual</p>
                        </div>
                        <button onclick="signOut()" class="px-6 py-3 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-xl transition-all">
                            <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                            </svg>
                            Sair
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Toast -->
    <div id="notificationToast" class="notification-toast">
        <div class="bg-white    rounded-lg shadow-lg border border-gray-200    p-4 max-w-sm">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <svg class="w-5 h-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </div>
                <div class="ml-3">
                    <p class="text-sm font-medium text-gray-900   " id="toastMessage">Sucesso!</p>
                </div>
                <div class="ml-auto pl-3">
                    <button onclick="hideNotification()" class="text-gray-400 hover:text-gray-600   :text-gray-300">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Confirma√ß√£o de Exclus√£o - REMOVIDO TEMPORARIAMENTE -->
    <!-- <div id="deleteUserModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[10000] hidden backdrop-blur-sm" style="display: none !important;">
        <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4 shadow-2xl">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.34 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                    </svg>
                </div>
                <h3 class="text-xl font-bold text-gray-800 mb-2">Confirmar Exclus√£o</h3>
                <p class="text-sm text-gray-500">Esta a√ß√£o n√£o pode ser desfeita</p>
            </div>
            <div class="text-center mb-6">
                <p class="text-gray-700">Tem certeza que deseja excluir o usu√°rio <strong id="deleteUserName">Nome do Usu√°rio</strong>?</p>
            </div>
            <div class="flex space-x-4">
                <button onclick="closeDeleteUserModal()" class="flex-1 px-6 py-3 border-2 border-gray-200 text-gray-600 rounded-xl hover:bg-gray-50 hover:border-gray-300 transition-all duration-200 font-medium">
                    Cancelar
                </button>
                <button onclick="confirmDeleteUser()" class="flex-1 px-6 py-3 bg-red-600 text-white rounded-xl hover:bg-red-700 transition-all duration-200 font-medium">
                    Excluir
                </button>
            </div>
        </div>
    </div> -->

    <script>

// Check authentication before initializing page
async function checkAuthentication() {
    // Usar a vers√£o corrigida que sincroniza com Supabase
    return await window.authFix.checkAuthenticationFixed();
}

// Watcher: verifica periodicamente se a conta foi bloqueada
async function startBlockWatcher(intervalMs = 15000) {
    try {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) return;
        const check = async () => {
            try {
                const { data } = await supabase
                    .from('users')
                    .select('is_active')
                    .eq('id', user.id)
                    .single();
                if (data && data.is_active === false) {
                    window.location.href = 'acesso-bloqueado.html';
                }
            } catch (_) {}
        };
        // Checa imediatamente e agenda pr√≥ximo
        await check();
        setInterval(check, intervalMs);
    } catch (_) {}
}

// Initialize page
document.addEventListener('DOMContentLoaded', async function() {
    // Fechar qualquer modal que possa estar aberto
    const deleteModal = document.getElementById('deleteUserModal');
    if (deleteModal && !deleteModal.classList.contains('hidden')) {
        deleteModal.classList.add('hidden');
        console.log('Modal de exclus√£o fechado automaticamente no carregamento da p√°gina');
    }
    
    // Monitorar mudan√ßas no modal para detectar abertura autom√°tica
    if (deleteModal) {
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                    const target = mutation.target;
                    if (!target.classList.contains('hidden')) {
                        console.warn('Modal de exclus√£o foi aberto! Stack trace:', new Error().stack);
                        // Se n√£o h√° userToDelete definido, fechar o modal
                        if (!userToDelete) {
                            console.log('Fechando modal aberto sem userToDelete');
                            target.classList.add('hidden');
                        }
                    }
                }
            });
        });
        observer.observe(deleteModal, { attributes: true, attributeFilter: ['class'] });
    }
    
    // Prote√ß√£o adicional: for√ßar fechamento do modal a cada 100ms por 5 segundos
    let protectionCount = 0;
    const protectionInterval = setInterval(function() {
        if (protectionCount >= 50) { // 5 segundos
            clearInterval(protectionInterval);
            return;
        }
        
        const modal = document.getElementById('deleteUserModal');
        if (modal && !modal.classList.contains('hidden')) {
            if (!userToDelete || !userToDelete.id) {
                modal.classList.add('hidden');
                // Remover backdrop tamb√©m
                modal.style.display = 'none';
                modal.style.visibility = 'hidden';
                modal.style.opacity = '0';
                modal.style.pointerEvents = 'none';
                console.log('Prote√ß√£o ativa: modal e backdrop fechados');
            }
        }
        protectionCount++;
    }, 100);
    
    // Limpar vari√°vel userToDelete
    if (typeof userToDelete !== 'undefined') {
        userToDelete = null;
    }
    
    // Check authentication first
    const isAuthenticated = await checkAuthentication();
    if (!isAuthenticated) {
        return; // Stop execution if not authenticated
    }
    
    initializeTheme(); // Initialize theme first
    initializeCharts(); // Initialize charts before loading data
    await initializePage();
    setupEventListeners();
    updateDateTime();
    setInterval(updateDateTime, 60000); // Update every minute
    // Iniciar verifica√ß√£o de bloqueio durante a sess√£o
    startBlockWatcher(15000);
});

async function initializePage() {
    try {
        // Verify Supabase authentication
        const { data: { user }, error: authError } = await supabase.auth.getUser();
        if (authError || !user) {
            console.error('Supabase authentication failed:', authError);
            showNotification('Erro de autentica√ß√£o. Redirecionando para login...', 'error');
            setTimeout(() => {
                window.location.href = 'login.html';
            }, 2000);
            return;
        }
        
        console.log('Supabase user authenticated:', user.email);
        
        // Check if user is active
        const { data: userData, error: userError } = await supabase
            .from('users')
            .select('is_active')
            .eq('id', user.id)
            .single();
            
        if (userError) {
            console.error('Error checking user status:', userError);
        } else if (!userData.is_active) {
            console.log('User is blocked, redirecting to blocked page');
            window.location.href = 'acesso-bloqueado.html';
            return;
        }
        
        // Execute each function independently to avoid blocking
        try {
            await setFarmName();
        } catch (error) {
            console.error('Error setting farm name:', error);
        }
        
        try {
            await setManagerName();
        } catch (error) {
            console.error('Error setting manager name:', error);
        }
        

        
        try {
            await loadUserProfile();
        } catch (error) {
            console.error('Error loading user profile:', error);
        }
        
        try {
            if (typeof loadHeaderProfilePhoto === 'function') {
                await loadHeaderProfilePhoto();
            }
        } catch (error) {
            console.error('Error loading header profile photo:', error);
        }
        
        try {
            console.log('üöÄ Chamando loadDashboardData...');
            await loadDashboardData();
        } catch (error) {
            console.error('‚ùå ERRO ao chamar loadDashboardData:', error);
        }
        
        try {
            await loadVolumeData();
            await loadVolumeRecords();
        } catch (error) {
            console.error('Error loading volume data:', error);
        }
        
        try {
            await loadQualityData();
            await loadQualityTests();
        } catch (error) {
            console.error('Error loading quality data:', error);
        }
        
        try {
            await loadTemperatureChart();
        } catch (error) {
            console.error('Error loading temperature chart:', error);
        }
        
        try {
            await loadPaymentsData();
        } catch (error) {
            console.error('Error loading payments data:', error);
        }
        
        try {
            await loadDashboardVolumeChart();
        } catch (error) {
            console.error('Error loading dashboard volume chart:', error);
        }
        
        try {
            await loadWeeklyVolumeChart();
        } catch (error) {
            console.error('Error loading weekly volume chart:', error);
        }
        
        try {
            await loadDailyVolumeChart();
        } catch (error) {
            console.error('Error loading daily volume chart:', error);
        }
        
        try {
            await loadDashboardWeeklyChart();
        } catch (error) {
            console.error('Error loading dashboard weekly chart:', error);
        }
        
        try {
            // Get user's farm_id for recent activities
            const { data: { user } } = await supabase.auth.getUser();
            if (user) {
                const { data: usersData } = await supabase
                    .from('users')
                    .select('farm_id')
                    .eq('email', user.email)
                    .order('created_at', { ascending: true }); // Sempre usar conta prim√°ria
                
                const userData = usersData?.[0]; // Primeira conta = prim√°ria
                
                if (userData?.farm_id) {
                    await loadRecentActivities(userData.farm_id);
                }
            }
        } catch (error) {
            console.error('Error loading recent activities:', error);
        }
        
        try {
            await loadUsersData();
        } catch (error) {
            console.error('Error loading users data:', error);
        }
    } catch (error) {
        console.error('Error initializing page:', error);
        // Show user-friendly message
        showNotification('Algumas informa√ß√µes n√£o puderam ser carregadas. Verifique sua conex√£o.', 'warning');
    }
}
// Function to create user if not exists using RPC functions
async function createUserIfNotExists(authUser) {
    try {
        console.log('Creating user and farm using RPC functions...');
        
        // First check if user already exists
        const { data: existingUser, error: userCheckError } = await supabase
            .from('users')
            .select('id, farm_id')
            .eq('email', authUser.email)
            .maybeSingle();
        
        if (userCheckError) {
            console.error('Error checking existing user:', userCheckError);
            throw userCheckError;
        }
        
        if (existingUser) {
            console.log('User already exists:', existingUser);
            return;
        }
        
        // Check if farm already exists with the same name
        const farmName = authUser.user_metadata?.farm_name || 'fazenda nascimento';
        console.log('Looking for farm with name:', farmName);
        
        const { data: existingFarm, error: farmCheckError } = await supabase
            .from('farms')
            .select('id')
            .eq('name', farmName)
            .maybeSingle();
        
        if (farmCheckError) {
            console.error('Error checking existing farm:', farmCheckError);
            throw farmCheckError;
        }
        
        let farmId;
        
        if (existingFarm) {
            console.log('Farm already exists, using existing farm:', existingFarm.id);
            farmId = existingFarm.id;
        } else {
            // Try to create new farm, but handle duplicate name error
            console.log('Creating new farm with name:', farmName);
            const { data: newFarmId, error: farmError } = await supabase
                .rpc('create_initial_farm', {
                    p_name: farmName,
                    p_owner_name: authUser.user_metadata?.name || authUser.email?.split('@')[0] || 'Propriet√°rio',
                    p_city: authUser.user_metadata?.city || 'Cidade',
                    p_state: authUser.user_metadata?.state || 'MG'
                });
            
            if (farmError) {
                console.error('Error creating farm via RPC:', farmError);
                // If it's a duplicate name error, try to find the existing farm
                if (farmError.code === '23505' || farmError.message?.includes('duplicate') || farmError.message?.includes('already exists')) {
                    console.log('Farm name already exists, searching for existing farm...');
                    
                    // Wait a bit and try again
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                    const { data: retryFarm, error: retryError } = await supabase
                        .from('farms')
                        .select('id')
                        .eq('name', farmName)
                        .maybeSingle();
                    
                    if (retryError) {
                        console.error('Error searching for existing farm:', retryError);
                        throw retryError;
                    }
                    
                    if (retryFarm) {
                        farmId = retryFarm.id;
                        console.log('Found existing farm with ID:', farmId);
                    } else {
                        console.error('Could not find or create farm');
                        throw new Error('Failed to create or find farm');
                    }
                } else {
                    throw farmError;
                }
            } else {
                farmId = newFarmId;
                console.log('Farm created via RPC with ID:', farmId);
            }
        }
        
        if (!farmId) {
            throw new Error('No farm ID available for user creation');
        }
        
        // Create user with the farm_id
        console.log('Creating user with farm_id:', farmId);
        const { data: userResult, error: userError } = await supabase
            .rpc('create_initial_user', {
                p_user_id: authUser.id,
                p_farm_id: farmId,
                p_name: authUser.user_metadata?.name || authUser.email?.split('@')[0] || 'Usu√°rio',
                p_email: authUser.email,
                p_role: authUser.user_metadata?.role || 'funcionario',
                p_whatsapp: authUser.user_metadata?.whatsapp || authUser.user_metadata?.phone || ''
            });
        
        if (userError) {
            console.error('Error creating user via RPC:', userError);
            throw userError;
        } else {
            console.log('User created successfully via RPC:', userResult);
        }
    } catch (error) {
        console.error('Error in createUserIfNotExists:', error);
        throw error; // Re-throw the error so it can be handled by the caller
    }
}

// Function to get farm name from session or Supabase
async function getFarmName() {
    try {
        console.log('Getting farm name...');
        
        // First try to get from local session
        const userData = localStorage.getItem('userData') || sessionStorage.getItem('userData');
        if (userData) {
            try {
                const user = JSON.parse(userData);
                if (user.farm_name) {
                    console.log('Using farm name from session:', user.farm_name);
                    return user.farm_name;
                }
            } catch (error) {
                console.error('Error parsing session data:', error);
            }
        }
        
        // Get current user and their farm
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) {
            console.log('No user found, using fallback');
            return 'Minha Fazenda';
        }

        // Get user's farm_id from users table - SEMPRE USAR CONTA PRIM√ÅRIA
        const { data: usersData, error: userError } = await supabase
            .from('users')
            .select('farm_id')
            .eq('email', user.email)
            .order('created_at', { ascending: true }); // Primeira conta = prim√°ria
        
        const userDbData = usersData?.[0]; // Sempre usar a primeira conta
            
        if (userError) {
            console.warn('Error fetching user data:', userError);
            throw userError;
        }
        
        if (!userDbData?.farm_id) {
            // Fallback to auth metadata
            if (user.user_metadata?.farm_name) {
                return user.user_metadata.farm_name;
            }
            console.log('User or farm_id not found, using fallback');
            return 'Minha Fazenda';
        }

        // Get farm name from farms table
        const { data: farmData, error: farmError } = await supabase
            .from('farms')
            .select('name')
            .eq('id', userDbData.farm_id)
            .single();
        
        if (farmError || !farmData?.name) {
            console.log('Farm name not found, using fallback');
            return 'Minha Fazenda';
        }
        
        console.log('Using farm name from database:', farmData.name);
        return farmData.name;
        
    } catch (error) {
        console.error('Error fetching farm name:', error);
        return 'Minha Fazenda';
    }
}

// Toggle theme function
function toggleTheme() {
    const html = document.documentElement;
    const body = document.body;
    const isDark = html.classList.contains('dark');
    
    if (isDark) {
        // Mudar para modo claro
        html.classList.remove('dark');
        body.classList.remove('dark');
        localStorage.setItem('theme', 'light');
        showNotification('Modo claro ativado', 'success');
        applyChartTheme();
    } else {
        // Mudar para modo escuro
        html.classList.add('dark');
        body.classList.add('dark');
        localStorage.setItem('theme', 'dark');
        showNotification('Modo escuro ativado', 'success');
        applyChartTheme();
    }
    
    // For√ßar atualiza√ß√£o do nome do usu√°rio no header
    setTimeout(async () => {
        try {
            await setManagerName();
        } catch (error) {
            console.error('Erro ao atualizar nome do usu√°rio:', error);
        }
    }, 100);
}

// Fun√ß√£o utilit√°ria para sempre buscar a conta prim√°ria
async function getPrimaryUserAccount(email) {
    try {
        const { data: usersData, error } = await supabase
            .from('users')
            .select('*')
            .eq('email', email)
            .eq('is_active', true)
            .order('created_at', { ascending: true }); // Primeira conta = prim√°ria
        
        if (error) {
            console.error('Erro ao buscar conta prim√°ria:', error);
            return null;
        }
        
        return usersData?.[0] || null; // Sempre retorna a primeira conta
    } catch (error) {
        console.error('Erro na fun√ß√£o getPrimaryUserAccount:', error);
        return null;
    }
}

// Initialize theme
function initializeTheme() {
    const savedTheme = localStorage.getItem('theme');
    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    
    if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
        document.documentElement.classList.add('dark');
        document.body.classList.add('dark');
    }
    // Apply chart theme on load
    setTimeout(applyChartTheme, 0);
    
    // For√ßar carregamento do nome do usu√°rio ap√≥s inicializa√ß√£o do tema
    setTimeout(async () => {
        try {
            await setManagerName();
        } catch (error) {
            console.error('Erro ao carregar nome do usu√°rio na inicializa√ß√£o:', error);
        }
    }, 200);
}

// Chamar a inicializa√ß√£o do tema quando a p√°gina carregar
document.addEventListener('DOMContentLoaded', function() {
    initializeTheme();
});

// Show notification function melhorada
function showNotification(message, type = 'info') {
    // Verificar se √© uma mensagem especial que merece modal
    if (message.includes('Logo carregada') || message.includes('Configura√ß√µes salvas com sucesso')) {
        showSuccessModal(message, type);
        return;
    }
    
    // Create notification element com design melhorado
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 p-4 rounded-xl shadow-2xl z-50 max-w-sm transform transition-all duration-300 border-l-4`;
    
    // Definir cores e √≠cones baseados no tipo
    let bgColor, textColor, borderColor, icon;
    switch(type) {
        case 'error':
            bgColor = 'bg-red-50';
            textColor = 'text-red-800';
            borderColor = 'border-red-500';
            icon = 'üö®';
            break;
        case 'warning':
            bgColor = 'bg-yellow-50';
            textColor = 'text-yellow-800';
            borderColor = 'border-yellow-500';
            icon = '‚ö†Ô∏è';
            break;
        case 'success':
            bgColor = 'bg-green-50';
            textColor = 'text-green-800';
            borderColor = 'border-green-500';
            icon = '‚úÖ';
            break;
        default:
            bgColor = 'bg-blue-50';
            textColor = 'text-blue-800';
            borderColor = 'border-blue-500';
            icon = '‚ÑπÔ∏è';
    }
    
    notification.className += ` ${bgColor} ${textColor} ${borderColor}`;
    
    // Criar conte√∫do com √≠cone
    notification.innerHTML = `
        <div class="flex items-start space-x-3">
            <span class="text-lg flex-shrink-0">${icon}</span>
            <div class="flex-1">
                <p class="font-medium text-sm">${message}</p>
            </div>
            <button onclick="this.parentElement.parentElement.remove()" class="text-gray-400 hover:text-gray-600 transition-colors">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
    `;
    
    // Adicionar anima√ß√£o de entrada
    notification.style.transform = 'translateX(100%)';
    notification.style.opacity = '0';
    
    // Add to page
    document.body.appendChild(notification);
    
    // Animar entrada
    requestAnimationFrame(() => {
        notification.style.transform = 'translateX(0)';
        notification.style.opacity = '1';
    });
    
    // Remove after 5 seconds with animation
    setTimeout(() => {
        if (notification.parentNode) {
            notification.style.transform = 'translateX(100%)';
            notification.style.opacity = '0';
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
                }
            }, 300);
        }
    }, 5000);
}
// Modal de sucesso especial para mensagens importantes
function showSuccessModal(message, type = 'success') {
    // Verificar se j√° existe um modal
    const existingModal = document.getElementById('successModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Criar modal
    const modal = document.createElement('div');
    modal.id = 'successModal';
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
    
    // Determinar √≠cone e cores baseado na mensagem
    let icon, title, bgColor;
    if (message.includes('Logo carregada')) {
        icon = 'üñºÔ∏è';
        title = 'Logo Carregada!';
        bgColor = 'from-blue-500 to-blue-600';
    } else if (message.includes('Configura√ß√µes salvas')) {
        icon = '‚öôÔ∏è';
        title = 'Configura√ß√µes Salvas!';
        bgColor = 'from-green-500 to-green-600';
    } else {
        icon = '‚úÖ';
        title = 'Sucesso!';
        bgColor = 'from-green-500 to-green-600';
    }
    
    modal.innerHTML = `
        <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4 transform transition-all duration-300 scale-95 opacity-0" id="modalContent">
            <!-- Header com gradiente -->
            <div class="text-center mb-6">
                <div class="w-20 h-20 bg-gradient-to-br ${bgColor} rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg">
                    <span class="text-3xl">${icon}</span>
                </div>
                <h3 class="text-2xl font-bold text-gray-900 mb-2">${title}</h3>
                <div class="w-16 h-1 bg-gradient-to-r ${bgColor} rounded-full mx-auto"></div>
            </div>
            
            <!-- Mensagem -->
            <div class="text-center mb-8">
                <p class="text-gray-600 leading-relaxed">${message}</p>
            </div>
            
            <!-- Bot√£o -->
            <div class="text-center">
                <button onclick="closeSuccessModal()" class="bg-gradient-to-r ${bgColor} text-white px-8 py-3 rounded-xl font-semibold shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 transition-all duration-200">
                    Entendi
                </button>
            </div>
        </div>
    `;
    
    // Adicionar evento de clique no fundo para fechar
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            closeSuccessModal();
        }
    });
    
    document.body.appendChild(modal);
    
    // Animar entrada
    requestAnimationFrame(() => {
        const content = document.getElementById('modalContent');
        if (content) {
            content.style.transform = 'scale(1)';
            content.style.opacity = '1';
        }
    });
    
    // Auto-fechar ap√≥s 4 segundos
    setTimeout(() => {
        closeSuccessModal();
    }, 4000);
}

// Fun√ß√£o para fechar modal de sucesso
function closeSuccessModal() {
    const modal = document.getElementById('successModal');
    if (modal) {
        const content = document.getElementById('modalContent');
        if (content) {
            content.style.transform = 'scale(0.95)';
            content.style.opacity = '0';
        }
        setTimeout(() => {
            modal.remove();
        }, 300);
    }
}

// Function to get manager name from session or Supabase
async function getManagerName() {
    try {
        console.log('Getting manager name...');
        
        // First try to get from local session
        const userData = localStorage.getItem('userData') || sessionStorage.getItem('userData');
        if (userData) {
            try {
                const user = JSON.parse(userData);
                if (user.name) {
                    console.log('Using manager name from session:', user.name);
                    return user.name;
                }
            } catch (error) {
                console.error('Error parsing session data:', error);
            }
        }
        
        // Fallback to Supabase Auth
        const { data: { user } } = await supabase.auth.getUser();
        console.log('User data:', user);
        if (!user) {
            console.log('No user found, using fallback');
            return authUser.user_metadata?.name || authUser.email?.split('@')[0] || 'Gerente';
        }

        // First try to get user from database
        const { data, error } = await supabase
            .from('users')
            .select('name')
            .eq('email', user.email)
            .single();
        
        console.log('User query result:', { data, error });
        
        // If user not found in database, return fallback
        if (error && error.code === 'PGRST116') {
            return user.user_metadata?.name || user.email?.split('@')[0] || 'Gerente';
        }
        
        if (error) {
            console.error('Error in getManagerName:', error);
            return 'Gerente';
        }
        return data?.name || 'Gerente';
    } catch (error) {
        console.error('Error fetching manager name:', error);
        return 'Gerente';
    }
}

// Function to set farm name in header
async function setFarmName() {
    const farmName = await getFarmName();
    document.getElementById('farmNameHeader').textContent = farmName;
}

// Function to extract formal name (second name)
function extractFormalName(fullName) {
    if (!fullName || typeof fullName !== 'string') {
        return 'Gerente';
    }
    
    // Remove extra spaces and split
    const names = fullName.trim().split(/\s+/);
    
    // If only one name, return it
    if (names.length === 1) {
        return names[0];
    }
    
    // If two names, return the second
    if (names.length === 2) {
        return names[1];
    }
    
    // For 3 or more names, try to find the most formal name
    // Skip common prefixes and find the second meaningful name
    const skipWords = ['da', 'de', 'do', 'das', 'dos', 'di', 'del', 'della', 'delle', 'delli'];
    
    let formalName = '';
    let nameCount = 0;
    
    for (let i = 0; i < names.length; i++) {
        const name = names[i].toLowerCase();
        
        // Skip common prefixes
        if (skipWords.includes(name)) {
            continue;
        }
        
        // Count meaningful names
        nameCount++;
        
        // Get the second meaningful name
        if (nameCount === 2) {
            formalName = names[i];
            break;
        }
    }
    
    // If we didn't find a second meaningful name, use the second name overall
    if (!formalName && names.length >= 2) {
        formalName = names[1];
    }
    
    // If still no formal name, use the first name
    if (!formalName) {
        formalName = names[0];
    }
    
    // Capitalize first letter
    return formalName.charAt(0).toUpperCase() + formalName.slice(1).toLowerCase();
}

// Function to set manager name in profile
async function setManagerName() {
    const managerName = await getManagerName();
    const farmName = await getFarmName();
    
    // Set with fallback values if empty
    const finalManagerName = managerName || 'Gerente';
    const finalFarmName = farmName || 'Minha Fazenda';
    
    // Extract formal name for welcome message
    const formalName = extractFormalName(finalManagerName);
    
    const elements = [
        'profileName',
        'profileFullName'
    ];
    
    elements.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.textContent = finalManagerName;
        }
    });
    
    // Set header and welcome message with formal name
    const headerElement = document.getElementById('managerName');
    const welcomeElement = document.getElementById('managerWelcome');
    if (headerElement) {
        headerElement.textContent = formalName;
    }
    if (welcomeElement) {
        welcomeElement.textContent = formalName;
    }
    
    document.getElementById('profileFarmName').textContent = finalFarmName;
}

// Function to load user profile data
async function loadUserProfile() {
    try {
        const whatsappElement = document.getElementById('profileWhatsApp');
        
        if (!whatsappElement) {
            return;
        }
        
        // First try to get from local session
        const sessionData = localStorage.getItem('userData') || sessionStorage.getItem('userData');
        
        if (sessionData) {
            try {
                const user = JSON.parse(sessionData);
                
                // Set profile data from session
                document.getElementById('profileEmail2').textContent = user.email || '';
                const whatsappValue = user.whatsapp || user.phone || 'N√£o informado';
                document.getElementById('profileWhatsApp').textContent = whatsappValue;
                return;
            } catch (error) {
                // Continue to fallback
            }
        }
        
        // Fallback to Supabase Auth
        const { data: { user } } = await supabase.auth.getUser();
        
        if (!user) {
            document.getElementById('profileEmail2').textContent = 'N√£o logado';
            document.getElementById('profileWhatsApp').textContent = 'N√£o informado';
            return;
        }

        const { data: userData, error } = await supabase
            .from('users')
            .select('name, email, whatsapp')
            .eq('email', user.email)
            .single();
        
        // If user not found, just show error - don't create automatically
        if (error && error.code === 'PGRST116') {
            document.getElementById('profileEmail2').textContent = user.email || '';
            document.getElementById('profileWhatsApp').textContent = 'Usu√°rio n√£o encontrado';
            return;
        }
        
        if (error) {
            document.getElementById('profileEmail2').textContent = user.email || '';
            document.getElementById('profileWhatsApp').textContent = 'Erro ao carregar';
            return;
        }

        // Update profile elements
        if (userData) {
            const email = userData.email || user.email || '';
            const whatsapp = userData.whatsapp || 'N√£o informado';
            
            document.getElementById('profileEmail2').textContent = email;
            document.getElementById('profileWhatsApp').textContent = whatsapp;
        } else {
            document.getElementById('profileEmail2').textContent = user.email || '';
            document.getElementById('profileWhatsApp').textContent = 'N√£o informado';
        }
    } catch (error) {
        document.getElementById('profileEmail2').textContent = 'Erro';
        document.getElementById('profileWhatsApp').textContent = 'Erro';
    }
}


// Update date and time
function updateDateTime() {
    const now = new Date();
    const timeString = now.toLocaleTimeString('pt-BR', { 
        hour: '2-digit', 
        minute: '2-digit' 
    });
    document.getElementById('lastUpdate').textContent = timeString;
}
// Load dashboard data from Supabase
async function loadDashboardData() {
    if (!supabase) {
        return;
    }
    
    try {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) {
            return;
        }

        // Get user's farm_id first
        const { data: userData, error: userError } = await supabase
            .from('users')
            .select('farm_id')
            .eq('email', user.email)
            .maybeSingle();
        
        if (userError || !userData) {
            return;
        }

        // Load volume data - handle if table doesn't exist
        try {
            const { data: volumeData, error: volumeError } = await supabase
                .from('milk_production')
                .select('volume_liters')
                .eq('farm_id', userData.farm_id)
                .gte('production_date', new Date().toISOString().split('T')[0]);

            if (!volumeError && volumeData && volumeData.length > 0) {
                const todayVolume = volumeData.reduce((sum, record) => sum + (record.volume_liters || 0), 0);
                document.getElementById('todayVolume').textContent = `${todayVolume} L`;
            } else {
                document.getElementById('todayVolume').textContent = '0 L';
            }
        } catch (error) {
            document.getElementById('todayVolume').textContent = '0 L';
        }

        // Load quality data - handle if table doesn't exist
        try {
            const { data: qualityData, error: qualityError } = await supabase
                .from('quality_tests')
                .select('fat_percentage, protein_percentage')
                .eq('farm_id', userData.farm_id)
                .gte('test_date', new Date().toISOString().split('T')[0]);

            if (!qualityError && qualityData && qualityData.length > 0) {
                // Calculate quality score based on fat and protein percentages
                let totalScore = 0;
                let validTests = 0;
                
                qualityData.forEach(record => {
                    if (record.fat_percentage && record.protein_percentage) {
                        // Quality score: fat (3.0-4.5% ideal) + protein (3.0-3.8% ideal)
                        const fatScore = Math.min(100, Math.max(0, (record.fat_percentage / 4.0) * 100));
                        const proteinScore = Math.min(100, Math.max(0, (record.protein_percentage / 3.5) * 100));
                        const testScore = (fatScore + proteinScore) / 2;
                        totalScore += testScore;
                        validTests++;
                    }
                });
                
                if (validTests > 0) {
                    const avgQuality = totalScore / validTests;
                    document.getElementById('qualityAverage').textContent = `${Math.round(avgQuality)}%`;
                } else {
                    document.getElementById('qualityAverage').textContent = '--%';
                }
            } else {
                document.getElementById('qualityAverage').textContent = '--%';
            }
        } catch (error) {
            console.log('Quality tests table not available or no data');
            document.getElementById('qualityAverage').textContent = '--%';
        }

        // Load financial data - handle if table doesn't exist
        try {
            const { data: financialData, error: financialError } = await supabase
                .from('financial_records')
                .select('amount, type')
                .eq('farm_id', userData.farm_id)
                .eq('type', 'despesa')
                .gte('created_at', new Date(new Date().getFullYear(), new Date().getMonth(), 1).toISOString());

            if (!financialError && financialData && financialData.length > 0) {
                const pendingAmount = financialData.reduce((sum, record) => sum + (record.amount || 0), 0);
                document.getElementById('pendingPayments').textContent = `R$ ${pendingAmount.toLocaleString('pt-BR')}`;
            } else {
                document.getElementById('pendingPayments').textContent = 'R$ 0';
            }
        } catch (error) {
            console.log('Financial records table not available');
            document.getElementById('pendingPayments').textContent = 'R$ 0';
        }

        // Load users data
        try {
            const { data: usersData, error: usersError } = await supabase
                .from('users')
                .select('id')
                .eq('farm_id', userData.farm_id)
                .eq('is_active', true);

            if (!usersError && usersData) {
                document.getElementById('activeUsers').textContent = usersData.length;
            } else {
                document.getElementById('activeUsers').textContent = '0';
            }
        } catch (error) {
            console.log('Users table query failed');
            document.getElementById('activeUsers').textContent = '0';
        }

        // Load recent activities
        console.log('üìã Carregando atividades recentes...');
        await loadRecentActivities(userData.farm_id);
        
        console.log('‚úÖ loadDashboardData conclu√≠da com sucesso!');

    } catch (error) {
        console.error('‚ùå ERRO GERAL em loadDashboardData:', error);
        console.error('Stack trace:', error.stack);
    }
}

// Load volume data from database
async function loadVolumeData() {
    try {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) throw new Error('User not authenticated');

        const { data: volumeUserData, error: userError } = await supabase
            .from('users')
            .select('farm_id')
            .eq('email', user.email)
            .single();
        
        if (userError) {
            console.warn('Error fetching user data for volume:', userError);
            throw userError;
        }

        // Get today's production data
        const today = new Date().toISOString().split('T')[0];
        const { data: todayData, error: todayError } = await supabase
            .from('milk_production')
            .select('volume_liters')
            .eq('farm_id', volumeUserData.farm_id)
            .gte('production_date', today)
            .lte('production_date', today);

        if (todayError) {
            console.warn('Error fetching today data:', todayError);
        }

        // Get week average
        const weekAgo = new Date();
        weekAgo.setDate(weekAgo.getDate() - 7);
        const { data: weekData, error: weekError } = await supabase
            .from('milk_production')
            .select('volume_liters')
            .eq('farm_id', volumeUserData.farm_id)
            .gte('production_date', weekAgo.toISOString().split('T')[0]);

        if (weekError) {
            console.warn('Error fetching week data:', weekError);
        }

        const todayVolume = todayData?.reduce((sum, record) => sum + (record.volume_liters || 0), 0) || 0;
        const weekAvg = weekData?.length > 0 ? 
            weekData.reduce((sum, record) => sum + (record.volume_liters || 0), 0) / weekData.length : 0;
        const growth = weekAvg > 0 ? ((todayVolume - weekAvg) / weekAvg * 100) : 0;
        
        document.getElementById('volumeToday').textContent = `${todayVolume.toFixed(0)} L`;
        document.getElementById('volumeWeekAvg').textContent = `${weekAvg.toFixed(0)} L`;
        document.getElementById('volumeGrowth').textContent = `${growth > 0 ? '+' : ''}${growth.toFixed(1)}%`;
        
        // Buscar a √∫ltima coleta real do banco de dados
        const { data: lastCollectionData, error: lastCollectionError } = await supabase
            .from('milk_production')
            .select('created_at')
            .eq('farm_id', volumeUserData.farm_id)
            .order('created_at', { ascending: false })
            .limit(1);

        if (!lastCollectionError && lastCollectionData && lastCollectionData.length > 0) {
            const lastCollectionTime = new Date(lastCollectionData[0].created_at);
            const dateStr = lastCollectionTime.toLocaleDateString('pt-BR', { 
                day: '2-digit', 
                month: '2-digit', 
                year: 'numeric' 
            });
            const timeStr = lastCollectionTime.toLocaleTimeString('pt-BR', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            document.getElementById('lastCollection').textContent = `${dateStr} - ${timeStr}`;
        } else {
            document.getElementById('lastCollection').textContent = '--/--/---- - --:--';
        }
        
    } catch (error) {
        console.error('Error loading volume data:', error);
        // Set default values on error
        document.getElementById('volumeToday').textContent = '0 L';
        document.getElementById('volumeWeekAvg').textContent = '0 L';
        document.getElementById('volumeGrowth').textContent = '0%';
        document.getElementById('lastCollection').textContent = '--:--';
    }
}

// Load quality data from database
async function loadQualityData() {
    try {
        console.log('üîç loadQualityData iniciado...');
        
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) {
            console.log('‚ùå Usu√°rio n√£o autenticado');
            throw new Error('User not authenticated');
        }

        const { data: qualityUserData, error: userError } = await supabase
            .from('users')
            .select('farm_id')
            .eq('email', user.email)
            .single();
        
        if (userError) {
            console.warn('Error fetching user data for quality:', userError);
            throw userError;
        }

        console.log('‚úÖ Farm ID encontrado para qualidade:', qualityUserData.farm_id);

        // Get latest quality data
        console.log('üîç Buscando dados de qualidade para farm_id:', qualityUserData.farm_id);
        
        const { data: qualityData, error } = await supabase
            .from('quality_tests')
            .select('fat_percentage, protein_percentage, scc, cbt, test_date')
            .eq('farm_id', qualityUserData.farm_id)
            .not('fat_percentage', 'is', null)
            .not('protein_percentage', 'is', null)
            .order('test_date', { ascending: false })
            .limit(30);

        if (error) {
            console.warn('Error fetching quality data:', error);
            throw error;
        }

        console.log('üìä Dados de qualidade recebidos:', qualityData?.length || 0, 'registros');
        console.log('üìã Primeiros 3 registros de qualidade:', qualityData?.slice(0, 3));

        if (qualityData && qualityData.length > 0) {
            // Filter out records with invalid data
            const validQualityData = qualityData.filter(record => 
                record.fat_percentage && 
                record.protein_percentage && 
                !isNaN(record.fat_percentage) && 
                !isNaN(record.protein_percentage)
            );
            
            console.log('‚úÖ Registros v√°lidos para c√°lculo:', validQualityData.length, 'de', qualityData.length);
            
            if (validQualityData.length === 0) {
                console.log('‚ö†Ô∏è Nenhum registro v√°lido encontrado para c√°lculo');
                document.getElementById('fatContent').textContent = '--';
                document.getElementById('proteinContent').textContent = '--';
                document.getElementById('sccCount').textContent = '--';
                document.getElementById('tbc').textContent = '--';
                document.getElementById('qualityAverage').textContent = '--%';
                updateQualityCharts([]);
                return;
            }
            
            const avgFat = validQualityData.reduce((sum, record) => sum + (record.fat_percentage || 0), 0) / validQualityData.length;
            const avgProtein = validQualityData.reduce((sum, record) => sum + (record.protein_percentage || 0), 0) / validQualityData.length;
                            const avgSCC = validQualityData.reduce((sum, record) => sum + (record.scc || 0), 0) / validQualityData.length;
                            const avgTBC = validQualityData.reduce((sum, record) => sum + (record.cbt || 0), 0) / validQualityData.length;
            
            console.log('üìà M√©dias calculadas:', { avgFat, avgProtein, avgSCC, avgTBC });
            
            // Calculate quality score based on industry standards
            let totalScore = 0;
            let validTests = 0;
            
            validQualityData.forEach(record => {
                if (record.fat_percentage && record.protein_percentage) {
                    // Quality scoring based on industry standards
                    // Fat: 3.0-4.5% is excellent, 2.5-3.0% is good, <2.5% is poor
                    // Protein: 3.0-3.8% is excellent, 2.7-3.0% is good, <2.7% is poor
                    
                    let fatScore = 0;
                    if (record.fat_percentage >= 3.0 && record.fat_percentage <= 4.5) {
                        fatScore = 100; // Excellent range
                    } else if (record.fat_percentage >= 2.5 && record.fat_percentage < 3.0) {
                        fatScore = 70; // Good range
                    } else if (record.fat_percentage > 4.5) {
                        fatScore = 80; // Above excellent, still good
                    } else {
                        fatScore = Math.max(0, (record.fat_percentage / 2.5) * 70); // Poor range
                    }
                    
                    let proteinScore = 0;
                    if (record.protein_percentage >= 3.0 && record.protein_percentage <= 3.8) {
                        proteinScore = 100; // Excellent range
                    } else if (record.protein_percentage >= 2.7 && record.protein_percentage < 3.0) {
                        proteinScore = 70; // Good range
                    } else if (record.protein_percentage > 3.8) {
                        proteinScore = 80; // Above excellent, still good
                    } else {
                        proteinScore = Math.max(0, (record.protein_percentage / 2.7) * 70); // Poor range
                    }
                    
                    const testScore = (fatScore + proteinScore) / 2;
                    totalScore += testScore;
                    validTests++;
                }
            });
            
            const avgQuality = validTests > 0 ? totalScore / validTests : 0;
            console.log('üéØ Qualidade m√©dia calculada:', avgQuality.toFixed(1) + '%');
            console.log('üìä Detalhes do c√°lculo:', { totalScore, validTests, avgQuality });
            
            document.getElementById('fatContent').textContent = `${avgFat.toFixed(1)}%`;
            document.getElementById('proteinContent').textContent = `${avgProtein.toFixed(1)}%`;
            document.getElementById('sccCount').textContent = avgSCC > 0 ? `${Math.round(avgSCC / 1000)}k` : '--';
            document.getElementById('tbc').textContent = avgTBC > 0 ? `${Math.round(avgTBC / 1000)}k` : '--';
            document.getElementById('qualityAverage').textContent = `${Math.round(avgQuality)}%`;
            
            console.log('‚úÖ Elementos de qualidade atualizados');
            
            // Update quality charts
            updateQualityCharts(validQualityData);
        } else {
            console.log('‚ö†Ô∏è Nenhum dado de qualidade encontrado');
            document.getElementById('fatContent').textContent = '--';
            document.getElementById('proteinContent').textContent = '--';
            document.getElementById('sccCount').textContent = '--';
            document.getElementById('tbc').textContent = '--';
            document.getElementById('qualityAverage').textContent = '--%';
            
            // Update charts with empty data
            updateQualityCharts([]);
        }
        
    } catch (error) {
        console.error('Error loading quality data:', error);
        // Set default values on error
        document.getElementById('fatContent').textContent = '--';
        document.getElementById('proteinContent').textContent = '--';
        document.getElementById('sccCount').textContent = '--';
        document.getElementById('tbc').textContent = '--';
        document.getElementById('qualityAverage').textContent = '--%';
        
        // Update charts with empty data
        updateQualityCharts([]);
    }
}
// Load sales data from database
async function loadPaymentsData() {
    try {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) throw new Error('User not authenticated');

        const { data: userData, error: userError } = await supabase
            .from('users')
            .select('farm_id')
            .eq('email', user.email)
            .maybeSingle();
        
        if (userError) {
            console.warn('Error fetching user data for sales:', userError);
            throw userError;
        }

        // Get sales data from financial records table
        const { data: salesData, error: salesError } = await supabase
            .from('financial_records')
            .select('amount, type, record_date, created_at, description')
            .eq('farm_id', userData.farm_id)
            .eq('type', 'receita')
            .order('created_at', { ascending: false });

        if (salesError) {
            console.warn('Error fetching sales data:', salesError);
            throw salesError;
        }

        let completedAmount = 0;
        let pendingAmount = 0;
        let overdueAmount = 0;

        if (salesData && salesData.length > 0) {
            // Para financial_records, consideramos todas as receitas como "pagas"
            // pois s√£o registros de transa√ß√µes j√° realizadas
            salesData.forEach(sale => {
                const amount = parseFloat(sale.amount) || 0;
                completedAmount += amount;
            });
        }

        // Update UI elements
        document.getElementById('paidAmount').textContent = `R$ ${completedAmount.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;
        document.getElementById('pendingAmount').textContent = `R$ ${pendingAmount.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;
        document.getElementById('overdueAmount').textContent = `R$ ${overdueAmount.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;
        
        // Update sales chart if it exists
        if (window.paymentsChart && window.paymentsChart.data && window.paymentsChart.data.datasets) {
            window.paymentsChart.data.labels = ['Pagos', 'Pendentes', 'Atrasados'];
            window.paymentsChart.data.datasets[0].data = [completedAmount, pendingAmount, overdueAmount];
            window.paymentsChart.update();
        }
        
    } catch (error) {
        console.error('Error loading sales data:', error);
        // Set default values on error
        document.getElementById('paidAmount').textContent = 'R$ 0,00';
        document.getElementById('pendingAmount').textContent = 'R$ 0,00';
        document.getElementById('overdueAmount').textContent = 'R$ 0,00';
    }
}

// Load users data from database
async function loadUsersData() {
    try {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) throw new Error('User not authenticated');

        let { data: usersUserData, error: userError } = await supabase
            .from('users')
            .select('farm_id')
            .eq('email', user.email)
            .maybeSingle();
        
        if (userError) {
            console.warn('Error fetching user data for users count:', userError);
            throw userError;
        }
        if (!usersUserData) {
            throw new Error('User data not found');
        }

        const { data: usersData, error } = await supabase
            .from('users')
            .select('id, name, email, role, whatsapp, is_active, created_at, profile_photo_url')
            .eq('farm_id', usersUserData.farm_id)
            .order('created_at', { ascending: false });

        if (usersData) {
            const employeesCount = usersData.filter(u => u.role === 'funcionario').length;
            const veterinariansCount = usersData.filter(u => u.role === 'veterinario').length;
            const managersCount = usersData.filter(u => u.role === 'gerente').length;
            const totalUsers = usersData.length;
            
            document.getElementById('totalUsers').textContent = totalUsers;
            document.getElementById('employeesCount').textContent = employeesCount;
            document.getElementById('veterinariansCount').textContent = veterinariansCount;
            document.getElementById('managersCount').textContent = managersCount;
            
        setTimeout(() => {
            displayUsersList(usersData);
            
            document.querySelectorAll('.action-button.permissions').forEach(button => {
                button.addEventListener('click', function(e) {
                    e.preventDefault();
                    const userId = this.getAttribute('data-user-id');
                    const currentStatus = this.getAttribute('data-current-status') === 'true';
                    toggleUserAccess(userId, currentStatus);
                });
            });
        }, 100);
        } else {
            document.getElementById('totalUsers').textContent = '1';
            document.getElementById('employeesCount').textContent = '0';
            document.getElementById('veterinariansCount').textContent = '0';
            document.getElementById('managersCount').textContent = '1';
            displayUsersList([]);
        }
        
    } catch (error) {
        console.error('Error loading users data:', error);
        // Set default values on error
        document.getElementById('totalUsers').textContent = '1';
        document.getElementById('employeesCount').textContent = '0';
        document.getElementById('veterinariansCount').textContent = '0';
        document.getElementById('managersCount').textContent = '1';
        displayUsersList([]);
    }
}

// Load weekly volume chart data
async function loadWeeklyVolumeChart() {
    try {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) return;

        const { data: userData, error: userError } = await supabase
            .from('users')
            .select('farm_id')
            .eq('email', user.email)
            .maybeSingle();
        
        if (userError) {
            console.warn('Error fetching user data for weekly volume:', userError);
            return;
        }

        // Get last 7 days of data
        const endDate = new Date();
        const startDate = new Date();
        startDate.setDate(startDate.getDate() - 6);

        const { data: volumeData, error } = await supabase
            .from('milk_production')
            .select('production_date, volume_liters')
            .eq('farm_id', userData.farm_id)
            .gte('production_date', startDate.toISOString().split('T')[0])
            .lte('production_date', endDate.toISOString().split('T')[0])
            .order('production_date', { ascending: true });

        if (error) {
            console.warn('Error fetching weekly volume data:', error);
            return;
        }

        // Group by date and sum volumes
        const dailyVolumes = {};
        const labels = [];
        
        // Initialize all days with 0
        for (let i = 0; i < 7; i++) {
            const date = new Date(startDate);
            date.setDate(date.getDate() + i);
            const dateStr = date.toISOString().split('T')[0];
            const dayName = date.toLocaleDateString('pt-BR', { weekday: 'short' });
            labels.push(dayName);
            dailyVolumes[dateStr] = 0;
        }

        // Sum volumes by date
        if (volumeData) {
            volumeData.forEach(record => {
                if (dailyVolumes.hasOwnProperty(record.production_date)) {
                    dailyVolumes[record.production_date] += record.volume_liters || 0;
                }
            });
        }

        const data = Object.values(dailyVolumes);
        const hasRealData = data.some(value => value > 0);

        // Update chart
        if (window.weeklyVolumeChart && hasRealData) {
            window.weeklyVolumeChart.data.labels = labels;
            window.weeklyVolumeChart.data.datasets[0].data = data;
            window.weeklyVolumeChart.update();
        }

    } catch (error) {
        console.error('Error loading weekly volume chart:', error);
    }
}

// Load daily volume chart data
async function loadDailyVolumeChart() {
    try {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) return;

        const { data: userData, error: userError } = await supabase
            .from('users')
            .select('farm_id')
            .eq('email', user.email)
            .single();
        
        if (userError) {
            console.warn('Error fetching user data for daily volume:', userError);
            return;
        }

        // Get today's data by shift
        const today = new Date().toISOString().split('T')[0];
        const { data: volumeData, error } = await supabase
            .from('milk_production')
            .select('shift, volume_liters')
            .eq('farm_id', userData.farm_id)
            .eq('production_date', today)
            .order('shift', { ascending: true });

        if (error) {
            console.warn('Error fetching daily volume data:', error);
            return;
        }

        // Group by shift
        const shiftVolumes = {
            'manha': 0,
            'tarde': 0,
            'noite': 0
        };

        if (volumeData) {
            volumeData.forEach(record => {
                if (shiftVolumes.hasOwnProperty(record.shift)) {
                    shiftVolumes[record.shift] += record.volume_liters || 0;
                }
            });
        }

        const labels = ['Manh√£', 'Tarde', 'Noite'];
        const data = [shiftVolumes.manha, shiftVolumes.tarde, shiftVolumes.noite];

        // Update chart
        if (window.dailyVolumeChart) {
            window.dailyVolumeChart.data.labels = labels;
            window.dailyVolumeChart.data.datasets[0].data = data;
            window.dailyVolumeChart.update();
        }

    } catch (error) {
        console.error('Error loading daily volume chart:', error);
    }
}

// Load monthly volume chart data (only shows on last day of month)
async function loadMonthlyVolumeChart() {
    try {
        const now = new Date();
        const lastDayOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);
        
        // Only show monthly chart on the last day of the month
        if (now.getDate() !== lastDayOfMonth.getDate()) {
            return;
        }
        
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) return;

        const { data: userData, error: userError } = await supabase
            .from('users')
            .select('farm_id')
            .eq('email', user.email)
            .single();
        
        if (userError) {
            console.warn('Error fetching user data for monthly volume:', userError);
            return;
        }

        // Get last 12 months of data
        const endDate = new Date();
        const startDate = new Date();
        startDate.setMonth(startDate.getMonth() - 11);
        startDate.setDate(1);

        const { data: volumeData, error } = await supabase
            .from('milk_production')
            .select('production_date, volume_liters')
            .eq('farm_id', userData.farm_id)
            .gte('production_date', startDate.toISOString().split('T')[0])
            .lte('production_date', endDate.toISOString().split('T')[0])
            .order('production_date', { ascending: true });

        if (error) {
            console.warn('Error fetching monthly volume data:', error);
            return;
        }

        // Group by month and sum volumes
        const monthlyVolumes = {};
        const labels = [];
        
        // Initialize all months with 0
        for (let i = 0; i < 12; i++) {
            const date = new Date(startDate);
            date.setMonth(date.getMonth() + i);
            const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
            const monthName = date.toLocaleDateString('pt-BR', { month: 'short', year: '2-digit' });
            labels.push(monthName);
            monthlyVolumes[monthKey] = 0;
        }

        // Sum volumes by month
        if (volumeData) {
            volumeData.forEach(record => {
                const date = new Date(record.production_date);
                const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                if (monthlyVolumes.hasOwnProperty(monthKey)) {
                    monthlyVolumes[monthKey] += record.volume_liters || 0;
                }
            });
        }
        const data = Object.values(monthlyVolumes);

        // Show monthly chart container and update chart
        const monthlyChartContainer = document.getElementById('monthlyVolumeChartContainer');
        if (monthlyChartContainer) {
            monthlyChartContainer.style.display = 'block';
            
            if (window.monthlyVolumeChart) {
                window.monthlyVolumeChart.data.labels = labels;
                window.monthlyVolumeChart.data.datasets[0].data = data;
                window.monthlyVolumeChart.update();
            }
        }

    } catch (error) {
        console.error('Error loading monthly volume chart:', error);
    }
}

// Load weekly summary chart (only shows on Sundays)
async function loadWeeklySummaryChart() {
    try {
        const now = new Date();
        
        // Only show weekly summary on Sundays (0 = Sunday)
        if (now.getDay() !== 0) {
            return;
        }
        
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) return;

        const { data: userData, error: userError } = await supabase
            .from('users')
            .select('farm_id')
            .eq('email', user.email)
            .single();
        
        if (userError) {
            console.warn('Error fetching user data for weekly summary:', userError);
            return;
        }

        // Get last 8 weeks of data
        const endDate = new Date();
        const startDate = new Date();
        startDate.setDate(startDate.getDate() - 56); // 8 weeks

        const { data: volumeData, error } = await supabase
            .from('milk_production')
            .select('production_date, volume_liters')
            .eq('farm_id', userData.farm_id)
            .gte('production_date', startDate.toISOString().split('T')[0])
            .lte('production_date', endDate.toISOString().split('T')[0])
            .order('production_date', { ascending: true });

        if (error) {
            console.warn('Error fetching weekly summary data:', error);
            return;
        }

        // Group by week and sum volumes
        const weeklyVolumes = {};
        const labels = [];
        
        // Initialize all weeks with 0
        for (let i = 0; i < 8; i++) {
            const weekStart = new Date(startDate);
            weekStart.setDate(weekStart.getDate() + (i * 7));
            const weekKey = getWeekKey(weekStart);
            const weekLabel = `Sem ${i + 1}`;
            labels.push(weekLabel);
            weeklyVolumes[weekKey] = 0;
        }

        // Sum volumes by week
        if (volumeData) {
            volumeData.forEach(record => {
                const date = new Date(record.production_date);
                const weekKey = getWeekKey(date);
                if (weeklyVolumes.hasOwnProperty(weekKey)) {
                    weeklyVolumes[weekKey] += record.volume_liters || 0;
                }
            });
        }

        const data = Object.values(weeklyVolumes);

        // Show weekly summary chart container and update chart
        const weeklySummaryContainer = document.getElementById('weeklySummaryChartContainer');
        if (weeklySummaryContainer) {
            weeklySummaryContainer.style.display = 'block';
            
            if (window.weeklySummaryChart) {
                window.weeklySummaryChart.data.labels = labels;
                window.weeklySummaryChart.data.datasets[0].data = data;
                window.weeklySummaryChart.update();
            }
        }

    } catch (error) {
        console.error('Error loading weekly summary chart:', error);
    }
}

// Helper function to get week key
function getWeekKey(date) {
    const startOfWeek = new Date(date);
    startOfWeek.setDate(date.getDate() - date.getDay());
    return startOfWeek.toISOString().split('T')[0];
}

// Load dashboard volume chart (last 7 days)
async function loadDashboardVolumeChart() {
    try {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) return;

        const { data: userData, error: userError } = await supabase
            .from('users')
            .select('farm_id')
            .eq('email', user.email)
            .single();
        
        if (userError) {
            console.warn('Error fetching user data for dashboard volume chart:', userError);
            return;
        }

        // Get last 7 days of data
        const endDate = new Date();
        const startDate = new Date();
        startDate.setDate(startDate.getDate() - 6);

        const { data: volumeData, error } = await supabase
            .from('milk_production')
            .select('production_date, volume_liters')
            .eq('farm_id', userData.farm_id)
            .gte('production_date', startDate.toISOString().split('T')[0])
            .lte('production_date', endDate.toISOString().split('T')[0])
            .order('production_date', { ascending: true });

        if (error) {
            console.warn('Error fetching dashboard volume data:', error);
            return;
        }

        // Group by date and sum volumes
        const dailyVolumes = {};
        const labels = [];
        
        // Initialize all days with 0
        for (let i = 0; i < 7; i++) {
            const date = new Date(startDate);
            date.setDate(date.getDate() + i);
            const dateStr = date.toISOString().split('T')[0];
            const dayName = date.toLocaleDateString('pt-BR', { weekday: 'short' });
            labels.push(dayName);
            dailyVolumes[dateStr] = 0;
        }

        // Sum volumes by date
        if (volumeData) {
            volumeData.forEach(record => {
                if (dailyVolumes.hasOwnProperty(record.production_date)) {
                    dailyVolumes[record.production_date] += record.volume_liters || 0;
                }
            });
        }

        const data = Object.values(dailyVolumes);
        const hasRealData = data.some(value => value > 0);

        // Update chart
        if (window.volumeChart && hasRealData) {
            // Restore canvas if it was replaced by message
            const chartContainer = document.querySelector('#volumeChart').parentElement;
            if (chartContainer && !chartContainer.querySelector('canvas')) {
                chartContainer.innerHTML = '<canvas id="volumeChart"></canvas>';
                // Reinitialize chart
                const volumeCtx = document.getElementById('volumeChart');
                if (volumeCtx) {
                    window.volumeChart = new Chart(volumeCtx, {
                        type: 'line',
                        data: {
                            labels: [],
                            datasets: [{
                                label: 'Volume (L)',
                                data: [],
                                borderColor: '#369e36',
                                backgroundColor: 'rgba(54, 158, 54, 0.1)',
                                tension: 0.4,
                                fill: true
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: false
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            }
                        }
                    });
                }
            }
            
            window.volumeChart.data.labels = labels;
            window.volumeChart.data.datasets[0].data = data;
            window.volumeChart.update();
            console.log('Dashboard volume chart updated successfully with data');
        } else if (window.volumeChart) {
            console.log('No volume data available for dashboard chart');
            // Show informative message in chart container
            const chartContainer = document.querySelector('#volumeChart').parentElement;
            if (chartContainer) {
                const totalRecords = volumeData?.length || 0;
                const recordsWithVolume = volumeData?.filter(r => r.volume_liters > 0).length || 0;
                
                chartContainer.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-64 text-center">
                        <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mb-4">
                            <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path>
                            </svg>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-900 mb-2">Sem Dados de Volume</h3>
                        <p class="text-gray-500 text-sm">Nenhum registro com volume foi encontrado nos √∫ltimos 7 dias.</p>
                        <p class="text-gray-400 text-xs mt-1">
                            Total de registros: ${totalRecords} | Com volume: ${recordsWithVolume}
                        </p>
                        <p class="text-gray-400 text-xs mt-1">Os dados aparecer√£o aqui quando houver registros com volume.</p>
                    </div>
                `;
            }
        }

    } catch (error) {
        console.error('Error loading dashboard volume chart:', error);
    }
}

// Load dashboard weekly production chart (last 7 days)
async function loadDashboardWeeklyChart() {
    try {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) return;

        const { data: userData, error: userError } = await supabase
            .from('users')
            .select('farm_id')
            .eq('email', user.email)
            .single();
        
        if (userError) {
            console.warn('Error fetching user data for dashboard weekly chart:', userError);
            return;
        }

        // Get last 7 days of data
        const endDate = new Date();
        const startDate = new Date();
        startDate.setDate(startDate.getDate() - 6);

        const { data: productionData, error } = await supabase
            .from('milk_production')
            .select('production_date, volume_liters')
            .eq('farm_id', userData.farm_id)
            .gte('production_date', startDate.toISOString().split('T')[0])
            .lte('production_date', endDate.toISOString().split('T')[0])
            .order('production_date', { ascending: true });

        if (error) {
            console.warn('Error fetching dashboard weekly production data:', error);
            return;
        }

        // Group by date and sum volumes
        const dailyProduction = {};
        const labels = [];
        
        // Initialize all days with 0
        for (let i = 0; i < 7; i++) {
            const date = new Date(startDate);
            date.setDate(date.getDate() + i);
            const dateStr = date.toISOString().split('T')[0];
            const dayName = date.toLocaleDateString('pt-BR', { weekday: 'short' });
            labels.push(dayName);
            dailyProduction[dateStr] = 0;
        }

        // Sum production by date
        if (productionData) {
            productionData.forEach(record => {
                if (dailyProduction.hasOwnProperty(record.production_date)) {
                    dailyProduction[record.production_date] += record.volume_liters || 0;
                }
            });
        }

        const data = Object.values(dailyProduction);

        // Update chart
        if (window.dashboardWeeklyChart) {
            window.dashboardWeeklyChart.data.labels = labels;
            window.dashboardWeeklyChart.data.datasets[0].data = data;
            window.dashboardWeeklyChart.update();
        }

    } catch (error) {
        console.error('Error loading dashboard weekly chart:', error);
    }
}

// Helper function to get time ago text
function getTimeAgo(minutesAgo) {
    if (minutesAgo < 60) {
        return `${minutesAgo}min atr√°s`;
    } else if (minutesAgo < 1440) {
        const hours = Math.floor(minutesAgo / 60);
        return `${hours}h atr√°s`;
    } else {
        const days = Math.floor(minutesAgo / 1440);
        return `${days}d atr√°s`;
    }
}
// Load recent activities
// Function removed - now using loadRecentActivities(farmId) version only

// Function to display users list
function displayUsersList(users) {
    console.log('=== DEBUG: displayUsersList iniciado ===');
    console.log('DEBUG: Usu√°rios recebidos:', users?.map(u => ({ 
        id: u.id, 
        name: u.name, 
        role: u.role,
        profile_photo_url: u.profile_photo_url 
    })));
    const usersList = document.getElementById('usersList');
    
    if (!users || users.length === 0) {
        usersList.innerHTML = `
            <div class="text-center py-12">
                <div class="w-20 h-20 bg-gray-100    rounded-full flex items-center justify-center mx-auto mb-6">
                    <svg class="w-10 h-10 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                    </svg>
                </div>
                <h3 class="text-lg font-semibold text-gray-900    mb-2">Nenhum Usu√°rio Cadastrado</h3>
                <p class="text-gray-600    mb-4">Adicione usu√°rios para gerenciar sua equipe</p>
                <button onclick="addUser()" class="px-6 py-3 gradient-forest text-white font-semibold rounded-xl hover:shadow-lg transition-all">
                    <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                    </svg>
                    Adicionar Primeiro Usu√°rio
                </button>
            </div>
        `;
        return;
    }
    
    const usersHtml = users.map(user => {
        
        const roleText = {
            'gerente': 'Gerente',
            'funcionario': 'Funcion√°rio',
            'veterinario': 'Veterin√°rio',
            'proprietario': 'Propriet√°rio'
        }[user.role] || user.role;
        
        const roleColor = {
            'gerente': 'bg-blue-100 text-blue-800',
            'funcionario': 'bg-green-100 text-green-800',
            'veterinario': 'bg-purple-100 text-purple-800',
            'proprietario': 'bg-yellow-100 text-yellow-800'
        }[user.role] || 'bg-gray-100 text-gray-800';
        
        const statusColor = user.is_active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
        const statusText = user.is_active ? 'Ativo' : 'Inativo';
        
        const showPhoto = user.profile_photo_url && user.profile_photo_url.trim() !== '';
        
        return `
            <div class="user-card">
                <div class="user-card-header">
                    <div class="user-info">
                        <div class="user-avatar">
                            ${showPhoto ? 
                                `<img id="user-photo-${user.id}" src="${user.profile_photo_url}?t=${Date.now()}" alt="Foto de ${user.name}" class="w-full h-full object-cover" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" onload="this.nextElementSibling.style.display='none';">
                                <div id="user-icon-${user.id}" class="w-full h-full bg-gradient-to-br from-forest-500 to-forest-600 flex items-center justify-center absolute inset-0" style="display: flex;">
                                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                    </svg>
                                </div>` :
                                `<div id="user-icon-${user.id}" class="w-full h-full bg-gradient-to-br from-forest-500 to-forest-600 flex items-center justify-center">
                                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                    </svg>
                                </div>`
                            }
                        </div>
                        <div class="user-details">
                            <div class="user-name">${user.name}</div>
                            <div class="user-email">${user.email}</div>
                            <div class="user-phone">${user.whatsapp || 'WhatsApp n√£o informado'}</div>
                        </div>
                    </div>
                    <div class="user-status">
                        <span class="status-badge role ${roleColor}">${roleText}</span>
                        <span class="status-badge active ${statusColor}">${statusText}</span>
                    </div>
                </div>
                <div class="user-card-footer">
                    <div class="user-created">Criado em: ${new Date(user.created_at).toLocaleDateString('pt-BR')}</div>
                    <div class="user-actions">
                        <button onclick="editUser('${user.id}')" class="action-button edit" title="Editar usu√°rio">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                            </svg>
                        </button>
                        <button onclick="toggleUserAccess('${user.id}', ${user.is_active})" class="action-button permissions ${!user.is_active ? 'blocked' : ''}" title="${user.is_active ? 'Bloquear acesso' : 'Desbloquear acesso'}" data-user-id="${user.id}" data-current-status="${user.is_active}">
                            ${user.is_active ? 
                                '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>' :
                                '<svg class="w-4 h-4 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 11V7a4 4 0 018 0m-4 8v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2z"></path></svg>'
                            }
                        </button>
                        <button onclick="deleteUser('${user.id}', '${user.name.replace(/'/g, "\\'").replace(/"/g, '\\"')}')" class="action-button delete" title="Excluir usu√°rio">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        `;
    }).join('');
    
    usersList.innerHTML = usersHtml;
}

// Function to edit user
async function editUser(userId) {
    try {
        // Buscar dados do funcion√°rio pelo ID selecionado
        const { data: user, error } = await supabase
            .from('users')
            .select('*')
            .eq('id', userId)
            .single();
        if (error) throw error;
        // Sempre criar uma c√≥pia do objeto
        const funcionario = { ...user };
        // Preencher campos do modal de edi√ß√£o
        document.getElementById('editUserId').value = funcionario.id;
        document.getElementById('editUserName').value = funcionario.name;
        document.getElementById('editUserEmail').value = funcionario.email;
        document.getElementById('editUserWhatsapp').value = funcionario.whatsapp || '';
        document.getElementById('editUserRole').value = funcionario.role;
        // Atualizar preview da foto baseado no role
        const editPreview = document.getElementById('editProfilePreview');
        const editPlaceholder = document.getElementById('editProfilePlaceholder');
        const photoSection = document.getElementById('editPhotoSection');
        
        if (photoSection) {
            if (funcionario.role === 'funcionario') {
                photoSection.classList.remove('hidden');
                
                if (funcionario.profile_photo_url && editPreview && editPlaceholder) {
                    const uniqueTimestamp = Date.now() + '_' + funcionario.id + '_' + Math.random().toString(36).substr(2, 9);
                    editPreview.src = funcionario.profile_photo_url + '?t=' + uniqueTimestamp;
                    editPreview.classList.remove('hidden');
                    editPlaceholder.classList.add('hidden');
                } else if (editPreview && editPlaceholder) {
                    editPreview.classList.add('hidden');
                    editPlaceholder.classList.remove('hidden');
                    editPreview.src = '';
                }
            } else {
                photoSection.classList.add('hidden');
            }
        }
        openEditUserModal();
    } catch (error) {
        console.error('Error loading user data:', error);
        showNotification('Erro ao carregar dados do usu√°rio', 'error');
    }
}

// Function to toggle user access
async function toggleUserAccess(userId, currentStatus) {
    try {
        console.log('toggleUserAccess called with:', { userId, currentStatus });
        
        // Validate inputs
        if (!userId) {
            throw new Error('User ID is required');
        }
        
        const newStatus = !currentStatus;
        const action = newStatus ? 'desbloqueado' : 'bloqueado';
        
        console.log('Attempting to update user status to:', newStatus);
        
        // First, let's check if the user exists and get current data
        const { data: currentUser, error: fetchError } = await supabase
            .from('users')
            .select('*')
            .eq('id', userId)
            .single();
            
        if (fetchError) {
            console.error('Error fetching user:', fetchError);
            throw new Error('Usu√°rio n√£o encontrado');
        }
        
        console.log('Current user data:', currentUser);
        
        // Now update the user status
        const { data, error } = await supabase
            .from('users')
            .update({ is_active: newStatus })
            .eq('id', userId)
            .select();
            
        console.log('Supabase update response:', { data, error });
        
        if (error) {
            console.error('Supabase error:', error);
            throw error;
        }
        
        console.log('User status updated successfully');
        showNotification(`Acesso do usu√°rio ${action} com sucesso!`, 'success');
        
        // Reload users list with a small delay to ensure the update is processed
        setTimeout(async () => {
            await loadUsersData();
        }, 500);
        
    } catch (error) {
        console.error('Error toggling user access:', error);
        showNotification('Erro ao alterar acesso do usu√°rio: ' + (error.message || error), 'error');
    }
}

// Test function for debugging user blocking
async function testUserBlocking() {
    try {
        console.log('Testing user blocking functionality...');
        
        // Get current user data
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) {
            console.error('No authenticated user');
            return;
        }
        
        console.log('Current authenticated user:', user);
        
        // Get farm users
        const { data: usersData, error } = await supabase
            .from('users')
            .select('*')
            .eq('email', user.email)
            .single();
            
        if (error) {
            console.error('Error fetching current user data:', error);
            return;
        }
        
        console.log('Current user farm data:', usersData);
        
        // Get all users from the same farm
        const { data: farmUsers, error: farmUsersError } = await supabase
            .from('users')
            .select('*')
            .eq('farm_id', usersData.farm_id);
            
        if (farmUsersError) {
            console.error('Error fetching farm users:', farmUsersError);
            return;
        }
        
        console.log('All farm users:', farmUsers);
        
        // Test blocking the first non-manager user
        const testUser = farmUsers.find(u => u.role !== 'gerente' && u.id !== usersData.id);
        
        if (testUser) {
            console.log('Testing with user:', testUser);
            await toggleUserAccess(testUser.id, testUser.is_active);
        } else {
            console.log('No suitable test user found');
        }
        
    } catch (error) {
        console.error('Test error:', error);
    }
}

// Make test function available globally
window.testUserBlocking = testUserBlocking;

// Vari√°vel para armazenar dados do usu√°rio a ser exclu√≠do
let userToDelete = null;

// Function to delete user (usa confirm simples)
function deleteUser(userId, userName) {
    // Verificar se os par√¢metros s√£o v√°lidos
    if (!userId || !userName) {
        console.error('deleteUser: Par√¢metros inv√°lidos', { userId, userName });
        return;
    }
    
    // Verificar se n√£o √© uma chamada acidental
    if (typeof userId !== 'string' || typeof userName !== 'string') {
        console.error('deleteUser: Tipos de par√¢metros inv√°lidos', { userId: typeof userId, userName: typeof userName });
        return;
    }
    
    // Verificar se n√£o √© uma chamada autom√°tica (deve ser chamada por clique do usu√°rio)
    if (!event || !event.isTrusted) {
        console.error('deleteUser: Chamada n√£o autorizada - deve ser iniciada por clique do usu√°rio');
        return;
    }
    
    // Verifica√ß√£o adicional: garantir que n√£o √© uma chamada autom√°tica
    const stack = new Error().stack;
    if (stack && (stack.includes('setTimeout') || stack.includes('setInterval') || stack.includes('Promise'))) {
        console.error('deleteUser: Chamada autom√°tica detectada, bloqueando');
        return;
    }
    
    // Usar confirm simples em vez do modal
    const confirmed = confirm(`Tem certeza que deseja excluir o usu√°rio "${userName}"?\n\nEsta a√ß√£o n√£o pode ser desfeita.`);
    
    if (confirmed) {
        console.log('Usu√°rio confirmou exclus√£o:', userName);
        // Executar exclus√£o diretamente
        executeDeleteUser(userId, userName);
    } else {
        console.log('Usu√°rio cancelou exclus√£o');
    }
}

// Fun√ß√£o para executar a exclus√£o
async function executeDeleteUser(userId, userName) {
    try {
        console.log('Executando exclus√£o do usu√°rio:', userName);
        
        const { data, error } = await supabase
            .from('users')
            .delete()
            .eq('id', userId);
            
        if (error) {
            console.error('Erro ao excluir usu√°rio:', error);
            showNotification('Erro ao excluir usu√°rio: ' + error.message, 'error');
            return;
        }
        
        console.log('Usu√°rio exclu√≠do com sucesso');
        showNotification(`Usu√°rio "${userName}" exclu√≠do com sucesso!`, 'success');
        await loadUsersData(); // Reload users list
        
    } catch (error) {
        console.error('Erro ao excluir usu√°rio:', error);
        showNotification('Erro ao excluir usu√°rio: ' + error.message, 'error');
    }
}

// Function to close delete confirmation modal (n√£o mais necess√°ria)
function closeDeleteUserModal() {
    console.log('Fun√ß√£o closeDeleteUserModal n√£o √© mais necess√°ria - usando confirm simples');
}

// Adicionar listener para fechar modal com ESC
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        const deleteModal = document.getElementById('deleteUserModal');
        if (deleteModal && !deleteModal.classList.contains('hidden')) {
            closeDeleteUserModal();
            console.log('Modal de exclus√£o fechado com ESC');
        }
    }
});

// Prevenir abertura acidental do modal
window.addEventListener('error', function(event) {
    const deleteModal = document.getElementById('deleteUserModal');
    if (deleteModal && !deleteModal.classList.contains('hidden')) {
        deleteModal.classList.add('hidden');
        console.log('Modal fechado devido a erro JavaScript:', event.error);
    }
});



// Function to confirm user deletion (n√£o mais necess√°ria)
async function confirmDeleteUser() {
    console.log('Fun√ß√£o confirmDeleteUser n√£o √© mais necess√°ria - usando confirm simples');
}
// Function to handle edit user form submission
async function handleEditUser(e) {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const userId = formData.get('id'); // Corrigido para 'id' conforme o input hidden
    const name = formData.get('name');
    const whatsapp = formData.get('whatsapp');
    const role = formData.get('role');
    const password = formData.get('password');
    
    try {
        // Preparar dados para atualiza√ß√£o
        const updateData = {
            name: name,
            whatsapp: whatsapp || null,
            role: role
        };
        
        // Nota: Senhas s√£o gerenciadas pelo Supabase Auth, n√£o pela tabela users
        // Se uma nova senha foi fornecida, ela deve ser atualizada via supabase.auth.updateUser
        if (password && password.trim() !== '') {
            // TODO: Implementar atualiza√ß√£o de senha via Supabase Auth se necess√°rio
            console.log('Senha fornecida, mas n√£o ser√° atualizada via tabela users');
        }
        
        // Handle profile photo upload if provided and role is funcionario
        if (role === 'funcionario') {
            const profilePhotoFile = formData.get('profilePhoto');
            if (profilePhotoFile && profilePhotoFile.size > 0) {
                try {
                    const profilePhotoUrl = await uploadProfilePhoto(profilePhotoFile, userId);
                    updateData.profile_photo_url = profilePhotoUrl;
                } catch (photoError) {
                    console.error('Error uploading profile photo:', photoError);
                    // Don't show error notification for photo upload - user update is more important
                    // showNotification('Erro ao fazer upload da foto de perfil, mas outros dados ser√£o atualizados', 'warning');
                }
            }
        } else {
            updateData.profile_photo_url = null;
        }
        
        const { error } = await supabase
            .from('users')
            .update(updateData)
            .eq('id', userId);
            
        if (error) throw error;
        
        showNotification('Usu√°rio atualizado com sucesso!', 'success');
        closeEditUserModal();
        
        // Update users list without reloading photos to prevent conflicts
        setTimeout(async () => {
            await refreshUsersListOnly();
        }, 500);
        
        // Atualizar foto na lista se foi alterada
        if (updateData.profile_photo_url) {
            setTimeout(async () => {
                await updateUserPhotoInList(userId, updateData.profile_photo_url);
            }, 600);
        }
        
    } catch (error) {
        console.error('Error updating user:', error);
        showNotification('Erro ao atualizar usu√°rio', 'error');
    }
}

// Function to open edit user modal
function openEditUserModal() {
    document.getElementById('editUserModal').classList.add('show');
}

// Function to close edit user modal
function closeEditUserModal() {
    document.getElementById('editUserModal').classList.remove('show');
    document.getElementById('editUserForm').reset();
}

// Fun√ß√£o para preview de foto no add user
function previewProfilePhoto(input) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('profilePreview').src = e.target.result;
            document.getElementById('profilePreview').classList.remove('hidden');
            document.getElementById('profilePlaceholder').classList.add('hidden');
        };
        reader.readAsDataURL(input.files[0]);
    }
}

// Fun√ß√£o para preview de foto no edit user
function previewEditProfilePhoto(input) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('editProfilePreview').src = e.target.result;
            document.getElementById('editProfilePreview').classList.remove('hidden');
            document.getElementById('editProfilePlaceholder').classList.add('hidden');
        };
        reader.readAsDataURL(input.files[0]);
    }
}

let currentMode = '';

function openPhotoChoiceModal(mode) {
    currentMode = mode;
    const modal = document.getElementById('photoChoiceModal');
    modal.classList.remove('hidden');
    
    // Pequeno delay para permitir a transi√ß√£o
    setTimeout(() => {
        modal.classList.add('show');
    }, 10);
}

function closePhotoChoiceModal() {
    const modal = document.getElementById('photoChoiceModal');
    modal.classList.remove('show');
    
    // Aguarda a anima√ß√£o terminar antes de esconder
    setTimeout(() => {
        modal.classList.add('hidden');
        currentMode = '';
    }, 300);
}

function choosePhotoSource(source) {
    let inputId = currentMode === 'add' ? 'profilePhotoInput' : 'editProfilePhoto';
    let input = document.getElementById(inputId);
    
    if (source === 'camera') {
        input.setAttribute('capture', 'environment');
    } else {
        input.removeAttribute('capture');
    }
    
    input.click();
    closePhotoChoiceModal();
}

// Fun√ß√£o para adicionar foto no cadastro de novo usu√°rio
function addPhotoToNewUser() {
    openPhotoChoiceModal('add');
}

// Fun√ß√£o para adicionar foto na edi√ß√£o de usu√°rio
function addPhotoToEditUser() {
    openPhotoChoiceModal('edit');
}

// Setup event listeners
function setupEventListeners() {
    // Listener para role no add user
    const userRoleSelect = document.getElementById('userRole');
    if (userRoleSelect) {
        userRoleSelect.addEventListener('change', function() {
            const addPhotoSection = document.getElementById('addPhotoSection');
            if (this.value === 'funcionario') {
                addPhotoSection.classList.remove('hidden');
            } else {
                addPhotoSection.classList.add('hidden');
            }
        });
    }
    
    // Listener para role no edit user
    const editUserRoleSelect = document.getElementById('editUserRole');
    if (editUserRoleSelect) {
        editUserRoleSelect.addEventListener('change', function() {
            const editPhotoSection = document.getElementById('editPhotoSection');
            if (this.value === 'funcionario') {
                editPhotoSection.classList.remove('hidden');
            } else {
                editPhotoSection.classList.add('hidden');
            }
        });
    }
    
    // Tab switching for both desktop and mobile
    const navItems = document.querySelectorAll('.nav-item, .mobile-nav-item');
    
    navItems.forEach(item => {
        item.addEventListener('click', function(e) {
            e.preventDefault();
            const targetTab = this.getAttribute('data-tab');
            
            if (targetTab) {
                // Remove active class from all nav items
                navItems.forEach(nav => nav.classList.remove('active'));
                
                // Add active class to clicked item
                this.classList.add('active');
                
                // Hide all tab contents
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.add('hidden');
                });
                
                // Show target tab content
                const targetContent = document.getElementById(targetTab + '-tab');
                if (targetContent) {
                    targetContent.classList.remove('hidden');
                }
            }
        });
    });

    // Form submissions
    const passwordForm = document.getElementById('changePasswordForm');
    if (passwordForm) {
        passwordForm.addEventListener('submit', handlePasswordChange);
    }

    // Add user form submission
    const addUserForm = document.getElementById('addUserForm');
    if (addUserForm) {
        addUserForm.addEventListener('submit', handleAddUser);
    }

    // Update profile form submission
    const updateProfileForm = document.getElementById('updateProfileForm');
    if (updateProfileForm) {
        updateProfileForm.addEventListener('submit', handleUpdateProfile);
    }

    // Edit user form submission
    const editUserForm = document.getElementById('editUserForm');
    if (editUserForm) {
        editUserForm.addEventListener('submit', handleEditUser);
    }

    // Email preview update
    const userNameInput = document.getElementById('userName');
    if (userNameInput) {
        userNameInput.addEventListener('input', function() {
            updateEmailPreview(this.value);
        });
    }
}

// Handle password change
async function handlePasswordChange(e) {
    e.preventDefault();
    const formData = new FormData(e.target);
    const currentPassword = formData.get('current_password');
    const newPassword = formData.get('new_password');
    const confirmPassword = formData.get('confirm_password');

    if (newPassword !== confirmPassword) {
        showNotification('As senhas n√£o coincidem', 'error');
        return;
    }

    try {
        const { error } = await supabase.auth.updateUser({
            password: newPassword
        });

        if (error) throw error;

        showNotification('Senha alterada com sucesso!', 'success');
        e.target.reset();

    } catch (error) {
        console.error('Error changing password:', error);
        showNotification('Erro ao alterar senha', 'error');
    }
}

// Global chart instances
let qualityTrendChart = null;
let qualityDistributionChart = null;

// Load volume records table
async function loadVolumeRecords() {
    try {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) throw new Error('User not authenticated');

        const { data: userData, error: userError } = await supabase
            .from('users')
            .select('farm_id')
            .eq('email', user.email)
            .single();
        
        if (userError) {
            console.warn('Error fetching user data for volume records:', userError);
            throw userError;
        }

        // Get volume records data
        const { data: volumeRecords, error } = await supabase
            .from('milk_production')
            .select(`
                *,
                users(name)
            `)
            .eq('farm_id', userData.farm_id)
            .order('production_date', { ascending: false })
            .limit(20);

        if (error) {
            console.warn('Error fetching volume records:', error);
        }

        displayVolumeRecords(volumeRecords || []);
        
    } catch (error) {
        console.error('Error loading volume records:', error);
        displayVolumeRecords([]);
    }
}
// Display volume records in table
function displayVolumeRecords(records) {
    const tbody = document.getElementById('volumeRecords');
    
    if (!records || records.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="5" class="px-6 py-12 text-center text-gray-500">
                    <div class="flex flex-col items-center">
                        <svg class="w-12 h-12 text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        <p class="text-lg font-medium mb-2">Nenhum registro de volume encontrado</p>
                        <p class="text-sm">Adicione registros de produ√ß√£o para monitorar o volume</p>
                    </div>
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = records.map(record => {
        const recordDate = new Date(record.production_date).toLocaleDateString('pt-BR');
        const recordTime = new Date(record.created_at).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
        const volume = record.volume_liters ? `${record.volume_liters.toFixed(1)}L` : '--';
        const userName = record.users?.name || '--';
        const notes = record.notes || '--';
        
        return `
            <tr class="hover:bg-gray-50">
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${recordDate} ${recordTime}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${volume}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${userName}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${notes}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm">
                    <button onclick="deleteVolumeRecord('${record.id}')" class="text-red-600 hover:text-red-800 font-medium">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                    </button>
                </td>
            </tr>
        `;
    }).join('');
}

// Load quality tests table
async function loadQualityTests() {
    try {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) throw new Error('User not authenticated');

        const { data: qualityUserData, error: userError } = await supabase
            .from('users')
            .select('farm_id')
            .eq('email', user.email)
            .single();
        
        if (userError) {
            console.warn('Error fetching user data for quality tests:', userError);
            throw userError;
        }

        // Get quality tests data
        const { data: qualityTests, error } = await supabase
            .from('quality_tests')
            .select('*')
            .eq('farm_id', qualityUserData.farm_id)
            .order('test_date', { ascending: false })
            .limit(20);

        if (error) {
            console.warn('Error fetching quality tests:', error);
        }

        displayQualityTests(qualityTests || []);
        
    } catch (error) {
        console.error('Error loading quality tests:', error);
        displayQualityTests([]);
    }
}

// Display quality tests in table
function displayQualityTests(tests) {
    const tbody = document.getElementById('qualityTests');
    
    if (!tests || tests.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="6" class="px-6 py-12 text-center text-gray-500">
                    <div class="flex flex-col items-center">
                        <svg class="w-12 h-12 text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        <p class="text-lg font-medium mb-2">Nenhum teste de qualidade encontrado</p>
                        <p class="text-sm">Adicione testes de qualidade para monitorar a qualidade do leite</p>
                    </div>
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = tests.map(test => {
        const testDate = new Date(test.test_date).toLocaleDateString('pt-BR');
        const fatPercentage = test.fat_percentage ? `${test.fat_percentage.toFixed(1)}%` : '--';
        const proteinPercentage = test.protein_percentage ? `${test.protein_percentage.toFixed(1)}%` : '--';
                        const sccCount = test.scc ? `${Math.round(test.scc / 1000)}k` : '--';
                        const tbcCount = test.cbt ? `${Math.round(test.cbt / 1000)}k` : '--';
        const laboratory = test.laboratory || '--';
        
        // Determine quality grade based on values
        let qualityGrade = 'A';
        let gradeColor = 'bg-green-100 text-green-800';
        
        if (test.fat_percentage < 3.0 || test.protein_percentage < 2.9 || 
                            (test.scc && test.scc > 400000) ||
                            (test.cbt && test.cbt > 100000)) {
            qualityGrade = 'C';
            gradeColor = 'bg-red-100 text-red-800';
        } else if (test.fat_percentage < 3.5 || test.protein_percentage < 3.2 ||
                   (test.scc && test.scc > 200000) ||
                   (test.cbt && test.cbt > 50000)) {
            qualityGrade = 'B';
            gradeColor = 'bg-yellow-100 text-yellow-800';
        }
        
        return `
            <tr class="hover:bg-gray-50">
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${testDate}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${fatPercentage}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${proteinPercentage}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${sccCount}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${tbcCount}</td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${gradeColor}">
                        Nota ${qualityGrade}
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm">
                    <button onclick="deleteQualityTest('${test.id}')" class="text-red-600 hover:text-red-800 font-medium">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                    </button>
                </td>
            </tr>
        `;
    }).join('');
}

// Delete volume record function
async function deleteVolumeRecord(recordId) {
    if (!confirm('Tem certeza que deseja excluir este registro de volume?')) {
        return;
    }
    
    try {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) {
            showNotification('Usu√°rio n√£o autenticado', 'error');
            return;
        }
        
        // Delete the record
        const { error } = await supabase
            .from('milk_production')
            .delete()
            .eq('id', recordId);
        
        if (error) {
            console.error('Error deleting volume record:', error);
            showNotification('Erro ao excluir registro: ' + error.message, 'error');
            return;
        }
        
        showNotification('Registro de volume exclu√≠do com sucesso!', 'success');
        
        // Reload data
        await loadVolumeData();
        await loadVolumeRecords();
        await loadWeeklyVolumeChart();
        await loadDailyVolumeChart();
        await loadDashboardWeeklyChart();
        await loadWeeklySummaryChart();
        await loadMonthlyVolumeChart();
        await loadQualityChart();
        await loadTemperatureChart();
        // Get user's farm_id for recent activities
        if (user) {
            const { data: userData } = await supabase
                .from('users')
                .select('farm_id')
                .eq('email', user.email)
                .single();
            
            if (userData?.farm_id) {
                await loadRecentActivities(userData.farm_id);
            }
        }
        
    } catch (error) {
        console.error('Error deleting volume record:', error);
        showNotification('Erro ao excluir registro: ' + error.message, 'error');
    }
}

// Delete quality test function
async function deleteQualityTest(testId) {
    if (!confirm('Tem certeza que deseja excluir este teste de qualidade?')) {
        return;
    }
    
    try {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) {
            showNotification('Usu√°rio n√£o autenticado', 'error');
            return;
        }
        
        // Delete the test
        const { error } = await supabase
            .from('quality_tests')
            .delete()
            .eq('id', testId);
        
        if (error) {
            console.error('Error deleting quality test:', error);
            showNotification('Erro ao excluir teste: ' + error.message, 'error');
            return;
        }
        
        showNotification('Teste de qualidade exclu√≠do com sucesso!', 'success');
        
        // Reload data
        await loadQualityData();
        await loadQualityTests();
        
    } catch (error) {
        console.error('Error deleting quality test:', error);
        showNotification('Erro ao excluir teste: ' + error.message, 'error');
    }
}

// Load quality chart data
async function loadQualityChart() {
    try {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) return;

        const { data: userProfile } = await supabase
            .from('users')
            .select('farm_id')
            .eq('email', user.email)
            .single();

        if (!userProfile?.farm_id) return;

        const { data: qualityData, error } = await supabase
            .from('quality_tests')
            .select('*')
            .eq('farm_id', userProfile.farm_id)
            .order('test_date', { ascending: false })
            .limit(7);

        if (error) {
            console.error('Error loading quality data:', error);
            return;
        }

        if (window.qualityChart && qualityData && qualityData.length > 0) {
            const labels = qualityData.reverse().map(record => 
                new Date(record.test_date).toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' })
            );
            const qualityScores = qualityData.map(record => {
                // Calculate quality score based on fat and protein percentages
                const fatScore = Math.min((record.fat_percentage || 0) / 4 * 100, 100);
                const proteinScore = Math.min((record.protein_percentage || 0) / 3.5 * 100, 100);
                return Math.round((fatScore + proteinScore) / 2);
            });

            window.qualityChart.data.labels = labels;
            window.qualityChart.data.datasets[0].data = qualityScores;
            window.qualityChart.update();
        }
    } catch (error) {
        console.error('Error loading quality chart:', error);
    }
}

// Load temperature chart data
async function loadTemperatureChart() {
    try {
        console.log('üîç loadTemperatureChart iniciado...');
        
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) {
            console.log('‚ùå Usu√°rio n√£o autenticado');
            return;
        }

        const { data: userData } = await supabase
            .from('users')
            .select('farm_id')
            .eq('email', user.email)
            .single();

        if (!userData?.farm_id) {
            console.log('‚ùå Farm ID n√£o encontrado');
            return;
        }

        console.log('‚úÖ Farm ID encontrado:', userData.farm_id);
        console.log('üîç Procurando dados de temperatura para farm_id:', userData.farm_id);
        
        // First, let's check if there are any records with temperature
        const { data: allRecords, error: checkError } = await supabase
            .from('milk_production')
            .select('production_date, temperature')
            .eq('farm_id', userData.farm_id);
            
        console.log('All records found:', allRecords?.length || 0);
        console.log('Records with temperature:', allRecords?.filter(r => r.temperature !== null).length || 0);

        const { data: temperatureData, error } = await supabase
            .from('milk_production')
            .select('production_date, temperature')
            .eq('farm_id', userData.farm_id)
            .not('temperature', 'is', null)
            .order('production_date', { ascending: false })
            .limit(7);

        if (error) {
            console.error('Error loading temperature data:', error);
            return;
        }
        console.log('üìä Dados de temperatura recebidos:', temperatureData);
        console.log('üìà Temperature chart exists:', !!window.temperatureChart);
        
        if (window.temperatureChart) {
            if (temperatureData && temperatureData.length > 0) {
                // Restore canvas if it was replaced by message
                const chartContainer = document.querySelector('#temperatureChart').parentElement;
                if (chartContainer && !chartContainer.querySelector('canvas')) {
                    chartContainer.innerHTML = '<canvas id="temperatureChart"></canvas>';
                    // Reinitialize chart
                    const temperatureCtx = document.getElementById('temperatureChart');
                    if (temperatureCtx) {
                        window.temperatureChart = new Chart(temperatureCtx, {
                            type: 'line',
                            data: {
                                labels: [],
                                datasets: [{
                                    label: 'Temperatura (¬∞C)',
                                    data: [],
                                    borderColor: '#f59e0b',
                                    backgroundColor: 'rgba(245, 158, 11, 0.1)',
                                    borderWidth: 3,
                                    pointRadius: 6,
                                    pointHoverRadius: 8,
                                    pointBackgroundColor: '#f59e0b',
                                    pointBorderColor: '#ffffff',
                                    pointBorderWidth: 2,
                                    tension: 0.4,
                                    fill: true,
                                    showLine: true
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                interaction: {
                                    intersect: false,
                                    mode: 'index'
                                },
                                plugins: {
                                    legend: {
                                        display: false
                                    },
                                    tooltip: {
                                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                        titleColor: 'white',
                                        bodyColor: 'white',
                                        borderColor: 'rgba(255, 255, 255, 0.1)',
                                        borderWidth: 1,
                                        callbacks: {
                                            label: function(context) {
                                                return 'Temperatura: ' + context.parsed.y + '¬∞C';
                                            }
                                        }
                                    }
                                },
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        max: 10,
                                        grid: {
                                            color: 'rgba(0, 0, 0, 0.1)'
                                        },
                                        ticks: {
                                            callback: function(value) {
                                                return value + '¬∞C';
                                            }
                                        }
                                    },
                                    x: {
                                        grid: {
                                            color: 'rgba(0, 0, 0, 0.1)'
                                        }
                                    }
                                },
                                elements: {
                                    line: {
                                        tension: 0.4
                                    },
                                    point: {
                                        radius: 6,
                                        hoverRadius: 8
                                    }
                                }
                            }
                        });
                    }
                }
                
                const labels = temperatureData.reverse().map(record => 
                    new Date(record.production_date).toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' })
                );
                const temperatures = temperatureData.map(record => record.temperature || 0);

                console.log('Temperature chart labels:', labels);
                console.log('Temperature chart data:', temperatures);

                // If only one data point, add a previous day with same value to show a line
                if (labels.length === 1) {
                    const currentDate = new Date(temperatureData[0].production_date);
                    const previousDate = new Date(currentDate);
                    previousDate.setDate(previousDate.getDate() - 1);
                    
                    labels.unshift(previousDate.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' }));
                    temperatures.unshift(temperatures[0]); // Same temperature for previous day
                }

                window.temperatureChart.data.labels = labels;
                window.temperatureChart.data.datasets[0].data = temperatures;
                
                // Show success message
                console.log('Temperature chart updated successfully with data');
            } else {
                console.log('No temperature data available');
                // Show message in chart area
                const chartContainer = document.querySelector('#temperatureChart').parentElement;
                console.log('üì¶ Temperature chart container found:', !!chartContainer);
                if (chartContainer) {
                    const totalRecords = allRecords?.length || 0;
                    const recordsWithTemp = allRecords?.filter(r => r.temperature !== null).length || 0;
                    
                    chartContainer.innerHTML = `
                        <div class="flex flex-col items-center justify-center h-64 text-center">
                            <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mb-4">
                                <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                                </svg>
                            </div>
                            <h3 class="text-lg font-semibold text-gray-900 mb-2">Sem Dados de Temperatura</h3>
                            <p class="text-gray-500 text-sm">Nenhum registro com temperatura foi encontrado nos √∫ltimos 7 dias.</p>
                            <p class="text-gray-400 text-xs mt-1">
                                Total de registros: ${totalRecords} | Com temperatura: ${recordsWithTemp}
                            </p>
                            <p class="text-gray-400 text-xs mt-1">Os dados aparecer√£o aqui quando houver registros com temperatura.</p>
                        </div>
                    `;
                }
                
                // Clear chart when no data
                window.temperatureChart.data.labels = [];
                window.temperatureChart.data.datasets[0].data = [];
            }
            window.temperatureChart.update();
        } else {
            console.error('Temperature chart not initialized');
        }
    } catch (error) {
        console.error('Error loading temperature chart:', error);
    }
}

// Update quality charts with data
function updateQualityCharts(qualityData) {
    console.log('updateQualityCharts called with data:', qualityData);
    console.log('qualityTrendChart exists:', !!qualityTrendChart);
    
    // Update trend chart
    if (qualityTrendChart) {
        try {
            const labels = qualityData.slice(0, 10).reverse().map(record => 
                new Date(record.test_date).toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' })
            );
            const fatData = qualityData.slice(0, 10).reverse().map(record => record.fat_percentage || 0);
            const proteinData = qualityData.slice(0, 10).reverse().map(record => record.protein_percentage || 0);
            
            console.log('Updating trend chart with:', { labels, fatData, proteinData });
            
            qualityTrendChart.data.labels = labels;
            qualityTrendChart.data.datasets[0].data = fatData;
            qualityTrendChart.data.datasets[1].data = proteinData;
            qualityTrendChart.update();
            
            console.log('Trend chart updated successfully');
        } catch (error) {
            console.error('Error updating trend chart:', error);
        }
    } else {
        console.warn('qualityTrendChart is not initialized');
    }
    
    // Update distribution chart
    if (qualityDistributionChart && qualityData.length > 0) {
        const avgFat = qualityData.reduce((sum, record) => sum + (record.fat_percentage || 0), 0) / qualityData.length;
        const avgProtein = qualityData.reduce((sum, record) => sum + (record.protein_percentage || 0), 0) / qualityData.length;
                        const avgSCC = qualityData.reduce((sum, record) => sum + (record.scc || 0), 0) / qualityData.length;
        
        // Classify quality based on standards
        const fatQuality = avgFat >= 3.5 ? 'Excelente' : avgFat >= 3.0 ? 'Bom' : 'Regular';
        const proteinQuality = avgProtein >= 3.2 ? 'Excelente' : avgProtein >= 2.9 ? 'Bom' : 'Regular';
        const sccQuality = avgSCC <= 200000 ? 'Excelente' : avgSCC <= 400000 ? 'Bom' : 'Regular';
        
        const excellent = [fatQuality, proteinQuality, sccQuality].filter(q => q === 'Excelente').length;
        const good = [fatQuality, proteinQuality, sccQuality].filter(q => q === 'Bom').length;
        const regular = [fatQuality, proteinQuality, sccQuality].filter(q => q === 'Regular').length;
        
        qualityDistributionChart.data.labels = ['Excelente', 'Bom', 'Regular'];
        qualityDistributionChart.data.datasets[0].data = [excellent, good, regular];
        qualityDistributionChart.update();
    }
}

// Load recent activities
async function loadRecentActivities(farmId) {
    try {
        const { data: activities, error } = await supabase
            .from('milk_production')
            .select(`
                id,
                volume_liters,
                production_date,
                shift,
                created_at,
                users!inner(name)
            `)
            .eq('farm_id', farmId)
            .order('created_at', { ascending: false })
            .limit(5);

        if (error) {
            console.warn('Error loading recent activities:', error);
            return;
        }

        const activitiesContainer = document.getElementById('recentActivities');
        
        if (!activities || activities.length === 0) {
            activitiesContainer.innerHTML = `
                <div class="text-center py-8">
                    <div class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <p class="text-gray-500 text-sm">Nenhuma atividade recente</p>
                    <p class="text-gray-400 text-xs">Registros aparecer√£o aqui</p>
                </div>
            `;
            return;
        }

        activitiesContainer.innerHTML = activities.map(activity => {
            const timeAgo = getTimeAgo(new Date(activity.created_at));
            const userName = activity.users?.name || 'Usu√°rio';
            
            return `
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                    <div class="flex items-center space-x-3">
                        <div class="w-8 h-8 bg-forest-500 rounded-full flex items-center justify-center">
                            <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path>
                            </svg>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-gray-900">${activity.volume_liters}L - ${activity.shift}</p>
                            <p class="text-xs text-gray-500">${timeAgo} ‚Ä¢ por ${userName}</p>
                        </div>
                    </div>
                    <div class="text-xs text-gray-400">
                        ${timeAgo}
                    </div>
                </div>
            `;
        }).join('');

    } catch (error) {
        console.error('Error loading recent activities:', error);
    }
}

// Helper function to calculate time ago
function getTimeAgo(date) {
    const now = new Date();
    const diffInSeconds = Math.floor((now - date) / 1000);
    
    if (diffInSeconds < 60) {
        return `${diffInSeconds}s`;
    } else if (diffInSeconds < 3600) {
        return `${Math.floor(diffInSeconds / 60)}min`;
    } else if (diffInSeconds < 86400) {
        return `${Math.floor(diffInSeconds / 3600)}h`;
    } else {
        return `${Math.floor(diffInSeconds / 86400)}d`;
    }
}

// Initialize charts
function initializeCharts() {
    // Volume Chart
    const volumeCtx = document.getElementById('volumeChart');
    if (volumeCtx) {
        window.volumeChart = new Chart(volumeCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Volume (L)',
                    data: [],
                    borderColor: '#369e36',
                    backgroundColor: 'rgba(54, 158, 54, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }

    // Quality Chart
    const qualityCtx = document.getElementById('qualityChart');
    if (qualityCtx) {
        window.qualityChart = new Chart(qualityCtx, {
            type: 'bar',
            data: {
                labels: [],
                datasets: [{
                    label: 'Qualidade (%)',
                    data: [],
                    backgroundColor: '#5bb85b',
                    borderRadius: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100
                    }
                }
            }
        });
    }
    // Temperature Chart
    const temperatureCtx = document.getElementById('temperatureChart');
    console.log('üå°Ô∏è Temperature chart canvas found:', !!temperatureCtx);
    if (temperatureCtx) {
        window.temperatureChart = new Chart(temperatureCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Temperatura (¬∞C)',
                    data: [],
                    borderColor: '#f59e0b',
                    backgroundColor: 'rgba(245, 158, 11, 0.1)',
                    borderWidth: 3,
                    pointRadius: 6,
                    pointHoverRadius: 8,
                    pointBackgroundColor: '#f59e0b',
                    pointBorderColor: '#ffffff',
                    pointBorderWidth: 2,
                    tension: 0.4,
                    fill: true,
                    showLine: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    intersect: false,
                    mode: 'index'
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleColor: 'white',
                        bodyColor: 'white',
                        borderColor: 'rgba(255, 255, 255, 0.1)',
                        borderWidth: 1,
                        callbacks: {
                            label: function(context) {
                                return 'Temperatura: ' + context.parsed.y + '¬∞C';
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 10,
                        grid: {
                            color: 'rgba(0, 0, 0, 0.1)'
                        },
                        ticks: {
                            callback: function(value) {
                                return value + '¬∞C';
                            }
                        }
                    },
                    x: {
                        grid: {
                            color: 'rgba(0, 0, 0, 0.1)'
                        }
                    }
                },
                elements: {
                    line: {
                        tension: 0.4
                    },
                    point: {
                        radius: 6,
                        hoverRadius: 8
                    }
                }
            }
        });
    }

    // Dashboard Weekly Production Chart
    const dashboardWeeklyCtx = document.getElementById('dashboardWeeklyChart');
    if (dashboardWeeklyCtx) {
        window.dashboardWeeklyChart = new Chart(dashboardWeeklyCtx, {
            type: 'bar',
            data: {
                labels: [],
                datasets: [{
                    label: 'Produ√ß√£o (L)',
                    data: [],
                    backgroundColor: '#5bb85b',
                    borderRadius: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }

    // Weekly Volume Chart
    const weeklyVolumeCtx = document.getElementById('weeklyVolumeChart');
    if (weeklyVolumeCtx) {
        window.weeklyVolumeChart = new Chart(weeklyVolumeCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Volume Semanal (L)',
                    data: [],
                    borderColor: '#3b82f6',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    borderWidth: 3,
                    pointRadius: 6,
                    pointHoverRadius: 8,
                    pointBackgroundColor: '#3b82f6',
                    pointBorderColor: '#ffffff',
                    pointBorderWidth: 2,
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    intersect: false,
                    mode: 'index'
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleColor: 'white',
                        bodyColor: 'white',
                        borderColor: 'rgba(255, 255, 255, 0.1)',
                        borderWidth: 1,
                        callbacks: {
                            label: function(context) {
                                return 'Volume: ' + context.parsed.y + 'L';
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(0, 0, 0, 0.1)'
                        },
                        ticks: {
                            callback: function(value) {
                                return value + 'L';
                            }
                        }
                    },
                    x: {
                        grid: {
                            color: 'rgba(0, 0, 0, 0.1)'
                        }
                    }
                }
            }
        });
    }

    // Daily Volume Chart
    const dailyVolumeCtx = document.getElementById('dailyVolumeChart');
    if (dailyVolumeCtx) {
        window.dailyVolumeChart = new Chart(dailyVolumeCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Volume por Hor√°rio (L)',
                    data: [],
                    borderColor: '#3b82f6',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }

    // Quality Trend Chart
    const qualityTrendCtx = document.getElementById('qualityTrendChart');
    if (qualityTrendCtx) {
        qualityTrendChart = new Chart(qualityTrendCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    {
                        label: 'Gordura (%)',
                        data: [],
                        borderColor: '#f59e0b',
                        backgroundColor: 'rgba(245, 158, 11, 0.1)',
                        borderWidth: 3,
                        pointRadius: 5,
                        pointHoverRadius: 7,
                        pointBackgroundColor: '#f59e0b',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2,
                        tension: 0.4,
                        fill: false
                    },
                    {
                        label: 'Prote√≠na (%)',
                        data: [],
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        borderWidth: 3,
                        pointRadius: 5,
                        pointHoverRadius: 7,
                        pointBackgroundColor: '#10b981',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2,
                        tension: 0.4,
                        fill: false
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    intersect: false,
                    mode: 'index'
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 6,
                        grid: {
                            color: 'rgba(0, 0, 0, 0.1)'
                        },
                        ticks: {
                            callback: function(value) {
                                return value + '%';
                            }
                        }
                    },
                    x: {
                        grid: {
                            color: 'rgba(0, 0, 0, 0.1)'
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                        labels: {
                            usePointStyle: true,
                            padding: 20
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleColor: 'white',
                        bodyColor: 'white',
                        borderColor: 'rgba(255, 255, 255, 0.1)',
                        borderWidth: 1
                    }
                }
            }
        });
    }

    // Quality Distribution Chart
    const qualityDistCtx = document.getElementById('qualityDistributionChart');
    if (qualityDistCtx) {
        qualityDistributionChart = new Chart(qualityDistCtx, {
            type: 'doughnut',
            data: {
                labels: ['Excelente', 'Bom', 'Regular'],
                datasets: [{
                    data: [0, 0, 0],
                    backgroundColor: ['#10b981', '#f59e0b', '#ef4444'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    }

    // Payments Chart
    const paymentsCtx = document.getElementById('paymentsChart');
    if (paymentsCtx) {
        window.paymentsChart = new Chart(paymentsCtx, {
            type: 'bar',
            data: {
                labels: ['Pagos', 'Pendentes', 'Atrasados'],
                datasets: [{
                    label: 'Vendas (R$)',
                    data: [0, 0, 0],
                    backgroundColor: ['#10b981', '#f59e0b', '#ef4444']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }
    // Weekly Summary Chart
    const weeklySummaryCtx = document.getElementById('weeklySummaryChart');
    if (weeklySummaryCtx) {
        window.weeklySummaryChart = new Chart(weeklySummaryCtx, {
            type: 'bar',
            data: {
                labels: [],
                datasets: [{
                    label: 'Volume Semanal (L)',
                    data: [],
                    backgroundColor: '#3b82f6',
                    borderColor: '#1d4ed8',
                    borderWidth: 1,
                    borderRadius: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return value + 'L';
                            }
                        }
                    }
                }
            }
        });
    }

    // Monthly Volume Chart
    const monthlyVolumeCtx = document.getElementById('monthlyVolumeChart');
    if (monthlyVolumeCtx) {
        window.monthlyVolumeChart = new Chart(monthlyVolumeCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Volume Mensal (L)',
                    data: [],
                    borderColor: '#10b981',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    borderWidth: 3,
                    pointRadius: 6,
                    pointHoverRadius: 8,
                    pointBackgroundColor: '#10b981',
                    pointBorderColor: '#ffffff',
                    pointBorderWidth: 2,
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return value + 'L';
                            }
                        }
                    }
                }
            }
        });
    }
}

// Show notification
function showNotification(message, type = 'success') {
    const toast = document.getElementById('notificationToast');
    const messageElement = document.getElementById('toastMessage');
    const iconElement = toast.querySelector('svg');
    
    messageElement.textContent = message;
    
    // Update icon and colors based on type
    if (type === 'error') {
        iconElement.classList.remove('text-green-400', 'text-blue-400');
        iconElement.classList.add('text-red-400');
        iconElement.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path>';
    } else if (type === 'info') {
        iconElement.classList.remove('text-green-400', 'text-red-400');
        iconElement.classList.add('text-blue-400');
        iconElement.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>';
    } else {
        iconElement.classList.remove('text-red-400', 'text-blue-400');
        iconElement.classList.add('text-green-400');
        iconElement.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>';
    }
    
    toast.classList.add('show');
    
    setTimeout(() => {
        toast.classList.remove('show');
    }, 5000);
}

// Hide notification
function hideNotification() {
    document.getElementById('notificationToast').classList.remove('show');
}

// Profile modal functions
function openProfileModal() {
    document.getElementById('profileModal').classList.add('show');
}

function closeProfileModal() {
    document.getElementById('profileModal').classList.remove('show');
}

// Profile edit functions
function toggleProfileEdit() {
    const viewMode = document.getElementById('profileViewMode');
    const editMode = document.getElementById('profileEditMode');
    const editBtn = document.getElementById('editProfileBtn');
    
    if (editMode.classList.contains('hidden')) {
        // Switch to edit mode
        viewMode.classList.add('hidden');
        editMode.classList.remove('hidden');
        editBtn.innerHTML = `
            <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
            Cancelar
        `;
        editBtn.onclick = cancelProfileEdit;
        
        // Populate edit form with current values
        populateEditForm();
    } else {
        // Switch back to view mode
        cancelProfileEdit();
    }
}

function cancelProfileEdit() {
    const viewMode = document.getElementById('profileViewMode');
    const editMode = document.getElementById('profileEditMode');
    const editBtn = document.getElementById('editProfileBtn');
    
    viewMode.classList.remove('hidden');
    editMode.classList.add('hidden');
    editBtn.innerHTML = `
        <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
        </svg>
        Editar
    `;
    editBtn.onclick = toggleProfileEdit;
}

function populateEditForm() {
    // Get current values from view mode
    const currentName = document.getElementById('profileFullName').textContent;
    const currentEmail = document.getElementById('profileEmail2').textContent;
    const currentWhatsApp = document.getElementById('profileWhatsApp').textContent;
    
    // Populate edit form
    document.getElementById('editProfileName').value = currentName === 'Carregando...' ? '' : currentName;
    document.getElementById('editProfileEmail').value = currentEmail === 'Carregando...' ? '' : currentEmail;
    document.getElementById('editProfileWhatsApp').value = currentWhatsApp === 'Carregando...' || currentWhatsApp === 'N√£o informado' ? '' : currentWhatsApp;
}

// Handle profile update form submission
async function handleUpdateProfile(event) {
    event.preventDefault();
    
    try {
        const formData = new FormData(event.target);
        const { data: { user } } = await supabase.auth.getUser();
        
        if (!user) {
            throw new Error('Usu√°rio n√£o autenticado');
        }
        
        const updateData = {
            name: formData.get('name'),
            whatsapp: formData.get('whatsapp') || null,
            // Campos de relat√≥rio adicionados
            report_farm_name: formData.get('report_farm_name') || null,
            report_farm_logo_base64: formData.get('report_farm_logo_base64') || null,
            report_footer_text: formData.get('report_footer_text') || null,
            report_system_logo_base64: formData.get('report_system_logo_base64') || null
        };
        
        // Handle profile photo upload if provided
        const profilePhotoFile = formData.get('profilePhoto');
        if (profilePhotoFile && profilePhotoFile.size > 0) {
            try {
                const profilePhotoUrl = await uploadProfilePhoto(profilePhotoFile, user.id);
                updateData.profile_photo_url = profilePhotoUrl;
            } catch (photoError) {
                console.error('Erro ao fazer upload da foto de perfil:', photoError);
                // Don't show error notification for photo upload - profile update is more important
                // showNotification('Erro ao fazer upload da foto de perfil, mas outros dados foram atualizados', 'warning');
            }
        }
        
        // First, check if user exists in users table
        const { data: existingUser, error: checkError } = await supabase
            .from('users')
            .select('*')
            .eq('id', user.id)
            .single();
        
        // Update user table in database
        const { data, error } = await supabase
            .from('users')
            .update(updateData)
            .eq('id', user.id)
            .select();
        
        if (error) {
            throw error;
        }
        
        // Also update user metadata in Supabase Auth
        const { error: authError } = await supabase.auth.updateUser({
            data: {
                name: updateData.name,
                whatsapp: updateData.whatsapp
            }
        });
        
        if (authError) {
            console.warn('Erro ao atualizar metadata do usu√°rio:', authError);
        }
        
        // Update the view mode with new values
        document.getElementById('profileFullName').textContent = updateData.name || 'N√£o informado';
        document.getElementById('profileName').textContent = updateData.name || 'N√£o informado';
        
        // Extract formal name for header and welcome message
        const formalName = extractFormalName(updateData.name);
        document.getElementById('managerName').textContent = formalName || 'Gerente';
        document.getElementById('managerWelcome').textContent = formalName || 'Gerente';
        
        document.getElementById('profileWhatsApp').textContent = updateData.whatsapp || 'N√£o informado';
        
        // Update localStorage/sessionStorage if exists (excluding profile_photo_url to prevent cross-page sharing)
        const sessionData = localStorage.getItem('userData') || sessionStorage.getItem('userData');
        if (sessionData) {
            try {
                const userData = JSON.parse(sessionData);
                userData.name = updateData.name;
                userData.whatsapp = updateData.whatsapp;
                // DO NOT update profile_photo_url in localStorage to prevent sharing between pages
                // Each page should load profile photo directly from database
                
                if (localStorage.getItem('userData')) {
                    localStorage.setItem('userData', JSON.stringify(userData));
                }
                if (sessionStorage.getItem('userData')) {
                    sessionStorage.setItem('userData', JSON.stringify(userData));
                }
            } catch (e) {
                console.warn('Erro ao atualizar dados da sess√£o:', e);
            }
        }
        
        // Switch back to view mode
        cancelProfileEdit();
        
        showNotification('Perfil atualizado com sucesso!', 'success');
        
    } catch (error) {
        console.error('Erro ao atualizar perfil:', error);
        showNotification('Erro ao atualizar perfil: ' + error.message, 'error');
    }
}

// Action functions
function addVolumeRecord() {
    // Criar modal para adicionar novo registro de volume
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    modal.innerHTML = `
        <div class="bg-white    rounded-2xl p-6 w-full max-w-md mx-4">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-bold text-slate-900   ">Novo Registro de Volume</h3>
                <button onclick="closeVolumeModal()" class="text-gray-400 hover:text-gray-600   :text-gray-300">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <form id="volumeForm" onsubmit="handleAddVolume(event)">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700    mb-2">Data</label>
                        <input type="date" name="production_date" required class="w-full px-3 py-2 border border-gray-300    rounded-lg focus:ring-2 focus:ring-forest-500 focus:border-transparent      ">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700    mb-2">Turno</label>
                        <select name="shift" required class="w-full px-3 py-2 border border-gray-300    rounded-lg focus:ring-2 focus:ring-forest-500 focus:border-transparent      ">
                            <option value="">Selecione o turno</option>
                            <option value="manha">Manh√£</option>
                            <option value="tarde">Tarde</option>
                            <option value="noite">Noite</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700    mb-2">Volume (Litros)</label>
                        <input type="number" name="volume" step="0.1" min="0" required class="w-full px-3 py-2 border border-gray-300    rounded-lg focus:ring-2 focus:ring-forest-500 focus:border-transparent      " placeholder="0.0">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700    mb-2">Temperatura (¬∞C)</label>
                        <input type="number" name="temperature" step="0.1" class="w-full px-3 py-2 border border-gray-300    rounded-lg focus:ring-2 focus:ring-forest-500 focus:border-transparent      " placeholder="4.0">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700    mb-2">Observa√ß√µes</label>
                        <textarea name="observations" rows="3" class="w-full px-3 py-2 border border-gray-300    rounded-lg focus:ring-2 focus:ring-forest-500 focus:border-transparent      " placeholder="Observa√ß√µes adicionais (opcional)"></textarea>
                    </div>
                </div>
                <div class="flex gap-3 mt-6">
                    <button type="button" onclick="closeVolumeModal()" class="flex-1 px-4 py-2 border border-gray-300    text-gray-700    rounded-lg hover:bg-gray-50   :bg-slate-700 transition-colors">
                        Cancelar
                    </button>
                    <button type="submit" class="flex-1 px-4 py-2 bg-forest-600 text-white rounded-lg hover:bg-forest-700 transition-colors">
                        Registrar
                    </button>
                </div>
            </form>
        </div>
    `;
    
    modal.id = 'volumeModal';
    document.body.appendChild(modal);
    
    // Set default date to today
    const today = new Date().toISOString().split('T')[0];
    modal.querySelector('input[name="production_date"]').value = today;
}
function addQualityTest() {
    // Criar modal para adicionar novo teste de qualidade
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    modal.innerHTML = `
        <div class="bg-white    rounded-2xl p-6 w-full max-w-md mx-4">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-bold text-slate-900   ">Novo Teste de Qualidade</h3>
                <button onclick="closeQualityModal()" class="text-gray-400 hover:text-gray-600   :text-gray-300">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <form id="qualityForm" onsubmit="handleAddQuality(event)">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700    mb-2">Data do Teste</label>
                        <input type="date" name="test_date" required class="w-full px-3 py-2 border border-gray-300    rounded-lg focus:ring-2 focus:ring-forest-500 focus:border-transparent      ">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700    mb-2">Gordura (%)</label>
                        <input type="number" name="fat_percentage" step="0.01" min="0" max="100" required class="w-full px-3 py-2 border border-gray-300    rounded-lg focus:ring-2 focus:ring-forest-500 focus:border-transparent      " placeholder="3.50">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700    mb-2">Prote√≠na (%)</label>
                        <input type="number" name="protein_percentage" step="0.01" min="0" max="100" required class="w-full px-3 py-2 border border-gray-300    rounded-lg focus:ring-2 focus:ring-forest-500 focus:border-transparent      " placeholder="3.20">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700    mb-2">CCS (mil/mL)</label>
                        <input type="number" name="scc" min="0" required class="w-full px-3 py-2 border border-gray-300    rounded-lg focus:ring-2 focus:ring-forest-500 focus:border-transparent      " placeholder="200">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700    mb-2">CBT (mil/mL)</label>
                        <input type="number" name="total_bacterial_count" min="0" required class="w-full px-3 py-2 border border-gray-300    rounded-lg focus:ring-2 focus:ring-forest-500 focus:border-transparent      " placeholder="50">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700    mb-2">Laborat√≥rio</label>
                        <input type="text" name="laboratory" class="w-full px-3 py-2 border border-gray-300    rounded-lg focus:ring-2 focus:ring-forest-500 focus:border-transparent      " placeholder="Nome do laborat√≥rio">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700    mb-2">Observa√ß√µes</label>
                        <textarea name="notes" rows="3" class="w-full px-3 py-2 border border-gray-300    rounded-lg focus:ring-2 focus:ring-forest-500 focus:border-transparent      " placeholder="Observa√ß√µes adicionais (opcional)"></textarea>
                    </div>
                </div>
                <div class="flex gap-3 mt-6">
                    <button type="button" onclick="closeQualityModal()" class="flex-1 px-4 py-2 border border-gray-300    text-gray-700    rounded-lg hover:bg-gray-50   :bg-slate-700 transition-colors">
                        Cancelar
                    </button>
                    <button type="submit" class="flex-1 px-4 py-2 bg-forest-600 text-white rounded-lg hover:bg-forest-700 transition-colors">
                        Registrar
                    </button>
                </div>
            </form>
        </div>
    `;
    
    modal.id = 'qualityModal';
    document.body.appendChild(modal);
    
    // Set default date to today
    const today = new Date().toISOString().split('T')[0];
    modal.querySelector('input[name="test_date"]').value = today;
}

function addPayment() {
    // Criar modal para adicionar novo pagamento
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    modal.innerHTML = `
        <div class="bg-white    rounded-2xl p-6 w-full max-w-md mx-4">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-bold text-slate-900   ">Nova Venda de Leite</h3>
                <button onclick="closePaymentModal()" class="text-gray-400 hover:text-gray-600   :text-gray-300">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <form id="paymentForm" onsubmit="handleAddPayment(event)">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700    mb-2">Descri√ß√£o</label>
                        <input type="text" name="description" required class="w-full px-3 py-2 border border-gray-300    rounded-lg focus:ring-2 focus:ring-forest-500 focus:border-transparent      " placeholder="Ex: Venda para Latic√≠nio ABC">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700    mb-2">Valor (R$)</label>
                        <input type="number" name="amount" step="0.01" required class="w-full px-3 py-2 border border-gray-300    rounded-lg focus:ring-2 focus:ring-forest-500 focus:border-transparent      " placeholder="0,00">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700    mb-2">Tipo</label>
                        <select name="payment_type" required class="w-full px-3 py-2 border border-gray-300    rounded-lg focus:ring-2 focus:ring-forest-500 focus:border-transparent      ">
                            <option value="">Selecione o tipo</option>
                            <option value="laticinio">Latic√≠nio</option>
                            <option value="cooperativa">Cooperativa</option>
                            <option value="distribuidor">Distribuidor</option>
                            <option value="consumidor_final">Consumidor Final</option>
                            <option value="exportacao">Exporta√ß√£o</option>
                            <option value="outros">Outros</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700    mb-2">Data da Venda</label>
                        <input type="date" name="due_date" required class="w-full px-3 py-2 border border-gray-300    rounded-lg focus:ring-2 focus:ring-forest-500 focus:border-transparent      ">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700    mb-2">Status</label>
                        <select name="status" required class="w-full px-3 py-2 border border-gray-300    rounded-lg focus:ring-2 focus:ring-forest-500 focus:border-transparent      ">
                            <option value="pending">Pendente</option>
                            <option value="completed">Conclu√≠da</option>
                            <option value="overdue">Atrasada</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700    mb-2">Observa√ß√µes</label>
                        <textarea name="notes" rows="3" class="w-full px-3 py-2 border border-gray-300    rounded-lg focus:ring-2 focus:ring-forest-500 focus:border-transparent      " placeholder="Observa√ß√µes adicionais (opcional)"></textarea>
                    </div>
                </div>
                <div class="flex gap-3 mt-6">
                    <button type="button" onclick="closePaymentModal()" class="flex-1 px-4 py-2 border border-gray-300    text-gray-700    rounded-lg hover:bg-gray-50   :bg-slate-700 transition-colors">
                        Cancelar
                    </button>
                    <button type="submit" class="flex-1 px-4 py-2 bg-forest-600 text-white rounded-lg hover:bg-forest-700 transition-colors">
                        Adicionar
                    </button>
                </div>
            </form>
        </div>
    `;
    
    modal.id = 'paymentModal';
    document.body.appendChild(modal);
    
    // Set default due date to today
    const today = new Date().toISOString().split('T')[0];
    modal.querySelector('input[name="due_date"]').value = today;
}

function closePaymentModal() {
    const modal = document.getElementById('paymentModal');
    if (modal) {
        modal.remove();
    }
}

function closeVolumeModal() {
    const modal = document.getElementById('volumeModal');
    if (modal) {
        modal.remove();
    }
}

function closeQualityModal() {
    const modal = document.getElementById('qualityModal');
    if (modal) {
        modal.remove();
    }
}

async function handleAddVolume(event) {
    event.preventDefault();
    const formData = new FormData(event.target);
    
    const volumeData = {
        production_date: formData.get('production_date'),
        shift: formData.get('shift'),
        volume: parseFloat(formData.get('volume')),
        temperature: formData.get('temperature') ? parseFloat(formData.get('temperature')) : null,
        observations: formData.get('observations') || null
    };

    try {
        const { data: { user: currentUser } } = await supabase.auth.getUser();
        if (!currentUser) throw new Error('User not authenticated');

        // Get current user's farm_id
        const { data: managerData, error: managerError } = await supabase
            .from('users')
            .select('farm_id')
            .eq('id', currentUser.id)
            .single();

        if (managerError) throw managerError;
        if (!managerData?.farm_id) throw new Error('Farm not found');

        // Insert volume record into database
        const { error: volumeError } = await supabase
            .from('milk_production')
            .insert({
                farm_id: managerData.farm_id,
                user_id: currentUser.id,
                production_date: volumeData.production_date,
                shift: volumeData.shift,
                volume_liters: volumeData.volume,
                temperature: volumeData.temperature,
                observations: volumeData.observations,
                created_at: new Date().toISOString()
            });

        if (volumeError) throw volumeError;

        showNotification('Registro de volume adicionado com sucesso!', 'success');
        closeVolumeModal();
        
        // Reload volume data and charts
        await loadVolumeData();
        await loadWeeklyVolumeChart();
        await loadDailyVolumeChart();
        await loadDashboardWeeklyChart();
        // Get user's farm_id for recent activities
        const { data: { user } } = await supabase.auth.getUser();
        if (user) {
            const { data: userData } = await supabase
                .from('users')
                .select('farm_id')
                .eq('email', user.email)
                .single();
            
            if (userData?.farm_id) {
                await loadRecentActivities(userData.farm_id);
            }
        }
        
    } catch (error) {
        console.error('Error adding volume record:', error);
        showNotification('Erro ao adicionar registro de volume: ' + error.message, 'error');
    }
}

async function handleAddQuality(event) {
    event.preventDefault();
    const formData = new FormData(event.target);
    
    const qualityData = {
        test_date: formData.get('test_date'),
        fat_percentage: parseFloat(formData.get('fat_percentage')),
        protein_percentage: parseFloat(formData.get('protein_percentage')),
                        scc: parseInt(formData.get('scc')),
                        cbt: parseInt(formData.get('total_bacterial_count')),
        laboratory: formData.get('laboratory') || null,
        notes: formData.get('notes') || null
    };

    try {
        const { data: { user: currentUser } } = await supabase.auth.getUser();
        if (!currentUser) throw new Error('User not authenticated');

        // Get current user's farm_id
        const { data: managerData, error: managerError } = await supabase
            .from('users')
            .select('farm_id')
            .eq('id', currentUser.id)
            .single();

        if (managerError) throw managerError;
        if (!managerData?.farm_id) throw new Error('Farm not found');

        // Insert quality test into database
        const { error: qualityError } = await supabase
            .from('quality_tests')
            .insert({
                farm_id: managerData.farm_id,
                test_date: qualityData.test_date,
                fat_percentage: qualityData.fat_percentage,
                protein_percentage: qualityData.protein_percentage,
                scc: qualityData.scc,
                cbt: qualityData.cbt,
                laboratory: qualityData.laboratory,
                notes: qualityData.notes,
                created_at: new Date().toISOString()
            });

        if (qualityError) throw qualityError;

        showNotification('Teste de qualidade adicionado com sucesso!', 'success');
        closeQualityModal();
        
        // Reload quality data and charts
        await loadQualityData();
        await loadQualityTests();
        
        // Get user's farm_id for recent activities
        const { data: { user } } = await supabase.auth.getUser();
        if (user) {
            const { data: userData } = await supabase
                .from('users')
                .select('farm_id')
                .eq('email', user.email)
                .single();
            
            if (userData?.farm_id) {
                await loadRecentActivities(userData.farm_id);
            }
        }
        
    } catch (error) {
        console.error('Error adding quality test:', error);
        showNotification('Erro ao adicionar teste de qualidade: ' + error.message, 'error');
    }
}
async function handleAddPayment(event) {
    event.preventDefault();
    const formData = new FormData(event.target);
    
    const paymentData = {
        record_date: formData.get('due_date'), // Data do registro
        type: 'receita', // Tipo de registro financeiro
        amount: parseFloat(formData.get('amount')), // Valor
        description: `${formData.get('description')} - Tipo: ${formData.get('payment_type')}${formData.get('notes') ? ' - ' + formData.get('notes') : ''}`, // Descri√ß√£o
        category: formData.get('payment_type') || 'venda_leite' // Categoria
    };

    try {
        const { data: { user: currentUser } } = await supabase.auth.getUser();
        if (!currentUser) throw new Error('User not authenticated');

        // Get current user's farm_id
        const { data: managerData, error: managerError } = await supabase
            .from('users')
            .select('farm_id')
            .eq('id', currentUser.id)
            .single();

        if (managerError) throw managerError;
        if (!managerData?.farm_id) throw new Error('Farm not found');

        // Insert financial record into database
        const { error: paymentError } = await supabase
            .from('financial_records')
            .insert({
                ...paymentData,
                farm_id: managerData.farm_id,
                type: 'receita'
            });

        if (paymentError) throw paymentError;

        showNotification('Venda adicionada com sucesso!', 'success');
        closePaymentModal();
        
        // Reload sales data and recent activities
        await loadPaymentsData();
        
        // Get user's farm_id for recent activities
        if (currentUser) {
            const { data: userData } = await supabase
                .from('users')
                .select('farm_id')
                .eq('email', currentUser.email)
                .single();
            
            if (userData?.farm_id) {
                await loadRecentActivities(userData.farm_id);
            }
        }
        
    } catch (error) {
        console.error('Error adding payment:', error);
        showNotification('Erro ao adicionar venda: ' + error.message, 'error');
    }
}

// Modal functions
function openAddUserModal() {
    document.getElementById('addUserModal').classList.add('show');
    
    // Verificar se o cargo 'funcionario' est√° selecionado e mostrar a se√ß√£o de foto
    const userRoleSelect = document.getElementById('userRole');
    const addPhotoSection = document.getElementById('addPhotoSection');
    
    if (userRoleSelect && addPhotoSection) {
        // Definir 'funcionario' como op√ß√£o padr√£o
        userRoleSelect.value = 'funcionario';
        
        // Mostrar a se√ß√£o de foto j√° que 'funcionario' √© o padr√£o
        addPhotoSection.classList.remove('hidden');
    }
}

function closeAddUserModal() {
    document.getElementById('addUserModal').classList.remove('show');
    document.getElementById('addUserForm').reset();
    
    // Reset profile photo preview
    const preview = document.getElementById('profilePreview');
    const placeholder = document.getElementById('profilePlaceholder');
    if (preview && placeholder) {
        preview.classList.add('hidden');
        placeholder.classList.remove('hidden');
        preview.src = '';
    }
    
    // Reset email preview
    const emailPreview = document.getElementById('emailPreview');
    if (emailPreview) {
        emailPreview.textContent = 'Digite o nome para ver o email';
    }
}

// Generate email based on name and farm
async function generateUserEmail(name, farmId) {
    try {
        // Validate input parameters
        if (!name || typeof name !== 'string' || name.trim() === '') {
            throw new Error('Nome do usu√°rio √© obrigat√≥rio');
        }
        
        if (!farmId) {
            throw new Error('ID da fazenda √© obrigat√≥rio');
        }
        
        // Get farm name
        const { data: farmData, error: farmError } = await supabase
            .from('farms')
            .select('name')
            .eq('id', farmId)
            .single();

        if (farmError) throw farmError;
        
        if (!farmData || !farmData.name || typeof farmData.name !== 'string' || farmData.name.trim() === '') {
            throw new Error('Nome da fazenda n√£o encontrado ou inv√°lido');
        }
        
        // Sanitizar o nome da fazenda (tudo min√∫sculo, sem espa√ßo, sem acento)
        const farmName = farmData.name
            .trim()
            .toLowerCase()
            .normalize('NFD')
            .replace(/[\u0300-\u036f]/g, '') // Remove acentos
            .replace(/\s+/g, '') // Remove espa√ßos
            .replace(/[^a-z0-9]/g, ''); // Remove caracteres especiais
        
        // Extrair o primeiro nome do usu√°rio
        const firstName = name.trim().split(' ')[0]
            .toLowerCase()
            .normalize('NFD')
            .replace(/[\u0300-\u036f]/g, '') // Remove acentos
            .replace(/[^a-z0-9]/g, ''); // Remove caracteres especiais
            
        // Validar se o primeiro nome n√£o est√° vazio ap√≥s sanitiza√ß√£o
        if (!firstName) {
            throw new Error('Nome do usu√°rio inv√°lido ap√≥s sanitiza√ß√£o');
        }
        
        let finalEmail;
        let attempts = 0;
        const maxAttempts = 50; // Evitar loop infinito
        
        // Verificar se o e-mail j√° existe no banco
        while (attempts < maxAttempts) {
            // Gerar dois n√∫meros aleat√≥rios entre 10 e 99
            const num1 = Math.floor(Math.random() * 90) + 10; // 10-99
            const num2 = Math.floor(Math.random() * 90) + 10; // 10-99
            
            finalEmail = `${firstName}${num1}${num2}@${farmName}.lactech.com`;
            
            // Verificar se email j√° existe
            const { data: existingUser, error } = await supabase
                .from('users')
                .select('id')
                .eq('email', finalEmail)
                .maybeSingle(); // Use maybeSingle() em vez de single()
            
            if (error) {
                console.error('Error checking email:', error);
                throw error;
            }
            
            if (!existingUser) {
                // Email dispon√≠vel, sair do loop
                break;
            }
            
            attempts++;
        }
        
        if (attempts >= maxAttempts) {
            throw new Error('N√£o foi poss√≠vel gerar um email √∫nico ap√≥s v√°rias tentativas');
        }
        
        return finalEmail;
    } catch (error) {
        console.error('Error generating email:', error);
        throw error;
    }
}

// Update email preview
async function updateEmailPreview(name) {
    const emailPreview = document.getElementById('emailPreview');
    
    if (!emailPreview) {
        console.error('Email preview element not found');
        return;
    }
    
    if (!name || typeof name !== 'string' || name.trim() === '') {
        emailPreview.textContent = 'Digite o nome para ver o email';
        return;
    }
    
    try {
        const { data: { user: currentUser } } = await supabase.auth.getUser();
        if (!currentUser) {
            emailPreview.textContent = 'Usu√°rio n√£o autenticado';
            return;
        }

        const { data: managerData, error: managerError } = await supabase
            .from('users')
            .select('farm_id')
            .eq('id', currentUser.id)
            .single();

        if (managerError) throw managerError;
        
        if (!managerData || !managerData.farm_id) {
            emailPreview.textContent = 'Fazenda n√£o encontrada';
            return;
        }
        
        const email = await generateUserEmail(name, managerData.farm_id);
        emailPreview.textContent = email;
    } catch (error) {
        console.error('Error in updateEmailPreview:', error);
        emailPreview.textContent = 'Erro ao gerar email';
    }
}

async function hashPassword(password) {
    const encoder = new TextEncoder();
    const data = encoder.encode(password);
    const hash = await crypto.subtle.digest('SHA-256', data);
    const hashArray = Array.from(new Uint8Array(hash));
    const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    return hashHex;
}

async function sendWhatsAppCredentials(whatsapp, name, email, password) {
    try {
        let formattedNumber = whatsapp.replace(/\D/g, '');
        if (!formattedNumber.startsWith('55')) {
            formattedNumber = '55' + formattedNumber;
        }
        
        const message = `üå± *LACTECH - Sistema de Gest√£o Leiteira* ü•õ\n\n` +
            `üéâ *Ol√° ${name}!*\n\n` +
            `Suas credenciais de acesso foram criadas com sucesso:\n\n` +
            `üìß *Email:* ${email}\n` +
            `üîë *Senha:* ${password}\n\n` +
            `‚ö†Ô∏è *INSTRU√á√ïES IMPORTANTES:*\n` +
            `‚úÖ Mantenha suas credenciais seguras\n` +
            `‚úÖ N√£o compartilhe com terceiros\n\n` +
            `üåê *Acesse o sistema:*\n` +
            `https://lacteste.netlify.app/\n\n` +
            `üì± *Suporte t√©cnico dispon√≠vel*\n` +
            `Em caso de d√∫vidas, entre em contato\n\n` +
            `üöÄ *Bem-vindo(a) √† equipe LacTech!*\n` +
            `Juntos, vamos revolucionar a gest√£o leiteira! üêÑüíö`;
        
        // Copiar mensagem para √°rea de transfer√™ncia
        try {
            await navigator.clipboard.writeText(message);
            
            // Mostrar modal com instru√ß√µes
            showWhatsAppInstructions(formattedNumber, name, message);
            
            return true;
        } catch (clipboardError) {
            console.error('Erro ao copiar para √°rea de transfer√™ncia:', clipboardError);
            // Fallback: mostrar modal mesmo sem copiar
            showWhatsAppInstructions(formattedNumber, name, message);
            return true;
        }
        
    } catch (error) {
        console.error('Error sending WhatsApp message:', error);
        return false;
    }
}

// Mostrar modal com instru√ß√µes para envio manual
function showWhatsAppInstructions(phoneNumber, userName, message) {
    // Criar modal se n√£o existir
    let modal = document.getElementById('whatsappInstructionsModal');
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'whatsappInstructionsModal';
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        modal.innerHTML = `
            <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-900">üì± Enviar Credenciais via WhatsApp</h3>
                    <button onclick="closeWhatsAppInstructions()" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                
                <div class="space-y-4">
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                        <p class="text-sm text-green-800">
                            ‚úÖ <strong>Mensagem copiada!</strong><br>
                            As credenciais foram copiadas para sua √°rea de transfer√™ncia.
                        </p>
                    </div>
                    
                    <div class="space-y-2">
                        <p class="text-sm font-medium text-gray-700">Para enviar as credenciais:</p>
                        <ol class="text-sm text-gray-600 space-y-1 list-decimal list-inside">
                            <li>Abra o WhatsApp no seu celular ou computador</li>
                            <li>Procure pelo contato: <strong>${phoneNumber}</strong></li>
                            <li>Cole a mensagem (Ctrl+V) e envie</li>
                        </ol>
                    </div>
                    
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                        <p class="text-xs text-blue-800">
                            üí° <strong>Dica:</strong> Voc√™ tamb√©m pode clicar no bot√£o abaixo para abrir o WhatsApp Web automaticamente.
                        </p>
                    </div>
                    
                    <div class="flex space-x-3">
                        <button onclick="openWhatsAppWeb('${phoneNumber}', '${encodeURIComponent(message)}')" 
                                class="flex-1 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors text-sm">
                            üåê Abrir WhatsApp Web
                        </button>
                        <button onclick="copyMessageAgain('${encodeURIComponent(message)}')" 
                                class="flex-1 bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors text-sm">
                            üìã Copiar Novamente
                        </button>
                    </div>
                    
                    <button onclick="closeWhatsAppInstructions()" 
                            class="w-full bg-gray-100 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-200 transition-colors text-sm">
                        Fechar
                    </button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
    }
    // Atualizar conte√∫do do modal
    const phoneElement = modal.querySelector('strong');
    if (phoneElement) {
        phoneElement.textContent = phoneNumber;
    }
    
    // Mostrar modal
    modal.style.display = 'flex';
}

// Fechar modal de instru√ß√µes
function closeWhatsAppInstructions() {
    const modal = document.getElementById('whatsappInstructionsModal');
    if (modal) {
        modal.style.display = 'none';
    }
}

// Abrir WhatsApp Web (op√ß√£o alternativa)
function openWhatsAppWeb(phoneNumber, encodedMessage) {
    const whatsappUrl = `https://wa.me/${phoneNumber}?text=${encodedMessage}`;
    window.open(whatsappUrl, '_blank');
    closeWhatsAppInstructions();
}

// Copiar mensagem novamente
async function copyMessageAgain(encodedMessage) {
    try {
        const message = decodeURIComponent(encodedMessage);
        await navigator.clipboard.writeText(message);
        showNotification('Mensagem copiada novamente!', 'success');
    } catch (error) {
        console.error('Erro ao copiar mensagem:', error);
        showNotification('Erro ao copiar mensagem', 'error');
    }
}

// Handle add user
async function handleAddUser(e) {
    e.preventDefault();
    console.log('=== DEBUG: handleAddUser iniciado ===');
    const formData = new FormData(e.target);
    
    const userData = {
        name: formData.get('name'),
        whatsapp: formData.get('whatsapp'),
        role: formData.get('role'),
        password: formData.get('password')
    };
    
    console.log('DEBUG: Dados do formul√°rio:', userData);

    // Validate form data
    if (!userData.name || typeof userData.name !== 'string' || userData.name.trim() === '') {
        showNotification('Nome do usu√°rio √© obrigat√≥rio', 'error');
        return;
    }
    
    if (!userData.whatsapp || typeof userData.whatsapp !== 'string' || userData.whatsapp.trim() === '') {
        showNotification('WhatsApp √© obrigat√≥rio', 'error');
        return;
    }
    
    if (!userData.role || typeof userData.role !== 'string' || userData.role.trim() === '') {
        showNotification('Fun√ß√£o do usu√°rio √© obrigat√≥ria', 'error');
        return;
    }
    
    if (!userData.password || typeof userData.password !== 'string' || userData.password.trim() === '') {
        showNotification('Senha √© obrigat√≥ria', 'error');
        return;
    }

    try {
        const { data: { user: currentUser } } = await supabase.auth.getUser();
        if (!currentUser) throw new Error('User not authenticated');

        // Get current user's farm_id
        const { data: managerData, error: managerError } = await supabase
            .from('users')
            .select('farm_id')
            .eq('id', currentUser.id)
            .single();

        if (managerError) throw managerError;
        if (!managerData?.farm_id) throw new Error('Farm not found');

        // Generate automatic email
        const email = await generateUserEmail(userData.name, managerData.farm_id);
        
        // Hash the password securely
        const passwordHash = await hashPassword(userData.password);

        // Create user first to get the real user ID
        const createUserData = {
            email: email,
            password: userData.password,
            name: userData.name,
            whatsapp: userData.whatsapp,
            role: userData.role
        };
        const userResult = await LacTechAPI.createUser(createUserData);
        
        if (!userResult.success) {
            throw new Error(userResult.error || 'Falha ao criar usu√°rio');
        }

        // Handle profile photo upload if provided - now with real user ID
        let profilePhotoUrl = null;
        const profilePhotoFile = formData.get('profilePhoto');
        
        if (profilePhotoFile && profilePhotoFile.size > 0) {
            try {
                // Use the real user ID for the photo upload
                profilePhotoUrl = await uploadProfilePhoto(profilePhotoFile, userResult.userId);
                
                // Update user record with profile photo URL
                const { error: updateError } = await supabase
                    .from('users')
                    .update({ profile_photo_url: profilePhotoUrl })
                    .eq('id', userResult.userId);
                    
                if (updateError) {
                    console.error('Error updating profile photo URL:', updateError);
                    showNotification('Foto enviada, mas erro ao associar ao usu√°rio', 'warning');
                }
            } catch (photoError) {
                console.error('Error uploading profile photo:', photoError);
                // Don't show error notification for photo upload - user creation is more important
                // showNotification('Erro ao fazer upload da foto de perfil, mas o usu√°rio foi criado', 'warning');
            }
        }

        // Send WhatsApp message with credentials
        const whatsappSent = await sendWhatsAppCredentials(userData.whatsapp, userData.name, email, userData.password);
        
        const successMessage = whatsappSent ? 
            `Usu√°rio ${userData.name} criado com sucesso! Credenciais enviadas via WhatsApp.` : 
            `Usu√°rio ${userData.name} criado com sucesso! Envie as credenciais manualmente via WhatsApp.`;
            
        showNotification(successMessage, 'success');
        closeAddUserModal();
        
        // Update only the users list instead of full page reload
        setTimeout(() => {
            loadUsersData();
        }, 1000); // Delay to show notification

    } catch (error) {
        console.error('Error creating user:', error);
        showNotification('Erro ao criar usu√°rio: ' + error.message, 'error');
    }
}

function addUser() {
    openAddUserModal();
}

async function exportVolumeReport() {
    try {
        // Buscar dados de volume de leite
        const { data: volumeData, error } = await supabase
            .from('milk_production')
            .select(`
                *,
                users(name, email)
            `)
            .order('production_date', { ascending: false });

        if (error) throw error;

        // Gerar relat√≥rio em formato PDF
        await generateVolumePDF(volumeData);
        
        showNotification('Relat√≥rio de Volume exportado com sucesso!', 'success');
    } catch (error) {
        console.error('Error exporting volume report:', error);
        showNotification('Erro ao exportar relat√≥rio de volume', 'error');
    }
}

async function exportQualityReport() {
    try {
        // Buscar dados de qualidade
        const { data: qualityData, error } = await supabase
            .from('quality_tests')
            .select('*')
            .order('test_date', { ascending: false });

        if (error) throw error;

        // Gerar relat√≥rio em formato PDF
        await generateQualityPDF(qualityData);
        
        showNotification('Relat√≥rio de Qualidade exportado com sucesso!', 'success');
    } catch (error) {
        console.error('Error exporting quality report:', error);
        showNotification('Erro ao exportar relat√≥rio de qualidade', 'error');
    }
}

// Fun√ß√£o para gerar relat√≥rio de vendas
async function generatePaymentsReport() {
    try {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) throw new Error('User not authenticated');

        const { data: userData, error: userError } = await supabase
            .from('users')
            .select('farm_id')
            .eq('email', user.email)
            .single();
        
        if (userError) throw userError;

        // Buscar dados de vendas
        const { data: salesData, error } = await supabase
            .from('financial_records')
            .select('*')
            .eq('farm_id', userData.farm_id)
            .eq('type', 'receita')
            .order('created_at', { ascending: false });

        if (error) throw error;

        // Gerar relat√≥rio em formato PDF
        await generatePaymentsPDF(salesData);
        
        showNotification('Relat√≥rio de Vendas gerado com sucesso!', 'success');
    } catch (error) {
        console.error('Error generating sales report:', error);
        showNotification('Erro ao gerar relat√≥rio de vendas', 'error');
    }
}

// Helper functions for PDF generation
// Defini√ß√£o da logo do sistema (Base64 ou URL)
// Logo do sistema em SVG Base64 para uso nos relat√≥rios
const systemLogo = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjQwIiBoZWlnaHQ9IjQwIiByeD0iOCIgZmlsbD0iIzJhN2YyYSIvPgo8cGF0aCBkPSJNMTIgMjhIMjhWMjRIMTJWMjhaIiBmaWxsPSJ3aGl0ZSIvPgo8cGF0aCBkPSJNMTYgMjBIMjRWMTZIMTZWMjBaIiBmaWxsPSJ3aGl0ZSIvPgo8cGF0aCBkPSJNMjAgMTJWMzJNMTIgMjBIMjhNMTYgMTZIMjQiIHN0cm9rZT0id2hpdGUiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIi8+Cjwvc3ZnPgo=';

// Configura√ß√µes de Relat√≥rios - vari√°vel global
window.reportSettings = {
    farmName: 'Fazenda',
    farmLogo: null
};

// Carregar configura√ß√µes salvas
async function loadReportSettings() {
    try {
        const { data: userProfile, error } = await supabase.rpc('get_user_profile');
        
        if (error) throw error;
        if (!userProfile || userProfile.length === 0) return;

        const profile = userProfile[0];
        
        // Usar o nome da fazenda do perfil ou buscar no banco
        window.reportSettings.farmName = profile.report_farm_name || profile.farm_name || await getFarmName();
        window.reportSettings.farmLogo = profile.report_farm_logo_base64 || null;
        
        // Os dados est√£o carregados no window.reportSettings para uso geral
        // A aba de relat√≥rios tem sua pr√≥pria fun√ß√£o de carregamento
    } catch (error) {
        console.error('Error loading report settings:', error);
        // Em caso de erro, ainda tentar obter o nome da fazenda
        try {
            window.reportSettings.farmName = await getFarmName();
        } catch (fallbackError) {
            console.error('Error in fallback farm name loading:', fallbackError);
        }
    }
}

// Fun√ß√£o para lidar com upload da logo da fazenda
async function handleFarmLogoUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    // Validar tipo de arquivo
    if (!file.type.startsWith('image/')) {
        showNotification('Por favor, selecione um arquivo de imagem v√°lido', 'error');
        return;
    }
    
    // Validar tamanho do arquivo (m√°x. 2MB)
    if (file.size > 2 * 1024 * 1024) {
        showNotification('A imagem deve ter no m√°ximo 2MB', 'error');
        return;
    }
    
    try {
        // Converter para base64
        const base64 = await fileToBase64(file);
        window.reportSettings.farmLogo = base64;
        
        // Atualizar preview
        updateFarmLogoPreview(base64);
        
        showNotification('Logo carregada com sucesso! Clique em "Salvar Configura√ß√µes" para aplicar', 'success');
    } catch (error) {
        console.error('Erro ao processar logo:', error);
        showNotification('Erro ao processar a imagem', 'error');
    }
}

// Fun√ß√£o para converter arquivo para base64
function fileToBase64(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
    });
}

// Fun√ß√£o para atualizar preview da logo (compatibilidade com elementos que podem n√£o existir)
function updateFarmLogoPreview(base64Logo) {
    const preview = document.getElementById('farmLogoPreview');
    const placeholder = document.getElementById('farmLogoPlaceholder');
    const image = document.getElementById('farmLogoImage');
    const removeBtn = document.getElementById('removeFarmLogo');
    
    // Verificar se os elementos existem antes de tentar atualiz√°-los
    if (!preview || !placeholder || !image || !removeBtn) {
        // Elementos n√£o existem (modal foi removido), n√£o fazer nada
        return;
    }
    
    if (base64Logo) {
        image.src = base64Logo;
        preview.classList.remove('hidden');
        placeholder.classList.add('hidden');
        removeBtn.classList.remove('hidden');
    } else {
        image.src = '';
        preview.classList.add('hidden');
        placeholder.classList.remove('hidden');
        removeBtn.classList.add('hidden');
    }
}
// Fun√ß√£o para remover logo da fazenda (compatibilidade)
function removeFarmLogo() {
    window.reportSettings.farmLogo = null;
    updateFarmLogoPreview(null);
    
    // Limpar input file se existir
    const fileInput = document.getElementById('farmLogoUpload');
    if (fileInput) {
        fileInput.value = '';
    }
    
    // S√≥ mostrar notifica√ß√£o se a fun√ß√£o existir
    if (typeof showNotification === 'function') {
    showNotification('Logo removida! Clique em "Salvar Configura√ß√µes" para aplicar', 'info');
    }
}

async function saveReportSettings() {
    try {
        // Usar o nome da fazenda das configura√ß√µes globais ou padr√£o
        const farmName = window.reportSettings.farmName || 'Fazenda';
        
        const { error } = await supabase.rpc('update_user_report_settings', {
            p_report_farm_name: farmName,
            p_report_farm_logo_base64: window.reportSettings.farmLogo,
            p_report_footer_text: null,
            p_report_system_logo_base64: null
        });
        
        console.log('Salvando configura√ß√µes:', {
            farmName: farmName,
            hasLogo: !!window.reportSettings.farmLogo,
            logoLength: window.reportSettings.farmLogo ? window.reportSettings.farmLogo.length : 0
        });

        if (error) throw error;

        window.reportSettings.farmName = farmName;
        
        showNotification('Configura√ß√µes salvas com sucesso!', 'success');
    } catch (error) {
        console.error('Error saving report settings:', error);
        showNotification('Erro ao salvar configura√ß√µes', 'error');
    }
}

// Carregar configura√ß√µes ao inicializar
document.addEventListener('DOMContentLoaded', function() {
    loadReportSettings();
});

// Fun√ß√£o para pr√©via do relat√≥rio
function previewReport() {
    // Gerar um relat√≥rio de exemplo com as configura√ß√µes atuais
    const sampleData = [
        {
            production_date: new Date().toISOString(),
            volume_liters: 150.5,
            milking_type: 'morning',
            notes: 'Registro de exemplo',
            users: { name: 'Funcion√°rio Exemplo' }
        }
    ];
    
    generateVolumePDF(sampleData, true); // true indica que √© uma pr√©via
}


// Toggle password visibility function
function togglePasswordVisibility(inputId, buttonId) {
    const passwordInput = document.getElementById(inputId);
    const toggleButton = document.getElementById(buttonId);
    
    if (passwordInput.type === 'password') {
        passwordInput.type = 'text';
        toggleButton.innerHTML = `
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.878 9.878L3 3m6.878 6.878L21 21"></path>
            </svg>
        `;
    } else {
        passwordInput.type = 'password';
        toggleButton.innerHTML = `
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                <path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
            </svg>
        `;
    }
}

// Profile photo preview functions
function previewProfilePhoto(input) {
    const file = input.files[0];
    if (file) {
        // Validate file size (5MB max)
        if (file.size > 5 * 1024 * 1024) {
            showNotification('A foto deve ter no m√°ximo 5MB', 'error');
            input.value = '';
            return;
        }
        
        // Validate file type
        if (!file.type.startsWith('image/')) {
            showNotification('Por favor, selecione apenas arquivos de imagem', 'error');
            input.value = '';
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            const preview = document.getElementById('profilePreview');
            const placeholder = document.getElementById('profilePlaceholder');
            
            preview.src = e.target.result;
            preview.classList.remove('hidden');
            placeholder.classList.add('hidden');
        };
        reader.readAsDataURL(file);
    }
}

function previewEditProfilePhoto(input) {
    const file = input.files[0];
    if (file) {
        // Validate file size (5MB max)
        if (file.size > 5 * 1024 * 1024) {
            showNotification('A foto deve ter no m√°ximo 5MB', 'error');
            input.value = '';
            return;
        }
        
        // Validate file type
        if (!file.type.startsWith('image/')) {
            showNotification('Por favor, selecione apenas arquivos de imagem', 'error');
            input.value = '';
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            const preview = document.getElementById('editProfilePreview');
            const placeholder = document.getElementById('editProfilePlaceholder');
            
            preview.src = e.target.result;
            preview.classList.remove('hidden');
            placeholder.classList.add('hidden');
        };
        reader.readAsDataURL(file);
    }
}

// Upload profile photo to Supabase Storage
async function uploadProfilePhoto(file, userId) {
    try {
        console.log('=== DEBUG: uploadProfilePhoto iniciado ===');
        console.log('DEBUG: Detalhes do arquivo:', {
            name: file.name,
            size: file.size,
            type: file.type
        });
        console.log('DEBUG: userId alvo:', userId);
        
        // Get current authenticated user
        const { data: { user }, error: authError } = await supabase.auth.getUser();
        console.log('DEBUG: Usu√°rio autenticado:', { id: user?.id, email: user?.email, error: authError });
        
        if (authError || !user) {
            console.error('DEBUG: Falha na autentica√ß√£o:', authError);
            throw new Error('Usu√°rio n√£o autenticado');
        }
        
        // Get current user's farm_id for organizing photos by farm
        console.log('DEBUG: Buscando farm_id para usu√°rio:', user.id);
        const { data: managerData, error: managerError } = await supabase
            .from('users')
            .select('farm_id')
            .eq('email', user.email)
            .single();
        
        console.log('DEBUG: Dados da fazenda:', { data: managerData, error: managerError });
        
        if (managerError || !managerData?.farm_id) {
            console.error('DEBUG: Fazenda n√£o encontrada:', managerError);
            throw new Error('Farm not found');
        }
        
        const fileExt = file.name.split('.').pop();
        // Ensure we always use the target userId, never fallback to current user
        if (!userId) {
            throw new Error('userId √© obrigat√≥rio para upload de foto');
        }
        
        // Create unique filename with more specific naming
        const timestamp = Date.now();
        const randomId = Math.random().toString(36).substr(2, 9);
        const fileName = `user_${userId}_${timestamp}_${randomId}.${fileExt}`;
        const filePath = `farm_${managerData.farm_id}/${fileName}`;
        
        console.log('DEBUG: Detalhes do upload:', {
            fileName,
            filePath,
            farmId: managerData.farm_id,
            timestamp,
            randomId
        });
        
        const { data, error } = await supabase.storage
            .from('profile-photos')
            .upload(filePath, file, {
                cacheControl: '3600',
                upsert: false
            });
        
        console.log('DEBUG: Resultado do upload:', { data, error });
        
        if (error) {
            console.error('DEBUG: Erro no upload:', {
                message: error.message,
                statusCode: error.statusCode,
                error: error
            });
            throw error;
        }
        
        console.log('DEBUG: Upload bem-sucedido, gerando URL p√∫blica');
        
        const { data: { publicUrl } } = supabase.storage
            .from('profile-photos')
            .getPublicUrl(filePath);
        
        console.log('DEBUG: URL p√∫blica gerada:', publicUrl);
        return publicUrl;
    } catch (error) {
        console.error('DEBUG: Erro final:', {
            message: error.message,
            stack: error.stack,
            error: error
        });
        throw error;
    }
}

// Function to refresh users list without reloading photos
async function refreshUsersListOnly() {
    console.log('=== DEBUG: refreshUsersListOnly iniciado ===');
    try {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) {
            console.log('DEBUG: Usu√°rio n√£o autenticado');
            return;
        }
        
        // Get current user's farm_id
        const { data: userData, error: userError } = await supabase
            .from('users')
            .select('farm_id')
            .eq('id', user.id)
            .single();
        
        if (userError || !userData?.farm_id) {
            return;
        }
        
        // Get all users from the same farm (without photos to avoid cache issues)
        const { data: allUsers, error } = await supabase
            .from('users')
            .select('id, name, email, role, whatsapp, is_active, created_at')
            .eq('farm_id', userData.farm_id)
            .order('created_at', { ascending: false });
        
        if (error) {
            return;
        }
        
        // Update counts only
        if (allUsers) {
            const employeesCount = allUsers.filter(u => u.role === 'funcionario').length;
            const veterinariansCount = allUsers.filter(u => u.role === 'veterinario').length;
            const managersCount = allUsers.filter(u => u.role === 'gerente').length;
            const totalUsers = allUsers.length;
            
            document.getElementById('totalUsers').textContent = totalUsers;
            document.getElementById('employeesCount').textContent = employeesCount;
            document.getElementById('veterinariansCount').textContent = veterinariansCount;
            document.getElementById('managersCount').textContent = managersCount;
        }
        
    } catch (error) {
        console.error('DEBUG: Erro no refreshUsersListOnly:', error);
    }
}

// Function to update a specific user's photo in the list
async function updateUserPhotoInList(userId, newPhotoUrl) {
    console.log('=== DEBUG: updateUserPhotoInList iniciado ===');
    console.log('DEBUG: Atualizando foto do usu√°rio:', userId, 'com URL:', newPhotoUrl);
    
    try {
        const photoElement = document.getElementById(`user-photo-${userId}`);
        const iconElement = document.getElementById(`user-icon-${userId}`);
        
        if (photoElement && newPhotoUrl) {
            // Update the photo with cache buster
            const cacheBuster = Date.now();
            photoElement.src = newPhotoUrl + '?cb=' + cacheBuster;
            photoElement.style.display = 'block';
            
            if (iconElement) {
                iconElement.style.display = 'none';
            }
            
            console.log('DEBUG: Foto atualizada com sucesso para usu√°rio:', userId);
        } else if (iconElement && !newPhotoUrl) {
            // Show icon if no photo
            if (photoElement) {
                photoElement.style.display = 'none';
            }
            iconElement.style.display = 'flex';
            
            console.log('DEBUG: √çcone mostrado para usu√°rio:', userId);
        }
        
    } catch (error) {
        console.error('DEBUG: Erro ao atualizar foto na lista:', error);
    }
}
// Debug function to check all users photos
async function debugCheckAllPhotos() {
    console.log('=== DEBUG: Verificando todas as fotos no banco ===');
    try {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) {
            console.log('DEBUG: Usu√°rio n√£o autenticado');
            return;
        }
        
        // Get current user's farm_id
        const { data: userData, error: userError } = await supabase
            .from('users')
            .select('farm_id')
            .eq('id', user.id)
            .single();
        
        if (userError || !userData?.farm_id) {
            console.log('DEBUG: Erro ao obter farm_id:', userError);
            return;
        }
        
        // Get all users from the same farm
        const { data: allUsers, error } = await supabase
            .from('users')
            .select('id, name, email, role, profile_photo_url, created_at')
            .eq('farm_id', userData.farm_id)
            .order('created_at', { ascending: false });
        
        if (error) {
            console.log('DEBUG: Erro ao buscar usu√°rios:', error);
            return;
        }
        
        console.log('DEBUG: Estado atual das fotos no banco:');
        allUsers.forEach(u => {
            console.log(`- ${u.name} (${u.role}): ${u.profile_photo_url || 'Sem foto'}`);
        });
        
    } catch (error) {
        console.error('DEBUG: Erro na verifica√ß√£o:', error);
    }
}

// Sign out function
async function signOut() {
    if (confirm('Tem certeza que deseja sair?')) {
        await supabase.auth.signOut();
        window.location.href = 'index.html';
    }
}

// Fun√ß√£o para carregar dados da conta secund√°ria existente
async function loadSecondaryAccountData() {
    try {
        // Get current user data
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) {
            console.error('Usu√°rio n√£o autenticado');
            return;
        }
        
        // Get user details from users table
        const { data: userData, error: userError } = await supabase
            .from('users')
            .select('*')
            .eq('id', user.id)
            .single();
            
        if (userError) {
            console.error('Erro ao buscar dados do usu√°rio:', userError);
            return;
        }
        
        // Verificar se existe uma conta secund√°ria usando a tabela secondary_accounts
        let secondaryAccountRelation = null;
        try {
            const { data: relationData, error: relationError } = await supabase
                .from('secondary_accounts')
                .select('secondary_account_id')
                .eq('primary_account_id', user.id)
                .maybeSingle();
                
            if (relationError) {
                console.error('Erro ao verificar rela√ß√£o de conta secund√°ria:', relationError);
            } else {
                secondaryAccountRelation = relationData;
            }
        } catch (error) {
            console.error('Erro ao acessar tabela secondary_accounts:', error);
        }
        
        // Se n√£o encontrou na tabela de rela√ß√µes, tenta o m√©todo antigo
        if (!secondaryAccountRelation) {
            try {
                // Check if secondary account exists by email
                const { data: secondaryAccount, error: secondaryError } = await supabase
                    .from('users')
                    .select('*')
                    .eq('email', userData.email)
                    .eq('farm_id', userData.farm_id)
                    .neq('id', userData.id)
                    .maybeSingle();
                
                if (secondaryError) {
                    console.error('Erro ao verificar conta secund√°ria:', secondaryError);
                }
                
                if (secondaryAccount) {
                    // Preencher o formul√°rio com os dados da conta secund√°ria
                    const nameField = document.getElementById('secondaryAccountName');
                    const roleField = document.getElementById('secondaryAccountRole');
                    const activeField = document.getElementById('secondaryAccountActive');
                    
                    if (nameField) nameField.value = secondaryAccount.name;
                    if (roleField) roleField.value = secondaryAccount.role;
                    if (activeField) activeField.checked = secondaryAccount.is_active;
                    
                    // Atualizar o status da conta secund√°ria
                    const noAccountDiv = document.getElementById('noSecondaryAccount');
                    const hasAccountDiv = document.getElementById('hasSecondaryAccount');
                    const nameDisplay = document.getElementById('secondaryAccountNameDisplay');
                    const switchBtn = document.getElementById('switchAccountBtn');
                    
                    if (noAccountDiv) noAccountDiv.style.display = 'none';
                    if (hasAccountDiv) hasAccountDiv.style.display = 'block';
                    if (nameDisplay) nameDisplay.textContent = secondaryAccount.name;
                    if (switchBtn) switchBtn.disabled = false;
                    
                    // Criar a rela√ß√£o na tabela secondary_accounts se n√£o existir
                    try {
                        const { error: insertError } = await supabase
                            .from('secondary_accounts')
                            .insert([
                                {
                                    primary_account_id: user.id,
                                    secondary_account_id: secondaryAccount.id
                                }
                            ]);
                            
                        if (insertError && !insertError.message.includes('duplicate key')) {
                            console.error('Erro ao criar rela√ß√£o de conta secund√°ria:', insertError);
                        }
                    } catch (error) {
                        console.error('Erro ao criar rela√ß√£o:', error);
                    }
                } else {
                    // Limpar o formul√°rio
                    const nameField = document.getElementById('secondaryAccountName');
                    const roleField = document.getElementById('secondaryAccountRole');
                    const activeField = document.getElementById('secondaryAccountActive');
                    
                    if (nameField) nameField.value = '';
                    if (roleField) roleField.value = 'funcionario';
                    if (activeField) activeField.checked = true;
                    
                    // Atualizar o status da conta secund√°ria
                    const noAccountDiv = document.getElementById('noSecondaryAccount');
                    const hasAccountDiv = document.getElementById('hasSecondaryAccount');
                    const switchBtn = document.getElementById('switchAccountBtn');
                    
                    if (noAccountDiv) noAccountDiv.style.display = 'block';
                    if (hasAccountDiv) hasAccountDiv.style.display = 'none';
                    if (switchBtn) switchBtn.disabled = true;
                }
            } catch (error) {
                console.error('Erro ao verificar conta secund√°ria:', error);
            }
        } else {
            try {
                // Buscar os dados da conta secund√°ria usando o ID da rela√ß√£o
                const { data: secondaryAccount, error: accountError } = await supabase
                    .from('users')
                    .select('*')
                    .eq('id', secondaryAccountRelation.secondary_account_id)
                    .single();
                    
                if (accountError) {
                    console.error('Erro ao buscar dados da conta secund√°ria:', accountError);
                    return;
                }
                
                // Preencher o formul√°rio com os dados da conta secund√°ria
                const nameField = document.getElementById('secondaryAccountName');
                const roleField = document.getElementById('secondaryAccountRole');
                const activeField = document.getElementById('secondaryAccountActive');
                
                if (nameField) nameField.value = secondaryAccount.name;
                if (roleField) roleField.value = secondaryAccount.role;
                if (activeField) activeField.checked = secondaryAccount.is_active;
                
                // Atualizar o status da conta secund√°ria
                const noAccountDiv = document.getElementById('noSecondaryAccount');
                const hasAccountDiv = document.getElementById('hasSecondaryAccount');
                const nameDisplay = document.getElementById('secondaryAccountNameDisplay');
                const switchBtn = document.getElementById('switchAccountBtn');
                
                if (noAccountDiv) noAccountDiv.style.display = 'none';
                if (hasAccountDiv) hasAccountDiv.style.display = 'block';
                if (nameDisplay) nameDisplay.textContent = secondaryAccount.name;
                if (switchBtn) switchBtn.disabled = false;
            } catch (error) {
                console.error('Erro ao buscar dados da conta secund√°ria:', error);
            }
        }
    } catch (error) {
        console.error('Erro ao carregar dados da conta secund√°ria:', error);
    }
}

// Fun√ß√£o para salvar a conta secund√°ria
async function saveSecondaryAccount(event) {
    event.preventDefault();
    
    try {
        // Mostrar indicador de carregamento
        const submitBtn = event.target.querySelector('button[type="submit"]');
        const originalBtnText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<svg class="animate-spin h-5 w-5 mr-2" viewBox="0 0 24 24" fill="none"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Salvando...';
        submitBtn.disabled = true;
        
        // Get current user data
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) {
            console.error('Usu√°rio n√£o autenticado');
            return;
        }
        
        // Get user details from users table
        const { data: userData, error: userError } = await supabase
            .from('users')
            .select('*')
            .eq('id', user.id)
            .single();
            
        if (userError) {
            console.error('Erro ao buscar dados do usu√°rio:', userError);
            return;
        }
        
        // Get form data
        const secondaryRole = document.getElementById('secondaryAccountRole').value;
        const roleSuffix = secondaryRole === 'veterinario' ? ' (Veterin√°rio)' : ' (Funcion√°rio)';
        const secondaryName = document.getElementById('secondaryAccountName').value.trim() || userData.name + roleSuffix;
        const isActive = document.getElementById('secondaryAccountActive').checked;
        
        // Gerar email √∫nico para a conta secund√°ria
        const secondaryEmail = userData.email + (secondaryRole === 'veterinario' ? '.vet' : '.func');
        
        // Verificar se j√° existe uma conta secund√°ria com o mesmo email modificado
        const { data: existingAccount, error: checkError } = await supabase
            .from('users')
            .select('*')
            .eq('email', secondaryEmail)
            .eq('farm_id', userData.farm_id)
            .maybeSingle();
        
        let secondaryAccount;
        
        if (!checkError && existingAccount) {
            // Update existing account
            const { data: updatedAccount, error: updateError } = await supabase
                .from('users')
                .update({
                    name: secondaryName,
                    role: secondaryRole,
                    is_active: isActive
                })
                .eq('id', existingAccount.id)
                .select()
                .single();
                
            if (updateError) {
                console.error('Erro ao atualizar conta secund√°ria:', updateError);
                showNotification('Erro ao atualizar conta secund√°ria. Por favor, tente novamente.', 'error');
                return;
            }
            
            secondaryAccount = updatedAccount;
            showNotification('Conta secund√°ria atualizada com sucesso!', 'success');
            
            // Verificar se j√° existe uma rela√ß√£o na tabela secondary_accounts
            const { data: existingRelation, error: relationError } = await supabase
                .from('secondary_accounts')
                .select('*')
                .eq('primary_account_id', user.id)
                .eq('secondary_account_id', secondaryAccount.id)
                .single();
                
            if (relationError && relationError.code !== 'PGRST116') {
                console.error('Erro ao verificar rela√ß√£o de conta secund√°ria:', relationError);
            }
            
            // Se n√£o existir rela√ß√£o, criar uma
            if (!existingRelation) {
                const { error: insertError } = await supabase
                    .from('secondary_accounts')
                    .insert([
                        {
                            primary_account_id: user.id,
                            secondary_account_id: secondaryAccount.id
                        }
                    ]);
                    
                if (insertError) {
                    console.error('Erro ao criar rela√ß√£o de conta secund√°ria:', insertError);
                }
            }
        } else {
            // Create new secondary account
            console.log('Criando nova conta secund√°ria com dados:', {
                farm_id: userData.farm_id,
                name: secondaryName,
                email: secondaryEmail,
                role: secondaryRole,
                whatsapp: userData.whatsapp,
                is_active: isActive,
                profile_photo_url: userData.profile_photo_url
            });
            
            // Verificar se j√° existe um usu√°rio com o mesmo email e farm_id
            const { data: existingUsers, error: existingError } = await supabase
                .from('users')
                .select('*')
                .eq('email', secondaryEmail)
                .eq('farm_id', userData.farm_id)
                .neq('id', userData.id);
                
            if (existingError) {
                console.error('Erro ao verificar usu√°rios existentes:', existingError);
            } else {
                console.log('Usu√°rios existentes com mesmo email e farm_id:', existingUsers);
                
                // Se j√° existir um usu√°rio secund√°rio, atualizar em vez de criar
                if (existingUsers && existingUsers.length > 0) {
                    const { data: updatedAccount, error: updateError } = await supabase
                        .from('users')
                        .update({
                            name: secondaryName,
                            role: secondaryRole,
                            is_active: isActive
                        })
                        .eq('id', existingUsers[0].id)
                        .select()
                        .single();
                        
                    if (updateError) {
                        console.error('Erro ao atualizar conta secund√°ria existente:', updateError);
                        showNotification('Erro ao atualizar conta secund√°ria. Por favor, tente novamente.', 'error');
                        return;
                    }
                    
                    secondaryAccount = updatedAccount;
                    showNotification('Conta secund√°ria atualizada com sucesso!', 'success');
                    
                    // Verificar se j√° existe uma rela√ß√£o na tabela secondary_accounts
                    const { data: existingRelation, error: relationError } = await supabase
                        .from('secondary_accounts')
                        .select('*')
                        .eq('primary_account_id', user.id)
                        .eq('secondary_account_id', secondaryAccount.id)
                        .single();
                        
                    if (relationError && relationError.code !== 'PGRST116') {
                        console.error('Erro ao verificar rela√ß√£o de conta secund√°ria:', relationError);
                    }
                    
                    // Se n√£o existir rela√ß√£o, criar uma
                    if (!existingRelation) {
                        const { error: insertError } = await supabase
                            .from('secondary_accounts')
                            .insert([
                                {
                                    primary_account_id: user.id,
                                    secondary_account_id: secondaryAccount.id
                                }
                            ]);
                            
                        if (insertError) {
                            console.error('Erro ao criar rela√ß√£o de conta secund√°ria:', insertError);
                        }
                    }
                } else {
                    // Create new secondary account
                    const { data: newAccount, error: insertError } = await supabase
                        .from('users')
                        .insert([
                            {
                                farm_id: userData.farm_id,
                                name: secondaryName,
                                email: secondaryEmail,
                                role: secondaryRole,
                                whatsapp: userData.whatsapp,
                                is_active: isActive,
                                profile_photo_url: userData.profile_photo_url
                            }
                        ])
                        .select()
                        .single();
                        
                    if (insertError) {
                        console.error('Erro ao criar nova conta secund√°ria:', insertError);
                        showNotification('Erro ao criar conta secund√°ria. Por favor, tente novamente.', 'error');
                        return;
                    }
                    
                    secondaryAccount = newAccount;
                    showNotification('Conta secund√°ria criada com sucesso!', 'success');
                    
                    // Create relation in secondary_accounts table
                    const { error: relationError } = await supabase
                        .from('secondary_accounts')
                        .insert([
                            {
                                primary_account_id: user.id,
                                secondary_account_id: secondaryAccount.id
                            }
                        ]);
                        
                                         if (relationError) {
                         console.error('Erro ao criar rela√ß√£o de conta secund√°ria:', relationError);
                     }
                 }
             }
         }
         
         // Atualizar a interface e sair da fun√ß√£o com verifica√ß√µes de seguran√ßa
        const noSecondaryAccount = document.getElementById('noSecondaryAccount');
        const hasSecondaryAccount = document.getElementById('hasSecondaryAccount');
        const secondaryAccountNameDisplay = document.getElementById('secondaryAccountNameDisplay');
        const switchAccountBtn = document.getElementById('switchAccountBtn');
        
        if (noSecondaryAccount) noSecondaryAccount.style.display = 'none';
        if (hasSecondaryAccount) hasSecondaryAccount.style.display = 'block';
        if (secondaryAccountNameDisplay) secondaryAccountNameDisplay.textContent = secondaryAccount.name;
        if (switchAccountBtn) switchAccountBtn.disabled = false;
        
        hideSecondaryAccountForm();
        
        // Atualizar os cards de contas
        loadAccountCards();
        
        // Mostrar modal de sucesso
        showSecondaryAccountSuccessModal(secondaryAccount);
    } catch (error) {
        console.error('Erro ao salvar conta secund√°ria:', error);
        showNotification('Ocorreu um erro ao salvar a conta secund√°ria.', 'error');
    } finally {
        // Restaurar o bot√£o
        const submitBtn = event.target.querySelector('button[type="submit"]');
        submitBtn.innerHTML = 'Salvar Configura√ß√µes';
        submitBtn.disabled = false;
    }
}

// Fun√ß√£o para alternar a visibilidade do painel de contas
function toggleAccountsPanel() {
    const panel = document.getElementById('accountsPanel');
    if (panel.classList.contains('hidden')) {
        panel.classList.remove('hidden');
        loadAccountCards();
    } else {
        panel.classList.add('hidden');
    }
}

// Fun√ß√£o para carregar os cards de contas
async function loadAccountCards() {
    try {
        // Get current user data
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) {
            console.error('Usu√°rio n√£o autenticado');
            return;
        }
        
        // Get user details from users table
        const { data: userData, error: userError } = await supabase
            .from('users')
            .select('*')
            .eq('id', user.id)
            .single();
            
        if (userError) {
            console.error('Erro ao buscar dados do usu√°rio:', userError);
            return;
        }
        
        // Limpar o container de cards
        const cardsContainer = document.getElementById('accountCards');
        cardsContainer.innerHTML = '';
        
        // Adicionar card da conta principal
        const primaryCard = document.createElement('div');
        primaryCard.className = 'bg-white border border-blue-100 rounded-xl p-4 shadow-sm hover:shadow-md transition-all';
        primaryCard.innerHTML = `
            <div class="flex items-center space-x-3">
                <div class="flex-shrink-0">
                    <div class="w-12 h-12 rounded-full bg-forest-100 flex items-center justify-center text-forest-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                        </svg>
                    </div>
                </div>
                <div class="flex-1">
                    <h5 class="font-medium text-blue-900">${userData.name}</h5>
                    <p class="text-sm text-blue-600 capitalize">${userData.role}</p>
                </div>
                <div>
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-forest-100 text-forest-800">
                        Atual
                    </span>
                </div>
            </div>
        `;
        cardsContainer.appendChild(primaryCard);
        
        // Buscar contas secund√°rias na tabela secondary_accounts
        const { data: secondaryRelations, error: relError } = await supabase
            .from('secondary_accounts')
            .select('secondary_account_id')
            .eq('primary_account_id', user.id);
            
        if (relError) {
            console.error('Erro ao buscar rela√ß√µes de contas secund√°rias:', relError);
            return;
        }
        
        if (secondaryRelations && secondaryRelations.length > 0) {
            // Buscar detalhes de cada conta secund√°ria
            for (const relation of secondaryRelations) {
                const { data: secondaryAccount, error: accountError } = await supabase
                    .from('users')
                    .select('*')
                    .eq('id', relation.secondary_account_id)
                    .single();
                    
                if (accountError) {
                    console.error('Erro ao buscar detalhes da conta secund√°ria:', accountError);
                    continue;
                }
                
                // Criar card para a conta secund√°ria
                const secondaryCard = document.createElement('div');
                secondaryCard.className = 'bg-white border border-blue-100 rounded-xl p-4 shadow-sm hover:shadow-md transition-all';
                secondaryCard.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <div class="flex-shrink-0">
                            <div class="w-12 h-12 rounded-full bg-blue-100 flex items-center justify-center text-blue-600">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                </svg>
                            </div>
                        </div>
                        <div class="flex-1">
                            <h5 class="font-medium text-blue-900">${secondaryAccount.name}</h5>
                            <p class="text-sm text-blue-600 capitalize">${secondaryAccount.role}</p>
                        </div>
                        <div>
                            <button onclick="switchToAccount('${secondaryAccount.id}')" class="px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium rounded-lg transition-all">
                                Alternar
                            </button>
                        </div>
                    </div>
                `;
                cardsContainer.appendChild(secondaryCard);
            }
        } else {
            // Se n√£o encontrou contas secund√°rias, mostrar mensagem
            const noAccountsMessage = document.createElement('div');
            noAccountsMessage.className = 'text-center p-4 text-blue-600';
            noAccountsMessage.innerHTML = `
                <p>Voc√™ ainda n√£o possui contas secund√°rias configuradas.</p>
                <button onclick="showSecondaryAccountForm()" class="mt-2 px-3 py-1 bg-forest-500 hover:bg-forest-600 text-white text-sm font-medium rounded-lg transition-all">
                    Configurar Conta
                </button>
            `;
            cardsContainer.appendChild(noAccountsMessage);
        }
    } catch (error) {
        console.error('Erro ao carregar cards de contas:', error);
    }
}

// Fun√ß√£o para alternar para uma conta espec√≠fica
async function switchToAccount(accountId) {
    try {
        // Get current user data
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) {
            console.error('Usu√°rio n√£o autenticado');
            return;
        }
        
        // Get user details from users table
        const { data: userData, error: userError } = await supabase
            .from('users')
            .select('*')
            .eq('id', user.id)
            .single();
            
        if (userError) {
            console.error('Erro ao buscar dados do usu√°rio:', userError);
            return;
        }
        
        // Store current role in session storage
        sessionStorage.setItem('previous_role', userData.role);
        
        // Get secondary account details
        const { data: secondaryAccount, error: secondaryError } = await supabase
            .from('users')
            .select('*')
            .eq('id', accountId)
            .single();
        
        if (secondaryError) {
            console.error('Erro ao buscar conta secund√°ria:', secondaryError);
            return;
        }
        
        if (!secondaryAccount.is_active) {
            showNotification('Esta conta est√° desativada. Por favor, ative-a nas configura√ß√µes.', 'warning');
            showSecondaryAccountForm();
            return;
        }
        
        // Secondary account exists and is active, switch to it
        console.log('Alternando para conta secund√°ria');
        
        // Store current user session data
        const currentSession = {
            id: userData.id,
            email: userData.email,
            name: userData.name,
            user_type: userData.role,
            farm_id: userData.farm_id,
            farm_name: sessionStorage.getItem('farm_name') || ''
        };
        
        // Store secondary account session data
        const secondarySession = {
            id: secondaryAccount.id,
            email: secondaryAccount.email,
            name: secondaryAccount.name,
            user_type: secondaryAccount.role,
            farm_id: secondaryAccount.farm_id,
            farm_name: sessionStorage.getItem('farm_name') || ''
        };
        // Save current session for later
        sessionStorage.setItem('primary_account', JSON.stringify(currentSession));
        
        // Set new session
        sessionStorage.setItem('user', JSON.stringify(secondarySession));
        
        // Redirect to appropriate page based on role
        if (secondaryAccount.role === 'funcionario') {
            window.location.href = 'funcionario.html';
        } else if (secondaryAccount.role === 'veterinario') {
            window.location.href = 'veterinario.html';
        } else {
            showNotification('Conta secund√°ria encontrada, mas o tipo n√£o √© reconhecido.', 'warning');
        }
    } catch (error) {
        console.error('Erro ao alternar conta:', error);
        showNotification('Ocorreu um erro ao alternar para a conta secund√°ria.', 'error');
    }
}

// Function to switch between manager and inseminator accounts (mantido para compatibilidade)
async function switchToSecondaryAccount() {
    try {
        // Get current user data
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) {
            console.error('Usu√°rio n√£o autenticado');
            return;
        }
        
        const { data: secondaryRelations, error: relError } = await supabase
            .from('secondary_accounts')
            .select('secondary_account_id')
            .eq('primary_account_id', user.id);
            
        if (relError || !secondaryRelations || secondaryRelations.length === 0) {
            showNotification('Voc√™ precisa configurar uma conta secund√°ria primeiro.', 'warning');
            showSecondaryAccountForm();
            return;
        }
        
        if (secondaryRelations.length > 1) {
            toggleAccountsPanel();
            return;
        }
        
        switchToAccount(secondaryRelations[0].secondary_account_id);
    } catch (error) {
        console.error('Erro ao alternar conta:', error);
        showNotification('Ocorreu um erro ao alternar para a conta secund√°ria.', 'error');
    }
}


async function checkIfSecondaryAccount() {
    try {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) return false;
        
        const { data: relation, error } = await supabase
            .from('secondary_accounts')
            .select('primary_account_id')
            .eq('secondary_account_id', user.id)
            .single();
        
        if (error || !relation) {
            return false;
        }
        
        return true;
    } catch (error) {
        console.error('Erro ao verificar se √© conta secund√°ria:', error);
        return false;
    }
}

async function showAlterSecondaryAccountSection() {
    const isSecondary = await checkIfSecondaryAccount();
    const alterSection = document.getElementById('alterSecondaryAccountSection');
    
    if (alterSection) {
        if (isSecondary) {
            alterSection.style.display = 'block';
            console.log('‚úÖ Se√ß√£o de altera√ß√£o de conta secund√°ria mostrada');
        } else {
            alterSection.style.display = 'none';
            console.log('‚ÑπÔ∏è Usu√°rio n√£o √© conta secund√°ria, se√ß√£o oculta');
        }
    }
}

// Fun√ß√£o para mostrar formul√°rio de altera√ß√£o de conta secund√°ria
function showAlterSecondaryAccountForm() {
    const form = document.getElementById('secondaryAccountForm');
    const alterBtn = document.getElementById('alterSecondaryAccountBtn');
    
    if (form) {
        form.style.display = 'block';
        // Mudar o texto do bot√£o para indicar que √© uma altera√ß√£o
        const submitBtn = form.querySelector('button[type="submit"]');
        if (submitBtn) {
            submitBtn.innerHTML = 'Alterar Conta Secund√°ria';
        }
        
        // Carregar dados atuais da conta
        loadCurrentSecondaryAccountData();
    }
    
    if (alterBtn) {
        alterBtn.style.display = 'none';
    }
}

// Fun√ß√£o para carregar dados atuais da conta secund√°ria
async function loadCurrentSecondaryAccountData() {
    try {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) return;
        
        // Buscar dados atuais do usu√°rio
        const { data: userData, error } = await supabase
            .from('users')
            .select('name, email, role, is_active')
            .eq('id', user.id)
            .single();
        
        if (error) {
            console.error('Erro ao carregar dados atuais:', error);
            return;
        }
        
        // Preencher formul√°rio com dados atuais
        const nameField = document.getElementById('secondaryAccountName');
        const roleField = document.getElementById('secondaryAccountRole');
        const activeField = document.getElementById('secondaryAccountActive');
        
        if (nameField) nameField.value = userData.name || '';
        if (roleField) roleField.value = userData.role || 'funcionario';
        if (activeField) activeField.checked = userData.is_active || false;
        
        console.log('‚úÖ Dados atuais carregados no formul√°rio');
        
    } catch (error) {
        console.error('Erro ao carregar dados atuais:', error);
    }
}

// Fun√ß√£o para salvar altera√ß√µes da conta secund√°ria
async function saveSecondaryAccountAlteration(event) {
    event.preventDefault();
    
    try {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) {
            showNotification('Usu√°rio n√£o autenticado', 'error');
            return;
        }
        
        // Obter dados do formul√°rio
        const name = document.getElementById('secondaryAccountName').value.trim();
        const role = document.getElementById('secondaryAccountRole').value;
        const isActive = document.getElementById('secondaryAccountActive').checked;
        
        if (!name) {
            showNotification('Por favor, informe o nome da conta.', 'warning');
            return;
        }
        
        // Atualizar dados do usu√°rio
        const { data: updatedUser, error: updateError } = await supabase
            .from('users')
            .update({
                name: name,
                role: role,
                is_active: isActive
            })
            .eq('id', user.id)
            .select()
            .single();
        
        if (updateError) {
            console.error('Erro ao atualizar conta:', updateError);
            showNotification('Erro ao atualizar a conta secund√°ria.', 'error');
            return;
        }
        
        // Atualizar dados da sess√£o
        const sessionData = {
            id: updatedUser.id,
            email: updatedUser.email,
            name: updatedUser.name,
            role: updatedUser.role,
            farm_id: updatedUser.farm_id,
            is_active: updatedUser.is_active
        };
        
        localStorage.setItem('userData', JSON.stringify(sessionData));
        
        // Esconder formul√°rio
        hideSecondaryAccountForm();
        
        // Mostrar modal de sucesso
        showSecondaryAccountSuccessModal(updatedUser, 'alteracao');
        
        // Recarregar dados da p√°gina
        await loadUserProfile();
        await setManagerName();
        
        console.log('‚úÖ Conta secund√°ria alterada com sucesso');
        
    } catch (error) {
        console.error('Erro ao alterar conta secund√°ria:', error);
        showNotification('Ocorreu um erro ao alterar a conta secund√°ria.', 'error');
    }
}

// Modificar a fun√ß√£o showSecondaryAccountSuccessModal para suportar altera√ß√µes
function showSecondaryAccountSuccessModal(account, action = 'criacao') {
    const modal = document.getElementById('secondaryAccountSuccessModal');
    const title = document.getElementById('successModalTitle');
    const message = document.getElementById('successModalMessage');
    const name = document.getElementById('successAccountName');
    const role = document.getElementById('successAccountRole');
    const email = document.getElementById('successAccountEmail');
    
    if (modal && title && message && name && role && email) {
        if (action === 'alteracao') {
            title.textContent = 'Conta Secund√°ria Alterada!';
            message.textContent = 'Suas informa√ß√µes foram atualizadas com sucesso.';
        } else {
            title.textContent = 'Conta Secund√°ria Criada!';
            message.textContent = 'Sua conta secund√°ria foi configurada com sucesso.';
        }
        
        name.textContent = account.name || 'N√£o informado';
        role.textContent = account.role || 'N√£o informado';
        email.textContent = account.email || 'N√£o informado';
        
        modal.classList.remove('hidden');
        
        // Auto-close ap√≥s 5 segundos
        setTimeout(() => {
            closeSecondaryAccountSuccessModal();
        }, 5000);
    }
}

// Fun√ß√£o para lidar com submiss√£o do formul√°rio (cria√ß√£o ou altera√ß√£o)
async function handleSecondaryAccountSubmit(event) {
    event.preventDefault();
    
    try {
        // Verificar se √© uma conta secund√°ria
        const isSecondary = await checkIfSecondaryAccount();
        
        if (isSecondary) {
            // Se √© conta secund√°ria, usar fun√ß√£o de altera√ß√£o
            await saveSecondaryAccountAlteration(event);
        } else {
            // Se n√£o √© conta secund√°ria, usar fun√ß√£o de cria√ß√£o
            await saveSecondaryAccount(event);
        }
        
    } catch (error) {
        console.error('Erro ao processar submiss√£o do formul√°rio:', error);
        showNotification('Ocorreu um erro ao processar a solicita√ß√£o.', 'error');
    }
}





// LIMPEZA DAS FUN√á√ïES DE CARREGAMENTO
// Remove console.logs e corrige problemas de carregamento

// Fun√ß√£o limpa para carregar dados do usu√°rio
async function loadUserProfileClean() {
    try {
        const whatsappElement = document.getElementById('profileWhatsApp');
        
        if (!whatsappElement) {
            return;
        }
        
        // Primeiro tentar obter da sess√£o local
        const sessionData = localStorage.getItem('userData') || sessionStorage.getItem('userData');
        
        if (sessionData) {
            try {
                const user = JSON.parse(sessionData);
                
                // Definir dados do perfil da sess√£o
                document.getElementById('profileEmail2').textContent = user.email || '';
                const whatsappValue = user.whatsapp || user.phone || 'N√£o informado';
                document.getElementById('profileWhatsApp').textContent = whatsappValue;
                return;
            } catch (error) {
                // Continuar para fallback
            }
        }
        
        // Fallback para Supabase Auth
        const { data: { user } } = await supabase.auth.getUser();
        
        if (!user) {
            document.getElementById('profileEmail2').textContent = 'N√£o logado';
            document.getElementById('profileWhatsApp').textContent = 'N√£o informado';
            return;
        }

        // Buscar dados do usu√°rio no banco
        const { data: userData, error } = await supabase
            .from('users')
            .select('name, email, whatsapp')
            .eq('email', user.email)
            .single();
        
        // Se usu√°rio n√£o encontrado, mostrar erro
        if (error && error.code === 'PGRST116') {
            document.getElementById('profileEmail2').textContent = user.email || '';
            document.getElementById('profileWhatsApp').textContent = 'Usu√°rio n√£o encontrado';
            return;
        }
        
        if (error) {
            document.getElementById('profileEmail2').textContent = user.email || '';
            document.getElementById('profileWhatsApp').textContent = 'Erro ao carregar';
            return;
        }

        // Atualizar elementos do perfil
        if (userData) {
            const email = userData.email || user.email || '';
            const whatsapp = userData.whatsapp || 'N√£o informado';
            
            document.getElementById('profileEmail2').textContent = email;
            document.getElementById('profileWhatsApp').textContent = whatsapp;
        } else {
            document.getElementById('profileEmail2').textContent = user.email || '';
            document.getElementById('profileWhatsApp').textContent = 'N√£o informado';
        }
        
        // Atualizar foto do perfil se dispon√≠vel
        if (userData?.profile_photo_url) {
            updateProfilePhotoDisplay(userData.profile_photo_url + '?t=' + Date.now());
        }
    } catch (error) {
        document.getElementById('profileEmail2').textContent = 'Erro';
        document.getElementById('profileWhatsApp').textContent = 'Erro';
    }
}

// Fun√ß√£o limpa para definir nome da fazenda
async function setFarmNameClean() {
    try {
        const farmName = await getFarmName();
        const farmNameElement = document.getElementById('farmNameHeader');
        if (farmNameElement) {
            farmNameElement.textContent = farmName;
        }
    } catch (error) {
        const farmNameElement = document.getElementById('farmNameHeader');
        if (farmNameElement) {
            farmNameElement.textContent = 'Minha Fazenda';
        }
    }
}

// Fun√ß√£o limpa para definir nome do gerente
async function setManagerNameClean() {
    try {
        const managerName = await getManagerName();
        const farmName = await getFarmName();
        
        const finalManagerName = managerName || 'Gerente';
        const finalFarmName = farmName || 'Minha Fazenda';
        
        // Extract formal name for welcome message
        const formalName = extractFormalName(finalManagerName);
        
        const elements = [
            'profileName',
            'profileFullName'
        ];
        
        elements.forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.textContent = finalManagerName;
            }
        });
        
        // Set header and welcome message with formal name
        const headerElement = document.getElementById('managerName');
        const welcomeElement = document.getElementById('managerWelcome');
        if (headerElement) {
            headerElement.textContent = formalName;
        }
        if (welcomeElement) {
            welcomeElement.textContent = formalName;
        }
        
        const farmElement = document.getElementById('profileFarmName');
        if (farmElement) {
            farmElement.textContent = finalFarmName;
        }
    } catch (error) {
        // Definir valores padr√£o em caso de erro
        const defaultName = 'Gerente';
        const defaultFarm = 'Minha Fazenda';
        
        const elements = [
            'profileName', 
            'profileFullName'
        ];
        
        elements.forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.textContent = defaultName;
            }
        });
        
        // Set header and welcome message with formal name
        const headerElement = document.getElementById('managerName');
        const welcomeElement = document.getElementById('managerWelcome');
        if (headerElement) {
            headerElement.textContent = defaultName;
        }
        if (welcomeElement) {
            welcomeElement.textContent = defaultName;
        }
        
        const farmElement = document.getElementById('profileFarmName');
        if (farmElement) {
            farmElement.textContent = defaultFarm;
        }
    }
}

// Substituir fun√ß√µes originais pelas vers√µes limpas
window.loadUserProfile = loadUserProfileClean;
window.setFarmName = setFarmNameClean;
window.setManagerName = setManagerNameClean;

// Fun√ß√µes do gerente substitu√≠das pelas vers√µes limpas

// REMO√á√ÉO COMPLETA DE TODOS OS CONSOLE.LOGS PARA PROTEGER O BANCO
// Substituir console.log por fun√ß√£o vazia para evitar sobrecarga
const originalConsoleLog = console.log;
const originalConsoleError = console.error;

// TEMPORARIAMENTE HABILITADO PARA DEBUG
// console.log = function() {
//     // N√£o fazer nada - silenciar completamente
// };

// console.error = function() {
//     // N√£o fazer nada - silenciar completamente
// };

// Fun√ß√£o para restaurar console.log se necess√°rio (para debug)
window.restoreConsoleLogs = function() {
    console.log = originalConsoleLog;
    console.error = originalConsoleError;
};

// Fun√ß√£o para verificar se h√° muitas requisi√ß√µes
window.checkDatabaseRequests = function() {
    // Monitorar requisi√ß√µes ao banco
    const originalFetch = window.fetch;
    let requestCount = 0;
    
    window.fetch = function(...args) {
        requestCount++;
        if (requestCount > 100) {
            console.warn('‚ö†Ô∏è Muitas requisi√ß√µes detectadas:', requestCount);
        }
        return originalFetch.apply(this, args);
    };
    
    // Reset contador a cada 5 segundos
    setInterval(() => {
        requestCount = 0;
    }, 5000);
};

// Ativar prote√ß√£o contra muitas requisi√ß√µes
checkDatabaseRequests();

console.log('‚úÖ BANCO PROTEGIDO - CONSOLE.LOGS REMOVIDOS');

// ===== FUN√á√ïES PARA FOTO DO GERENTE =====

// Vari√°vel global para armazenar a foto selecionada
let selectedManagerPhoto = null;

// Fun√ß√£o para alternar modo de edi√ß√£o da foto do gerente
function toggleManagerPhotoEdit() {
    const viewMode = document.getElementById('managerPhotoViewMode');
    const editMode = document.getElementById('managerPhotoEditMode');
    const editBtn = document.getElementById('editManagerPhotoBtn');
    
    if (viewMode.classList.contains('hidden')) {
        // Voltar para modo visualiza√ß√£o
        viewMode.classList.remove('hidden');
        editMode.classList.add('hidden');
        editBtn.textContent = 'Alterar Foto';
        selectedManagerPhoto = null;
    } else {
        // Ir para modo edi√ß√£o
        viewMode.classList.add('hidden');
        editMode.classList.remove('hidden');
        editBtn.textContent = 'Cancelar';
    }
}

// Fun√ß√£o para cancelar edi√ß√£o da foto do gerente
function cancelManagerPhotoEdit() {
    toggleManagerPhotoEdit();
    // Limpar preview
    const previewImage = document.getElementById('managerPhotoPreviewImage');
    const previewPlaceholder = document.getElementById('managerPhotoPreviewPlaceholder');
    if (previewImage) previewImage.classList.add('hidden');
    if (previewPlaceholder) previewPlaceholder.classList.remove('hidden');
    selectedManagerPhoto = null;
}

// Fun√ß√£o para lidar com upload da foto do gerente
function handleManagerPhotoUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    // Validar tipo de arquivo
    const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
    if (!allowedTypes.includes(file.type)) {
        showNotification('Formato de arquivo n√£o suportado. Use PNG, JPG, JPEG, GIF ou WEBP.', 'error');
        return;
    }
    
    // Validar tamanho (5MB)
    const maxSize = 5 * 1024 * 1024; // 5MB
    if (file.size > maxSize) {
        showNotification('Arquivo muito grande. Tamanho m√°ximo: 5MB.', 'error');
        return;
    }
    
    // Armazenar arquivo selecionado
    selectedManagerPhoto = file;
    
    // Mostrar preview
    const reader = new FileReader();
    reader.onload = function(e) {
        const previewImage = document.getElementById('managerPhotoPreviewImage');
        const previewPlaceholder = document.getElementById('managerPhotoPreviewPlaceholder');
        
        if (previewImage && previewPlaceholder) {
            previewImage.src = e.target.result;
            previewImage.classList.remove('hidden');
            previewPlaceholder.classList.add('hidden');
        }
    };
    reader.readAsDataURL(file);
}

// Fun√ß√£o para salvar foto do gerente
async function saveManagerPhoto() {
    if (!selectedManagerPhoto) {
        showNotification('Selecione uma foto primeiro.', 'error');
        return;
    }
    
    try {
        // Obter dados do usu√°rio atual
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) {
            showNotification('Usu√°rio n√£o autenticado.', 'error');
            return;
        }
        
        // Upload da foto usando fun√ß√£o espec√≠fica para gerente
        const photoUrl = await uploadManagerProfilePhoto(selectedManagerPhoto, user.id);
        
        if (photoUrl) {
            // Atualizar foto no banco de dados
            const { error } = await supabase
                .from('users')
                .update({ profile_photo_url: photoUrl })
                .eq('id', user.id);
            
            if (error) throw error;
            
            // Atualizar interface
            updateManagerPhotoDisplay(photoUrl);
            
            // Atualizar lista de usu√°rios
            await loadUsersData();
            
            // Voltar para modo visualiza√ß√£o
            toggleManagerPhotoEdit();
            
            showNotification('Foto de perfil atualizada com sucesso!', 'success');
        }
        
    } catch (error) {
        console.error('Erro ao salvar foto do gerente:', error);
        showNotification('Erro ao salvar foto de perfil.', 'error');
    }
}

// Fun√ß√£o espec√≠fica para upload de foto do gerente
async function uploadManagerProfilePhoto(file, userId) {
    try {
        // Gerar nome √∫nico para o arquivo
        const timestamp = Date.now();
        const randomId = Math.random().toString(36).substr(2, 9);
        const fileExtension = file.name.split('.').pop();
        const fileName = `manager_${userId}_${timestamp}_${randomId}.${fileExtension}`;
        
        // Upload para Supabase Storage
        const { data, error } = await supabase.storage
            .from('profile-photos')
            .upload(fileName, file);
        
        if (error) throw error;
        
        // Obter URL p√∫blica
        const { data: urlData } = supabase.storage
            .from('profile-photos')
            .getPublicUrl(fileName);
        
        return urlData.publicUrl;
        
    } catch (error) {
        console.error('Erro no upload da foto do gerente:', error);
        throw new Error('Erro ao fazer upload da foto.');
    }
}

// Fun√ß√£o para atualizar exibi√ß√£o da foto do gerente
function updateManagerPhotoDisplay(photoUrl) {
    const photoImage = document.getElementById('managerPhotoImage');
    const photoPlaceholder = document.getElementById('managerPhotoPlaceholder');
    
    if (photoUrl && photoImage && photoPlaceholder) {
        // Adicionar timestamp para evitar cache
        photoImage.src = photoUrl + '?t=' + Date.now();
        photoImage.classList.remove('hidden');
        photoPlaceholder.classList.add('hidden');
    } else if (photoPlaceholder) {
        // Mostrar placeholder se n√£o h√° foto
        if (photoImage) photoImage.classList.add('hidden');
        photoPlaceholder.classList.remove('hidden');
    }
    
    // Atualizar tamb√©m a foto no header
    updateHeaderProfilePhoto(photoUrl);
    
    // Atualizar tamb√©m a foto no modal de perfil
    updateModalProfilePhoto(photoUrl);
}

// Fun√ß√£o para atualizar foto no header
function updateHeaderProfilePhoto(photoUrl) {
    const headerPhoto = document.getElementById('headerProfilePhoto');
    const headerIcon = document.getElementById('headerProfileIcon');
    
    if (headerPhoto && headerIcon) {
        if (photoUrl) {
            // Adicionar timestamp para evitar cache
            const photoUrlWithTimestamp = photoUrl + '?t=' + Date.now();
            headerPhoto.src = photoUrlWithTimestamp;
            headerPhoto.classList.remove('hidden');
            headerIcon.classList.add('hidden');
        } else {
            // Mostrar √≠cone padr√£o se n√£o h√° foto
            headerPhoto.classList.add('hidden');
            headerIcon.classList.remove('hidden');
        }
    }
}

// Fun√ß√£o para atualizar foto no modal de perfil
function updateModalProfilePhoto(photoUrl) {
    const modalPhoto = document.getElementById('modalProfilePhoto');
    const modalIcon = document.getElementById('modalProfileIcon');
    
    if (modalPhoto && modalIcon) {
        if (photoUrl) {
            // Adicionar timestamp para evitar cache
            const photoUrlWithTimestamp = photoUrl + '?t=' + Date.now();
            modalPhoto.src = photoUrlWithTimestamp;
            modalPhoto.classList.remove('hidden');
            modalIcon.classList.add('hidden');
        } else {
            // Mostrar √≠cone padr√£o se n√£o h√° foto
            modalPhoto.classList.add('hidden');
            modalIcon.classList.remove('hidden');
        }
    }
}
// Fun√ß√£o para carregar foto do gerente ao abrir o modal
async function loadManagerPhoto() {
    try {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) return;
        
        // Buscar dados do usu√°rio incluindo foto
        const { data: userData, error } = await supabase
            .from('users')
            .select('profile_photo_url')
            .eq('id', user.id)
            .single();
        
        if (error) {
            console.error('Erro ao carregar foto do gerente:', error);
            return;
        }
        
        // Atualizar exibi√ß√£o da foto
        updateManagerPhotoDisplay(userData.profile_photo_url);
        
    } catch (error) {
        console.error('Erro ao carregar foto do gerente:', error);
    }
}

// Modificar fun√ß√£o openProfileModal para carregar foto
const originalOpenProfileModal = window.openProfileModal;
window.openProfileModal = function() {
    originalOpenProfileModal();
    // Carregar foto do gerente
    loadManagerPhoto();
};

// Fun√ß√£o para carregar foto no header ao inicializar a p√°gina
async function loadHeaderPhoto() {
    try {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) return;
        
        // Buscar dados do usu√°rio incluindo foto
        const { data: userData, error } = await supabase
            .from('users')
            .select('profile_photo_url')
            .eq('id', user.id)
            .single();
        
        if (error) {
            console.error('Erro ao carregar foto do header:', error);
            return;
        }
        
        // Atualizar foto no header
        updateHeaderProfilePhoto(userData.profile_photo_url);
        
    } catch (error) {
        console.error('Erro ao carregar foto do header:', error);
    }
}

// Chamar fun√ß√£o para carregar foto no header quando a p√°gina carrega
document.addEventListener('DOMContentLoaded', function() {
    loadHeaderPhoto();
});

// ==================== FUN√á√ïES DA ABA DE RELAT√ìRIOS ====================

// Vari√°veis globais para a aba de relat√≥rios
let reportTabSettings = {
    farmName: '',
    farmLogo: null
};

// Fun√ß√£o para carregar configura√ß√µes na aba de relat√≥rios
async function loadReportTabSettings() {
    try {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) return;

        // Buscar dados do usu√°rio incluindo farm_id
        const { data: userData, error: userError } = await supabase
            .from('users')
            .select('report_farm_name, report_farm_logo_base64, farm_id')
            .eq('id', user.id)
            .single();

        if (userError) throw userError;

        // Se n√£o tem nome da fazenda configurado, buscar do banco
        let farmName = userData.report_farm_name;
        if (!farmName && userData.farm_id) {
            const { data: farmData, error: farmError } = await supabase
                .from('farms')
                .select('name')
                .eq('id', userData.farm_id)
                .single();

            if (!farmError && farmData) {
                farmName = farmData.name;
            }
        }

        // Se ainda n√£o tem nome, usar padr√£o
        if (!farmName) {
            farmName = 'Fazenda';
        }

        reportTabSettings.farmName = farmName;
        reportTabSettings.farmLogo = userData.report_farm_logo_base64;
        
        // Atualizar campos
        document.getElementById('reportFarmNameTab').value = farmName;
        updateFarmLogoPreviewTab(reportTabSettings.farmLogo);
        
        // Corrigir duplica√ß√£o da logo
        setTimeout(() => {
            fixLogoDuplication();
        }, 100);
        
        console.log('Nome da fazenda carregado:', farmName);
    } catch (error) {
        console.error('Erro ao carregar configura√ß√µes:', error);
        // Em caso de erro, usar nome padr√£o
        document.getElementById('reportFarmNameTab').value = 'Fazenda';
    }
}

// Fun√ß√£o para upload da logo na aba
async function handleFarmLogoUploadTab(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    if (!file.type.startsWith('image/')) {
        showNotification('Por favor, selecione um arquivo de imagem v√°lido', 'error');
        return;
    }
    
    if (file.size > 2 * 1024 * 1024) {
        showNotification('A imagem deve ter no m√°ximo 2MB', 'error');
        return;
    }
    
    try {
        const base64 = await fileToBase64(file);
        reportTabSettings.farmLogo = base64;
        updateFarmLogoPreviewTab(base64);
        showNotification('Logo carregada com sucesso! Clique em "Salvar Configura√ß√µes" para aplicar', 'success');
    } catch (error) {
        console.error('Erro ao processar logo:', error);
        showNotification('Erro ao processar a imagem', 'error');
    }
}

// Fun√ß√£o para atualizar preview da logo na aba
function updateFarmLogoPreviewTab(base64Logo) {
    const preview = document.getElementById('farmLogoPreviewTab');
    const placeholder = document.getElementById('farmLogoPlaceholderTab');
    const image = document.getElementById('farmLogoImageTab');
    const removeBtn = document.getElementById('removeFarmLogoTab');
    
    if (base64Logo) {
        image.src = base64Logo;
        preview.classList.remove('hidden');
        placeholder.classList.add('hidden');
        removeBtn.classList.remove('hidden');
        
        // For√ßar oculta√ß√£o do placeholder via CSS
        placeholder.style.display = 'none';
        placeholder.style.visibility = 'hidden';
        placeholder.style.opacity = '0';
        placeholder.style.position = 'absolute';
        placeholder.style.zIndex = '-1';
        placeholder.style.pointerEvents = 'none';
        placeholder.style.width = '0';
        placeholder.style.height = '0';
        placeholder.style.overflow = 'hidden';
        
        // Garantir que o bot√£o remover seja vis√≠vel
        removeBtn.style.display = 'flex';
        removeBtn.style.visibility = 'visible';
        removeBtn.style.opacity = '1';
        removeBtn.style.position = 'relative';
        removeBtn.style.zIndex = 'auto';
        removeBtn.style.pointerEvents = 'auto';
        removeBtn.style.width = 'auto';
        removeBtn.style.height = 'auto';
        removeBtn.style.overflow = 'visible';
    } else {
        image.src = '';
        preview.classList.add('hidden');
        placeholder.classList.remove('hidden');
        removeBtn.classList.add('hidden');
        
        // For√ßar exibi√ß√£o do placeholder via CSS
        placeholder.style.display = 'flex';
        placeholder.style.visibility = 'visible';
        placeholder.style.opacity = '1';
        placeholder.style.position = 'relative';
        placeholder.style.zIndex = 'auto';
        placeholder.style.pointerEvents = 'auto';
        placeholder.style.width = 'auto';
        placeholder.style.height = 'auto';
        placeholder.style.overflow = 'visible';
        
        // For√ßar oculta√ß√£o completa do bot√£o remover via CSS
        removeBtn.style.display = 'none';
        removeBtn.style.visibility = 'hidden';
        removeBtn.style.opacity = '0';
        removeBtn.style.position = 'absolute';
        removeBtn.style.zIndex = '-1';
        removeBtn.style.pointerEvents = 'none';
        removeBtn.style.width = '0';
        removeBtn.style.height = '0';
        removeBtn.style.overflow = 'hidden';
    }
}

// Fun√ß√£o para corrigir duplica√ß√£o da logo na inicializa√ß√£o
function fixLogoDuplication() {
    const preview = document.getElementById('farmLogoPreviewTab');
    const placeholder = document.getElementById('farmLogoPlaceholderTab');
    const removeBtn = document.getElementById('removeFarmLogoTab');
    
    if (preview && placeholder && removeBtn) {
        if (preview.classList.contains('hidden')) {
            // Se preview est√° oculta, mostrar placeholder e ocultar bot√£o remover
            placeholder.style.display = 'flex';
            placeholder.style.visibility = 'visible';
            placeholder.style.opacity = '1';
            placeholder.style.position = 'relative';
            placeholder.style.zIndex = 'auto';
            placeholder.style.pointerEvents = 'auto';
            placeholder.style.width = 'auto';
            placeholder.style.height = 'auto';
            placeholder.style.overflow = 'visible';
            
            // Ocultar bot√£o remover completamente
            removeBtn.style.display = 'none';
            removeBtn.style.visibility = 'hidden';
            removeBtn.style.opacity = '0';
            removeBtn.style.position = 'absolute';
            removeBtn.style.zIndex = '-1';
            removeBtn.style.pointerEvents = 'none';
            removeBtn.style.width = '0';
            removeBtn.style.height = '0';
            removeBtn.style.overflow = 'hidden';
        } else {
            // Se preview est√° vis√≠vel, ocultar placeholder e mostrar bot√£o remover
            placeholder.style.display = 'none';
            placeholder.style.visibility = 'hidden';
            placeholder.style.opacity = '0';
            placeholder.style.position = 'absolute';
            placeholder.style.zIndex = '-1';
            placeholder.style.pointerEvents = 'none';
            placeholder.style.width = '0';
            placeholder.style.height = '0';
            placeholder.style.overflow = 'hidden';
            
            // Mostrar bot√£o remover
            removeBtn.style.display = 'flex';
            removeBtn.style.visibility = 'visible';
            removeBtn.style.opacity = '1';
            removeBtn.style.position = 'relative';
            removeBtn.style.zIndex = 'auto';
            removeBtn.style.pointerEvents = 'auto';
            removeBtn.style.width = 'auto';
            removeBtn.style.height = 'auto';
            removeBtn.style.overflow = 'visible';
        }
    }
}

// Fun√ß√£o para remover logo da aba
function removeFarmLogoTab() {
    reportTabSettings.farmLogo = null;
    updateFarmLogoPreviewTab(null);
    document.getElementById('farmLogoUploadTab').value = '';
    showNotification('Logo removida! Clique em "Salvar Configura√ß√µes" para aplicar', 'info');
}

// Fun√ß√£o para salvar configura√ß√µes da aba
async function saveReportSettingsTab() {
    try {
        const farmName = document.getElementById('reportFarmNameTab').value || 'Fazenda';
        
        const { error } = await supabase.rpc('update_user_report_settings', {
            p_report_farm_name: farmName,
            p_report_farm_logo_base64: reportTabSettings.farmLogo,
            p_report_footer_text: null,
            p_report_system_logo_base64: null
        });

        if (error) throw error;

        reportTabSettings.farmName = farmName;
        showNotification('Configura√ß√µes salvas com sucesso!', 'success');
        
        // Sincronizar com as configura√ß√µes do modal
        if (window.reportSettings) {
            window.reportSettings.farmName = farmName;
            window.reportSettings.farmLogo = reportTabSettings.farmLogo;
        }
        
    } catch (error) {
        console.error('Erro ao salvar configura√ß√µes:', error);
        showNotification('Erro ao salvar configura√ß√µes', 'error');
    }
}

// Fun√ß√£o para carregar estat√≠sticas dos relat√≥rios
async function loadReportStats() {
    try {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) return;

        const { data: userData } = await supabase
            .from('users')
            .select('farm_id')
            .eq('id', user.id)
            .single();

        if (!userData?.farm_id) return;

        const hoje = new Date().toISOString().split('T')[0];
        const inicioMes = new Date();
        inicioMes.setDate(1);
        const seteDiasAtras = new Date();
        seteDiasAtras.setDate(seteDiasAtras.getDate() - 6);

        // Produ√ß√£o de hoje
        const { data: producaoHoje } = await supabase
            .from('milk_production')
            .select('volume_liters')
            .eq('farm_id', userData.farm_id)
            .eq('production_date', hoje);

        let volumeHoje = 0;
        if (producaoHoje) {
            volumeHoje = producaoHoje.reduce((sum, item) => sum + parseFloat(item.volume_liters || 0), 0);
        }

        // M√©dia semanal
        const { data: producaoSemana } = await supabase
            .from('milk_production')
            .select('volume_liters, production_date')
            .eq('farm_id', userData.farm_id)
            .gte('production_date', seteDiasAtras.toISOString().split('T')[0]);

        let mediaSemana = 0;
        if (producaoSemana?.length > 0) {
            const volumesPorDia = {};
            producaoSemana.forEach(item => {
                if (!volumesPorDia[item.production_date]) {
                    volumesPorDia[item.production_date] = 0;
                }
                volumesPorDia[item.production_date] += parseFloat(item.volume_liters || 0);
            });
            
            const totalDias = Object.keys(volumesPorDia).length;
            const totalVolume = Object.values(volumesPorDia).reduce((sum, vol) => sum + vol, 0);
            mediaSemana = totalDias > 0 ? totalVolume / totalDias : 0;
        }

        // Total do m√™s
        const { data: producaoMes } = await supabase
            .from('milk_production')
            .select('volume_liters')
            .eq('farm_id', userData.farm_id)
            .gte('production_date', inicioMes.toISOString().split('T')[0]);

        let totalMes = 0;
        let registrosMes = 0;
        if (producaoMes) {
            totalMes = producaoMes.reduce((sum, item) => sum + parseFloat(item.volume_liters || 0), 0);
            registrosMes = producaoMes.length;
        }

        // Funcion√°rios ativos
        const { data: funcionarios } = await supabase
            .from('users')
            .select('id')
            .eq('farm_id', userData.farm_id)
            .eq('role', 'funcionario');

        const funcionariosAtivos = funcionarios?.length || 0;

        // Atualizar elementos
        document.getElementById('reportTodayVolume').textContent = volumeHoje.toFixed(1) + ' L';
        document.getElementById('reportWeekAverage').textContent = mediaSemana.toFixed(1) + ' L';
        document.getElementById('reportMonthTotal').textContent = totalMes.toFixed(1) + ' L';
        document.getElementById('reportMonthRecords').textContent = registrosMes.toString();
        document.getElementById('reportActiveEmployees').textContent = funcionariosAtivos.toString();

        // Carregar lista de funcion√°rios no select
        const selectEmployee = document.getElementById('reportEmployee');
        if (selectEmployee && funcionarios) {
            selectEmployee.innerHTML = '<option value="">Todos os funcion√°rios</option>';
            
            for (const func of funcionarios) {
                const { data: userData } = await supabase
                    .from('users')
                    .select('name')
                    .eq('id', func.id)
                    .single();
                
                if (userData?.name) {
                    const option = document.createElement('option');
                    option.value = func.id;
                    option.textContent = userData.name;
                    selectEmployee.appendChild(option);
                }
            }
        }

    } catch (error) {
        console.error('Erro ao carregar estat√≠sticas:', error);
    }
}

// Fun√ß√£o para exportar Excel
async function exportExcelReport() {
    try {
        const startDate = document.getElementById('reportStartDate').value;
        const endDate = document.getElementById('reportEndDate').value;
        const employeeId = document.getElementById('reportEmployee').value;

        if (!startDate || !endDate) {
            showNotification('Por favor, selecione as datas inicial e final', 'warning');
            return;
        }

        const { data: { user } } = await supabase.auth.getUser();
        if (!user) return;

        const { data: userData } = await supabase
            .from('users')
            .select('farm_id')
            .eq('id', user.id)
            .single();

        if (!userData?.farm_id) return;

        // Buscar dados
        let query = supabase
            .from('milk_production')
            .select(`
                production_date,
                shift,
                volume_liters,
                temperature,
                observations,
                created_at,
                users!inner(name)
            `)
            .eq('farm_id', userData.farm_id)
            .gte('production_date', startDate)
            .lte('production_date', endDate)
            .order('production_date', { ascending: true })
            .order('created_at', { ascending: true });

        if (employeeId) {
            query = query.eq('user_id', employeeId);
        }

        const { data: dadosExcel, error } = await query;

        if (error) {
            throw error;
        }

        if (!dadosExcel || dadosExcel.length === 0) {
            showNotification('Nenhum dado encontrado para o per√≠odo selecionado', 'info');
            return;
        }
        // Obter informa√ß√µes da fazenda para o cabe√ßalho
        const farmName = reportTabSettings.farmName || 'Fazenda';
        const dataInicio = new Date(startDate).toLocaleDateString('pt-BR');
        const dataFim = new Date(endDate).toLocaleDateString('pt-BR');
        const dataGeracao = new Date().toLocaleString('pt-BR');
        
        // Calcular estat√≠sticas
        const totalVolume = dadosExcel.reduce((sum, item) => sum + (parseFloat(item.volume_liters) || 0), 0);
        const mediaVolume = dadosExcel.length > 0 ? totalVolume / dadosExcel.length : 0;
        const totalRegistros = dadosExcel.length;

        // Criar dados para Excel com design limpo
        const excelData = [
            // Cabe√ßalho Principal
            [`RELAT√ìRIO DE PRODU√á√ÉO DE LEITE - ${farmName.toUpperCase()}`],
            [''],
            ['INFORMA√á√ïES DO RELAT√ìRIO'],
            ['Per√≠odo:', `${dataInicio} at√© ${dataFim}`],
            ['Data de Gera√ß√£o:', dataGeracao],
            ['Total de Registros:', totalRegistros],
            ['Volume Total Produzido:', `${totalVolume.toFixed(2)} L`],
            ['M√©dia por Registro:', `${mediaVolume.toFixed(2)} L`],
            [''],
            // Cabe√ßalho da Tabela
            ['Data', 'Funcion√°rio', 'Turno', 'Volume (L)', 'Temperatura (¬∞C)', 'Observa√ß√µes', 'Data/Hora Registro']
        ];

        dadosExcel.forEach(item => {
            const data = new Date(item.production_date).toLocaleDateString('pt-BR');
            const turno = {
                'manha': 'Manh√£',
                'tarde': 'Tarde', 
                'noite': 'Noite'
            }[item.shift] || item.shift;
            const dataHora = new Date(item.created_at).toLocaleString('pt-BR');

            excelData.push([
                data,
                item.users?.name || 'N/A',
                turno,
                parseFloat(item.volume_liters) || 0,
                item.temperature ? `${item.temperature}¬∞C` : '',
                item.observations || '',
                dataHora
            ]);
        });

        // Criar workbook e worksheet
        const ws = XLSX.utils.aoa_to_sheet(excelData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Produ√ß√£o de Leite');

        // Definir larguras das colunas melhoradas
        ws['!cols'] = [
            { width: 15 }, // Data
            { width: 25 }, // Funcion√°rio
            { width: 15 }, // Turno
            { width: 15 }, // Volume
            { width: 18 }, // Temperatura
            { width: 35 }, // Observa√ß√µes
            { width: 22 }  // Data/Hora Registro
        ];

        // Estilizar cabe√ßalho principal
        if (ws['A1']) {
            ws['A1'].s = {
                font: { bold: true, color: { rgb: "FFFFFF" } },
                fill: { fgColor: { rgb: "2563EB" } },
                alignment: { horizontal: "center" }
            };
        }

        // Merge das c√©lulas do t√≠tulo
        ws['!merges'] = [
            { s: { r: 0, c: 0 }, e: { r: 0, c: 6 } }, // T√≠tulo principal
            { s: { r: 2, c: 0 }, e: { r: 2, c: 6 } }  // Subt√≠tulo informa√ß√µes
        ];

        // Estilizar linha de informa√ß√µes
        for (let i = 3; i <= 8; i++) {
            const cellA = `A${i}`;
            const cellB = `B${i}`;
            if (ws[cellA]) {
                ws[cellA].s = {
                    font: { bold: true, color: { rgb: "1F2937" } },
                    fill: { fgColor: { rgb: "F3F4F6" } }
                };
            }
            if (ws[cellB]) {
                ws[cellB].s = {
                    font: { color: { rgb: "374151" } },
                    fill: { fgColor: { rgb: "F9FAFB" } }
                };
            }
        }

        // Estilizar cabe√ßalho da tabela
        for (let col = 0; col < 7; col++) {
            const cell = ws[XLSX.utils.encode_cell({ r: 9, c: col })];
            if (cell) {
                cell.s = {
                    font: { bold: true, color: { rgb: "FFFFFF" } },
                    fill: { fgColor: { rgb: "059669" } },
                    alignment: { horizontal: "center" },
                    border: {
                        top: { style: "thin", color: { rgb: "000000" } },
                        bottom: { style: "thin", color: { rgb: "000000" } },
                        left: { style: "thin", color: { rgb: "000000" } },
                        right: { style: "thin", color: { rgb: "000000" } }
                    }
                };
            }
        }

        // Estilizar dados da tabela
        for (let row = 10; row < excelData.length; row++) {
            for (let col = 0; col < 7; col++) {
                const cell = ws[XLSX.utils.encode_cell({ r: row, c: col })];
                if (cell) {
                    const isEvenRow = (row - 10) % 2 === 0;
                    cell.s = {
                        fill: { fgColor: { rgb: isEvenRow ? "F9FAFB" : "FFFFFF" } },
                        border: {
                            top: { style: "thin", color: { rgb: "E5E7EB" } },
                            bottom: { style: "thin", color: { rgb: "E5E7EB" } },
                            left: { style: "thin", color: { rgb: "E5E7EB" } },
                            right: { style: "thin", color: { rgb: "E5E7EB" } }
                        },
                        alignment: { 
                            horizontal: col === 3 ? "right" : "left", // Volume alinhado √† direita
                            vertical: "center"
                        }
                    };
                    
                    // Destacar volumes acima da m√©dia
                    if (col === 3 && parseFloat(cell.v) > mediaVolume) {
                        cell.s.font = { bold: true, color: { rgb: "059669" } };
                    }
                }
            }
        }

        // Download
        const fileName = `Relat√≥rio_${farmName}_${startDate}_${endDate}.xlsx`;
        XLSX.writeFile(wb, fileName);

        showNotification('Arquivo Excel exportado com sucesso!', 'success');

    } catch (error) {
        console.error('Erro ao exportar Excel:', error);
        
        showNotification('Erro ao exportar relat√≥rio: ' + error.message, 'error');
    }
}

// Fun√ß√£o para exportar PDF
async function exportPDFReport() {
    try {
        const startDate = document.getElementById('reportStartDate').value;
        const endDate = document.getElementById('reportEndDate').value;
        const employeeId = document.getElementById('reportEmployee').value;

        if (!startDate || !endDate) {
            showNotification('Por favor, selecione as datas inicial e final', 'warning');
            return;
        }

        const { data: { user } } = await supabase.auth.getUser();
        if (!user) return;

        const { data: userData } = await supabase
            .from('users')
            .select('farm_id')
            .eq('id', user.id)
            .single();

        if (!userData?.farm_id) return;

        let query = supabase
            .from('milk_production')
            .select(`
                production_date,
                shift,
                volume_liters,
                temperature,
                observations,
                created_at,
                users!inner(name)
            `)
            .eq('farm_id', userData.farm_id)
            .gte('production_date', startDate)
            .lte('production_date', endDate)
            .order('production_date', { ascending: true });

        if (employeeId) {
            query = query.eq('user_id', employeeId);
        }

        const { data: dadosPDF, error } = await query;

        if (error) throw error;

        if (!dadosPDF || dadosPDF.length === 0) {
            showNotification('Nenhum dado encontrado para o per√≠odo selecionado', 'info');
            return;
        }

        // Gerar PDF usando a fun√ß√£o existente
        generateVolumePDF(dadosPDF, false);

    } catch (error) {
        console.error('Erro ao exportar PDF:', error);
        showNotification('Erro ao exportar PDF: ' + error.message, 'error');
    }
}



// ===== FUN√á√ïES DE CONTAS SECUND√ÅRIAS =====

// Toggle do formul√°rio de conta secund√°ria
function toggleSecondaryAccountForm() {
    const form = document.getElementById('secondaryAccountForm');
    const isHidden = form.classList.contains('hidden');
    
    if (isHidden) {
        form.classList.remove('hidden');
        // Preencher campos com dados do gerente atual
        fillManagerDataInForm();
    } else {
        form.classList.add('hidden');
        document.getElementById('createSecondaryAccountForm').reset();
    }
}

// Cancelar formul√°rio de conta secund√°ria
function cancelSecondaryAccountForm() {
    document.getElementById('secondaryAccountForm').classList.add('hidden');
    document.getElementById('createSecondaryAccountForm').reset();
}

// Preencher formul√°rio com dados do gerente
async function fillManagerDataInForm() {
    try {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) return;

        const { data: userData } = await supabase
            .from('users')
            .select('name, whatsapp')
            .eq('id', user.id)
            .single();

        if (userData) {
            document.getElementById('secondaryAccountName').value = userData.name || '';
            document.getElementById('secondaryAccountWhatsApp').value = userData.whatsapp || '';
        }
    } catch (error) {
        console.error('Erro ao carregar dados do gerente:', error);
    }
}

// Carregar lista de contas secund√°rias
async function loadSecondaryAccounts() {
    try {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) return;

        // Buscar dados do gerente para obter o farm_id
        const { data: managerData } = await supabase
            .from('users')
            .select('farm_id')
            .eq('id', user.id)
            .single();

        if (!managerData?.farm_id) return;

        // Buscar contas secund√°rias da mesma fazenda
        const { data: secondaryAccounts } = await supabase
            .from('users')
            .select('id, name, email, role, created_at, is_active')
            .eq('farm_id', managerData.farm_id)
            .neq('id', user.id) // Excluir o pr√≥prio gerente
            .in('role', ['funcionario', 'veterinario'])
            .order('created_at', { ascending: false });

        const container = document.getElementById('secondaryAccountsList');
        if (!container) return;

        if (!secondaryAccounts || secondaryAccounts.length === 0) {
            container.innerHTML = `
                <div class="text-center py-6 text-gray-500">
                    <svg class="w-12 h-12 mx-auto mb-3 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM9 3a2 2 0 11-4 0 2 2 0 014 0z"></path>
                    </svg>
                    <p class="text-sm">Nenhuma conta secund√°ria criada</p>
                </div>
            `;
            return;
        }

        container.innerHTML = secondaryAccounts.map(account => {
            const roleLabel = account.role === 'funcionario' ? 'Funcion√°rio' : 'Veterin√°rio';
            const roleColor = account.role === 'funcionario' ? 'bg-blue-100 text-blue-800' : 'bg-green-100 text-green-800';
            const statusColor = account.is_active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
            const statusLabel = account.is_active ? 'Ativa' : 'Inativa';
            const createdDate = new Date(account.created_at).toLocaleDateString('pt-BR');

            return `
                <div class="flex items-center justify-between p-4 border border-gray-200 rounded-xl hover:shadow-sm transition-all">
                    <div class="flex-1">
                        <div class="flex items-center gap-3 mb-2">
                            <h5 class="font-semibold text-gray-900">${account.name}</h5>
                            <span class="px-2 py-1 text-xs font-medium rounded-full ${roleColor}">${roleLabel}</span>
                            <span class="px-2 py-1 text-xs font-medium rounded-full ${statusColor}">${statusLabel}</span>
                        </div>
                        <div class="text-sm text-gray-600">
                            <p><strong>Email:</strong> ${account.email}</p>
                            <p><strong>Criada em:</strong> ${createdDate}</p>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="toggleAccountStatus('${account.id}', ${!account.is_active})" 
                                class="px-3 py-1 text-xs font-medium rounded-lg transition-all ${
                                    account.is_active 
                                        ? 'bg-red-100 text-red-700 hover:bg-red-200' 
                                        : 'bg-green-100 text-green-700 hover:bg-green-200'
                                }">
                            ${account.is_active ? 'Desativar' : 'Ativar'}
                        </button>
                        <button onclick="resetAccountPassword('${account.id}', '${account.name}')" 
                                class="px-3 py-1 text-xs font-medium bg-yellow-100 text-yellow-700 hover:bg-yellow-200 rounded-lg transition-all">
                            Resetar Senha
                        </button>
                    </div>
                </div>
            `;
        }).join('');

    } catch (error) {
        console.error('Erro ao carregar contas secund√°rias:', error);
        showNotification('Erro ao carregar contas secund√°rias', 'error');
    }
}

// Criar nova conta secund√°ria
async function createSecondaryAccount(formData) {
    try {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) throw new Error('Usu√°rio n√£o autenticado');

        // Buscar dados do gerente
        const { data: managerData } = await supabase
            .from('users')
            .select('farm_id')
            .eq('id', user.id)
            .single();

        if (!managerData?.farm_id) {
            throw new Error('Fazenda n√£o encontrada');
        }

        // Gerar senha tempor√°ria
        const tempPassword = generateTempPassword();

        // Criar usu√°rio no Supabase Auth
        const { data: authData, error: authError } = await supabase.auth.signUp({
            email: formData.email,
            password: tempPassword,
            options: {
                data: {
                    name: formData.name,
                    role: formData.account_type,
                    whatsapp: formData.whatsapp,
                    farm_name: sessionStorage.getItem('farm_name') || 'Minha Fazenda'
                },
                emailRedirectTo: undefined // Disable email confirmation
            }
        });

        if (authError) throw authError;
        if (!authData.user) throw new Error('Falha ao criar usu√°rio');

        // Inserir dados na tabela users usando RPC
        const { error: insertError } = await supabase
            .rpc('create_secondary_user', {
                p_user_id: authData.user.id,
                p_farm_id: managerData.farm_id,
                p_name: formData.name,
                p_email: formData.email,
                p_role: formData.account_type,
                p_whatsapp: formData.whatsapp || '',
                p_created_by: user.id,
                p_temp_password: tempPassword
            });

        if (insertError) throw insertError;

        showNotification(`Conta ${formData.account_type} criada com sucesso!\nSenha tempor√°ria: ${tempPassword}`, 'success');
        
        // Resetar formul√°rio e recarregar lista
        document.getElementById('createSecondaryAccountForm').reset();
        document.getElementById('secondaryAccountForm').classList.add('hidden');
        await loadSecondaryAccounts();

        // Mostrar modal com senha tempor√°ria
        showTempPasswordModal(formData.name, formData.email, tempPassword);

    } catch (error) {
        console.error('Erro ao criar conta secund√°ria:', error);
        showNotification('Erro ao criar conta: ' + error.message, 'error');
    }
}

// Gerar senha tempor√°ria
function generateTempPassword() {
    const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnpqrstuvwxyz23456789';
    let password = '';
    for (let i = 0; i < 8; i++) {
        password += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return password;
}

// Mostrar modal com senha tempor√°ria
function showTempPasswordModal(name, email, password) {
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[10000] backdrop-blur-sm';
    modal.innerHTML = `
        <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4 shadow-2xl">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </div>
                <h3 class="text-xl font-bold text-gray-800 mb-2">Conta Criada com Sucesso!</h3>
                <p class="text-sm text-gray-500">Anote a senha tempor√°ria</p>
            </div>
            
            <div class="bg-gray-50 rounded-xl p-4 mb-6">
                <div class="space-y-2">
                    <div><strong>Nome:</strong> ${name}</div>
                    <div><strong>Email:</strong> ${email}</div>
                    <div class="flex items-center justify-between">
                        <strong>Senha Tempor√°ria:</strong>
                        <div class="flex items-center gap-2">
                            <code class="bg-white px-2 py-1 rounded border font-mono text-lg">${password}</code>
                            <button onclick="copyToClipboard('${password}')" class="p-1 text-gray-500 hover:text-gray-700">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="bg-yellow-50 border border-yellow-200 rounded-xl p-4 mb-6">
                <div class="flex items-start">
                    <svg class="w-5 h-5 text-yellow-600 mt-0.5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.34 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                    </svg>
                    <div>
                        <h5 class="text-sm font-semibold text-yellow-800 mb-1">Importante!</h5>
                        <p class="text-sm text-yellow-700">O usu√°rio dever√° alterar esta senha no primeiro acesso ao sistema.</p>
                    </div>
                </div>
            </div>
            
            <button onclick="this.closest('.fixed').remove()" class="w-full px-6 py-3 bg-forest-600 text-white rounded-xl hover:bg-forest-700 transition-all font-medium">
                Entendi
            </button>
        </div>
    `;
    document.body.appendChild(modal);
}

// Copiar para clipboard
function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        showNotification('Senha copiada para a √°rea de transfer√™ncia!', 'success');
    }).catch(() => {
        showNotification('Erro ao copiar senha', 'error');
    });
}

// Alternar status da conta
async function toggleAccountStatus(userId, newStatus) {
    try {
        const { error } = await supabase
            .from('users')
            .update({ is_active: newStatus })
            .eq('id', userId);

        if (error) throw error;

        showNotification(`Conta ${newStatus ? 'ativada' : 'desativada'} com sucesso!`, 'success');
        await loadSecondaryAccounts();

    } catch (error) {
        console.error('Erro ao alterar status da conta:', error);
        showNotification('Erro ao alterar status da conta', 'error');
    }
}

// Resetar senha da conta
async function resetAccountPassword(userId, userName) {
    if (!confirm(`Tem certeza que deseja resetar a senha de ${userName}?`)) {
        return;
    }

    try {
        const newPassword = generateTempPassword();

        // Atualizar apenas a senha tempor√°ria na tabela
        // Nota: O usu√°rio precisar√° usar a fun√ß√£o de recupera√ß√£o de senha do Supabase
        // ou o administrador do sistema precisar√° resetar via painel admin
        const { error: updateError } = await supabase
            .from('users')
            .update({ temp_password: newPassword })
            .eq('id', userId);

        if (updateError) throw updateError;

        showNotification('Nova senha tempor√°ria gerada! O usu√°rio deve usar a recupera√ß√£o de senha do sistema.', 'warning');
        showTempPasswordModal(userName, '', newPassword);

    } catch (error) {
        console.error('Erro ao resetar senha:', error);
        showNotification('Erro ao resetar senha: ' + error.message, 'error');
    }
}

// Event listener para formul√°rio de conta secund√°ria
document.getElementById('createSecondaryAccountForm')?.addEventListener('submit', async function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    const data = Object.fromEntries(formData.entries());
    await createSecondaryAccount(data);
});

// Carregar contas secund√°rias quando o modal for aberto
// (A fun√ß√£o j√° foi modificada anteriormente para carregar foto do gerente)
// Agora vamos adicionar a funcionalidade de carregar contas secund√°rias
const currentOpenProfileModal = window.openProfileModal;
window.openProfileModal = function() {
    currentOpenProfileModal();
    setTimeout(() => {
        loadSecondaryAccounts();
    }, 100);
};

// Fun√ß√£o para pr√©via do relat√≥rio na aba
function previewReportTab() {
    const startDate = document.getElementById('reportStartDate').value;
    const endDate = document.getElementById('reportEndDate').value;

    if (!startDate || !endDate) {
        showNotification('Por favor, selecione as datas inicial e final para a pr√©via', 'warning');
        return;
    }

    // Gerar relat√≥rio de exemplo
    const sampleData = [
        {
            production_date: startDate,
            volume_liters: 150.5,
            shift: 'manha',
            temperature: 4.2,
            observations: 'Exemplo de registro para pr√©via',
            users: { name: 'Funcion√°rio Exemplo' },
            created_at: new Date().toISOString()
        }
    ];

    generateVolumePDF(sampleData, true);
}

// Inicializar datas padr√£o (√∫ltimo m√™s)
function initializeDateFilters() {
    const today = new Date();
    const lastMonth = new Date();
    lastMonth.setMonth(today.getMonth() - 1);

    document.getElementById('reportStartDate').value = lastMonth.toISOString().split('T')[0];
    document.getElementById('reportEndDate').value = today.toISOString().split('T')[0];
}

// Carregar biblioteca Excel dinamicamente
function loadExcelLibrary() {
    if (typeof XLSX === 'undefined') {
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js';
        script.onload = function() {
            console.log('Biblioteca Excel carregada');
        };
        script.onerror = function() {
            console.warn('N√£o foi poss√≠vel carregar a biblioteca Excel');
        };
        document.head.appendChild(script);
    }
}

// Evento para carregar dados quando a aba de relat√≥rios for aberta
document.addEventListener('DOMContentLoaded', function() {
    loadExcelLibrary();
    
    // Carregar dados quando a aba for aberta
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                const reportsTab = document.getElementById('reports-tab');
                if (reportsTab && !reportsTab.classList.contains('hidden')) {
                    loadReportTabSettings();
                    loadReportStats();
                    initializeDateFilters();
                }
            }
        });
    });
    
    const reportsTab = document.getElementById('reports-tab');
    if (reportsTab) {
        observer.observe(reportsTab, { attributes: true });
    }
});

            // App Version Display
        document.addEventListener('DOMContentLoaded', function() {
            // Adiciona vers√£o do app no perfil do usu√°rio
            const appVersion = '1.0.0';
            
            // Fun√ß√£o para adicionar vers√£o em elementos de perfil
            function addVersionToProfile() {
                const profileElements = document.querySelectorAll('.user-profile, .profile-info, .user-info');
                profileElements.forEach(element => {
                    if (!element.querySelector('.app-version')) {
                        const versionDiv = document.createElement('div');
                        versionDiv.className = 'app-version text-xs text-gray-500 mt-2';
                        versionDiv.innerHTML = `App v${appVersion}`;
                        element.appendChild(versionDiv);
                    }
                });
                
                // Adicionar no footer se existir
                const footer = document.querySelector('footer, .footer');
                if (footer && !footer.querySelector('.app-version')) {
                    const versionDiv = document.createElement('div');
                    versionDiv.className = 'app-version text-xs text-gray-500 text-center mt-4';
                    versionDiv.innerHTML = `LacTech v${appVersion}`;
                    footer.appendChild(versionDiv);
                }
            }
            
            // Fun√ß√£o para adicionar vers√£o no modal de perfil
            function addVersionToProfileModal() {
                const profileModal = document.getElementById('profileModal');
                if (profileModal && !profileModal.querySelector('.app-version')) {
                    const versionDiv = document.createElement('div');
                    versionDiv.className = 'app-version text-xs text-gray-500 text-center mt-4 p-4 border-t border-gray-200';
                    versionDiv.innerHTML = `LacTech v${appVersion}`;
                    profileModal.querySelector('.modal-content').appendChild(versionDiv);
                }
            }
            
            // Executar ap√≥s carregamento
            setTimeout(addVersionToProfile, 1000);
            
            // Adicionar vers√£o quando o modal de perfil for aberto
            const originalOpenProfileModal = window.openProfileModal;
            window.openProfileModal = function() {
                if (originalOpenProfileModal) {
                    originalOpenProfileModal();
                }
                setTimeout(addVersionToProfileModal, 100);
            };
        });

    </script>
</body>
</html>