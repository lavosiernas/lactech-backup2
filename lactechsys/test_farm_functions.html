<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste das Funções da Fazenda</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <h1>Teste das Funções da Fazenda</h1>
    
    <div>
        <h2>Testar check_farm_exists</h2>
        <input type="text" id="testName" placeholder="Nome da fazenda" value="Fazenda Teste">
        <input type="text" id="testCnpj" placeholder="CNPJ" value="12.345.678/0001-90">
        <button onclick="testCheckFarm()">Verificar Fazenda</button>
        <div id="checkResult"></div>
    </div>
    
    <div>
        <h2>Listar Fazendas Existentes</h2>
        <button onclick="listFarms()">Listar Fazendas</button>
        <div id="farmsList"></div>
    </div>
    
    <div>
        <h2>Criar Fazenda de Teste</h2>
        <button onclick="createTestFarm()">Criar Fazenda</button>
        <div id="createResult"></div>
    </div>

    <script>
        // Configuração do Supabase
        const supabaseUrl = 'https://njnusdzwvxpsxhcspsop.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5qbnVzZHp3dnhwc3hoY3Nwc29wIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ4NTY2MjIsImV4cCI6MjA3MDQzMjYyMn0.fmOK6xVEECzQmjTQAUm3Ct0UkNXirabMLlM96wnAQOk';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        async function testCheckFarm() {
            const name = document.getElementById('testName').value;
            const cnpj = document.getElementById('testCnpj').value;
            const resultDiv = document.getElementById('checkResult');
            
            try {
                console.log('Testando check_farm_exists com:', { name, cnpj });
                const { data, error } = await supabase
                    .rpc('check_farm_exists', { p_name: name, p_cnpj: cnpj });
                
                console.log('Resultado:', { data, error });
                
                if (error) {
                    resultDiv.innerHTML = `<p style="color: red;">Erro: ${error.message}</p>`;
                } else {
                    resultDiv.innerHTML = `<p style="color: ${data ? 'orange' : 'green'};">Fazenda existe: ${data}</p>`;
                }
            } catch (err) {
                console.error('Erro no teste:', err);
                resultDiv.innerHTML = `<p style="color: red;">Erro: ${err.message}</p>`;
            }
        }

        async function listFarms() {
            const resultDiv = document.getElementById('farmsList');
            
            try {
                const { data, error } = await supabase
                    .from('farms')
                    .select('id, name, cnpj, created_at')
                    .order('created_at', { ascending: false })
                    .limit(10);
                
                if (error) {
                    resultDiv.innerHTML = `<p style="color: red;">Erro: ${error.message}</p>`;
                } else {
                    let html = '<h3>Fazendas Existentes:</h3>';
                    if (data.length === 0) {
                        html += '<p>Nenhuma fazenda encontrada.</p>';
                    } else {
                        html += '<ul>';
                        data.forEach(farm => {
                            html += `<li><strong>${farm.name}</strong> - CNPJ: ${farm.cnpj} - ID: ${farm.id}</li>`;
                        });
                        html += '</ul>';
                    }
                    resultDiv.innerHTML = html;
                }
            } catch (err) {
                console.error('Erro ao listar fazendas:', err);
                resultDiv.innerHTML = `<p style="color: red;">Erro: ${err.message}</p>`;
            }
        }

        async function createTestFarm() {
            const resultDiv = document.getElementById('createResult');
            const testData = {
                name: 'Fazenda Teste ' + Date.now(),
                owner_name: 'Proprietário Teste',
                cnpj: '12.345.678/0001-' + String(Math.floor(Math.random() * 100)).padStart(2, '0'),
                city: 'Cidade Teste',
                state: 'SP',
                address: 'Endereço Teste'
            };
            
            try {
                console.log('Criando fazenda de teste:', testData);
                const { data, error } = await supabase.rpc('create_initial_farm', {
                    p_name: testData.name,
                    p_owner_name: testData.owner_name,
                    p_cnpj: testData.cnpj,
                    p_city: testData.city,
                    p_state: testData.state,
                    p_address: testData.address
                });
                
                console.log('Resultado da criação:', { data, error });
                
                if (error) {
                    resultDiv.innerHTML = `<p style="color: red;">Erro: ${error.message}</p>`;
                } else {
                    resultDiv.innerHTML = `<p style="color: green;">Fazenda criada com sucesso! ID: ${data}</p>`;
                }
            } catch (err) {
                console.error('Erro na criação:', err);
                resultDiv.innerHTML = `<p style="color: red;">Erro: ${err.message}</p>`;
            }
        }
    </script>
</body>
</html>