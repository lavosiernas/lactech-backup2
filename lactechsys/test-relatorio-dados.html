<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste de Dados dos Relat√≥rios - LacTech</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase_config_fixed.js"></script>
    <link rel="icon" href="https://i.postimg.cc/vmrkgDcB/lactech.png" type="image/x-icon">
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="max-w-6xl mx-auto px-4 py-8">
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h1 class="text-2xl font-bold text-gray-900 mb-6">üîç Teste de Dados dos Relat√≥rios</h1>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Teste de Autentica√ß√£o -->
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <h2 class="text-lg font-semibold text-blue-800 mb-3">1. Status de Autentica√ß√£o</h2>
                    <div id="authStatus" class="text-sm text-blue-700">
                        Verificando...
                    </div>
                </div>

                <!-- Teste de Farm ID -->
                <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                    <h2 class="text-lg font-semibold text-green-800 mb-3">2. Farm ID do Usu√°rio</h2>
                    <div id="farmIdStatus" class="text-sm text-green-700">
                        Verificando...
                    </div>
                </div>

                <!-- Teste de Dados de Produ√ß√£o -->
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                    <h2 class="text-lg font-semibold text-yellow-800 mb-3">3. Dados de Produ√ß√£o</h2>
                    <div id="productionStatus" class="text-sm text-yellow-700">
                        Verificando...
                    </div>
                    <div id="productionData" class="mt-3 text-xs bg-white p-2 rounded border max-h-40 overflow-y-auto">
                        <!-- Dados ser√£o inseridos aqui -->
                    </div>
                </div>

                <!-- Teste de Dados de Qualidade -->
                <div class="bg-purple-50 border border-purple-200 rounded-lg p-4">
                    <h2 class="text-lg font-semibold text-purple-800 mb-3">4. Dados de Qualidade</h2>
                    <div id="qualityStatus" class="text-sm text-purple-700">
                        Verificando...
                    </div>
                    <div id="qualityData" class="mt-3 text-xs bg-white p-2 rounded border max-h-40 overflow-y-auto">
                        <!-- Dados ser√£o inseridos aqui -->
                    </div>
                </div>
            </div>

            <!-- Bot√µes de Teste -->
            <div class="mt-8 space-y-4">
                <div class="flex flex-wrap gap-4">
                    <button onclick="testAuth()" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                        üîê Testar Autentica√ß√£o
                    </button>
                    <button onclick="testFarmId()" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">
                        üè† Testar Farm ID
                    </button>
                    <button onclick="testProductionData()" class="px-4 py-2 bg-yellow-500 text-white rounded hover:bg-yellow-600">
                        üìä Testar Dados de Produ√ß√£o
                    </button>
                    <button onclick="testQualityData()" class="px-4 py-2 bg-purple-500 text-white rounded hover:bg-purple-600">
                        üß™ Testar Dados de Qualidade
                    </button>
                    <button onclick="testAll()" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600">
                        üîÑ Testar Tudo
                    </button>
                </div>
            </div>

            <!-- Resultados Detalhados -->
            <div class="mt-8">
                <h2 class="text-xl font-bold text-gray-900 mb-4">üìã Resultados Detalhados</h2>
                <div id="detailedResults" class="bg-gray-100 p-4 rounded-lg text-sm font-mono">
                    Clique em "Testar Tudo" para ver os resultados detalhados...
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentUser = null;
        let currentFarmId = null;

        // Fun√ß√£o para testar autentica√ß√£o
        async function testAuth() {
            const statusDiv = document.getElementById('authStatus');
            const resultsDiv = document.getElementById('detailedResults');
            
            try {
                statusDiv.innerHTML = 'üîç Verificando...';
                
                const { data: { user }, error } = await supabase.auth.getUser();
                
                if (error) {
                    statusDiv.innerHTML = '‚ùå Erro na autentica√ß√£o: ' + error.message;
                    resultsDiv.innerHTML += `<div class="text-red-600">‚ùå Erro de autentica√ß√£o: ${error.message}</div>`;
                    return;
                }
                
                if (!user) {
                    statusDiv.innerHTML = '‚ùå Usu√°rio n√£o autenticado';
                    resultsDiv.innerHTML += '<div class="text-red-600">‚ùå Usu√°rio n√£o autenticado</div>';
                    return;
                }
                
                currentUser = user;
                statusDiv.innerHTML = `‚úÖ Autenticado: ${user.email}`;
                resultsDiv.innerHTML += `<div class="text-green-600">‚úÖ Usu√°rio autenticado: ${user.email}</div>`;
                
            } catch (error) {
                statusDiv.innerHTML = '‚ùå Erro: ' + error.message;
                resultsDiv.innerHTML += `<div class="text-red-600">‚ùå Erro geral: ${error.message}</div>`;
            }
        }

        // Fun√ß√£o para testar Farm ID
        async function testFarmId() {
            const statusDiv = document.getElementById('farmIdStatus');
            const resultsDiv = document.getElementById('detailedResults');
            
            if (!currentUser) {
                statusDiv.innerHTML = '‚ùå Usu√°rio n√£o autenticado';
                return;
            }
            
            try {
                statusDiv.innerHTML = 'üîç Verificando Farm ID...';
                
                const { data: userData, error } = await supabase
                    .from('users')
                    .select('farm_id, name, role')
                    .eq('id', currentUser.id)
                    .single();
                
                if (error) {
                    statusDiv.innerHTML = '‚ùå Erro ao buscar Farm ID: ' + error.message;
                    resultsDiv.innerHTML += `<div class="text-red-600">‚ùå Erro ao buscar Farm ID: ${error.message}</div>`;
                    return;
                }
                
                if (!userData || !userData.farm_id) {
                    statusDiv.innerHTML = '‚ùå Farm ID n√£o encontrado';
                    resultsDiv.innerHTML += '<div class="text-red-600">‚ùå Farm ID n√£o encontrado</div>';
                    return;
                }
                
                currentFarmId = userData.farm_id;
                statusDiv.innerHTML = `‚úÖ Farm ID: ${userData.farm_id}<br>üë§ Nome: ${userData.name}<br>üîë Role: ${userData.role}`;
                resultsDiv.innerHTML += `<div class="text-green-600">‚úÖ Farm ID encontrado: ${userData.farm_id} | Nome: ${userData.name} | Role: ${userData.role}</div>`;
                
            } catch (error) {
                statusDiv.innerHTML = '‚ùå Erro: ' + error.message;
                resultsDiv.innerHTML += `<div class="text-red-600">‚ùå Erro ao buscar Farm ID: ${error.message}</div>`;
            }
        }

        // Fun√ß√£o para testar dados de produ√ß√£o
        async function testProductionData() {
            const statusDiv = document.getElementById('productionStatus');
            const dataDiv = document.getElementById('productionData');
            const resultsDiv = document.getElementById('detailedResults');
            
            if (!currentFarmId) {
                statusDiv.innerHTML = '‚ùå Farm ID n√£o dispon√≠vel';
                return;
            }
            
            try {
                statusDiv.innerHTML = 'üîç Buscando dados de produ√ß√£o...';
                
                const { data: productionData, error } = await supabase
                    .from('milk_production')
                    .select(`
                        id,
                        production_date,
                        volume_liters,
                        shift,
                        temperature,
                        observations,
                        created_at,
                        users(name)
                    `)
                    .eq('farm_id', currentFarmId)
                    .order('production_date', { ascending: false })
                    .limit(10);
                
                if (error) {
                    statusDiv.innerHTML = '‚ùå Erro ao buscar dados: ' + error.message;
                    resultsDiv.innerHTML += `<div class="text-red-600">‚ùå Erro ao buscar produ√ß√£o: ${error.message}</div>`;
                    return;
                }
                
                if (!productionData || productionData.length === 0) {
                    statusDiv.innerHTML = '‚ö†Ô∏è Nenhum dado de produ√ß√£o encontrado';
                    dataDiv.innerHTML = '<em>Nenhum registro encontrado</em>';
                    resultsDiv.innerHTML += '<div class="text-yellow-600">‚ö†Ô∏è Nenhum dado de produ√ß√£o encontrado</div>';
                    return;
                }
                
                const totalVolume = productionData.reduce((sum, record) => sum + (parseFloat(record.volume_liters) || 0), 0);
                statusDiv.innerHTML = `‚úÖ ${productionData.length} registros encontrados<br>üìä Volume total: ${totalVolume.toFixed(2)} L`;
                
                // Mostrar dados detalhados
                dataDiv.innerHTML = productionData.map(record => `
                    <div class="border-b border-gray-200 py-1">
                        <strong>${record.production_date}</strong> | 
                        ${record.volume_liters}L | 
                        ${record.shift} | 
                        ${record.users?.name || 'N/A'}
                    </div>
                `).join('');
                
                resultsDiv.innerHTML += `<div class="text-green-600">‚úÖ ${productionData.length} registros de produ√ß√£o encontrados | Volume total: ${totalVolume.toFixed(2)}L</div>`;
                
            } catch (error) {
                statusDiv.innerHTML = '‚ùå Erro: ' + error.message;
                resultsDiv.innerHTML += `<div class="text-red-600">‚ùå Erro ao buscar produ√ß√£o: ${error.message}</div>`;
            }
        }

        // Fun√ß√£o para testar dados de qualidade
        async function testQualityData() {
            const statusDiv = document.getElementById('qualityStatus');
            const dataDiv = document.getElementById('qualityData');
            const resultsDiv = document.getElementById('detailedResults');
            
            if (!currentFarmId) {
                statusDiv.innerHTML = '‚ùå Farm ID n√£o dispon√≠vel';
                return;
            }
            
            try {
                statusDiv.innerHTML = 'üîç Buscando dados de qualidade...';
                
                const { data: qualityData, error } = await supabase
                    .from('quality_tests')
                    .select(`
                        id,
                        test_date,
                        fat_percentage,
                        protein_percentage,
                        scc,
                        cbt,
                        created_at
                    `)
                    .eq('farm_id', currentFarmId)
                    .order('test_date', { ascending: false })
                    .limit(10);
                
                if (error) {
                    statusDiv.innerHTML = '‚ùå Erro ao buscar dados: ' + error.message;
                    resultsDiv.innerHTML += `<div class="text-red-600">‚ùå Erro ao buscar qualidade: ${error.message}</div>`;
                    return;
                }
                
                if (!qualityData || qualityData.length === 0) {
                    statusDiv.innerHTML = '‚ö†Ô∏è Nenhum dado de qualidade encontrado';
                    dataDiv.innerHTML = '<em>Nenhum registro encontrado</em>';
                    resultsDiv.innerHTML += '<div class="text-yellow-600">‚ö†Ô∏è Nenhum dado de qualidade encontrado</div>';
                    return;
                }
                
                const avgFat = qualityData.reduce((sum, record) => sum + (parseFloat(record.fat_percentage) || 0), 0) / qualityData.length;
                const avgProtein = qualityData.reduce((sum, record) => sum + (parseFloat(record.protein_percentage) || 0), 0) / qualityData.length;
                
                statusDiv.innerHTML = `‚úÖ ${qualityData.length} registros encontrados<br>üßà Gordura m√©dia: ${avgFat.toFixed(2)}%<br>ü•õ Prote√≠na m√©dia: ${avgProtein.toFixed(2)}%`;
                
                // Mostrar dados detalhados
                dataDiv.innerHTML = qualityData.map(record => `
                    <div class="border-b border-gray-200 py-1">
                        <strong>${record.test_date}</strong> | 
                        Gordura: ${record.fat_percentage}% | 
                        Prote√≠na: ${record.protein_percentage}% | 
                        CCS: ${record.scc || 'N/A'}
                    </div>
                `).join('');
                
                resultsDiv.innerHTML += `<div class="text-green-600">‚úÖ ${qualityData.length} registros de qualidade encontrados | Gordura m√©dia: ${avgFat.toFixed(2)}% | Prote√≠na m√©dia: ${avgProtein.toFixed(2)}%</div>`;
                
            } catch (error) {
                statusDiv.innerHTML = '‚ùå Erro: ' + error.message;
                resultsDiv.innerHTML += `<div class="text-red-600">‚ùå Erro ao buscar qualidade: ${error.message}</div>`;
            }
        }

        // Fun√ß√£o para testar tudo
        async function testAll() {
            document.getElementById('detailedResults').innerHTML = '<div class="text-blue-600">üîÑ Iniciando testes completos...</div>';
            
            await testAuth();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testFarmId();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testProductionData();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testQualityData();
            
            document.getElementById('detailedResults').innerHTML += '<div class="text-green-600 font-bold mt-4">‚úÖ Todos os testes conclu√≠dos!</div>';
        }

        // Executar teste inicial quando a p√°gina carregar
        document.addEventListener('DOMContentLoaded', () => {
            testAuth();
        });
    </script>
</body>
</html>
