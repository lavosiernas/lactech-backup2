<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel do Veterinário - Sistema Leiteiro</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Painel do Veterinário - Sistema completo para gestão de produção leiteira, controle de qualidade e relatórios">
    <meta name="theme-color" content="#166534">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="LacTech Veterinário">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="msapplication-TileColor" content="#166534">
    <meta name="msapplication-config" content="/browserconfig.xml">
    
    <!-- PWA Icons -->
    <link rel="icon" href="https://i.postimg.cc/vmrkgDcB/lactech.png" type="image/x-icon">
    <link rel="apple-touch-icon" href="https://i.postimg.cc/vmrkgDcB/lactech.png">
    <link rel="apple-touch-icon" sizes="72x72" href="https://i.postimg.cc/vmrkgDcB/lactech.png">
    <link rel="apple-touch-icon" sizes="96x96" href="https://i.postimg.cc/vmrkgDcB/lactech.png">
    <link rel="apple-touch-icon" sizes="128x128" href="https://i.postimg.cc/vmrkgDcB/lactech.png">
    <link rel="apple-touch-icon" sizes="144x144" href="https://i.postimg.cc/vmrkgDcB/lactech.png">
    <link rel="apple-touch-icon" sizes="152x152" href="https://i.postimg.cc/vmrkgDcB/lactech.png">
    <link rel="apple-touch-icon" sizes="192x192" href="https://i.postimg.cc/vmrkgDcB/lactech.png">
    <link rel="apple-touch-icon" sizes="384x384" href="https://i.postimg.cc/vmrkgDcB/lactech.png">
    <link rel="apple-touch-icon" sizes="512x512" href="https://i.postimg.cc/vmrkgDcB/lactech.png">
    
    <!-- PWA Manifest -->

    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="assets/js/pdf-generator.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="assets/js/loading-screen.js"></script>
    <script src="lactech-api-nova.js"></script>
    <script src="auth_fix.js"></script>
    <script src="pwa-manager.js"></script>
    <script>
        // Aguardar configuração do Supabase antes de carregar fix_data_sync_complete.js
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(function() {
                const script = document.createElement('script');
                script.src = 'fix_data_sync_complete.js';
                document.head.appendChild(script);
            }, 1000);
        });
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="assets/css/style.css">
    <link href="assets/css/dark-theme-fixes.css?v=2.0" rel="stylesheet">
    <link href="assets/css/loading-screen.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'forest': {
                            50: '#f0f9f0', 100: '#dcf2dc', 200: '#bce5bc', 300: '#8dd18d',
                            400: '#5bb85b', 500: '#369e36', 600: '#2a7f2a', 700: '#236523',
                            800: '#1f511f', 900: '#1a431a',
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="gradient-mesh antialiased">

    <!-- Header -->
    <header class="gradient-forest shadow-xl sticky top-0 z-40 border-b border-forest-800">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center space-x-3">
                    <div class="header-logo-container">
                        <img src="assets/img/lactech-logo.png" alt="LacTech Logo" class="header-logo">
                    </div>
                    <div>
                        <h1 class="text-lg font-bold text-white tracking-tight">PAINEL VETERINÁRIO</h1>
                        <p class="text-xs text-forest-200" id="farmNameHeader">Carregando...</p>
                    </div>
                </div>

                <!-- Desktop Navigation -->
                <nav class="hidden md:flex space-x-1">
                    <button class="nav-item active relative px-3 py-2 text-sm font-semibold text-white hover:text-forest-200 transition-all rounded-lg" data-tab="dashboard">
                        Dashboard
                    </button>
                    <button class="nav-item relative px-3 py-2 text-sm font-semibold text-white hover:text-forest-200 transition-all rounded-lg" data-tab="animals">
                        Animais
                    </button>
                    <button class="nav-item relative px-3 py-2 text-sm font-semibold text-white hover:text-forest-200 transition-all rounded-lg" data-tab="treatments">
                        Tratamentos
                    </button>
                    <button class="nav-item relative px-3 py-2 text-sm font-semibold text-white hover:text-forest-200 transition-all rounded-lg" data-tab="insemination">
                        Inseminação IA
                    </button>
                    <button class="nav-item relative px-3 py-2 text-sm font-semibold text-white hover:text-forest-200 transition-all rounded-lg" data-tab="reports">
                        Relatórios
                    </button>
                </nav>

                <div class="flex items-center space-x-4">
                    <!-- Botão de retorno à conta do gerente (apenas para contas secundárias) -->
                    <div id="returnToManagerBtn" class="hidden">
                        <button onclick="returnToManagerAccount()" class="flex items-center space-x-2 text-white hover:text-forest-200 p-2 rounded-lg transition-all bg-white bg-opacity-10 hover:bg-opacity-20">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                            </svg>
                            <span class="text-sm font-medium">Voltar ao Gerente</span>
                        </button>
                    </div>
                    
                    <button onclick="openProfileModal()" class="flex items-center space-x-3 text-white hover:text-forest-200 p-2 rounded-lg transition-all">
                        <div class="w-8 h-8 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                            </svg>
                        </div>
                        <div class="text-left hidden sm:block">
                            <div class="text-sm font-semibold" id="vetName">Carregando...</div>
                            <div class="text-xs text-forest-200">Veterinário</div>
                        </div>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 pb-24 md:pb-4">
        
        <!-- Dashboard Tab -->
        <div id="dashboard-tab" class="tab-content">
            <!-- Welcome Section -->
            <div class="gradient-forest rounded-2xl p-6 mb-6 text-white shadow-xl relative overflow-hidden">
                <div class="relative z-10">
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="text-2xl font-bold mb-2">Olá, Dr(a). <span id="vetWelcome">Carregando...</span>!</h2>
                            <p class="text-forest-200 text-base font-medium mb-3">Monitore a saúde do rebanho</p>
                            <div class="flex items-center space-x-4">
                                <div class="text-xs font-medium">Última atualização: Agora</div>
                            </div>
                        </div>
                        <div class="hidden sm:block">
                            <div class="w-16 h-16 bg-white bg-opacity-20 rounded-2xl flex items-center justify-center backdrop-blur-sm">
                                <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
                                </svg>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Health Overview -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div class="data-card rounded-2xl p-4 text-center">
                    <div class="w-12 h-12 bg-green-500 rounded-xl flex items-center justify-center mx-auto mb-3 shadow-lg">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <div class="text-xl font-bold text-slate-900 mb-1" id="healthyAnimals">--</div>
                    <div class="text-xs text-slate-500 font-medium">Saudáveis</div>
                    <div class="text-xs text-slate-600 font-semibold mt-1">Animais</div>
                </div>
                
                <div class="data-card rounded-2xl p-4 text-center">
                    <div class="w-12 h-12 bg-yellow-500 rounded-xl flex items-center justify-center mx-auto mb-3 shadow-lg">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                        </svg>
                    </div>
                    <div class="text-xl font-bold text-slate-900 mb-1" id="warningAnimals">--</div>
                    <div class="text-xs text-slate-500 font-medium">Atenção</div>
                    <div class="text-xs text-slate-600 font-semibold mt-1">Animais</div>
                </div>
                
                <div class="data-card rounded-2xl p-4 text-center">
                    <div class="w-12 h-12 bg-red-500 rounded-xl flex items-center justify-center mx-auto mb-3 shadow-lg">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <div class="text-xl font-bold text-slate-900 mb-1" id="criticalAnimals">--</div>
                    <div class="text-xs text-slate-500 font-medium">Críticos</div>
                    <div class="text-xs text-slate-600 font-semibold mt-1">Animais</div>
                </div>
                
                <div class="data-card rounded-2xl p-4 text-center">
                    <div class="w-12 h-12 bg-blue-500 rounded-xl flex items-center justify-center mx-auto mb-3 shadow-lg">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path>
                        </svg>
                    </div>
                    <div class="text-xl font-bold text-slate-900 mb-1" id="activeTreatments">--</div>
                    <div class="text-xs text-slate-500 font-medium">Ativos</div>
                    <div class="text-xs text-slate-600 font-semibold mt-1">Tratamentos</div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <!-- Quick Health Check -->
                <div class="data-card rounded-2xl p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-bold text-slate-900">Registro Rápido</h3>
                        <div class="w-10 h-10 gradient-forest rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                            </svg>
                        </div>
                    </div>
                    <form id="quickHealthForm" class="space-y-4">
                        <div class="form-floating">
                            <input type="text" id="quickAnimalId" name="animal_id" class="w-full px-3 py-4 border border-slate-200 rounded-xl focus:border-forest-500 focus:ring-2 focus:ring-forest-100 focus:outline-none" placeholder=" " required>
                            <label for="quickAnimalId" class="text-slate-600">ID do Animal</label>
                        </div>
                        <div class="form-floating">
                            <select id="quickHealthStatus" name="health_status" class="w-full px-3 py-4 border border-slate-200 rounded-xl focus:border-forest-500 focus:ring-2 focus:ring-forest-100 focus:outline-none" required>
                                <option value="">Selecione...</option>
                                <option value="healthy">Saudável</option>
                                <option value="warning">Atenção</option>
                                <option value="critical">Crítico</option>
                            </select>
                            <label for="quickHealthStatus" class="text-slate-600">Status de Saúde</label>
                        </div>
                        <button type="submit" class="w-full gradient-forest text-white font-semibold py-3 rounded-xl hover:shadow-lg transition-all">
                            <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                            </svg>
                            Registrar Status
                        </button>
                    </form>
                </div>

                <!-- Recent Alerts -->
                <div class="data-card rounded-2xl p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-bold text-slate-900">Alertas Recentes</h3>
                        <button onclick="showTab('animals')" class="text-forest-600 hover:text-forest-700 font-semibold text-sm">Ver Todos</button>
                    </div>
                    <div class="space-y-3" id="recentAlerts">
                        <div class="text-center py-8">
                            <div class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 17h5l-5 5v-5zM4.828 4.828A4 4 0 015.5 4H9v1H5.5a3 3 0 00-2.121.879l-.707.707A1 1 0 012 7.414V11H1V7.414a2 2 0 01.586-1.414l.707-.707a5 5 0 013.535-1.465z"></path>
                                </svg>
                            </div>
                            <p class="text-gray-500 text-sm">Nenhum alerta recente</p>
                            <p class="text-gray-400 text-xs">Todos os animais estão bem</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Health Trends Chart -->
            <div class="data-card rounded-2xl p-6">
                <h3 class="text-lg font-bold text-slate-900 mb-4">Tendências de Saúde</h3>
                <div class="h-64 flex items-center justify-center">
                    <div class="text-center">
                        <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                            </svg>
                        </div>
                        <p class="text-gray-500 text-sm">Dados insuficientes para gráfico</p>
                        <p class="text-gray-400 text-xs">Registre mais dados para visualizar tendências</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Animals Tab -->
        <div id="animals-tab" class="tab-content hidden">
            <div class="space-y-6">
                <!-- Header -->
                <div class="data-card rounded-2xl p-6">
                    <div class="flex flex-col sm:flex-row sm:items-center justify-between mb-6 gap-4">
                        <div>
                            <h2 class="text-xl md:text-2xl font-bold text-slate-900 mb-1">Gestão de Animais</h2>
                            <p class="text-slate-600 text-sm">Monitore a saúde e histórico dos animais</p>
                        </div>
                        <div class="flex flex-col sm:flex-row gap-3 w-full sm:w-auto">
                            <select id="animalFilter" class="px-4 py-2 border border-slate-200 rounded-lg text-sm focus:border-forest-500 focus:outline-none">
                                <option value="all">Todos os animais</option>
                                <option value="healthy">Saudáveis</option>
                                <option value="warning">Atenção</option>
                                <option value="critical">Críticos</option>
                            </select>
                            <button onclick="openAddAnimalModal()" class="px-4 py-2 bg-forest-600 text-white rounded-lg hover:shadow-lg transition-all font-semibold text-sm">
                                <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                </svg>
                                Adicionar Animal
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Animals List -->
                <div class="data-card rounded-2xl p-6">
                    <div class="space-y-4" id="animalsList">
                        <div class="text-center py-12">
                            <div class="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-6">
                                <svg class="w-10 h-10 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                                </svg>
                            </div>
                            <h3 class="text-lg font-semibold text-gray-900 mb-2">Nenhum Animal Cadastrado</h3>
                            <p class="text-gray-600 mb-4">Comece adicionando animais ao sistema</p>
                            <button onclick="openAddAnimalModal()" class="px-6 py-3 gradient-forest text-white font-semibold rounded-xl hover:shadow-lg transition-all">
                                <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                </svg>
                                Adicionar Primeiro Animal
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Treatments Tab -->
        <div id="treatments-tab" class="tab-content hidden">
            <div class="space-y-6">
                <!-- Header -->
                <div class="data-card rounded-2xl p-6">
                    <div class="flex flex-col sm:flex-row sm:items-center justify-between mb-6 gap-4">
                        <div>
                            <h2 class="text-xl md:text-2xl font-bold text-slate-900 mb-1">Tratamentos</h2>
                            <p class="text-slate-600 text-sm">Gerencie tratamentos e medicações</p>
                        </div>
                        <div class="flex flex-col sm:flex-row gap-3 w-full sm:w-auto">
                            <select id="treatmentFilter" class="px-4 py-2 border border-slate-200 rounded-lg text-sm focus:border-forest-500 focus:outline-none">
                                <option value="all">Todos os tratamentos</option>
                                <option value="active">Ativos</option>
                                <option value="completed">Concluídos</option>
                                <option value="pending">Pendentes</option>
                            </select>
                            <button onclick="openAddTreatmentModal()" class="px-4 py-2 bg-forest-600 text-white rounded-lg hover:shadow-lg transition-all font-semibold text-sm">
                                <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                </svg>
                                Novo Tratamento
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Treatment Form -->
                <div class="data-card rounded-2xl p-6">
                    <h3 class="text-lg font-bold text-slate-900 mb-4">Registrar Tratamento</h3>
                    <form id="treatmentForm" class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Animal ID -->
                            <div class="form-floating">
                                <input type="text" id="treatmentAnimalId" name="animal_id" class="w-full px-3 py-4 border border-slate-200 rounded-xl focus:border-forest-500 focus:ring-2 focus:ring-forest-100 focus:outline-none" placeholder=" " required>
                                <label for="treatmentAnimalId" class="text-slate-600">ID do Animal *</label>
                            </div>

                            <!-- Treatment Type -->
                            <div class="form-floating">
                                <select id="treatmentType" name="treatment_type" class="w-full px-3 py-4 border border-slate-200 rounded-xl focus:border-forest-500 focus:ring-2 focus:ring-forest-100 focus:outline-none" required>
                                    <option value="">Selecione...</option>
                                    <option value="vaccination">Vacinação</option>
                                    <option value="medication">Medicação</option>
                                    <option value="surgery">Cirurgia</option>
                                    <option value="examination">Exame</option>
                                    <option value="other">Outro</option>
                                </select>
                                <label for="treatmentType" class="text-slate-600">Tipo de Tratamento *</label>
                            </div>

                            <!-- Medication -->
                            <div class="form-floating">
                                <input type="text" id="medication" name="medication" class="w-full px-3 py-4 border border-slate-200 rounded-xl focus:border-forest-500 focus:ring-2 focus:ring-forest-100 focus:outline-none" placeholder=" ">
                                <label for="medication" class="text-slate-600">Medicamento/Vacina</label>
                            </div>

                            <!-- Dosage -->
                            <div class="form-floating">
                                <input type="text" id="dosage" name="dosage" class="w-full px-3 py-4 border border-slate-200 rounded-xl focus:border-forest-500 focus:ring-2 focus:ring-forest-100 focus:outline-none" placeholder=" ">
                                <label for="dosage" class="text-slate-600">Dosagem</label>
                            </div>

                            <!-- Start Date -->
                            <div class="form-floating">
                                <input type="date" id="startDate" name="start_date" class="w-full px-3 py-4 border border-slate-200 rounded-xl focus:border-forest-500 focus:ring-2 focus:ring-forest-100 focus:outline-none" required>
                                <label for="startDate" class="text-slate-600">Data de Início *</label>
                            </div>

                            <!-- End Date -->
                            <div class="form-floating">
                                <input type="date" id="endDate" name="end_date" class="w-full px-3 py-4 border border-slate-200 rounded-xl focus:border-forest-500 focus:ring-2 focus:ring-forest-100 focus:outline-none">
                                <label for="endDate" class="text-slate-600">Data de Término</label>
                            </div>
                        </div>

                        <!-- Notes -->
                        <div class="form-floating">
                            <textarea id="treatmentNotes" name="notes" rows="3" class="w-full px-3 py-4 border border-slate-200 rounded-xl focus:border-forest-500 focus:ring-2 focus:ring-forest-100 focus:outline-none resize-none" placeholder=" "></textarea>
                            <label for="treatmentNotes" class="text-slate-600">Observações</label>
                        </div>

                        <!-- Submit Button -->
                        <div class="flex flex-col sm:flex-row gap-4 pt-4">
                            <button type="submit" class="flex-1 gradient-forest text-white font-semibold py-3 px-6 rounded-xl hover:shadow-lg transition-all">
                                <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                </svg>
                                Registrar Tratamento
                            </button>
                            <button type="button" onclick="resetTreatmentForm()" class="px-6 py-3 border border-slate-300 text-slate-700 font-semibold rounded-xl hover:bg-slate-50 transition-all">
                                <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                </svg>
                                Limpar Formulário
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Treatments List -->
                <div class="data-card rounded-2xl p-6">
                    <h3 class="text-lg font-bold text-slate-900 mb-4">Tratamentos Ativos</h3>
                    <div class="space-y-4" id="treatmentsList">
                        <div class="text-center py-12">
                            <div class="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-6">
                                <svg class="w-10 h-10 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path>
                                </svg>
                            </div>
                            <h3 class="text-lg font-semibold text-gray-900 mb-2">Nenhum Tratamento Ativo</h3>
                            <p class="text-gray-600 mb-4">Registre tratamentos para acompanhar a saúde dos animais</p>
                            <p class="text-gray-500 text-sm">Use o formulário acima para adicionar um novo tratamento</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Insemination Tab -->
        <div id="insemination-tab" class="tab-content hidden">
            <div class="space-y-6">
                <!-- Header -->
                <div class="data-card rounded-2xl p-6">
                    <div class="flex flex-col sm:flex-row sm:items-center justify-between mb-6 gap-4">
                        <div>
                            <h2 class="text-xl md:text-2xl font-bold text-slate-900 mb-1">Inseminação Artificial</h2>
                            <p class="text-slate-600 text-sm">Controle reprodutivo e registro de inseminações</p>
                        </div>
                        <div class="flex flex-col sm:flex-row gap-3 w-full sm:w-auto">
                            <select id="inseminationFilter" class="px-4 py-2 border border-slate-200 rounded-lg text-sm focus:border-forest-500 focus:outline-none">
                                <option value="all">Todas as inseminações</option>
                                <option value="confirmed">Gravidez confirmada</option>
                                <option value="pending">Aguardando confirmação</option>
                                <option value="failed">Não confirmada</option>
                            </select>
                            <button onclick="openAddInseminationModal()" class="px-4 py-2 bg-forest-600 text-white rounded-lg hover:shadow-lg transition-all font-semibold text-sm">
                                <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                </svg>
                                Nova Inseminação
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Insemination Statistics -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="data-card rounded-2xl p-4 text-center">
                        <div class="w-12 h-12 bg-blue-500 rounded-xl flex items-center justify-center mx-auto mb-3 shadow-lg">
                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                            </svg>
                        </div>
                        <div class="text-xl font-bold text-slate-900 mb-1" id="totalInseminations">--</div>
                        <div class="text-xs text-slate-500 font-medium">Total</div>
                        <div class="text-xs text-slate-600 font-semibold mt-1">Inseminações</div>
                    </div>
                    
                    <div class="data-card rounded-2xl p-4 text-center">
                        <div class="w-12 h-12 bg-green-500 rounded-xl flex items-center justify-center mx-auto mb-3 shadow-lg">
                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <div class="text-xl font-bold text-slate-900 mb-1" id="confirmedPregnancies">--</div>
                        <div class="text-xs text-slate-500 font-medium">Confirmadas</div>
                        <div class="text-xs text-slate-600 font-semibold mt-1">Gestações</div>
                    </div>
                    
                    <div class="data-card rounded-2xl p-4 text-center">
                        <div class="w-12 h-12 bg-yellow-500 rounded-xl flex items-center justify-center mx-auto mb-3 shadow-lg">
                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <div class="text-xl font-bold text-slate-900 mb-1" id="pendingConfirmations">--</div>
                        <div class="text-xs text-slate-500 font-medium">Pendentes</div>
                        <div class="text-xs text-slate-600 font-semibold mt-1">Confirmações</div>
                    </div>
                    
                    <div class="data-card rounded-2xl p-4 text-center">
                        <div class="w-12 h-12 bg-purple-500 rounded-xl flex items-center justify-center mx-auto mb-3 shadow-lg">
                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M16 8v8m-4-5v5m-4-2v2m-2 4h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                            </svg>
                        </div>
                        <div class="text-xl font-bold text-slate-900 mb-1" id="successRate">--%</div>
                        <div class="text-xs text-slate-500 font-medium">Taxa de</div>
                        <div class="text-xs text-slate-600 font-semibold mt-1">Sucesso</div>
                    </div>
                </div>

                <!-- Insemination Form -->
                <div class="data-card rounded-2xl p-6">
                    <h3 class="text-lg font-bold text-slate-900 mb-4">Registrar Inseminação Artificial</h3>
                    <form id="inseminationForm" class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Animal ID -->
                            <div class="form-floating">
                                <input type="text" id="inseminationAnimalId" name="animal_id" class="w-full px-3 py-4 border border-slate-200 rounded-xl focus:border-forest-500 focus:ring-2 focus:ring-forest-100 focus:outline-none" placeholder=" " required>
                                <label for="inseminationAnimalId" class="text-slate-600">ID do Animal *</label>
                            </div>

                            <!-- Insemination Date -->
                            <div class="form-floating">
                                <input type="datetime-local" id="inseminationDate" name="insemination_date" class="w-full px-3 py-4 border border-slate-200 rounded-xl focus:border-forest-500 focus:ring-2 focus:ring-forest-100 focus:outline-none" required>
                                <label for="inseminationDate" class="text-slate-600">Data e Hora da IA *</label>
                            </div>

                            <!-- Semen Batch -->
                            <div class="form-floating">
                                <input type="text" id="semenBatch" name="semen_batch" class="w-full px-3 py-4 border border-slate-200 rounded-xl focus:border-forest-500 focus:ring-2 focus:ring-forest-100 focus:outline-none" placeholder=" " required>
                                <label for="semenBatch" class="text-slate-600">Lote do Sêmen *</label>
                            </div>

                            <!-- Bull ID -->
                            <div class="form-floating">
                                <input type="text" id="bullId" name="bull_id" class="w-full px-3 py-4 border border-slate-200 rounded-xl focus:border-forest-500 focus:ring-2 focus:ring-forest-100 focus:outline-none" placeholder=" ">
                                <label for="bullId" class="text-slate-600">ID do Touro</label>
                            </div>

                            <!-- Technician -->
                            <div class="form-floating">
                                <input type="text" id="technician" name="technician" class="w-full px-3 py-4 border border-slate-200 rounded-xl focus:border-forest-500 focus:ring-2 focus:ring-forest-100 focus:outline-none" placeholder=" ">
                                <label for="technician" class="text-slate-600">Técnico Responsável</label>
                            </div>

                            <!-- Heat Detection Method -->
                            <div class="form-floating">
                                <select id="heatDetectionMethod" name="heat_detection_method" class="w-full px-3 py-4 border border-slate-200 rounded-xl focus:border-forest-500 focus:ring-2 focus:ring-forest-100 focus:outline-none">
                                    <option value="">Selecione...</option>
                                    <option value="visual">Observação Visual</option>
                                    <option value="detector">Detector de Cio</option>
                                    <option value="hormonal">Sincronização Hormonal</option>
                                    <option value="other">Outro</option>
                                </select>
                                <label for="heatDetectionMethod" class="text-slate-600">Método de Detecção do Cio</label>
                            </div>

                            <!-- Body Condition Score -->
                            <div class="form-floating">
                                <select id="bodyConditionScore" name="body_condition_score" class="w-full px-3 py-4 border border-slate-200 rounded-xl focus:border-forest-500 focus:ring-2 focus:ring-forest-100 focus:outline-none">
                                    <option value="">Selecione...</option>
                                    <option value="1">1 - Muito Magra</option>
                                    <option value="2">2 - Magra</option>
                                    <option value="3">3 - Ideal</option>
                                    <option value="4">4 - Gorda</option>
                                    <option value="5">5 - Muito Gorda</option>
                                </select>
                                <label for="bodyConditionScore" class="text-slate-600">Escore de Condição Corporal</label>
                            </div>

                            <!-- Expected Birth Date (calculated automatically) -->
                            <div class="form-floating">
                                <input type="date" id="expectedBirthDate" name="expected_birth_date" class="w-full px-3 py-4 border border-slate-200 rounded-xl bg-slate-50" readonly>
                                <label for="expectedBirthDate" class="text-slate-600">Data Prevista de Parto (calculada)</label>
                            </div>
                        </div>

                        <!-- Observations -->
                        <div class="form-floating">
                            <textarea id="inseminationObservations" name="observations" rows="3" class="w-full px-3 py-4 border border-slate-200 rounded-xl focus:border-forest-500 focus:ring-2 focus:ring-forest-100 focus:outline-none resize-none" placeholder=" "></textarea>
                            <label for="inseminationObservations" class="text-slate-600">Observações Técnicas</label>
                        </div>

                        <!-- Submit Button -->
                        <div class="flex flex-col sm:flex-row gap-4 pt-4">
                            <button type="submit" class="flex-1 gradient-forest text-white font-semibold py-3 px-6 rounded-xl hover:shadow-lg transition-all">
                                <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                </svg>
                                Registrar Inseminação
                            </button>
                            <button type="button" onclick="resetInseminationForm()" class="px-6 py-3 border border-slate-300 text-slate-700 font-semibold rounded-xl hover:bg-slate-50 transition-all">
                                <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                </svg>
                                Limpar Formulário
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Inseminations List -->
                <div class="data-card rounded-2xl p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-bold text-slate-900">Histórico de Inseminações</h3>
                        <button onclick="refreshInseminationsList()" class="text-forest-600 hover:text-forest-700 p-2 rounded-lg hover:bg-forest-50 transition-all">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                            </svg>
                        </button>
                    </div>
                    <div class="space-y-4" id="inseminationsList">
                        <div class="text-center py-12">
                            <div class="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-6">
                                <svg class="w-10 h-10 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                </svg>
                            </div>
                            <h3 class="text-lg font-semibold text-gray-900 mb-2">Nenhuma Inseminação Registrada</h3>
                            <p class="text-gray-600 mb-4">Registre inseminações para controlar o programa reprodutivo</p>
                            <p class="text-gray-500 text-sm">Use o formulário acima para adicionar uma nova inseminação</p>
                        </div>
                    </div>
                </div>

                <!-- Pregnancy Confirmation Section -->
                <div class="data-card rounded-2xl p-6">
                    <h3 class="text-lg font-bold text-slate-900 mb-4">Confirmação de Gravidez</h3>
                    <form id="pregnancyConfirmationForm" class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <!-- Insemination ID -->
                            <div class="form-floating">
                                <select id="inseminationSelect" name="insemination_id" class="w-full px-3 py-4 border border-slate-200 rounded-xl focus:border-forest-500 focus:ring-2 focus:ring-forest-100 focus:outline-none" required>
                                    <option value="">Selecione uma inseminação...</option>
                                </select>
                                <label for="inseminationSelect" class="text-slate-600">Inseminação *</label>
                            </div>

                            <!-- Pregnancy Status -->
                            <div class="form-floating">
                                <select id="pregnancyStatus" name="pregnancy_confirmed" class="w-full px-3 py-4 border border-slate-200 rounded-xl focus:border-forest-500 focus:ring-2 focus:ring-forest-100 focus:outline-none" required>
                                    <option value="">Selecione...</option>
                                    <option value="true">Confirmada</option>
                                    <option value="false">Não Confirmada</option>
                                </select>
                                <label for="pregnancyStatus" class="text-slate-600">Status da Gravidez *</label>
                            </div>

                            <!-- Confirmation Method -->
                            <div class="form-floating">
                                <select id="confirmationMethod" name="confirmation_method" class="w-full px-3 py-4 border border-slate-200 rounded-xl focus:border-forest-500 focus:ring-2 focus:ring-forest-100 focus:outline-none">
                                    <option value="">Selecione...</option>
                                    <option value="ultrasound">Ultrassom</option>
                                    <option value="palpation">Palpação Retal</option>
                                    <option value="blood_test">Exame de Sangue</option>
                                    <option value="visual">Observação Visual</option>
                                </select>
                                <label for="confirmationMethod" class="text-slate-600">Método de Confirmação</label>
                            </div>
                        </div>

                        <!-- Confirmation Date -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="form-floating">
                                <input type="date" id="confirmationDate" name="confirmation_date" class="w-full px-3 py-4 border border-slate-200 rounded-xl focus:border-forest-500 focus:ring-2 focus:ring-forest-100 focus:outline-none" required>
                                <label for="confirmationDate" class="text-slate-600">Data da Confirmação *</label>
                            </div>
                        </div>

                        <!-- Submit Button -->
                        <div class="flex flex-col sm:flex-row gap-4 pt-4">
                            <button type="submit" class="flex-1 gradient-forest text-white font-semibold py-3 px-6 rounded-xl hover:shadow-lg transition-all">
                                <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                Confirmar Gravidez
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Reports Tab -->
        <div id="reports-tab" class="tab-content hidden">
            <div class="space-y-6">
                <!-- Header -->
                <div class="data-card rounded-2xl p-6">
                    <div class="flex flex-col sm:flex-row sm:items-center justify-between mb-6 gap-4">
                        <div>
                            <h2 class="text-xl md:text-2xl font-bold text-slate-900 mb-1">Relatórios Veterinários</h2>
                            <p class="text-slate-600 text-sm">Análises detalhadas da saúde do rebanho</p>
                        </div>
                    </div>
                </div>

                <!-- Report Options -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Health Report -->
                    <div class="data-card rounded-2xl p-6 text-center">
                        <div class="w-16 h-16 bg-green-100 rounded-2xl flex items-center justify-center mx-auto mb-4">
                            <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                            </svg>
                        </div>
                        <h3 class="text-lg font-semibold text-slate-900 mb-2">Relatório de Saúde</h3>
                        <p class="text-slate-600 text-sm mb-4">Status geral do rebanho</p>
                        <button onclick="generateHealthReport()" class="w-full px-4 py-2 bg-green-600 text-white rounded-lg hover:shadow-lg transition-all font-semibold text-sm">
                            Gerar Relatório
                        </button>
                    </div>

                    <!-- Treatment Report -->
                    <div class="data-card rounded-2xl p-6 text-center">
                        <div class="w-16 h-16 bg-blue-100 rounded-2xl flex items-center justify-center mx-auto mb-4">
                            <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path>
                            </svg>
                        </div>
                        <h3 class="text-lg font-semibold text-slate-900 mb-2">Relatório de Tratamentos</h3>
                        <p class="text-slate-600 text-sm mb-4">Histórico de medicações</p>
                        <button onclick="generateTreatmentReport()" class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:shadow-lg transition-all font-semibold text-sm">
                            Gerar Relatório
                        </button>
                    </div>

                    <!-- Vaccination Report -->
                    <div class="data-card rounded-2xl p-6 text-center">
                        <div class="w-16 h-16 bg-purple-100 rounded-2xl flex items-center justify-center mx-auto mb-4">
                            <svg class="w-8 h-8 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                            </svg>
                        </div>
                        <h3 class="text-lg font-semibold text-slate-900 mb-2">Relatório de Vacinação</h3>
                        <p class="text-slate-600 text-sm mb-4">Controle vacinal</p>
                        <button onclick="generateVaccinationReport()" class="w-full px-4 py-2 bg-purple-600 text-white rounded-lg hover:shadow-lg transition-all font-semibold text-sm">
                            Gerar Relatório
                        </button>
                    </div>
                </div>

                <!-- Report Preview -->
                <div class="data-card rounded-2xl p-6">
                    <h3 class="text-lg font-bold text-slate-900 mb-4">Prévia do Relatório</h3>
                    <div class="text-center py-12">
                        <div class="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-6">
                            <svg class="w-10 h-10 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-900 mb-2">Selecione um Relatório</h3>
                        <p class="text-gray-600 mb-4">Escolha uma das opções acima para gerar um relatório</p>
                        <p class="text-gray-500 text-sm">Os relatórios serão gerados com base nos dados veterinários</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Enhanced Mobile Navigation -->
    <nav class="fixed bottom-0 left-0 right-0 md:hidden mobile-nav-enhanced shadow-2xl z-40">
        <div class="grid grid-cols-4 gap-1 p-2">
            <button class="mobile-nav-item active flex flex-col items-center py-3 px-2 transition-all" data-tab="dashboard">
                <svg class="w-5 h-5 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                </svg>
                <span class="text-xs font-semibold">Dashboard</span>
            </button>
            <button class="mobile-nav-item flex flex-col items-center py-3 px-2 transition-all" data-tab="animals">
                <svg class="w-5 h-5 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                </svg>
                <span class="text-xs font-semibold">Animais</span>
            </button>
            <button class="mobile-nav-item flex flex-col items-center py-3 px-2 transition-all" data-tab="treatments">
                <svg class="w-5 h-5 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path>
                </svg>
                <span class="text-xs font-semibold">Tratamentos</span>
            </button>
            <button class="mobile-nav-item flex flex-col items-center py-3 px-2 transition-all" data-tab="insemination">
                <svg class="w-5 h-5 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <span class="text-xs font-semibold">Inseminação IA</span>
            </button>
            <button class="mobile-nav-item flex flex-col items-center py-3 px-2 transition-all" data-tab="reports">
                <svg class="w-5 h-5 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                <span class="text-xs font-semibold">Relatórios</span>
            </button>
        </div>
    </nav>

    <!-- Modal de Perfil do Veterinário -->
    <div id="profileModal" class="fullscreen-modal">
        <div class="modal-content">
            <!-- Header do Modal -->
            <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 z-10">
                <div class="flex items-center justify-between">
                    <h2 class="text-xl font-bold text-gray-900">Perfil do Veterinário</h2>
                    <button onclick="closeProfileModal()" class="p-2 hover:bg-gray-100 rounded-lg transition-all">
                        <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>
            
            <!-- Conteúdo do Perfil -->
            <div class="p-6 space-y-6">
                <!-- Header do Perfil -->
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center space-x-4">
                        <div class="w-16 h-16 gradient-forest rounded-2xl flex items-center justify-center shadow-lg">
                            <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                            </svg>
                        </div>
                        <div>
                            <h2 class="text-2xl font-bold text-slate-900" id="profileName">Carregando...</h2>
                            <p class="text-slate-600 text-base">Veterinário</p>
                            <p class="text-sm text-slate-500" id="profileFarmName">Carregando...</p>
                        </div>
                    </div>
                </div>
                
                <!-- Informações Profissionais (só para contas principais) -->
                <div id="professionalInfoSection" class="bg-white rounded-2xl p-6 shadow-sm border border-gray-200">
                    <h4 class="text-lg font-semibold text-gray-900 mb-4">Informações Profissionais</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-600 mb-1">Nome Completo</label>
                            <p class="text-gray-900 font-medium" id="profileFullName">Carregando...</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-600 mb-1">Email</label>
                            <p class="text-gray-900 font-medium" id="profileEmail2">Carregando...</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-600 mb-1">Telefone</label>
                            <p class="text-gray-900 font-medium" id="profilePhone">Carregando...</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-600 mb-1">Especialidade</label>
                            <p class="text-gray-900 font-medium" id="profileSpecialty">Carregando...</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-600 mb-1">Cargo</label>
                            <p class="text-gray-900 font-medium">Veterinário</p>
                        </div>
                    </div>
                </div>
                
                <!-- Alterar Senha (só para contas principais) -->
                <div id="changePasswordSection" class="bg-white rounded-2xl p-6 shadow-sm border border-gray-200">
                    <h4 class="text-lg font-semibold text-gray-900 mb-4">Alterar Senha</h4>
                    <form id="changePasswordForm" class="space-y-4">
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 mb-2">Senha Atual</label>
                            <input type="password" required name="current_password" class="w-full px-4 py-3 border border-slate-200 rounded-xl focus:border-forest-500 focus:ring-2 focus:ring-forest-100 focus:outline-none" placeholder="Digite sua senha atual">
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-2">Nova Senha</label>
                                <input type="password" required name="new_password" class="w-full px-4 py-3 border border-slate-200 rounded-xl focus:border-forest-500 focus:ring-2 focus:ring-forest-100 focus:outline-none" placeholder="Nova senha">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-2">Confirmar Nova Senha</label>
                                <input type="password" required name="confirm_password" class="w-full px-4 py-3 border border-slate-200 rounded-xl focus:border-forest-500 focus:ring-2 focus:ring-forest-100 focus:outline-none" placeholder="Confirme a nova senha">
                            </div>
                        </div>
                        <button type="submit" class="px-6 py-3 gradient-forest text-white font-semibold rounded-xl hover:shadow-lg transition-all">
                            Alterar Senha
                        </button>
                    </form>
                </div>
                
                <!-- Conta Principal (só para contas secundárias) -->
                <div id="primaryAccountSection" class="bg-white rounded-2xl p-6 shadow-sm border border-blue-200" style="display: none;">
                    <h4 class="text-lg font-semibold text-blue-900 mb-4">Conta Principal</h4>
                    <div class="flex items-center justify-between">
                        <div>
                            <h5 class="font-medium text-blue-900">Retornar para Gerente</h5>
                            <p class="text-sm text-blue-600">Voltar para sua conta principal de gerente</p>
                        </div>
                        <button id="switchToPrimaryBtn" onclick="switchToPrimaryAccount()" class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-xl transition-all">
                            <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path>
                            </svg>
                            Retornar
                        </button>
                    </div>
                </div>
                
                <!-- Sair do Sistema (só para contas principais) -->
                <div id="dangerZoneSection" class="bg-white rounded-2xl p-6 shadow-sm border border-red-200">
                    <h4 class="text-lg font-semibold text-red-900 mb-4">Zona de Perigo</h4>
                    <div class="flex items-center justify-between">
                        <div>
                            <h5 class="font-medium text-red-900">Sair do Sistema</h5>
                            <p class="text-sm text-red-600">Encerrar sua sessão atual</p>
                        </div>
                        <button onclick="signOut()" class="px-6 py-3 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-xl transition-all">
                            <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                            </svg>
                            Sair
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Toast -->
    <div id="notificationToast" class="notification-toast">
        <div class="bg-white rounded-lg shadow-lg border border-gray-200 p-4 max-w-sm">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <svg class="w-5 h-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </div>
                <div class="ml-3">
                    <p class="text-sm font-medium text-gray-900" id="toastMessage">Registro salvo com sucesso!</p>
                </div>
                <div class="ml-auto pl-3">
                    <button onclick="hideNotification()" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Supabase Configuration já está no arquivo supabase_config_fixed.js
        // Usar a instância global do supabase

        // Check authentication
        async function checkAuthentication() {
            // Usar a versão corrigida que sincroniza com Supabase
            return await window.authFix.checkAuthenticationFixed();
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', async function() {
            const isAuthenticated = await checkAuthentication();
            if (!isAuthenticated) {
                return; // Stop execution if not authenticated
            }
            await initializePage();
            setupEventListeners();
            setCurrentDate();
        });

        async function initializePage() {
            // Verificar se o usuário está ativo
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (user) {
                    const { data: userData, error } = await supabase
                        .from('users')
                        .select('is_active')
                        .eq('id', user.id)
                        .single();
                    
                    if (!error && userData && userData.is_active === false) {
                        window.location.href = 'acesso-bloqueado.html';
                        return;
                    }
                }
            } catch (error) {
                console.error('Erro ao verificar status do usuário:', error);
            }
            
            await setFarmName();
            await setVetName();
            await loadDashboardData();
            
        }

        // Function to get farm name from Supabase
        async function getFarmName() {
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) return 'Minha Fazenda';

                const { data: userData, error: userError } = await supabase
                    .from('users')
                    .select('farm_id')
                    .eq('id', user.id)
                    .single();
                
                if (userError) throw userError;

                const { data, error } = await supabase
                    .from('farms')
                    .select('name')
                    .eq('id', userData.farm_id)
                    .single();
                
                if (error) throw error;
                return data?.name || user.user_metadata?.farm_name || 'Minha Fazenda';
            } catch (error) {
                console.error('Error fetching farm name:', error);
                return 'Minha Fazenda';
            }
        }

        // Function to get veterinarian name from Supabase
        async function getVetName() {
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) return { name: 'Veterinário', profile_photo_url: null };

                const { data, error } = await supabase
                    .from('users')
                    .select('name, profile_photo_url')
                    .eq('id', user.id)
                    .single();
                
                if (error) throw error;
                return {
                    name: data?.name || user.user_metadata?.name || 'Veterinário',
                    profile_photo_url: data?.profile_photo_url || null
                };
            } catch (error) {
                console.error('Error fetching vet name:', error);
                return { name: 'Veterinário', profile_photo_url: null };
            }
        }

        // Function to set farm name in header
        async function setFarmName() {
            const farmName = await getFarmName();
            document.getElementById('farmNameHeader').textContent = farmName;
        }

        // Function to extract formal name (second name)
        function extractFormalName(fullName) {
            if (!fullName || typeof fullName !== 'string') {
                return 'Veterinário';
            }
            
            // Remove extra spaces and split
            const names = fullName.trim().split(/\s+/);
            
            // If only one name, return it
            if (names.length === 1) {
                return names[0];
            }
            
            // If two names, return the second
            if (names.length === 2) {
                return names[1];
            }
            
            // For 3 or more names, try to find the most formal name
            // Skip common prefixes and find the second meaningful name
            const skipWords = ['da', 'de', 'do', 'das', 'dos', 'di', 'del', 'della', 'delle', 'delli'];
            
            let formalName = '';
            let nameCount = 0;
            
            for (let i = 0; i < names.length; i++) {
                const name = names[i].toLowerCase();
                
                // Skip common prefixes
                if (skipWords.includes(name)) {
                    continue;
                }
                
                // Count meaningful names
                nameCount++;
                
                // Get the second meaningful name
                if (nameCount === 2) {
                    formalName = names[i];
                    break;
                }
            }
            
            // If we didn't find a second meaningful name, use the second name overall
            if (!formalName && names.length >= 2) {
                formalName = names[1];
            }
            
            // If still no formal name, use the first name
            if (!formalName) {
                formalName = names[0];
            }
            
            // Capitalize first letter
            return formalName.charAt(0).toUpperCase() + formalName.slice(1).toLowerCase();
        }

        // Function to set veterinarian name in profile
        async function setVetName() {
            const vetData = await getVetName();
            const farmName = await getFarmName();
            
            // Extract formal name for welcome message
            const formalName = extractFormalName(vetData.name);
            
            document.getElementById('vetName').textContent = formalName;
            document.getElementById('vetWelcome').textContent = formalName;
            document.getElementById('profileName').textContent = vetData.name;
            document.getElementById('profileFullName').textContent = vetData.name;
            document.getElementById('profileFarmName').textContent = farmName;
            
            // Update profile photo display
            updateProfilePhotoDisplay(vetData.profile_photo_url);
        }

        // Function to update profile photo display
        function updateProfilePhotoDisplay(photoUrl) {
            try {
                // Add timestamp to prevent cache issues
                const photoUrlWithTimestamp = photoUrl ? photoUrl + '?t=' + Date.now() : null;
                
                // Update header profile photo
                const headerPhoto = document.getElementById('headerProfilePhoto');
                const headerIcon = document.getElementById('headerProfileIcon');
                
                if (headerPhoto && headerIcon) {
                    if (photoUrlWithTimestamp) {
                        headerPhoto.src = photoUrlWithTimestamp;
                        headerPhoto.classList.remove('hidden');
                        headerIcon.classList.add('hidden');
                    } else {
                        headerPhoto.classList.add('hidden');
                        headerIcon.classList.remove('hidden');
                    }
                }
                
                // Update modal profile photo
                const modalPhoto = document.getElementById('modalProfilePhoto');
                const modalIcon = document.getElementById('modalProfileIcon');
                
                if (modalPhoto && modalIcon) {
                    if (photoUrlWithTimestamp) {
                        modalPhoto.src = photoUrlWithTimestamp;
                        modalPhoto.classList.remove('hidden');
                        modalIcon.classList.add('hidden');
                    } else {
                        modalPhoto.classList.add('hidden');
                        modalIcon.classList.remove('hidden');
                    }
                }
            } catch (error) {
                console.error('Erro ao atualizar exibição da foto de perfil:', error);
            }
        }

        // Load dashboard data from Supabase
        async function loadDashboardData() {
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) return;

                // Load animal health statistics
                const { data: animalsData, error: animalsError } = await supabase
                    .from('animals')
                    .select('health_status');

                if (!animalsError && animalsData) {
                    const healthStats = animalsData.reduce((acc, animal) => {
                        acc[animal.health_status] = (acc[animal.health_status] || 0) + 1;
                        return acc;
                    }, {});

                    document.getElementById('healthyAnimals').textContent = healthStats.healthy || 0;
                    document.getElementById('warningAnimals').textContent = healthStats.warning || 0;
                    document.getElementById('criticalAnimals').textContent = healthStats.critical || 0;
                }

                // Load active treatments
                const { data: treatmentsData, error: treatmentsError } = await supabase
                    .from('treatments')
                    .select('id')
                    .eq('status', 'active');

                if (!treatmentsError && treatmentsData) {
                    document.getElementById('activeTreatments').textContent = treatmentsData.length;
                }

            } catch (error) {
                console.error('Error loading dashboard data:', error);
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            // Tab switching
            const navItems = document.querySelectorAll('.nav-item, .mobile-nav-item');
            const tabContents = document.querySelectorAll('.tab-content');

            navItems.forEach(item => {
                item.addEventListener('click', function() {
                    const targetTab = this.getAttribute('data-tab');
                    
                    // Remove active class from all nav items
                    navItems.forEach(nav => nav.classList.remove('active'));
                    
                    // Add active class to clicked item
                    this.classList.add('active');
                    
                    // Hide all tab contents
                    tabContents.forEach(content => content.classList.add('hidden'));
                    
                    // Show target tab content
                    document.getElementById(targetTab + '-tab').classList.remove('hidden');
                });
            });

            // Form submissions
            document.getElementById('quickHealthForm').addEventListener('submit', handleQuickHealth);
            document.getElementById('treatmentForm').addEventListener('submit', handleTreatmentRegister);
            document.getElementById('changePasswordForm').addEventListener('submit', handlePasswordChange);
        }

        // Handle quick health check form
        async function handleQuickHealth(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const animalId = formData.get('animal_id');
            const healthStatus = formData.get('health_status');

            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) throw new Error('User not authenticated');

                const { error } = await supabase
                    .from('animal_health_records')
                    .insert([{
                        animal_id: animalId,
                        health_status: healthStatus,
                        veterinarian_id: user.id,
                        recorded_at: new Date().toISOString()
                    }]);

                if (error) throw error;

                showNotification('Status de saúde registrado com sucesso!', 'success');
                e.target.reset();
                await loadDashboardData();

            } catch (error) {
                console.error('Error saving health status:', error);
                showNotification('Erro ao registrar status de saúde', 'error');
            }
        }

        // Handle treatment register form
        async function handleTreatmentRegister(e) {
            e.preventDefault();
            const formData = new FormData(e.target);

            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) throw new Error('User not authenticated');

                const treatmentData = {
                    animal_id: formData.get('animal_id'),
                    treatment_type: formData.get('treatment_type'),
                    medication: formData.get('medication') || null,
                    dosage: formData.get('dosage') || null,
                    start_date: formData.get('start_date'),
                    end_date: formData.get('end_date') || null,
                    notes: formData.get('notes') || null,
                    veterinarian_id: user.id,
                    status: 'active',
                    created_at: new Date().toISOString()
                };

                const { error } = await supabase
                    .from('treatments')
                    .insert([treatmentData]);

                if (error) throw error;

                showNotification('Tratamento registrado com sucesso!', 'success');
                e.target.reset();
                setCurrentDate();
                await loadDashboardData();

            } catch (error) {
                console.error('Error saving treatment:', error);
                showNotification('Erro ao registrar tratamento', 'error');
            }
        }

        // Handle password change
        async function handlePasswordChange(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const currentPassword = formData.get('current_password');
            const newPassword = formData.get('new_password');
            const confirmPassword = formData.get('confirm_password');

            if (newPassword !== confirmPassword) {
                showNotification('As senhas não coincidem', 'error');
                return;
            }

            try {
                const { error } = await supabase.auth.updateUser({
                    password: newPassword
                });

                if (error) throw error;

                showNotification('Senha alterada com sucesso!', 'success');
                e.target.reset();

            } catch (error) {
                console.error('Error changing password:', error);
                showNotification('Erro ao alterar senha', 'error');
            }
        }

        // Set current date in form
        function setCurrentDate() {
            const now = new Date();
            const dateInput = document.getElementById('startDate');
            
            if (dateInput) {
                dateInput.value = now.toISOString().split('T')[0];
            }
        }

        // Reset treatment form
        function resetTreatmentForm() {
            document.getElementById('treatmentForm').reset();
            setCurrentDate();
        }

        // Show notification
        function showNotification(message, type = 'success') {
            const toast = document.getElementById('notificationToast');
            const messageElement = document.getElementById('toastMessage');
            const iconElement = toast.querySelector('svg');
            
            messageElement.textContent = message;
            
            // Update icon and colors based on type
            if (type === 'error') {
                iconElement.classList.remove('text-green-400');
                iconElement.classList.add('text-red-400');
                iconElement.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path>';
            } else {
                iconElement.classList.remove('text-red-400');
                iconElement.classList.add('text-green-400');
                iconElement.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>';
            }
            
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 5000);
        }

        // Hide notification
        function hideNotification() {
            document.getElementById('notificationToast').classList.remove('show');
        }

        // Profile modal functions
        function openProfileModal() {
            document.getElementById('profileModal').classList.add('show');
        }

        function closeProfileModal() {
            document.getElementById('profileModal').classList.remove('show');
        }

        // Show specific tab
        function showTab(tabName) {
            const navItems = document.querySelectorAll('.nav-item, .mobile-nav-item');
            const tabContents = document.querySelectorAll('.tab-content');
            
            // Remove active class from all nav items
            navItems.forEach(nav => nav.classList.remove('active'));
            
            // Add active class to target nav item
            const targetNav = document.querySelector(`[data-tab="${tabName}"]`);
            if (targetNav) {
                targetNav.classList.add('active');
            }
            
            // Hide all tab contents
            tabContents.forEach(content => content.classList.add('hidden'));
            
            // Show target tab content
            document.getElementById(tabName + '-tab').classList.remove('hidden');
        }

        // FIXED MODAL FUNCTIONS - COMPACT AND RESPONSIVE
        function openAddAnimalModal() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg max-h-[85vh] flex flex-col">
                    <!-- Modal Header -->
                    <div class="bg-gradient-to-r from-forest-600 to-forest-700 px-6 py-4 text-white rounded-t-2xl flex-shrink-0">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <div class="w-8 h-8 bg-white bg-opacity-20 rounded-lg flex items-center justify-center">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                                    </svg>
                                </div>
                                <div>
                                    <h3 class="text-lg font-bold">Adicionar Animal</h3>
                                    <p class="text-forest-100 text-xs">Cadastre um novo animal</p>
                                </div>
                            </div>
                            <button onclick="closeAnimalModal()" class="w-8 h-8 bg-white bg-opacity-20 rounded-lg flex items-center justify-center hover:bg-opacity-30 transition-all">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                    </div>

                    <!-- Modal Body -->
                    <div class="p-6 overflow-y-auto flex-1">
                        <form id="animalForm" onsubmit="handleAddAnimal(event)" class="space-y-4">
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div class="sm:col-span-2">
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Nome do Animal *</label>
                                    <input type="text" name="name" required 
                                           class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-forest-500 focus:border-transparent transition-all text-sm" 
                                           placeholder="Ex: Mimosa, Estrela">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Raça *</label>
                                    <select name="breed" required 
                                            class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-forest-500 focus:border-transparent transition-all text-sm">
                                        <option value="">Selecione</option>
                                        <option value="Holstein">Holstein</option>
                                        <option value="Jersey">Jersey</option>
                                        <option value="Gir">Gir</option>
                                        <option value="Girolando">Girolando</option>
                                        <option value="Pardo Suíço">Pardo Suíço</option>
                                        <option value="Nelore">Nelore</option>
                                        <option value="Angus">Angus</option>
                                        <option value="Mestiça">Mestiça</option>
                                        <option value="Outra">Outra</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Sexo *</label>
                                    <select name="gender" required 
                                            class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-forest-500 focus:border-transparent transition-all text-sm">
                                        <option value="">Selecione</option>
                                        <option value="female">Fêmea</option>
                                        <option value="male">Macho</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Data de Nascimento *</label>
                                    <input type="date" name="birth_date" required 
                                           class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-forest-500 focus:border-transparent transition-all text-sm">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Status de Saúde *</label>
                                    <select name="health_status" required 
                                            class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-forest-500 focus:border-transparent transition-all text-sm">
                                        <option value="healthy">Saudável</option>
                                        <option value="warning">Atenção</option>
                                        <option value="critical">Crítico</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Peso (kg)</label>
                                    <input type="number" name="weight" step="0.1" min="0" 
                                           class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-forest-500 focus:border-transparent transition-all text-sm" 
                                           placeholder="450.5">
                                </div>
                                <div class="sm:col-span-2">
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Observações</label>
                                    <textarea name="notes" rows="3" 
                                              class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-forest-500 focus:border-transparent transition-all resize-none text-sm" 
                                              placeholder="Observações sobre o animal..."></textarea>
                                </div>
                            </div>
                        </form>
                    </div>

                    <!-- Modal Footer -->
                    <div class="bg-gray-50 px-6 py-4 flex gap-3 justify-end rounded-b-2xl flex-shrink-0">
                        <button type="button" onclick="closeAnimalModal()" 
                                class="px-4 py-2 border border-gray-300 text-gray-700 font-semibold rounded-lg hover:bg-gray-100 transition-all text-sm">
                            Cancelar
                        </button>
                        <button type="submit" form="animalForm" 
                                class="px-6 py-2 bg-gradient-to-r from-forest-600 to-forest-700 text-white font-semibold rounded-lg hover:shadow-lg transition-all text-sm">
                            Adicionar
                        </button>
                    </div>
                </div>
            `;
            
            modal.id = 'animalModal';
            document.body.appendChild(modal);
        }

        function closeAnimalModal() {
            const modal = document.getElementById('animalModal');
            if (modal) {
                modal.remove();
            }
        }

        async function handleAddAnimal(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            
            const animalData = {
                name: formData.get('name'),
                identification: formData.get('identification') || null, // Adicionado campo identification
                animal_type: formData.get('animal_type') || 'vaca', // Adicionado campo animal_type
                breed: formData.get('breed'),
                birth_date: formData.get('birth_date'),
                gender: formData.get('gender'),
                health_status: formData.get('health_status'),
                weight: formData.get('weight') ? parseFloat(formData.get('weight')) : null,
                notes: formData.get('notes') || null,
                is_active: true // Adicionado campo is_active
            };

            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) throw new Error('User not authenticated');

                // Get current user's farm_id
                const { data: userData, error: userError } = await supabase
                    .from('users')
                    .select('farm_id')
                    .eq('id', user.id)
                    .single();

                if (userError) throw userError;
                if (!userData?.farm_id) throw new Error('Farm not found');

                // Insert animal into database
                const { error: animalError } = await supabase
                    .from('animals')
                    .insert({
                        ...animalData,
                        farm_id: userData.farm_id,
                        created_at: new Date().toISOString()
                    });

                if (animalError) throw animalError;

                showNotification('Animal adicionado com sucesso!', 'success');
                closeAnimalModal();
                
                // Reload dashboard data
                await loadDashboardData();
                
            } catch (error) {
                console.error('Error adding animal:', error);
                showNotification('Erro ao adicionar animal: ' + error.message, 'error');
            }
        }

        function openAddTreatmentModal() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[85vh] flex flex-col">
                    <!-- Modal Header -->
                    <div class="bg-gradient-to-r from-blue-600 to-blue-700 px-6 py-4 text-white rounded-t-2xl flex-shrink-0">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <div class="w-8 h-8 bg-white bg-opacity-20 rounded-lg flex items-center justify-center">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path>
                                    </svg>
                                </div>
                                <div>
                                    <h3 class="text-lg font-bold">Novo Tratamento</h3>
                                    <p class="text-blue-100 text-xs">Registre um novo tratamento</p>
                                </div>
                            </div>
                            <button onclick="closeTreatmentModal()" class="w-8 h-8 bg-white bg-opacity-20 rounded-lg flex items-center justify-center hover:bg-opacity-30 transition-all">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                    </div>

                    <!-- Modal Body -->
                    <div class="p-6 overflow-y-auto flex-1">
                        <form id="treatmentModalForm" onsubmit="handleAddTreatment(event)" class="space-y-4">
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div class="sm:col-span-2">
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Animal *</label>
                                    <select name="animal_id" required id="animalSelect" 
                                            class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all text-sm">
                                        <option value="">Carregando animais...</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Tipo de Tratamento *</label>
                                    <select name="treatment_type" required 
                                            class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all text-sm">
                                        <option value="">Selecione</option>
                                        <option value="medication">Medicação</option>
                                        <option value="vaccination">Vacinação</option>
                                        <option value="surgery">Cirurgia</option>
                                        <option value="therapy">Terapia</option>
                                        <option value="preventive">Preventivo</option>
                                        <option value="emergency">Emergência</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Status *</label>
                                    <select name="status" required 
                                            class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all text-sm">
                                        <option value="active">Ativo</option>
                                        <option value="completed">Concluído</option>
                                        <option value="suspended">Suspenso</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Medicação/Procedimento *</label>
                                    <input type="text" name="medication" required 
                                           class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all text-sm" 
                                           placeholder="Ex: Antibiótico, Vacina V10">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Dosagem</label>
                                    <input type="text" name="dosage" 
                                           class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all text-sm" 
                                           placeholder="Ex: 10ml, 2 comprimidos">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Data de Início *</label>
                                    <input type="date" name="start_date" required 
                                           class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all text-sm">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Data de Fim</label>
                                    <input type="date" name="end_date" 
                                           class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all text-sm">
                                </div>
                                <div class="sm:col-span-2">
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Observações</label>
                                    <textarea name="notes" rows="3" 
                                              class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all resize-none text-sm" 
                                              placeholder="Observações sobre o tratamento..."></textarea>
                                </div>
                            </div>
                        </form>
                    </div>

                    <!-- Modal Footer -->
                    <div class="bg-gray-50 px-6 py-4 flex gap-3 justify-end rounded-b-2xl flex-shrink-0">
                        <button type="button" onclick="closeTreatmentModal()" 
                                class="px-4 py-2 border border-gray-300 text-gray-700 font-semibold rounded-lg hover:bg-gray-100 transition-all text-sm">
                            Cancelar
                        </button>
                        <button type="submit" form="treatmentModalForm" 
                                class="px-6 py-2 bg-gradient-to-r from-blue-600 to-blue-700 text-white font-semibold rounded-lg hover:shadow-lg transition-all text-sm">
                            Registrar
                        </button>
                    </div>
                </div>
            `;
            
            modal.id = 'treatmentModal';
            document.body.appendChild(modal);
            
            // Set default start date to today
            const today = new Date().toISOString().split('T')[0];
            modal.querySelector('input[name="start_date"]').value = today;
            
            // Load animals for selection
            loadAnimalsForTreatment();
        }

        function closeTreatmentModal() {
            const modal = document.getElementById('treatmentModal');
            if (modal) {
                modal.remove();
            }
        }

        async function loadAnimalsForTreatment() {
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) return;

                const { data: userData, error: userError } = await supabase
                    .from('users')
                    .select('farm_id')
                    .eq('id', user.id)
                    .single();

                if (userError) throw userError;

                const { data: animals, error } = await supabase
                    .from('animals')
                    .select('id, name, breed')
                    .eq('farm_id', userData.farm_id)
                    .order('name');

                if (error) throw error;

                const select = document.getElementById('animalSelect');
                if (select) {
                    select.innerHTML = '<option value="">Selecione um animal</option>';
                    animals.forEach(animal => {
                        const option = document.createElement('option');
                        option.value = animal.id;
                        option.textContent = `${animal.name} (${animal.breed})`;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading animals:', error);
                const select = document.getElementById('animalSelect');
                if (select) {
                    select.innerHTML = '<option value="">Erro ao carregar animais</option>';
                }
            }
        }

        async function handleAddTreatment(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            
            const treatmentData = {
                animal_id: formData.get('animal_id'),
                treatment_type: formData.get('treatment_type'),
                medication_name: formData.get('medication'), // Corrigido: medication -> medication_name
                dosage: formData.get('dosage') || null,
                treatment_start_date: formData.get('start_date'), // Corrigido: start_date -> treatment_start_date
                treatment_end_date: formData.get('end_date') || null, // Corrigido: end_date -> treatment_end_date
                status: formData.get('status'),
                notes: formData.get('notes') || null,
                // Campos adicionais do esquema
                administration_route: formData.get('administration_route') || null,
                withdrawal_period_days: formData.get('withdrawal_period_days') ? parseInt(formData.get('withdrawal_period_days')) : null,
                cost: formData.get('cost') ? parseFloat(formData.get('cost')) : null
            };

            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) throw new Error('User not authenticated');

                // Get current user's farm_id
                const { data: userData, error: userError } = await supabase
                    .from('users')
                    .select('farm_id')
                    .eq('id', user.id)
                    .single();

                if (userError) throw userError;
                if (!userData?.farm_id) throw new Error('Farm not found');

                // Insert treatment into database
                const { error: treatmentError } = await supabase
                    .from('treatments')
                    .insert({
                        ...treatmentData,
                        veterinarian_id: user.id,
                        farm_id: userData.farm_id, // Adicionado farm_id
                        created_at: new Date().toISOString()
                    });

                if (treatmentError) throw treatmentError;

                showNotification('Tratamento registrado com sucesso!', 'success');
                closeTreatmentModal();
                
                // Reload dashboard data
                await loadDashboardData();
                
            } catch (error) {
                console.error('Error adding treatment:', error);
                showNotification('Erro ao registrar tratamento: ' + error.message, 'error');
            }
        }

        // Report generation functions
        async function generateHealthReport() {
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) throw new Error('User not authenticated');

                // Buscar dados de saúde dos animais
                const { data: healthData, error } = await supabase
                    .from('animal_health_records')
                    .select(`
                        *,
                        animals(name, breed, birth_date)
                    `)
                    .eq('veterinarian_id', user.id)
                    .order('recorded_at', { ascending: false });

                if (error) throw error;

                // Gerar relatório em formato PDF
                await generateHealthPDF(healthData);
                
                showNotification('Relatório de Saúde gerado com sucesso!', 'success');
            } catch (error) {
                console.error('Error generating health report:', error);
                showNotification('Erro ao gerar relatório de saúde', 'error');
            }
        }

        async function generateTreatmentReport() {
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) throw new Error('User not authenticated');

                // Buscar dados de tratamentos
                const { data: treatmentData, error } = await supabase
                    .from('treatments')
                    .select(`
                        *,
                        animals(name, breed, birth_date)
                    `)
                    .eq('veterinarian_id', user.id)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                // Gerar relatório em formato PDF
                await generateTreatmentPDF(treatmentData);
                
                showNotification('Relatório de Tratamentos gerado com sucesso!', 'success');
            } catch (error) {
                console.error('Error generating treatment report:', error);
                showNotification('Erro ao gerar relatório de tratamentos', 'error');
            }
        }

        async function generateVaccinationReport() {
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) throw new Error('User not authenticated');

                // Buscar dados de vacinação (tratamentos do tipo vacinação)
                const { data: vaccinationData, error } = await supabase
                    .from('treatments')
                    .select(`
                        *,
                        animals(name, breed, birth_date)
                    `)
                    .eq('veterinarian_id', user.id)
                    .eq('treatment_type', 'vaccination')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                // Gerar relatório em formato PDF
                await generateVaccinationPDF(vaccinationData);
                
                showNotification('Relatório de Vacinação gerado com sucesso!', 'success');
            } catch (error) {
                console.error('Error generating vaccination report:', error);
                showNotification('Erro ao gerar relatório de vacinação', 'error');
            }
        }

        // Helper functions for PDF generation
        async function generateHealthPDF(data) {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                // Configurações
                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();
                const margin = 20;
                let yPosition = margin;

                // Título
                doc.setFontSize(18);
                doc.setFont('helvetica', 'bold');
                const titleText = window.reportSettings?.farmName
                    ? `RELATÓRIO DE SAÚDE ANIMAL - ${window.reportSettings.farmName}`
                    : 'RELATÓRIO DE SAÚDE ANIMAL';
                doc.text(titleText, margin, yPosition);
                yPosition += 20;

                // Data do relatório
                doc.setFontSize(12);
                doc.setFont('helvetica', 'normal');
                const today = new Date().toLocaleDateString('pt-BR');
                doc.text(`Relatório gerado em: ${today}`, margin, yPosition);
                yPosition += 20;

                // Cabeçalho da tabela
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                const headers = ['Data', 'Animal', 'Raça', 'Status', 'Observações'];
                const colWidths = [25, 35, 30, 25, 75];
                let xPosition = margin;

                headers.forEach((header, index) => {
                    doc.text(header, xPosition, yPosition);
                    xPosition += colWidths[index];
                });
                yPosition += 8;

                // Linha separadora
                doc.line(margin, yPosition, pageWidth - margin, yPosition);
                yPosition += 5;

                // Dados da tabela
                doc.setFont('helvetica', 'normal');
                data.forEach((record) => {
                    if (yPosition > pageHeight - 30) {
                        doc.addPage();
                        yPosition = margin;
                    }

                    xPosition = margin;
                    const rowData = [
                        new Date(record.recorded_at).toLocaleDateString('pt-BR'),
                        record.animals?.name || 'N/A',
                        record.animals?.breed || 'N/A',
                        record.health_status || 'N/A',
                        record.notes || 'N/A'
                    ];

                    rowData.forEach((cell, cellIndex) => {
                        const cellText = String(cell).substring(0, 20); // Limitar texto
                        doc.text(cellText, xPosition, yPosition);
                        xPosition += colWidths[cellIndex];
                    });
                    yPosition += 6;
                });

                // Download do PDF
                doc.save(`relatorio_saude_animais_${new Date().toISOString().split('T')[0]}.pdf`);
            } catch (error) {
                console.error('Erro ao gerar PDF de saúde:', error);
                throw error;
            }
        }

        async function generateTreatmentPDF(data) {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                // Configurações
                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();
                const margin = 20;
                let yPosition = margin;

                // Título
                doc.setFontSize(18);
                doc.setFont('helvetica', 'bold');
                const titleText = window.reportSettings?.farmName
                    ? `RELATÓRIO DE TRATAMENTOS - ${window.reportSettings.farmName}`
                    : 'RELATÓRIO DE TRATAMENTOS';
                doc.text(titleText, margin, yPosition);
                yPosition += 20;

                // Data do relatório
                doc.setFontSize(12);
                doc.setFont('helvetica', 'normal');
                const today = new Date().toLocaleDateString('pt-BR');
                doc.text(`Relatório gerado em: ${today}`, margin, yPosition);
                yPosition += 20;

                // Cabeçalho da tabela
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                const headers = ['Início', 'Animal', 'Tipo', 'Medicação', 'Status'];
                const colWidths = [25, 35, 35, 35, 25];
                let xPosition = margin;

                headers.forEach((header, index) => {
                    doc.text(header, xPosition, yPosition);
                    xPosition += colWidths[index];
                });
                yPosition += 8;

                // Linha separadora
                doc.line(margin, yPosition, pageWidth - margin, yPosition);
                yPosition += 5;

                // Dados da tabela
                doc.setFont('helvetica', 'normal');
                data.forEach((treatment) => {
                    if (yPosition > pageHeight - 30) {
                        doc.addPage();
                        yPosition = margin;
                    }

                    xPosition = margin;
                    const rowData = [
                        new Date(treatment.start_date).toLocaleDateString('pt-BR'),
                        treatment.animals?.name || 'N/A',
                        treatment.treatment_type || 'N/A',
                        treatment.medication || 'N/A',
                        treatment.status || 'N/A'
                    ];

                    rowData.forEach((cell, cellIndex) => {
                        const cellText = String(cell).substring(0, 15); // Limitar texto
                        doc.text(cellText, xPosition, yPosition);
                        xPosition += colWidths[cellIndex];
                    });
                    yPosition += 6;
                });

                // Download do PDF
                doc.save(`relatorio_tratamentos_${new Date().toISOString().split('T')[0]}.pdf`);
            } catch (error) {
                console.error('Erro ao gerar PDF de tratamentos:', error);
                throw error;
            }
        }

        async function generateVaccinationPDF(data) {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                // Configurações
                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();
                const margin = 20;
                let yPosition = margin;

                // Título
                doc.setFontSize(18);
                doc.setFont('helvetica', 'bold');
                const titleText = window.reportSettings?.farmName
                    ? `RELATÓRIO DE VACINAÇÃO - ${window.reportSettings.farmName}`
                    : 'RELATÓRIO DE VACINAÇÃO';
                doc.text(titleText, margin, yPosition);
                yPosition += 20;

                // Data do relatório
                doc.setFontSize(12);
                doc.setFont('helvetica', 'normal');
                const today = new Date().toLocaleDateString('pt-BR');
                doc.text(`Relatório gerado em: ${today}`, margin, yPosition);
                yPosition += 20;

                // Cabeçalho da tabela
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                const headers = ['Data', 'Animal', 'Raça', 'Vacina', 'Status'];
                const colWidths = [25, 35, 30, 40, 25];
                let xPosition = margin;

                headers.forEach((header, index) => {
                    doc.text(header, xPosition, yPosition);
                    xPosition += colWidths[index];
                });
                yPosition += 8;

                // Linha separadora
                doc.line(margin, yPosition, pageWidth - margin, yPosition);
                yPosition += 5;

                // Dados da tabela
                doc.setFont('helvetica', 'normal');
                data.forEach((vaccination) => {
                    if (yPosition > pageHeight - 30) {
                        doc.addPage();
                        yPosition = margin;
                    }

                    xPosition = margin;
                    const rowData = [
                        new Date(vaccination.start_date).toLocaleDateString('pt-BR'),
                        vaccination.animals?.name || 'N/A',
                        vaccination.animals?.breed || 'N/A',
                        vaccination.medication || 'N/A',
                        vaccination.status || 'N/A'
                    ];

                    rowData.forEach((cell, cellIndex) => {
                        const cellText = String(cell).substring(0, 18); // Limitar texto
                        doc.text(cellText, xPosition, yPosition);
                        xPosition += colWidths[cellIndex];
                    });
                    yPosition += 6;
                });

                // Download do PDF
                doc.save(`relatorio_vacinacao_${new Date().toISOString().split('T')[0]}.pdf`);
            } catch (error) {
                console.error('Erro ao gerar PDF de vacinação:', error);
                throw error;
            }
        }



        // Sign out function
        async function signOut() {
            if (confirm('Tem certeza que deseja sair?')) {
                await supabase.auth.signOut();
                window.location.href = 'index.html';
            }
        }

        // FUNÇÕES PARA GERENCIAR CONTA SECUNDÁRIA (VERSÃO SIMPLES)

        // Função simples para verificar se o usuário atual é uma conta secundária
        async function checkIfSecondaryAccount() {
            try {
                const { data: { user }, error: authError } = await supabase.auth.getUser();
                if (authError || !user) {
                    return false;
                }
                
                // Verificar se o email tem sufixo de conta secundária
                const email = user.email.toLowerCase();
                const secondarySuffixes = ['.func', '.vet', '.sec', '.secundaria'];
                
                for (const suffix of secondarySuffixes) {
                    if (email.includes(suffix)) {
                        return true;
                    }
                }
                
                // Verificar se o email contém palavras-chave de conta secundária
                const secondaryKeywords = ['funcionario', 'veterinario', 'secundaria', 'auxiliar'];
                for (const keyword of secondaryKeywords) {
                    if (email.includes(keyword)) {
                        return true;
                    }
                }
                
                return false;
                
            } catch (error) {
                return false;
            }
        }

        // Função para gerenciar a visibilidade das seções do perfil
        async function manageProfileSections() {
            try {
                const isSecondary = await checkIfSecondaryAccount();
                
                // Elementos para contas principais
                const professionalInfoSection = document.getElementById('professionalInfoSection');
                const changePasswordSection = document.getElementById('changePasswordSection');
                const dangerZoneSection = document.getElementById('dangerZoneSection');
                
                // Elementos para contas secundárias
                const primaryAccountSection = document.getElementById('primaryAccountSection');
                
                if (isSecondary) {
                    // Se é conta secundária, ocultar seções principais e mostrar seção de retorno
                    if (professionalInfoSection) professionalInfoSection.style.display = 'none';
                    if (changePasswordSection) changePasswordSection.style.display = 'none';
                    if (dangerZoneSection) dangerZoneSection.style.display = 'none';
                    if (primaryAccountSection) primaryAccountSection.style.display = 'block';
                } else {
                    // Se é conta principal, mostrar seções principais e ocultar seção de retorno
                    if (professionalInfoSection) professionalInfoSection.style.display = 'block';
                    if (changePasswordSection) changePasswordSection.style.display = 'block';
                    if (dangerZoneSection) dangerZoneSection.style.display = 'block';
                    if (primaryAccountSection) primaryAccountSection.style.display = 'none';
                }
                
            } catch (error) {
                // Silenciar erro
            }
        }

        // Função simples para retornar para a conta principal
        async function switchToPrimaryAccount() {
            try {
                const { data: { user }, error: authError } = await supabase.auth.getUser();
                if (authError || !user) {
                    alert('Usuário não autenticado');
                    return;
                }
                
                // Buscar a conta principal baseada no email
                const email = user.email.toLowerCase();
                let primaryEmail = email;
                
                // Remover sufixos de conta secundária
                const secondarySuffixes = ['.func', '.vet', '.sec', '.secundaria'];
                for (const suffix of secondarySuffixes) {
                    if (primaryEmail.includes(suffix)) {
                        primaryEmail = primaryEmail.replace(suffix, '');
                        break;
                    }
                }
                
                // Buscar dados da conta principal
                const { data: primaryAccount, error: primaryError } = await supabase
                    .from('users')
                    .select('*')
                    .eq('email', primaryEmail)
                    .single();
                
                if (primaryError || !primaryAccount) {
                    alert('Erro ao carregar dados da conta principal. Verifique se a conta principal existe.');
                    return;
                }
                
                // Armazenar dados da conta secundária atual
                const currentSession = {
                    id: user.id,
                    email: user.email,
                    name: user.name,
                    user_type: user.user_metadata?.role || 'veterinario',
                    farm_id: user.user_metadata?.farm_id || '',
                    farm_name: sessionStorage.getItem('farm_name') || ''
                };
                
                // Armazenar dados da conta principal
                const primarySession = {
                    id: primaryAccount.id,
                    email: primaryAccount.email,
                    name: primaryAccount.name,
                    user_type: primaryAccount.role,
                    farm_id: primaryAccount.farm_id,
                    farm_name: sessionStorage.getItem('farm_name') || ''
                };
                
                // Salvar sessão atual para retorno posterior
                sessionStorage.setItem('secondary_account', JSON.stringify(currentSession));
                
                // Definir nova sessão como conta principal
                sessionStorage.setItem('user', JSON.stringify(primarySession));
                
                // Redirecionar para a página do gerente
                window.location.href = 'gerente.html';
                
            } catch (error) {
                alert('Ocorreu um erro ao retornar para a conta principal.');
            }
        }

        // Modificar a função initializePage para incluir verificação de conta secundária
        async function initializePageWithSecondaryCheck() {
            try {
                // Executar inicialização normal
                await initializePage();
                
                // Gerenciar seções do perfil baseado no tipo de conta
                await manageProfileSections();
                
            } catch (error) {
                // Silenciar erro
            }
        }

        // Substituir a função initializePage original
        if (typeof window !== 'undefined') {
            window.initializePage = initializePageWithSecondaryCheck;
        }

        // REMOÇÃO COMPLETA DE TODOS OS CONSOLE.LOGS PARA PROTEGER O BANCO
        // Substituir console.log por função vazia para evitar sobrecarga
        const originalConsoleLog = console.log;
        const originalConsoleError = console.error;

        console.log = function() {
            // Não fazer nada - silenciar completamente
        };

        console.error = function() {
            // Não fazer nada - silenciar completamente
        };

        // Função para restaurar console.log se necessário (para debug)
        window.restoreConsoleLogs = function() {
            console.log = originalConsoleLog;
            console.error = originalConsoleError;
        };

        // Função para verificar se há muitas requisições
        window.checkDatabaseRequests = function() {
            // Monitorar requisições ao banco
            const originalFetch = window.fetch;
            let requestCount = 0;
            
            window.fetch = function(...args) {
                requestCount++;
                if (requestCount > 100) {
                    console.warn('⚠️ Muitas requisições detectadas:', requestCount);
                }
                return originalFetch.apply(this, args);
            };
            
            // Reset contador a cada 5 segundos
            setInterval(() => {
                requestCount = 0;
            }, 5000);
        };

        // Ativar proteção contra muitas requisições
        checkDatabaseRequests();

        // ===== FUNÇÕES DE INSEMINAÇÃO ARTIFICIAL =====
        
        // Calcular data prevista de parto (280 dias após inseminação)
        function calculateExpectedBirthDate(inseminationDate) {
            if (!inseminationDate) return '';
            const date = new Date(inseminationDate);
            date.setDate(date.getDate() + 280); // Gestação bovina média: 280 dias
            return date.toISOString().split('T')[0];
        }

        // Atualizar data prevista automaticamente
        document.getElementById('inseminationDate')?.addEventListener('change', function() {
            const expectedDate = calculateExpectedBirthDate(this.value);
            document.getElementById('expectedBirthDate').value = expectedDate;
        });

        // Registrar nova inseminação
        async function registerInsemination(formData) {
            try {
                const { data, error } = await supabase.rpc('register_artificial_insemination', {
                    p_animal_id: formData.animal_id,
                    p_insemination_date: formData.insemination_date,
                    p_semen_batch: formData.semen_batch,
                    p_bull_id: formData.bull_id || null,
                    p_technician: formData.technician || null,
                    p_heat_detection_method: formData.heat_detection_method || null,
                    p_body_condition_score: formData.body_condition_score ? parseInt(formData.body_condition_score) : null,
                    p_expected_birth_date: formData.expected_birth_date || null,
                    p_observations: formData.observations || null
                });

                if (error) throw error;
                
                showNotification('Inseminação registrada com sucesso!', 'success');
                document.getElementById('inseminationForm').reset();
                await loadInseminationsList();
                await loadInseminationStats();
                await loadPendingInseminations();
                
                return data;
            } catch (error) {
                console.error('Erro ao registrar inseminação:', error);
                showNotification('Erro ao registrar inseminação: ' + error.message, 'error');
                throw error;
            }
        }

        // Confirmar gravidez
        async function confirmPregnancy(inseminationId, isConfirmed, confirmationMethod, confirmationDate) {
            try {
                const { data, error } = await supabase.rpc('confirm_pregnancy', {
                    p_insemination_id: inseminationId,
                    p_pregnancy_confirmed: isConfirmed,
                    p_confirmation_method: confirmationMethod,
                    p_confirmation_date: confirmationDate
                });

                if (error) throw error;
                
                showNotification('Status de gravidez atualizado com sucesso!', 'success');
                document.getElementById('pregnancyConfirmationForm').reset();
                await loadInseminationsList();
                await loadInseminationStats();
                await loadPendingInseminations();
                
                return data;
            } catch (error) {
                console.error('Erro ao confirmar gravidez:', error);
                showNotification('Erro ao confirmar gravidez: ' + error.message, 'error');
                throw error;
            }
        }

        // Carregar lista de inseminações
        async function loadInseminationsList() {
            try {
                const { data: inseminations, error } = await supabase
                    .from('artificial_inseminations')
                    .select(`
                        *,
                        animals(animal_id, breed)
                    `)
                    .order('insemination_date', { ascending: false });

                if (error) throw error;

                const container = document.getElementById('inseminationsList');
                if (!container) return;

                if (!inseminations || inseminations.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-12">
                            <div class="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-6">
                                <svg class="w-10 h-10 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                </svg>
                            </div>
                            <h3 class="text-lg font-semibold text-gray-900 mb-2">Nenhuma Inseminação Registrada</h3>
                            <p class="text-gray-600 mb-4">Registre inseminações para controlar o programa reprodutivo</p>
                            <p class="text-gray-500 text-sm">Use o formulário acima para adicionar uma nova inseminação</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = inseminations.map(insemination => {
                    const date = new Date(insemination.insemination_date).toLocaleDateString('pt-BR');
                    const expectedBirth = insemination.expected_birth_date ? 
                        new Date(insemination.expected_birth_date).toLocaleDateString('pt-BR') : 'N/A';
                    
                    const statusBadge = insemination.pregnancy_confirmed === true ? 
                        '<span class="px-2 py-1 bg-green-100 text-green-800 text-xs font-medium rounded-full">Confirmada</span>' :
                        insemination.pregnancy_confirmed === false ?
                        '<span class="px-2 py-1 bg-red-100 text-red-800 text-xs font-medium rounded-full">Não Confirmada</span>' :
                        '<span class="px-2 py-1 bg-yellow-100 text-yellow-800 text-xs font-medium rounded-full">Pendente</span>';

                    return `
                        <div class="border border-slate-200 rounded-xl p-4 hover:shadow-md transition-all">
                            <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
                                <div class="flex-1">
                                    <div class="flex items-center gap-3 mb-2">
                                        <h4 class="font-semibold text-slate-900">Animal: ${insemination.animal_id}</h4>
                                        ${statusBadge}
                                    </div>
                                    <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-sm text-slate-600">
                                        <div><strong>Data IA:</strong> ${date}</div>
                                        <div><strong>Lote:</strong> ${insemination.semen_batch}</div>
                                        <div><strong>Touro:</strong> ${insemination.bull_id || 'N/A'}</div>
                                        <div><strong>Parto Prev.:</strong> ${expectedBirth}</div>
                                    </div>
                                    ${insemination.technician ? `<div class="text-sm text-slate-600 mt-1"><strong>Técnico:</strong> ${insemination.technician}</div>` : ''}
                                    ${insemination.observations ? `<div class="text-sm text-slate-600 mt-1"><strong>Obs:</strong> ${insemination.observations}</div>` : ''}
                                </div>
                                <div class="flex gap-2">
                                    ${insemination.pregnancy_confirmed === null ? `
                                        <button onclick="quickConfirmPregnancy('${insemination.id}', true)" class="px-3 py-1 bg-green-600 text-white text-xs rounded-lg hover:bg-green-700 transition-all">
                                            Confirmar
                                        </button>
                                        <button onclick="quickConfirmPregnancy('${insemination.id}', false)" class="px-3 py-1 bg-red-600 text-white text-xs rounded-lg hover:bg-red-700 transition-all">
                                            Negar
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

            } catch (error) {
                console.error('Erro ao carregar inseminações:', error);
                showNotification('Erro ao carregar lista de inseminações', 'error');
            }
        }

        // Carregar estatísticas de inseminação
        async function loadInseminationStats() {
            try {
                const { data: inseminations, error } = await supabase
                    .from('artificial_inseminations')
                    .select('pregnancy_confirmed');

                if (error) throw error;

                const total = inseminations?.length || 0;
                const confirmed = inseminations?.filter(i => i.pregnancy_confirmed === true).length || 0;
                const pending = inseminations?.filter(i => i.pregnancy_confirmed === null).length || 0;
                const successRate = total > 0 ? Math.round((confirmed / total) * 100) : 0;

                document.getElementById('totalInseminations').textContent = total;
                document.getElementById('confirmedPregnancies').textContent = confirmed;
                document.getElementById('pendingConfirmations').textContent = pending;
                document.getElementById('successRate').textContent = successRate + '%';

            } catch (error) {
                console.error('Erro ao carregar estatísticas:', error);
            }
        }

        // Carregar inseminações pendentes para o select
        async function loadPendingInseminations() {
            try {
                const { data: inseminations, error } = await supabase
                    .from('artificial_inseminations')
                    .select('id, animal_id, insemination_date, semen_batch')
                    .is('pregnancy_confirmed', null)
                    .order('insemination_date', { ascending: false });

                if (error) throw error;

                const select = document.getElementById('inseminationSelect');
                if (!select) return;

                select.innerHTML = '<option value="">Selecione uma inseminação...</option>';
                
                if (inseminations && inseminations.length > 0) {
                    inseminations.forEach(insemination => {
                        const date = new Date(insemination.insemination_date).toLocaleDateString('pt-BR');
                        const option = document.createElement('option');
                        option.value = insemination.id;
                        option.textContent = `${insemination.animal_id} - ${date} - Lote: ${insemination.semen_batch}`;
                        select.appendChild(option);
                    });
                }

            } catch (error) {
                console.error('Erro ao carregar inseminações pendentes:', error);
            }
        }

        // Confirmação rápida de gravidez
        async function quickConfirmPregnancy(inseminationId, isConfirmed) {
            const today = new Date().toISOString().split('T')[0];
            await confirmPregnancy(inseminationId, isConfirmed, 'visual', today);
        }

        // Resetar formulário de inseminação
        function resetInseminationForm() {
            document.getElementById('inseminationForm').reset();
            document.getElementById('expectedBirthDate').value = '';
        }

        // Atualizar lista de inseminações
        function refreshInseminationsList() {
            loadInseminationsList();
            loadInseminationStats();
            loadPendingInseminations();
        }

        // Event listeners para formulários de inseminação
        document.getElementById('inseminationForm')?.addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const data = Object.fromEntries(formData.entries());
            await registerInsemination(data);
        });

        document.getElementById('pregnancyConfirmationForm')?.addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const data = Object.fromEntries(formData.entries());
            
            await confirmPregnancy(
                data.insemination_id,
                data.pregnancy_confirmed === 'true',
                data.confirmation_method,
                data.confirmation_date
            );
        });

        // Carregar dados de inseminação quando a aba for ativada
        document.addEventListener('DOMContentLoaded', function() {
            // Adicionar listener para quando a aba de inseminação for ativada
            const inseminationTab = document.querySelector('[data-tab="insemination"]');
            if (inseminationTab) {
                inseminationTab.addEventListener('click', function() {
                    setTimeout(() => {
                        loadInseminationsList();
                        loadInseminationStats();
                        loadPendingInseminations();
                    }, 100);
                });
            }
        });

        console.log('✅ BANCO PROTEGIDO - CONSOLE.LOGS REMOVIDOS');
        
        // Função para retornar à conta do gerente
        function returnToManagerAccount() {
            const confirmed = confirm('Deseja retornar à sua conta de gerente?\n\nVocê será redirecionado para o painel do gerente.');
            
            if (confirmed) {
                // Limpar dados da conta secundária
                sessionStorage.removeItem('currentSecondaryAccount');
                
                // Redirecionar para o painel do gerente
                window.location.href = 'gerente.html';
            }
        }
        
        // Verificar se é conta secundária e mostrar botão de retorno
        function checkSecondaryAccount() {
            const secondaryAccount = sessionStorage.getItem('currentSecondaryAccount');
            const returnBtn = document.getElementById('returnToManagerBtn');
            
            if (secondaryAccount && returnBtn) {
                try {
                    const accountData = JSON.parse(secondaryAccount);
                    if (accountData.isSecondary) {
                        returnBtn.classList.remove('hidden');
                        console.log('✅ Conta secundária detectada - botão de retorno ativado');
                    }
                } catch (error) {
                    console.error('Erro ao verificar conta secundária:', error);
                }
            }
        }
        
        // Executar verificação quando a página carregar
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(checkSecondaryAccount, 1000);
        });
        
                    // App Version Display
        document.addEventListener('DOMContentLoaded', function() {
            // Adiciona versão do app no perfil do usuário
            const appVersion = '1.0.0';
            
            // Função para adicionar versão em elementos de perfil
            function addVersionToProfile() {
                const profileElements = document.querySelectorAll('.user-profile, .profile-info, .user-info');
                profileElements.forEach(element => {
                    if (!element.querySelector('.app-version')) {
                        const versionDiv = document.createElement('div');
                        versionDiv.className = 'app-version text-xs text-gray-500 mt-2';
                        versionDiv.innerHTML = `App v${appVersion}`;
                        element.appendChild(versionDiv);
                    }
                });
                
                // Adicionar no footer se existir
                const footer = document.querySelector('footer, .footer');
                if (footer && !footer.querySelector('.app-version')) {
                    const versionDiv = document.createElement('div');
                    versionDiv.className = 'app-version text-xs text-gray-500 text-center mt-4';
                    versionDiv.innerHTML = `LacTech v${appVersion}`;
                    footer.appendChild(versionDiv);
                }
            }
            
            // Função para adicionar versão no modal de perfil
            function addVersionToProfileModal() {
                const profileModal = document.getElementById('profileModal');
                if (profileModal && !profileModal.querySelector('.app-version')) {
                    const versionDiv = document.createElement('div');
                    versionDiv.className = 'app-version text-xs text-gray-500 text-center mt-4 p-4 border-t border-gray-200';
                    versionDiv.innerHTML = `LacTech v${appVersion}`;
                    profileModal.querySelector('.modal-content').appendChild(versionDiv);
                }
            }
            
            // Executar após carregamento
            setTimeout(addVersionToProfile, 1000);
            
            // Adicionar versão quando o modal de perfil for aberto
            const originalOpenProfileModal = window.openProfileModal;
            window.openProfileModal = function() {
                if (originalOpenProfileModal) {
                    originalOpenProfileModal();
                }
                setTimeout(addVersionToProfileModal, 100);
            };
        });
    </script>
</body>
</html>

