<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Limpar farm_id - Lagoa Do Mato</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: #2a2a2a;
            padding: 30px;
            border-radius: 10px;
        }
        h1 {
            color: #4CAF50;
        }
        .result {
            background: #333;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid #f44336;
            font-family: monospace;
            overflow-x: auto;
            font-size: 12px;
        }
        .line-number {
            color: #888;
            margin-right: 10px;
        }
        .match {
            background: #f44336;
            color: #fff;
            padding: 2px 5px;
            border-radius: 3px;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 16px;
            cursor: pointer;
            border-radius: 5px;
            margin: 10px 5px;
        }
        button:hover {
            background: #45a049;
        }
        .count {
            font-size: 24px;
            color: #f44336;
            font-weight: bold;
            margin: 20px 0;
        }
        #results {
            max-height: 600px;
            overflow-y: auto;
        }
        .instructions {
            background: #1565C0;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .warning {
            background: #FF9800;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            color: #000;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Limpar Refer√™ncias Din√¢micas ao farm_id</h1>
        
        <div class="instructions">
            <h3>üìã Como usar:</h3>
            <ol>
                <li><strong>Abra o arquivo gerente.php</strong> no Cursor/VS Code</li>
                <li><strong>Selecione TUDO</strong> (Ctrl+A ou Cmd+A)</li>
                <li><strong>Copie</strong> (Ctrl+C ou Cmd+C)</li>
                <li><strong>Cole aqui</strong> na √°rea de texto abaixo</li>
                <li>Clique em <strong>"üîç Buscar farm_id"</strong></li>
                <li>Veja todas as refer√™ncias din√¢micas encontradas</li>
                <li>Clique em <strong>"‚úÖ Substituir Tudo"</strong></li>
                <li>Clique em <strong>"üìã Copiar Resultado"</strong></li>
                <li>Cole de volta no gerente.php</li>
            </ol>
        </div>

        <div class="warning">
            <h3>‚ö†Ô∏è O QUE SER√Å SUBSTITU√çDO:</h3>
            <ul>
                <li><code>userData.farm_id</code> ‚Üí <code>1</code></li>
                <li><code>user.farm_id</code> ‚Üí <code>1</code></li>
                <li><code>managerData.farm_id</code> ‚Üí <code>1</code></li>
                <li><code>if (!userData?.farm_id)</code> ‚Üí <code>if (!userData)</code></li>
                <li><code>loadRecentActivities(userData.farm_id)</code> ‚Üí <code>loadRecentActivities()</code></li>
                <li>E mais ~30 padr√µes diferentes!</li>
            </ul>
            <p><strong>N√ÉO SER√Å ALTERADO:</strong> <code>farm_id: 1</code>, <code>WHERE farm_id = 1</code>, coment√°rios</p>
        </div>

        <textarea id="fileContent" style="width: 100%; height: 300px; background: #333; color: #0f0; padding: 10px; border: 2px solid #555; border-radius: 5px; font-family: 'Courier New', monospace; font-size: 12px; line-height: 1.5;" placeholder="Cole TODO o conte√∫do do arquivo gerente.php aqui..."></textarea>
        
        <div style="margin: 20px 0;">
            <button onclick="buscarFarmId()" style="background: #2196F3;">üîç Buscar farm_id Din√¢mico</button>
            <button onclick="substituirTudo()" style="background: #4CAF50;">‚úÖ Substituir Tudo (Fixar = 1)</button>
            <button onclick="copiarResultado()" style="background: #FF9800;">üìã Copiar Resultado</button>
            <button onclick="limparTexto()" style="background: #f44336;">üóëÔ∏è Limpar</button>
        </div>
        
        <div class="count" id="count"></div>
        <div id="results"></div>
        <div id="output"></div>
    </div>

    <script>
        let linhasComFarmId = [];

        function buscarFarmId() {
            const content = document.getElementById('fileContent').value;
            
            if (!content) {
                alert('‚ö†Ô∏è Cole o conte√∫do do gerente.php primeiro!');
                return;
            }
            
            const lines = content.split('\n');
            const resultsDiv = document.getElementById('results');
            const countDiv = document.getElementById('count');
            
            linhasComFarmId = [];
            resultsDiv.innerHTML = '';
            
            let totalMatches = 0;
            
            lines.forEach((line, index) => {
                // Buscar QUALQUER padr√£o de farm_id (exceto coment√°rios)
                if (line.trim().startsWith('//')) return; // Ignorar linhas de coment√°rio
                
                const patterns = [
                    /\w+\.farm_id/g,  // qualquerCoisa.farm_id
                    /farm_id\s*:\s*\w+/g, // farm_id: variavel
                    /\(.*?farm_id.*?\)/g, // (parametro com farm_id)
                    /farm_id\s*[=!<>]=\s*\w+/g, // compara√ß√µes
                ];
                
                let hasMatch = false;
                let highlighted = line;
                
                patterns.forEach(regex => {
                    const matches = line.match(regex);
                    if (matches) {
                        totalMatches += matches.length;
                        hasMatch = true;
                        highlighted = highlighted.replace(regex, '<span class="match">$&</span>');
                    }
                });
                
                if (hasMatch) {
                    linhasComFarmId.push(index + 1);
                    resultsDiv.innerHTML += `
                        <div class="result">
                            <span class="line-number">Linha ${index + 1}:</span>
                            <code>${highlighted}</code>
                        </div>
                    `;
                }
            });
            
            countDiv.innerHTML = `üî¥ Encontradas <strong>${totalMatches}</strong> refer√™ncias ao farm_id em <strong>${linhasComFarmId.length}</strong> linhas`;
            
            if (totalMatches === 0) {
                countDiv.innerHTML = '‚úÖ Nenhuma refer√™ncia ao farm_id encontrada!';
                countDiv.style.color = '#4CAF50';
            }
        }

        function substituirTudo() {
            let content = document.getElementById('fileContent').value;
            
            if (!content) {
                alert('‚ö†Ô∏è Cole o conte√∫do do gerente.php primeiro!');
                return;
            }
            
            let totalReplacements = 0;
            
            // TODOS os padr√µes poss√≠veis de farm_id
            const allPatterns = [
                'userData', 'user', 'managerData', 'currentUser', 'parsedUserData',
                'volumeUserData', 'qualityUserData', 'usersUserData', 'usersData',
                'userProfile', 'secondaryAccount', 'updatedUser', 'userToDelete',
                'farmData', 'qualityData', 'volumeData', 'existingUser', 'newUser',
                'adminData', 'employeeData', 'ownerData', 'profileData'
            ];
            
            // 1. Substituir TODOS os .farm_id din√¢micos
            allPatterns.forEach(varName => {
                const regex = new RegExp(`\\b${varName}\\.farm_id\\b`, 'g');
                const matches = content.match(regex);
                if (matches) {
                    totalReplacements += matches.length;
                    console.log(`‚úÖ ${matches.length}x: ${varName}.farm_id ‚Üí 1`);
                }
                content = content.replace(regex, '1');
            });
            
            // 2. Atribui√ß√µes: farm_id: variavel.farm_id
            const atribRegex = /farm_id:\s*\w+\.farm_id/g;
            const atribMatches = content.match(atribRegex);
            if (atribMatches) {
                totalReplacements += atribMatches.length;
                console.log(`‚úÖ ${atribMatches.length}x: farm_id: var.farm_id`);
            }
            content = content.replace(atribRegex, 'farm_id: 1 // Lagoa Do Mato');
            
            // 3. Valida√ß√µes: if (!userData?.farm_id)
            const validacoes = [
                [/if\s*\(\s*!(\w+)\?\.farm_id\s*\)/g, 'if (!$1)'],
                [/if\s*\(\s*(\w+)\?\.farm_id\s*\)/g, 'if ($1)'],
                [/if\s*\(\s*!(\w+)\s*\|\|\s*!\1\.farm_id\s*\)/g, 'if (!$1)'],
            ];
            
            validacoes.forEach(([regex, replacement]) => {
                const matches = content.match(regex);
                if (matches) {
                    totalReplacements += matches.length;
                    console.log(`‚úÖ ${matches.length}x valida√ß√µes`);
                }
                content = content.replace(regex, replacement);
            });
            
            // 4. Compara√ß√µes: record.farm_id === userData.farm_id
            const compRegex = /(\w+)\.farm_id\s*===\s*\w+\.farm_id/g;
            const compMatches = content.match(compRegex);
            if (compMatches) {
                totalReplacements += compMatches.length;
                console.log(`‚úÖ ${compMatches.length}x compara√ß√µes`);
            }
            content = content.replace(compRegex, '$1.farm_id === 1');
            
            // 5. Chamadas de fun√ß√£o: funcao(userData.farm_id)
            const funcPatterns = [
                [/loadRecentActivities\s*\(\s*1\s*\)/g, 'loadRecentActivities() // Lagoa Do Mato'],
                [/getFarmUsers\s*\(\s*1\s*\)/g, 'getFarmUsers() // Lagoa Do Mato'],
                [/setupChatRealtime\s*\(\s*1\s*\)/g, 'setupChatRealtime() // Lagoa Do Mato'],
                [/getChatMessages\s*\(\s*1\s*,/g, 'getChatMessages('],
                [/getVolumeData\s*\(\s*1\s*,\s*['"]week['"]/g, "getVolumeData('week'"],
                [/getVolumeData\s*\(\s*1\s*,\s*['"]month['"]/g, "getVolumeData('month'"],
                [/generateUserEmail\s*\(\s*name\s*,\s*1\s*\)/g, 'generateUserEmail(name) // Lagoa Do Mato'],
            ];
            
            funcPatterns.forEach(([regex, replacement]) => {
                const matches = content.match(regex);
                if (matches) {
                    totalReplacements += matches.length;
                }
                content = content.replace(regex, replacement);
            });
            
            // 6. Logs com farm_id
            const logPatterns = [
                [/console\.log\s*\(\s*['"].*?Farm ID.*?['"],\s*1\s*\)/g, "console.log('üè° Fazenda: Lagoa Do Mato')"],
                [/console\.log\s*\(\s*['"].*?farm_id.*?['"],\s*1\s*\)/gi, "console.log('Fazenda: Lagoa Do Mato')"],
            ];
            
            logPatterns.forEach(([regex, replacement]) => {
                const matches = content.match(regex);
                if (matches) {
                    totalReplacements += matches.length;
                }
                content = content.replace(regex, replacement);
            });
            
            // 7. Coment√°rios
            content = content.replace(/\/\/ Get user's farm_id/g, '// Usu√°rio da fazenda Lagoa Do Mato');
            content = content.replace(/\/\/ Get current user's farm_id/g, '// Usu√°rio da fazenda Lagoa Do Mato');
            
            document.getElementById('fileContent').value = content;
            document.getElementById('output').innerHTML = `
                <div style="background: #4CAF50; padding: 20px; border-radius: 5px; margin-top: 20px; color: white;">
                    <h3>‚úÖ Substitui√ß√£o Conclu√≠da!</h3>
                    <p style="font-size: 24px; font-weight: bold; margin: 15px 0;">${totalReplacements} substitui√ß√µes realizadas</p>
                    <p style="margin-top: 15px; font-size: 18px;">
                        <strong>AGORA:</strong><br>
                        1. Clique em "üìã Copiar Resultado"<br>
                        2. Cole no gerente.php (Ctrl+A ‚Üí Ctrl+V ‚Üí Ctrl+S)<br>
                        3. Clique em "üîç Buscar" de novo para verificar!
                    </p>
                </div>
            `;
            
            // Buscar novamente para confirmar
            setTimeout(buscarFarmId, 1000);
        }

        function copiarResultado() {
            const content = document.getElementById('fileContent').value;
            
            if (!content) {
                alert('‚ö†Ô∏è Nenhum conte√∫do para copiar!');
                return;
            }
            
            navigator.clipboard.writeText(content).then(() => {
                alert('‚úÖ Conte√∫do copiado para a √°rea de transfer√™ncia!\n\nAgora:\n1. Abra gerente.php no Cursor\n2. Ctrl+A (selecionar tudo)\n3. Ctrl+V (colar)\n4. Salvar (Ctrl+S)');
            }).catch(err => {
                alert('‚ùå Erro ao copiar: ' + err);
            });
        }
        
        function limparTexto() {
            document.getElementById('fileContent').value = '';
            document.getElementById('results').innerHTML = '';
            document.getElementById('count').innerHTML = '';
            document.getElementById('output').innerHTML = '';
        }
    </script>
</body>
</html>

