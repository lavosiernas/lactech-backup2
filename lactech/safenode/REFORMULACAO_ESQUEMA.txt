═══════════════════════════════════════════════════════════════════════════════
                    SAFENODE - ESQUEMA DE REFORMULAÇÃO
                    Arquitetura Independente + Cloudflare Complementar
═══════════════════════════════════════════════════════════════════════════════

┌─────────────────────────────────────────────────────────────────────────────┐
│                        ARQUITETURA ATUAL (PROBLEMA)                         │
└─────────────────────────────────────────────────────────────────────────────┘

    Requisição → Cloudflare → SafeNode (espelha dados) → Dashboard
                    ↓
            Dados dependem da Cloudflare


┌─────────────────────────────────────────────────────────────────────────────┐
│                    NOVA ARQUITETURA (INDEPENDENTE)                           │
└─────────────────────────────────────────────────────────────────────────────┘

    Requisição → SafeNode (análise própria) → Decisão → Cloudflare (complemento)
                    ↓                              ↓
            Logs próprios                    Sincronização opcional
                    ↓
            Dashboard (dados próprios)


═══════════════════════════════════════════════════════════════════════════════
                            CAMADAS DO SAFENODE
═══════════════════════════════════════════════════════════════════════════════

┌─────────────────────────────────────────────────────────────────────────────┐
│ CAMADA 1: ANÁLISE PRÓPRIA (INDEPENDENTE)                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│  1.1 DETECÇÃO DE AMEAÇAS                                                     │
│      ├─ ThreatDetector (próprio)                                            │
│      ├─ Padrões OWASP CRS                                                    │
│      ├─ Machine Learning básico (comportamento)                             │
│      └─ Análise heurística                                                    │
│                                                                               │
│  1.2 ANÁLISE DE COMPORTAMENTO                                                │
│      ├─ Rate Limiting próprio                                                │
│      ├─ Padrões de requisição suspeitos                                      │
│      ├─ Análise de sessão                                                    │
│      └─ Detecção de bots                                                     │
│                                                                               │
│  1.3 GEO-LOCALIZAÇÃO                                                         │
│      ├─ IP Geolocation (próprio)                                             │
│      ├─ Regras por país                                                      │
│      └─ Blacklist geográfica                                                 │
│                                                                               │
│  1.4 REPUTAÇÃO DE IP                                                         │
│      ├─ Histórico próprio de IPs                                              │
│      ├─ Score de confiança                                                   │
│      └─ Blacklist/Whitelist própria                                          │
│                                                                               │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│ CAMADA 2: DECISÃO E AÇÃO (INDEPENDENTE)                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│  2.1 SISTEMA DE SCORING                                                      │
│      ├─ Threat Score (0-100)                                                 │
│      ├─ Confidence Score                                                     │
│      └─ Risk Level (Low/Medium/High/Critical)                                │
│                                                                               │
│  2.2 AÇÕES AUTOMÁTICAS                                                       │
│      ├─ Allow (permitir)                                                     │
│      ├─ Challenge (desafio)                                                  │
│      ├─ Rate Limit (limitar)                                                 │
│      ├─ Block (bloquear)                                                     │
│      └─ Log Only (apenas registrar)                                         │
│                                                                               │
│  2.3 REGRAS PERSONALIZADAS                                                    │
│      ├─ Firewall Rules (próprias)                                            │
│      ├─ Custom Patterns                                                      │
│      └─ Site-specific rules                                                  │
│                                                                               │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│ CAMADA 3: ARMAZENAMENTO E LOGS (PRÓPRIO)                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│  3.1 LOGS DE SEGURANÇA                                                       │
│      ├─ Todas as requisições analisadas                                      │
│      ├─ Ameaças detectadas                                                   │
│      ├─ Ações tomadas                                                        │
│      └─ Performance metrics                                                  │
│                                                                               │
│  3.2 MÉTRICAS E ESTATÍSTICAS                                                 │
│      ├─ Requisições por hora/dia                                             │
│      ├─ Taxa de bloqueio                                                     │
│      ├─ Top ameaças                                                          │
│      ├─ Top IPs bloqueados                                                    │
│      └─ Análise de tendências                                                │
│                                                                               │
│  3.3 HISTÓRICO E INCIDENTES                                                  │
│      ├─ Incidentes agrupados                                                 │
│      ├─ Timeline de eventos                                                  │
│      └─ Relatórios de segurança                                              │
│                                                                               │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│ CAMADA 4: INTEGRAÇÃO CLOUDFLARE (COMPLEMENTAR)                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│  4.1 SINCRONIZAÇÃO BIDIRECIONAL                                              │
│      ├─ SafeNode → Cloudflare (bloqueios críticos)                           │
│      └─ Cloudflare → SafeNode (eventos de segurança)                        │
│                                                                               │
│  4.2 USO DA CLOUDFLARE                                                       │
│      ├─ DDoS Protection (camada adicional)                                   │
│      ├─ WAF Rules (complementar)                                             │
│      ├─ DNS Management                                                       │
│      └─ CDN/Caching                                                          │
│                                                                               │
│  4.3 DADOS DA CLOUDFLARE                                                     │
│      ├─ Usar APENAS como referência                                          │
│      ├─ Comparar com dados próprios                                          │
│      └─ Não depender para decisões                                           │
│                                                                               │
└─────────────────────────────────────────────────────────────────────────────┘


═══════════════════════════════════════════════════════════════════════════════
                        FLUXO DE DECISÃO INDEPENDENTE
═══════════════════════════════════════════════════════════════════════════════

    REQUISIÇÃO CHEGA
         │
         ├─→ [1] Identificar Site
         │       └─→ Carregar configurações do site
         │
         ├─→ [2] Obter IP Real
         │       └─→ Verificar headers (CF-Connecting-IP, X-Forwarded-For)
         │
         ├─→ [3] Verificar Whitelist (própria)
         │       └─→ Se whitelisted → ALLOW + LOG
         │
         ├─→ [4] Verificar Blacklist (própria)
         │       └─→ Se blacklisted → BLOCK + LOG
         │
         ├─→ [5] Geo-Localização (própria)
         │       └─→ Verificar regras geográficas
         │
         ├─→ [6] Rate Limiting (próprio)
         │       └─→ Verificar limites por IP
         │
         ├─→ [7] Análise de Ameaças (própria)
         │       ├─→ ThreatDetector
         │       ├─→ Padrões OWASP
         │       └─→ Análise comportamental
         │
         ├─→ [8] Calcular Threat Score
         │       └─→ Combinar todas as análises
         │
         ├─→ [9] Aplicar Regras de Firewall (próprias)
         │       └─→ Regras customizadas do site
         │
         ├─→ [10] DECISÃO FINAL
         │        ├─→ ALLOW → Permitir + Log
         │        ├─→ CHALLENGE → Desafio + Log
         │        ├─→ RATE_LIMIT → Limitar + Log
         │        └─→ BLOCK → Bloquear + Log
         │
         ├─→ [11] Registrar no Log Próprio
         │        └─→ Sempre registrar, independente da decisão
         │
         └─→ [12] Sincronizar com Cloudflare (OPCIONAL)
                  ├─→ Se bloqueio crítico → Criar regra CF
                  └─→ Se evento importante → Enviar para CF


═══════════════════════════════════════════════════════════════════════════════
                        DASHBOARD - NOVA ESTRUTURA
═══════════════════════════════════════════════════════════════════════════════

┌─────────────────────────────────────────────────────────────────────────────┐
│ SEÇÃO 1: ESTATÍSTICAS PRÓPRIAS (PRIMÁRIAS)                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│  • Total de Requisições (próprio)                                            │
│  • Requisições Bloqueadas (próprio)                                           │
│  • Requisições Permitidas (próprio)                                          │
│  • Visitantes Únicos (próprio)                                               │
│  • Taxa de Bloqueio (próprio)                                                │
│  • Ameaças Detectadas (próprio)                                              │
│                                                                               │
│  FONTE: safenode_security_logs (banco próprio)                                │
│                                                                               │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│ SEÇÃO 2: ANÁLISE DE AMEAÇAS (PRÓPRIAS)                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│  • SQL Injection detectados                                                  │
│  • XSS detectados                                                            │
│  • Brute Force detectados                                                    │
│  • DDoS detectados                                                           │
│  • Path Traversal detectados                                                 │
│  • Command Injection detectados                                              │
│                                                                               │
│  FONTE: Análise própria do ThreatDetector                                    │
│                                                                               │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│ SEÇÃO 3: TOP AMEAÇAS E IPs (PRÓPRIOS)                                       │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│  • Top 10 IPs Bloqueados                                                     │
│  • Top 10 Países de Origem                                                  │
│  • Top 10 Tipos de Ameaça                                                   │
│  • IPs com Maior Threat Score                                                │
│                                                                               │
│  FONTE: Agregação dos próprios logs                                          │
│                                                                               │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│ SEÇÃO 4: GRÁFICOS E TENDÊNCIAS (PRÓPRIOS)                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│  • Requisições por Hora (últimas 24h)                                        │
│  • Bloqueios por Hora                                                        │
│  • Tendência de Ameaças (últimos 7 dias)                                     │
│  • Distribuição por País                                                     │
│  • Distribuição por Tipo de Ameaça                                          │
│                                                                               │
│  FONTE: Agregação temporal dos próprios logs                                 │
│                                                                               │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│ SEÇÃO 5: INCIDENTES E EVENTOS (PRÓPRIOS)                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│  • Incidentes Ativos                                                         │
│  • Incidentes Resolvidos                                                     │
│  • Timeline de Eventos                                                       │
│  • Logs Recentes                                                             │
│                                                                               │
│  FONTE: safenode_incidents + safenode_security_logs                        │
│                                                                               │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│ SEÇÃO 6: CLOUDFLARE (COMPLEMENTAR - OPCIONAL)                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│  • Status de Sincronização                                                   │
│  • Regras Criadas no CF                                                      │
│  • Eventos Recebidos do CF (referência)                                      │
│  • Comparação: SafeNode vs Cloudflare                                         │
│                                                                               │
│  NOTA: Esta seção é INFORMATIVA, não decisiva                                │
│                                                                               │
└─────────────────────────────────────────────────────────────────────────────┘


═══════════════════════════════════════════════════════════════════════════════
                        ESTRUTURA DE DADOS NO BANCO
═══════════════════════════════════════════════════════════════════════════════

TABELA: safenode_security_logs (PRINCIPAL)
├─ id (PK)
├─ site_id (FK)
├─ ip_address
├─ request_uri
├─ request_method
├─ action_taken (allowed/blocked/challenged/rate_limited)
├─ threat_type (sql_injection/xss/brute_force/etc)
├─ threat_score (0-100) ← PRÓPRIO
├─ confidence_score (0-100) ← PRÓPRIO
├─ user_agent
├─ referer
├─ country_code
├─ response_time
├─ created_at

TABELA: safenode_incidents (AGRUPAMENTO)
├─ id (PK)
├─ site_id (FK)
├─ ip_address
├─ threat_type
├─ total_events
├─ critical_events
├─ first_seen
├─ last_seen
├─ status (open/resolved)
├─ threat_score_avg ← PRÓPRIO

TABELA: safenode_ip_reputation (REPUTAÇÃO PRÓPRIA)
├─ id (PK)
├─ ip_address (UNIQUE)
├─ trust_score (0-100) ← PRÓPRIO
├─ total_requests
├─ blocked_requests
├─ allowed_requests
├─ first_seen
├─ last_seen
├─ country_code
├─ is_whitelisted
├─ is_blacklisted

TABELA: safenode_threat_patterns (PADRÕES PRÓPRIOS)
├─ id (PK)
├─ pattern (regex)
├─ threat_type
├─ severity (0-100)
├─ is_active
├─ created_at

TABELA: safenode_firewall_rules (REGRAS PRÓPRIAS)
├─ id (PK)
├─ site_id (FK)
├─ rule_name
├─ rule_type (ip/country/pattern)
├─ rule_value
├─ action (allow/block/challenge)
├─ priority
├─ is_active


═══════════════════════════════════════════════════════════════════════════════
                        COMPONENTES A CRIAR/MODIFICAR
═══════════════════════════════════════════════════════════════════════════════

[1] ThreatAnalyzer (NOVO)
    └─ Análise avançada de ameaças com scoring próprio

[2] BehaviorAnalyzer (NOVO)
    └─ Análise comportamental de IPs e sessões

[3] IPReputationManager (NOVO)
    └─ Gerenciamento de reputação de IPs próprio

[4] DashboardStats (REFORMULAR)
    └─ Usar APENAS dados próprios, não Cloudflare

[5] SecurityAnalytics (REFORMULAR)
    └─ Analytics baseado em logs próprios

[6] CloudflareSync (NOVO - OPCIONAL)
    └─ Sincronização bidirecional opcional

[7] IncidentManager (MELHORAR)
    └─ Agrupamento inteligente de incidentes


═══════════════════════════════════════════════════════════════════════════════
                        PRINCÍPIOS DA REFORMULAÇÃO
═══════════════════════════════════════════════════════════════════════════════

✓ SafeNode funciona INDEPENDENTE da Cloudflare
✓ Cloudflare é COMPLEMENTAR, não essencial
✓ Todas as decisões são baseadas em análise própria
✓ Logs próprios são a fonte primária de dados
✓ Dashboard mostra dados próprios primeiro
✓ Cloudflare aparece apenas como referência/comparação
✓ Sistema pode funcionar sem Cloudflare configurada


═══════════════════════════════════════════════════════════════════════════════
                            PRÓXIMOS PASSOS
═══════════════════════════════════════════════════════════════════════════════

1. Reformular dashboard-stats.php para usar dados próprios
2. Criar IPReputationManager
3. Melhorar ThreatDetector com scoring próprio
4. Criar BehaviorAnalyzer
5. Reformular SecurityAnalytics
6. Criar CloudflareSync (opcional)
7. Atualizar dashboard.php para mostrar dados próprios
8. Adicionar comparação SafeNode vs Cloudflare (opcional)

═══════════════════════════════════════════════════════════════════════════════

